% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  letterpaper,
  DIV=11,
  numbers=noendperiod,
  oneside]{scrreprt}

\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[left=1in,marginparwidth=2.0666666666667in,textwidth=4.1333333333333in,marginparsep=0.3in]{geometry}
\setlength{\emergencystretch}{3em} % prevent overfull lines
\setcounter{secnumdepth}{5}
% Make \paragraph and \subparagraph free-standing
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{241,243,245}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.40,0.45,0.13}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\BuiltInTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\ExtensionTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.28,0.35,0.67}{#1}}
\newcommand{\ImportTok}[1]{\textcolor[rgb]{0.00,0.46,0.62}{#1}}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\NormalTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.07,0.07,0.07}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

\usepackage{booktabs}
\usepackage{siunitx}

  \newcolumntype{d}{S[
    input-open-uncertainty=,
    input-close-uncertainty=,
    parse-numbers = false,
    table-align-text-pre=false,
    table-align-text-post=false
  ]}
  
\usepackage{longtable}
\usepackage{array}
\usepackage{multirow}
\usepackage{wrapfig}
\usepackage{float}
\usepackage{colortbl}
\usepackage{pdflscape}
\usepackage{tabu}
\usepackage{threeparttable}
\usepackage{threeparttablex}
\usepackage[normalem]{ulem}
\usepackage{makecell}
\usepackage{xcolor}
\KOMAoption{captions}{tableheading}
\makeatletter
\@ifpackageloaded{tcolorbox}{}{\usepackage[many]{tcolorbox}}
\@ifpackageloaded{fontawesome5}{}{\usepackage{fontawesome5}}
\definecolor{quarto-callout-color}{HTML}{909090}
\definecolor{quarto-callout-note-color}{HTML}{0758E5}
\definecolor{quarto-callout-important-color}{HTML}{CC1914}
\definecolor{quarto-callout-warning-color}{HTML}{EB9113}
\definecolor{quarto-callout-tip-color}{HTML}{00A047}
\definecolor{quarto-callout-caution-color}{HTML}{FC5300}
\definecolor{quarto-callout-color-frame}{HTML}{acacac}
\definecolor{quarto-callout-note-color-frame}{HTML}{4582ec}
\definecolor{quarto-callout-important-color-frame}{HTML}{d9534f}
\definecolor{quarto-callout-warning-color-frame}{HTML}{f0ad4e}
\definecolor{quarto-callout-tip-color-frame}{HTML}{02b875}
\definecolor{quarto-callout-caution-color-frame}{HTML}{fd7e14}
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{bookmark}{}{\usepackage{bookmark}}
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table des matières}
\else
  \newcommand\contentsname{Table des matières}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{Liste des Figures}
\else
  \newcommand\listfigurename{Liste des Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{Liste des Tables}
\else
  \newcommand\listtablename{Liste des Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{Liste des Listings}}
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother
\makeatletter
\@ifpackageloaded{tcolorbox}{}{\usepackage[many]{tcolorbox}}
\makeatother
\makeatletter
\@ifundefined{shadecolor}{\definecolor{shadecolor}{rgb}{.97, .97, .97}}
\makeatother
\makeatletter
\@ifpackageloaded{sidenotes}{}{\usepackage{sidenotes}}
\@ifpackageloaded{marginnote}{}{\usepackage{marginnote}}
\makeatother
\makeatletter
\makeatother
\ifLuaTeX
\usepackage[bidi=basic]{babel}
\else
\usepackage[bidi=default]{babel}
\fi
\babelprovide[main,import]{french}
% get rid of language-specific shorthands (see #6817):
\let\LanguageShortHands\languageshorthands
\def\languageshorthands#1{}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={guide-R},
  pdfauthor={Joseph Larmarange},
  pdflang={fr},
  colorlinks=true,
  linkcolor={blue},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}

\title{guide-R}
\usepackage{etoolbox}
\makeatletter
\providecommand{\subtitle}[1]{% add subtitle to \maketitle
  \apptocmd{\@title}{\par {\large #1 \par}}{}{}
}
\makeatother
\subtitle{Guide pour l'analyse de données d'enquêtes avec R}
\author{Joseph Larmarange}
\date{5 juillet 2023}

\begin{document}
\maketitle
\ifdefined\Shaded\renewenvironment{Shaded}{\begin{tcolorbox}[borderline west={3pt}{0pt}{shadecolor}, enhanced, breakable, interior hidden, boxrule=0pt, sharp corners, frame hidden]}{\end{tcolorbox}}\fi

\renewcommand*\contentsname{Table des matières}
{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{2}
\tableofcontents
}
\bookmarksetup{startatroot}

\hypertarget{pruxe9face}{%
\chapter*{Préface}\label{pruxe9face}}
\addcontentsline{toc}{chapter}{Préface}

\markboth{Préface}{Préface}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-warning-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-warning-color}{\faExclamationTriangle}\hspace{0.5em}{Guide en cours d'écriture}, bottomrule=.15mm, colframe=quarto-callout-warning-color-frame]

Ce guide est encore incomplet. Le plan prévu est visible à cette
adresse~: \url{https://github.com/larmarange/guide-R/issues/12}.

En attendant, nous vous conseillons de compléter votre lecture par le
site \href{https://larmarange.github.io/analyse-R/}{analyse-R}.

\end{tcolorbox}

Ce guide porte sur l'analyse de données d'enquêtes avec le logiciel
\href{https://www.r-project.org/}{\textbf{R}}, un logiciel libre de
statitistiques et de traitement de données. Les exemples présentés ici
relèvent principalement du champs des sciences sociales quantitatives et
des sciences de santé. Ils peuvent néanmoins s'appliquer à d'autre
champs disciplinaires. Cependant, comme tout ouvrage, ce guide ne peut
être exhaustif.

Ce guide présente comment réaliser des analyses statistiques et diverses
opérations courantes (comme la manipulation de données ou la production
de graphiques) avec \textbf{R}. Il ne s'agit pas d'un cours de
statistiques : les différents chapitres présupposent donc que vous avez
déjà une connaissance des différentes techniques présentées. Si vous
souhaitez des précisions théoriques / méthodologiques à propos d'un
certain type d'analyses, nous vous conseillons d'utiliser votre moteur
de recherche préféré. En effet, on trouve sur internet de très nombreux
supports de cours (sans compter les nombreux ouvrages spécialisés
disponibles en librairie).

De même, il ne s'agit pas d'une introduction ou d'un guide pour les
utilisatrices et utilisateurs débutant·es. Si vous découvrez \textbf{R},
nous vous conseillons la lecture de l'\emph{Introduction à R et au
tidyverse} de Julien Barnier (\url{https://juba.github.io/tidyverse/}).
Vous pouvez également lire les chapitres introductifs d'\emph{analyse-R
: Introduction à l'analyse d'enquêtes avec R et RStudio}
(\url{https://larmarange.github.io/analyse-R/}). Néanmoins, quelques
rappels sur les bases du langage sont fournis dans la section
\emph{Bases du langage}. Une bonne compréhension de ces dernières, bien
qu'un peu ardue de prime abord, permet de comprendre le sens des
commandes qu'on utilise et de pleinement exploiter la puissance que
\textbf{R} offre en matière de manipulation de données.

\textbf{R} disposent de nombreuses extensions ou packages (plus de
16~000) et il existe souvent plusieurs manières de procéder pour arriver
au même résultat. En particulier, en matière de manipulation de données,
on oppose\sidenote{\footnotesize Une comparaison des deux syntaxes est illustrée par
  une \href{https://dplyr.tidyverse.org/articles/base.html}{vignette
  dédiée de dplyr}.} souvent \emph{base R} qui repose sur les fonctions
disponibles en standard dans \textbf{R}, la majorité étant fournies dans
les packages \texttt{\{base\}}, \texttt{\{utils\}} ou encore
\texttt{\{stats\}}, qui sont toujours chargés par défaut, et le
\texttt{\{tidyverse\}} qui est une collection de packages comprenant,
entre autres, \texttt{\{dplyr\}}, \texttt{\{tibble\}},
\texttt{\{tidyr\}}, \texttt{\{forcats\}} ou encore \texttt{\{ggplot2\}}.
Il y a un débat ouvert, parfois passionné, sur le fait de privilégier
l'une ou l'autre approche, et les avantages et inconvénients de chacune
dépendent de nombreux facteurs, comme la lisibilité du code ou bien les
performances en temps de calcul. Dans ce guide, nous avons adopté un
point de vue pragmatique et utiliserons, le plus souvent mais pas
exclusivement, les fonctions du \texttt{\{tidyverse\}}, de même que nous
avons privilégié d'autres packages, comme \texttt{\{gtsummary\}} ou
\texttt{\{questionr\}} par exemple pour la statistique descriptive. Cela
ne signifie pas, pour chaque point abordé, qu'il s'agit de l'unique
manière de procéder. Dans certains cas, il s'agit simplement de
préférences personnelles.

Bien qu'il en reprenne de nombreux contenus, ce guide ne se substitue
pas au site \href{https://larmarange.github.io/analyse-R/}{analyse-R}.
Il s'agit plutôt d'une version complémentaire qui a vocation à être plus
structurée et parfois plus sélective dans les contenus présentés.

En complément, on pourra également se référer aux
\href{https://larmarange.github.io/webin-R/}{webin-R}, une série de
vidéos avec partage d'écran, librement accessibles sur Youtube :
\url{https://www.youtube.com/c/webinR}.

Cette version du guide a utilisé \emph{R version 4.2.3 (2023-03-15
ucrt)}. Ce document est généré avec \href{https://quarto.org/}{quarto}
et le code source est disponible sur
\href{https://github.com/larmarange/guide-R}{GitHub}. Pour toute
suggestion ou correction, vous pouvez ouvrir un
\href{https://github.com/larmarange/guide-R/issues}{ticket GitHub}. Pour
d'autres questions, vous pouvez utiliser les forums de discussion
disponibles en bas de chaque page sur la version web du guide. Ce
document est régulièrement mis à jour. La dernière version est
consultable sur \url{https://larmarange.github.io/guide-R/}.

\hypertarget{remerciements}{%
\section*{Remerciements}\label{remerciements}}
\addcontentsline{toc}{section}{Remerciements}

\markright{Remerciements}

Ce document a bénéficié de différents apports provenant notamment de
l'\href{https://github.com/juba/intro-r}{\emph{Introduction à R}} et de
l'\href{https://juba.github.io/tidyverse/}{\emph{Introduction à R et au
tidyverse}} de Julien Barnier et
d'\href{https://larmarange.github.io/analyse-R/}{analyse-R :
introduction à l'analyse d'enquêtes avec R et RStudio}.

Merci donc à Julien Barnier, Julien Biaudet, François Briatte, Milan
Bouchet-Valat, Ewen Gallic, Frédérique Giraud, Joël Gombin, Mayeul
Kauffmann, Christophe Lalanne \& Nicolas Robette.

\hypertarget{licence}{%
\section*{Licence}\label{licence}}
\addcontentsline{toc}{section}{Licence}

\markright{Licence}

Ce document est mis à disposition selon les termes de la
\href{http://creativecommons.org/licenses/by-nc-sa/4.0/}{Licence
Creative Commons Attribution - Pas d'Utilisation Commerciale - Partage
dans les Mêmes Conditions 4.0 International}.

\includegraphics[width=1.66667in,height=\textheight]{./ressources/by-nc-sa.png}

\part{\textbf{Bases du langage}}

\hypertarget{sec-packages}{%
\chapter{Packages}\label{sec-packages}}

L'installation par défaut du logiciel \textbf{R} contient le cœur du
programme ainsi qu'un ensemble de fonctions de base fournissant un grand
nombre d'outils de traitement de données et d'analyse statistiques.

\textbf{R} étant un logiciel libre, il bénéficie d'une forte communauté
d'utilisateurs qui peuvent librement contribuer au développement du
logiciel en lui ajoutant des fonctionnalités supplémentaires. Ces
contributions prennent la forme d'extensions (packages en anglais)
pouvant être installées par l'utilisateur et fournissant alors diverses
fonctionnalités supplémentaires.

Il existe un très grand nombre d'extensions (plus de 16~000 à ce jour),
qui sont diffusées par un réseau baptisé \textbf{CRAN}
(\emph{Comprehensive R Archive Network}).

La liste de toutes les extensions disponibles sur \textbf{CRAN} est
disponible ici~: \url{http://cran.r-project.org/web/packages/}.

Pour faciliter un peu le repérage des extensions, il existe un ensemble
de regroupements thématiques (économétrie, finance, génétique, données
spatiales\ldots) baptisés Task views~:
\url{http://cran.r-project.org/web/views/}.

On y trouve notamment une \emph{Task view} dédiée aux sciences sociales,
listant de nombreuses extensions potentiellement utiles pour les
analyses statistiques dans ce champ disciplinaire~:
\url{http://cran.r-project.org/web/views/SocialSciences.html}.

On peut aussi citer le site \emph{Awesome R}
(\url{https://github.com/qinwf/awesome-R}) qui fournit une liste
d'extensions choisies et triées par thématique.

\hypertarget{installation-cran}{%
\section{Installation (CRAN)}\label{installation-cran}}

L'installation d'une extension se fait par la fonction
\texttt{install.packages()}, à qui on fournit le nom de l'extension. Par
exemple, si on souhaite installer l'extension \texttt{\{gtsummary\}}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{"gtsummary"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Sous \textbf{RStudio}, on pourra également cliquer sur \emph{Install}
dans l'onglet \emph{Packages} du quadrant inférieur droit.

Alternativement, on pourra avoir recours au package \texttt{\{remotes\}}
et à sa fonction \texttt{remotes::install\_cran()}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{remotes}\SpecialCharTok{::}\FunctionTok{install\_cran}\NormalTok{(}\StringTok{"gtsummary"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

Le package \texttt{\{remotes\}} n'est pas disponible par défaut sous
\textbf{R} et devra donc être installé classiquement avec
\texttt{install.packages("remotes")}. À la différence de
\texttt{install.packages()}, \texttt{remotes::install\_cran()} vérifie
si le package est déjà installé et, si oui, si la version installée est
déjà la dernière version, avant de procéder à une installation complète
si et seulement si cela est nécessaire.

\end{tcolorbox}

\hypertarget{chargement}{%
\section{Chargement}\label{chargement}}

Une fois un package installé (c'est-à-dire que ses fichiers ont eté
téléchargés et copiés sur votre ordinateur), ses fonctions et objets ne
sont pas directement accessibles. Pour pouvoir les utiliser, il faut,
\textbf{à chaque session de travail}, charger le package en mémoire avec
la fonction \texttt{library()} ou la fonction \texttt{require()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gtsummary)}
\end{Highlighting}
\end{Shaded}

À partir de là, on peut utiliser les fonctions de l'extension, consulter
leur page d'aide en ligne, accéder aux jeux de données qu'elle contient,
etc.

Alternativement, pour accéder à un objet ou une fonction d'un package
sans avoir à le charger en mémoire, on pourra avoir recours à
l'opérateur \texttt{::}. Ainsi, l'écriture \texttt{p::f()} signifie la
fonction \texttt{f()} du package \texttt{p}. Cette écriture sera
notamment utilisée tout au long de ce guide pour indiquer à quel package
appartient telle fonction : \texttt{remotes::install\_cran()} indique
que la fonction \texttt{install\_cran()} provient du packages
\texttt{\{remotes\}}.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Important}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

Il est important de bien comprendre la différence entre
\texttt{install.packages()} et \texttt{library()}. La première va
chercher un package sur internet et l'installe en local sur le disque
dur de l'ordinateur. On n'a besoin d'effectuer cette opération qu'une
seule fois. La seconde lit les informations de l'extension sur le disque
dur et les met à disposition de \textbf{R}. On a besoin de l'exécuter à
chaque début de session ou de script.

\end{tcolorbox}

\hypertarget{mise-uxe0-jour}{%
\section{Mise à jour}\label{mise-uxe0-jour}}

Pour mettre à jour l'ensemble des pacakges installés, il suffit
d'exécuter la fonction \texttt{update.packages()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{update.packages}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

Sous \textbf{RStudio}, on pourra alternativement cliquer sur
\emph{Update} dans l'onglet \emph{Packages} du quadrant inférieur droit.

Si on souhaite désinstaller une extension précédemment installée, on
peut utiliser la fonction \texttt{remove.packages()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{remove.packages}\NormalTok{(}\StringTok{"gtsummary"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Installer / Mettre à jour les packages utilisés par un projet}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Après une mise à jour majeure de \textbf{R}, il est souvent nécessaire
de réinstaller tous les packages utilisés. De même, on peut parfois
souhaiter mettre à jour uniquement les packages utilisés par un projet
donné sans avoir à mettre à jour tous les autres packages présents sur
son PC.

Une astuce consiste à avoir recours à la fonction
\texttt{renv::dependencies()} qui examine le code du projet courant pour
identifier les packages utilisés, puis à passer cette liste de packages
à \texttt{remotes::install\_cran()} qui installera les packages
manquants ou pour lesquels une mise à jour est disponible.

Il vous suffit d'exécuter la commande ci-dessous~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{renv}\SpecialCharTok{::}\FunctionTok{dependencies}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  purrr}\SpecialCharTok{::}\FunctionTok{pluck}\NormalTok{(}\StringTok{"Package"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  remotes}\SpecialCharTok{::}\FunctionTok{install\_cran}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\end{tcolorbox}

\hypertarget{installation-depuis-github}{%
\section{Installation depuis GitHub}\label{installation-depuis-github}}

Certains packages ne sont pas disponibles sur
\href{https://cran.r-project.org/}{\textbf{CRAN}} mais seulement sur
\href{https://github.com/}{\textbf{GitHub}}, une plateforme de
développement informatique. Il s'agit le plus souvent de packages qui ne
sont pas encore suffisament matures pour être diffusés sur \textbf{CRAN}
(sachant que des vérifications strictes sont effectués avant qu'un
package ne soit référencés sur \textbf{CRAN}).

Dans d'autres cas de figure, la dernière version stable d'un package est
disponible sur \textbf{CRAN} tandis que la version en cours de
développement est, elle, disponible sur \textbf{GitHub}. Il fuat être
vigilant avec les versions de développement. Parfois, elle corrige un
bug ou introduit une nouvelle fonctionnalité qui n'est pas encore dans
la version stable. Mais les versions de développement peuvent aussi
contenir de nouveaux bugs ou des fonctionnalités instables.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-warning-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-warning-color}{\faExclamationTriangle}\hspace{0.5em}{Sous Windows}, bottomrule=.15mm, colframe=quarto-callout-warning-color-frame]

Pour les utilisatrices et utilisateurs sous \textbf{Windows}, il faut
être conscient que le code source d'un package doit être compilé afin de
pouvoir être utilisé. \textbf{CRAN} fournit une version des packages
déjà compilée pour \textbf{Windows} ce qui facilite l'installation.

Par contre, lorsque l'on installe un package depuis \textbf{GitHub},
\textbf{R} ne récupère que le code source et il est donc nécessaire de
compiler localement le package. Pour cela, il est nécessaire que soit
installé sur le PC un outil complémentaire appelé \textbf{RTools}. Il
est téléchargeable à l'adresse
\url{https://cran.r-project.org/bin/windows/Rtools/}.

\end{tcolorbox}

Le code source du package \texttt{\{labelled\}} est disponible sur
\textbf{GitHub} à l'adresse
\url{https://github.com/larmarange/labelled}. Pour installer la version
de développement de \texttt{\{labelled\}},on aura recours à la fonction
\texttt{remotes::install\_github()} à laquelle on passera la partie
située à droite de \texttt{https://github.com/} dans l'URL du package, à
savoir~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{remotes}\SpecialCharTok{::}\FunctionTok{install\_github}\NormalTok{(}\StringTok{"larmarange/labelled"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{le-tidyverse}{%
\section{Le tidyverse}\label{le-tidyverse}}

Le terme \texttt{\{tidyverse\}} est une contraction de \emph{tidy}
(qu'on pourrait traduire par bien rangé) et de \emph{universe}. Il
s'agit en fait d'une collection de packages conçus pour travailler
ensemble et basés sur une philosophie commune.

Ils abordent un très grand nombre d'opérations courantes dans \textbf{R}
(la liste n'est pas exhaustive) :

\begin{itemize}
\tightlist
\item
  visualisation (\texttt{\{ggplot2\}})
\item
  manipulation des tableaux de données (\texttt{\{dplyr\}},
  \texttt{\{tidyr\}})
\item
  import/export de données (\texttt{\{readr\}}, \texttt{\{readxl\}},
  \texttt{\{haven\}})
\item
  manipulation de variables (\texttt{\{forcats\}}, \texttt{\{stringr\}},
  \texttt{\{lubridate\}})
\item
  programmation (\texttt{\{purrr\}}, \texttt{\{magrittr\}},
  \texttt{\{glue\}})
\end{itemize}

Un des objectifs de ces extensions est de fournir des fonctions avec une
syntaxe cohérente, qui fonctionnent bien ensemble, et qui retournent des
résultats prévisibles. Elles sont en grande partie issues du travail
d'\href{http://hadley.nz/}{Hadley Wickham}, qui travaille désormais pour
\href{https://www.rstudio.com}{RStudio}.

\texttt{\{tidyverse\}} est également le nom d'une extension générique
qui permets d'installer en une seule commande l'ensemble des packages
constituant le \emph{tidyverse}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{install.packages}\NormalTok{(}\StringTok{"tidyverse"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Lorsque l'on charge le package \texttt{\{tidyverse\}} avec
\texttt{library()}, cela charge également en mémoire les principaux
packages du \emph{tidyverse}\sidenote{\footnotesize Si on a besoin d'un autre package
  du \emph{tidyverse} comme \texttt{\{lubridate\}}, il faudra donc le
  charger individuellement.}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-- Attaching core tidyverse packages ------------------------ tidyverse 2.0.0 --
v dplyr     1.1.1     v readr     2.1.4
v forcats   1.0.0     v stringr   1.5.0
v ggplot2   3.4.1     v tibble    3.2.1
v lubridate 1.9.2     v tidyr     1.3.0
v purrr     1.0.1     
-- Conflicts ------------------------------------------ tidyverse_conflicts() --
x dplyr::filter() masks stats::filter()
x dplyr::lag()    masks stats::lag()
i Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors
\end{verbatim}

\begin{figure}

{\centering \includegraphics{bases/ressources/tidyverse_core_packages.png}

}

\caption{\label{fig-tidyverse-core}Packages chargés avec
\texttt{library(tidyverse)}}

\end{figure}

\hypertarget{sec-vecteurs}{%
\chapter{Vecteurs}\label{sec-vecteurs}}

Les vecteurs sont l'objet de base de \textbf{R} et correspondent à une
liste de valeurs. Leurs propriétés fondamentales sont~:

\begin{itemize}
\tightlist
\item
  les vecteurs sont unidimensionnels (i.e.~ce sont des objets à une
  seule dimension, à la différence d'une matrice par exemple)~;
\item
  toutes les valeurs d'un vecteur sont d'un seul et même type~;
\item
  les vecteurs ont une longueur qui correspond au nombre de valeurs
  contenues dans le vecteur.
\end{itemize}

\hypertarget{types-et-classes}{%
\section{Types et classes}\label{types-et-classes}}

Dans \textbf{R}, il existe plusieurs types fondamentaux de vecteurs et,
en particulier,~:

\begin{itemize}
\tightlist
\item
  les nombres réels (c'est-à-dire les nombres décimaux\sidenote{\footnotesize Pour
    rappel, \textbf{R} étant anglophone, le caractère utilisé pour
    indiqué les chiffres après la virgule est le point (\texttt{.}).}),
  par exemple \texttt{5.23}~;
\item
  les nombres entiers, que l'on saisi en ajoutant le suffixe
  \texttt{L}\sidenote{\footnotesize \textbf{R} utilise 32 bits pour représenter des
    nombres entiers, ce qui correspond en informatique à des entiers
    longs ou \emph{long integers} en anglais, d'où la lettre \texttt{L}
    utilisée pour indiquer un nombre entier.}, par exemple \texttt{4L}~;
\item
  les chaînes de caractères (qui correspondent à du texte), que l'on
  saisit avec des guillemets doubles (\texttt{"}) ou simples
  (\texttt{\textquotesingle{}}), par exemple \texttt{"abc"}~;
\item
  les valeurs logiques ou valeurs booléennes, à savoir vrai ou faux, que
  l'on représente avec les mots \texttt{TRUE} et \texttt{FALSE} (en
  majuscules\sidenote{\footnotesize On peut également utiliser les raccourcis
    \texttt{T} et \texttt{F}. Cependant, pour une meilleure lisibilité
    du code, il est préférable d'utiliser les versions longues
    \texttt{TRUE} et \texttt{FALSE}.}).
\end{itemize}

En plus de ces types de base, il existe de nombreux autres types de
vecteurs utilisés pour représenter toutes sortes de données, comme les
facteurs (voir Chapitre~\ref{sec-facteurs}) ou les dates (voir
Chapitre~\ref{sec-dates}).

La fonction \texttt{class()} renvoie la nature d'un vecteur tandis que
la fonction \texttt{typeof()} indique la manière dont un vecteur est
stocké de manière interne par \textbf{R}.

\hypertarget{tbl-types-vecteurs}{}
\begin{longtable}[]{@{}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.2740}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3562}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3699}}@{}}
\caption{\label{tbl-types-vecteurs}Le type et la classe des principaux
types de vecteurs}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\centering
\texttt{x}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\texttt{class(x)}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\texttt{typeof(x)}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\centering
\texttt{x}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\texttt{class(x)}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\texttt{typeof(x)}
\end{minipage} \\
\midrule()
\endhead
\texttt{3L} & integer & integer \\
\texttt{5.3} & numeric & double \\
\texttt{TRUE} & logical & logical \\
\texttt{"abc"} & character & character \\
\texttt{factor("a")} & factor & integer \\
\texttt{as.Date("2020-01-01")} & Date & double \\
\bottomrule()
\end{longtable}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Pour un vecteur numérique, le type est \texttt{"double"} car \textbf{R}
utilise une double précision pour stocker informatiquement les nombres
réels.

En interne, les facteurs sont représentés par un nombre entier auquel
est attaché une étiquette, c'est pourquoi \texttt{typeof()} renvoie
\texttt{"integer"}.

Quand aux dates, elles sont stockées en interne sous la forme d'un
nombre réel représentant le nombre de jours depuis le
1\textsuperscript{er} janvier 1970, d'où le fait que \texttt{typeof()}
renvoie \texttt{"double"}.

\end{tcolorbox}

\hypertarget{cruxe9ation-dun-vecteur}{%
\section{Création d'un vecteur}\label{cruxe9ation-dun-vecteur}}

Pour créer un vecteur, on utilisera la fonction \texttt{c()} en lui
passant la liste des valeurs à combiner\sidenote{\footnotesize La lettre \texttt{c}
  est un raccourci du mot anglais \emph{combine}, puisque cette fonction
  permet de combiner des valeurs individuelles dans un vecteur unique.}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{1.88}\NormalTok{, }\FloatTok{1.65}\NormalTok{, }\FloatTok{1.92}\NormalTok{, }\FloatTok{1.76}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\FloatTok{1.72}\NormalTok{)}
\NormalTok{taille}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.88 1.65 1.92 1.76   NA 1.72
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sexe }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"h"}\NormalTok{, }\StringTok{"f"}\NormalTok{, }\StringTok{"h"}\NormalTok{, }\StringTok{"f"}\NormalTok{, }\StringTok{"f"}\NormalTok{, }\StringTok{"f"}\NormalTok{)}
\NormalTok{sexe}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "h" "f" "h" "f" "f" "f"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{urbain }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{)}
\NormalTok{urbain}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]  TRUE  TRUE FALSE FALSE FALSE  TRUE
\end{verbatim}

Nous l'avons vu, toutes les valeurs d'un vecteur doivent obligatoirement
être du même type. Dès lors, si on essaie de combiner des valeurs de
différents types, \textbf{R} essaiera de les convertir au mieux. Par
exemple~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(2L, }\FloatTok{3.14}\NormalTok{, }\StringTok{"a"}\NormalTok{)}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2"    "3.14" "a"   
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "character"
\end{verbatim}

Dans le cas présent, toutes les valeurs ont été converties en chaînes de
caractères.

Dans certaines situations, on peut avoir besoin de créer un vecteur
d'une certaine longueur mais dont toutes les valeurs sont identiques.
Cela se réalise facilement avec \texttt{rep()} à qui on indiquera la
valeur à répéter puis le nombre de répétitions~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 [1] 2 2 2 2 2 2 2 2 2 2
\end{verbatim}

On peut aussi lui indiquer plusieurs valeurs qui seront alors répétées
en boucle~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{), }\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "a" "b" "a" "b" "a" "b"
\end{verbatim}

Dans d'autres situations, on peut avoir besoin de créer un vecteur
contenant une suite de valeurs, ce qui se réalise aisément avec
\texttt{seq()} à qui on précisera les arguments \texttt{from} (point de
départ), \texttt{to} (point d'arrivée) et \texttt{by} (pas). Quelques
exemples valent mieux qu'un long discours~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 [1]  1  2  3  4  5  6  7  8  9 10
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{seq}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{17}\NormalTok{, }\AttributeTok{by =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]  5  7  9 11 13 15 17
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{seq}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 [1] 10  9  8  7  6  5  4  3  2  1  0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{by =} \SpecialCharTok{{-}}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 [1] 100  90  80  70  60  50  40  30  20  10
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{seq}\NormalTok{(}\FloatTok{1.23}\NormalTok{, }\FloatTok{5.67}\NormalTok{, }\AttributeTok{by =} \FloatTok{0.33}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 [1] 1.23 1.56 1.89 2.22 2.55 2.88 3.21 3.54 3.87 4.20 4.53 4.86 5.19 5.52
\end{verbatim}

L'opérateur \texttt{:} est un raccourci de la fonction \texttt{seq()}
pour créer une suite de nombres entiers. Il s'utilise ainsi~:

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1 2 3 4 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{24}\SpecialCharTok{:}\DecValTok{32}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 24 25 26 27 28 29 30 31 32
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{55}\SpecialCharTok{:}\DecValTok{43}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 [1] 55 54 53 52 51 50 49 48 47 46 45 44 43
\end{verbatim}

\hypertarget{longueur-dun-vecteur}{%
\section{Longueur d'un vecteur}\label{longueur-dun-vecteur}}

La longueur d'un vecteur correspond au nombre de valeurs qui le
composent. Elle s'obtient avec \texttt{length()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(taille)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2
\end{verbatim}

La longueur d'un vecteur vide (\texttt{NULL}) est zéro.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(}\ConstantTok{NULL}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0
\end{verbatim}

\hypertarget{combiner-des-vecteurs}{%
\section{Combiner des vecteurs}\label{combiner-des-vecteurs}}

Pour combiner des vecteurs, rien de plus simple. Il suffit d'utiliser
\texttt{c()}~! Les valeurs des différents vecteurs seront mises bout à
bout pour créer un unique vecteur.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\FunctionTok{length}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{9}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\FunctionTok{length}\NormalTok{(y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(x, y)}
\NormalTok{z}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 [1] 2 1 3 4 9 1 2 6 3 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(z)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 10
\end{verbatim}

\hypertarget{vecteurs-nommuxe9s}{%
\section{Vecteurs nommés}\label{vecteurs-nommuxe9s}}

Les différentes valeurs d'un vecteur peuvent être nommées. Une première
manière de nommer les éléments d'un vecteur est de le faire à sa
création~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sexe }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{Michel =} \StringTok{"h"}\NormalTok{, }\AttributeTok{Anne =} \StringTok{"f"}\NormalTok{, }
  \AttributeTok{Dominique =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{Jean =} \StringTok{"h"}\NormalTok{, }
  \AttributeTok{Claude =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{Marie =} \StringTok{"f"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Lorsqu'on affiche le vecteur, la présentation change quelque peu.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sexe}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
   Michel      Anne Dominique      Jean    Claude     Marie 
      "h"       "f"        NA       "h"        NA       "f" 
\end{verbatim}

La liste des noms s'obtient avec \texttt{names()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(sexe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Michel"    "Anne"      "Dominique" "Jean"      "Claude"    "Marie"    
\end{verbatim}

Pour ajouter ou modifier les noms d'un vecteur, on doit attribuer un
nouveau vecteur de noms~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(sexe) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Michael"}\NormalTok{, }\StringTok{"Anna"}\NormalTok{, }\StringTok{"Dom"}\NormalTok{, }\StringTok{"John"}\NormalTok{, }\StringTok{"Alex"}\NormalTok{, }\StringTok{"Mary"}\NormalTok{)}
\NormalTok{sexe}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Michael    Anna     Dom    John    Alex    Mary 
    "h"     "f"      NA     "h"      NA     "f" 
\end{verbatim}

Pour supprimer tous les noms, il y a la fonction \texttt{unname()}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{anonyme }\OtherTok{\textless{}{-}} \FunctionTok{unname}\NormalTok{(sexe)}
\NormalTok{anonyme}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "h" "f" NA  "h" NA  "f"
\end{verbatim}

\hypertarget{indexation-par-position}{%
\section{Indexation par position}\label{indexation-par-position}}

L'indexation est l'une des fonctionnalités les plus puissantes mais
aussi les plus difficiles à maîtriser de \textbf{R}. Il s'agit
d'opérations permettant de sélectionner des sous-ensembles de valeurs en
fonction de différents critères. Il existe trois types d'indexation~:
(i) l'indexation par position, (ii) l'indexation par nom et (iii)
l'indexation par condition. Le principe est toujours le même~: on
indique entre crochets\sidenote{\footnotesize Pour rappel, les crochets s'obtiennent
  sur un clavier français de type PC en appuyant sur la touche Alt~Gr et
  la touche ( ou ).} (\texttt{{[}{]}}) ce qu'on souhaite garder ou non.

Commençons par l'indexation par position encore appelée indexation
directe. Ce mode le plus simple d'indexation consiste à indiquer la
position des éléments à conserver.

Reprenons notre vecteur \texttt{taille}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.88 1.65 1.92 1.76   NA 1.72
\end{verbatim}

Si on souhaite le premier élément du vecteur, on peut faire~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.88
\end{verbatim}

Si on souhaite les trois premiers éléments ou les éléments 2, 5 et 6~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.88 1.65 1.92
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille[}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.65   NA 1.72
\end{verbatim}

Si on veut le dernier élément~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille[}\FunctionTok{length}\NormalTok{(taille)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.72
\end{verbatim}

Il est tout à fait possible de sélectionner les valeurs dans le
désordre~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille[}\FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]   NA 1.88 1.76 1.92
\end{verbatim}

Dans le cadre de l'indexation par position, il est également possible de
spécifier des nombres négatifs, auquel cas cela signifiera toutes les
valeurs sauf celles-là. Par exemple~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille[}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.65 1.92 1.76 1.72
\end{verbatim}

À noter, si on indique une position au-delà de la longueur du vecteur,
\textbf{R} renverra \texttt{NA}. Par exemple~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille[}\DecValTok{23}\SpecialCharTok{:}\DecValTok{25}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] NA NA NA
\end{verbatim}

\hypertarget{indexation-par-nom}{%
\section{Indexation par nom}\label{indexation-par-nom}}

Lorsqu'un vecteur est nommé, il est dès lors possible d'accéder à ses
valeurs à partir de leur nom. Il s'agit de l'indexation par nom.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sexe[}\StringTok{"Anna"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Anna 
 "f" 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sexe[}\FunctionTok{c}\NormalTok{(}\StringTok{"Mary"}\NormalTok{, }\StringTok{"Michael"}\NormalTok{, }\StringTok{"John"}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
   Mary Michael    John 
    "f"     "h"     "h" 
\end{verbatim}

Par contre il n'est pas possible d'utiliser l'opérateur \texttt{-} comme
pour l'indexation directe. Pour exclure un élément en fonction de son
nom, on doit utiliser une autre forme d'indexation, l'indexation par
condition, expliquée dans la section suivante. On peut ainsi
faire\ldots{}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sexe[}\FunctionTok{names}\NormalTok{(sexe) }\SpecialCharTok{!=} \StringTok{"Dom"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\ldots{} pour sélectionner tous les éléments sauf celui qui s'appelle
Dom.

\hypertarget{indexation-par-condition}{%
\section{Indexation par condition}\label{indexation-par-condition}}

L'indexation par condition consiste à fournir un vecteur logique
indiquant si chaque élément doit être inclus (si \texttt{TRUE}) ou exclu
(si \texttt{FALSE}). Par exemple~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sexe}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Michael    Anna     Dom    John    Alex    Mary 
    "h"     "f"      NA     "h"      NA     "f" 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sexe[}\FunctionTok{c}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Michael    John 
    "h"     "h" 
\end{verbatim}

Écrire manuellement une telle condition n'est pas très pratique à
l'usage. Mais supposons que nous ayons également à notre disposition les
deux vecteurs suivants, également de longueur 6.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{urbain }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{)}
\NormalTok{poids }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{80}\NormalTok{, }\DecValTok{63}\NormalTok{, }\DecValTok{75}\NormalTok{, }\DecValTok{87}\NormalTok{, }\DecValTok{82}\NormalTok{, }\DecValTok{67}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Le vecteur \texttt{urbain} est un vecteur logique. On peut directement
l'utiliser pour avoir le sexe des enquêtés habitant en milieu urbain~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sexe[urbain]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Michael    Anna    Mary 
    "h"     "f"     "f" 
\end{verbatim}

Supposons qu'on souhaite maintenant avoir la taille des individus pesant
80 kilogrammes ou plus. Nous pouvons effectuer une comparaison à l'aide
des opérateurs de comparaison suivants~:

\hypertarget{tbl-operateurs-comparaisons}{}
\begin{longtable}[]{@{}ll@{}}
\caption{\label{tbl-operateurs-comparaisons}Opérateurs de
comparaison}\tabularnewline
\toprule()
Opérateur de comparaison & Signification \\
\midrule()
\endfirsthead
\toprule()
Opérateur de comparaison & Signification \\
\midrule()
\endhead
\texttt{==} & égal à \\
\texttt{\%in\%} & appartient à \\
\texttt{!=} & différent de \\
\texttt{\textgreater{}} & strictement supérieur à \\
\texttt{\textless{}} & strictement inférieur à \\
\texttt{\textgreater{}=} & supérieur ou égal à \\
\texttt{\textless{}=} & inférieur ou égal à \\
\bottomrule()
\end{longtable}

Voyons tout de suite un exemple~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{poids }\SpecialCharTok{\textgreater{}=} \DecValTok{80}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]  TRUE FALSE FALSE  TRUE  TRUE FALSE
\end{verbatim}

Que s'est-il passé~? Nous avons fourni à \textbf{R} une condition et il
nous a renvoyé un vecteur logique avec autant d'éléments qu'il y a
d'observations et dont la valeur est \texttt{TRUE} si la condition est
remplie et \texttt{FALSE} dans les autres cas. Nous pouvons alors
utiliser ce vecteur logique pour obtenir la taille des participants
pesant 80 kilogrammes ou plus~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille[poids }\SpecialCharTok{\textgreater{}=} \DecValTok{80}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.88 1.76   NA
\end{verbatim}

On peut combiner ou modifier des conditions à l'aide des opérateurs
logiques habituels~:

\hypertarget{tbl-operateurs-logiques}{}
\begin{longtable}[]{@{}ll@{}}
\caption{\label{tbl-operateurs-logiques}Opérateurs
logiques}\tabularnewline
\toprule()
Opérateur logique & Signification \\
\midrule()
\endfirsthead
\toprule()
Opérateur logique & Signification \\
\midrule()
\endhead
\texttt{\&} & et logique \\
\texttt{\textbar{}} & ou logique \\
\texttt{!} & négation logique \\
\bottomrule()
\end{longtable}

Supposons que je veuille identifier les personnes pesant 80 kilogrammes
ou plus \textbf{et} vivant en milieu urbain~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{poids }\SpecialCharTok{\textgreater{}=} \DecValTok{80} \SpecialCharTok{\&}\NormalTok{ urbain}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]  TRUE FALSE FALSE FALSE FALSE FALSE
\end{verbatim}

Les résultats sont différents si je souhaite isoler les personnes pesant
80 kilogrammes ou plus \textbf{ou} vivant milieu urbain~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{poids }\SpecialCharTok{\textgreater{}=} \DecValTok{80} \SpecialCharTok{|}\NormalTok{ urbain}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]  TRUE  TRUE FALSE  TRUE  TRUE  TRUE
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Comparaison et valeur manquante}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

Une remarque importante~: quand l'un des termes d'une condition comporte
une valeur manquante (\texttt{NA}), le résultat de cette condition n'est
pas toujours \texttt{TRUE} ou \texttt{FALSE}, il peut aussi être à son
tour une valeur manquante.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.88 1.65 1.92 1.76   NA 1.72
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille }\SpecialCharTok{\textgreater{}} \FloatTok{1.8}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]  TRUE FALSE  TRUE FALSE    NA FALSE
\end{verbatim}

On voit que le test \texttt{NA\ \textgreater{}\ 1.8} ne renvoie ni vrai
ni faux, mais \texttt{NA}.

Une autre conséquence importante de ce comportement est qu'on ne peut
pas utiliser l'opérateur l'expression \texttt{==\ NA} pour tester la
présence de valeurs manquantes. On utilisera à la place la fonction
\emph{ad hoc} \texttt{is.na()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{is.na}\NormalTok{(taille }\SpecialCharTok{\textgreater{}} \FloatTok{1.8}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE FALSE  TRUE FALSE
\end{verbatim}

Pour compliquer encore un peu le tout, lorsqu'on utilise une condition
pour l'indexation, si la condition renvoie \texttt{NA}, \textbf{R} ne
sélectionne pas l'élément mais retourne quand même la valeur
\texttt{NA}. Ceci a donc des conséquences sur le résultat d'une
indexation par comparaison.

Par exemple si je cherche à connaître le poids des personnes mesurant
1,80 mètre ou plus~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{taille}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.88 1.65 1.92 1.76   NA 1.72
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{poids}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 80 63 75 87 82 67
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{poids[taille }\SpecialCharTok{\textgreater{}} \FloatTok{1.8}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 80 75 NA
\end{verbatim}

Les éléments pour lesquels la taille n'est pas connue ont été
transformés en \texttt{NA}, ce qui n'influera pas le calcul d'une
moyenne. Par contre, lorsqu'on utilisera assignation et indexation
ensemble, cela peut créer des problèmes. Il est donc préférable
lorsqu'on a des valeurs manquantes de les exclure ainsi~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{poids[taille }\SpecialCharTok{\textgreater{}} \FloatTok{1.8} \SpecialCharTok{\&} \SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(taille)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 80 75
\end{verbatim}

\end{tcolorbox}

\hypertarget{assignation-par-indexation}{%
\section{Assignation par indexation}\label{assignation-par-indexation}}

L'indexation peut être combinée avec l'assignation (opérateur
\texttt{\textless{}-}) pour modifier seulement certaines parties d'un
vecteur. Ceci fonctionne pour les différents types d'indexation évoqués
précédemment.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\DecValTok{5}
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1 2 3 4 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v[}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{3}
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 3 2 3 4 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sexe[}\StringTok{"Alex"}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"non{-}binaire"}
\NormalTok{sexe}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
      Michael          Anna           Dom          John          Alex 
          "h"           "f"            NA           "h" "non-binaire" 
         Mary 
          "f" 
\end{verbatim}

Enfin on peut modifier plusieurs éléments d'un seul coup soit en
fournissant un vecteur, soit en profitant du mécanisme de recyclage. Les
deux commandes suivantes sont ainsi rigoureusement équivalentes~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sexe[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{)] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Homme"}\NormalTok{, }\StringTok{"Homme"}\NormalTok{, }\StringTok{"Homme"}\NormalTok{)}
\NormalTok{sexe[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{)] }\OtherTok{\textless{}{-}} \StringTok{"Homme"}
\end{Highlighting}
\end{Shaded}

L'assignation par indexation peut aussi être utilisée pour ajouter une
ou plusieurs valeurs à un vecteur~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(sexe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sexe[}\DecValTok{7}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"f"}
\NormalTok{sexe}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
      Michael          Anna           Dom          John          Alex 
      "Homme"           "f"       "Homme"       "Homme" "non-binaire" 
         Mary               
          "f"           "f" 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(sexe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 7
\end{verbatim}

\hypertarget{en-ruxe9sumuxe9}{%
\section{En résumé}\label{en-ruxe9sumuxe9}}

\begin{itemize}
\tightlist
\item
  Un vecteur est un objet unidimensionnel contenant une liste de valeurs
  qui sont toutes du même type (entières, numériques, textuelles ou
  logiques).
\item
  La fonction \texttt{class()} permet de connaître le type du vecteur et
  la fonction \texttt{length()} sa longueur, c'est-à-dire son nombre
  d'éléments.
\item
  La fonction \texttt{c()} sert à créer et à combiner des vecteurs.
\item
  Les valeurs manquantes sont représentées avec \texttt{NA}.
\item
  Un vecteur peut être nommé, c'est-à-dire qu'un nom textuel a été
  associé à chaque élément. Cela peut se faire lors de sa création ou
  avec la fonction \texttt{names()}.
\item
  L'indexation consiste à extraire certains éléments d'un vecteur. Pour
  cela, on indique ce qu'on souhaite extraire entre crochets
  (\texttt{{[}{]}}) juste après le nom du vecteur. Le type d'indexation
  dépend du type d'information transmise.
\item
  S'il s'agit de nombres entiers, c'est l'indexation par position~: les
  nombres représentent la position dans le vecteur des éléments qu'on
  souhaite extraire. Un nombre négatif s'interprète comme tous les
  éléments sauf celui-là.
\item
  Si on indique des chaînes de caractères, c'est l'indexation par nom~:
  on indique le nom des éléments qu'on souhaite extraire. Cette forme
  d'indexation ne fonctionne que si le vecteur est nommé.
\item
  Si on transmet des valeurs logiques, le plus souvent sous la forme
  d'une condition, c'est l'indexation par condition~: \texttt{TRUE}
  indique les éléments à extraire et \texttt{FALSE} les éléments à
  exclure. Il faut être vigilant aux valeurs manquantes (\texttt{NA})
  dans ce cas précis.
\item
  Enfin, il est possible de ne modifier que certains éléments d'un
  vecteur en ayant recours à la fois à l'indexation (\texttt{{[}{]}}) et
  à l'assignation (\texttt{\textless{}-}).
\end{itemize}

\hypertarget{webin-r}{%
\section{webin-R}\label{webin-r}}

On pourra également se référer au webin-R \#02 (\emph{les bases du
langage R}) sur \href{https://youtu.be/Eh8piunoqQc}{YouTube}.

\url{https://youtu.be/Eh8piunoqQc}

\hypertarget{sec-listes}{%
\chapter{Listes}\label{sec-listes}}

Par nature, les vecteurs ne peuvent contenir que des valeurs de même
type (numérique, textuel ou logique). Or, on peut avoir besoin de
représenter des objets plus complexes composés d'éléments disparates.
C'est ce que permettent les listes.

\hypertarget{propriuxe9tuxe9s-et-cruxe9ation}{%
\section{Propriétés et création}\label{propriuxe9tuxe9s-et-cruxe9ation}}

Une liste se crée tout simplement avec la fonction \texttt{list()}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l1 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\StringTok{"abc"}\NormalTok{)}
\NormalTok{l1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[[1]]
[1] 1 2 3 4 5

[[2]]
[1] "abc"
\end{verbatim}

Une liste est un ensemble d'objets, quels qu'ils soient, chaque élément
d'une liste pouvant avoir ses propres dimensions. Dans notre exemple
précédent, nous avons créé une liste \texttt{l1} composée de deux
éléments~: un vecteur d'entiers de longueur 5 et un vecteur textuel de
longueur 1. La longueur d'une liste correspond aux nombres d'éléments
qu'elle contient et s'obtient avec \texttt{length()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(l1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2
\end{verbatim}

Comme les vecteurs, une liste peut être nommée et les noms des éléments
d'une liste sont accessibles avec \texttt{names()}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l2 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{minuscules =}\NormalTok{ letters, }
  \AttributeTok{majuscules =}\NormalTok{ LETTERS, }
  \AttributeTok{mois =}\NormalTok{ month.name}
\NormalTok{)}
\NormalTok{l2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
$minuscules
 [1] "a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q" "r" "s"
[20] "t" "u" "v" "w" "x" "y" "z"

$majuscules
 [1] "A" "B" "C" "D" "E" "F" "G" "H" "I" "J" "K" "L" "M" "N" "O" "P" "Q" "R" "S"
[20] "T" "U" "V" "W" "X" "Y" "Z"

$mois
 [1] "January"   "February"  "March"     "April"     "May"       "June"     
 [7] "July"      "August"    "September" "October"   "November"  "December" 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(l2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(l2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "minuscules" "majuscules" "mois"      
\end{verbatim}

Que se passe-t-il maintenant si on effectue la commande suivante~?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(l1, l2)}
\end{Highlighting}
\end{Shaded}

À votre avis, quelle est la longueur de cette nouvelle liste
\texttt{l}~? 5~?

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(l)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2
\end{verbatim}

Eh bien non~! Elle est de longueur 2 car nous avons créé une liste
composée de deux éléments qui sont eux-mêmes des listes. Cela est plus
lisible si on fait appel à la fonction \texttt{str()} qui permet de
visualiser la structure d'un objet.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(l)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
List of 2
 $ :List of 2
  ..$ : int [1:5] 1 2 3 4 5
  ..$ : chr "abc"
 $ :List of 3
  ..$ minuscules: chr [1:26] "a" "b" "c" "d" ...
  ..$ majuscules: chr [1:26] "A" "B" "C" "D" ...
  ..$ mois      : chr [1:12] "January" "February" "March" "April" ...
\end{verbatim}

Une liste peut contenir tous types d'objets, y compris d'autres listes.
Pour combiner les éléments d'une liste, il faut utiliser la fonction
\texttt{append()}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l }\OtherTok{\textless{}{-}} \FunctionTok{append}\NormalTok{(l1, l2)}
\FunctionTok{length}\NormalTok{(l)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(l)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
List of 5
 $           : int [1:5] 1 2 3 4 5
 $           : chr "abc"
 $ minuscules: chr [1:26] "a" "b" "c" "d" ...
 $ majuscules: chr [1:26] "A" "B" "C" "D" ...
 $ mois      : chr [1:12] "January" "February" "March" "April" ...
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

On peut noter en passant qu'une liste peut tout à fait n'être que
partiellement nommée.

\end{tcolorbox}

\hypertarget{indexation}{%
\section{Indexation}\label{indexation}}

Les crochets simples (\texttt{{[}{]}}) fonctionnent comme pour les
vecteurs. On peut utiliser à la fois l'indexation par position,
l'indexation par nom et l'indexation par condition.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[[1]]
[1] 1 2 3 4 5

[[2]]
[1] "abc"

$minuscules
 [1] "a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q" "r" "s"
[20] "t" "u" "v" "w" "x" "y" "z"

$majuscules
 [1] "A" "B" "C" "D" "E" "F" "G" "H" "I" "J" "K" "L" "M" "N" "O" "P" "Q" "R" "S"
[20] "T" "U" "V" "W" "X" "Y" "Z"

$mois
 [1] "January"   "February"  "March"     "April"     "May"       "June"     
 [7] "July"      "August"    "September" "October"   "November"  "December" 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[[1]]
[1] 1 2 3 4 5

$minuscules
 [1] "a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q" "r" "s"
[20] "t" "u" "v" "w" "x" "y" "z"

$majuscules
 [1] "A" "B" "C" "D" "E" "F" "G" "H" "I" "J" "K" "L" "M" "N" "O" "P" "Q" "R" "S"
[20] "T" "U" "V" "W" "X" "Y" "Z"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l[}\FunctionTok{c}\NormalTok{(}\StringTok{"majuscules"}\NormalTok{, }\StringTok{"minuscules"}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
$majuscules
 [1] "A" "B" "C" "D" "E" "F" "G" "H" "I" "J" "K" "L" "M" "N" "O" "P" "Q" "R" "S"
[20] "T" "U" "V" "W" "X" "Y" "Z"

$minuscules
 [1] "a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q" "r" "s"
[20] "t" "u" "v" "w" "x" "y" "z"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l[}\FunctionTok{c}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[[1]]
[1] 1 2 3 4 5

[[2]]
[1] "abc"

$mois
 [1] "January"   "February"  "March"     "April"     "May"       "June"     
 [7] "July"      "August"    "September" "October"   "November"  "December" 
\end{verbatim}

Même si on extrait un seul élément, l'extraction obtenue avec les
crochets simples renvoie toujours une liste, ici composée d'un seul
élément~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(l[}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
List of 1
 $ : int [1:5] 1 2 3 4 5
\end{verbatim}

Supposons que je souhaite calculer la moyenne des valeurs du premier
élément de ma liste. Essayons la commande suivante~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mean}\NormalTok{(l[}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Warning in mean.default(l[1]): l'argument n'est ni numérique, ni logique :
renvoi de NA
\end{verbatim}

\begin{verbatim}
[1] NA
\end{verbatim}

Nous obtenons un message d'erreur. En effet, \textbf{R} ne sait pas
calculer une moyenne à partir d'une liste. Ce qu'il lui faut, c'est un
vecteur de valeurs numériques. Autrement dit, ce que nous cherchons à
obtenir c'est le contenu même du premier élément de notre liste et non
une liste à un seul élément.

C'est ici que les doubles crochets (\texttt{{[}{[}{]}{]}}) vont rentrer
en jeu. Pour ces derniers, nous pourrons utiliser l'indexation par
position ou l'indexation par nom, mais pas l'indexation par condition.
De plus, le critère qu'on indiquera doit indiquer \textbf{un et un seul}
élément de notre liste. Au lieu de renvoyer une liste à un élément, les
doubles crochets vont renvoyer l'élément désigné.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(l[}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
List of 1
 $ : int [1:5] 1 2 3 4 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(l[[}\DecValTok{1}\NormalTok{]])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 int [1:5] 1 2 3 4 5
\end{verbatim}

Maintenant, nous pouvons calculer notre moyenne~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mean}\NormalTok{(l[[}\DecValTok{1}\NormalTok{]])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 3
\end{verbatim}

Nous pouvons aussi utiliser l'indexation par nom.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l[[}\StringTok{"mois"}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 [1] "January"   "February"  "March"     "April"     "May"       "June"     
 [7] "July"      "August"    "September" "October"   "November"  "December" 
\end{verbatim}

Mais il faut avouer que cette écriture avec doubles crochets et
guillemets est un peu lourde. Heureusement, un nouvel acteur entre en
scène~: le symbole dollar (\texttt{\$}). C'est un raccourci des doubles
crochets pour l'indexation par nom qu'on utilise ainsi~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l}\SpecialCharTok{$}\NormalTok{mois}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 [1] "January"   "February"  "March"     "April"     "May"       "June"     
 [7] "July"      "August"    "September" "October"   "November"  "December" 
\end{verbatim}

Les écritures \texttt{l\$mois} et \texttt{l{[}{[}"mois"{]}{]}} sont
équivalentes. Attention~! Cela ne fonctionne que pour l'indexation par
nom.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l}\SpecialCharTok{$}\DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Error: unexpected numeric constant in "l$1"
\end{verbatim}

L'assignation par indexation fonctionne également avec les doubles
crochets ou le signe dollar~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l[[}\DecValTok{2}\NormalTok{]] }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"un"}\NormalTok{, }\StringTok{"vecteur"}\NormalTok{, }\StringTok{"textuel"}\NormalTok{))}
\NormalTok{l}\SpecialCharTok{$}\NormalTok{mois }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Janvier"}\NormalTok{, }\StringTok{"Février"}\NormalTok{, }\StringTok{"Mars"}\NormalTok{)}
\NormalTok{l}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[[1]]
[1] 1 2 3 4 5

[[2]]
[[2]][[1]]
[1] "un"      "vecteur" "textuel"


$minuscules
 [1] "a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q" "r" "s"
[20] "t" "u" "v" "w" "x" "y" "z"

$majuscules
 [1] "A" "B" "C" "D" "E" "F" "G" "H" "I" "J" "K" "L" "M" "N" "O" "P" "Q" "R" "S"
[20] "T" "U" "V" "W" "X" "Y" "Z"

$mois
[1] "Janvier" "Février" "Mars"   
\end{verbatim}

\hypertarget{en-ruxe9sumuxe9-1}{%
\section{En résumé}\label{en-ruxe9sumuxe9-1}}

\begin{itemize}
\tightlist
\item
  Les listes sont des objets unidimensionnels pouvant contenir tout type
  d'objet, y compris d'autres listes.
\item
  Elles ont une longueur qu'on obtient avec \texttt{length()}.
\item
  On crée une liste avec \texttt{list()} et on peut fusionner des listes
  avec \texttt{append()}.
\item
  Tout comme les vecteurs, les listes peuvent être nommées et les noms
  des éléments s'obtiennent avec \texttt{base::names()}.
\item
  Les crochets simples (\texttt{{[}{]}}) permettent de sélectionner les
  éléments d'une liste, en utilisant l'indexation par position,
  l'indexation par nom ou l'indexation par condition. Cela renvoie
  toujours une autre liste.
\item
  Les doubles crochets (\texttt{{[}{[}{]}{]}}) renvoient directement le
  contenu d'un élément de la liste qu'on aura sélectionné par position
  ou par nom.
\item
  Le symbole \texttt{\$} est un raccourci pour facilement sélectionner
  un élément par son nom, \texttt{liste\$nom} étant équivalent à
  \texttt{liste{[}{[}"nom"{]}{]}}.
\end{itemize}

\hypertarget{webin-r-1}{%
\section{webin-R}\label{webin-r-1}}

On pourra également se référer au webin-R \#02 (\emph{les bases du
langage R}) sur \href{https://youtu.be/Eh8piunoqQc}{YouTube}.

\url{https://youtu.be/Eh8piunoqQc}

\hypertarget{sec-tableaux-donnees}{%
\chapter{Tableaux de données}\label{sec-tableaux-donnees}}

Les tableaux de données, ou \emph{data frame} en anglais, est un type
d'objets essentiel pour les données d'enquêtes.

\hypertarget{propriuxe9tuxe9s-et-cruxe9ation-1}{%
\section{Propriétés et
création}\label{propriuxe9tuxe9s-et-cruxe9ation-1}}

Dans \textbf{R}, les tableaux de données sont tout simplement des listes
(voir Chapitre~\ref{sec-listes}) avec quelques propriétés spécifiques~:

\begin{itemize}
\tightlist
\item
  les tableaux de données ne peuvent contenir que des vecteurs~;
\item
  tous les vecteurs d'un tableau de données ont la même longueur~;
\item
  tous les éléments d'un tableau de données sont nommés et ont chacun un
  nom unique.
\end{itemize}

Dès lors, un tableau de données correspond aux fichiers de données qu'on
a l'habitude de manipuler dans d'autres logiciels de statistiques comme
\textbf{SPSS} ou \textbf{Stata}. Les variables sont organisées en
colonnes et les observations en lignes.

On peut créer un tableau de données avec la fonction
\texttt{data.frame()}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{sexe =}  \FunctionTok{c}\NormalTok{(}\StringTok{"f"}\NormalTok{, }\StringTok{"f"}\NormalTok{, }\StringTok{"h"}\NormalTok{, }\StringTok{"h"}\NormalTok{), }
  \AttributeTok{age =} \FunctionTok{c}\NormalTok{(}\DecValTok{52}\NormalTok{, }\DecValTok{31}\NormalTok{, }\DecValTok{29}\NormalTok{, }\DecValTok{35}\NormalTok{), }
  \AttributeTok{blond =} \FunctionTok{c}\NormalTok{(}\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  sexe age blond
1    f  52 FALSE
2    f  31  TRUE
3    h  29  TRUE
4    h  35 FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'data.frame':   4 obs. of  3 variables:
 $ sexe : chr  "f" "f" "h" "h"
 $ age  : num  52 31 29 35
 $ blond: logi  FALSE TRUE TRUE FALSE
\end{verbatim}

Un tableau de données étant une liste, la fonction \texttt{length()}
renverra le nombre d'éléments de la liste, donc dans le cas présent le
nombre de variables, et \texttt{names()} leurs noms~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "sexe"  "age"   "blond"
\end{verbatim}

Comme tous les éléments d'un tableau de données ont la même longueur,
cet objet peut être vu comme bidimensionnel. Les fonctions
\texttt{nrow()}, \texttt{ncol()} et \texttt{dim()} donnent
respectivement le nombre de lignes, le nombre de colonnes et les
dimensions de notre tableau.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nrow}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ncol}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dim}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 4 3
\end{verbatim}

De plus, tout comme les colonnes ont un nom, il est aussi possible de
nommer les lignes avec \texttt{row.names()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{row.names}\NormalTok{(df) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Anna"}\NormalTok{, }\StringTok{"Mary{-}Ann"}\NormalTok{, }\StringTok{"Michael"}\NormalTok{, }\StringTok{"John"}\NormalTok{)}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         sexe age blond
Anna        f  52 FALSE
Mary-Ann    f  31  TRUE
Michael     h  29  TRUE
John        h  35 FALSE
\end{verbatim}

\hypertarget{indexation-1}{%
\section{Indexation}\label{indexation-1}}

Les tableaux de données étant des listes, nous pouvons donc utiliser les
crochets simples (\texttt{{[}{]}}), les crochets doubles
(\texttt{{[}{[}{]}{]}}) et le symbole dollar (\texttt{\$}) pour extraire
des parties de notre tableau, de la même manière que pour n'importe
quelle liste.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         sexe
Anna        f
Mary-Ann    f
Michael     h
John        h
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[[}\DecValTok{1}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "f" "f" "h" "h"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df}\SpecialCharTok{$}\NormalTok{sexe}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "f" "f" "h" "h"
\end{verbatim}

Cependant, un tableau de données étant un objet bidimensionnel, il est
également possible d'extraire des données sur deux dimensions, à savoir
un premier critère portant sur les lignes et un second portant sur les
colonnes. Pour cela, nous utiliserons les crochets simples
(\texttt{{[}{]}}) en séparant nos deux critères par une virgule
(\texttt{,}).

Un premier exemple~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         sexe age blond
Anna        f  52 FALSE
Mary-Ann    f  31  TRUE
Michael     h  29  TRUE
John        h  35 FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 29
\end{verbatim}

Cette première commande indique que nous souhaitons la troisième ligne
de la seconde colonne, autrement dit l'âge de Michael. Le même résultat
peut être obtenu avec l'indexation par nom, l'indexation par condition,
ou un mélange de tout ça.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\StringTok{"Michael"}\NormalTok{, }\StringTok{"age"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 29
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\FunctionTok{c}\NormalTok{(F, F, T, F), }\FunctionTok{c}\NormalTok{(F, T, F)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 29
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\DecValTok{3}\NormalTok{, }\StringTok{"age"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 29
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\StringTok{"Michael"}\NormalTok{, }\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 29
\end{verbatim}

Il est également possible de préciser un seul critère. Par exemple, si
je souhaite les deux premières observations, ou les variables
\emph{sexe} et \emph{blond}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{,]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         sexe age blond
Anna        f  52 FALSE
Mary-Ann    f  31  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[,}\FunctionTok{c}\NormalTok{(}\StringTok{"sexe"}\NormalTok{, }\StringTok{"blond"}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         sexe blond
Anna        f FALSE
Mary-Ann    f  TRUE
Michael     h  TRUE
John        h FALSE
\end{verbatim}

Il a suffi de laisser un espace vide avant ou après la virgule.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-warning-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-warning-color}{\faExclamationTriangle}\hspace{0.5em}{Avertissement}, bottomrule=.15mm, colframe=quarto-callout-warning-color-frame]

ATTENTION~! Il est cependant impératif de laisser la virgule pour
indiquer à \textbf{R} qu'on souhaite effectuer une indexation à deux
dimensions. Si on oublie la virgule, cela nous ramène au mode de
fonctionnement des listes. Et le résultat n'est pas forcément le même~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\DecValTok{2}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         sexe age blond
Mary-Ann    f  31  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[, }\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 52 31 29 35
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         age
Anna      52
Mary-Ann  31
Michael   29
John      35
\end{verbatim}

\end{tcolorbox}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

Au passage, on pourra noter quelques subtilités sur le résultat renvoyé.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(df[}\DecValTok{2}\NormalTok{, ])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'data.frame':   1 obs. of  3 variables:
 $ sexe : chr "f"
 $ age  : num 31
 $ blond: logi TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(df[, }\DecValTok{2}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 num [1:4] 52 31 29 35
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(df[}\DecValTok{2}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'data.frame':   4 obs. of  1 variable:
 $ age: num  52 31 29 35
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(df[[}\DecValTok{2}\NormalTok{]])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 num [1:4] 52 31 29 35
\end{verbatim}

\texttt{df{[}2,\ {]}} signifie qu'on veut toutes les variables pour le
second individu. Le résultat est un tableau de données à une ligne et
trois colonnes. \texttt{df{[}2{]}} correspond au mode d'extraction des
listes et renvoie donc une liste à un élément, en l'occurrence un
tableau de données à quatre observations et une variable.
\texttt{df{[}{[}2{]}{]}} quant à lui renvoie le contenu de cette
variable, soit un vecteur numérique de longueur quatre. Reste
\texttt{df{[},\ 2{]}} qui renvoie toutes les observations pour la
seconde colonne. Or l'indexation bidimensionnelle a un fonctionnement un
peu particulier~: par défaut elle renvoie un tableau de données mais
s'il y a une seule variable dans l'extraction, c'est un vecteur qui est
renvoyé. Pour plus de détails, on pourra consulter l'entrée d'aide
\texttt{help("{[}.data.frame")}.

\end{tcolorbox}

\hypertarget{sec-afficher-donnees}{%
\section{Afficher les données}\label{sec-afficher-donnees}}

Prenons un tableau de données un peu plus conséquent, en l'occurrence le
jeu de données \texttt{?questionr::hdv2003} disponible dans l'extension
\texttt{\{questionr\}} et correspondant à un extrait de l'enquête
\emph{Histoire de vie} réalisée par l'INSEE en 2003. Il contient 2000
individus et 20 variables.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(questionr)}
\FunctionTok{data}\NormalTok{(hdv2003)}
\end{Highlighting}
\end{Shaded}

Si on demande d'afficher l'objet \texttt{hdv2003} dans la console
(résultat non reproduit ici), \textbf{R} va afficher l'ensemble du
contenu de \texttt{hdv2003} à l'écran ce qui, sur un tableau de cette
taille, ne sera pas très lisible. Pour une exploration visuelle, le plus
simple est souvent d'utiliser la visionneuse intégrée à \textbf{RStudio}
et qu'on peut appeler avec la fonction \texttt{View()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{View}\NormalTok{(hdv2003)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics{bases/ressources/rstudio_view_hdv2003.png}

}

\caption{\label{fig-view}Interface View() de R RStudio}

\end{figure}

Les fonctions \texttt{head()} et \texttt{tail()}, qui marchent également
sur les vecteurs, permettent d'afficher seulement les premières
(respectivement les dernières) lignes d'un tableau de données~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(hdv2003)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  id age  sexe                                              nivetud    poids
1  1  28 Femme Enseignement superieur y compris technique superieur 2634.398
2  2  23 Femme                                                 <NA> 9738.396
3  3  59 Homme                    Derniere annee d'etudes primaires 3994.102
4  4  34 Homme Enseignement superieur y compris technique superieur 5731.662
5  5  71 Femme                    Derniere annee d'etudes primaires 4329.094
6  6  35 Femme        Enseignement technique ou professionnel court 8674.699
                  occup     qualif freres.soeurs clso
1 Exerce une profession    Employe             8  Oui
2       Etudiant, eleve       <NA>             2  Oui
3 Exerce une profession Technicien             2  Non
4 Exerce une profession Technicien             1  Non
5              Retraite    Employe             0  Oui
6 Exerce une profession    Employe             5  Non
                        relig                     trav.imp    trav.satisf
1 Ni croyance ni appartenance                Peu important Insatisfaction
2 Ni croyance ni appartenance                         <NA>           <NA>
3 Ni croyance ni appartenance Aussi important que le reste      Equilibre
4  Appartenance sans pratique Moins important que le reste   Satisfaction
5         Pratiquant regulier                         <NA>           <NA>
6 Ni croyance ni appartenance            Le plus important      Equilibre
  hard.rock lecture.bd peche.chasse cuisine bricol cinema sport heures.tv
1       Non        Non          Non     Oui    Non    Non   Non         0
2       Non        Non          Non     Non    Non    Oui   Oui         1
3       Non        Non          Non     Non    Non    Non   Oui         0
4       Non        Non          Non     Oui    Oui    Oui   Oui         2
5       Non        Non          Non     Non    Non    Non   Non         3
6       Non        Non          Non     Non    Non    Oui   Oui         2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tail}\NormalTok{(hdv2003, }\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
       id age  sexe                                       nivetud     poids
1999 1999  24 Femme Enseignement technique ou professionnel court 13740.810
2000 2000  66 Femme  Enseignement technique ou professionnel long  7709.513
                     occup  qualif freres.soeurs clso
1999 Exerce une profession Employe             2  Non
2000              Au foyer Employe             3  Non
                          relig                     trav.imp trav.satisf
1999 Appartenance sans pratique Moins important que le reste   Equilibre
2000 Appartenance sans pratique                         <NA>        <NA>
     hard.rock lecture.bd peche.chasse cuisine bricol cinema sport heures.tv
1999       Non        Non          Non     Non    Non    Oui   Non       0.3
2000       Non        Oui          Non     Oui    Non    Non   Non       0.0
\end{verbatim}

L'extension \texttt{\{dplyr\}} propose une fonction
\texttt{dplyr::glimpse()} (ce qui signifie aperçu en anglais) qui permet
de visualiser rapidement et de manière condensée le contenu d'un tableau
de données.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{glimpse}\NormalTok{(hdv2003)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Rows: 2,000
Columns: 20
$ id            <int> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 1~
$ age           <int> 28, 23, 59, 34, 71, 35, 60, 47, 20, 28, 65, 47, 63, 67, ~
$ sexe          <fct> Femme, Femme, Homme, Homme, Femme, Femme, Femme, Homme, ~
$ nivetud       <fct> "Enseignement superieur y compris technique superieur", ~
$ poids         <dbl> 2634.3982, 9738.3958, 3994.1025, 5731.6615, 4329.0940, 8~
$ occup         <fct> "Exerce une profession", "Etudiant, eleve", "Exerce une ~
$ qualif        <fct> Employe, NA, Technicien, Technicien, Employe, Employe, O~
$ freres.soeurs <int> 8, 2, 2, 1, 0, 5, 1, 5, 4, 2, 3, 4, 1, 5, 2, 3, 4, 0, 2,~
$ clso          <fct> Oui, Oui, Non, Non, Oui, Non, Oui, Non, Oui, Non, Oui, O~
$ relig         <fct> Ni croyance ni appartenance, Ni croyance ni appartenance~
$ trav.imp      <fct> Peu important, NA, Aussi important que le reste, Moins i~
$ trav.satisf   <fct> Insatisfaction, NA, Equilibre, Satisfaction, NA, Equilib~
$ hard.rock     <fct> Non, Non, Non, Non, Non, Non, Non, Non, Non, Non, Non, N~
$ lecture.bd    <fct> Non, Non, Non, Non, Non, Non, Non, Non, Non, Non, Non, N~
$ peche.chasse  <fct> Non, Non, Non, Non, Non, Non, Oui, Oui, Non, Non, Non, N~
$ cuisine       <fct> Oui, Non, Non, Oui, Non, Non, Oui, Oui, Non, Non, Oui, N~
$ bricol        <fct> Non, Non, Non, Oui, Non, Non, Non, Oui, Non, Non, Oui, O~
$ cinema        <fct> Non, Oui, Non, Oui, Non, Oui, Non, Non, Oui, Oui, Oui, N~
$ sport         <fct> Non, Oui, Oui, Oui, Non, Oui, Non, Non, Non, Oui, Non, O~
$ heures.tv     <dbl> 0.0, 1.0, 0.0, 2.0, 3.0, 2.0, 2.9, 1.0, 2.0, 2.0, 1.0, 0~
\end{verbatim}

L'extension \texttt{\{labelled\}} propose une fonction
\texttt{labelled::look\_for()} qui permet de lister les différentes
variables d'un fichier de données~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(labelled)}
\FunctionTok{look\_for}\NormalTok{(hdv2003)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable      label col_type missing
 1   id            —     int      0      
 2   age           —     int      0      
 3   sexe          —     fct      0      
                                         
 4   nivetud       —     fct      112    
                                         
                                         
                                         
                                         
                                         
                                         
                                         
 5   poids         —     dbl      0      
 6   occup         —     fct      0      
                                         
                                         
                                         
                                         
                                         
                                         
 7   qualif        —     fct      347    
                                         
                                         
                                         
                                         
                                         
                                         
 8   freres.soeurs —     int      0      
 9   clso          —     fct      0      
                                         
                                         
 10  relig         —     fct      0      
                                         
                                         
                                         
                                         
                                         
 11  trav.imp      —     fct      952    
                                         
                                         
                                         
 12  trav.satisf   —     fct      952    
                                         
                                         
 13  hard.rock     —     fct      0      
                                         
 14  lecture.bd    —     fct      0      
                                         
 15  peche.chasse  —     fct      0      
                                         
 16  cuisine       —     fct      0      
                                         
 17  bricol        —     fct      0      
                                         
 18  cinema        —     fct      0      
                                         
 19  sport         —     fct      0      
                                         
 20  heures.tv     —     dbl      5      
 values                                     
                                            
                                            
 Homme                                      
 Femme                                      
 N'a jamais fait d'etudes                   
 A arrete ses etudes, avant la derniere ann~
 Derniere annee d'etudes primaires          
 1er cycle                                  
 2eme cycle                                 
 Enseignement technique ou professionnel co~
 Enseignement technique ou professionnel lo~
 Enseignement superieur y compris technique~
                                            
 Exerce une profession                      
 Chomeur                                    
 Etudiant, eleve                            
 Retraite                                   
 Retire des affaires                        
 Au foyer                                   
 Autre inactif                              
 Ouvrier specialise                         
 Ouvrier qualifie                           
 Technicien                                 
 Profession intermediaire                   
 Cadre                                      
 Employe                                    
 Autre                                      
                                            
 Oui                                        
 Non                                        
 Ne sait pas                                
 Pratiquant regulier                        
 Pratiquant occasionnel                     
 Appartenance sans pratique                 
 Ni croyance ni appartenance                
 Rejet                                      
 NSP ou NVPR                                
 Le plus important                          
 Aussi important que le reste               
 Moins important que le reste               
 Peu important                              
 Satisfaction                               
 Insatisfaction                             
 Equilibre                                  
 Non                                        
 Oui                                        
 Non                                        
 Oui                                        
 Non                                        
 Oui                                        
 Non                                        
 Oui                                        
 Non                                        
 Oui                                        
 Non                                        
 Oui                                        
 Non                                        
 Oui                                        
                                            
\end{verbatim}

Lorsqu'on a un gros tableau de données avec de nombreuses variables, il
peut être difficile de retrouver la ou les variables d'intérêt. Il est
possible d'indiquer à \texttt{labelled::look\_for()} un mot-clé pour
limiter la recherche. Par exemple~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{look\_for}\NormalTok{(hdv2003, }\StringTok{"trav"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable    label col_type missing values                      
 11  trav.imp    —     fct      952     Le plus important           
                                        Aussi important que le reste
                                        Moins important que le reste
                                        Peu important               
 12  trav.satisf —     fct      952     Satisfaction                
                                        Insatisfaction              
                                        Equilibre                   
\end{verbatim}

Il est à noter que si la recherche n'est pas sensible à la casse
(i.e.~aux majuscules et aux minuscules), elle est sensible aux accents.

La méthode \texttt{summary()} qui fonctionne sur tout type d'objet
permet d'avoir quelques statistiques de base sur les différentes
variables de notre tableau, les statistiques affichées dépendant du type
de variable.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(hdv2003)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
       id              age           sexe     
 Min.   :   1.0   Min.   :18.00   Homme: 899  
 1st Qu.: 500.8   1st Qu.:35.00   Femme:1101  
 Median :1000.5   Median :48.00               
 Mean   :1000.5   Mean   :48.16               
 3rd Qu.:1500.2   3rd Qu.:60.00               
 Max.   :2000.0   Max.   :97.00               
                                              
                                                 nivetud        poids         
 Enseignement technique ou professionnel court       :463   Min.   :   78.08  
 Enseignement superieur y compris technique superieur:441   1st Qu.: 2221.82  
 Derniere annee d'etudes primaires                   :341   Median : 4631.19  
 1er cycle                                           :204   Mean   : 5535.61  
 2eme cycle                                          :183   3rd Qu.: 7626.53  
 (Other)                                             :256   Max.   :31092.14  
 NA's                                                :112                     
                   occup                           qualif    freres.soeurs   
 Exerce une profession:1049   Employe                 :594   Min.   : 0.000  
 Chomeur              : 134   Ouvrier qualifie        :292   1st Qu.: 1.000  
 Etudiant, eleve      :  94   Cadre                   :260   Median : 2.000  
 Retraite             : 392   Ouvrier specialise      :203   Mean   : 3.283  
 Retire des affaires  :  77   Profession intermediaire:160   3rd Qu.: 5.000  
 Au foyer             : 171   (Other)                 :144   Max.   :22.000  
 Autre inactif        :  83   NA's                    :347                   
          clso                              relig    
 Oui        : 936   Pratiquant regulier        :266  
 Non        :1037   Pratiquant occasionnel     :442  
 Ne sait pas:  27   Appartenance sans pratique :760  
                    Ni croyance ni appartenance:399  
                    Rejet                      : 93  
                    NSP ou NVPR                : 40  
                                                     
                         trav.imp           trav.satisf  hard.rock  lecture.bd
 Le plus important           : 29   Satisfaction  :480   Non:1986   Non:1953  
 Aussi important que le reste:259   Insatisfaction:117   Oui:  14   Oui:  47  
 Moins important que le reste:708   Equilibre     :451                        
 Peu important               : 52   NA's          :952                        
 NA's                        :952                                             
                                                                              
                                                                              
 peche.chasse cuisine    bricol     cinema     sport        heures.tv     
 Non:1776     Non:1119   Non:1147   Non:1174   Non:1277   Min.   : 0.000  
 Oui: 224     Oui: 881   Oui: 853   Oui: 826   Oui: 723   1st Qu.: 1.000  
                                                          Median : 2.000  
                                                          Mean   : 2.247  
                                                          3rd Qu.: 3.000  
                                                          Max.   :12.000  
                                                          NA's   :5       
\end{verbatim}

On peut également appliquer \texttt{summary()} à une variable
particulière.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(hdv2003}\SpecialCharTok{$}\NormalTok{sexe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Homme Femme 
  899  1101 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(hdv2003}\SpecialCharTok{$}\NormalTok{age)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  18.00   35.00   48.00   48.16   60.00   97.00 
\end{verbatim}

\hypertarget{en-ruxe9sumuxe9-2}{%
\section{En résumé}\label{en-ruxe9sumuxe9-2}}

\begin{itemize}
\tightlist
\item
  Les tableaux de données sont des listes avec des propriétés
  particulières~:

  \begin{enumerate}
  \def\labelenumi{\roman{enumi}.}
  \tightlist
  \item
    tous les éléments sont des vecteurs~;
  \item
    tous les vecteurs ont la même longueur~;
  \item
    tous les vecteurs ont un nom et ce nom est unique.
  \end{enumerate}
\item
  On peut créer un tableau de données avec \texttt{data.frame()}.
\item
  Les tableaux de données correspondent aux fichiers de données qu'on
  utilise usuellement dans d'autres logiciels de statistiques~: les
  variables sont représentées en colonnes et les observations en lignes.
\item
  Ce sont des objets bidimensionnels~: \texttt{ncol()} renvoie le nombre
  de colonnes et \texttt{nrow()} le nombre de lignes.
\item
  Les doubles crochets (\texttt{{[}{[}{]}{]}}) et le symbole dollar
  (\texttt{\$}) fonctionnent comme pour les listes et permettent
  d'accéder aux variables.
\item
  Il est possible d'utiliser des coordonnées bidimensionnelles avec les
  crochets simples (\texttt{{[}{]}}) en indiquant un critère sur les
  lignes puis un critère sur les colonnes, séparés par une virgule
  (\texttt{,}).
\end{itemize}

\hypertarget{webin-r-2}{%
\section{webin-R}\label{webin-r-2}}

On pourra également se référer au webin-R \#02 (\emph{les bases du
langage R}) sur \href{https://youtu.be/Eh8piunoqQc}{YouTube}.

\url{https://youtu.be/Eh8piunoqQc}

\hypertarget{sec-tibbles}{%
\chapter{Tibbles}\label{sec-tibbles}}

\hypertarget{sec-tidy-data}{%
\section{Le concept de tidy data}\label{sec-tidy-data}}

Le \texttt{\{tidyverse\}} est en partie fondé sur le concept de
\emph{tidy data}, développé à l'origine par Hadley Wickham dans un
\href{https://www.jstatsoft.org/article/view/v059i10}{article de 2014}
du \emph{Journal of Statistical Software}.

Il s'agit d'un modèle d'organisation des données qui vise à faciliter le
travail souvent long et fastidieux de nettoyage et de préparation
préalable à la mise en oeuvre de méthodes d'analyse.

Les principes d'un jeu de données \emph{tidy} sont les suivants~:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  chaque variable est une colonne
\item
  chaque observation est une ligne
\item
  chaque type d'observation est dans une table différente
\end{enumerate}

Un chapitre dédié à \texttt{\{tidyr\}} (voir Chapitre~\ref{sec-tidyr})
présente comment définir et rendre des données \emph{tidy} avec ce
package.

Les extensions du \texttt{\{tidyverse\}}, notamment \texttt{\{ggplot2\}}
et \texttt{\{dplyr\}}, sont prévues pour fonctionner avec des données
\emph{tidy}.

\hypertarget{tibbles}{%
\section{tibbles~: des tableaux de données améliorés}\label{tibbles}}

Une autre particularité du \texttt{\{tidyverse\}} est que ces extensions
travaillent avec des tableaux de données au format
\texttt{tibble::tibble()}, qui est une évolution plus moderne du
classique \texttt{data.frame} de \textbf{R} de base.

Ce format est fourni est géré par l'extension du même nom
(\texttt{\{tibble\}}), qui fait partie du coeur du \emph{tidyverse}. La
plupart des fonctions des extensions du \emph{tidyverse} acceptent des
\emph{data.frames} en entrée, mais retournent un \emph{tibble}.

Contrairement aux \emph{data frames}, les \emph{tibbles}~:

\begin{itemize}
\tightlist
\item
  n'ont pas de noms de lignes (\emph{rownames})
\item
  autorisent des noms de colonnes invalides pour les \emph{data frames}
  (espaces, caractères spéciaux, nombres\ldots) \sidenote{\footnotesize Quand on veut
    utiliser des noms de ce type, on doit les entourer avec des
    \emph{backticks} (`)}
\item
  s'affichent plus intelligemment que les \emph{data frames}~: seules
  les premières lignes sont affichées, ainsi que quelques informations
  supplémentaires utiles (dimensions, types des colonnes\ldots)
\item
  ne font pas de \emph{partial matching} sur les noms de colonnes
  \sidenote{\footnotesize Dans \textbf{R} base, si une table \texttt{d} contient une
    colonne \texttt{qualif}, \texttt{d\$qual} retournera cette colonne.}
\item
  affichent un avertissement si on essaie d'accéder à une colonne qui
  n'existe pas
\end{itemize}

Pour autant, les tibbles restent compatibles avec les \emph{data
frames}.

Il est possible de créer un \emph{tibble} manuellement avec
\texttt{tibble::tibble()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{tibble}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\FloatTok{1.2345}\NormalTok{, }\FloatTok{12.345}\NormalTok{, }\FloatTok{123.45}\NormalTok{, }\FloatTok{1234.5}\NormalTok{, }\DecValTok{12345}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"c"}\NormalTok{, }\StringTok{"d"}\NormalTok{, }\StringTok{"e"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 2
         x y    
     <dbl> <chr>
1     1.23 a    
2    12.3  b    
3   123.   c    
4  1234.   d    
5 12345    e    
\end{verbatim}

On peut ainsi facilement convertir un \emph{data frame} en tibble avec
\texttt{tibble::as\_tibble()}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\OtherTok{\textless{}{-}} \FunctionTok{as\_tibble}\NormalTok{(mtcars)}
\NormalTok{d}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 32 x 11
     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
   <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
 1  21       6  160    110  3.9   2.62  16.5     0     1     4     4
 2  21       6  160    110  3.9   2.88  17.0     0     1     4     4
 3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
 4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
 5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
 6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
 7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
 8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2
 9  22.8     4  141.    95  3.92  3.15  22.9     1     0     4     2
10  19.2     6  168.   123  3.92  3.44  18.3     1     0     4     4
# i 22 more rows
\end{verbatim}

D'ailleurs, quand on regarde la classe d'un tibble, on peut s'apercevoir
qu'un tibble hérite de la classe \texttt{data.frame} mais possède en
plus la classe \texttt{tbl\_df}. Cela traduit bien le fait que les
\emph{tibbles} restent des \emph{data frames}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(d)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "tbl_df"     "tbl"        "data.frame"
\end{verbatim}

Si le \emph{data frame} d'origine a des \emph{rownames}, on peut d'abord
les convertir en colonnes avec \texttt{tibble::rownames\_to\_column()}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\OtherTok{\textless{}{-}} \FunctionTok{as\_tibble}\NormalTok{(}\FunctionTok{rownames\_to\_column}\NormalTok{(mtcars))}
\NormalTok{d}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 32 x 12
   rowname       mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
   <chr>       <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
 1 Mazda RX4    21       6  160    110  3.9   2.62  16.5     0     1     4     4
 2 Mazda RX4 ~  21       6  160    110  3.9   2.88  17.0     0     1     4     4
 3 Datsun 710   22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
 4 Hornet 4 D~  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
 5 Hornet Spo~  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
 6 Valiant      18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
 7 Duster 360   14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
 8 Merc 240D    24.4     4  147.    62  3.69  3.19  20       1     0     4     2
 9 Merc 230     22.8     4  141.    95  3.92  3.15  22.9     1     0     4     2
10 Merc 280     19.2     6  168.   123  3.92  3.44  18.3     1     0     4     4
# i 22 more rows
\end{verbatim}

À l'inverse, on peut à tout moment convertir un tibble en \emph{data
frame} avec \texttt{tibble::as.data.frame()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{as.data.frame}\NormalTok{(d)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
               rowname  mpg cyl  disp  hp drat    wt  qsec vs am gear carb
1            Mazda RX4 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
2        Mazda RX4 Wag 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
3           Datsun 710 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
4       Hornet 4 Drive 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
5    Hornet Sportabout 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
6              Valiant 18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
7           Duster 360 14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
8            Merc 240D 24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
9             Merc 230 22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
10            Merc 280 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
11           Merc 280C 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
12          Merc 450SE 16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
13          Merc 450SL 17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
14         Merc 450SLC 15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
15  Cadillac Fleetwood 10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
16 Lincoln Continental 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
17   Chrysler Imperial 14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
18            Fiat 128 32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
19         Honda Civic 30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
20      Toyota Corolla 33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
21       Toyota Corona 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
22    Dodge Challenger 15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
23         AMC Javelin 15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
24          Camaro Z28 13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
25    Pontiac Firebird 19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
26           Fiat X1-9 27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
27       Porsche 914-2 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
28        Lotus Europa 30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
29      Ford Pantera L 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
30        Ferrari Dino 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
31       Maserati Bora 15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8
32          Volvo 142E 21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2
\end{verbatim}

Là encore, on peut convertir la colonne \emph{rowname} en ``vrais''
\emph{rownames} avec \texttt{tibble::column\_to\_rownames()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{column\_to\_rownames}\NormalTok{(}\FunctionTok{as.data.frame}\NormalTok{(d))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
Mazda RX4           21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
Mazda RX4 Wag       21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
Datsun 710          22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
Hornet 4 Drive      21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
Hornet Sportabout   18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
Valiant             18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
Duster 360          14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
Merc 240D           24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
Merc 230            22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
Merc 280            19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
Merc 280C           17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
Merc 450SE          16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
Merc 450SL          17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
Merc 450SLC         15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
Cadillac Fleetwood  10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
Lincoln Continental 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
Chrysler Imperial   14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
Fiat 128            32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
Honda Civic         30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
Toyota Corolla      33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
Toyota Corona       21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
Dodge Challenger    15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
AMC Javelin         15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
Camaro Z28          13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
Pontiac Firebird    19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
Fiat X1-9           27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
Porsche 914-2       26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
Lotus Europa        30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
Ford Pantera L      15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
Ferrari Dino        19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
Maserati Bora       15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8
Volvo 142E          21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

Les deux fonctions \texttt{tibble::column\_to\_rownames()} et
\texttt{tibble::rownames\_to\_column()} acceptent un argument
supplémentaire \texttt{var} qui permet d'indiquer un nom de colonne
autre que le nom \texttt{rowname} utilisé par défaut pour créer ou
identifier la colonne contenant les noms de lignes.

\end{tcolorbox}

\hypertarget{donnuxe9es-et-tableaux-imbriquuxe9s}{%
\section{Données et tableaux
imbriqués}\label{donnuxe9es-et-tableaux-imbriquuxe9s}}

Une des particularités des \emph{tibbles} est qu'ils acceptent, à la
différence des \emph{data frames}, des colonnes composées de listes et,
par extension, d'autres tibbles (qui sont des listes) ~!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(}
  \AttributeTok{g =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{),}
  \AttributeTok{data =} \FunctionTok{list}\NormalTok{(}
    \FunctionTok{tibble}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\NormalTok{, }\AttributeTok{y =} \DecValTok{2}\NormalTok{),}
    \FunctionTok{tibble}\NormalTok{(}\AttributeTok{x =} \DecValTok{4}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\AttributeTok{y =} \DecValTok{6}\SpecialCharTok{:}\DecValTok{7}\NormalTok{),}
    \FunctionTok{tibble}\NormalTok{(}\AttributeTok{x =} \DecValTok{10}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}
\NormalTok{d}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 3 x 2
      g data            
  <dbl> <list>          
1     1 <tibble [1 x 2]>
2     2 <tibble [2 x 2]>
3     3 <tibble [1 x 1]>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d}\SpecialCharTok{$}\NormalTok{data[[}\DecValTok{2}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 2
      x     y
  <int> <int>
1     4     6
2     5     7
\end{verbatim}

Cette fonctionalité, combinée avec les fonctions de \texttt{\{tidyr\}}
et de \texttt{\{purrr\}}, s'avère très puissante pour réaliser des
opérations multiples en peu de ligne de code.

Dans l'exemple ci-dessous, nous réalisons des régressions linéaires par
sous-groupe et les présentons dans un même tableau. Pour le moment, le
code présenté doit vous sembler complexe et un peu obscur. Pas de
panique : tout cela sera clarifié dans les differents chapitres de ce
guide. Ce qu'il y a à retenir pour le moment, c'est la possibilité de
stocker, dans les colonnes d'un \emph{tibble}, différent types de
données, y compris des sous-tableaux, des résultats de modèles et même
des tableaux mis en forme.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{reg }\OtherTok{\textless{}{-}}
\NormalTok{  iris }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(Species) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{nest}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{model =} \FunctionTok{map}\NormalTok{(}
\NormalTok{      data, }
      \SpecialCharTok{\textasciitilde{}} \FunctionTok{lm}\NormalTok{(Sepal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Petal.Length }\SpecialCharTok{+}\NormalTok{ Petal.Width, }\AttributeTok{data =}\NormalTok{ .)}
\NormalTok{    ),}
    \AttributeTok{tbl =} \FunctionTok{map}\NormalTok{(model, gtsummary}\SpecialCharTok{::}\NormalTok{tbl\_regression)}
\NormalTok{  )}
\NormalTok{reg}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 3 x 4
# Groups:   Species [3]
  Species    data              model  tbl       
  <fct>      <list>            <list> <list>    
1 setosa     <tibble [50 x 4]> <lm>   <tbl_rgrs>
2 versicolor <tibble [50 x 4]> <lm>   <tbl_rgrs>
3 virginica  <tibble [50 x 4]> <lm>   <tbl_rgrs>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gtsummary}\SpecialCharTok{::}\FunctionTok{tbl\_merge}\NormalTok{(}
\NormalTok{  reg}\SpecialCharTok{$}\NormalTok{tbl,}
  \AttributeTok{tab\_spanner =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"**"}\NormalTok{, reg}\SpecialCharTok{$}\NormalTok{Species, }\StringTok{"**"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 18\tabcolsep) * \real{0.1508}}
  >{\centering\arraybackslash}p{(\columnwidth - 18\tabcolsep) * \real{0.0794}}
  >{\centering\arraybackslash}p{(\columnwidth - 18\tabcolsep) * \real{0.1032}}
  >{\centering\arraybackslash}p{(\columnwidth - 18\tabcolsep) * \real{0.1032}}
  >{\centering\arraybackslash}p{(\columnwidth - 18\tabcolsep) * \real{0.0794}}
  >{\centering\arraybackslash}p{(\columnwidth - 18\tabcolsep) * \real{0.0952}}
  >{\centering\arraybackslash}p{(\columnwidth - 18\tabcolsep) * \real{0.1032}}
  >{\centering\arraybackslash}p{(\columnwidth - 18\tabcolsep) * \real{0.0794}}
  >{\centering\arraybackslash}p{(\columnwidth - 18\tabcolsep) * \real{0.1032}}
  >{\centering\arraybackslash}p{(\columnwidth - 18\tabcolsep) * \real{0.1032}}@{}}
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Characteristic}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Beta}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% CI}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-value}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Beta}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% CI}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-value}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Beta}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% CI}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-value}
\end{minipage} \\
\midrule()
\endhead
Petal.Length & 0.40 & -0.20, 0.99 & 0.2 & 0.93 & 0.59, 1.3 &
\textless0.001 & 1.0 & 0.81, 1.2 & \textless0.001 \\
Petal.Width & 0.71 & -0.27, 1.7 & 0.2 & -0.32 & -1.1, 0.49 & 0.4 & 0.01
& -0.35, 0.37 & \textgreater0.9 \\
\bottomrule()
\end{longtable}

\hypertarget{sec-attributs}{%
\chapter{Attributs}\label{sec-attributs}}

Les objets \textbf{R} peuvent avoir des attributs qui correspondent en
quelque sorte à des métadonnées associées à l'objet en question.
Techniquement, un attribut peut être tout type d'objet \textbf{R} (un
vecteur, une liste, une fonction\ldots).

Parmi les attributs les plus courants, on retrouve nottament~:

\begin{itemize}
\tightlist
\item
  \texttt{class}~: la classe de l'objet
\item
  \texttt{lenghth}~: sa longueur
\item
  \texttt{names}~: les noms donnés aux éléments de l'objet
\item
  \texttt{levels}~: pour les facteurs, les étiquettes des différents
  niveaux
\item
  \texttt{label}~: une étiquette de variable
\end{itemize}

La fonction \texttt{attributes()} permet de lister tous les attributs
associés à un objet.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attributes}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
$names
[1] "Sepal.Length" "Sepal.Width"  "Petal.Length" "Petal.Width"  "Species"     

$class
[1] "data.frame"

$row.names
  [1]   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18
 [19]  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36
 [37]  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52  53  54
 [55]  55  56  57  58  59  60  61  62  63  64  65  66  67  68  69  70  71  72
 [73]  73  74  75  76  77  78  79  80  81  82  83  84  85  86  87  88  89  90
 [91]  91  92  93  94  95  96  97  98  99 100 101 102 103 104 105 106 107 108
[109] 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126
[127] 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144
[145] 145 146 147 148 149 150
\end{verbatim}

Pour accéder à un attribut spécifique, on aura recours à \texttt{attr()}
en spéficiant à la fois l'objet considéré et le nom de l'attribut
souhaité.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\SpecialCharTok{|\textgreater{}} \FunctionTok{attr}\NormalTok{(}\StringTok{"names"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Sepal.Length" "Sepal.Width"  "Petal.Length" "Petal.Width"  "Species"     
\end{verbatim}

Pour les attributs les plus courants de \textbf{R}, il faut noter qu'il
existe le plus souvent des fonctions spécifiques, comme
\texttt{class()}, \texttt{names()} ou \texttt{row.names()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "data.frame"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Sepal.Length" "Sepal.Width"  "Petal.Length" "Petal.Width"  "Species"     
\end{verbatim}

La fonction \texttt{attr()}, associée à l'opérateur d'assignation
(\texttt{\textless{}-}) permet également de définir ses propres
attributs.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attr}\NormalTok{(iris, }\StringTok{"perso"}\NormalTok{) }\OtherTok{\textless{}{-}} \StringTok{"Des notes personnelles"}
\FunctionTok{attributes}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
$names
[1] "Sepal.Length" "Sepal.Width"  "Petal.Length" "Petal.Width"  "Species"     

$class
[1] "data.frame"

$row.names
  [1]   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18
 [19]  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36
 [37]  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52  53  54
 [55]  55  56  57  58  59  60  61  62  63  64  65  66  67  68  69  70  71  72
 [73]  73  74  75  76  77  78  79  80  81  82  83  84  85  86  87  88  89  90
 [91]  91  92  93  94  95  96  97  98  99 100 101 102 103 104 105 106 107 108
[109] 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126
[127] 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144
[145] 145 146 147 148 149 150

$perso
[1] "Des notes personnelles"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attr}\NormalTok{(iris, }\StringTok{"perso"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Des notes personnelles"
\end{verbatim}

\part{\textbf{Manipulation de données}}

\hypertarget{sec-pipe}{%
\chapter{Le pipe}\label{sec-pipe}}

Il est fréquent d'enchainer des opérations en appelant successivement
des fonctions sur le résultat de l'appel précédent.

Prenons un exemple. Supposons que nous ayons un vecteur numérique
\texttt{v} dont nous voulons calculer la moyenne puis l'afficher via un
message dans la console. Pour un meilleur rendu, nous allons arrondir la
moyenne à une décimale, mettre en forme le résultat à la française,
c'est-à-dire avec la virgule comme séparateur des décimales, créer une
phrase avec le résultat, puis l'afficher dans la console. Voici le code
correspondant, étape par étape.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{1.2}\NormalTok{, }\FloatTok{8.7}\NormalTok{, }\FloatTok{5.6}\NormalTok{, }\FloatTok{11.4}\NormalTok{)}
\NormalTok{m }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(v)}
\NormalTok{r }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(m, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)}
\NormalTok{f }\OtherTok{\textless{}{-}} \FunctionTok{format}\NormalTok{(r, }\AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"La moyenne est de "}\NormalTok{, f, }\StringTok{"."}\NormalTok{)}
\FunctionTok{message}\NormalTok{(p)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
La moyenne est de 6,7.
\end{verbatim}

Cette écriture, n'est pas vraiment optimale, car cela entraine la
création d'un grand nombre de variables intermédiaires totalement
inutiles. Nous pourrions dès lors imbriquer les différentes fonctions
les unes dans les autres~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{message}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"La moyenne est de "}\NormalTok{, }\FunctionTok{format}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(v),        }\AttributeTok{digits =} \DecValTok{1}\NormalTok{), }\AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{), }\StringTok{"."}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
La moyenne est de 6,7.
\end{verbatim}

Nous obtenons bien le même résultat, mais la lecture de cette ligne de
code est assez difficile et il n'est pas aisé de bien identifier à
quelle fonction est rattaché chaque argument.

Une amélioration possible serait d'effectuer des retours à la ligne avec
une indentation adéquate pour rendre cela plus lisible.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{message}\NormalTok{(}
  \FunctionTok{paste0}\NormalTok{(}
    \StringTok{"La moyenne est de "}\NormalTok{, }
    \FunctionTok{format}\NormalTok{(}
      \FunctionTok{round}\NormalTok{(}
        \FunctionTok{mean}\NormalTok{(v), }
        \AttributeTok{digits =} \DecValTok{1}\NormalTok{), }
      \AttributeTok{decimal.mark =} \StringTok{","}
\NormalTok{    ),}
    \StringTok{"."}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
La moyenne est de 6,7.
\end{verbatim}

C'est déjà mieux, mais toujours pas optimal.

\hypertarget{le-pipe-natif-de-r}{%
\section{\texorpdfstring{Le pipe natif de R~:
\texttt{\textbar{}\textgreater{}}}{Le pipe natif de R~: \textbar\textgreater{}}}\label{le-pipe-natif-de-r}}

Depuis la version 4.1, \textbf{R} a introduit ce que l'on nomme un
\emph{pipe} (tuyau en anglais), un nouvel opérateur noté
\texttt{\textbar{}\textgreater{}}.

Le principe de cet opérateur est de passer l'élément situé à sa gauche
comme premier argument de la fonction située à sa droite. Ainsi,
l'écriture \texttt{x\ \textbar{}\textgreater{}\ f()} est équivalente à
\texttt{f(x)} et l'écriture \texttt{x\ \textbar{}\textgreater{}\ f(y)} à
\texttt{f(x,\ y)}.

Parfois, on souhaite passer l'objet \textbf{x} à un autre endroit de la
fonction \texttt{f()} que le premier argument. Depuis la version 4.2,
\textbf{R} a introduit l'opérateur \texttt{\_},que l'on nomme un
\emph{placeholder}, pour indiquer où passer l'objet de gauche. Ainsi,
\texttt{x\ \textbar{}\textgreater{}\ f(y,\ a\ =\ \_)} devient équivalent
à \texttt{f(y,\ a\ =\ x)}. \textbf{ATTENTION~:} le \emph{placeholder}
doit impérativement être transmis à un argument nommé~!

Tout cela semble encore un peu abstrait~? Reprenons notre exemple
précédent et réécrivons le code avec le \emph{pipe}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mean}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{round}\NormalTok{(}\AttributeTok{digits =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{format}\NormalTok{(}\AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{paste0}\NormalTok{(}\StringTok{"La moyenne est de "}\NormalTok{, }\AttributeTok{m =}\NormalTok{ \_, }\StringTok{"."}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{message}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
La moyenne est de 6,7.
\end{verbatim}

Le code n'est-il pas plus lisible~?

Pour visualiser chaque étape du code, vous pouvez consulter le diaporama
suivant~:
\url{https://larmarange.github.io/guide-R/manipulation/ressources/flipbook-pipe.html}

\hypertarget{le-pipe-du-tidyverse}{%
\section{\texorpdfstring{Le pipe du tidyverse~:
\texttt{\%\textgreater{}\%}}{Le pipe du tidyverse~: \%\textgreater\%}}\label{le-pipe-du-tidyverse}}

Ce n'est qu'à partir de la version 4.1 sortie en 2021 que \textbf{R} a
proposé de manière native un \emph{pipe}, en l'occurence l'opérateur
\texttt{\textbar{}\textgreater{}}.

En cela, \textbf{R} s'est notamment inspiré d'un opérateur similaire
introduit dès 2014 dans le \emph{tidyverse}. Le pipe du \emph{tidyverse}
fonctionne de manière similaire. Il est implémenté dans le package
\texttt{\{magrittr\}} qui doit donc être chargé en mémoire. Le
\emph{pipe} est également disponible lorsque l'on effecture
\texttt{library(tidyverse)}.

Cet opérateur s'écrit \texttt{\%\textgreater{}\%} et il dispose lui
aussi d'un \emph{placeholder} qui est le \texttt{.}. La syntaxe du
\emph{placeholder} est un peu plus souple puisqu'il peut être passé à
tout type d'argument, y compris un argument sans nom. Si l'on reprend
notre exemple précédent.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magrittr)}
\NormalTok{v }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mean}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{round}\NormalTok{(}\AttributeTok{digits =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{format}\NormalTok{(}\AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{paste0}\NormalTok{(}\StringTok{"La moyenne est de "}\NormalTok{, ., }\StringTok{"."}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{message}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
La moyenne est de 6,7.
\end{verbatim}

\hypertarget{vaut-il-mieux-utiliser-ou}{%
\section{\texorpdfstring{Vaut-il mieux utiliser
\texttt{\textbar{}\textgreater{}} ou
\texttt{\%\textgreater{}\%}~?}{Vaut-il mieux utiliser \textbar\textgreater{} ou \%\textgreater\%~?}}\label{vaut-il-mieux-utiliser-ou}}

\includegraphics{manipulation/ressources/native_pipe_vs_magrittr.jpg}

Bonne question. Si vous utilisez une version récente de \textbf{R} (≥
4.2), il est préférable d'avoir recours au \emph{pipe} natif de
\textbf{R} dans la mesure où il est
\href{https://michaelbarrowman.co.uk/post/the-new-base-pipe/}{plus
efficient en termes de temps de calcul} car il fait partie intégrante du
langage. Dans ce guide, nous privilégeons d'ailleurs l'utilisation de
\texttt{\textbar{}\textgreater{}}.

Si votre code nécessite de fonctionner avec différentes versions de
\textbf{R}, par exemple dans le cadre d'un package, il est alors
préférable, pour le moment, d'utiliser celui fourni par
\texttt{\{magrittr\}} (\texttt{\%\textgreater{}\%}).

\hypertarget{sec-pluck-chuck}{%
\section{\texorpdfstring{Accéder à un élément avec
\texttt{purrr::pluck()} et
\texttt{purrr::chuck()}}{Accéder à un élément avec purrr::pluck() et purrr::chuck()}}\label{sec-pluck-chuck}}

Il est fréquent d'avoir besoin d'accéder à un élément précis d'une
liste, d'un tableau ou d'un vecteur, ce que l'on fait d'ordinaire avec
la syntaxe \texttt{{[}{[}{]}{]}} ou \texttt{\$} pour les listes ou
\texttt{{[}{]}} pour les vecteurs. Cependant, cette syntaxe se combine
souvent mal avec un enchaînement d'opérations utilisant le \emph{pipe}.

Le package \texttt{\{purrr\}}, chargé par défaut avec
\texttt{library(tidyverse)}, fournit une fonction
\texttt{purrr::pluck()} qui, est l'équivalent de \texttt{{[}{[}{]}{]}},
et qui permet de récupérer un élément par son nom ou sa position. Ainsi,
si l'on considère le tableau de données \texttt{iris},
\texttt{pluck(iris,\ "Petal.Witdh")} est équivalent à
\texttt{iris\$Petal.Width}. Voyons un example d'utilisation dans le
cadre d'un enchaînement d'opérations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  purrr}\SpecialCharTok{::}\FunctionTok{pluck}\NormalTok{(}\StringTok{"Petal.Width"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mean}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.199333
\end{verbatim}

Cette écriture est équivalente à~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mean}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Petal.Width)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.199333
\end{verbatim}

\texttt{purrr::pluck()} fonctionne également sur des vecteurs (et dans
ce cas opère comme \texttt{{[}{]}}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"c"}\NormalTok{, }\StringTok{"d"}\NormalTok{)}
\NormalTok{v }\SpecialCharTok{|\textgreater{}}\NormalTok{ purrr}\SpecialCharTok{::}\FunctionTok{pluck}\NormalTok{(}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "b"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v[}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "b"
\end{verbatim}

On peut également, dans un même appel à \texttt{purrr::pluck()},
enchaîner plusieurs niveaux. Les trois syntaxes ci-après sont ainsi
équivalents~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  purrr}\SpecialCharTok{::}\FunctionTok{pluck}\NormalTok{(}\StringTok{"Sepal.Width"}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 3.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  purrr}\SpecialCharTok{::}\FunctionTok{pluck}\NormalTok{(}\StringTok{"Sepal.Width"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  purrr}\SpecialCharTok{::}\FunctionTok{pluck}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 3.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris[[}\StringTok{"Sepal.Width"}\NormalTok{]][}\DecValTok{3}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 3.2
\end{verbatim}

Si l'on demande un élément qui n'existe pas, \texttt{purrr:pluck()}
renverra l'élement vide (\texttt{NULL}). Si l'on souhaite plutôt que
cela génère une erreur, on aura alors recours à \texttt{purrr::chuck()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\SpecialCharTok{|\textgreater{}}\NormalTok{ purrr}\SpecialCharTok{::}\FunctionTok{pluck}\NormalTok{(}\StringTok{"inconnu"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\SpecialCharTok{|\textgreater{}}\NormalTok{ purrr}\SpecialCharTok{::}\FunctionTok{chuck}\NormalTok{(}\StringTok{"inconnu"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Error in `purrr::chuck()`:
! Can't find name `inconnu` in vector.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\SpecialCharTok{|\textgreater{}}\NormalTok{ purrr}\SpecialCharTok{::}\FunctionTok{pluck}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\SpecialCharTok{|\textgreater{}}\NormalTok{ purrr}\SpecialCharTok{::}\FunctionTok{chuck}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Error in `purrr::chuck()`:
! Index 1 exceeds the length of plucked object (10 > 4).
\end{verbatim}

\hypertarget{sec-dplyr}{%
\chapter{\texorpdfstring{\texttt{dplyr}}{dplyr}}\label{sec-dplyr}}

\texttt{\{dplyr\}} est l'un des packages les plus connus du
\emph{tidyverse}. Il facilite le traitement et la manipulation des
tableaux de données (qu'il s'agisse de \emph{data frame} ou de
\emph{tibble}). Il propose une syntaxe claire et cohérente, sous formes
de verbes correspondant à des fonctions.

\texttt{\{dplyr\}} part du principe que les données sont \emph{tidy}
(chaque variable est une colonne, chaque observation est une ligne, voir
Chapitre~\ref{sec-tibbles}). Les verbes de \texttt{\{dplyr\}} prennent
en entrée un tableau de données\sidenote{\footnotesize Le package \texttt{\{dbplyr\}}
  permets d'étendre les verbes de \texttt{\{dplyr\}} à des tables de
  bases de données \textbf{SQL,} \texttt{\{dtplyr\}} à des tableaux de
  données du type \texttt{\{data.table\}} et \texttt{\{srvyr\}} à des
  données pondérées du type \texttt{\{survey\}}.} (\emph{data frame} ou
\emph{tibble}) et renvoient systématiquement un \emph{tibble}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(dplyr)}
\end{Highlighting}
\end{Shaded}

Dans ce qui suit on va utiliser le jeu de données
\texttt{\{nycflights13\}}, contenu dans l'extension du même nom (qu'il
faut donc avoir installée). Celui-ci correspond aux données de tous les
vols au départ d'un des trois aéroports de New-York en 2013. Il a la
particularité d'être réparti en trois tables~:

\begin{itemize}
\tightlist
\item
  \texttt{nycflights13::flights} contient des informations sur les
  vols~: date, départ, destination, horaires, retard\ldots{}
\item
  \texttt{nycflights13::airports} contient des informations sur les
  aéroports
\item
  \texttt{nycflights13::airlines} contient des données sur les
  compagnies aériennes
\end{itemize}

On va charger les trois tables du jeu de données~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(nycflights13)}
\DocumentationTok{\#\# Chargement des trois tables du jeu de données}
\FunctionTok{data}\NormalTok{(flights)}
\FunctionTok{data}\NormalTok{(airports)}
\FunctionTok{data}\NormalTok{(airlines)}
\end{Highlighting}
\end{Shaded}

Normalement trois objets correspondant aux trois tables ont dû
apparaître dans votre environnement.

\hypertarget{opuxe9rations-sur-les-lignes}{%
\section{Opérations sur les lignes}\label{opuxe9rations-sur-les-lignes}}

\hypertarget{filter}{%
\subsection{filter()}\label{filter}}

\texttt{dplyr::filter()} sélectionne des lignes d'un tableau de données
selon une condition. On lui passe en paramètre un test, et seules les
lignes pour lesquelles ce test renvoit \texttt{TRUE} (vrai) sont
conservées\sidenote{\footnotesize Si le test renvoie faux (\texttt{FALSE}) ou une
  valeur manquante (\texttt{NA}), les lignes correspondantes ne seront
  donc pas sélectionnées.}.

Par exemple, si on veut sélectionner les vols du mois de janvier, on
peut filtrer sur la variable \emph{month} de la manière suivante~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{filter}\NormalTok{(flights, month }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 27,004 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# i 26,994 more rows
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

Cela peut s'écrire plus simplement avec un pipe~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} \FunctionTok{filter}\NormalTok{(month }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 27,004 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# i 26,994 more rows
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

Si l'on veut uniquement les vols avec un retard au départ (variable
\emph{dep\_delay}) compris entre 10 et 15 minutes~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(dep\_delay }\SpecialCharTok{\textgreater{}=} \DecValTok{10} \SpecialCharTok{\&}\NormalTok{ dep\_delay }\SpecialCharTok{\textless{}=} \DecValTok{15}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 14,919 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     1      611            600        11      945            931
 2  2013     1     1      623            610        13      920            915
 3  2013     1     1      743            730        13     1107           1100
 4  2013     1     1      743            730        13     1059           1056
 5  2013     1     1      851            840        11     1215           1206
 6  2013     1     1      912            900        12     1241           1220
 7  2013     1     1      914            900        14     1058           1043
 8  2013     1     1      920            905        15     1039           1025
 9  2013     1     1     1011           1001        10     1133           1128
10  2013     1     1     1112           1100        12     1440           1438
# i 14,909 more rows
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

Si l'on passe plusieurs arguments à \texttt{dplyr::filter()}, celui-ci
rajoute automatiquement une condition \textbf{ET}. La ligne ci-dessus
peut donc également être écrite de la manière suivante, avec le même
résultat~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(dep\_delay }\SpecialCharTok{\textgreater{}=} \DecValTok{10}\NormalTok{, dep\_delay }\SpecialCharTok{\textless{}=} \DecValTok{15}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Enfin, on peut également placer des fonctions dans les tests, qui nous
permettent par exemple de sélectionner les vols avec la plus grande
distance~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(distance }\SpecialCharTok{==} \FunctionTok{max}\NormalTok{(distance))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 342 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     1      857            900        -3     1516           1530
 2  2013     1     2      909            900         9     1525           1530
 3  2013     1     3      914            900        14     1504           1530
 4  2013     1     4      900            900         0     1516           1530
 5  2013     1     5      858            900        -2     1519           1530
 6  2013     1     6     1019            900        79     1558           1530
 7  2013     1     7     1042            900       102     1620           1530
 8  2013     1     8      901            900         1     1504           1530
 9  2013     1     9      641            900      1301     1242           1530
10  2013     1    10      859            900        -1     1449           1530
# i 332 more rows
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Évaluation contextuelle}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Il est important de noter que \texttt{\{dplyr\}} procède à une
évaluation contextuelle des expressions qui lui sont passées. Ainsi, on
peut indiquer directement le nom d'une variable et \texttt{\{dplyr\}}
l'interprétera dans le contexte du tableau de données, c'est-à-dire
regardera s'il existe une colonne portant ce nom dans le tableau.

Dans l'expression
\texttt{flights\ \textbar{}\textgreater{}\ filter(month\ ==\ 1)},
\texttt{month} est interprété comme la colonne \emph{month} du tableau
\texttt{flights}, à savoir \texttt{flights\$month}.

Il est également possible d'indiquer des objets extérieurs au tableau~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m }\OtherTok{\textless{}{-}} \DecValTok{2}
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(month }\SpecialCharTok{==}\NormalTok{ m)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 24,951 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     2     1      456            500        -4      652            648
 2  2013     2     1      520            525        -5      816            820
 3  2013     2     1      527            530        -3      837            829
 4  2013     2     1      532            540        -8     1007           1017
 5  2013     2     1      540            540         0      859            850
 6  2013     2     1      552            600        -8      714            715
 7  2013     2     1      552            600        -8      919            910
 8  2013     2     1      552            600        -8      655            709
 9  2013     2     1      553            600        -7      833            815
10  2013     2     1      553            600        -7      821            825
# i 24,941 more rows
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

Cela fonctionne car il n'y a pas de colonne \emph{m} dans
\texttt{flights}. Dès lors, \texttt{\{dplyr\}} regarde s'il existe un
objet \texttt{m} dans l'environnement de travail.

Par contre, si une colonne existe dans le tableau, elle aura priorité
sur les objets du même nom dans l'environnement. Dans l'exemple
ci-dessous, le résultat obtenu n'est pas celui voulu. Il est interprété
comme sélectionner toutes les lignes où la colonne \emph{mois} est égale
à elle-même et donc cela sélectionne toutes les lignes du tableau.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{month }\OtherTok{\textless{}{-}} \DecValTok{3}
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(month }\SpecialCharTok{==}\NormalTok{ month)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# i 336,766 more rows
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

Afin de distinguer ce qui correspond à une colonne du tableau et à un
objet de l'environnement, on pourra avoir recours à \texttt{.data} et
\texttt{.env} (voir \texttt{help(".env",\ package\ =\ "rlang")}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{month }\OtherTok{\textless{}{-}} \DecValTok{3}
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(.data}\SpecialCharTok{$}\NormalTok{month }\SpecialCharTok{==}\NormalTok{ .env}\SpecialCharTok{$}\NormalTok{month)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 28,834 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     3     1        4           2159       125      318             56
 2  2013     3     1       50           2358        52      526            438
 3  2013     3     1      117           2245       152      223           2354
 4  2013     3     1      454            500        -6      633            648
 5  2013     3     1      505            515       -10      746            810
 6  2013     3     1      521            530        -9      813            827
 7  2013     3     1      537            540        -3      856            850
 8  2013     3     1      541            545        -4     1014           1023
 9  2013     3     1      549            600       -11      639            703
10  2013     3     1      550            600       -10      747            801
# i 28,824 more rows
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

\end{tcolorbox}

\hypertarget{slice}{%
\subsection{slice()}\label{slice}}

Le verbe \texttt{dplyr::slice()} sélectionne des lignes du tableau selon
leur position. On lui passe un chiffre ou un vecteur de chiffres.

Si l'on souhaite sélectionner la 345\textsuperscript{e} ligne du tableau
\texttt{airports}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{slice}\NormalTok{(}\DecValTok{345}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1 x 8
  faa   name                lat   lon   alt    tz dst   tzone            
  <chr> <chr>             <dbl> <dbl> <dbl> <dbl> <chr> <chr>            
1 CYF   Chefornak Airport  60.1 -164.    40    -9 A     America/Anchorage
\end{verbatim}

Si l'on veut sélectionner les 5 premières lignes~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{slice}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 8
  faa   name                            lat   lon   alt    tz dst   tzone       
  <chr> <chr>                         <dbl> <dbl> <dbl> <dbl> <chr> <chr>       
1 04G   Lansdowne Airport              41.1 -80.6  1044    -5 A     America/New~
2 06A   Moton Field Municipal Airport  32.5 -85.7   264    -6 A     America/Chi~
3 06C   Schaumburg Regional            42.0 -88.1   801    -6 A     America/Chi~
4 06N   Randall Airport                41.4 -74.4   523    -5 A     America/New~
5 09J   Jekyll Island Airport          31.1 -81.4    11    -5 A     America/New~
\end{verbatim}

\hypertarget{arrange}{%
\subsection{arrange()}\label{arrange}}

\texttt{dplyr::arrange()} réordonne les lignes d'un tableau selon une ou
plusieurs colonnes.

Ainsi, si l'on veut trier le tableau \texttt{flights} selon le retard au
départ, dans l'ordre croissant~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{arrange}\NormalTok{(dep\_delay)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013    12     7     2040           2123       -43       40           2352
 2  2013     2     3     2022           2055       -33     2240           2338
 3  2013    11    10     1408           1440       -32     1549           1559
 4  2013     1    11     1900           1930       -30     2233           2243
 5  2013     1    29     1703           1730       -27     1947           1957
 6  2013     8     9      729            755       -26     1002            955
 7  2013    10    23     1907           1932       -25     2143           2143
 8  2013     3    30     2030           2055       -25     2213           2250
 9  2013     3     2     1431           1455       -24     1601           1631
10  2013     5     5      934            958       -24     1225           1309
# i 336,766 more rows
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

On peut trier selon plusieurs colonnes. Par exemple selon le mois, puis
selon le retard au départ~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{arrange}\NormalTok{(month, dep\_delay)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1    11     1900           1930       -30     2233           2243
 2  2013     1    29     1703           1730       -27     1947           1957
 3  2013     1    12     1354           1416       -22     1606           1650
 4  2013     1    21     2137           2159       -22     2232           2316
 5  2013     1    20      704            725       -21     1025           1035
 6  2013     1    12     2050           2110       -20     2310           2355
 7  2013     1    12     2134           2154       -20        4             50
 8  2013     1    14     2050           2110       -20     2329           2355
 9  2013     1     4     2140           2159       -19     2241           2316
10  2013     1    11     1947           2005       -18     2209           2230
# i 336,766 more rows
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

Si l'on veut trier selon une colonne par ordre décroissant, on lui
applique la fonction \texttt{dplyr::desc()}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(dep\_delay))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     9      641            900      1301     1242           1530
 2  2013     6    15     1432           1935      1137     1607           2120
 3  2013     1    10     1121           1635      1126     1239           1810
 4  2013     9    20     1139           1845      1014     1457           2210
 5  2013     7    22      845           1600      1005     1044           1815
 6  2013     4    10     1100           1900       960     1342           2211
 7  2013     3    17     2321            810       911      135           1020
 8  2013     6    27      959           1900       899     1236           2226
 9  2013     7    22     2257            759       898      121           1026
10  2013    12     5      756           1700       896     1058           2020
# i 336,766 more rows
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

Combiné avec \texttt{dplyr::slice()}, \texttt{dplyr::arrange()} permet
par exemple de sélectionner les trois vols ayant eu le plus de retard~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(dep\_delay)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{slice}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 3 x 19
   year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
  <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
1  2013     1     9      641            900      1301     1242           1530
2  2013     6    15     1432           1935      1137     1607           2120
3  2013     1    10     1121           1635      1126     1239           1810
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

\hypertarget{slice_sample}{%
\subsection{slice\_sample()}\label{slice_sample}}

\texttt{dplyr::slice\_sample()} permet de sélectionner aléatoirement un
nombre de lignes ou une fraction des lignes d'un tableau. Ainsi si l'on
veut choisir 5 lignes au hasard dans le tableau \texttt{airports}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{slice\_sample}\NormalTok{(}\AttributeTok{n =} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 8
  faa   name                           lat    lon   alt    tz dst   tzone       
  <chr> <chr>                        <dbl>  <dbl> <dbl> <dbl> <chr> <chr>       
1 LSE   La Crosse Municipal           43.9  -91.3   654    -6 A     America/Chi~
2 UES   Waukesha County Airport       43.0  -88.2   911    -6 A     America/Chi~
3 SPW   Spencer Muni                  43.2  -95.2  1339    -6 A     America/Chi~
4 FAR   Hector International Airport  46.9  -96.8   902    -6 A     America/Chi~
5 KPR   Port Williams Seaplane Base   58.5 -153.      0    -9 A     America/Anc~
\end{verbatim}

Si l'on veut tirer au hasard 10\% des lignes de \texttt{flights}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{slice\_sample}\NormalTok{(}\AttributeTok{prop =}\NormalTok{ .}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 33,677 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     8     8     1748           1713        35     2013           1919
 2  2013    10     8     1040           1046        -6     1335           1330
 3  2013     3    14      624            630        -6      754            811
 4  2013     8    10     2153           2130        23       34           2359
 5  2013    10    23     2235           2245       -10     2335           2356
 6  2013     1    17     1230           1235        -5     1530           1606
 7  2013     6     6     1000            955         5     1124           1110
 8  2013     5    26      704            705        -1      938            956
 9  2013    10     1      712            720        -8      934           1000
10  2013     3     1     1816           1820        -4     2000           2031
# i 33,667 more rows
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

Ces fonctions sont utiles notamment pour faire de l'``échantillonnage''
en tirant au hasard un certain nombre d'observations du tableau.

\hypertarget{distinct}{%
\subsection{distinct()}\label{distinct}}

\texttt{dplyr::distinct()} filtre les lignes du tableau pour ne
conserver que les lignes distinctes, en supprimant toutes les lignes en
double.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{select}\NormalTok{(day, month) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{distinct}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 365 x 2
     day month
   <int> <int>
 1     1     1
 2     2     1
 3     3     1
 4     4     1
 5     5     1
 6     6     1
 7     7     1
 8     8     1
 9     9     1
10    10     1
# i 355 more rows
\end{verbatim}

On peut lui spécifier une liste de variables~: dans ce cas, pour toutes
les observations ayant des valeurs identiques pour les variables en
question, \texttt{dplyr::distinct()} ne conservera que la première
d'entre elles.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{distinct}\NormalTok{(month, day)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 365 x 2
   month   day
   <int> <int>
 1     1     1
 2     1     2
 3     1     3
 4     1     4
 5     1     5
 6     1     6
 7     1     7
 8     1     8
 9     1     9
10     1    10
# i 355 more rows
\end{verbatim}

L'option \texttt{.keep\_all} permet, dans l'opération précédente, de
conserver l'ensemble des colonnes du tableau~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{distinct}\NormalTok{(month, day, }\AttributeTok{.keep\_all =} \ConstantTok{TRUE}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 365 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     1      517            515         2      830            819
 2  2013     1     2       42           2359        43      518            442
 3  2013     1     3       32           2359        33      504            442
 4  2013     1     4       25           2359        26      505            442
 5  2013     1     5       14           2359        15      503            445
 6  2013     1     6       16           2359        17      451            442
 7  2013     1     7       49           2359        50      531            444
 8  2013     1     8      454            500        -6      625            648
 9  2013     1     9        2           2359         3      432            444
10  2013     1    10        3           2359         4      426            437
# i 355 more rows
# i 11 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>
\end{verbatim}

\hypertarget{opuxe9rations-sur-les-colonnes}{%
\section{Opérations sur les
colonnes}\label{opuxe9rations-sur-les-colonnes}}

\hypertarget{sec-dplyr-select}{%
\subsection{select()}\label{sec-dplyr-select}}

\texttt{dplyr::select()} permet de sélectionner des colonnes d'un
tableau de données. Ainsi, si l'on veut extraire les colonnes
\texttt{lat} et \texttt{lon} du tableau \texttt{airports}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(lat, lon)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1,458 x 2
     lat    lon
   <dbl>  <dbl>
 1  41.1  -80.6
 2  32.5  -85.7
 3  42.0  -88.1
 4  41.4  -74.4
 5  31.1  -81.4
 6  36.4  -82.2
 7  41.5  -84.5
 8  42.9  -76.8
 9  39.8  -76.6
10  48.1 -123. 
# i 1,448 more rows
\end{verbatim}

Si on fait précéder le nom d'un \texttt{-}, la colonne est éliminée
plutôt que sélectionnée~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{lat, }\SpecialCharTok{{-}}\NormalTok{lon)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1,458 x 6
   faa   name                             alt    tz dst   tzone              
   <chr> <chr>                          <dbl> <dbl> <chr> <chr>              
 1 04G   Lansdowne Airport               1044    -5 A     America/New_York   
 2 06A   Moton Field Municipal Airport    264    -6 A     America/Chicago    
 3 06C   Schaumburg Regional              801    -6 A     America/Chicago    
 4 06N   Randall Airport                  523    -5 A     America/New_York   
 5 09J   Jekyll Island Airport             11    -5 A     America/New_York   
 6 0A9   Elizabethton Municipal Airport  1593    -5 A     America/New_York   
 7 0G6   Williams County Airport          730    -5 A     America/New_York   
 8 0G7   Finger Lakes Regional Airport    492    -5 A     America/New_York   
 9 0P2   Shoestring Aviation Airfield    1000    -5 U     America/New_York   
10 0S9   Jefferson County Intl            108    -8 A     America/Los_Angeles
# i 1,448 more rows
\end{verbatim}

\texttt{dplyr::select()} comprend toute une série de fonctions
facilitant la sélection de multiples colonnes. Par exemple,
\texttt{dplyr::starts\_with()}, \texttt{dplyr::ends\_width()},
\texttt{dplyr::contains()} ou \texttt{dplyr::matches()} permettent
d'exprimer des conditions sur les noms de variables~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(}\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"dep\_"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 2
   dep_time dep_delay
      <int>     <dbl>
 1      517         2
 2      533         4
 3      542         2
 4      544        -1
 5      554        -6
 6      554        -4
 7      555        -5
 8      557        -3
 9      557        -3
10      558        -2
# i 336,766 more rows
\end{verbatim}

La syntaxe \texttt{colonne1:colonne2} permet de sélectionner toutes les
colonnes situées entre \emph{colonne1} et \emph{colonne2}
incluses\sidenote{\footnotesize À noter que cette opération est un peu plus
  ``fragile'' que les autres, car si l'ordre des colonnes change elle
  peut renvoyer un résultat différent.}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(year}\SpecialCharTok{:}\NormalTok{day)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 3
    year month   day
   <int> <int> <int>
 1  2013     1     1
 2  2013     1     1
 3  2013     1     1
 4  2013     1     1
 5  2013     1     1
 6  2013     1     1
 7  2013     1     1
 8  2013     1     1
 9  2013     1     1
10  2013     1     1
# i 336,766 more rows
\end{verbatim}

\texttt{dplyr::all\_of()} et \texttt{dplyr::any\_of()} permettent de
fournir une liste de variables à extraire sous forme de vecteur textuel.
Alors que \texttt{dplyr::all\_of()} renverra une erreur si une variable
n'est pas trouvée dans le tableau de départ, \texttt{dplyr::any\_of()}
sera moins stricte.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(}\FunctionTok{all\_of}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"year"}\NormalTok{, }\StringTok{"month"}\NormalTok{, }\StringTok{"day"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 3
    year month   day
   <int> <int> <int>
 1  2013     1     1
 2  2013     1     1
 3  2013     1     1
 4  2013     1     1
 5  2013     1     1
 6  2013     1     1
 7  2013     1     1
 8  2013     1     1
 9  2013     1     1
10  2013     1     1
# i 336,766 more rows
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(}\FunctionTok{all\_of}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"century"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"month"}\NormalTok{, }\StringTok{"day"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Error in `all_of()`:
! Can't subset columns that don't exist.
x Column `century` doesn't exist.
\end{verbatim}

\begin{verbatim}
Erreur : Can't subset columns that don't exist. 
x Column `century` doesn't exist.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(}\FunctionTok{any\_of}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"century"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"month"}\NormalTok{, }\StringTok{"day"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 3
    year month   day
   <int> <int> <int>
 1  2013     1     1
 2  2013     1     1
 3  2013     1     1
 4  2013     1     1
 5  2013     1     1
 6  2013     1     1
 7  2013     1     1
 8  2013     1     1
 9  2013     1     1
10  2013     1     1
# i 336,766 more rows
\end{verbatim}

\texttt{dplyr::where()} permets de sélectionner des variables à partir
d'une fonction qui renvoie une valeur logique. Par exemple, pour
sélectionner seulement les variables textuelles~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(}\FunctionTok{where}\NormalTok{(is.character))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 4
   carrier tailnum origin dest 
   <chr>   <chr>   <chr>  <chr>
 1 UA      N14228  EWR    IAH  
 2 UA      N24211  LGA    IAH  
 3 AA      N619AA  JFK    MIA  
 4 B6      N804JB  JFK    BQN  
 5 DL      N668DN  LGA    ATL  
 6 UA      N39463  EWR    ORD  
 7 B6      N516JB  EWR    FLL  
 8 EV      N829AS  LGA    IAD  
 9 B6      N593JB  JFK    MCO  
10 AA      N3ALAA  LGA    ORD  
# i 336,766 more rows
\end{verbatim}

\texttt{dplyr::select()} peut être utilisée pour réordonner les colonnes
d'une table en utilisant la fonction \texttt{dplyr::everything()}, qui
sélectionne l'ensemble des colonnes non encore sélectionnées. Ainsi, si
l'on souhaite faire passer la colonne \emph{name} en première position
de la table \texttt{airports}, on peut faire~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(name, }\FunctionTok{everything}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1,458 x 8
   name                           faa     lat    lon   alt    tz dst   tzone    
   <chr>                          <chr> <dbl>  <dbl> <dbl> <dbl> <chr> <chr>    
 1 Lansdowne Airport              04G    41.1  -80.6  1044    -5 A     America/~
 2 Moton Field Municipal Airport  06A    32.5  -85.7   264    -6 A     America/~
 3 Schaumburg Regional            06C    42.0  -88.1   801    -6 A     America/~
 4 Randall Airport                06N    41.4  -74.4   523    -5 A     America/~
 5 Jekyll Island Airport          09J    31.1  -81.4    11    -5 A     America/~
 6 Elizabethton Municipal Airport 0A9    36.4  -82.2  1593    -5 A     America/~
 7 Williams County Airport        0G6    41.5  -84.5   730    -5 A     America/~
 8 Finger Lakes Regional Airport  0G7    42.9  -76.8   492    -5 A     America/~
 9 Shoestring Aviation Airfield   0P2    39.8  -76.6  1000    -5 U     America/~
10 Jefferson County Intl          0S9    48.1 -123.    108    -8 A     America/~
# i 1,448 more rows
\end{verbatim}

\hypertarget{relocate}{%
\subsection{relocate()}\label{relocate}}

Pour réordonner des colonnes, on pourra aussi avoir recours à
\texttt{dplyr::relocate()} en indiquant les premières variables. Il
n'est pas nécessaire d'ajouter \texttt{everything()} car avec
\texttt{dplyr::relocate()} toutes les variables sont conservées.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{relocate}\NormalTok{(lon, lat, name)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1,458 x 8
      lon   lat name                           faa     alt    tz dst   tzone    
    <dbl> <dbl> <chr>                          <chr> <dbl> <dbl> <chr> <chr>    
 1  -80.6  41.1 Lansdowne Airport              04G    1044    -5 A     America/~
 2  -85.7  32.5 Moton Field Municipal Airport  06A     264    -6 A     America/~
 3  -88.1  42.0 Schaumburg Regional            06C     801    -6 A     America/~
 4  -74.4  41.4 Randall Airport                06N     523    -5 A     America/~
 5  -81.4  31.1 Jekyll Island Airport          09J      11    -5 A     America/~
 6  -82.2  36.4 Elizabethton Municipal Airport 0A9    1593    -5 A     America/~
 7  -84.5  41.5 Williams County Airport        0G6     730    -5 A     America/~
 8  -76.8  42.9 Finger Lakes Regional Airport  0G7     492    -5 A     America/~
 9  -76.6  39.8 Shoestring Aviation Airfield   0P2    1000    -5 U     America/~
10 -123.   48.1 Jefferson County Intl          0S9     108    -8 A     America/~
# i 1,448 more rows
\end{verbatim}

\hypertarget{rename}{%
\subsection{rename()}\label{rename}}

Une variante de \texttt{dplyr::select()} est
\texttt{dplyr::rename()}\sidenote{\footnotesize Il est également possible de renommer
  des colonnes directement avec \texttt{select()}, avec la même syntaxe
  que pour \texttt{rename()}.}, qui permet de renommer facilement des
colonnes. On l'utilise en lui passant des paramètres de la forme
\texttt{nouveau\_nom\ =\ ancien\_nom}. Ainsi, si on veut renommer les
colonnes \emph{lon} et \emph{lat} de \texttt{airports} en
\emph{longitude} et \emph{latitude}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{rename}\NormalTok{(}\AttributeTok{longitude =}\NormalTok{ lon, }\AttributeTok{latitude =}\NormalTok{ lat)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1,458 x 8
   faa   name                         latitude longitude   alt    tz dst   tzone
   <chr> <chr>                           <dbl>     <dbl> <dbl> <dbl> <chr> <chr>
 1 04G   Lansdowne Airport                41.1     -80.6  1044    -5 A     Amer~
 2 06A   Moton Field Municipal Airpo~     32.5     -85.7   264    -6 A     Amer~
 3 06C   Schaumburg Regional              42.0     -88.1   801    -6 A     Amer~
 4 06N   Randall Airport                  41.4     -74.4   523    -5 A     Amer~
 5 09J   Jekyll Island Airport            31.1     -81.4    11    -5 A     Amer~
 6 0A9   Elizabethton Municipal Airp~     36.4     -82.2  1593    -5 A     Amer~
 7 0G6   Williams County Airport          41.5     -84.5   730    -5 A     Amer~
 8 0G7   Finger Lakes Regional Airpo~     42.9     -76.8   492    -5 A     Amer~
 9 0P2   Shoestring Aviation Airfield     39.8     -76.6  1000    -5 U     Amer~
10 0S9   Jefferson County Intl            48.1    -123.    108    -8 A     Amer~
# i 1,448 more rows
\end{verbatim}

Si les noms de colonnes comportent des espaces ou des caractères
spéciaux, on peut les entourer de guillemets (\texttt{"}) ou de quotes
inverses (\texttt{\textasciigrave{}})~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{rename}\NormalTok{(}
    \StringTok{"retard départ"} \OtherTok{=}\NormalTok{ dep\_delay,}
    \StringTok{"retard arrivée"} \OtherTok{=}\NormalTok{ arr\_delay}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(}\StringTok{\textasciigrave{}}\AttributeTok{retard départ}\StringTok{\textasciigrave{}}\NormalTok{, }\StringTok{\textasciigrave{}}\AttributeTok{retard arrivée}\StringTok{\textasciigrave{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 2
   `retard départ` `retard arrivée`
             <dbl>            <dbl>
 1               2               11
 2               4               20
 3               2               33
 4              -1              -18
 5              -6              -25
 6              -4               12
 7              -5               19
 8              -3              -14
 9              -3               -8
10              -2                8
# i 336,766 more rows
\end{verbatim}

\hypertarget{rename_with}{%
\subsection{rename\_with()}\label{rename_with}}

La fonction \texttt{dplyr::rename\_with()} permets de renommer plusieurs
colonnes d'un coup en transmettant une fonction, par exemple
\texttt{toupper()} qui passe tous les caractères en majuscule.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{rename\_with}\NormalTok{(toupper)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1,458 x 8
   FAA   NAME                             LAT    LON   ALT    TZ DST   TZONE    
   <chr> <chr>                          <dbl>  <dbl> <dbl> <dbl> <chr> <chr>    
 1 04G   Lansdowne Airport               41.1  -80.6  1044    -5 A     America/~
 2 06A   Moton Field Municipal Airport   32.5  -85.7   264    -6 A     America/~
 3 06C   Schaumburg Regional             42.0  -88.1   801    -6 A     America/~
 4 06N   Randall Airport                 41.4  -74.4   523    -5 A     America/~
 5 09J   Jekyll Island Airport           31.1  -81.4    11    -5 A     America/~
 6 0A9   Elizabethton Municipal Airport  36.4  -82.2  1593    -5 A     America/~
 7 0G6   Williams County Airport         41.5  -84.5   730    -5 A     America/~
 8 0G7   Finger Lakes Regional Airport   42.9  -76.8   492    -5 A     America/~
 9 0P2   Shoestring Aviation Airfield    39.8  -76.6  1000    -5 U     America/~
10 0S9   Jefferson County Intl           48.1 -123.    108    -8 A     America/~
# i 1,448 more rows
\end{verbatim}

On pourra notamment utiliser les fonctions du package \texttt{snakecase}
et, en particulier, \texttt{snakecase::to\_snake\_case()} que je
recommande pour nommer de manière consistante les variables\sidenote{\footnotesize Le
  \href{https://fr.wikipedia.org/wiki/Snake_case}{\textbf{\emph{snake
  case}}} est une convention typographique en informatique consistant à
  écrire des ensembles de mots, généralement, en minuscules en les
  séparant par des tirets bas.}.

\hypertarget{pull}{%
\subsection{pull()}\label{pull}}

La fonction \texttt{dplyr::pull()} permet d'accéder au contenu d'une
variable. C'est un équivalent aux opérateurs \texttt{\$} ou
\texttt{{[}{[}{]}{]}}. On peut lui passer un nom de variable ou bien sa
position.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{pull}\NormalTok{(alt) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mean}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1001.416
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

\texttt{dplyr::pull()} ressemble à la fonction \texttt{purrr::chuck()}
que nous avons déjà abordée (cf.~Section~\ref{sec-pluck-chuck}).
Cependant, \texttt{dplyr::pull()} ne fonctionne que sur des tableaux de
données tandis que \texttt{purrr::chuck()} est plus générique et peut
s'appliquer à tous types de listes.

\end{tcolorbox}

\hypertarget{mutate}{%
\subsection{mutate()}\label{mutate}}

\texttt{dplyr::mutate()} permet de créer de nouvelles colonnes dans le
tableau de données, en général à partir de variables existantes.

Par exemple, la table \texttt{airports} contient l'altitude de
l'aéroport en pieds. Si l'on veut créer une nouvelle variable
\emph{alt\_m} avec l'altitude en mètres, on peut faire~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airports }\OtherTok{\textless{}{-}} 
\NormalTok{  airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{alt\_m =}\NormalTok{ alt }\SpecialCharTok{/} \FloatTok{3.2808}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

On peut créer plusieurs nouvelles colonnes en une seule fois, et les
expressions successives peuvent prendre en compte les résultats des
calculs précédents. L'exemple suivant convertit d'abord la distance en
kilomètres dans une variable \emph{distance\_km}, puis utilise cette
nouvelle colonne pour calculer la vitesse en km/h.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\OtherTok{\textless{}{-}} 
\NormalTok{  flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{distance\_km =}\NormalTok{ distance }\SpecialCharTok{/} \FloatTok{0.62137}\NormalTok{,}
    \AttributeTok{vitesse =}\NormalTok{ distance\_km }\SpecialCharTok{/}\NormalTok{ air\_time }\SpecialCharTok{*} \DecValTok{60}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{opuxe9rations-groupuxe9es}{%
\section{Opérations groupées}\label{opuxe9rations-groupuxe9es}}

\hypertarget{group_by}{%
\subsection{group\_by()}\label{group_by}}

Un élément très important de \texttt{\{dplyr\}} est la fonction
\texttt{dplyr::group\_by()}. Elle permet de définir des groupes de
lignes à partir des valeurs d'une ou plusieurs colonnes. Par exemple, on
peut grouper les vols selon leur mois~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(month)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 21
# Groups:   month [12]
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# i 336,766 more rows
# i 13 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>, distance_km <dbl>,
#   vitesse <dbl>
\end{verbatim}

Par défaut ceci ne fait rien de visible, à part l'apparition d'une
mention \emph{Groups} dans l'affichage du résultat. Mais à partir du
moment où des groupes ont été définis, les verbes comme
\texttt{dplyr::slice()} ou \texttt{dplyr::mutate()} vont en tenir compte
lors de leurs opérations.

Par exemple, si on applique \texttt{dplyr::slice()} à un tableau
préalablement groupé, il va sélectionner les lignes aux positions
indiquées \emph{pour chaque groupe}. Ainsi la commande suivante affiche
le premier vol de chaque mois, selon leur ordre d'apparition dans le
tableau~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(month) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{slice}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 12 x 21
# Groups:   month [12]
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     1      517            515         2      830            819
 2  2013     2     1      456            500        -4      652            648
 3  2013     3     1        4           2159       125      318             56
 4  2013     4     1      454            500        -6      636            640
 5  2013     5     1        9           1655       434      308           2020
 6  2013     6     1        2           2359         3      341            350
 7  2013     7     1        1           2029       212      236           2359
 8  2013     8     1       12           2130       162      257             14
 9  2013     9     1        9           2359        10      343            340
10  2013    10     1      447            500       -13      614            648
11  2013    11     1        5           2359         6      352            345
12  2013    12     1       13           2359        14      446            445
# i 13 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>, distance_km <dbl>,
#   vitesse <dbl>
\end{verbatim}

Idem pour \texttt{dplyr::mutate()}~: les opérations appliquées lors du
calcul des valeurs des nouvelles colonnes sont appliquée groupe de
lignes par groupe de lignes. Dans l'exemple suivant, on ajoute une
nouvelle colonne qui contient le retard moyen \emph{du mois
correspondant}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(month) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{mean\_delay\_month =} \FunctionTok{mean}\NormalTok{(dep\_delay, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 22
# Groups:   month [12]
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# i 336,766 more rows
# i 14 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>, distance_km <dbl>,
#   vitesse <dbl>, mean_delay_month <dbl>
\end{verbatim}

Ceci peut permettre, par exemple, de déterminer si un retard donné est
supérieur ou inférieur au retard moyen du mois en cours.

\texttt{dplyr::group\_by()} peut aussi être utile avec
\texttt{dplyr::filter()}, par exemple pour sélectionner les vols avec le
retard au départ le plus important \emph{pour chaque mois}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(month) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(dep\_delay }\SpecialCharTok{==} \FunctionTok{max}\NormalTok{(dep\_delay, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 12 x 21
# Groups:   month [12]
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     9      641            900      1301     1242           1530
 2  2013    10    14     2042            900       702     2255           1127
 3  2013    11     3      603           1645       798      829           1913
 4  2013    12     5      756           1700       896     1058           2020
 5  2013     2    10     2243            830       853      100           1106
 6  2013     3    17     2321            810       911      135           1020
 7  2013     4    10     1100           1900       960     1342           2211
 8  2013     5     3     1133           2055       878     1250           2215
 9  2013     6    15     1432           1935      1137     1607           2120
10  2013     7    22      845           1600      1005     1044           1815
11  2013     8     8     2334           1454       520      120           1710
12  2013     9    20     1139           1845      1014     1457           2210
# i 13 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>, distance_km <dbl>,
#   vitesse <dbl>
\end{verbatim}

\textbf{Attention~:} la clause \texttt{dplyr::roup\_by()} marche pour
les verbes déjà vus précédemment, \emph{sauf} pour
\texttt{dplyr::arrange()}, qui par défaut trie la table sans tenir
compte des groupes. Pour obtenir un tri par groupe, il faut lui ajouter
l'argument \texttt{.by\_group\ =\ TRUE}.

On peut voir la différence en comparant les deux résultats suivants~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(month) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(dep\_delay))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 21
# Groups:   month [12]
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     9      641            900      1301     1242           1530
 2  2013     6    15     1432           1935      1137     1607           2120
 3  2013     1    10     1121           1635      1126     1239           1810
 4  2013     9    20     1139           1845      1014     1457           2210
 5  2013     7    22      845           1600      1005     1044           1815
 6  2013     4    10     1100           1900       960     1342           2211
 7  2013     3    17     2321            810       911      135           1020
 8  2013     6    27      959           1900       899     1236           2226
 9  2013     7    22     2257            759       898      121           1026
10  2013    12     5      756           1700       896     1058           2020
# i 336,766 more rows
# i 13 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>, distance_km <dbl>,
#   vitesse <dbl>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(month) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(dep\_delay), }\AttributeTok{.by\_group =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 336,776 x 21
# Groups:   month [12]
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
 1  2013     1     9      641            900      1301     1242           1530
 2  2013     1    10     1121           1635      1126     1239           1810
 3  2013     1     1      848           1835       853     1001           1950
 4  2013     1    13     1809            810       599     2054           1042
 5  2013     1    16     1622            800       502     1911           1054
 6  2013     1    23     1551            753       478     1812           1006
 7  2013     1    10     1525            900       385     1713           1039
 8  2013     1     1     2343           1724       379      314           1938
 9  2013     1     2     2131           1512       379     2340           1741
10  2013     1     7     2021           1415       366     2332           1724
# i 336,766 more rows
# i 13 more variables: arr_delay <dbl>, carrier <chr>, flight <int>,
#   tailnum <chr>, origin <chr>, dest <chr>, air_time <dbl>, distance <dbl>,
#   hour <dbl>, minute <dbl>, time_hour <dttm>, distance_km <dbl>,
#   vitesse <dbl>
\end{verbatim}

\hypertarget{summarise}{%
\subsection{summarise()}\label{summarise}}

\texttt{dplyr::summarise()} permet d'agréger les lignes du tableau en
effectuant une opération résumée sur une ou plusieurs colonnes. Il
s'agit de toutes les fonctions qui prennent en entrée un ensemble de
valeurs et renvoie une valeur unique, comme la moyenne
(\texttt{mean()}). Par exemple, si l'on souhaite connaître les retards
moyens au départ et à l'arrivée pour l'ensemble des vols du tableau
\texttt{flights}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{retard\_dep =} \FunctionTok{mean}\NormalTok{(dep\_delay, }\AttributeTok{na.rm=}\ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{retard\_arr =} \FunctionTok{mean}\NormalTok{(arr\_delay, }\AttributeTok{na.rm=}\ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1 x 2
  retard_dep retard_arr
       <dbl>      <dbl>
1       12.6       6.90
\end{verbatim}

Cette fonction est en général utilisée avec \texttt{dplyr::group\_by()},
puisqu'elle permet du coup d'agréger et de résumer les lignes du tableau
groupe par groupe. Si l'on souhaite calculer le délai maximum, le délai
minimum et le délai moyen au départ pour chaque mois, on pourra faire~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(month) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{max\_delay =} \FunctionTok{max}\NormalTok{(dep\_delay, }\AttributeTok{na.rm=}\ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{min\_delay =} \FunctionTok{min}\NormalTok{(dep\_delay, }\AttributeTok{na.rm=}\ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{mean\_delay =} \FunctionTok{mean}\NormalTok{(dep\_delay, }\AttributeTok{na.rm=}\ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 12 x 4
   month max_delay min_delay mean_delay
   <int>     <dbl>     <dbl>      <dbl>
 1     1      1301       -30      10.0 
 2     2       853       -33      10.8 
 3     3       911       -25      13.2 
 4     4       960       -21      13.9 
 5     5       878       -24      13.0 
 6     6      1137       -21      20.8 
 7     7      1005       -22      21.7 
 8     8       520       -26      12.6 
 9     9      1014       -24       6.72
10    10       702       -25       6.24
11    11       798       -32       5.44
12    12       896       -43      16.6 
\end{verbatim}

\texttt{dplyr::summarise()} dispose d'une fonction spéciale
\texttt{dplyr::n()}, qui retourne le nombre de lignes du groupe. Ainsi
si l'on veut le nombre de vols par destination, on peut utiliser~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(dest) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{n =} \FunctionTok{n}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 105 x 2
   dest      n
   <chr> <int>
 1 ABQ     254
 2 ACK     265
 3 ALB     439
 4 ANC       8
 5 ATL   17215
 6 AUS    2439
 7 AVL     275
 8 BDL     443
 9 BGR     375
10 BHM     297
# i 95 more rows
\end{verbatim}

\texttt{dplyr::n()} peut aussi être utilisée avec
\texttt{dplyr::filter()} et \texttt{dplyr::mutate()}.

\hypertarget{count}{%
\subsection{count()}\label{count}}

À noter que quand l'on veut compter le nombre de lignes par groupe, on
peut utiliser directement la fonction \texttt{dplyr::count()}. Ainsi le
code suivant est identique au précédent~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{count}\NormalTok{(dest)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 105 x 2
   dest      n
   <chr> <int>
 1 ABQ     254
 2 ACK     265
 3 ALB     439
 4 ANC       8
 5 ATL   17215
 6 AUS    2439
 7 AVL     275
 8 BDL     443
 9 BGR     375
10 BHM     297
# i 95 more rows
\end{verbatim}

\hypertarget{grouper-selon-plusieurs-variables}{%
\subsection{Grouper selon plusieurs
variables}\label{grouper-selon-plusieurs-variables}}

On peut grouper selon plusieurs variables à la fois, il suffit de les
indiquer dans la clause du \texttt{dplyr::group\_by()}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(month, dest) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{nb =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(nb))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
`summarise()` has grouped output by 'month'. You can override using the
`.groups` argument.
\end{verbatim}

\begin{verbatim}
# A tibble: 1,113 x 3
# Groups:   month [12]
   month dest     nb
   <int> <chr> <int>
 1     8 ORD    1604
 2    10 ORD    1604
 3     5 ORD    1582
 4     9 ORD    1582
 5     7 ORD    1573
 6     6 ORD    1547
 7     7 ATL    1511
 8     8 ATL    1507
 9     8 LAX    1505
10     7 LAX    1500
# i 1,103 more rows
\end{verbatim}

On peut également compter selon plusieurs variables~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{count}\NormalTok{(origin, dest) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(n))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 224 x 3
   origin dest      n
   <chr>  <chr> <int>
 1 JFK    LAX   11262
 2 LGA    ATL   10263
 3 LGA    ORD    8857
 4 JFK    SFO    8204
 5 LGA    CLT    6168
 6 EWR    ORD    6100
 7 JFK    BOS    5898
 8 LGA    MIA    5781
 9 JFK    MCO    5464
10 EWR    BOS    5327
# i 214 more rows
\end{verbatim}

On peut utiliser plusieurs opérations de groupage dans le même
\emph{pipeline}. Ainsi, si l'on souhaite déterminer le couple
origine/destination ayant le plus grand nombre de vols selon le mois de
l'année, on devra procéder en deux étapes~:

\begin{itemize}
\tightlist
\item
  d'abord grouper selon mois, origine et destination pour calculer le
  nombre de vols
\item
  puis grouper uniquement selon le mois pour sélectionner la ligne avec
  la valeur maximale.
\end{itemize}

Au final, on obtient le code suivant~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(month, origin, dest) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{nb =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(month) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{filter}\NormalTok{(nb }\SpecialCharTok{==} \FunctionTok{max}\NormalTok{(nb))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
`summarise()` has grouped output by 'month', 'origin'. You can override using
the `.groups` argument.
\end{verbatim}

\begin{verbatim}
# A tibble: 12 x 4
# Groups:   month [12]
   month origin dest     nb
   <int> <chr>  <chr> <int>
 1     1 JFK    LAX     937
 2     2 JFK    LAX     834
 3     3 JFK    LAX     960
 4     4 JFK    LAX     935
 5     5 JFK    LAX     960
 6     6 JFK    LAX     928
 7     7 JFK    LAX     985
 8     8 JFK    LAX     979
 9     9 JFK    LAX     925
10    10 JFK    LAX     965
11    11 JFK    LAX     907
12    12 JFK    LAX     947
\end{verbatim}

Lorsqu'on effectue un \texttt{dplyr::group\_by()} suivi d'un
\texttt{dplyr::summarise()}, le tableau résultat est automatiquement
dégroupé \emph{de la dernière variable de regroupement}. Ainsi le
tableau généré par le code suivant est groupé par \emph{month} et
\emph{origin}\sidenote{\footnotesize Comme expliqué dans le message affiché dans la
  console, cela peut être contrôlé avec l'argument \texttt{.groups} de
  \texttt{dplyr::summarise()}, dont les options sont décrites dans
  l'aide de la fonction.}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(month, origin, dest) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{nb =} \FunctionTok{n}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
`summarise()` has grouped output by 'month', 'origin'. You can override using
the `.groups` argument.
\end{verbatim}

\begin{verbatim}
# A tibble: 2,313 x 4
# Groups:   month, origin [36]
   month origin dest     nb
   <int> <chr>  <chr> <int>
 1     1 EWR    ALB      64
 2     1 EWR    ATL     362
 3     1 EWR    AUS      51
 4     1 EWR    AVL       2
 5     1 EWR    BDL      37
 6     1 EWR    BNA     111
 7     1 EWR    BOS     430
 8     1 EWR    BQN      31
 9     1 EWR    BTV     100
10     1 EWR    BUF     119
# i 2,303 more rows
\end{verbatim}

Cela peut permettre d'enchaîner les opérations groupées. Dans l'exemple
suivant, on calcule le pourcentage des trajets pour chaque destination
par rapport à tous les trajets du mois~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(month, dest) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{nb =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{pourcentage =}\NormalTok{ nb }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(nb) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
`summarise()` has grouped output by 'month'. You can override using the
`.groups` argument.
\end{verbatim}

\begin{verbatim}
# A tibble: 1,113 x 4
# Groups:   month [12]
   month dest     nb pourcentage
   <int> <chr> <int>       <dbl>
 1     1 ALB      64     0.237  
 2     1 ATL    1396     5.17   
 3     1 AUS     169     0.626  
 4     1 AVL       2     0.00741
 5     1 BDL      37     0.137  
 6     1 BHM      25     0.0926 
 7     1 BNA     399     1.48   
 8     1 BOS    1245     4.61   
 9     1 BQN      93     0.344  
10     1 BTV     223     0.826  
# i 1,103 more rows
\end{verbatim}

On peut à tout moment dégrouper un tableau à l'aide de
\texttt{dplyr::ungroup()}. Ce serait par exemple nécessaire, dans
l'exemple précédent, si on voulait calculer le pourcentage sur le nombre
total de vols plutôt que sur le nombre de vols par mois~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(month, dest) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{nb =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{ungroup}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{pourcentage =}\NormalTok{ nb }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(nb) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
`summarise()` has grouped output by 'month'. You can override using the
`.groups` argument.
\end{verbatim}

\begin{verbatim}
# A tibble: 1,113 x 4
   month dest     nb pourcentage
   <int> <chr> <int>       <dbl>
 1     1 ALB      64    0.0190  
 2     1 ATL    1396    0.415   
 3     1 AUS     169    0.0502  
 4     1 AVL       2    0.000594
 5     1 BDL      37    0.0110  
 6     1 BHM      25    0.00742 
 7     1 BNA     399    0.118   
 8     1 BOS    1245    0.370   
 9     1 BQN      93    0.0276  
10     1 BTV     223    0.0662  
# i 1,103 more rows
\end{verbatim}

À noter que \texttt{dplyr::count()}, par contre, renvoit un tableau non
groupé~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{count}\NormalTok{(month, dest)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1,113 x 3
   month dest      n
   <int> <chr> <int>
 1     1 ALB      64
 2     1 ATL    1396
 3     1 AUS     169
 4     1 AVL       2
 5     1 BDL      37
 6     1 BHM      25
 7     1 BNA     399
 8     1 BOS    1245
 9     1 BQN      93
10     1 BTV     223
# i 1,103 more rows
\end{verbatim}

\hypertarget{cheatsheet}{%
\section{Cheatsheet}\label{cheatsheet}}

\begin{figure}

{\centering 

\href{https://github.com/rstudio/cheatsheets/blob/main/data-transformation.pdf}{\includegraphics{manipulation/ressources/dplyr-cheatsheet-thumbs.png}}

}

\end{figure}

\hypertarget{webin-r-3}{%
\section{webin-R}\label{webin-r-3}}

On pourra également se référer au webin-R \#04 (\emph{manipuler les
données avec dplyr}) sur \href{https://youtu.be/aFvBhgmawcs}{YouTube}.

\url{https://youtu.be/aFvBhgmawcs}

\hypertarget{sec-facteurs}{%
\chapter{\texorpdfstring{Facteurs et
\texttt{forcats}}{Facteurs et forcats}}\label{sec-facteurs}}

Dans \textbf{R}, les fecteurs sont utilisés pour représenter des
variables catégorielles, c'est-à-dire des variables qui ont un nombre
fixé et limité de valeurs possibles (par exemple une variable
\emph{sexe} ou une variable \emph{niveau d'éducation}).

De telles variables sont parfois représentées sous forme textuelle
(vecteurs de type \texttt{character}). Cependant, cela ne permets pas
d'indiquer un ordre spécifique aux modalités, à la différence des
facteurs.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

Lorsque l'on importe des données d'enquêtes, il est fréquent que les
variables catégorielles sont codées sous la forme d'un code numérique
(par exemple 1 pour \emph{femme} et 2 pour \emph{homme}) auquel est
associé une \emph{étiquette de valeur}. C'est notamment le
fonctionnement usuel de logiciels tels que \textbf{SPSS}, \textbf{Stata}
ou \textbf{SAS}. Les étiquettes de valeurs seront abordés dans un
prochain chapitre (voir Chapitre~\ref{sec-etiquettes-valeurs}).

Au moment de l'analyse (tableaux statistiques, graphiques, modèles de
régression\ldots), il sera nécessaire de transformer ces vecteurs avec
étiquettes en facteurs.

\end{tcolorbox}

\hypertarget{cruxe9ation-dun-facteur}{%
\section{Création d'un facteur}\label{cruxe9ation-dun-facteur}}

Le plus simple pour créer un facteur est de partir d'un vecteur textuel
et d'utiliser la fonction \texttt{factor()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"nord"}\NormalTok{, }\StringTok{"sud"}\NormalTok{, }\StringTok{"sud"}\NormalTok{, }\StringTok{"est"}\NormalTok{, }\StringTok{"est"}\NormalTok{, }\StringTok{"est"}\NormalTok{)}
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{factor}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] nord sud  sud  est  est  est 
Levels: est nord sud
\end{verbatim}

Par défaut, les niveaux du facteur obtenu correspondent aux valeurs
uniques du fecteur textuel, triés par ordre alphabétique. Si l'on veut
contrôler l'ordre des niveaux, et éventuellement indiquer un niveau
absent des données, on utilisera l'argument \texttt{levels} de
\texttt{factor()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{factor}\NormalTok{(}\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"nord"}\NormalTok{, }\StringTok{"est"}\NormalTok{, }\StringTok{"sud"}\NormalTok{, }\StringTok{"ouest"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] nord sud  sud  est  est  est 
Levels: nord est sud ouest
\end{verbatim}

Si une valeur observée dans les données n'est pas indiqué dans
\texttt{levels}, elle sera siliencieusement convertie en valeur
manquante (\texttt{NA}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{factor}\NormalTok{(}\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"nord"}\NormalTok{, }\StringTok{"sud"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] nord sud  sud  <NA> <NA> <NA>
Levels: nord sud
\end{verbatim}

Si l'on veut être averti par un warning dans ce genre de situation, on
pourra avoir plutôt recours à la fonction
\texttt{readr::parse\_factor()} du package \texttt{\{readr\}}, qui, le
cas échéant, renverra un tableau avec les problèmes rencontrés.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  readr}\SpecialCharTok{::}\FunctionTok{parse\_factor}\NormalTok{(}\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"nord"}\NormalTok{, }\StringTok{"sud"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Warning: 3 parsing failures.
row col           expected actual
  4  -- value in level set    est
  5  -- value in level set    est
  6  -- value in level set    est
\end{verbatim}

\begin{verbatim}
[1] nord sud  sud  <NA> <NA> <NA>
attr(,"problems")
# A tibble: 3 x 4
    row   col expected           actual
  <int> <int> <chr>              <chr> 
1     4    NA value in level set est   
2     5    NA value in level set est   
3     6    NA value in level set est   
Levels: nord sud
\end{verbatim}

Une fois un facteur créé, on peut accéder à la liste de ses étiquettes
avec \texttt{levels()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{f }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(x)}
\FunctionTok{levels}\NormalTok{(f)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "est"  "nord" "sud" 
\end{verbatim}

Dans certaines situations (par exemple pour la réalisation d'une
régression logistique ordinale), on peut avoir avoir besoin d'indiquer
que les modalités du facteur sont ordonnées héarchiquement. Dans ce cas
là, on aura simplement recours à \texttt{ordered()} pour créer/convertir
notre facteur.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{c}\NormalTok{(}\StringTok{"supérieur"}\NormalTok{, }\StringTok{"primaire"}\NormalTok{, }\StringTok{"secondaire"}\NormalTok{, }\StringTok{"primaire"}\NormalTok{, }\StringTok{"supérieur"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{ordered}\NormalTok{(}\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"primaire"}\NormalTok{, }\StringTok{"secondaire"}\NormalTok{, }\StringTok{"supérieur"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] supérieur  primaire   secondaire primaire   supérieur 
Levels: primaire < secondaire < supérieur
\end{verbatim}

Techniquement, les valeurs d'un facteur sont stockés de manière interne
à l'aide de nombres entiers, dont la valeur représente la position de
l'étiquette correspondante dans l'attribut \texttt{levels}. Ainsi, un
facteur à \texttt{n} modalités sera toujours codé avec les nombre
entiers allant de 1 à \texttt{n}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(f)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "factor"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{typeof}\NormalTok{(f)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "integer"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{as.integer}\NormalTok{(f)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2 3 3 1 1 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{as.character}\NormalTok{(f)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "nord" "sud"  "sud"  "est"  "est"  "est" 
\end{verbatim}

\hypertarget{changer-lordre-des-modalituxe9s}{%
\section{Changer l'ordre des
modalités}\label{changer-lordre-des-modalituxe9s}}

Le pacakge \texttt{\{forcats\}}, chargé par défaut lorsque l'on exécute
la commande \texttt{library(tidyverse)}, fournie plusieurs fonctions
pour manipuler des facteurs. Pour donner des exemples d'utilisation de
ces différentes fonctions, nous allons utiliser le jeu de données
\texttt{hdv2003} du package \texttt{\{questionr\}}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{data}\NormalTok{(}\StringTok{"hdv2003"}\NormalTok{, }\AttributeTok{package =} \StringTok{"questionr"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Considérons la variable \emph{qualif} qui indique le niveau de
qualification des enquêtés. On peut voir la liste des niveaux de ce
facteur, et leur ordre, avec \texttt{levels()}, ou en effectuant un tri
à plat avec la fonction \texttt{questionr::freq()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{qualif }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{levels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Ouvrier specialise"       "Ouvrier qualifie"        
[3] "Technicien"               "Profession intermediaire"
[5] "Cadre"                    "Employe"                 
[7] "Autre"                   
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{qualif }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                           n    % val%
Ouvrier specialise       203 10.2 12.3
Ouvrier qualifie         292 14.6 17.7
Technicien                86  4.3  5.2
Profession intermediaire 160  8.0  9.7
Cadre                    260 13.0 15.7
Employe                  594 29.7 35.9
Autre                     58  2.9  3.5
NA                       347 17.3   NA
\end{verbatim}

Parfois, on a simplement besoin d'inverser l'ordre des facteurs, ce qui
peut se faire facilement avec la fonction \texttt{forcats::fct\_rev()}.
Elle renvoie le facteur fourni en entrée en ayant inverser l'ordre des
modalités (mais sans modifier l'ordre des valeurs dans le vecteur).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{qualif }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_rev}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                           n    % val%
Autre                     58  2.9  3.5
Employe                  594 29.7 35.9
Cadre                    260 13.0 15.7
Profession intermediaire 160  8.0  9.7
Technicien                86  4.3  5.2
Ouvrier qualifie         292 14.6 17.7
Ouvrier specialise       203 10.2 12.3
NA                       347 17.3   NA
\end{verbatim}

Pour plus de contrôle, on utilisera \texttt{forcats::fct\_relevel()} où
l'on indique l'ordre souhaité des modalités. On peut également seulement
indiquer les premières modalités, les autres seront ajoutées à la fin
sans changer leur ordre.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{qualif }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_relevel}\NormalTok{(}\StringTok{"Cadre"}\NormalTok{, }\StringTok{"Autre"}\NormalTok{, }\StringTok{"Technicien"}\NormalTok{, }\StringTok{"Employe"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                           n    % val%
Cadre                    260 13.0 15.7
Autre                     58  2.9  3.5
Technicien                86  4.3  5.2
Employe                  594 29.7 35.9
Ouvrier specialise       203 10.2 12.3
Ouvrier qualifie         292 14.6 17.7
Profession intermediaire 160  8.0  9.7
NA                       347 17.3   NA
\end{verbatim}

La fonction \texttt{forcats::fct\_infreq()} ordonne les modalités de
celle la plus fréquente à celle la moins fréquente (nombre
d'observations)~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{qualif }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_infreq}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                           n    % val%
Employe                  594 29.7 35.9
Ouvrier qualifie         292 14.6 17.7
Cadre                    260 13.0 15.7
Ouvrier specialise       203 10.2 12.3
Profession intermediaire 160  8.0  9.7
Technicien                86  4.3  5.2
Autre                     58  2.9  3.5
NA                       347 17.3   NA
\end{verbatim}

Pour inverser l'ordre, on combinera \texttt{forcats::fct\_infreq()} avec
\texttt{forcats::fct\_rev()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{qualif }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_infreq}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_rev}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                           n    % val%
Autre                     58  2.9  3.5
Technicien                86  4.3  5.2
Profession intermediaire 160  8.0  9.7
Ouvrier specialise       203 10.2 12.3
Cadre                    260 13.0 15.7
Ouvrier qualifie         292 14.6 17.7
Employe                  594 29.7 35.9
NA                       347 17.3   NA
\end{verbatim}

Dans certains cas, on souhaite créer un facteur dont les modalités sont
triées selon leur ordre d'apparation dans le jeu de données. Pour cela,
on aura recours à \texttt{forcats::fct\_inorder()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"c"}\NormalTok{, }\StringTok{"a"}\NormalTok{, }\StringTok{"d"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"a"}\NormalTok{, }\StringTok{"c"}\NormalTok{)}
\FunctionTok{factor}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] c a d b a c
Levels: a b c d
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fct\_inorder}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] c a d b a c
Levels: c a d b
\end{verbatim}

La fonction \texttt{forcats::fct\_reorder()} permets de trier les
modalités en fonction d'une autre variable. Par exemple, si je souhaite
trier les modalités de la variable \emph{qualif} en fonction de l'âge
moyen (dans chaque modalité)~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{qualif\_tri\_age }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003}\SpecialCharTok{$}\NormalTok{qualif }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_reorder}\NormalTok{(hdv2003}\SpecialCharTok{$}\NormalTok{age, }\AttributeTok{.fun =}\NormalTok{ mean)}
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(qualif\_tri\_age) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(}\AttributeTok{age\_moyen =} \FunctionTok{mean}\NormalTok{(age))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 8 x 2
  qualif_tri_age           age_moyen
  <fct>                        <dbl>
1 Technicien                    45.9
2 Employe                       46.7
3 Autre                         47.0
4 Ouvrier specialise            48.9
5 Profession intermediaire      49.1
6 Cadre                         49.7
7 Ouvrier qualifie              50.0
8 <NA>                          47.9
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

\texttt{\{questionr\}} propose une interface graphique afin de faciliter
les opérations de réordonnancement manuel. Pour la lancer, sélectionner
le menu \emph{Addins} puis \emph{Levels ordering}, ou exécuter la
fonction \texttt{questionr::iorder()} en lui passant comme paramètre le
facteur à réordonner.

\includegraphics{manipulation/ressources/iorder.png}

Une démonstration en vidéo de cet \emph{add-in} est disponible dans le
webin-R \#05 (\emph{recoder des variables}) sur
{[}YouTube{]}(https://youtu.be/CokvTbtWdwc?t=3934).

\url{https://youtu.be/CokvTbtWdwc}

\end{tcolorbox}

\hypertarget{sec-modifier-modalites}{%
\section{Modifier les modalités}\label{sec-modifier-modalites}}

Pour modifier le nom des modalités, on pourra avoir recours à
\texttt{forcats::fct\_recode()} avec une syntaxe de la forme
\texttt{"nouveau\ nom"\ =\ "ancien\ nom"}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{sexe }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         n  % val%
Homme  899 45   45
Femme 1101 55   55
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{sexe }\OtherTok{\textless{}{-}} 
\NormalTok{  hdv2003}\SpecialCharTok{$}\NormalTok{sexe }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_recode}\NormalTok{(}\AttributeTok{f =} \StringTok{"Femme"}\NormalTok{, }\AttributeTok{m =} \StringTok{"Homme"}\NormalTok{)}
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{sexe }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
     n  % val%
m  899 45   45
f 1101 55   55
\end{verbatim}

On peut également fusionner des modalités ensemble en leur attribuant le
même nom.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{nivetud }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                                                                  n    % val%
N'a jamais fait d'etudes                                         39  2.0  2.1
A arrete ses etudes, avant la derniere annee d'etudes primaires  86  4.3  4.6
Derniere annee d'etudes primaires                               341 17.0 18.1
1er cycle                                                       204 10.2 10.8
2eme cycle                                                      183  9.2  9.7
Enseignement technique ou professionnel court                   463 23.2 24.5
Enseignement technique ou professionnel long                    131  6.6  6.9
Enseignement superieur y compris technique superieur            441 22.0 23.4
NA                                                              112  5.6   NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{instruction }\OtherTok{\textless{}{-}} 
\NormalTok{  hdv2003}\SpecialCharTok{$}\NormalTok{nivetud }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_recode}\NormalTok{(}
    \StringTok{"primaire"} \OtherTok{=} \StringTok{"N\textquotesingle{}a jamais fait d\textquotesingle{}etudes"}\NormalTok{,}
    \StringTok{"primaire"} \OtherTok{=} \StringTok{"A arrete ses etudes, avant la derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
    \StringTok{"primaire"} \OtherTok{=} \StringTok{"Derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
    \StringTok{"secondaire"} \OtherTok{=} \StringTok{"1er cycle"}\NormalTok{,}
    \StringTok{"secondaire"} \OtherTok{=} \StringTok{"2eme cycle"}\NormalTok{,}
    \StringTok{"technique/professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel court"}\NormalTok{,}
    \StringTok{"technique/professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel long"}\NormalTok{,}
    \StringTok{"supérieur"} \OtherTok{=} \StringTok{"Enseignement superieur y compris technique superieur"}
\NormalTok{  )}
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{instruction }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                          n    % val%
primaire                466 23.3 24.7
secondaire              387 19.4 20.5
technique/professionnel 594 29.7 31.5
supérieur               441 22.0 23.4
NA                      112  5.6   NA
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Interface graphique}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Le package\texttt{\{questionr\}} propose une interface graphique
facilitant le recodage des modalités d'une variable qualitative.
L'objectif est de permettre à la personne qui l'utilise de saisir les
nouvelles valeurs dans un formulaire, et de générer ensuite le code R
correspondant au recodage indiqué.

Pour utiliser cette interface, sous \textbf{RStudio} vous pouvez aller
dans le menu \emph{Addins} (présent dans la barre d'outils principale)
puis choisir \emph{Levels recoding}. Sinon, vous pouvez lancer dans la
console la fonction \texttt{questionr::irec()} en lui passant comme
paramètre la variable à recoder.

\includegraphics{manipulation/ressources/irec.png}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Une démonstration en vidéo de cet \emph{add-in} est disponible dans le
webin-R \#05 (\emph{recoder des variables}) sur
{[}YouTube{]}(https://youtu.be/CokvTbtWdwc?t=3387).

\url{https://youtu.be/CokvTbtWdwc}

\end{tcolorbox}

\end{tcolorbox}

La fonction \texttt{forcats::fct\_collapse()} est une variante de
\texttt{forcats::fct\_recode()} pour indiquer les fusions de modalités.
La même recodification s'écrirait alors~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{instruction }\OtherTok{\textless{}{-}} 
\NormalTok{  hdv2003}\SpecialCharTok{$}\NormalTok{nivetud }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_collapse}\NormalTok{(}
    \StringTok{"primaire"} \OtherTok{=} \FunctionTok{c}\NormalTok{(}
      \StringTok{"N\textquotesingle{}a jamais fait d\textquotesingle{}etudes"}\NormalTok{,}
      \StringTok{"A arrete ses etudes, avant la derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
      \StringTok{"Derniere annee d\textquotesingle{}etudes primaires"}
\NormalTok{    ),}
    \StringTok{"secondaire"} \OtherTok{=} \FunctionTok{c}\NormalTok{(}
      \StringTok{"1er cycle"}\NormalTok{,}
      \StringTok{"2eme cycle"}
\NormalTok{    ),}
    \StringTok{"technique/professionnel"} \OtherTok{=} \FunctionTok{c}\NormalTok{(}
      \StringTok{"Enseignement technique ou professionnel court"}\NormalTok{,}
      \StringTok{"Enseignement technique ou professionnel long"}
\NormalTok{    ),}
    \StringTok{"supérieur"} \OtherTok{=} \StringTok{"Enseignement superieur y compris technique superieur"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

Pour transformer les valeurs manquantes (\texttt{NA}) en une modalité
explicite, on pourra avoir recours à
\texttt{forcats::fct\_na\_value\_to\_level()}\sidenote{\footnotesize Cette fonction
  s'appelait précédemment \texttt{forcats::fct\_explicit\_na()} et a été
  renommée depuis la version 1.0.0 de \texttt{\{forcats\}.}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{instruction }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003}\SpecialCharTok{$}\NormalTok{instruction }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_na\_value\_to\_level}\NormalTok{(}\AttributeTok{level =} \StringTok{"(manquant)"}\NormalTok{)}
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{instruction }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                          n    % val%
primaire                466 23.3 23.3
secondaire              387 19.4 19.4
technique/professionnel 594 29.7 29.7
supérieur               441 22.0 22.0
(manquant)              112  5.6  5.6
\end{verbatim}

Plusieurs fonctions permettent de regrouper plusieurs modalités dans une
modalité \emph{autres}.

Par exemple, avec \texttt{forcats::fct\_other()}, on pourra indiquer les
modalités à garder.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{qualif }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                           n    % val%
Ouvrier specialise       203 10.2 12.3
Ouvrier qualifie         292 14.6 17.7
Technicien                86  4.3  5.2
Profession intermediaire 160  8.0  9.7
Cadre                    260 13.0 15.7
Employe                  594 29.7 35.9
Autre                     58  2.9  3.5
NA                       347 17.3   NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{qualif }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_other}\NormalTok{(}\AttributeTok{keep =} \FunctionTok{c}\NormalTok{(}\StringTok{"Technicien"}\NormalTok{, }\StringTok{"Cadre"}\NormalTok{, }\StringTok{"Employe"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
             n    % val%
Technicien  86  4.3  5.2
Cadre      260 13.0 15.7
Employe    594 29.7 35.9
Other      713 35.6 43.1
NA         347 17.3   NA
\end{verbatim}

La fonction \texttt{forcats::fct\_lump\_n()} permets de ne conserver que
les modalités les plus fréquentes et de regrouper les autres dans une
modalité \emph{autres}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{qualif }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_lump\_n}\NormalTok{(}\AttributeTok{n =} \DecValTok{4}\NormalTok{, }\AttributeTok{other\_level =} \StringTok{"Autres"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                     n    % val%
Ouvrier specialise 203 10.2 12.3
Ouvrier qualifie   292 14.6 17.7
Cadre              260 13.0 15.7
Employe            594 29.7 35.9
Autres             304 15.2 18.4
NA                 347 17.3   NA
\end{verbatim}

Et \texttt{forcats::fct\_lump\_min()} celles qui ont un minimum
d'observations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{qualif }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_lump\_min}\NormalTok{(}\AttributeTok{min =} \DecValTok{200}\NormalTok{, }\AttributeTok{other\_level =} \StringTok{"Autres"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                     n    % val%
Ouvrier specialise 203 10.2 12.3
Ouvrier qualifie   292 14.6 17.7
Cadre              260 13.0 15.7
Employe            594 29.7 35.9
Autres             304 15.2 18.4
NA                 347 17.3   NA
\end{verbatim}

Il peut arriver qu'une des modalités d'un facteur ne soit pas
représentée dans les données.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"a"}\NormalTok{),}
  \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"c"}\NormalTok{)}
\NormalTok{)}
\NormalTok{questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  n  % val%
a 3 75   75
b 1 25   25
c 0  0    0
\end{verbatim}

Pour calculer certains tests statistiques ou faire tourner un modèle,
ces modalités sans observation peuvent être problématiques.
\texttt{forcats::fct\_drop()} permet de supprimer les modalités qui
n'apparaissent pas dans les données.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] a a b a
Levels: a b c
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\SpecialCharTok{|\textgreater{}} \FunctionTok{fct\_drop}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] a a b a
Levels: a b
\end{verbatim}

À l'inverse, \texttt{forcats::fct\_expand()} permet d'ajouter une ou
plusieurs modalités à un facteur.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] a a b a
Levels: a b c
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\SpecialCharTok{|\textgreater{}} \FunctionTok{fct\_expand}\NormalTok{(}\StringTok{"d"}\NormalTok{, }\StringTok{"e"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] a a b a
Levels: a b c d e
\end{verbatim}

\hypertarget{sec-cut}{%
\section{Découper une variable numérique en classes}\label{sec-cut}}

Il est fréquent d'avoir besoin de découper une variable numérique en une
variable catgéorielles (un facteur) à plusieurs modalités, par exemple
pour créer des groupes d'âges à partir d'une variable \emph{age}.

On utilise pour cela la fonction \texttt{cut()} qui prend, outre la
variable à découper, un certain nombre d'arguments~:

\begin{itemize}
\tightlist
\item
  \texttt{breaks} indique soit le nombre de classes souhaité, soit, si
  on lui fournit un vecteur, les limites des classes~;
\item
  \texttt{labels} permet de modifier les noms de modalités attribués aux
  classes~;
\item
  \texttt{include.lowest} et \texttt{right} influent sur la manière dont
  les valeurs situées à la frontière des classes seront inclues ou
  exclues~;
\item
  \texttt{dig.lab} indique le nombre de chiffres après la virgule à
  conserver dans les noms de modalités.
\end{itemize}

Prenons tout de suite un exemple et tentons de découper la variable
\emph{age} en cinq classes~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{groupe\_ages =} \FunctionTok{cut}\NormalTok{(age, }\DecValTok{5}\NormalTok{))}
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{groupe\_ages }\SpecialCharTok{|\textgreater{}}\NormalTok{ questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
              n    % val%
(17.9,33.8] 454 22.7 22.7
(33.8,49.6] 628 31.4 31.4
(49.6,65.4] 556 27.8 27.8
(65.4,81.2] 319 16.0 16.0
(81.2,97.1]  43  2.1  2.1
\end{verbatim}

Par défaut \textbf{R} nous a bien créé cinq classes d'amplitudes égales.
La première classe va de 17,9 à 33,8 ans (en fait de 17 à 32), etc.

Les frontières de classe seraient plus présentables si elles utilisaient
des nombres ronds. On va donc spécifier manuellement le découpage
souhaité, par tranches de 20 ans~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{groupe\_ages =} \FunctionTok{cut}\NormalTok{(age, }\FunctionTok{c}\NormalTok{(}\DecValTok{18}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{40}\NormalTok{, }\DecValTok{60}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{97}\NormalTok{)))}
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{groupe\_ages }\SpecialCharTok{|\textgreater{}}\NormalTok{ questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
          n    % val%
(18,20]  55  2.8  2.8
(20,40] 660 33.0 33.3
(40,60] 780 39.0 39.3
(60,80] 436 21.8 22.0
(80,97]  52  2.6  2.6
NA       17  0.9   NA
\end{verbatim}

Les symboles dans les noms attribués aux classes ont leur importance~:
\texttt{(} signifie que la frontière de la classe est exclue, tandis que
\texttt{{[}} signifie qu'elle est incluse. Ainsi, \texttt{(20,40{]}}
signifie «~strictement supérieur à 20 et inférieur ou égal à 40~».

On remarque que du coup, dans notre exemple précédent, la valeur
minimale, 18, est exclue de notre première classe, et qu'une observation
est donc absente de ce découpage. Pour résoudre ce problème on peut soit
faire commencer la première classe à 17, soit utiliser l'option
\texttt{include.lowest=TRUE}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{groupe\_ages =} \FunctionTok{cut}\NormalTok{(}
\NormalTok{    age, }
    \FunctionTok{c}\NormalTok{(}\DecValTok{18}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{40}\NormalTok{, }\DecValTok{60}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{97}\NormalTok{),}
    \AttributeTok{include.lowest =} \ConstantTok{TRUE}
\NormalTok{  ))}
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{groupe\_ages }\SpecialCharTok{|\textgreater{}}\NormalTok{ questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
          n    % val%
[18,20]  72  3.6  3.6
(20,40] 660 33.0 33.0
(40,60] 780 39.0 39.0
(60,80] 436 21.8 21.8
(80,97]  52  2.6  2.6
\end{verbatim}

On peut également modifier le sens des intervalles avec l'option
\texttt{right=FALSE}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{groupe\_ages =} \FunctionTok{cut}\NormalTok{(}
\NormalTok{    age, }
    \FunctionTok{c}\NormalTok{(}\DecValTok{18}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{40}\NormalTok{, }\DecValTok{60}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{97}\NormalTok{),}
    \AttributeTok{include.lowest =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{  ))}
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{groupe\_ages }\SpecialCharTok{|\textgreater{}}\NormalTok{ questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
          n    % val%
[18,20)  48  2.4  2.4
[20,40) 643 32.1 32.1
[40,60) 793 39.6 39.6
[60,80) 454 22.7 22.7
[80,97]  62  3.1  3.1
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Interface graphique}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Il n'est pas nécessaire de connaître toutes les options de
\texttt{cut()}. Le package \texttt{\{questionr\}} propose là encore une
interface graphique permettant de visualiser l'effet des différents
paramètres et de générer le code \textbf{R} correspondant.

Pour utiliser cette interface, sous \textbf{RStudio} vous pouvez aller
dans le menu \emph{Addins} (présent dans la barre d'outils principale)
puis choisir \emph{Numeric range dividing}. Sinon, vous pouvez lancer
dans la console la fonction \texttt{questionr::icut()} en lui passant
comme paramètre la variable numérique à découper.

\includegraphics{manipulation/ressources/icut.png} Une démonstration en
vidéo de cet \emph{add-in} est disponible dans le webin-R \#05
(\emph{recoder des variables}) sur
{[}YouTube{]}(https://youtu.be/CokvTbtWdwc?t=2795).

\url{https://youtu.be/CokvTbtWdwc}

\end{tcolorbox}

\hypertarget{sec-combiner-variables}{%
\chapter{Combiner plusieurs variables}\label{sec-combiner-variables}}

Parfois, on a besoin de créer une nouvelle variable en partant des
valeurs d'une ou plusieurs autres variables. Dans ce cas on peut
utiliser les fonctions \texttt{dplyr::if\_else()} pour les cas les plus
simples, ou \texttt{dplyr::case\_when()} pour les cas plus complexes.

Une fois encore, nous utiliser le jeu de données \texttt{hdv2003} pour
illustrer ces différentes fonctions.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{data}\NormalTok{(}\StringTok{"hdv2003"}\NormalTok{, }\AttributeTok{package =} \StringTok{"questionr"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{if_else}{%
\section{if\_else()}\label{if_else}}

\texttt{dplyr::if\_else()} prend trois arguments~: un test, les valeurs
à renvoyer si le test est vrai, et les valeurs à renvoyer si le test est
faux.

Voici un exemple simple~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{12}\NormalTok{, }\DecValTok{14}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{16}\NormalTok{)}
\FunctionTok{if\_else}\NormalTok{(v }\SpecialCharTok{\textgreater{}} \DecValTok{10}\NormalTok{, }\StringTok{"Supérieur à 10"}\NormalTok{, }\StringTok{"Inférieur à 10"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Supérieur à 10" "Supérieur à 10" "Inférieur à 10" "Supérieur à 10"
\end{verbatim}

La fonction devient plus intéressante avec des tests combinant plusieurs
variables. Par exemple, imaginons qu'on souhaite créer une nouvelle
variable indiquant les hommes de plus de 60 ans~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\OtherTok{\textless{}{-}} 
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{statut =} \FunctionTok{if\_else}\NormalTok{(}
\NormalTok{      sexe }\SpecialCharTok{==} \StringTok{"Homme"} \SpecialCharTok{\&}\NormalTok{ age }\SpecialCharTok{\textgreater{}} \DecValTok{60}\NormalTok{,}
      \StringTok{"Homme de plus de 60 ans"}\NormalTok{,}
      \StringTok{"Autre"}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{pull}\NormalTok{(statut) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                           n    % val%
Autre                   1778 88.9 88.9
Homme de plus de 60 ans  222 11.1 11.1
\end{verbatim}

Il est possible d'utiliser des variables ou des combinaisons de
variables au sein du \texttt{dplyr::if\_else()}. Suppons une petite
enquête menée auprès de femmes et d'hommes. Le questionnaire comportait
une question de préférence posée différemment aux femmes et aux hommes
et dont les réponses ont ainsi été collectées dans deux variables
différentes, \emph{pref\_f} et \emph{pref\_h}, que l'on souhaite
combiner en une seule variable. De même, une certaine mesure
quantitative a été réalisée, mais une correction est nécessaire pour
normaliser ce score (retirer 0.4 aux scores des hommes et 0.6 aux scores
des femmes). Cela peut être réalisé avec le code ci-dessous.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(}
  \AttributeTok{sexe =} \FunctionTok{c}\NormalTok{(}\StringTok{"f"}\NormalTok{, }\StringTok{"f"}\NormalTok{, }\StringTok{"h"}\NormalTok{, }\StringTok{"h"}\NormalTok{),}
  \AttributeTok{pref\_f =} \FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{),}
  \AttributeTok{pref\_h =} \FunctionTok{c}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\StringTok{"c"}\NormalTok{, }\StringTok{"d"}\NormalTok{),}
  \AttributeTok{mesure =} \FunctionTok{c}\NormalTok{(}\FloatTok{1.2}\NormalTok{, }\FloatTok{4.1}\NormalTok{, }\FloatTok{3.8}\NormalTok{, }\FloatTok{2.7}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 4 x 4
  sexe  pref_f pref_h mesure
  <chr> <chr>  <chr>   <dbl>
1 f     a      <NA>      1.2
2 f     b      <NA>      4.1
3 h     <NA>   c         3.8
4 h     <NA>   d         2.7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} 
\NormalTok{  df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{pref =} \FunctionTok{if\_else}\NormalTok{(sexe }\SpecialCharTok{==} \StringTok{"f"}\NormalTok{, pref\_f, pref\_h),}
    \AttributeTok{indicateur =} \FunctionTok{if\_else}\NormalTok{(sexe }\SpecialCharTok{==} \StringTok{"h"}\NormalTok{, mesure }\SpecialCharTok{{-}} \FloatTok{0.4}\NormalTok{, mesure }\SpecialCharTok{{-}} \FloatTok{0.6}\NormalTok{)}
\NormalTok{  )}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 4 x 6
  sexe  pref_f pref_h mesure pref  indicateur
  <chr> <chr>  <chr>   <dbl> <chr>      <dbl>
1 f     a      <NA>      1.2 a            0.6
2 f     b      <NA>      4.1 b            3.5
3 h     <NA>   c         3.8 c            3.4
4 h     <NA>   d         2.7 d            2.3
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{if\_else() et ifelse()}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

La fonction \texttt{dplyr::if\_else()} ressemble à la fonction
\texttt{ifelse()} en base \textbf{R}. Il y a néanmoins quelques petites
différences~:

\begin{itemize}
\tightlist
\item
  \texttt{dplyr::if\_else()} vérifie que les valeurs fournies pour
  \texttt{true} et celles pour false sont du même type et de la même
  classe et renvoie une erreur dans le cas contraire, là où
  \texttt{ifelse()} sera plus permissif~;
\item
  si un vecteur a des attributs (cf.~Chapitre~\ref{sec-attributs}), ils
  seront préservés par \texttt{dplyr::if\_else()} (et pris dans le
  vecteur \texttt{true}), ce que ne fera pas \texttt{if\_else()}~;
\item
  \texttt{dplyr::if\_else()} propose un argument optionnel
  supplémentaire \texttt{missing} pour indiquer les valeurs à retourner
  lorsque le test renvoie \texttt{NA}.
\end{itemize}

\end{tcolorbox}

\hypertarget{case_when}{%
\section{case\_when()}\label{case_when}}

\texttt{dplyr::case\_when()} est une généralisation de
\texttt{dplyr::if\_else()} qui permet d'indiquer plusieurs tests et
leurs valeurs associées.

Imaginons que l'on souhaite créer une nouvelle variable permettant
d'identifier les hommes de plus de 60 ans, les femmes de plus de 60 ans,
et les autres. On peut utiliser la syntaxe suivante~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{statut =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{      age }\SpecialCharTok{\textgreater{}=} \DecValTok{60} \SpecialCharTok{\&}\NormalTok{ sexe }\SpecialCharTok{==} \StringTok{"Homme"} \SpecialCharTok{\textasciitilde{}} \StringTok{"Homme, 60 et plus"}\NormalTok{,}
\NormalTok{      age }\SpecialCharTok{\textgreater{}=} \DecValTok{60} \SpecialCharTok{\&}\NormalTok{ sexe }\SpecialCharTok{==} \StringTok{"Femme"} \SpecialCharTok{\textasciitilde{}} \StringTok{"Femme, 60 et plus"}\NormalTok{,}
      \ConstantTok{TRUE} \SpecialCharTok{\textasciitilde{}} \StringTok{"Autre"}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{pull}\NormalTok{(statut) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                     n    % val%
Autre             1484 74.2 74.2
Femme, 60 et plus  278 13.9 13.9
Homme, 60 et plus  238 11.9 11.9
\end{verbatim}

\texttt{dplyr::case\_when()} prend en arguments une série d'instructions
sous la forme \texttt{condition\ \textasciitilde{}\ valeur}. Il les
exécute une par une, et dès qu'une \texttt{condition} est vraie, il
renvoit la \texttt{valeur} associée.

La clause \texttt{TRUE\ \textasciitilde{}\ "Autre"} permet d'assigner
une valeur à toutes les lignes pour lesquelles aucune des conditions
précédentes n'est vraie.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Important}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

\textbf{Attention~:} comme les conditions sont testées l'une après
l'autre et que la valeur renvoyée est celle correspondant à la première
condition vraie, l'ordre de ces conditions est très important. Il faut
absolument aller du plus spécifique au plus général.

Par exemple le recodage suivant ne fonctionne pas~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{statut =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{      sexe }\SpecialCharTok{==} \StringTok{"Homme"} \SpecialCharTok{\textasciitilde{}} \StringTok{"Homme"}\NormalTok{,}
\NormalTok{      age }\SpecialCharTok{\textgreater{}=} \DecValTok{60} \SpecialCharTok{\&}\NormalTok{ sexe }\SpecialCharTok{==} \StringTok{"Homme"} \SpecialCharTok{\textasciitilde{}} \StringTok{"Homme, 60 et plus"}\NormalTok{,}
      \ConstantTok{TRUE} \SpecialCharTok{\textasciitilde{}} \StringTok{"Autre"}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{pull}\NormalTok{(statut) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         n  % val%
Autre 1101 55   55
Homme  899 45   45
\end{verbatim}

Comme la condition \texttt{sexe\ ==\ "Homme"} est plus générale que
\texttt{sexe\ ==\ "Homme"\ \&\ age\ \textgreater{}\ 60}, cette deuxième
condition n'est jamais testée~! On n'obtiendra jamais la valeur
correspondante.

Pour que ce recodage fonctionne il faut donc changer l'ordre des
conditions pour aller du plus spécifique au plus général~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{statut =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{      age }\SpecialCharTok{\textgreater{}=} \DecValTok{60} \SpecialCharTok{\&}\NormalTok{ sexe }\SpecialCharTok{==} \StringTok{"Homme"} \SpecialCharTok{\textasciitilde{}} \StringTok{"Homme, 60 et plus"}\NormalTok{,}
\NormalTok{      sexe }\SpecialCharTok{==} \StringTok{"Homme"} \SpecialCharTok{\textasciitilde{}} \StringTok{"Homme"}\NormalTok{,}
      \ConstantTok{TRUE} \SpecialCharTok{\textasciitilde{}} \StringTok{"Autre"}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{pull}\NormalTok{(statut) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                     n    % val%
Autre             1101 55.0 55.0
Homme              661 33.1 33.1
Homme, 60 et plus  238 11.9 11.9
\end{verbatim}

C'est pour cela que l'on peut utiliser, en toute dernière condition, la
valeur \texttt{TRUE} pour indiquer dans tous les autres cas.

\end{tcolorbox}

\hypertarget{recode_if}{%
\section{recode\_if()}\label{recode_if}}

Parfois, on n'a besoin de ne modifier une variable que pour certaines
observations. Prenons un petit exemple~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(}
  \AttributeTok{pref =} \FunctionTok{factor}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"bleu"}\NormalTok{, }\StringTok{"rouge"}\NormalTok{, }\StringTok{"autre"}\NormalTok{, }\StringTok{"rouge"}\NormalTok{, }\StringTok{"autre"}\NormalTok{)),}
  \AttributeTok{autre\_details =} \FunctionTok{c}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\StringTok{"bleu ciel"}\NormalTok{, }\ConstantTok{NA}\NormalTok{, }\StringTok{"jaune"}\NormalTok{)}
\NormalTok{)}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 2
  pref  autre_details
  <fct> <chr>        
1 bleu  <NA>         
2 rouge <NA>         
3 autre bleu ciel    
4 rouge <NA>         
5 autre jaune        
\end{verbatim}

Nous avons demandé aux enquêtés d'indiquer leur couleur préférée. Ils
pouvaient répondre bleu ou rouge et avait également la possibilité de
choisir autre et d'indiquer la valeur de leur choix dans un champs
textuel libre.

Une des personnes enquêtées a choisi autre et a indiqué dans le champs
texte la valeur bleu ciel. Pour les besoins de l'analyse, on peut
considérer que cette valeur bleu ciel pour être tout simplement recodée
en bleu.

En syntaxe \textbf{R} classique, on pourra simplement faire~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df}\SpecialCharTok{$}\NormalTok{pref[df}\SpecialCharTok{$}\NormalTok{autre\_details }\SpecialCharTok{==} \StringTok{"bleu ciel"}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"bleu"}
\end{Highlighting}
\end{Shaded}

Avec \texttt{dplyr::if\_else()}, on serait tenté d'écrire~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{pref =} \FunctionTok{if\_else}\NormalTok{(autre\_details }\SpecialCharTok{==} \StringTok{"bleu ciel"}\NormalTok{, }\StringTok{"bleu"}\NormalTok{, pref))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 2
  pref  autre_details
  <chr> <chr>        
1 <NA>  <NA>         
2 <NA>  <NA>         
3 bleu  bleu ciel    
4 <NA>  <NA>         
5 autre jaune        
\end{verbatim}

On obtient une erreur, car \texttt{dplyr::if\_else()} exige les valeurs
fournie pour \texttt{true} et \texttt{false} soient de même type.
Essayons alors~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{pref =} \FunctionTok{if\_else}\NormalTok{(autre\_details }\SpecialCharTok{==} \StringTok{"bleu ciel"}\NormalTok{, }\FunctionTok{factor}\NormalTok{(}\StringTok{"bleu"}\NormalTok{), pref))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 2
  pref  autre_details
  <fct> <chr>        
1 <NA>  <NA>         
2 <NA>  <NA>         
3 bleu  bleu ciel    
4 <NA>  <NA>         
5 autre jaune        
\end{verbatim}

Ici nous avons un autre problème, signalé par un message d'avertissement
(\emph{warning})~: \texttt{dplyr::if\_else()} ne préserve que les
attributs du vecteur passé en \texttt{true} et non ceux passés à
\texttt{false}. Or l'ensemble des modalités (niveaux du facteur) de la
variable \emph{pref} n'ont pas été définis dans \texttt{factor("bleu")}
et sont ainsi perdus, générant une perte de données (valeurs manquantes
\texttt{NA}).

Pour obtenir le bon résultat, il faudrait inverser la condition~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{pref =} \FunctionTok{if\_else}\NormalTok{(}
\NormalTok{    autre\_details }\SpecialCharTok{!=} \StringTok{"bleu ciel"}\NormalTok{, }
\NormalTok{    pref, }
    \FunctionTok{factor}\NormalTok{(}\StringTok{"bleu"}\NormalTok{)}
\NormalTok{  ))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 2
  pref  autre_details
  <fct> <chr>        
1 <NA>  <NA>         
2 <NA>  <NA>         
3 bleu  bleu ciel    
4 <NA>  <NA>         
5 autre jaune        
\end{verbatim}

Mais ce n'est toujours pas suffisant. En effet, la variable
\emph{autre\_details} a des valeurs manquantes pour lesquelles le test
\texttt{autre\_details\ !=\ "bleu\ ciel"} renvoie \texttt{NA} ce qui une
fois encore génère des valeurs manquantes non souhaitées. Dès lors, il
nous faut soit définir l'argument \texttt{missing} de
\texttt{dplyr::if\_else()}, soit être plus précis dans notre test.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{pref =} \FunctionTok{if\_else}\NormalTok{(}
\NormalTok{    autre\_details }\SpecialCharTok{!=} \StringTok{"bleu ciel"}\NormalTok{, }
\NormalTok{    pref, }
    \FunctionTok{factor}\NormalTok{(}\StringTok{"bleu"}\NormalTok{),}
    \AttributeTok{missing =}\NormalTok{ pref}
\NormalTok{  ))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 2
  pref  autre_details
  <fct> <chr>        
1 bleu  <NA>         
2 rouge <NA>         
3 bleu  bleu ciel    
4 rouge <NA>         
5 autre jaune        
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{pref =} \FunctionTok{if\_else}\NormalTok{(}
\NormalTok{    autre\_details }\SpecialCharTok{!=} \StringTok{"bleu ciel"} \SpecialCharTok{|} \FunctionTok{is.na}\NormalTok{(autre\_details), }
\NormalTok{    pref, }
    \FunctionTok{factor}\NormalTok{(}\StringTok{"bleu"}\NormalTok{)}
\NormalTok{  ))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 2
  pref  autre_details
  <fct> <chr>        
1 bleu  <NA>         
2 rouge <NA>         
3 bleu  bleu ciel    
4 rouge <NA>         
5 autre jaune        
\end{verbatim}

Bref, on peut s'en sortir avec \texttt{dplyr::if\_else()} mais ce n'est
pas forcément le plus pratique dans le cas présent. La syntaxe en base
\textbf{R} fonctionne très bien, mais ne peut pas être intégrée à un
enchainement d'opérations utilisant le \emph{pipe}.

Dans ce genre de situation, on pourra être intéressé par la fonction
\texttt{labelled::recode\_if()} disponible dans le package
\texttt{\{labelled\}}. Elle permet de ne modifier que certaines
observations d'un vecteur en fonction d'une condition. Si la condition
vaut \texttt{FALSE} ou \texttt{NA}, les observations concernées restent
inchangées. Voyons comment cela s'écrit~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}}
\NormalTok{  df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{pref =}\NormalTok{ pref }\SpecialCharTok{|\textgreater{}} 
\NormalTok{      labelled}\SpecialCharTok{::}\FunctionTok{recode\_if}\NormalTok{(autre\_details }\SpecialCharTok{==} \StringTok{"bleu ciel"}\NormalTok{, }\StringTok{"bleu"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 2
  pref  autre_details
  <fct> <chr>        
1 bleu  <NA>         
2 rouge <NA>         
3 bleu  bleu ciel    
4 rouge <NA>         
5 autre jaune        
\end{verbatim}

C'est tout de suite plus intuitif~!

\hypertarget{sec-etiquettes-variables}{%
\chapter{Étiquettes de variables}\label{sec-etiquettes-variables}}

\hypertarget{principe}{%
\section{Principe}\label{principe}}

Les étiquettes de variable permettent de donner un nom long, plus
explicite, aux différentes colonnes d'un tableau de données (ou encore
directement à un vecteur autonome). Dans le champs des grandes enquêtes,
il est fréquent de nommer les variables \emph{q101}, \emph{q102}, etc.
pour refléter le numéro de la question et d'indiquer ce qu'elle
réprésente (groupe d'âges, milieur de résidence\ldots) avec une
étiquette.

Un usage, introduit par le package \texttt{\{haven\}}, et repris depuis
par de nombreux autres packages dont \texttt{\{gtsummary\}} que nous
aborderons dans de prochains chapitres, consiste à stocker les
étiquettes de variables sous la forme d'un attribut\sidenote{\footnotesize Pour plus
  d'information sur les attributs, voir Chapitre~\ref{sec-attributs}.}
\texttt{"label"} attaché au vecteur / à la colonne du tableau.

Le package \texttt{\{labelled\}} permet de manipuler aisément ces
étiquettes de variables.

La visonneuse de données de \textbf{RStudio} sait reconnaître et
afficher ces étiquettes de variable lorsqu'elles existent. Prenons pour
exemple le jeu de données \texttt{gtsummary::trial} dont les colonnes
ont des étiquettes de variable. La commande
\texttt{View(gtsummary::trial)} permet d'ouvrir la visionneuse de
données de \textbf{RStudio}. Comme on peut le constater, une étiquette
de variable est bien présente sous le nom des différentes colonnes.

\begin{figure}

{\centering \includegraphics{manipulation/ressources/view_trial.png}

}

\caption{\label{fig-view-trial}Présentation du tableau
\texttt{gtsummary::trial} dans la visionneuse de \textbf{RStudio}}

\end{figure}

La fonction \texttt{labelled::look\_for()} du package
\texttt{\{labelled\}} permet de lister l'ensemble des variables d'un
tableau de données et affiche notamment les étiquettes de variable
associées.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(labelled)}
\NormalTok{gtsummary}\SpecialCharTok{::}\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label                  col_type missing values
 1   trt      Chemotherapy Treatment chr      0             
 2   age      Age                    dbl      11            
 3   marker   Marker Level (ng/mL)   dbl      10            
 4   stage    T Stage                fct      0       T1    
                                                      T2    
                                                      T3    
                                                      T4    
 5   grade    Grade                  fct      0       I     
                                                      II    
                                                      III   
 6   response Tumor Response         int      7             
 7   death    Patient Died           int      0             
 8   ttdeath  Months to Death/Censor dbl      0             
\end{verbatim}

La fonction \texttt{labelled::look\_for()} permet également de
rechercher des variables en tenant compte à la fois de leur nom et de
leur étiquette.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gtsummary}\SpecialCharTok{::}\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{(}\StringTok{"months"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label                  col_type missing values
 8   ttdeath  Months to Death/Censor dbl      0             
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Comme on le voit, la fonction \texttt{labelled::look\_for()} est tout à
fait adaptée pour générer un dictionnaire de codification. Ses
différentes options sont détaillées dans une
\href{https://larmarange.github.io/labelled/articles/look_for.html}{vignette
dédiée}. Les résultats renvoyés par \texttt{labelled::look\_for()} sont
récupérables dans un tableau de données que l'on pourra ainsi manipuler
à sa guise.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gtsummary}\SpecialCharTok{::}\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 8 x 7
    pos variable label                  col_type missing levels     value_labels
  <int> <chr>    <chr>                  <chr>      <int> <named li> <named list>
1     1 trt      Chemotherapy Treatment chr            0 <NULL>     <NULL>      
2     2 age      Age                    dbl           11 <NULL>     <NULL>      
3     3 marker   Marker Level (ng/mL)   dbl           10 <NULL>     <NULL>      
4     4 stage    T Stage                fct            0 <chr [4]>  <NULL>      
5     5 grade    Grade                  fct            0 <chr [3]>  <NULL>      
6     6 response Tumor Response         int            7 <NULL>     <NULL>      
7     7 death    Patient Died           int            0 <NULL>     <NULL>      
8     8 ttdeath  Months to Death/Censor dbl            0 <NULL>     <NULL>      
\end{verbatim}

\end{tcolorbox}

\hypertarget{manipulation-sur-un-vecteur-une-colonne}{%
\section{Manipulation sur un vecteur / une
colonne}\label{manipulation-sur-un-vecteur-une-colonne}}

La fonction \texttt{labelled::var\_label()} permets de voir l'étiquette
de variable attachée à un vecteur (renvoie \texttt{NULL} s'il n'y en a
pas) mais également d'ajouter/modifier une étiquette.

Le fait d'ajouter une étiquette de variable à un vecteur ne modifie en
rien son type ni sa classe. On peut associer une étiquette de variable à
n'importe quel type de variable, qu'elle soit numérique, textuelle, un
facteur ou encore des dates.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{v }\SpecialCharTok{|\textgreater{}} \FunctionTok{var\_label}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{var\_label}\NormalTok{(v) }\OtherTok{\textless{}{-}} \StringTok{"Mon étiquette"}
\FunctionTok{var\_label}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Mon étiquette"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 num [1:5] 1 5 2 4 1
 - attr(*, "label")= chr "Mon étiquette"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{var\_label}\NormalTok{(v) }\OtherTok{\textless{}{-}} \StringTok{"Une autre étiquette"}
\FunctionTok{var\_label}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Une autre étiquette"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 num [1:5] 1 5 2 4 1
 - attr(*, "label")= chr "Une autre étiquette"
\end{verbatim}

Pour supprimer une étiquette, il suffit d'attribuer la valeur
\texttt{NULL}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{var\_label}\NormalTok{(v) }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\FunctionTok{str}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 num [1:5] 1 5 2 4 1
\end{verbatim}

On peut appliquer \texttt{labelled::var\_label()} directement sur une
colonne de tableau.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{var\_label}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Petal.Length) }\OtherTok{\textless{}{-}} \StringTok{"Longueur du pétale"}
\FunctionTok{var\_label}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Petal.Width) }\OtherTok{\textless{}{-}} \StringTok{"Largeur du pétale"}
\FunctionTok{var\_label}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Species) }\OtherTok{\textless{}{-}} \StringTok{"Espèce"}
\NormalTok{iris }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable     label              col_type missing values    
 1   Sepal.Length —                  dbl      0                 
 2   Sepal.Width  —                  dbl      0                 
 3   Petal.Length Longueur du pétale dbl      0                 
 4   Petal.Width  Largeur du pétale  dbl      0                 
 5   Species      Espèce             fct      0       setosa    
                                                      versicolor
                                                      virginica 
\end{verbatim}

\hypertarget{manipulation-sur-un-tableau-de-donnuxe9es}{%
\section{Manipulation sur un tableau de
données}\label{manipulation-sur-un-tableau-de-donnuxe9es}}

La fonction \texttt{labelled::set\_variable\_labels()} permets de
manipuler les étiquettes de variable d'un tableau de données avec une
syntaxe du type \texttt{\{dplyr\}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\OtherTok{\textless{}{-}} 
\NormalTok{  iris }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{set\_variable\_labels}\NormalTok{(}
    \AttributeTok{Species =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{Sepal.Length =} \StringTok{"Longeur du sépale"}
\NormalTok{  )}
\NormalTok{iris }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable     label              col_type missing values    
 1   Sepal.Length Longeur du sépale  dbl      0                 
 2   Sepal.Width  —                  dbl      0                 
 3   Petal.Length Longueur du pétale dbl      0                 
 4   Petal.Width  Largeur du pétale  dbl      0                 
 5   Species      —                  fct      0       setosa    
                                                      versicolor
                                                      virginica 
\end{verbatim}

\hypertarget{pruxe9server-les-uxe9tiquettes}{%
\section{Préserver les
étiquettes}\label{pruxe9server-les-uxe9tiquettes}}

Certaines fonctions de \textbf{R} ne préservent pas les attributs et
risquent donc d'effacer les étiquettes de variables que l'on a définit.
Un exemple est la fonction générique \textbf{subset()} qui permet de
sélectionner certaines lignes remplissant une certaines conditions.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable     label              col_type missing values    
 1   Sepal.Length Longeur du sépale  dbl      0                 
 2   Sepal.Width  —                  dbl      0                 
 3   Petal.Length Longueur du pétale dbl      0                 
 4   Petal.Width  Largeur du pétale  dbl      0                 
 5   Species      —                  fct      0       setosa    
                                                      versicolor
                                                      virginica 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{subset}\NormalTok{(Species }\SpecialCharTok{==} \StringTok{"setosa"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable     label col_type missing values    
 1   Sepal.Length —     dbl      0                 
 2   Sepal.Width  —     dbl      0                 
 3   Petal.Length —     dbl      0                 
 4   Petal.Width  —     dbl      0                 
 5   Species      —     fct      0       setosa    
                                         versicolor
                                         virginica 
\end{verbatim}

On pourra, dans ce cas précis, préférer la fonction
\texttt{dplyr::filter()} qui préserve les attributs et donc les
étiquettes de variables.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(Species }\SpecialCharTok{==} \StringTok{"setosa"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable     label              col_type missing values    
 1   Sepal.Length Longeur du sépale  dbl      0                 
 2   Sepal.Width  —                  dbl      0                 
 3   Petal.Length Longueur du pétale dbl      0                 
 4   Petal.Width  Largeur du pétale  dbl      0                 
 5   Species      —                  fct      0       setosa    
                                                      versicolor
                                                      virginica 
\end{verbatim}

On pourra également tirer parti de la fonction
\texttt{labelled::copy\_labels\_from()} qui permet de copier les
étiquettes d'un tabeau à un autre.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{subset}\NormalTok{(Species }\SpecialCharTok{==} \StringTok{"setosa"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{copy\_labels\_from}\NormalTok{(iris) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable     label              col_type missing values    
 1   Sepal.Length Longeur du sépale  dbl      0                 
 2   Sepal.Width  —                  dbl      0                 
 3   Petal.Length Longueur du pétale dbl      0                 
 4   Petal.Width  Largeur du pétale  dbl      0                 
 5   Species      —                  fct      0       setosa    
                                                      versicolor
                                                      virginica 
\end{verbatim}

\hypertarget{sec-etiquettes-valeurs}{%
\chapter{Étiquettes de valeurs}\label{sec-etiquettes-valeurs}}

Dans le domaine des grandes enquêtes, il est fréquent de coder les
variables catégorielles avec des codes numériques auxquels on associé
une certaines valeurs. Par exemple, une variable \emph{milieu de
résidence} pourrait être codée 1 pour urbain, 2 pour semi-urbain, 3 pour
rural et 9 pour indiquer une donnée manquante. Une variable binaire
pourrait quant à elle être codée 0 pour non et 1 pour oui. Souvent,
chaque enquête définit ses propres conventions.

Les logiciels statistiques propriétaires \textbf{SPSS}, \textbf{Stata}
et \textbf{SAS} ont tous les trois un système d'étiquettes de valeurs
pour représenter ce type de variables catégorielles.

\textbf{R} n'a pas, de manière native, de système d'étiquettes de
valeurs. Le format utilisé en interne pour représenter les variables
catégorielles est celui des facteurs (cf.~Chapitre~\ref{sec-facteurs}).
Cependant, ce dernier ne permet de contrôler comment sont associées une
étiquette avec une valeur numérique précise.

\hypertarget{la-classe-haven_labelled}{%
\section{\texorpdfstring{La classe
\texttt{haven\_labelled}}{La classe haven\_labelled}}\label{la-classe-haven_labelled}}

Afin d'assurer une importation complète des données depuis
\textbf{SPSS}, \textbf{Stata} et \textbf{SAS}, le package
\texttt{\{haven\}} a introduit un nouveau type de vecteurs, la classe
\texttt{haven\_labelled}, qui permet justement de rendre compte de ces
vecteurs labellisés (i.e.~avec des étiquettes de valeurs). Le package
\texttt{\{labelled\}} fournie un jeu de fonctions pour faciliter la
manipulation des vecteurs labellisés.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Important}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

Les vecteurs labellisés sont un format intermédiaire qui permets
d'importer les données telles qu'elles ont été définies dans le fichier
source. Il n'est pas destiné à être utilisé pour l'analyse statistique.

Pour la réalisation de tableaux, graphiques, modèles, \textbf{R} attend
que les variables catégorielles soit codées sous formes de facteurs, et
que les variables continues soient numériques. On aura donc besoin, à un
moment ou à un autre, de convertir les vecteurs labellisés en facteurs
ou en variables numériques classiques.

\end{tcolorbox}

\hypertarget{manipulation-sur-un-vecteur-une-colonne-1}{%
\section{Manipulation sur un vecteur / une
colonne}\label{manipulation-sur-un-vecteur-une-colonne-1}}

Pour définir des étiquettes, la fonction de base est
\texttt{labelled::val\_labels()}. Il est possible de définir des
étiquettes de valeurs pour des vecteurs numériques, d'entiers et
textuels. On indiquera les étiquettes sous la forme
\texttt{étiquette\ =\ valeur}. Cette fonction s'utilise de la même
manière que \texttt{labelled::var\_label()} abordée au chapitre
précédent (cf.~Chapitre~\ref{sec-etiquettes-variables}). Un appel simple
renvoie les étiquettes de valeur associées au vecteur, \texttt{NULL}
s'il n'y en n'a pas. Combiner avec l'opérateur d'assignation
(\texttt{\textless{}-}), on peut ajouter/modifier les étiquettes de
valeurs associées au vecteur.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(labelled)}
\NormalTok{v }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{9}\NormalTok{)}
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1 2 1 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "numeric"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{val\_labels}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{val\_labels}\NormalTok{(v) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{non =} \DecValTok{1}\NormalTok{, }\AttributeTok{oui =} \DecValTok{2}\NormalTok{)}
\FunctionTok{val\_labels}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
non oui 
  1   2 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled<double>[4]>
[1] 1 2 1 9

Labels:
 value label
     1   non
     2   oui
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "haven_labelled" "vctrs_vctr"     "double"        
\end{verbatim}

Comme on peut le voir avec cet exemple simple :

\begin{itemize}
\tightlist
\item
  l'ajout d'étiquettes de valeurs modifie la class de l'objet (qui est
  maintenant un vecteur de la classe \texttt{haven\_labelled})~;
\item
  l'objet obtenu est multi-classes, la classe \texttt{double} indiquant
  ici qu'il s'agit d'un vecteur numérique~;
\item
  il n'est pas obligatoire d'associer une étiquette de valeurs à toutes
  les valeurs observées dans le vecteur (ici, nous n'avons pas défini
  d'étiquettes pour la valeur \texttt{9}).
\end{itemize}

La fonction \texttt{labelled::val\_label()} (notez l'absence d'un s à la
fin du nom de la fonction) permet d'accéder / de modifier l'étiquette
associée à une valeur spécifique.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{val\_label}\NormalTok{(v, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "non"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{val\_label}\NormalTok{(v, }\DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{val\_label}\NormalTok{(v, }\DecValTok{9}\NormalTok{) }\OtherTok{\textless{}{-}} \StringTok{"(manquant)"}
\FunctionTok{val\_label}\NormalTok{(v, }\DecValTok{2}\NormalTok{) }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled<double>[4]>
[1] 1 2 1 9

Labels:
 value      label
     1        non
     9 (manquant)
\end{verbatim}

Pour supprimer, toutes les étiquettes de valeurs, on attribuera
\texttt{NULL} avec \texttt{labelled::val\_labels()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{val\_labels}\NormalTok{(v) }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1 2 1 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "numeric"
\end{verbatim}

On remarquera que, lorsque toutes les étiquettes de valeurs sont
supprimées, la nature de l'objet change à nouveau et il redevient un
simple vecteur numérique.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-caution-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-caution-color}{\faFire}\hspace{0.5em}{Mise en garde}, bottomrule=.15mm, colframe=quarto-callout-caution-color-frame]

Il est essentiel de bien comprendre que l'ajout d'étiquettes de valeurs
ne change pas fondamentalement la nature du vecteur. \textbf{Cela ne le
transforme pas en variable catégorielle.} À ce stade, le vecteur n'a pas
été transformé en facteur. Cela reste un vecteur numérique qui est
considéré comme tel par \textbf{R}. On peut ainsi en calculer une
moyenne, ce qui serait impossible avec un facteur.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\FunctionTok{val\_labels}\NormalTok{(v) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{non =} \DecValTok{1}\NormalTok{, }\AttributeTok{oui =} \DecValTok{2}\NormalTok{)}
\FunctionTok{mean}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{f }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(v, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"non"}\NormalTok{, }\StringTok{"oui"}\NormalTok{))}
\FunctionTok{mean}\NormalTok{(f)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Warning in mean.default(f): l'argument n'est ni numérique, ni logique : renvoi
de NA
\end{verbatim}

\begin{verbatim}
[1] NA
\end{verbatim}

\end{tcolorbox}

Les fonctions \texttt{labelled::val\_labels()} et
\texttt{labelled::val\_label()} peuvent également être utilisées sur les
colonnes d'un tableau.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{tibble}\NormalTok{(}
  \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{)}
\FunctionTok{val\_labels}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{x) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{non =} \DecValTok{1}\NormalTok{, }\AttributeTok{oui =} \DecValTok{2}\NormalTok{)}
\FunctionTok{val\_label}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{y, }\DecValTok{9}\NormalTok{) }\OtherTok{\textless{}{-}} \StringTok{"(manquant)"}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 4 x 2
  x         y             
  <dbl+lbl> <dbl+lbl>     
1 1 [non]   3             
2 2 [oui]   9 [(manquant)]
3 1 [non]   9 [(manquant)]
4 2 [oui]   3             
\end{verbatim}

On pourra noter, que si notre tableau est un \emph{tibble}, les
étiquettes sont rendues dans la console quand on affiche le tableau.

La fonction \texttt{labelled::look\_for()} est également un bon moyen
d'afficher les étiquettes de valeurs.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values        
 1   x        —     dbl+lbl  0       [1] non       
                                     [2] oui       
 2   y        —     dbl+lbl  0       [9] (manquant)
\end{verbatim}

\hypertarget{manipulation-sur-un-tableau-de-donnuxe9es-1}{%
\section{Manipulation sur un tableau de
données}\label{manipulation-sur-un-tableau-de-donnuxe9es-1}}

\{labelled\} fournie 3 fonctions directement applicables sur un tableau
de données~: \texttt{labelled::set\_value\_labels()},
\texttt{labelled::add\_value\_labels()} et
\texttt{labelled::remove\_value\_labels()}. La première remplace
l'ensemble des étiquettes de valeurs associées à une variable, la
seconde ajoute des étiquettes de valeurs (et conserve celles déjà
définies), la troisième supprime les étiquettes associées à certaines
valeurs spécifiques (et laisse les autres inchangées).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values        
 1   x        —     dbl+lbl  0       [1] non       
                                     [2] oui       
 2   y        —     dbl+lbl  0       [9] (manquant)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{set\_value\_labels}\NormalTok{(}
    \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\AttributeTok{yes =} \DecValTok{2}\NormalTok{),}
    \AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\StringTok{"a répondu"} \OtherTok{=} \DecValTok{3}\NormalTok{, }\StringTok{"refus de répondre"} \OtherTok{=} \DecValTok{9}\NormalTok{)}
\NormalTok{  )}
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values               
 1   x        —     dbl+lbl  0       [2] yes              
 2   y        —     dbl+lbl  0       [3] a répondu        
                                     [9] refus de répondre
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_value\_labels}\NormalTok{(}
    \AttributeTok{x =} \FunctionTok{c}\NormalTok{(}\AttributeTok{no =} \DecValTok{1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{remove\_value\_labels}\NormalTok{(}
    \AttributeTok{y =} \DecValTok{9}
\NormalTok{  )}
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values       
 1   x        —     dbl+lbl  0       [2] yes      
                                     [1] no       
 2   y        —     dbl+lbl  0       [3] a répondu
\end{verbatim}

\hypertarget{conversion}{%
\section{Conversion}\label{conversion}}

\hypertarget{quand-convertir-les-vecteurs-labellisuxe9s}{%
\subsection{Quand convertir les vecteurs labellisés
?}\label{quand-convertir-les-vecteurs-labellisuxe9s}}

La classe \texttt{haven\_labelled} permets d'ajouter des métadonnées aux
variables sous la forme d'étiquettes de valeurs. Lorsque les données
sont importées depuis \textbf{SAS}, \textbf{SPSS} ou \textbf{Stata},
cela permet notamment de conserver le codage original du fichier
importé.

Mais il faut noter que ces \emph{étiquettes de valeur} n'indique pas
pour autant de manière systématique le type de variable (catégorielle ou
continue). Les vecteurs labellisés n'ont donc pas vocation à être
utilisés pour l'analyse, notamment le calcul de modèles statistiques.
Ils doivent être convertis en facteurs (pour les variables
catégorielles) ou en vecteurs numériques (pour les variables continues).

La question qui peut se poser est donc de choisir à quel moment cette
conversion doit avoir lieu dans un processus d'analyse. On peut
considérer deux approches principales.

\begin{figure}

{\centering \includegraphics{manipulation/ressources/conversion_labelled.png}

}

\caption{\label{fig-conversion-labelled}Deux approches possibles pour la
conversion des étiquettes de valeurs}

\end{figure}

Dans l'\textbf{approche A}, les vecteurs labellisés sont convertis juste
après l'import des données, en utilisant les fonctions
\texttt{labelled::unlabelled()}, \texttt{labelled::to\_factor()} ou
\texttt{base::unclass()} qui sont présentées ci-après. Dès lors, toute
la partie de nettoyage et de recodage des données se fera en utilisant
les fonctions classiques de \textbf{R}. Si l'on n'a pas besoin de
conserver le codage original, cette approche a l'avantage de s'inscrire
dans le fonctionnement usuel de \textbf{R}.

Dans l'\textbf{approche B}, les vecteurs labellisés sont conservés pour
l'étape de nettoyage et de recodage des données. Dans ce cas là, on
pourra avoir recours aux fonctions de l'extension \texttt{\{labelled\}}
qui facilitent la gestion des données labellisées. Cette approche est
particulièrement intéressante quand (i) on veut pouvoir se référer au
dictionnaire de codification fourni avec les données sources et donc on
veut conserver le codage original et/ou (ii) quand les données devront
faire l'objet d'un réexport après transformation. Par contre, comme dans
l'approche A, il faudra prévoir une conversion des variables labellisées
au moment de l'analyse.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-warning-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-warning-color}{\faExclamationTriangle}\hspace{0.5em}{Avertissement}, bottomrule=.15mm, colframe=quarto-callout-warning-color-frame]

Dans tous les cas, il est recommandé d'adopter l'une ou l'autre
approche, mais d'éviter de mélanger les différents types de vecteur. Une
organisation rigoureuse de ses données et de son code est essentielle~!

\end{tcolorbox}

\hypertarget{convertir-un-vecteur-labellisuxe9-en-facteur}{%
\subsection{Convertir un vecteur labellisé en
facteur}\label{convertir-un-vecteur-labellisuxe9-en-facteur}}

Il est très facile de convertir un vecteur labellisé en facteur à l'aide
la fonction \texttt{labelled::to\_factor()} du package
\texttt{\{labelled\}}\sidenote{\footnotesize On priviligiera la fonction
  \texttt{labelled::to\_factor()} à la fonction
  \texttt{haven::as\_factor()} de l'extension \texttt{\{haven\}}, la
  première ayant plus de possibilités et un comportement plus
  consistent.}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{9}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\ConstantTok{NA}\NormalTok{)}
\FunctionTok{val\_labels}\NormalTok{(v) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{oui =} \DecValTok{1}\NormalTok{, }\StringTok{"peut{-}être"} \OtherTok{=} \DecValTok{2}\NormalTok{, }
  \AttributeTok{non =} \DecValTok{3}\NormalTok{, }\StringTok{"ne sait pas"} \OtherTok{=} \DecValTok{9}
\NormalTok{)}
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled<double>[7]>
[1]  1  2  9  3  3  2 NA

Labels:
 value       label
     1         oui
     2   peut-être
     3         non
     9 ne sait pas
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{to\_factor}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] oui         peut-être   ne sait pas non         non         peut-être  
[7] <NA>       
Levels: oui peut-être non ne sait pas
\end{verbatim}

Il possible d'indiquer si l'on souhaite, comme étiquettes du facteur,
utiliser les étiquettes de valeur (par défaut), les valeurs elles-mêmes,
ou bien les étiquettes de valeurs préfixées par la valeur d'origine
indiquée entre crochets.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{to\_factor}\NormalTok{(v, }\StringTok{\textquotesingle{}l\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] oui         peut-être   ne sait pas non         non         peut-être  
[7] <NA>       
Levels: oui peut-être non ne sait pas
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{to\_factor}\NormalTok{(v, }\StringTok{\textquotesingle{}v\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1    2    9    3    3    2    <NA>
Levels: 1 2 3 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{to\_factor}\NormalTok{(v, }\StringTok{\textquotesingle{}p\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] [1] oui         [2] peut-être   [9] ne sait pas [3] non        
[5] [3] non         [2] peut-être   <NA>           
Levels: [1] oui [2] peut-être [3] non [9] ne sait pas
\end{verbatim}

Par défaut, les modalités du facteur seront triées selon l'ordre des
étiquettes de valeur. Mais cela peut être modifié avec l'argument
\texttt{sort\_levels} si l'on préfère trier selon les valeurs ou selon
l'ordre alphabétique des étiquettes.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{to\_factor}\NormalTok{(v, }\AttributeTok{sort\_levels =} \StringTok{\textquotesingle{}v\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] oui         peut-être   ne sait pas non         non         peut-être  
[7] <NA>       
Levels: oui peut-être non ne sait pas
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{to\_factor}\NormalTok{(v, }\AttributeTok{sort\_levels =} \StringTok{\textquotesingle{}l\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] oui         peut-être   ne sait pas non         non         peut-être  
[7] <NA>       
Levels: ne sait pas non oui peut-être
\end{verbatim}

\hypertarget{convertir-un-vecteur-labellisuxe9-en-numuxe9rique-ou-en-texte}{%
\subsection{Convertir un vecteur labellisé en numérique ou en
texte}\label{convertir-un-vecteur-labellisuxe9-en-numuxe9rique-ou-en-texte}}

Pour rappel, il existe deux types de vecteurs labellisés : des vecteurs
numériques labellisés (\texttt{x} dans l'exemple ci-dessous) et des
vecteurs textuels labellisés (\texttt{y} dans l'exemple ci-dessous).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\ConstantTok{NA}\NormalTok{)}
\FunctionTok{val\_labels}\NormalTok{(x) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{oui =} \DecValTok{1}\NormalTok{, }\StringTok{"peut{-}être"} \OtherTok{=} \DecValTok{2}\NormalTok{, }
  \AttributeTok{non =} \DecValTok{3}\NormalTok{, }\StringTok{"ne sait pas"} \OtherTok{=} \DecValTok{9}
\NormalTok{)}
  
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"f"}\NormalTok{, }\StringTok{"f"}\NormalTok{, }\StringTok{"h"}\NormalTok{, }\StringTok{"f"}\NormalTok{)}
\FunctionTok{val\_labels}\NormalTok{(y) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{femme =} \StringTok{"f"}\NormalTok{, }\AttributeTok{homme =} \StringTok{"h"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Pour leur retirer leur caractère labellisé et revenir à leur classe
d'origine, on peut utiliser la fonction \texttt{unclass()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unclass}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]  1  2  9  3  3  2 NA
attr(,"labels")
        oui   peut-être         non ne sait pas 
          1           2           3           9 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unclass}\NormalTok{(y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "f" "f" "h" "f"
attr(,"labels")
femme homme 
  "f"   "h" 
\end{verbatim}

À noter que dans ce cas-là, les étiquettes sont conservées comme
attributs du vecteur.

Une alternative est d'utiliser \texttt{labelled::remove\_labels()} qui
supprimera toutes les étiquettes, y compris les étiquettes de variable.
Pour conserver les étiquettes de variables et ne supprimer que les
étiquettes de valeurs, on indiquera \texttt{keep\_var\_label\ =\ TRUE}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{var\_label}\NormalTok{(x) }\OtherTok{\textless{}{-}} \StringTok{"Etiquette de variable"}
\FunctionTok{remove\_labels}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]  1  2  9  3  3  2 NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{remove\_labels}\NormalTok{(x, }\AttributeTok{keep\_var\_label =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]  1  2  9  3  3  2 NA
attr(,"label")
[1] "Etiquette de variable"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{remove\_labels}\NormalTok{(y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "f" "f" "h" "f"
\end{verbatim}

Dans le cas d'un vecteur numérique labellisé que l'on souhaiterait
convertir en variable textuelle, on pourra utiliser
\texttt{labelled::to\_character()} à la place de
\texttt{labelled::to\_factor()} qui, comme sa grande soeur, utilisera
les étiquettes de valeurs.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{to\_character}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "oui"         "peut-être"   "ne sait pas" "non"         "non"        
[6] "peut-être"   NA           
attr(,"label")
[1] "Etiquette de variable"
\end{verbatim}

\hypertarget{conversion-conditionnelle-en-facteurs}{%
\subsection{Conversion conditionnelle en
facteurs}\label{conversion-conditionnelle-en-facteurs}}

Il n'est pas toujours possible de déterminer la nature d'une variable
(continue ou catégorielle) juste à partir de la présence ou l'absence
d'étiquettes de valeur. En effet, on peut utiliser des étiquettes de
valeur dans le cadre d'une variable continue pour indiquer certaines
valeurs spécifiques.

Une bonne pratique est de vérifier chaque variable inclue dans une
analyse, une à une.

Cependant, une règle qui fonctionne dans 90\% des cas est de convertir
un vecteur labellisé en facteur si et seulement si toutes les valeurs
observées dans le vecteur disposent d'une étiquette de valeur
correspondante. C'est ce que propose la fonction
\texttt{labelled::unlabelled()} qui peut même être appliqué à tout un
tableau de données. Par défaut, elle fonctionne ainsi :

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  les variables non labellisées restent inchangées (variables \emph{f}
  et \emph{g} dans l'exemple ci-dessous);
\item
  si toutes les valeurs observées d'une variable labellisées ont une
  étiquette, elles sont converties en facteurs (variables \emph{b} et
  \emph{c});
\item
  sinon, on leur applique \texttt{base::unclass()} (variables \emph{a},
  \emph{d} et \emph{e}).
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{tibble}\NormalTok{(}
  \AttributeTok{a =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{),}
  \AttributeTok{b =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{),}
  \AttributeTok{c =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{d =} \FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"c"}\NormalTok{),}
  \AttributeTok{e =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{f =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{,}
  \AttributeTok{g =} \FunctionTok{as.Date}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \StringTok{"2020{-}01{-}01"}\NormalTok{, }\StringTok{"2020{-}02{-}01"}\NormalTok{, }
    \StringTok{"2020{-}03{-}01"}\NormalTok{, }\StringTok{"2020{-}04{-}01"}
\NormalTok{  ))}
\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{set\_value\_labels}\NormalTok{(}
    \AttributeTok{a =} \FunctionTok{c}\NormalTok{(}\AttributeTok{No =} \DecValTok{1}\NormalTok{, }\AttributeTok{Yes =} \DecValTok{2}\NormalTok{),}
    \AttributeTok{b =} \FunctionTok{c}\NormalTok{(}\AttributeTok{No =} \DecValTok{1}\NormalTok{, }\AttributeTok{Yes =} \DecValTok{2}\NormalTok{, }\AttributeTok{DK =} \DecValTok{3}\NormalTok{),}
    \AttributeTok{c =} \FunctionTok{c}\NormalTok{(}\AttributeTok{No =} \DecValTok{1}\NormalTok{, }\AttributeTok{Yes =} \DecValTok{2}\NormalTok{, }\AttributeTok{DK =} \DecValTok{3}\NormalTok{),}
    \AttributeTok{d =} \FunctionTok{c}\NormalTok{(}\AttributeTok{No =} \StringTok{"a"}\NormalTok{, }\AttributeTok{Yes =} \StringTok{"b"}\NormalTok{),}
    \AttributeTok{e =} \FunctionTok{c}\NormalTok{(}\AttributeTok{No =} \DecValTok{1}\NormalTok{, }\AttributeTok{Yes =} \DecValTok{2}\NormalTok{)}
\NormalTok{  )}
\NormalTok{df }\SpecialCharTok{|\textgreater{}} \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values 
 1   a        —     dbl+lbl  0       [1] No 
                                     [2] Yes
 2   b        —     dbl+lbl  0       [1] No 
                                     [2] Yes
                                     [3] DK 
 3   c        —     dbl+lbl  0       [1] No 
                                     [2] Yes
                                     [3] DK 
 4   d        —     chr+lbl  0       [a] No 
                                     [b] Yes
 5   e        —     dbl+lbl  0       [1] No 
                                     [2] Yes
 6   f        —     int      0              
 7   g        —     date     0              
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{to\_factor}\NormalTok{(df) }\SpecialCharTok{|\textgreater{}} \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values
 1   a        —     fct      0       No    
                                     Yes   
                                     3     
 2   b        —     fct      0       No    
                                     Yes   
                                     DK    
 3   c        —     fct      0       No    
                                     Yes   
                                     DK    
 4   d        —     fct      0       No    
                                     Yes   
                                     c     
 5   e        —     fct      0       No    
                                     Yes   
                                     9     
 6   f        —     int      0             
 7   g        —     date     0             
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlabelled}\NormalTok{(df) }\SpecialCharTok{|\textgreater{}} \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values
 1   a        —     dbl      0             
 2   b        —     fct      0       No    
                                     Yes   
                                     DK    
 3   c        —     fct      0       No    
                                     Yes   
                                     DK    
 4   d        —     chr      0             
 5   e        —     dbl      0             
 6   f        —     int      0             
 7   g        —     date     0             
\end{verbatim}

On peut indiquer certaines options, par exemple
\texttt{drop\_unused\_labels\ =\ TRUE} pour supprimer des facteurs créés
les niveaux non observées dans les données (voir la variable \emph{c}).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlabelled}\NormalTok{(df, }\AttributeTok{drop\_unused\_labels =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values
 1   a        —     dbl      0             
 2   b        —     fct      0       No    
                                     Yes   
                                     DK    
 3   c        —     fct      0       No    
                                     Yes   
 4   d        —     chr      0             
 5   e        —     dbl      0             
 6   f        —     int      0             
 7   g        —     date     0             
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{unlabelled}\NormalTok{(df, }\AttributeTok{levels =} \StringTok{"prefixed"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values 
 1   a        —     dbl      0              
 2   b        —     fct      0       [1] No 
                                     [2] Yes
                                     [3] DK 
 3   c        —     fct      0       [1] No 
                                     [2] Yes
                                     [3] DK 
 4   d        —     chr      0              
 5   e        —     dbl      0              
 6   f        —     int      0              
 7   g        —     date     0              
\end{verbatim}

\hypertarget{sec-valeurs-manquantes}{%
\chapter{Valeurs manquantes}\label{sec-valeurs-manquantes}}

Dans \textbf{R} base, les valeurs manquantes sont indiquées par la
valeurs logiques \texttt{NA} que l'on peut utiliser dans tous types de
vecteurs.

Dans certains cas, par exemple dans la fonction
\texttt{dplyr::if\_else()} qui vérifie que les deux options sont du même
type, on peut avoir besoin de spécifier une valeur manquante d'un
certains types précis (numérique, entier, textuel\ldots) ce que l'on
peut faire avec les constantes \texttt{NA\_real\_},
\texttt{NA\_integer\_} ou encore \texttt{NA\_character\_}.

De base, il n'existe qu'un seul type de valeurs manquantes dans
\textbf{R}. D'autres logiciels statistiques ont mis en place des
systèmes pour distinguer plusieurs types de valeurs manquantes, ce qui
peut avoir une importance dans le domaine des grandes enquêtes, par
exemple pour distinguer des ne sait pas d'un refus de répondre ou d'un
oubli enquêteur.

Ainsi, \textbf{Stata} et \textbf{SAS} ont un système de valeurs
manquantes étiquettées ou \emph{tagged NAs}, où les valeurs manquantes
peuvent recevoir une étiquette (une lettre entre a et z). De son côté,
\textbf{SPSS} permet d'indiquer, sous la forme de métadonnées, que
certaines valeurs devraient être traitées comme des valeurs manquantes
(par exemple que la valeur 8 correspont à des refus et que la valeur 9
correspond à des ne sait pas). Il s'agit alors de valeurs manquantes
définies par l'utilisateur ou \emph{user NAs.}

Dans tous les cas, il appartient à l'analyste de décider au cas par cas
comment ces valeurs manquantes doivent être traitées. Dans le cadre
d'une variable numérique, il est essentiel d'exclure ces valeurs
manquantes pour le calcul de statistiques telles que la moyenne ou
l'écart-type. Pour des variables catégorielles, les pourcentages peuvent
être calculées sur l'ensemble de l'échantillon (les valeurs manquantes
étant alors traitées comme des modalités à part entière) ou bien
uniquement sur les réponses valides, en fonction du besoin de l'analyse
et de ce que l'on cherche à montrer.

Afin d'éviter toute perte d'informations lors d'un import de données
depuis \textbf{Stata}, \textbf{SAS} et \textbf{SPSS}, le package
\texttt{\{haven\}} propose une implémentation sous \textbf{R} des
\emph{tagged NAs} et des \emph{user NAs}. Le package \{labelled\}
fournit quant à lui différentes fonctions pour les manipuler aisément.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(labelled)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec-tagged-na}{%
\section{\texorpdfstring{Valeurs manquantes étiquettées (\emph{tagged
NAs})}{Valeurs manquantes étiquettées (tagged NAs)}}\label{sec-tagged-na}}

\hypertarget{cruxe9ation-et-test}{%
\subsection{Création et test}\label{cruxe9ation-et-test}}

Les \emph{tagged NAs} sont de véritables valeurs manquantes
(\texttt{NA}) au sens de \textbf{R}, auxquelles a été attachées sur
étiquette, une lettre unique minuscule (a-z) ou majuscule (A-Z). On peut
les créer avec \texttt{labelled::tagged\_na()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\FunctionTok{tagged\_na}\NormalTok{(}\StringTok{"a"}\NormalTok{), }\FunctionTok{tagged\_na}\NormalTok{(}\StringTok{"z"}\NormalTok{), }\ConstantTok{NA}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Pour la plupart des fonctions de \textbf{R}, les \emph{tagged NAs} sont
juste considérées comme des valeurs manquantes régulières (\emph{regumar
NAs}). Dès lors, par défaut, elles sont justes affichées à l'écran comme
n'importe quelle valeur manquante et la fonction \texttt{is.na()}
renvoie \texttt{TRUE}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]  1  2  3 NA NA NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{is.na}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE  TRUE  TRUE  TRUE
\end{verbatim}

Pour afficher les étiquettes associées à ces valeurs manquantes, il faut
avoir recours à \texttt{labelled::na\_tag()},
\texttt{labelled::print\_tagged\_na()} ou encore
\texttt{labelled::format\_tagged\_na()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{na\_tag}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] NA  NA  NA  "a" "z" NA 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print\_tagged\_na}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]     1     2     3 NA(a) NA(z)    NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format\_tagged\_na}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "    1" "    2" "    3" "NA(a)" "NA(z)" "   NA"
\end{verbatim}

Pour tester si une certaine valeur manquante est une \emph{regular NA}
ou une \emph{tagged NA}, on aura recours à
\texttt{labelled::is\_regular\_na()} et à
\texttt{labelled::is\_tagged\_na()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{is.na}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE  TRUE  TRUE  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{is\_regular\_na}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE FALSE FALSE  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{is\_tagged\_na}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE  TRUE  TRUE FALSE
\end{verbatim}

Il est possible de tester une étiquette particulière en passant un
deuxième argument à \texttt{labelled::is\_tagged\_na()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{is\_tagged\_na}\NormalTok{(x, }\StringTok{"a"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE  TRUE FALSE FALSE
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

Il n'est possible de définir des \emph{tagged NAs} seulement pour des
vecteurs numériques (\emph{double}). Si l'on ajoute une \emph{tagged NA}
à un vecteur d'entiers, ce vecteur sera converti en vecteur numérique.
Si on l'ajoute à un vecteur textuel, la valeur manquante sera convertie
en \emph{regular NA}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\FunctionTok{tagged\_na}\NormalTok{(}\StringTok{"z"}\NormalTok{))}
\NormalTok{y}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "a" "b" NA 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{is\_tagged\_na}\NormalTok{(y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format\_tagged\_na}\NormalTok{(y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Error: `x` must be a double vector
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(1L, 2L, }\FunctionTok{tagged\_na}\NormalTok{(}\StringTok{"a"}\NormalTok{))}
\FunctionTok{typeof}\NormalTok{(z)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "double"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{format\_tagged\_na}\NormalTok{(z)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "    1" "    2" "NA(a)"
\end{verbatim}

\end{tcolorbox}

\hypertarget{valeurs-uniques-doublons-et-tris}{%
\subsection{Valeurs uniques, doublons et
tris}\label{valeurs-uniques-doublons-et-tris}}

Par défaut, les fonctions classiques de \textbf{R} \texttt{unique()},
\texttt{duplicated()}, \texttt{ordered()} ou encore \texttt{sort()}
traiteront les \emph{tagged NAs} comme des valeurs manquantes tout ce
qu'il y a de plus classique, et ne feront pas de différences entre des
\emph{tagged NAs} ayant des étiquettes différentes.

Pour traiter des \emph{tagged NAs} ayant des étiquettes différentes
comme des valeurs différentes, on aura recours aux fonctions
\texttt{labelled::unique\_tagged\_na()},
\texttt{labelled::duplicated\_tagged\_na()},
\texttt{labelled::order\_tagged\_na()} ou encore
\texttt{labelled::sort\_tagged\_na()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\FunctionTok{tagged\_na}\NormalTok{(}\StringTok{"a"}\NormalTok{), }\DecValTok{1}\NormalTok{, }\FunctionTok{tagged\_na}\NormalTok{(}\StringTok{"z"}\NormalTok{), }\DecValTok{2}\NormalTok{, }\FunctionTok{tagged\_na}\NormalTok{(}\StringTok{"a"}\NormalTok{), }\ConstantTok{NA}\NormalTok{)}
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{print\_tagged\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]     1     2 NA(a)     1 NA(z)     2 NA(a)    NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{unique}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{print\_tagged\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]     1     2 NA(a)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{unique\_tagged\_na}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{print\_tagged\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]     1     2 NA(a) NA(z)    NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{duplicated}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{duplicated\_tagged\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE  TRUE FALSE  TRUE  TRUE FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{sort}\NormalTok{(}\AttributeTok{na.last =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{print\_tagged\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]     1     1     2     2 NA(a) NA(z) NA(a)    NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{sort\_tagged\_na}\NormalTok{()  }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{print\_tagged\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]     1     1     2     2 NA(a) NA(a) NA(z)    NA
\end{verbatim}

\hypertarget{tagged-nas-et-uxe9tiquettes-de-valeurs}{%
\subsection{Tagged NAs et étiquettes de
valeurs}\label{tagged-nas-et-uxe9tiquettes-de-valeurs}}

Il est tout à fait possible d'associer une étiquette de valeurs
(cf.~Chapitre~\ref{sec-etiquettes-valeurs}) à des \emph{tagged NAs}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }
  \DecValTok{1}\NormalTok{, }\FunctionTok{tagged\_na}\NormalTok{(}\StringTok{"r"}\NormalTok{), }
  \DecValTok{0}\NormalTok{, }\FunctionTok{tagged\_na}\NormalTok{(}\StringTok{"d"}\NormalTok{), }
  \FunctionTok{tagged\_na}\NormalTok{(}\StringTok{"z"}\NormalTok{), }\ConstantTok{NA}
\NormalTok{)}
\FunctionTok{val\_labels}\NormalTok{(x) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{no =} \DecValTok{0}\NormalTok{, }
  \AttributeTok{yes =} \DecValTok{1}\NormalTok{,}
  \StringTok{"don\textquotesingle{}t know"} \OtherTok{=} \FunctionTok{tagged\_na}\NormalTok{(}\StringTok{"d"}\NormalTok{),}
  \AttributeTok{refusal =} \FunctionTok{tagged\_na}\NormalTok{(}\StringTok{"r"}\NormalTok{)}
\NormalTok{)}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled<double>[8]>
[1]     1     0     1 NA(r)     0 NA(d) NA(z)    NA

Labels:
 value      label
     0         no
     1        yes
 NA(d) don't know
 NA(r)    refusal
\end{verbatim}

Lorsqu'un vecteur labellisé est converti en facteur avec
\texttt{labelled::to\_factor()}, les \emph{tagged NAs} sont, par défaut
convertis en en valeurs manquantes classiques (\emph{regular NAs}). Il
n'est pas possible de définir des \emph{tagged NAs} pour des facteurs.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} \FunctionTok{to\_factor}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] yes  no   yes  <NA> no   <NA> <NA> <NA>
Levels: no yes
\end{verbatim}

L'option \texttt{explicit\_tagged\_na} de
\texttt{labelled::to\_factor()} permets de convertir les \emph{tagged
NAs} en modalités explicites du facteur.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{to\_factor}\NormalTok{(}\AttributeTok{explicit\_tagged\_na =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] yes        no         yes        refusal    no         don't know NA(z)     
[8] <NA>      
Levels: no yes don't know refusal NA(z)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{to\_factor}\NormalTok{(}
    \AttributeTok{levels =} \StringTok{"prefixed"}\NormalTok{, }
    \AttributeTok{explicit\_tagged\_na =} \ConstantTok{TRUE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] [1] yes            [0] no             [1] yes            [NA(r)] refusal   
[5] [0] no             [NA(d)] don't know [NA(z)] NA(z)      <NA>              
Levels: [0] no [1] yes [NA(d)] don't know [NA(r)] refusal [NA(z)] NA(z)
\end{verbatim}

\hypertarget{conversion-en-user-nas}{%
\subsection{Conversion en user NAs}\label{conversion-en-user-nas}}

La fonction \texttt{labelled::tagged\_na\_to\_user\_na()} permets de
convertir des \emph{tagged NAs} en \emph{user NAs}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tagged\_na\_to\_user\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled_spss<double>[8]>
[1]  1  0  1  3  0  2  4 NA
Missing range:  [2, 4]

Labels:
 value      label
     0         no
     1        yes
     2 don't know
     3    refusal
     4      NA(z)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tagged\_na\_to\_user\_na}\NormalTok{(}\AttributeTok{user\_na\_start =} \DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled_spss<double>[8]>
[1]  1  0  1 11  0 10 12 NA
Missing range:  [10, 12]

Labels:
 value      label
     0         no
     1        yes
    10 don't know
    11    refusal
    12      NA(z)
\end{verbatim}

La fonction \texttt{labelled::tagged\_na\_to\_regular\_na()} convertit
les \emph{tagged NAs} en valeurs manquantes classiques (\emph{regular
NAs}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tagged\_na\_to\_regular\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled<double>[8]>
[1]  1  0  1 NA  0 NA NA NA

Labels:
 value label
     0    no
     1   yes
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tagged\_na\_to\_regular\_na}\NormalTok{() }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{is\_tagged\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
\end{verbatim}

\hypertarget{sec-user-na}{%
\section{\texorpdfstring{Valeurs manquantes définies par l'utilisateurs
(\emph{user
NAs})}{Valeurs manquantes définies par l'utilisateurs (user NAs)}}\label{sec-user-na}}

Le package \texttt{\{haven\}} a introduit la classe
\texttt{haven\_labelled\_spss}, une extension de la classe
\texttt{haven\_labelled} permettant d'indiquer des valeurs à considérer
comme manquantes à la manière de \textbf{SPSS}.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Important}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

Cela revient à associer à un vecteur des attributs
(cf.~Chapitre~\ref{sec-attributs}) additionnels pour indiquer des
valeurs que l'utilisateur pourrait/devrait considérer comme manquante.
Cependant, il ne s'agit que de métadonnées et en interne ces valeurs ne
sont pas stockées sous forme de \texttt{NA} mais restent des valeurs
valides.

Il convient de garder en mémoire que la très grande majorité des
fonctions de \textbf{R} ne prendront pas en compte ces métadonnées et
traiteront donc ces valeurs comme des valeurs valides. C'est donc à
l'utilisateur de convertir, au besoin, ces les valeurs indiquées comme
manquantes en réelles valeurs manquantes (\texttt{NA}).

\end{tcolorbox}

\hypertarget{cruxe9ation}{%
\subsection{Création}\label{cruxe9ation}}

Il est possible d'indiquer des valeurs à considérer comme manquantes
(\emph{user NAs}) de deux manières~:

\begin{itemize}
\tightlist
\item
  soit en indiquant une liste de valeurs individuelles avec
  \texttt{labelled::na\_values()} (on peut indiquer \texttt{NULL} pour
  supprimer les déclarations existantes)~;
\item
  soit en indiquant deux valeurs représentant une plage de valeurs à
  considérées comme manquantes avec \texttt{labelled::na\_range()}
  (seront considérées comme manquantes toutes les valeurs supérieures ou
  égale au premier chiffre et inférieures ou égales au second
  chiffre\sidenote{\footnotesize On peut utiler \texttt{-Inf} et \texttt{Inf} qui
    représentent respectivement moins l'infini et l'infini.}).
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\ConstantTok{NA}\NormalTok{)}
\FunctionTok{val\_labels}\NormalTok{(v) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{faible =} \DecValTok{1}\NormalTok{, }
  \AttributeTok{fort =} \DecValTok{3}\NormalTok{, }
  \StringTok{"ne sait pas"} \OtherTok{=} \DecValTok{9}
\NormalTok{)}
\FunctionTok{na\_values}\NormalTok{(v) }\OtherTok{\textless{}{-}} \DecValTok{9}
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled_spss<double>[8]>
[1]  1  2  3  9  1  3  2 NA
Missing values: 9

Labels:
 value       label
     1      faible
     3        fort
     9 ne sait pas
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{na\_values}\NormalTok{(v) }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled<double>[8]>
[1]  1  2  3  9  1  3  2 NA

Labels:
 value       label
     1      faible
     3        fort
     9 ne sait pas
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{na\_range}\NormalTok{(v) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\ConstantTok{Inf}\NormalTok{)}
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled_spss<double>[8]>
[1]  1  2  3  9  1  3  2 NA
Missing range:  [5, Inf]

Labels:
 value       label
     1      faible
     3        fort
     9 ne sait pas
\end{verbatim}

On peut noter que les \emph{user NAs} peuvent cohabiter avec des
\emph{regular NAs} ainsi qu'avec des étiquettes de valeurs (\emph{value
labels}, cf. Chapitre~\ref{sec-etiquettes-valeurs}).

Pour manipuler les variables d'un tableau de données, on peut également
avoir recours à \texttt{labelled::set\_na\_values()} et
\texttt{labelled::set\_na\_range()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{tibble}\NormalTok{(}
    \AttributeTok{s1 =} \FunctionTok{c}\NormalTok{(}\StringTok{"M"}\NormalTok{, }\StringTok{"M"}\NormalTok{, }\StringTok{"F"}\NormalTok{, }\StringTok{"F"}\NormalTok{), }
    \AttributeTok{s2 =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{9}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{set\_na\_values}\NormalTok{(}\AttributeTok{s2 =} \DecValTok{9}\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{s2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled_spss<double>[4]>
[1] 1 1 2 9
Missing values: 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OtherTok{\textless{}{-}} 
\NormalTok{  df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{set\_na\_values}\NormalTok{(}\AttributeTok{s2 =} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{s2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled<double>[4]>
[1] 1 1 2 9
\end{verbatim}

\hypertarget{tests}{%
\subsection{Tests}\label{tests}}

La fonction \texttt{is.na()} est l'une des rares fonctions de base
\textbf{R} à reconnaître les \emph{user NAs} et donc à renvoyer
\texttt{TRUE} dans ce cas. Pour des tests plus spécifiques, on aura
recours à \texttt{labelled::is\_user\_na()} et
\texttt{labelled::is\_regular\_na()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled_spss<double>[8]>
[1]  1  2  3  9  1  3  2 NA
Missing range:  [5, Inf]

Labels:
 value       label
     1      faible
     3        fort
     9 ne sait pas
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\SpecialCharTok{|\textgreater{}} \FunctionTok{is.na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\SpecialCharTok{|\textgreater{}} \FunctionTok{is\_user\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\SpecialCharTok{|\textgreater{}} \FunctionTok{is\_regular\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE
\end{verbatim}

\hypertarget{conversion-1}{%
\subsection{Conversion}\label{conversion-1}}

Comme dit précédemment, pour la plupart des fonctions de \textbf{R}, les
\emph{users NAs} sont toujours des valeurs valides.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\DecValTok{11}\SpecialCharTok{:}\DecValTok{15}\NormalTok{)}
\FunctionTok{na\_range}\NormalTok{(x) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\ConstantTok{Inf}\NormalTok{)}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled_spss<integer>[10]>
 [1]  1  2  3  4  5 11 12 13 14 15
Missing range:  [10, Inf]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mean}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 8
\end{verbatim}

On aura alors recours à \texttt{labelled::user\_na\_to\_regular\_na()}
pour convertir les \emph{users NAs} en véritables valeurs manquantes
avant de procéder à un calcul statistique.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{user\_na\_to\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled<integer>[10]>
 [1]  1  2  3  4  5 NA NA NA NA NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{user\_na\_to\_na}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mean}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 3
\end{verbatim}

Une alternative consiste à transformer les \emph{user NAs} en
\emph{tagged NAs} avec \texttt{labelled::user\_na\_to\_tagged\_na()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{user\_na\_to\_tagged\_na}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{print\_tagged\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'x' has been converted into a double vector.
\end{verbatim}

\begin{verbatim}
 [1]     1     2     3     4     5 NA(a) NA(b) NA(c) NA(d) NA(e)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{user\_na\_to\_tagged\_na}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mean}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'x' has been converted into a double vector.
\end{verbatim}

\begin{verbatim}
[1] 3
\end{verbatim}

Pour supprimer les métadonnées relatives aux \emph{user NAs} sans les
convertir en valeurs manquantes, on aura recours à
\texttt{labelled::remove\_user\_na()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{remove\_user\_na}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<labelled<integer>[10]>
 [1]  1  2  3  4  5 11 12 13 14 15
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{remove\_user\_na}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mean}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 8
\end{verbatim}

Enfin, lorsque l'on convertit un vecteur labellisé en facteur avec
\texttt{labelled::to\_factor()}, on pourra utiliser l'argument
\texttt{user\_na\_to\_na} pour indiquer si les \emph{users NAs} doivent
être convertis ou non en valeurs manquantes classiques (\texttt{NA}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\FunctionTok{val\_labels}\NormalTok{(x) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{oui =} \DecValTok{1}\NormalTok{, }\AttributeTok{non =} \DecValTok{2}\NormalTok{, }\AttributeTok{refus =} \DecValTok{9}\NormalTok{)}
\FunctionTok{na\_values}\NormalTok{(x) }\OtherTok{\textless{}{-}} \DecValTok{9}
\NormalTok{x }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{to\_factor}\NormalTok{(}\AttributeTok{user\_na\_to\_na =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] oui  non  <NA> non 
Levels: oui non
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{to\_factor}\NormalTok{(}\AttributeTok{user\_na\_to\_na =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] oui   non   refus non  
Levels: oui non refus
\end{verbatim}

\hypertarget{sec-import-export}{%
\chapter{Import \& Export de données}\label{sec-import-export}}

\hypertarget{importer-un-fichier-texte}{%
\section{Importer un fichier texte}\label{importer-un-fichier-texte}}

Les fichiers texte constituent un des formats les plus largement
supportés par la majorité des logiciels statistiques. Presque tous
permettent d'exporter des données dans un format texte, y compris les
tableurs comme \textbf{Libre Office}, \textbf{Open Office} ou
\textbf{Excel}.

Cependant, il existe une grande variétés de format texte, qui peuvent
prendre différents noms selon les outils, tels que texte tabulé ou
\emph{texte (séparateur~: tabulation)}, \textbf{CSV} (pour
\emph{comma-separated value}, sachant que suivant les logiciels le
séparateur peut être une virgule ou un point-virgule).

\hypertarget{structure-dun-fichier-texte}{%
\subsection{Structure d'un fichier
texte}\label{structure-dun-fichier-texte}}

Dès lors, avant d'importer un fichier texte dans \textbf{R}, il est
indispensable de regarder comment ce dernier est structuré. Il importe
de prendre note des éléments suivants~:

\begin{itemize}
\tightlist
\item
  La première ligne contient-elle le nom des variables~?
\item
  Quel est le caractère séparateur entre les différentes variables
  (encore appelé séparateur de champs)~? Dans le cadre d'un fichier
  \textbf{CSV}, il aurait pu s'agir d'une virgule ou d'un point-virgule.
\item
  Quel est le caractère utilisé pour indiquer les décimales (le
  séparateur décimal)~? Il s'agit en général d'un point (à
  l'anglo-saxonne) ou d'une virgule (à la française).
\item
  Les valeurs textuelles sont-elles encadrées par des guillemets et, si
  oui, s'agit-il de guillements simple (\texttt{\textquotesingle{}}) ou
  de guillemets doubles (\texttt{"})~?
\item
  Pour les variables textuelles, y a-t-il des valeurs manquantes et si
  oui comment sont-elles indiquées~? Par exemple, le texte \texttt{NA}
  est parfois utilisé.
\end{itemize}

Il ne faut pas hésitez à ouvrir le fichier avec un éditeur de texte pour
le regarder de plus près.

\hypertarget{interface-graphique-avec-rstudio}{%
\subsection{Interface graphique avec
RStudio}\label{interface-graphique-avec-rstudio}}

\textbf{RStudio} fournit une interface graphique pour faciliter l'import
d'un fichier texte. Pour cela, il suffit d'aller dans le menu \emph{File
\textgreater{} Import Dataset} et de choisir l'option \emph{From
CSV}\sidenote{\footnotesize L'option CSV fonctionne pour tous les fichiers de type
  texte, même si votre fichier a une autre extension, \texttt{.txt} par
  exemple}. Cette option est également disponible via l'onglet
\emph{Environment} dans le quadrant haut-droite.

Pour la suite, nous allons utiliser ce
\href{ressources/exemple_texte_tabule.txt}{fichier texte à titre
d'exemple}.

\begin{figure}

{\centering \includegraphics{manipulation/ressources/capture_RStudio_import_readr.png}

}

\caption{\label{fig-import-rstudio-readr}Importer un fichier texte avec
RStudio}

\end{figure}

L'interface de \textbf{RStudio} vous présente sous \emph{Import Options}
les différentes options d'import disponible. La section \emph{Data
Preview} vous permet de voir en temps réel comment les données sont
importées. La section \emph{Code Preview} vous indique le code
\textbf{R} correspondant à vos choix. Il n'y a plus qu'à le
copier/coller dans un de vos scripts ou à cliquer sur \textbf{Import}
pour l'exécuter.

Vous pourrez remarquer que \textbf{RStudio} fait appel à l'extension
\texttt{\{readr\}} du tidyverse pour l'import des données via la
fonction \texttt{readr::read\_csv()}.

\texttt{\{readr\}} essaie de deviner le type de chacune des colonnes, en
se basant sur les premières observations. En cliquant sur le nom d'une
colonne, il est possible de modifier le type de la variable importée. Il
est également possible d'exclure une colonne de l'import (\emph{skip}).

\hypertarget{dans-un-script}{%
\subsection{Dans un script}\label{dans-un-script}}

L'interface graphique de \textbf{RStudio} fournit le code d'import. On
peut également l'adapter à ces besoins en consultant la page d'aide de
\texttt{readr::read\_csv()} pour plus de détails. Par exemple~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(readr)}
\NormalTok{d }\OtherTok{\textless{}{-}} \FunctionTok{read\_delim}\NormalTok{(}
  \StringTok{"http://larmarange.github.io/analyse{-}R/data/exemple\_texte\_tabule.txt"}\NormalTok{, }
  \AttributeTok{delim =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }
  \AttributeTok{quote =} \StringTok{"\textquotesingle{}"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

On peut indiquer le chemin local vers un fichier (le plus courant) ou
bien directement l'URL d'un fichier sur Internet.

\texttt{\{readr\}} propose plusieurs fonctions proches~:
\texttt{readr::read\_delim()}, \texttt{readr::read\_csv()},
\texttt{readr::read\_csv2()} et \texttt{readr::read\_tsv()}. Elles
fonctionnent toutes de manière identique et ont les mêmes arguments.
Seule différence, les valeurs par défaut de certainsparamètres.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Fichiers de très grande taille}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Si vous travaillez sur des données de grandes dimensions, les formats
texte peuvent être lents à exporter et importer. Dans ce cas là, on
pourra jeter un œil au package \texttt{\{vroom\}} et/ou aux fonctions
\texttt{data.table::fread()} et \texttt{data.table::fwrite()}.

\end{tcolorbox}

Dans des manuels ou des exemples en ligne, vous trouverez parfois
mention des fonctions \texttt{utils::read.table()},
\texttt{utils::read.csv()}, \texttt{utils::read.csv2()},
\texttt{utils::read.delim()} ou encore \texttt{utils::read.delim2()}. Il
s'agit des fonctions natives et historiques de \textbf{R} (extension
\texttt{\{utils\}}) dédiées à l'import de fichiers textes. Elles sont
similaires à celles de \texttt{\{readr\}} dans l'idée générale mais
diffèrent dans leurs détails et les traitements effectués sur les
données (pas de détection des dates par exemple). Pour plus
d'information, vous pouvez vous référer à la page d'aide de ces
fonctions.

\hypertarget{importer-un-fichier-excel}{%
\section{Importer un fichier Excel}\label{importer-un-fichier-excel}}

Une première approche pour importer des données \textbf{Excel} dans
\textbf{R} consiste à les exporter depuis \textbf{Excel} dans un fichier
texte (texte tabulé ou \textbf{CSV}) puis de suivre la procédure
d'importation d'un fichier texte.

Une feuille \textbf{Excel} peut également être importée directement avec
l'extension \texttt{\{readxl\}} du \emph{tidyverse}.

La fonction \texttt{readxl::read\_excel()} permet d'importer à la fois
des fichiers \texttt{.xls} (\textbf{Excel} 2003 et précédents) et
\texttt{.xlsx} (\textbf{Excel} 2007 et suivants).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(readxl)}
\NormalTok{donnees }\OtherTok{\textless{}{-}} \FunctionTok{read\_excel}\NormalTok{(}\StringTok{"data/fichier.xlsx"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Une seule feuille de calculs peut être importée à la fois. On pourra
préciser la feuille désirée avec \texttt{sheet} en indiquant soit le nom
de la feuille, soit sa position (première, seconde, \ldots).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{donnees }\OtherTok{\textless{}{-}} \FunctionTok{read\_excel}\NormalTok{(}\StringTok{"data/fichier.xlsx"}\NormalTok{, }\AttributeTok{sheet =} \DecValTok{3}\NormalTok{)}
\NormalTok{donnees }\OtherTok{\textless{}{-}} \FunctionTok{read\_excel}\NormalTok{(}\StringTok{"data/fichier.xlsx"}\NormalTok{, }\AttributeTok{sheet =} \StringTok{"mes\_donnees"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

On pourra préciser avec \texttt{col\_names} si la première ligne
contient le nom des variables.

Par défaut, \texttt{readxl::read\_excel()} va essayer de deviner le type
(numérique, textuelle, date) de chaque colonne. Au besoin, on pourra
indiquer le type souhaité de chaque colonne avec \texttt{col\_types}.

\textbf{RStudio} propose également pour les fichiers \textbf{Excel} un
assitant d'importation, similaire à celui pour les fichiers texte,
permettant de faciliter l'import.

\hypertarget{importer-depuis-des-logiciels-de-statistique}{%
\section{Importer depuis des logiciels de
statistique}\label{importer-depuis-des-logiciels-de-statistique}}

Le package \texttt{\{haven\}} du \emph{tidyverse} a été développé
spécifiquement pour permettre l'importation de données depuis les
formats des logiciels \textbf{Stata}, \textbf{SAS} et \textbf{SPSS}.

Il vise à offrir une importation unifiée depuis ces trois logiciels (là
où le package \texttt{\{foreign\}} distribué en standard avec \textbf{R}
adopte des conventions différentes selon le logiciel source).

Afin de ne pas perdre d'information lors de l'import, \texttt{\{haven\}}
a introduit la notion d'étiquettes de variables
(cf.~Chapitre~\ref{sec-etiquettes-variables}), une classe de vecteurs
pour la gestion des étiquettes de valeurs (cf.
Chapitre~\ref{sec-etiquettes-valeurs}), des mécanismes pour reproduire
la gestion des valeurs manquantes de ces trois logiciels
(cf.~Chapitre~\ref{sec-valeurs-manquantes}), mais également une gestion
et un import correct des dates, dates-heures et des variables horaires
(cf.~le package \texttt{\{hms\}}).

À noter que \textbf{RStudio} intègre égalementg une interface graphique
pour l'import des fichiers \textbf{Stata}, \textbf{SAS} et
\textbf{SPSS}.

\hypertarget{spss}{%
\subsection{SPSS}\label{spss}}

Les fichiers générés par \textbf{SPSS} sont de deux types~: les fichiers
\textbf{SPSS natifs} (extension \texttt{.sav}) et les fichiers au format
\textbf{SPSS export} (extension \texttt{.por}).

Dans les deux cas, on aura recours à la fonction
\texttt{haven::read\_spss()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(haven)}
\NormalTok{donnees }\OtherTok{\textless{}{-}} \FunctionTok{read\_spss}\NormalTok{(}\StringTok{"data/fichier.sav"}\NormalTok{, }\AttributeTok{user\_na =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Valeurs manquantes}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Dans \textbf{SPSS}, il est possible de définir des valeurs à considérées
comme manquantes ou \emph{user NAs}, voir
Chapitre~\ref{sec-valeurs-manquantes}. Par défaut,
\texttt{haven::read\_spss()} convertir toutes ces valeurs en \texttt{NA}
lors de l'import.

Or, il est parfois important de garder les différentes valeurs
originelles. Dans ce cas, on appellera \texttt{haven::read\_spss()} avec
l'option \texttt{user\_na\ =\ TRUE}.

\end{tcolorbox}

\hypertarget{sas}{%
\subsection{SAS}\label{sas}}

Les fichiers \textbf{SAS} se présentent en général sous deux format~:
format \textbf{SAS export} (extension \texttt{.xport} ou \texttt{.xpt})
ou format \textbf{SAS natif} (extension \texttt{.sas7bdat}).

Les fichiers \textbf{SAS natifs} peuvent être importées directement avec
\texttt{haven::read\_sas()} de l'extension \texttt{\{haven\}}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(haven)}
\NormalTok{donnees }\OtherTok{\textless{}{-}} \FunctionTok{read\_sas}\NormalTok{(}\StringTok{"data/fichier.sas7bdat"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Au besoin, on pourra préciser en deuxième argument le nom d'un fichier
\textbf{SAS catalogue} (extension \texttt{.sas7bcat}) contenant les
métadonnées du fichier de données.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(haven)}
\NormalTok{donnees }\OtherTok{\textless{}{-}} \FunctionTok{read\_sas}\NormalTok{(}
  \StringTok{"data/fichier.sas7bdat"}\NormalTok{, }
  \AttributeTok{catalog\_file =} \StringTok{"data/fichier.sas7bcat"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

Les fichiers au format \textbf{SAS export} peuvent être importés via la
fonction \texttt{foreign::read.xport()} de l'extension
\texttt{\{foreign\}}. Celle-ci s'utilise très simplement, en lui passant
le nom du fichier en argument~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(foreign)}
\NormalTok{donnees }\OtherTok{\textless{}{-}} \FunctionTok{read.xport}\NormalTok{(}\StringTok{"data/fichier.xpt"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\end{tcolorbox}

\hypertarget{stata}{%
\subsection{Stata}\label{stata}}

Pour les fichiers \textbf{Stata} (extension \texttt{.dta}), on aura
recours aux fonctions \texttt{haven::read\_dta()} et
\texttt{haven::read\_stata()} de l'extension \texttt{\{haven\}}. Ces
deux fonctions sont identiques.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(haven)}
\NormalTok{donnees }\OtherTok{\textless{}{-}} \FunctionTok{read\_dta}\NormalTok{(}\StringTok{"data/fichier.dta"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Important}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

\textbf{Gestion des valeurs manquantes}

Dans \textbf{Stata}, il est possible de définir plusieurs types de
valeurs manquantes, qui sont notées sous la forme \texttt{.a} à
\texttt{.z}. Elles sont importées par \texttt{\{haven\}} sous formes de
\emph{tagged NAs}, cf.~Chapitre~\ref{sec-valeurs-manquantes}.

\end{tcolorbox}

\hypertarget{dbase}{%
\subsection{dBase}\label{dbase}}

L'Insee et d'autres producteur de données diffusent leurs fichiers au
format \textbf{dBase} (extension \texttt{.dbf}). Ceux-ci sont
directement lisibles dans \textbf{R} avec la fonction
\texttt{foreign::read.dbf()} de l'extension \texttt{\{foreign\}}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(foreign)}
\NormalTok{donnees }\OtherTok{\textless{}{-}} \FunctionTok{read.dbf}\NormalTok{(}\StringTok{"data/fichier.dbf"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sauver-ses-donnuxe9es}{%
\section{Sauver ses données}\label{sauver-ses-donnuxe9es}}

\textbf{R} dispose également de son propre format pour sauvegarder et
échanger des données. On peut sauver n'importe quel objet créé avec
\textbf{R} et il est possible de sauver plusieurs objets dans un même
fichier. L'usage est d'utiliser l'extension \texttt{.RData} pour les
fichiers de données \textbf{R}. La fonction à utiliser s'appelle tout
simplement \texttt{save()}.

Par exemple, si l'on souhaite sauvegarder son tableau de données
\texttt{d} ainsi que les objets \texttt{tailles} et \texttt{poids} dans
un fichier \texttt{export.RData}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(d, tailles, poids, }\AttributeTok{file =} \StringTok{"export.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

À tout moment, il sera toujours possible de recharger ces données en
mémoire à l'aide de la fonction \texttt{load()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\StringTok{"export.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-caution-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-caution-color}{\faFire}\hspace{0.5em}{Mise en garde}, bottomrule=.15mm, colframe=quarto-callout-caution-color-frame]

Si entre temps vous aviez modifié votre tableau \texttt{d}, vos
modifications seront perdues. En effet, si lors du chargement de
données, un objet du même nom existe en mémoire, ce dernier sera
remplacé par l'objet importé.

\end{tcolorbox}

La fonction \texttt{save.image()} est un raccourci pour sauvergarder
tous les objets de la session de travail dans le fichier \texttt{.RData}
(un fichier un peu étrange car il n'a pas de nom mais juste une
extension). Lors de la fermeture de \textbf{RStudio}, il vous sera
demandé si vous souhaitez enregistrer votre session. Si vous répondez
\emph{Oui}, c'est cette fonction \texttt{save.image()} qui sera
appliquée.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save.image}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

Un autre mécanisme possible est le format \textbf{RDS} de \textbf{R}. La
fonction \texttt{saveRDS()} permet de sauvegarder \textbf{un et un seul}
objet \textbf{R} dans un fichier.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{saveRDS}\NormalTok{(d, }\AttributeTok{file =} \StringTok{"mes\_donnees.rds"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Cet objet pourra ensuite être lu avec la fonction \texttt{readRDS()}.
Mais au lieu d'être directement chargé dans la mémoire de
l'environnement de travail, l'objet lu sera retourné par la fonction
\texttt{readRDS()} et ce sera à l'utilisateur de le sauvegarder.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{donnees }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"mes\_donnees.rds"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{export-de-tableaux-de-donnuxe9es}{%
\section{Export de tableaux de
données}\label{export-de-tableaux-de-donnuxe9es}}

On peut avoir besoin d'exporter un tableau de données \textbf{R} vers
différents formats. La plupart des fonctions d'import disposent d'un
équivalent permettant l'export de données. On citera notamment~:

\begin{itemize}
\tightlist
\item
  \texttt{readr::write\_csv()} et \texttt{readr::write\_tsv()}
  permettent d'exporter au format \textbf{CSV} et texte tabulé
  respectivement, \texttt{readr::write\_delim()} offrant de multiples
  options pour l'exort au format texte~;
\item
  \texttt{haven::write\_sas()} permet d'exporter au format
  \textbf{SAS~;}
\item
  \texttt{haven::write\_sav()} au format \textbf{SPSS~;}
\item
  \texttt{haven::write\_dta()} au format \textbf{Stata~;}
\item
  \texttt{foreign::write.dbf()} au format \textbf{dBase}.
\end{itemize}

L'extension \texttt{readxl} ne fournit pas de fonction pour exporter au
format \textbf{Excel}. Par contre, on pourra passer par la fonction
\texttt{openxlsx::write.xlsx()} du package \texttt{\{openxlsx\}} ou la
fonction \texttt{xlsx::write.xlsx()} de l'extension \texttt{\{xlsx\}}.
L'intérêt de \texttt{\{openxlsx\}} est de ne pas dépendre de
\textbf{Java} à la différence de \texttt{\{xlsx\}}.

\hypertarget{sec-formater-nombre}{%
\chapter{Mettre en forme des nombres}\label{sec-formater-nombre}}

Dans les chapitres suivants, nous aurons régulièrement besoin, pour
produire des tableaux ou des figures propres, de \textbf{fonctions de
formatage} qui permettent de transformer des valeurs numériques en
chaînes de texte.

La fonction \textbf{R} de base est \texttt{format()} mais de nombreux
autres packages proposent des variations pour faciliter cette opération.
Le plus complet est probablement \texttt{\{scales\}} et, notamment, ses
fonctions \texttt{scales::label\_number()} et \texttt{scales::number()}.

Elles ont l'air très similaires et partagent un grand nombre de
paramètres en commun. La différence est que \texttt{scales::number()} a
besoin d'un vecteur numérique en entrée qu'elle va mettre en forme,
tandis que que \texttt{scales::label\_number()} renvoie une fonction que
l'on pourra ensuite appliquer à un vecteur numérique.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(scales)}
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{0.0023}\NormalTok{, .}\DecValTok{123}\NormalTok{, }\FloatTok{4.567}\NormalTok{, }\FloatTok{874.44}\NormalTok{, }\DecValTok{8957845}\NormalTok{)}
\FunctionTok{number}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.00"         "0.12"         "4.57"         "874.44"       "8 957 845.00"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{f }\OtherTok{\textless{}{-}} \FunctionTok{label\_number}\NormalTok{()}
\FunctionTok{f}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.00"         "0.12"         "4.57"         "874.44"       "8 957 845.00"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_number}\NormalTok{()(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.00"         "0.12"         "4.57"         "874.44"       "8 957 845.00"
\end{verbatim}

Dans de nombreux cas de figure (par exemple pour un graphique
\texttt{\{ggplot2\}} ou un tableau \texttt{\{gtsummary\}}), il sera
demandé de fournir une fonction de formatage, auquel cas on aura recours
aux fonctions de \texttt{\{scales\}} préfixées par \texttt{label\_*()}
qui permettent donc de générer une fonction personnalisée.

\hypertarget{label_number}{%
\section{\texorpdfstring{\texttt{label\_number()}}{label\_number()}}\label{label_number}}

\texttt{scales::label\_number()} est la fonction de base de mise en
forme de nombres dans \texttt{\{scales\}}, une majorité des autres
fonctions faisant appel à \texttt{scales::label\_number()} et partageant
les mêmes arguments.

Le paramètre \texttt{accurary} permets de définir le niveau d'arrondi à
utiliser. Par exemple, \texttt{.1} pour afficher une seule décimale. Il
est aussi possible d'indiquer un nombre qui n'est pas une puissance de
10 (par exemple \texttt{.25}). Si on n'indique rien (\texttt{NULL}),
alors \texttt{scales::label\_number()} essaiera de deviner un nombre de
décimales pertinent en fonction des valeurs du vecteur de nombres à
mettre en forme.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{accuracy =} \ConstantTok{NULL}\NormalTok{)(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.00"         "0.12"         "4.57"         "874.44"       "8 957 845.00"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{accuracy =}\NormalTok{ .}\DecValTok{1}\NormalTok{)(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.0"         "0.1"         "4.6"         "874.4"       "8 957 845.0"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{accuracy =}\NormalTok{ .}\DecValTok{25}\NormalTok{)(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.0"         "0.0"         "4.5"         "874.5"       "8 957 845.0"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{accuracy =} \DecValTok{10}\NormalTok{)(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0"         "0"         "0"         "870"       "8 957 840"
\end{verbatim}

L'option \texttt{scale} permets d'indiquer un facteur multiplicatif à
appliquer avant de mettre en forme. On utilisera le plus souvent les
options \texttt{prefix} et \texttt{suffix} en même temps pour indiquer
les unités.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{scale =} \DecValTok{100}\NormalTok{, }\AttributeTok{suffix =} \StringTok{"\%"}\NormalTok{)(x) }\CommentTok{\# pour cent}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0%"           "12%"          "457%"         "87 444%"      "895 784 500%"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{scale =} \DecValTok{1000}\NormalTok{, }\AttributeTok{suffix =} \StringTok{"\textbackslash{}u2030"}\NormalTok{)(x) }\CommentTok{\# pour mille}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2‰"             "123‰"           "4 567‰"         "874 440‰"      
[5] "8 957 845 000‰"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{scale =}\NormalTok{ .}\DecValTok{001}\NormalTok{, }\AttributeTok{suffix =} \StringTok{" milliers"}\NormalTok{, }\AttributeTok{accuracy =}\NormalTok{ .}\DecValTok{1}\NormalTok{)(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.0 milliers"     "0.0 milliers"     "0.0 milliers"     "0.9 milliers"    
[5] "8 957.8 milliers"
\end{verbatim}

Les arguments \texttt{decimal.mark} et \texttt{big.mark} permettent de
définir, respectivement, le séparateur de décimale et le séparateur de
milliers. Ainsi, pour afficher des nombres à la française (virgule pour
les décimales, espace pour les milliers)~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{, }\AttributeTok{big.mark =} \StringTok{" "}\NormalTok{)(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0,00"         "0,12"         "4,57"         "874,44"       "8 957 845,00"
\end{verbatim}

Note~: il est possible d'utiliser \texttt{small.interval} et
\texttt{small.mark} pour ajouter des séparateurs parmi les décimales.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{accuracy =} \DecValTok{10}\SpecialCharTok{\^{}{-}}\DecValTok{9}\NormalTok{, }\AttributeTok{small.mark =} \StringTok{"|"}\NormalTok{, }\AttributeTok{small.interval =} \DecValTok{3}\NormalTok{)(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.002|300|000"         "0.123|000|000"         "4.567|000|000"        
[4] "874.440|000|000"       "8 957 845.000|000|000"
\end{verbatim}

Les options \texttt{style\_positive} et \texttt{style\_negative}
permettent de personnaliser la manière dont les valeurs positives et
négatives sont mises en forme.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.2}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{0.3}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FloatTok{2.4}\NormalTok{, }\FloatTok{7.2}\NormalTok{)}
\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{style\_positive =} \StringTok{"plus"}\NormalTok{)(y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "-1.2" "-0.3" "0.0"  "+2.4" "+7.2"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{style\_negative =} \StringTok{"parens"}\NormalTok{)(y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "(1.2)" "(0.3)" "0.0"   "2.4"   "7.2"  
\end{verbatim}

\hypertarget{les-autres-fonctions-de-scales}{%
\section{\texorpdfstring{Les autres fonctions de
\texttt{\{scales\}}}{Les autres fonctions de \{scales\}}}\label{les-autres-fonctions-de-scales}}

\hypertarget{label_comma}{%
\subsection{\texorpdfstring{\texttt{label\_comma()}}{label\_comma()}}\label{label_comma}}

\texttt{scales::label\_comma()} (et \texttt{scales::comma()}) est une
variante de \texttt{scales::label\_number()} qui, par défaut, affiche
les nombres à l'américaine, avec une virgule comme séparateur de
milliers.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_comma}\NormalTok{()(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.00"         "0.12"         "4.57"         "874.44"       "8,957,845.00"
\end{verbatim}

\hypertarget{label_percent}{%
\subsection{\texorpdfstring{\texttt{label\_percent()}}{label\_percent()}}\label{label_percent}}

\texttt{scales::label\_percent()} (et \texttt{scales::percent()}) est
une variante de \texttt{scales::label\_number()} qui affiche les nombres
sous formes de pourcentages (les options par défaut sont
\texttt{scale\ =\ 100,\ suffix\ =\ "\%"}).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_percent}\NormalTok{()(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0%"           "12%"          "457%"         "87 444%"      "895 784 500%"
\end{verbatim}

On peut utiliser cette fonction pour afficher des résultats en pour
mille (le \href{https://unicode-table.com/fr/2030/}{code unicode} du
symbole ‰ étant u2030)~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_percent}\NormalTok{(}\AttributeTok{scale =} \DecValTok{1000}\NormalTok{, }\AttributeTok{suffix =} \StringTok{"\textbackslash{}u2030"}\NormalTok{)(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2‰"             "123‰"           "4 567‰"         "874 440‰"      
[5] "8 957 845 000‰"
\end{verbatim}

\hypertarget{label_dollar}{%
\subsection{\texorpdfstring{\texttt{label\_dollar()}}{label\_dollar()}}\label{label_dollar}}

\texttt{scales::label\_dollar()} est adapté à l'affichage des valeurs
monétaires.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_dollar}\NormalTok{()(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "$0"         "$0"         "$5"         "$874"       "$8,957,845"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_dollar}\NormalTok{(}\AttributeTok{prefix =} \StringTok{""}\NormalTok{, }\AttributeTok{suffix =} \StringTok{" €"}\NormalTok{, }\AttributeTok{accuracy =}\NormalTok{ .}\DecValTok{01}\NormalTok{, }\AttributeTok{big.mark =} \StringTok{" "}\NormalTok{)(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.00 €"         "0.12 €"         "4.57 €"         "874.44 €"      
[5] "8 957 845.00 €"
\end{verbatim}

L'option \texttt{style\_negative} permet d'afficher les valeurs
négatives avec des parenthèses, convention utilisée dans certaines
disciplines.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_dollar}\NormalTok{()(}\FunctionTok{c}\NormalTok{(}\FloatTok{12.5}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{21}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{56.36}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "$12.50"  "-$4.00"  "$21.00"  "-$56.36"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_dollar}\NormalTok{(}\AttributeTok{style\_negative =} \StringTok{"parens"}\NormalTok{)(}\FunctionTok{c}\NormalTok{(}\FloatTok{12.5}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\DecValTok{21}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{56.36}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "$12.50"   "($4.00)"  "$21.00"   "($56.36)"
\end{verbatim}

\hypertarget{label_pvalue}{%
\subsection{\texorpdfstring{\texttt{label\_pvalue()}}{label\_pvalue()}}\label{label_pvalue}}

\texttt{scales::label\_pvalue()} est adapté pour la mise en forme de
p-valeurs.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_pvalue}\NormalTok{()(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.000001}\NormalTok{, }\FloatTok{0.023}\NormalTok{, }\FloatTok{0.098}\NormalTok{, }\FloatTok{0.60}\NormalTok{, }\FloatTok{0.9998}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "<0.001" "0.023"  "0.098"  "0.600"  ">0.999"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_pvalue}\NormalTok{(}\AttributeTok{accuracy =}\NormalTok{ .}\DecValTok{01}\NormalTok{, }\AttributeTok{add\_p =} \ConstantTok{TRUE}\NormalTok{)(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.000001}\NormalTok{, }\FloatTok{0.023}\NormalTok{, }\FloatTok{0.098}\NormalTok{, }\FloatTok{0.60}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "p<0.01" "p=0.02" "p=0.10" "p=0.60"
\end{verbatim}

\hypertarget{label_number_si}{%
\subsection{\texorpdfstring{\texttt{label\_number\_si()}}{label\_number\_si()}}\label{label_number_si}}

\texttt{scales::label\_number\_si()} cherche le
\href{https://fr.wikipedia.org/wiki/Pr\%C3\%A9fixes_du_Syst\%C3\%A8me_international_d\%27unit\%C3\%A9s}{préfixe
du Système international d'unités} le plus proche et arrondi chaque
valeur en fonction, en ajoutant la précision correspondante.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_number\_si}\NormalTok{(}\AttributeTok{unit =} \StringTok{"g"}\NormalTok{)(}\FunctionTok{c}\NormalTok{(.}\DecValTok{00000145}\NormalTok{, .}\DecValTok{0034}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{12478}\NormalTok{, }\DecValTok{14569787}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Warning: `label_number_si()` was deprecated in scales 1.2.0.
i Please use the `scale_cut` argument of `label_number()` instead.
\end{verbatim}

\begin{verbatim}
[1] "0.0000 g" "0.0034 g" "5.0000 g" "12 Kg"    "15 Mg"   
\end{verbatim}

\hypertarget{label_scientific}{%
\subsection{\texorpdfstring{\texttt{label\_scientific()}}{label\_scientific()}}\label{label_scientific}}

\texttt{scales::label\_scientific()} affiche les nombres dans un format
scientifique (avec des puissances de 10).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_scientific}\NormalTok{(}\AttributeTok{unit =} \StringTok{"g"}\NormalTok{)(}\FunctionTok{c}\NormalTok{(.}\DecValTok{00000145}\NormalTok{, .}\DecValTok{0034}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{12478}\NormalTok{, }\DecValTok{14569787}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "1.45e-06" "3.40e-03" "5.00e+00" "1.25e+04" "1.46e+07"
\end{verbatim}

\hypertarget{label_bytes}{%
\subsection{\texorpdfstring{\texttt{label\_bytes()}}{label\_bytes()}}\label{label_bytes}}

\texttt{scales::label\_bytes()} mets en forme des tailles exprimées en
octets, utilisant au besoin des multiples de 1024.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{478}\NormalTok{, }\DecValTok{1235468}\NormalTok{, }\DecValTok{546578944897}\NormalTok{)}
\FunctionTok{label\_bytes}\NormalTok{()(b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "478 B"  "1 MB"   "547 GB"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_bytes}\NormalTok{(}\AttributeTok{units =} \StringTok{"auto\_binary"}\NormalTok{)(b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "478 iB"  "1 MiB"   "509 GiB"
\end{verbatim}

\hypertarget{label_ordinal}{%
\subsection{\texorpdfstring{\texttt{label\_ordinal()}}{label\_ordinal()}}\label{label_ordinal}}

\texttt{scales::label\_bytes()} permets d'afficher des rangs ou nombres
ordinaux. Plusieurs langues sont disponibles.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_ordinal}\NormalTok{()(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "1st" "2nd" "3rd" "4th" "5th"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_ordinal}\NormalTok{(}\AttributeTok{rules =} \FunctionTok{ordinal\_french}\NormalTok{())(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "1er" "2e"  "3e"  "4e"  "5e" 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_ordinal}\NormalTok{(}\AttributeTok{rules =} \FunctionTok{ordinal\_french}\NormalTok{(}\AttributeTok{gender =} \StringTok{"f"}\NormalTok{, }\AttributeTok{plural =} \ConstantTok{TRUE}\NormalTok{))(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "1res" "2es"  "3es"  "4es"  "5es" 
\end{verbatim}

\hypertarget{label_date-label_date_short-label_time}{%
\subsection{\texorpdfstring{\texttt{label\_date()},
\texttt{label\_date\_short()} \&
\texttt{label\_time()}}{label\_date(), label\_date\_short() \& label\_time()}}\label{label_date-label_date_short-label_time}}

\texttt{scales::label\_date()}, \texttt{scales::label\_date\_short()} et
\texttt{scales::label\_time()} peuvent être utilisées pour la mise en
forme de dates.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_date}\NormalTok{()(}\FunctionTok{as.Date}\NormalTok{(}\StringTok{"2020{-}02{-}14"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2020-02-14"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_date}\NormalTok{(}\AttributeTok{format =} \StringTok{"\%d/\%m/\%Y"}\NormalTok{)(}\FunctionTok{as.Date}\NormalTok{(}\StringTok{"2020{-}02{-}14"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "14/02/2020"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_date\_short}\NormalTok{()(}\FunctionTok{as.Date}\NormalTok{(}\StringTok{"2020{-}02{-}14"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "14\nfévr.\n2020"
\end{verbatim}

La mise en forme des dates est un peu complexe. Ne pas hésiter à
consulter le fichier d'aide de la fonction \texttt{base::strptime()}
pour plus d'informations.

\hypertarget{label_wrap}{%
\subsection{\texorpdfstring{\texttt{label\_wrap()}}{label\_wrap()}}\label{label_wrap}}

La fonction \texttt{scales::label\_wrap()} est un peu différente. Elle
permets d'insérer des retours à la ligne (\texttt{\textbackslash{}n})
dans des chaines de caractères. Elle tient compte des espaces pour
identifier les mots et éviter ainsi des coupures au milieu d'un mot.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \StringTok{"Ceci est un texte assez long et que l\textquotesingle{}on souhaiterait afficher sur plusieurs lignes. Cependant, on souhaite éviter que des coupures apparaissent au milieu d\textquotesingle{}un mot."}
\FunctionTok{label\_wrap}\NormalTok{(}\DecValTok{80}\NormalTok{)(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Ceci est un texte assez long et que l'on souhaiterait afficher sur plusieurs\nlignes. Cependant, on souhaite éviter que des coupures apparaissent au milieu\nd'un mot."
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_wrap}\NormalTok{(}\DecValTok{80}\NormalTok{)(x) }\SpecialCharTok{|\textgreater{}} \FunctionTok{message}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Ceci est un texte assez long et que l'on souhaiterait afficher sur plusieurs
lignes. Cependant, on souhaite éviter que des coupures apparaissent au milieu
d'un mot.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{label\_wrap}\NormalTok{(}\DecValTok{40}\NormalTok{)(x) }\SpecialCharTok{|\textgreater{}} \FunctionTok{message}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Ceci est un texte assez long et que
l'on souhaiterait afficher sur
plusieurs lignes. Cependant, on
souhaite éviter que des coupures
apparaissent au milieu d'un mot.
\end{verbatim}

\hypertarget{les-fonctions-de-formatage-de-gtsummary}{%
\section{\texorpdfstring{Les fonctions de formatage de
\texttt{\{gtsummary\}}}{Les fonctions de formatage de \{gtsummary\}}}\label{les-fonctions-de-formatage-de-gtsummary}}

Véritable couteau-suisse du statisticien, le package
\texttt{\{gtsummary\}} sera largement utilisé dans les prochains
chapitres pour produire des tableaux statistiques prêts à être publiés.

Ce package utilise par défaut ses propres fonctions de formatage mais,
au besoin, il sera toujours possible de lui transmettre des fonctions de
formatage créées avec \texttt{\{scales\}}.

\hypertarget{style_number}{%
\subsection{\texorpdfstring{\texttt{style\_number()}}{style\_number()}}\label{style_number}}

Fonction de base, \texttt{gtsummary::style\_number()} accepte les
paramètres \texttt{big.mark} (séparateur de milliers),
\texttt{decimal.mark} (séparateur de décimales) et \texttt{scale}
(facteur d'échelle). Le nombre de décimales se précisera quant à lui
avec \texttt{digits} où l'on indiquera le nombre de décimales souhaité.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gtsummary)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
#Uighur
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{0.123}\NormalTok{, }\FloatTok{0.9}\NormalTok{, }\FloatTok{1.1234}\NormalTok{, }\FloatTok{12.345}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{0.123}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{0.9}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{1.1234}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{132.345}\NormalTok{)}
\FunctionTok{style\_number}\NormalTok{(x, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.1"    "0.9"    "1.1"    "12.3"   "-0.1"   "-0.9"   "-1.1"   "-132.3"
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Nous verrons dans le chapitre sur les statistiques univariées (cf.
Section~\ref{sec-theme-gtsummary}) la fonction
\texttt{gtsummary::theme\_gtsummary\_language()} qui permet de fixer
globalement le séparateur de milliers et celui des décimales, afin de
changer les valeurs par défaut de l'ensemble des fonctions de formatage
de \texttt{\{gtsummary\}}.

Il est important de noter que cela n'a aucun effet sur les fonctions de
formatage de \texttt{\{scales\}}.

\end{tcolorbox}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-caution-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-caution-color}{\faFire}\hspace{0.5em}{Mise en garde}, bottomrule=.15mm, colframe=quarto-callout-caution-color-frame]

\texttt{gtsummary::style\_number()} est directement une fonction de
formatage (comme \texttt{scales::number()}) et non une fonction qui
générère une fonction de formatage (comme
\texttt{scales::label::number()}).

Pour créer une fonction de formatage personnalisée, on pourra avoir
recours à \texttt{purrr::partial()} qui permet d'appeller partiellement
une fonctio et qui renvoie une nouvelle fonction avec des paramètres par
défaut personnalisés.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fr }\OtherTok{\textless{}{-}}\NormalTok{ style\_number }\SpecialCharTok{|\textgreater{}}
\NormalTok{  purrr}\SpecialCharTok{::}\FunctionTok{partial}\NormalTok{(}\AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)}
\FunctionTok{fr}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0,1"    "0,9"    "1,1"    "12,3"   "-0,1"   "-0,9"   "-1,1"   "-132,3"
\end{verbatim}

\end{tcolorbox}

\hypertarget{style_sigfig}{%
\subsection{\texorpdfstring{\texttt{style\_sigfig()}}{style\_sigfig()}}\label{style_sigfig}}

Variante de \texttt{gtsummary::style\_number()},
\texttt{gstummary::style\_sigfig()} arrondi les valeurs transmises pour
n'afficher qu'un nombre choisi de chiffres significatifs. Le nombre de
décimales peut ainsi varier.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{style\_sigfig}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.12"  "0.90"  "1.1"   "12"    "-0.12" "-0.90" "-1.1"  "-132" 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{style\_sigfig}\NormalTok{(x, }\AttributeTok{digits =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.123"  "0.900"  "1.12"   "12.3"   "-0.123" "-0.900" "-1.12"  "-132"  
\end{verbatim}

\hypertarget{style_percent}{%
\subsection{\texorpdfstring{\texttt{style\_percent()}}{style\_percent()}}\label{style_percent}}

La fonction \texttt{gtsummary::style\_percent()} a un fonctionnement un
peu différent de celui de \texttt{scales::label\_percent()}. Par défaut,
le symbole \texttt{\%} n'est pas affiché (mais paramétrable avec
\texttt{symbol\ =\ TRUE}. Par défaut, une décimale est affichée pour les
valeurs inférieures à 10\% et aucune pour celles supérieures à 10\%. Un
symbole \texttt{\textless{}} est ajouté devant les valeurs strictement
positives inférieures à 0,1\%.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.0001}\NormalTok{, }\FloatTok{0.005}\NormalTok{, }\FloatTok{0.01}\NormalTok{, }\FloatTok{0.10}\NormalTok{, }\FloatTok{0.45356}\NormalTok{, }\FloatTok{0.99}\NormalTok{, }\FloatTok{1.45}\NormalTok{)}
\FunctionTok{label\_percent}\NormalTok{(}\AttributeTok{accuracy =}\NormalTok{ .}\DecValTok{1}\NormalTok{)(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0.0%"   "0.0%"   "0.5%"   "1.0%"   "10.0%"  "45.4%"  "99.0%"  "145.0%"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{style\_percent}\NormalTok{(v)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0"    "<0.1" "0.5"  "1.0"  "10"   "45"   "99"   "145" 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{style\_percent}\NormalTok{(v, }\AttributeTok{symbol =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0%"    "<0.1%" "0.5%"  "1.0%"  "10%"   "45%"   "99%"   "145%" 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{style\_percent}\NormalTok{(v, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0"     "0.01"  "0.50"  "1.00"  "10.0"  "45.4"  "99.0"  "145.0"
\end{verbatim}

\hypertarget{style_pvalue}{%
\subsection{\texorpdfstring{\texttt{style\_pvalue()}}{style\_pvalue()}}\label{style_pvalue}}

La fonction \texttt{gtsummary::style\_pvalue()} est similaire à
\texttt{scales::label\_pvalue()} mais adapte le nombre de décimales
affichées,

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{0.000001}\NormalTok{, }\FloatTok{0.023}\NormalTok{, }\FloatTok{0.098}\NormalTok{, }\FloatTok{0.60}\NormalTok{, }\FloatTok{0.9998}\NormalTok{)}
\FunctionTok{label\_pvalue}\NormalTok{()(p)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "<0.001" "0.023"  "0.098"  "0.600"  ">0.999"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{style\_pvalue}\NormalTok{(p)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "<0.001" "0.023"  "0.10"   "0.6"    ">0.9"  
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{style\_pvalue}\NormalTok{(p, }\AttributeTok{prepend\_p =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "p<0.001" "p=0.023" "p=0.10"  "p=0.6"   "p>0.9"  
\end{verbatim}

\hypertarget{style_ratio}{%
\subsection{\texorpdfstring{\texttt{style\_ratio()}}{style\_ratio()}}\label{style_ratio}}

Enfin, \texttt{gtsummary::style\_ratio()} est adaptée à l'affichage de
ratios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{r }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{0.123}\NormalTok{, }\FloatTok{0.9}\NormalTok{, }\FloatTok{1.1234}\NormalTok{, }\FloatTok{12.345}\NormalTok{, }\FloatTok{101.234}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{0.123}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{0.9}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{1.1234}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{12.345}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{101.234}\NormalTok{)}
\FunctionTok{style\_ratio}\NormalTok{(r)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 [1] "0.12"  "0.90"  "1.12"  "12.3"  "101"   "-0.12" "-0.90" "-1.12" "-12.3"
[10] "-101" 
\end{verbatim}

\hypertarget{bonus-signif_stars-de-ggstats}{%
\section{\texorpdfstring{Bonus~: \texttt{signif\_stars()} de
\texttt{\{ggstats\}}}{Bonus~: signif\_stars() de \{ggstats\}}}\label{bonus-signif_stars-de-ggstats}}

La fonction \texttt{ggstats::signif\_stars()} de \texttt{\{ggstats\}}
permet d'afficher des p-valeurs sous forme d'étoiles de significativité,
Par défaut, trois astérisques si p \textless{} 0,001, deux si p
\textless{} 0,01, une si p \textless{} 0,05 et un point si p \textless{}
0,10. Les valeurs sont bien sur paramétrables.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.01}\NormalTok{, }\FloatTok{0.001}\NormalTok{)}
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{signif\_stars}\NormalTok{(p)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] ""    "."   "*"   "**"  "***"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{signif\_stars}\NormalTok{(p, }\AttributeTok{one =}\NormalTok{ .}\DecValTok{15}\NormalTok{, }\AttributeTok{point =} \ConstantTok{NULL}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] ""    "*"   "*"   "**"  "***"
\end{verbatim}

\hypertarget{section}{%
\section{}\label{section}}

\hypertarget{sec-couleurs}{%
\chapter{Couleurs \& Palettes}\label{sec-couleurs}}

Dans les prochains chapitres, notamment lorsque nous ferons des
graphiques, nous aurons besoin de spécier à \textbf{R} les couleurs
souhaitées.

Le choix d'une palette de couleurs adaptée à sa représentation graphique
est également un élément essentiel avec quelques règles de base~: un
dégradé est adpaté pour représentée une variable continue tandis que
pour une variable catégorielle non ordonnée on aura recours à une
palette contrastée.

\hypertarget{noms-de-couleur}{%
\section{Noms de couleur}\label{noms-de-couleur}}

Lorsque l'on doit indiquer à \textbf{R} une couleur, notamment dans les
fonctions graphiques, on peut mentionner certaines couleurs en toutes
lettres (en anglais) comme \texttt{"red"} ou \texttt{"blue"}. La liste
des couleurs reconnues par \textbf{R} est disponible sur
\url{http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{colour =} \StringTok{"red"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"blue"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{manipulation/couleurs_files/figure-pdf/unnamed-chunk-1-1.pdf}

}

\end{figure}

\hypertarget{couleurs-rvb-et-code-hexaduxe9cimal}{%
\section{Couleurs RVB et code
hexadécimal}\label{couleurs-rvb-et-code-hexaduxe9cimal}}

En informatique, les couleurs sont usuellement codées en Rouge/Vert/Bleu
(voir \url{https://fr.wikipedia.org/wiki/Rouge_vert_bleu}) et
représentées par un code hexadécimal à 6 caractères (chiffres 0 à 9
et/ou lettres A à F), précédés du symbole \texttt{\#}. Ce code est
reconnu par \textbf{R}. On pourra par exemple indiquer
\texttt{"\#FF0000"} pour la couleur rouge ou \texttt{"\#666666"} pour un
gris foncé. Le code hexadécimal des différentes couleurs peut s'obtenir
aisément sur internet, de nombreux sites étant consacrés aux palettes de
couleurs.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{colour =} \StringTok{"\#666666"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"\#FF0000"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{manipulation/couleurs_files/figure-pdf/unnamed-chunk-2-1.pdf}

}

\end{figure}

Parfois, au lieu du code hexadécimal, les couleurs RVB sont indiquées
avec trois chiffres entiers compris entre 0 et 255. La conversion en
hexadécimal se fait avec la fonction \texttt{grDevices::rgb()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rgb}\NormalTok{(}\DecValTok{255}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\AttributeTok{maxColorValue =} \DecValTok{255}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "#FF0000"
\end{verbatim}

\hypertarget{palettes-de-couleurs}{%
\section{Palettes de couleurs}\label{palettes-de-couleurs}}

\hypertarget{color-brewer}{%
\subsection{Color Brewer}\label{color-brewer}}

Le projet \textbf{Color Brewer} a développé des palettes
cartographiques, à la fois séquentielles, divergentes et catégorielles,
présentées en détail sur \url{http://colorbrewer2.org/}. Pour chaque
type de palette, et en fonction du nombre de classes, est indiqué sur ce
site si la palette est adaptée aux personnes souffrant de daltonisme, si
elle est rendra correctement sur écran, en cas d'impression couleur et
en cas d'impression en noir et blanc.

Voici un aperçu des différentes palettes disponibles :

\includegraphics{manipulation/couleurs_files/figure-pdf/unnamed-chunk-4-1.pdf}

L'extension \texttt{\{RColorBrewer\}} permets d'accéder à ces palettes
sous \textbf{R}.

Si on utilise \texttt{\{ggplot2\}}, les palettes Color Brewer sont
directement disponibles via les fonctions
\texttt{ggplot2::scale\_fill\_brewer()} et
\texttt{ggplot2::scale\_colour\_brewer()}.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-caution-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-caution-color}{\faFire}\hspace{0.5em}{Mise en garde}, bottomrule=.15mm, colframe=quarto-callout-caution-color-frame]

Les palettes Color Brewer sont seulement implémentées pour des variables
catégorielles. Il est cependant possible de les utiliser avec des
variables continues en les combinants avec
\texttt{ggplot2::scale\_fill\_gradientn()} ou
\texttt{ggplot2::scale\_coulour\_gradientn()} (en remplaçant
\texttt{"Set1"} par le nom de la palette désirée) :

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{scale\_fill\_gradientn}\NormalTok{(}\AttributeTok{values =}\NormalTok{ RColorBrewer}\SpecialCharTok{::}\FunctionTok{brewer.pal}\NormalTok{(}\DecValTok{6}\NormalTok{, }\StringTok{"Set1"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\end{tcolorbox}

\hypertarget{palettes-de-paul-tol}{%
\subsection{Palettes de Paul Tol}\label{palettes-de-paul-tol}}

Le physicien Paul Tol a développé plusieurs palettes de couleurs
adaptées aux personnes souffrant de déficit de perception des couleurs
(daltonisme). À titre personnel, il s'agit des palettes de couleurs que
j'utilise le plus fréquemment.

Le détail de ses travaux est présenté sur
\url{https://personal.sron.nl/~pault/}.

Le pacakge \texttt{\{khroma\}} implémente ces palettes de couleurs
proposées par Paul Tol afin de pouvoir les utilisées directement dans
\textbf{R} et avec \texttt{\{ggplot\}}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(khroma)}
\FunctionTok{plot\_scheme}\NormalTok{(}\FunctionTok{colour}\NormalTok{(}\StringTok{"bright"}\NormalTok{)(}\DecValTok{7}\NormalTok{), }\AttributeTok{colours =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{manipulation/couleurs_files/figure-pdf/unnamed-chunk-6-1.pdf}

}

\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mpg) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ displ, }\AttributeTok{y =}\NormalTok{ hwy, }\AttributeTok{colour =}\NormalTok{ class) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
\NormalTok{  khroma}\SpecialCharTok{::}\FunctionTok{scale\_colour\_bright}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{manipulation/couleurs_files/figure-pdf/unnamed-chunk-6-2.pdf}

}

\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_scheme}\NormalTok{(}\FunctionTok{colour}\NormalTok{(}\StringTok{"muted"}\NormalTok{)(}\DecValTok{9}\NormalTok{), }\AttributeTok{colours =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{manipulation/couleurs_files/figure-pdf/unnamed-chunk-7-1.pdf}

}

\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_scheme}\NormalTok{(}\FunctionTok{colour}\NormalTok{(}\StringTok{"PRGn"}\NormalTok{)(}\DecValTok{9}\NormalTok{), }\AttributeTok{colours =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{manipulation/couleurs_files/figure-pdf/unnamed-chunk-8-1.pdf}

}

\end{figure}

Pour la liste complète des palettes disponibles, voir
\url{https://packages.tesselle.org/khroma/articles/tol.html}.

\hypertarget{interface-unifiuxe9e-avec-paletteer}{%
\subsection{\texorpdfstring{Interface unifiée avec
\texttt{\{paletteer\}}}{Interface unifiée avec \{paletteer\}}}\label{interface-unifiuxe9e-avec-paletteer}}

L'extension \texttt{\{paletteer\}} vise à proposer une interface unifiée
pour l'utilisation de palettes de couleurs fournies par d'autres
packages (dont \texttt{\{khroma\}}, mais aussi par exemple
\texttt{\{ggsci\}} qui fournit les palettes utilisées par certaines
revues scientifiques). Plus de 2~500 palettes sont ainsi disponibles.

On peut afficher un aperçu des principales palettes disponibles dans
\texttt{\{paletteer\}} avec la commande suivante~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gt}\SpecialCharTok{::}\FunctionTok{info\_paletteer}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

Pour afficher la liste complète des palettes discrètes et continues, on
utilisera les commandes suivantes~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{palettes\_d\_names }\SpecialCharTok{|\textgreater{}} \FunctionTok{View}\NormalTok{()}
\NormalTok{palettes\_c\_names }\SpecialCharTok{|\textgreater{}} \FunctionTok{View}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

La fonction \texttt{paletteer::paletteer\_d()} permet d'obtenir les
codes hexadécimaux d'une parlette discrète en précisant le nombre de
couleurs attendues. Les fonctions
\texttt{paletteer::scale\_color\_paletteer\_d()} et
\texttt{paletteer::scale\_fill\_paletteer\_d()} permettront d'utiliser
une palette donnée avec \texttt{\{ggplot2\}}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(paletteer)}
\FunctionTok{paletteer\_d}\NormalTok{(}\StringTok{"khroma::bright"}\NormalTok{, }\AttributeTok{n =} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<colors>
#4477AAFF #EE6677FF #228833FF #CCBB44FF #66CCEEFF 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(mpg) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ displ, }\AttributeTok{y =}\NormalTok{ hwy, }\AttributeTok{colour =}\NormalTok{ class) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_paletteer\_d}\NormalTok{(}\StringTok{"khroma::bright"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{manipulation/couleurs_files/figure-pdf/unnamed-chunk-11-1.pdf}

}

\end{figure}

L'équivalent existe pour les palettes continues, avec
\texttt{paletteer::paletteer\_c()},
\texttt{paletteer::scale\_color\_paletteer\_c()} et
\texttt{paletteer::scale\_fill\_paletteer\_c()} .

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{paletteer\_c}\NormalTok{(}\StringTok{"viridis::viridis"}\NormalTok{, }\AttributeTok{n =} \DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<colors>
#440154FF #414487FF #2A788EFF #22A884FF #7AD151FF #FDE725FF 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Sepal.Length, }\AttributeTok{y =}\NormalTok{ Sepal.Width, }\AttributeTok{colour =}\NormalTok{ Petal.Length) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_colour\_paletteer\_c}\NormalTok{(}\StringTok{"viridis::viridis"}\NormalTok{, }\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{manipulation/couleurs_files/figure-pdf/unnamed-chunk-12-1.pdf}

}

\end{figure}

\part{\textbf{Analyses}}

\hypertarget{sec-ggplot2}{%
\chapter{\texorpdfstring{Graphiques avec
\texttt{ggplot2}}{Graphiques avec ggplot2}}\label{sec-ggplot2}}

Le package \texttt{\{ggplot2\}} fait partie intégrante du
\emph{tidyverse}. Développé par Hadley Wickham, ce package met en œuvre
la grammaire graphique théorisée par Leland Wilkinson. Il devient vite
indispensable lorsque l'on souhaite réaliser des graphiques un peu
complexe.

\hypertarget{ressources}{%
\section{Ressources}\label{ressources}}

Il existe de très nombreuses ressources traitant de
\texttt{\{ggplot2\}}.

Pour une introduction en français, on pourra se référer au chapitre
\href{https://juba.github.io/tidyverse/08-ggplot2.html}{Visualiser avec
ggplot2} de l'\emph{Introduction à R et au tidyverse} de Julien Barnier,
au chapitre
\href{https://larmarange.github.io/analyse-R/intro-ggplot2.html}{Introduction
à ggplot2, la grammaire des graphiques} du site \emph{analyse-R} et
adapté d'une séance de cours de François Briatte, ou encore au chapitre
\href{http://egallic.fr/Enseignement/R/m1_stat_eco_logiciel_R.pdf}{Graphiques}
du cours \emph{Logiciel R et programmation} d'Ewen Gallic.

Pour les anglophones, la référence reste encore l'ouvrage \emph{ggplot2:
Elegant Graphics for Data Analysis} d'Hadley Wickham lui-même, dont la
troisième édition est librement accessible en ligne
(\url{https://ggplot2-book.org/}). D'un point de vue pratique, l'ouvrage
\emph{R Graphics Cookbook: practical recipes for visualizing data} de
Winston Chang est une mine d'informations, ouvrage là encore librement
accessible en ligne (\url{https://r-graphics.org/}).

\hypertarget{les-bases-de-ggplot2}{%
\section{\texorpdfstring{Les bases de
\texttt{ggplot2}}{Les bases de ggplot2}}\label{les-bases-de-ggplot2}}

\texttt{\{ggplot2\}} nécessite que les données du graphique soient sous
la forme d'un tableau de données (\emph{data.frame} ou \emph{tibble}) au
format \emph{tidy}, c'est-à-dire avec une ligne par observation et les
différentes valeurs à représenter sous forme de variables du tableau.

\begin{figure}

{\centering \includegraphics{analyses/ressources/ggplot-grammar-of-graphics.png}

}

\caption{\label{fig-grammaire-graphiques}La grammaire des graphiques}

\end{figure}

Tous les graphiques avec \texttt{\{ggplot2\}} suivent une même logique.
En \textbf{premier} lieu, on appelera la fonction
\texttt{ggplot2::ggplot()} en lui passant en paramètre le fichier de
données.

\texttt{\{ggplot2\}} nomme \emph{esthétiques} les différentes propriétés
visuelles d'un graphique, à savoir l'axe des x (\texttt{x}), celui des y
(\texttt{y}), la couleur des lignes (\texttt{colour}), celle de
remplissage des polygones (\texttt{fill}), le type de lignes
(\texttt{linetype}), la forme des points (\texttt{shape}), etc. Une
représentation graphique consiste donc à représenter chacune de nos
variables d'intérêt selon une esthétique donnée. En \textbf{second}
lieu, on appelera donc la fonction \texttt{ggplot2::aes()} pour indiquer
la correspondance entre les variables de notre fichier de données et les
esthétiques du graphique.

A minima, il est nécessaire d'indiquer en \textbf{troisième} lieu une
\emph{géométrie}, autrement dit la manière dont les éléments seront
représentés visuellement. À chaque géométrie corresponds une fonction
commençant par \texttt{geom\_}, par exemple
\texttt{ggplot2::geom\_point()} pour dessiner des points,
\texttt{ggplot2::geom\_line()} pour des lignes,
\texttt{ggplot2::geom\_bar()} pour des barres ou encore
\texttt{ggplot2::geom\_area()} pour des aires. Il existe de nombreuses
géométries différentes\sidenote{\footnotesize On trouvera une liste dans la
  \emph{cheat sheet} de \texttt{\{ggplot2\}}, voir
  Section~\ref{sec-cheatsheet-ggplot2}.}, chacune prenant en compte
certaines esthétiques, certaines étant requises pour cette géométrie et
d'autres optionnelles. La liste des esthétiques prises en compte par
chaque géométrie est indiquée dans l'aide en ligne de cette dernière.

Voici un exemple minimal de graphique avec \texttt{\{ggplot2\}}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\NormalTok{p }\OtherTok{\textless{}{-}} 
  \FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ Petal.Length, }
    \AttributeTok{y =}\NormalTok{ Petal.Width, }
    \AttributeTok{colour =}\NormalTok{ Species}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{()}
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/ggplot2_files/figure-pdf/fig-exemple-simple-ggplot2-1.pdf}

}

\caption{\label{fig-exemple-simple-ggplot2}Un exemple simple de nuage de
points avec \texttt{ggplot2}}

\end{figure}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Syntaxe additive}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

Le développement de \texttt{\{ggplot2\}} a débuté avant celui du
\emph{tidyverse} et la généralisation du \emph{pipe}. Dès lors, on ne
sera pas étonné que la syntaxe de \texttt{\{ggplot2\}} n'ait pas recours
à ce dernier mais repose sur une approche \emph{additive}. Un graphique
est dès lors initialisé avec la fonction \texttt{ggplot2::ggplot()} et
l'on ajoutera successivement des éléments au graphique en appelant
différentes fonctions et en utilisant l'opérateur \texttt{+}.

\end{tcolorbox}

Il est ensuite possible de personnaliser de nombreux éléments d'un
graphique et notamment~:

\begin{itemize}
\tightlist
\item
  les \emph{étiquettes} ou \emph{labs} (titre, axes, légendes) avec
  \texttt{ggplot2::ggtitle()}, \texttt{ggplot2::xlab()},
  \texttt{ggplot2::ylab()} ou encore la fonction plus générique
  \texttt{ggplot2::labs()}~;
\item
  les \emph{échelles} (\emph{scales}) des différentes esthétiques avec
  les fonctions commençant par \texttt{scale\_}~;
\item
  le système de \emph{coordonnées} avec les fonctions commençant par
  \texttt{coord\_}~;
\item
  les \emph{facettes} (\emph{facets}) avec les fonctions commençant par
  \texttt{facet\_}~;
\item
  la \emph{légende} (\emph{guides}) avec les fonctions commençant par
  \texttt{guide\_}~;
\item
  le \emph{thème} du graphiques (mise en forme des différents éléments)
  avec \texttt{ggplot2::theme()}.
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{x =} \StringTok{"Longueur du pétale"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Largeur du pétale"}\NormalTok{,}
    \AttributeTok{colour =} \StringTok{"Espèce"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}
    \StringTok{"Relation entre longueur et largeur des pétales"}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"Jeu de données Iris"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{7}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{coord\_equal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\AttributeTok{cols =} \FunctionTok{vars}\NormalTok{(Species)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}
    \AttributeTok{color =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{nrow =} \DecValTok{2}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face =} \StringTok{"bold"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/ggplot2_files/figure-pdf/fig-exemple-avance-ggplot2-1.pdf}

}

\caption{\label{fig-exemple-avance-ggplot2}Un exemple avancé de nuage de
points avec \texttt{ggplot2}}

\end{figure}

Pour visualiser chaque étape du code, vous pouvez consulter le diaporama
suivant~:
\url{https://larmarange.github.io/guide-R/analyses/ressources/flipbook-ggplot2.html}

\hypertarget{sec-cheatsheet-ggplot2}{%
\section{Cheatsheet}\label{sec-cheatsheet-ggplot2}}

\begin{figure}

{\centering 

\href{https://github.com/rstudio/cheatsheets/raw/main/data-visualization-2.1.pdf}{\includegraphics{analyses/ressources/data-visualization-cheatsheet-thumbs.png}}

}

\caption{\label{fig-cheatsheet-ggplot2}Cheatsheet ggplot2}

\end{figure}

\hypertarget{sec-esquisse}{%
\section{\texorpdfstring{Exploration visuelle avec
\texttt{esquisse}}{Exploration visuelle avec esquisse}}\label{sec-esquisse}}

Le package \texttt{\{esquisse\}} propose un \emph{addin} offrant une
interface visuelle pour la création de graphiques \texttt{\{ggplot2\}}.
Après installation du package, on pourra lancer \texttt{\{esquisse\}}
directement à partir du menu \emph{addins} de \textbf{RStudio}.

\begin{figure}

{\centering \includegraphics{analyses/ressources/esquisse-launch-addin.png}

}

\caption{\label{fig-lancement-esquisse}Lancement d'\texttt{esquisse} à
partir du menu \emph{Addins} de \textbf{RStudio}}

\end{figure}

Au lancement de l'\emph{addin}, une interface permettra de choisir le
tableau de données à partir duquel générer le graphique. Le plus simple
est de choisir un tableau présent dans l'environnement. Mais
\texttt{\{esquisse\}} offre aussi la possibilité d'importer des fichiers
externes, voir de procéder à quelques modificatiosn des données.

\begin{figure}

{\centering \includegraphics{analyses/ressources/esquisse-import-data.png}

}

\caption{\label{fig-esquisse-import-donnees}Import de données au
lancement d'\texttt{esquisse}}

\end{figure}

Le principe général d'\texttt{\{esquisse\}} consiste à associer des
variables à des esthétiques par glisser/déposer\sidenote{\footnotesize Si une
  esthétique n'est pas visible à l'écran, on pourra cliquer en haut à
  droite sur l'icône en forme de roue dentée afin de choisir d'afficher
  plus d'esthétiques.}. L'outil déterminera automatiquement une
géométrie adaptée en fonction de la nature des variables (continues ou
catgéorielles). Un clic sur le nom de la géométrie en haut à gauche
permet de sélectionner une autre géométrie.

\begin{figure}

{\centering \includegraphics{analyses/ressources/esquisse-geometries.png}

}

\caption{\label{fig-esquisse-géométrie}Choix d'une géométrie dans
\texttt{esquisse}}

\end{figure}

Les menus situés en bas de l'écran permettent d'ajouter/modifier des
étiquettes, de modifier certaines options du graphiques, de modifier les
échelles de couleurs et l'apparence du graphique, et de filtrer les
observations inclues dans le graphique.

Le menu \textbf{Code} permet de récupérer le code correspondant au
graphique afin de pouvoir le copier/coller dans un script.

\begin{figure}

{\centering \includegraphics{analyses/ressources/esquisse-controls-code.png}

}

\caption{\label{fig-esquisse-code}Obtenir le code du graphique obtenu
avec \texttt{esquisse}}

\end{figure}

\texttt{\{esquisse\}} offre également la possibilité d'exporter le
graphique obtenu dans différents formats.

\hypertarget{webin-r-4}{%
\section{webin-R}\label{webin-r-4}}

L'utilisation d'\texttt{\{esquisse\}} est présentée dans le webin-R \#03
(\emph{statistiques descriptives avec gtsummary et esquisse}) sur
\href{https://youtu.be/oEF_8GXyP5c?t=2620}{YouTube}.

\url{https://youtu.be/oEF_8GXyP5c}

\texttt{\{ggplot2\}} est abordé plus en détails dans le webin-R \#08
(\emph{ggplot2 et la grammaire des graphiques}) sur
\href{https://youtu.be/msnwENny_cg}{YouTube}.

\url{https://youtu.be/msnwENny_cg}

\hypertarget{combiner-plusieurs-graphiques}{%
\section{Combiner plusieurs
graphiques}\label{combiner-plusieurs-graphiques}}

Plusieurs packages proposent des fonctions pour combiner ensemble des
graphiques \texttt{\{ggplot2\}}, comme \texttt{\{patchwork\}},
\texttt{\{ggpubr\}}, \texttt{\{egg\}} ou \texttt{\{cowplot\}}. Ici, nous
privilégierons le package \texttt{\{patchwork\}} car, bien qu'il ne
fasse pas partie du \emph{tidyverse}, est développé et maintenant par
les mêmes auteurs que \texttt{\{ggplot2\}}.

Commençons par créer quelques graphiques avec \texttt{\{ggplot2\}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(mtcars) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ wt, }\AttributeTok{y =}\NormalTok{ mpg) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{()}
\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(mtcars) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{factor}\NormalTok{(cyl)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{()}
\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(mtcars) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{factor}\NormalTok{(cyl), }\AttributeTok{y =}\NormalTok{ mpg) }\SpecialCharTok{+}
  \FunctionTok{geom\_violin}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{))}
\NormalTok{p4 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(mtcars) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{factor}\NormalTok{(cyl), }\AttributeTok{y =}\NormalTok{ mpg) }\SpecialCharTok{+} 
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\ConstantTok{NULL}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Le symbole \texttt{+} permet de combiner des graphiques entre eux. Le
package \texttt{\{patchwork\}} déterminera le nombre de lignes et de
colonnes en fonction du nombre de graphiques. On pourra noter que les
axes des graphiques sont alignés les uns par rapports aux autres.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(patchwork)}
\NormalTok{p1 }\SpecialCharTok{+}\NormalTok{ p2 }\SpecialCharTok{+}\NormalTok{ p3 }\SpecialCharTok{+}\NormalTok{ p4}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/ggplot2_files/figure-pdf/unnamed-chunk-4-1.pdf}

}

\end{figure}

Les symboles \texttt{\textbar{}} et \texttt{/} permettent d'indiquer une
disposition côte à côte ou les uns au-dessus des autres.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\SpecialCharTok{|}\NormalTok{ p2 }\SpecialCharTok{|}\NormalTok{ p3}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/ggplot2_files/figure-pdf/unnamed-chunk-5-1.pdf}

}

\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\SpecialCharTok{/}\NormalTok{ p2}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/ggplot2_files/figure-pdf/unnamed-chunk-6-1.pdf}

}

\end{figure}

On peut utiliser les parenthèses pour indiquer des arrangements plus
complexes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(p1 }\SpecialCharTok{+}\NormalTok{ p2) }\SpecialCharTok{/}\NormalTok{ p3}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/ggplot2_files/figure-pdf/unnamed-chunk-7-1.pdf}

}

\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(p1 }\SpecialCharTok{+}\NormalTok{ p2) }\SpecialCharTok{|}\NormalTok{ p3}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/ggplot2_files/figure-pdf/unnamed-chunk-8-1.pdf}

}

\end{figure}

Si l'on a une liste de graphiques, on pourra appeler
\texttt{patchwork::wrap\_plots()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{list}\NormalTok{(p1, p2, p3, p4) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{wrap\_plots}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/ggplot2_files/figure-pdf/unnamed-chunk-9-1.pdf}

}

\end{figure}

La fonction \texttt{patchwork::plot\_layout()} permet de controler les
hauteurs / largeurs relatives des lignes / colonnes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\SpecialCharTok{+}\NormalTok{ p2 }\SpecialCharTok{+}\NormalTok{ p3 }\SpecialCharTok{+}\NormalTok{ p4 }\SpecialCharTok{+} \FunctionTok{plot\_layout}\NormalTok{(}\AttributeTok{widths =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/ggplot2_files/figure-pdf/unnamed-chunk-10-1.pdf}

}

\end{figure}

On peut également ajouter un titre ou des étiquettes avec
\texttt{patchwork::plot\_annotation()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\SpecialCharTok{+}\NormalTok{ p2 }\SpecialCharTok{+}\NormalTok{ p3 }\SpecialCharTok{+}\NormalTok{ p4 }\SpecialCharTok{+}
  \FunctionTok{plot\_annotation}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Titre du graphique"}\NormalTok{,}
    \AttributeTok{subtitle =} \StringTok{"sous{-}titre"}\NormalTok{,}
    \AttributeTok{caption =} \StringTok{"notes additionelles"}\NormalTok{,}
    \AttributeTok{tag\_levels =} \StringTok{"a"}\NormalTok{,}
    \AttributeTok{tag\_suffix =} \StringTok{"."}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/ggplot2_files/figure-pdf/unnamed-chunk-11-1.pdf}

}

\end{figure}

\hypertarget{sec-statistique-univariee}{%
\chapter{Statistique univariée \& Intervalles de
confiance}\label{sec-statistique-univariee}}

On entend par statistique univariée l'étude d'une seule variable, que
celle-ci soit continue (quantitative) ou catégorielle (qualitative). La
statistique univariée fait partie de la statistique descriptive.

\hypertarget{exploration-graphique}{%
\section{Exploration graphique}\label{exploration-graphique}}

Une première approche consiste à explorer visuelle la variable
d'intérêt, notamment à l'aide de l'interface proposée par
\texttt{\{esquisse\}} (cf Section~\ref{sec-esquisse}).

Nous indiquons ci-après le code correspond aux graphiques
\texttt{\{ggplot2\}} les plus courants.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\end{Highlighting}
\end{Shaded}

\hypertarget{variable-continue}{%
\subsection{Variable continue}\label{variable-continue}}

Un histogramme est la représentation graphique la plus commune pour
représenter la distribution d'une variable, par exemple ici la longueur
des pétales (variable \texttt{Petal.Length}) du fichier de données
\texttt{datasets::iris}. Il s'obtient avec la géométrie
\texttt{ggplot2::geom\_histogram()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
\end{verbatim}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-univariee_files/figure-pdf/fig-histogramme-simple-1.pdf}

}

\caption{\label{fig-histogramme-simple}un histogramme simple}

\end{figure}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Il faut noter qu'il nous a suffit d'associer simplement la variable
\texttt{Petal.Length} à l'esthétique \textbf{x}, sans avoir eu besoin
d'indiquer une variable pour l'esthétique \textbf{y}.

En fait, \texttt{\{ggplot2\}} associe par défaut à toute géométrie une
certaine statistique. Dans le cas de
\texttt{ggplot2::geom\_histogram()}, il s'agit de la statistique
\texttt{ggplot2::stat\_bin()} qui divise la variable continue en classes
de même largeur et compte le nombre d'observation dans chacunes.
\texttt{ggplot2::stat\_bin()} renvoie un certain nombre de variables
calculées (la liste complète est indiquée dans la documentation dans la
section \emph{Compute variables}), dont la variable \texttt{count} qui
correspond au nombre d'observations la classe. On peut associer cette
variable calculée à une esthétique grace à la fonction
\texttt{ggplot2::after\_stat()}, par exemple
\texttt{aes(y\ =\ after\_stat(count))}. Dans le cas présent, ce n'est
pas nécessaire car \texttt{\{ggplot2\}} fait cette association
automatiquement si l'on n'a pas déjà attribué une variable à
l'esthétique \textbf{y}.

\end{tcolorbox}

On peut personnaliser la couleur de remplissage des rectangles en
indiquant une valeur fixe pour l'esthétique \texttt{fill} dans l'appel
de \texttt{ggplot2::geom\_histogram()} (et non via la fonction
\texttt{ggplot2::aes()} puisqu'il ne s'agit pas d'une variable du
tableau de données). L'esthétique \texttt{colour} permet de spécifier la
couleur du trait des rectangles. Enfin, le paramètre \texttt{binwidth}
permet de spécifier la largeur des barres.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{(}
    \AttributeTok{fill =}\StringTok{"lightblue"}\NormalTok{, }
    \AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }
    \AttributeTok{binwidth =} \DecValTok{1}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Longeur du pétale"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Effectifs"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-univariee_files/figure-pdf/fig-histogramme-personnalise-1.pdf}

}

\caption{\label{fig-histogramme-personnalise}un histogramme
personnalisé}

\end{figure}

On peut alternativement indiquer un nombre de classes avec
\texttt{bins}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{bins =} \DecValTok{10}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-univariee_files/figure-pdf/fig-histogramme-10-classes-1.pdf}

}

\caption{\label{fig-histogramme-10-classes}un histogramme en 10 classes}

\end{figure}

Une représentation alternative de la distribution d'une variable peut
être obtenue avec une courbe de densité, dont la particularité est
d'avoir une surface sous la courbe égale à 1. Une telle courbe s'obtient
avec \texttt{ggplot2::geom\_density()}. Le paramètre \texttt{adjust}
permet d'ajuster le niveau de lissage de la courbe.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length) }\SpecialCharTok{+}
  \FunctionTok{geom\_density}\NormalTok{(}\AttributeTok{adjust =}\NormalTok{ .}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-univariee_files/figure-pdf/fig-courbe-densite-1.pdf}

}

\caption{\label{fig-courbe-densite}une courbe de densité}

\end{figure}

\hypertarget{sec-graph-univ-var-cat}{%
\subsection{Variable catégorielle}\label{sec-graph-univ-var-cat}}

Pour représenter la répartition des effectifs parmi les modalités d'une
variable catégorielle, on a souvent tendance à utiliser des diagrammes
en secteurs (camemberts). Or, ce type de représentation graphique est
très rarement appropriée~: l'oeil humain préfère comparer des longueurs
plutôt que des surfaces\sidenote{\footnotesize Voir en particulier
  \url{https://www.data-to-viz.com/caveat/pie.html} pour un exemple
  concret.}.

Dans certains contextes ou pour certaines présentations, on pourra
éventuellement considérer un diagramme en donut, mais le plus souvent,
rien ne vaut un bon vieux diagramme en barres avec
\texttt{ggplot2::geom\_bar()}. Prenons pour l'exemple la variable
\texttt{occup} du jeu de données \texttt{hdv2003} du package
\texttt{\{questionr\}}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"hdv2003"}\NormalTok{, }\AttributeTok{package =} \StringTok{"questionr"}\NormalTok{)}
\FunctionTok{ggplot}\NormalTok{(hdv2003) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ occup) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-univariee_files/figure-pdf/fig-diag-barres-simple-1.pdf}

}

\caption{\label{fig-diag-barres-simple}un diagramme en barres simple}

\end{figure}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Là encore, \texttt{\{ggplot2\}} a calculé de lui-même le nombre
d'observations de chaque modalité, en utilisant cette fois la
statistique \texttt{ggplot2::stat\_count()}.

\end{tcolorbox}

Si l'on souhaite représenter des pourcentages plutôt que des effectifs,
le plus simple est d'avoir recours à la statistique
\texttt{ggstats::stat\_prop()} du package
\texttt{\{ggstats\}}\sidenote{\footnotesize Cette statistique est également disponible
  via le package \texttt{\{GGally\}}.}. Pour appeler cette statistique,
on utilisera simplement \texttt{stat\ =\ "prop"} dans les géométries
concernées.

Cette statistique, qui sera également bien utile pour des graphiques
plus complexes, nécessite qu'on lui indique une esthétique \textbf{by}
pour dans quels sous-groupes calculés des proportions. Ici, nous avons
un seul groupe considéré et nous souhaitons des pourcentages du total.
On indiquera simplement \texttt{by\ =\ 1}.

Pour formater l'axe vertical avec des pourcentages, on pourra avoir
recours à la fonction \texttt{scales::label\_percent()} que l'on
appelera via \texttt{ggplot2::scale\_y\_continuous()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggstats)}
\FunctionTok{ggplot}\NormalTok{(hdv2003) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ occup, }\AttributeTok{y =} \FunctionTok{after\_stat}\NormalTok{(prop), }\AttributeTok{by =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"prop"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-univariee_files/figure-pdf/fig-diag-barres-personalise-1.pdf}

}

\caption{\label{fig-diag-barres-personalise}un diagramme en barres
épuré}

\end{figure}

Pour une publication ou une communication, il ne faut surtout pas
hésiter à \textbf{épurer} vos graphiques (\emph{less is better!}), voire
à trier les modalités en fonction de leur fréquence pour faciliter la
lecture (ce qui se fait aisément avec \texttt{forcats::fct\_infreq()}).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(hdv2003) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ forcats}\SpecialCharTok{::}\FunctionTok{fct\_infreq}\NormalTok{(occup), }
      \AttributeTok{y =} \FunctionTok{after\_stat}\NormalTok{(prop), }\AttributeTok{by =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"prop"}\NormalTok{, }
           \AttributeTok{fill =} \StringTok{"\#4477AA"}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}
    \FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{after\_stat}\NormalTok{(prop) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{          scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(}\AttributeTok{accuracy =}\NormalTok{ .}\DecValTok{1}\NormalTok{)),}
    \AttributeTok{stat =} \StringTok{"prop"}\NormalTok{,}
    \AttributeTok{nudge\_y =}\NormalTok{ .}\DecValTok{02}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\ConstantTok{NULL}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{ylab}\NormalTok{(}\ConstantTok{NULL}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Occupation des personnes enquêtées"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-univariee_files/figure-pdf/fig-diag-barres-epure-1.pdf}

}

\caption{\label{fig-diag-barres-epure}un diagramme en barres épuré}

\end{figure}

Pour visualiser chaque étape du code, vous pouvez consulter le diaporama
suivant~:
\url{https://larmarange.github.io/guide-R/analyses/ressources/flipbook-geom_bar-univarie.html}

\hypertarget{sec-tri-a-plat}{%
\section{Tableaux et tris à plat}\label{sec-tri-a-plat}}

Le package \texttt{\{gtsummary\}} constitue l'une des boites à outils de
l'analyste quantitativiste, car il permet de réaliser très facilement
des tableaux quasiment publiables en l'état. En matière de statistique
univarisée, la fonction clé est \texttt{gtsummary::tbl\_summary()}.

Commençons avec un premier exemple rapide. On part d'un tableau de
données et on indique, avec l'argument \texttt{include}, les variables à
afficher dans le tableau statistique (si on n'indique rien, toutes les
variables du tableau de données sont considérées). Il faut noter que
l'argument \texttt{include} de \texttt{gtsummary::tbl\_summary()}
utilise la même syntaxe dite \emph{tidy select} que
\texttt{dplyr::select()} (cf. Section~\ref{sec-dplyr-select}). On peut
indiquer tout autant des variables catégorielles que des variables
continues.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gtsummary)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
#BlackLivesMatter
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}\AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, occup))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-tableau-simple}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-tableau-simple}un tableau simple}\tabularnewline
\toprule()
\textbf{Characteristic} & \textbf{N = 2,000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Characteristic} & \textbf{N = 2,000} \\
\midrule()
\endhead
age & 48 (35, 60) \\
occup & \\
Exerce une profession & 1,049 (52\%) \\
Chomeur & 134 (6.7\%) \\
Etudiant, eleve & 94 (4.7\%) \\
Retraite & 392 (20\%) \\
Retire des affaires & 77 (3.9\%) \\
Au foyer & 171 (8.6\%) \\
Autre inactif & 83 (4.2\%) \\
\bottomrule()
\end{longtable}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Remarque sur les types de variables et les sélecteurs associés}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

\texttt{\{gtsummary\}} permets de réaliser des tableaux statistiques
combinant plusieurs variables, l'affichage des résultats pouvant
dépendre du type de variables.

Par défaut, \texttt{\{gtsummary\}} considère qu'une variable est
\textbf{catégorielle} s'il s'agit d'un facteur, d'une variable textuelle
ou d'une variable numérique ayant moins de 10 valeurs différentes.

Une variable sera considérée comme \textbf{dichotomique} (variable
catégorielle à seulement deux modalités) s'il s'agit d'un vecteur
logique (\texttt{TRUE}/\texttt{FALSE}), d'une variable textuelle codée
\texttt{yes}/\texttt{no} ou d'une variable numérique codée
\texttt{0}/\texttt{1}.

Dans les autres cas, une variable numérique sera considérée comme
\textbf{continue}.

Si vous utilisez des vecteurs labellisés (cf.
Chapitre~\ref{sec-etiquettes-valeurs}), vous devez les convertir, en
amont, en facteurs ou en variables numériques. Voir l'extension
\texttt{\{labelled\}} et les fonctions \texttt{labelled::to\_factor()},
\texttt{labelled::unlabelled()} et \texttt{unclass()}.

Au besoin, il est possible de forcer le type d'une variable avec
l'argument \texttt{type} de \texttt{gtsummary::tbl\_summary()}.

\texttt{\{gtsummary\}} fournit des sélecteurs qui peuvent être utilisés
dans les options des différentes fonctions, en particulier
\texttt{gtsummary::all\_continuous()} pour les variables continues,
\texttt{gtsummary::all\_dichotolous()} pour les variables dichotomiques
et \texttt{gtsummary::all\_categorical()} pour les variables
catégorielles. Cela inclue les variables dichotomiques. Il faut utiliser
\texttt{all\_categorical(dichotomous\ =\ FALSE)} pour sélectionner les
variables catégorielles en excluant les variables dichotomiques.

\end{tcolorbox}

\hypertarget{sec-theme-gtsummary}{%
\subsection{Thème du tableau}\label{sec-theme-gtsummary}}

\texttt{\{gtsummary\}} fournit plusieurs fonctions préfixées
\texttt{theme\_gtsummary\_*()} permettant de modifier l'affichage par
défaut des tableaux. Vous aurez notez que, par défaut,
\texttt{\{gtsummary\}} est anglophone.

La fonction \texttt{gtsummary::theme\_gtsummary\_journal()} permets
d'adopter les standards de certaines grandes revues scientifiques telles
que \emph{JAMA} (\emph{Journal of the American Medical Association}),
\emph{The Lancet} ou encore le \emph{NEJM} (\emph{New England Journal of
Medicine}).

La fonction \texttt{gtsummary::theme\_gtsummary\_language()} permet de
modifier la langue utilisée par défaut dans les tableaux. Les options
\texttt{decimal.mark} et \texttt{big.mark} permettent de définir
respectivement le séparateur de décimales et le séparateur des milliers.
Ainsi, pour présenter un tableau en français, on appliquera en début de
script~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{theme\_gtsummary\_language}\NormalTok{(}
  \AttributeTok{language =} \StringTok{"fr"}\NormalTok{, }
  \AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{, }
  \AttributeTok{big.mark =} \StringTok{" "}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Setting theme `language: fr`
\end{verbatim}

Ce thème sera appliqué à tous les tableaux ultérieurs.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}\AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, occup))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-tableau-simple-fr}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-tableau-simple-fr}un tableau simple en
français}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
age & 48 (35 -- 60) \\
occup & \\
Exerce une profession & 1 049 (52\%) \\
Chomeur & 134 (6,7\%) \\
Etudiant, eleve & 94 (4,7\%) \\
Retraite & 392 (20\%) \\
Retire des affaires & 77 (3,9\%) \\
Au foyer & 171 (8,6\%) \\
Autre inactif & 83 (4,2\%) \\
\bottomrule()
\end{longtable}

\hypertarget{uxe9tiquettes-des-variables}{%
\subsection{Étiquettes des
variables}\label{uxe9tiquettes-des-variables}}

\texttt{gtsummary}, par défaut, prends en compte les étiquettes de
variables (cf. Chapitre~\ref{sec-etiquettes-variables}), si elles
existent, et sinon utilisera le nom de chaque variable dans le tableau.
Pour rappel, les étiquettes de variables peuvent être manipulées avec
l'extension \texttt{\{labelled\}} et les fonctions
\texttt{labelled::var\_label()} et
\texttt{labelled::set\_variable\_labels()}.

Il est aussi possible d'utiliser l'option \texttt{label} de
\texttt{gtsummary::tbl\_summary()} pour indiquer des étiquettes
personnalisées.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  labelled}\SpecialCharTok{::}\FunctionTok{set\_variable\_labels}\NormalTok{(}
    \AttributeTok{occup =} \StringTok{"Occupation actuelle"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, occup, heures.tv),}
    \AttributeTok{label =} \FunctionTok{list}\NormalTok{(age }\SpecialCharTok{\textasciitilde{}} \StringTok{"Âge médian"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-tableau-etiquette}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-tableau-etiquette}un tableau
étiquetté}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
Âge médian & 48 (35 -- 60) \\
Occupation actuelle & \\
Exerce une profession & 1 049 (52\%) \\
Chomeur & 134 (6,7\%) \\
Etudiant, eleve & 94 (4,7\%) \\
Retraite & 392 (20\%) \\
Retire des affaires & 77 (3,9\%) \\
Au foyer & 171 (8,6\%) \\
Autre inactif & 83 (4,2\%) \\
heures.tv & 2,00 (1,00 -- 3,00) \\
Manquant & 5 \\
\bottomrule()
\end{longtable}

Pour modifier les modalités d'une variable catégorielle, il faut
modifier en amont les niveaux du facteur correspondant.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Remarque sur la syntaxe des options}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

De nombreuses options des fonctions de \texttt{\{gtsummary\}} peuvent
s'appliquer seulement à une ou certaines variables. Pour ces options-là,
\texttt{\{gtsummary\}} attends une formule de la forme
\texttt{variables\ concernées\ \textasciitilde{}\ valeur\ de\ l\textquotesingle{}option}
ou bien une liste de formules ayant cette forme.

Par exemple, pour modifier l'étiquette associée à une certaine variable,
on peut utiliser l'option \texttt{label} de
\texttt{gtsummary::tbl\_summary()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}\AttributeTok{label =}\NormalTok{ age }\SpecialCharTok{\textasciitilde{}} \StringTok{"Âge"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Lorsque l'on souhaite passer plusieurs options pour plusieurs variables
différentes, on utilisera une \texttt{list()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}\AttributeTok{label =} \FunctionTok{list}\NormalTok{(age }\SpecialCharTok{\textasciitilde{}} \StringTok{"Âge"}\NormalTok{, trt }\SpecialCharTok{\textasciitilde{}} \StringTok{"Traitement"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\texttt{\{gtsummary\}} est très flexible sur la manière d'indiquer la ou
les variables concernées. Il peut s'agir du nom de la variable, d'une
chaîne de caractères contenant le nom de la variable, ou d'un vecteur
contenant le nom de la variable. Les syntaxes ci-dessous sont ainsi
équivalentes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}\AttributeTok{label =}\NormalTok{ age }\SpecialCharTok{\textasciitilde{}} \StringTok{"Âge"}\NormalTok{)}
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}\AttributeTok{label =} \StringTok{"age"} \SpecialCharTok{\textasciitilde{}} \StringTok{"Âge"}\NormalTok{)}
\NormalTok{v }\OtherTok{\textless{}{-}} \StringTok{"age"}
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}\AttributeTok{label =}\NormalTok{ v }\SpecialCharTok{\textasciitilde{}} \StringTok{"Âge"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Pour appliquer le même changement à plusieurs variables, plusieurs
syntaxes sont acceptées pour lister plusieurs variables.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}\AttributeTok{label =} \FunctionTok{c}\NormalTok{(}\StringTok{"age"}\NormalTok{, }\StringTok{"trt"}\NormalTok{) }\SpecialCharTok{\textasciitilde{}} \StringTok{"Une même étiquette"}\NormalTok{)}
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}\AttributeTok{label =} \FunctionTok{c}\NormalTok{(age, trt) }\SpecialCharTok{\textasciitilde{}} \StringTok{"Une même étiquette"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Il est également possible d'utiliser la syntaxe \texttt{\{tidyselect\}}
et les sélecteurs de \texttt{\{tidyselect\}} comme
\texttt{tidyselect::everything()}, \texttt{tidyselect::starts\_with()},
\texttt{tidyselect::contains()} ou \texttt{tidyselect::all\_of()}. Ces
différents sélecteurs peuvent être combinés au sein d'un \texttt{c()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{label =} \FunctionTok{everything}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"Une même étiquette"}
\NormalTok{  )}
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{label =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"a"}\NormalTok{) }\SpecialCharTok{\textasciitilde{}} \StringTok{"Une même étiquette"}
\NormalTok{  )}
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{label =} \FunctionTok{c}\NormalTok{(}\FunctionTok{everything}\NormalTok{(), }\SpecialCharTok{{-}}\NormalTok{age, }\SpecialCharTok{{-}}\NormalTok{trt) }\SpecialCharTok{\textasciitilde{}} \StringTok{"Une même étiquette"}
\NormalTok{  )}
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{label =}\NormalTok{ age}\SpecialCharTok{:}\NormalTok{trt }\SpecialCharTok{\textasciitilde{}} \StringTok{"Une même étiquette"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

Bien sûr, il est possible d'utiliser les sélecteurs propres à
\texttt{\{gtsummary\}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{label =} \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"Une même étiquette"}
\NormalTok{  )}
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{label =} \FunctionTok{list}\NormalTok{(}
      \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"Variable continue"}\NormalTok{,}
      \FunctionTok{all\_dichotomous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"Variable dichotomique"}\NormalTok{,}
      \FunctionTok{all\_categorical}\NormalTok{(}\AttributeTok{dichotomous =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{\textasciitilde{}} \StringTok{"Variable catégorielle"}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

Enfin, si l'on ne précise rien à gauche du \texttt{\textasciitilde{}},
ce sera considéré comme équivalent à \texttt{everything()}. Les deux
syntaxes ci-dessous sont donc équivalentes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}\AttributeTok{label =} \SpecialCharTok{\textasciitilde{}} \StringTok{"Une même étiquette"}\NormalTok{)}
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{label =} \FunctionTok{everything}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"Une même étiquette"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\end{tcolorbox}

\hypertarget{statistiques-affichuxe9es}{%
\subsection{Statistiques affichées}\label{statistiques-affichuxe9es}}

Le paramètre \texttt{statistic} permets de sélectionner les statistiques
à afficher pour chaque variable. On indiquera une chaîne de caractères
dont les différentes statistiques seront indiquées entre accolades
(\texttt{\{\}}).

Pour une \textbf{variable continue}, on pourra utiliser
\texttt{\{median\}} pour la médiane, \texttt{\{mean\}} pour la moyenne,
\texttt{\{sd\}} pour l'écart type, \texttt{\{var\}} pour la variance,
\texttt{\{min\}} pour le minimum, \texttt{\{max\}} pour le maximum, ou
encore \texttt{\{p\#\#\}} (en remplacant \texttt{\#\#} par un nombre
entier entre 00 et 100) pour le percentile correspondant (par exemple
\texttt{p25} et \texttt{p75} pour le premier et le troisième quartile).
Utilisez \texttt{gtsummary::all\_continous()} pour sélectionner toutes
les variables continues.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, heures.tv),}
    \AttributeTok{statistic =} 
      \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"Moy. : \{mean\} [min{-}max : \{min\} {-} \{max\}]"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-stat-var-cont}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-stat-var-cont}statisques personnalisées pour une
variable continue}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
age & Moy. : 48 {[}min-max : 18 - 97{]} \\
heures.tv & Moy. : 2,25 {[}min-max : 0,00 - 12,00{]} \\
Manquant & 5 \\
\bottomrule()
\end{longtable}

Il est possible d'afficher des statistiques différentes pour chaque
variable.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, heures.tv),}
    \AttributeTok{statistic =} \FunctionTok{list}\NormalTok{(}
\NormalTok{      age }\SpecialCharTok{\textasciitilde{}} \StringTok{"Méd. : \{median\} [\{p25\} {-} \{p75\}]"}\NormalTok{,}
\NormalTok{      heures.tv }\SpecialCharTok{\textasciitilde{}} \StringTok{"Moy. : \{mean\} (\{sd\})"}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-stat-var-cont2}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-stat-var-cont2}statisques personnalisées pour une
variable continue (2)}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
age & Méd. : 48 {[}35 - 60{]} \\
heures.tv & Moy. : 2,25 (1,78) \\
Manquant & 5 \\
\bottomrule()
\end{longtable}

Pour les variables continues, il est également possible d'indiquer le
nom d'une fonction personnalisée qui prends un vecteur et renvoie une
valeur résumée. Par exemple, pour afficher la moyenne des carrés~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{moy\_carres }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{mean}\NormalTok{(x}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{\}}
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ heures.tv,}
    \AttributeTok{statistic =} \SpecialCharTok{\textasciitilde{}} \StringTok{"MC : \{moy\_carres\}"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-stat-var-cont3}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-stat-var-cont3}statisques personnalisées pour une
variable continue (3)}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
heures.tv & MC : 8,20 \\
Manquant & 5 \\
\bottomrule()
\end{longtable}

Pour une \textbf{variable catégorielle}, les statistiques possibles sont
\texttt{\{n\}} le nombre d'observations, \texttt{\{N\}} le nombre total
d'observations, et \texttt{\{p\}} le pourcentage correspondant. Utilisez
\texttt{gtsummary::all\_categorical()} pour sélectionner toutes les
variables catégorielles.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ occup,}
    \AttributeTok{statistic =} \FunctionTok{all\_categorical}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"\{p\} \% (\{n\}/\{N\})"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-stat-var-cat}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-stat-var-cat}statisques personnalisées pour une
variable catégorielle}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
occup & \\
Exerce une profession & 52 \% (1 049/2 000) \\
Chomeur & 6,7 \% (134/2 000) \\
Etudiant, eleve & 4,7 \% (94/2 000) \\
Retraite & 20 \% (392/2 000) \\
Retire des affaires & 3,9 \% (77/2 000) \\
Au foyer & 8,6 \% (171/2 000) \\
Autre inactif & 4,2 \% (83/2 000) \\
\bottomrule()
\end{longtable}

Il est possible, pour une variable catégorielle, de trier les modalités
de la plus fréquente à la moins fréquente avec le paramètre
\texttt{sort}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ occup,}
    \AttributeTok{sort =} \FunctionTok{all\_categorical}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"frequency"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-stat-var-cat-sort}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-stat-var-cat-sort}variable catégorielle triée par
fréquence}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
occup & \\
Exerce une profession & 1 049 (52\%) \\
Retraite & 392 (20\%) \\
Au foyer & 171 (8,6\%) \\
Chomeur & 134 (6,7\%) \\
Etudiant, eleve & 94 (4,7\%) \\
Autre inactif & 83 (4,2\%) \\
Retire des affaires & 77 (3,9\%) \\
\bottomrule()
\end{longtable}

Pour toutes les variables (catégorielles et continues), les statistiques
suivantes sont également disponibles~:

\begin{itemize}
\tightlist
\item
  \texttt{\{N\_obs\}} le nombre total d'observations,
\item
  \texttt{\{N\_miss\}} le nombre d'observations manquantes
  (\texttt{NA}),
\item
  \texttt{\{N\_nonmiss\}} le nombre d'observations non manquantes,
\item
  \texttt{\{p\_miss\}} le pourcentage d'observations manquantes
  (i.e.~\texttt{N\_miss\ /\ N\_obs}) et
\item
  \texttt{\{p\_nonmiss\}} le pourcentage d'observations non manquantes
  (i.e.~\texttt{N\_nonmiss\ /\ N\_obs}).
\end{itemize}

\hypertarget{affichage-du-nom-des-statistiques}{%
\subsection{Affichage du nom des
statistiques}\label{affichage-du-nom-des-statistiques}}

Lorsque l'on affiche de multiples statistiques, la liste des
statistiques est regroupée dans une note de tableau qui peut vite
devenir un peu confuse.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tbl }\OtherTok{\textless{}{-}}\NormalTok{ hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, heures.tv, occup),}
    \AttributeTok{statistic =} \FunctionTok{list}\NormalTok{(}
\NormalTok{      age }\SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\} (\{sd\})"}\NormalTok{,}
\NormalTok{      heures.tv }\SpecialCharTok{\textasciitilde{}} \StringTok{"\{median\} [\{p25\} {-} \{p75\}]"}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{tbl}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-stat-nom}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-stat-nom}tableau par défaut}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
age & 48 (17) \\
heures.tv & 2,00 {[}1,00 - 3,00{]} \\
Manquant & 5 \\
occup & \\
Exerce une profession & 1 049 (52\%) \\
Chomeur & 134 (6,7\%) \\
Etudiant, eleve & 94 (4,7\%) \\
Retraite & 392 (20\%) \\
Retire des affaires & 77 (3,9\%) \\
Au foyer & 171 (8,6\%) \\
Autre inactif & 83 (4,2\%) \\
\bottomrule()
\end{longtable}

La fonction \texttt{gtsummary::add\_stat\_label()} permets d'indiquer le
type de statistique à côté du nom des variables ou bien dans une colonne
dédiée, plutôt qu'en note de tableau.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tbl }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_stat\_label}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-stat-nom-2}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-stat-nom-2}ajout du nom des
statistiques}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
age, Moyenne (ET) & 48 (17) \\
heures.tv, Médiane {[}EI{]} & 2,00 {[}1,00 - 3,00{]} \\
Manquant & 5 \\
occup, n (\%) & \\
Exerce une profession & 1 049 (52\%) \\
Chomeur & 134 (6,7\%) \\
Etudiant, eleve & 94 (4,7\%) \\
Retraite & 392 (20\%) \\
Retire des affaires & 77 (3,9\%) \\
Au foyer & 171 (8,6\%) \\
Autre inactif & 83 (4,2\%) \\
\bottomrule()
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tbl }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_stat\_label}\NormalTok{(}\AttributeTok{location =} \StringTok{"column"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-stat-nom-3}{}
\begin{longtable}[]{@{}lcc@{}}
\caption{\label{tbl-stat-nom-3}ajout du nom des statistiques dans une
colonne séparée}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{Statistique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{Statistique} & \textbf{N = 2 000} \\
\midrule()
\endhead
age & Moyenne (ET) & 48 (17) \\
heures.tv & Médiane {[}EI{]} & 2,00 {[}1,00 - 3,00{]} \\
Manquant & n & 5 \\
occup & & \\
Exerce une profession & n (\%) & 1 049 (52\%) \\
Chomeur & n (\%) & 134 (6,7\%) \\
Etudiant, eleve & n (\%) & 94 (4,7\%) \\
Retraite & n (\%) & 392 (20\%) \\
Retire des affaires & n (\%) & 77 (3,9\%) \\
Au foyer & n (\%) & 171 (8,6\%) \\
Autre inactif & n (\%) & 83 (4,2\%) \\
\bottomrule()
\end{longtable}

\hypertarget{forcer-le-type-de-variable}{%
\subsection{Forcer le type de
variable}\label{forcer-le-type-de-variable}}

Comme évoqué plus haut, \texttt{\{gtsummary\}} détermine automatiquement
le type de chaque variable. Par défaut, la variabe \texttt{age} du
tableau de données \texttt{trial} est traitée comme variable continue,
\texttt{death} comme dichotomique (seule la valeur 1 est affichée) et
\texttt{grade} comme variable catégorielle.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(grade, age, death)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-types-defaut}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-types-defaut}types de variable par
défaut}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 200} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 200} \\
\midrule()
\endhead
Grade & \\
I & 68 (34\%) \\
II & 68 (34\%) \\
III & 64 (32\%) \\
Age & 47 (38 -- 57) \\
Manquant & 11 \\
Patient Died & 112 (56\%) \\
\bottomrule()
\end{longtable}

Il est cependant possible de forcer un certain type avec l'argument
\texttt{type}. Précision~: lorsque l'on force une variable en
dichotomique, il faut indiquer avec \texttt{value} la valeur à afficher
(les autres sont alors masquées).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(grade, death),}
    \AttributeTok{type =} \FunctionTok{list}\NormalTok{(}
\NormalTok{      grade }\SpecialCharTok{\textasciitilde{}} \StringTok{"dichotomous"}\NormalTok{,}
\NormalTok{      death }\SpecialCharTok{\textasciitilde{}} \StringTok{"categorical"}
\NormalTok{    ),}
    \AttributeTok{value =}\NormalTok{ grade }\SpecialCharTok{\textasciitilde{}} \StringTok{"III"}\NormalTok{,}
    \AttributeTok{label =}\NormalTok{ grade }\SpecialCharTok{\textasciitilde{}} \StringTok{"Grade III"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-types-personnalises}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-types-personnalises}types de variable
personnalisés}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 200} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 200} \\
\midrule()
\endhead
Grade III & 64 (32\%) \\
Patient Died & \\
0 & 88 (44\%) \\
1 & 112 (56\%) \\
\bottomrule()
\end{longtable}

\hypertarget{afficher-des-statistiques-sur-plusieurs-lignes-variables-continues}{%
\subsection{Afficher des statistiques sur plusieurs lignes (variables
continues)}\label{afficher-des-statistiques-sur-plusieurs-lignes-variables-continues}}

Pour les variables continues, \texttt{\{gtsummary\}} a introduit un type
de variable \texttt{"continuous2"}, qui doit être attribué manuellement
via \texttt{type}, et qui permets d'afficher plusieurs lignes de
statistiques (en indiquant plusieurs chaînes de caractères dans
\texttt{statistic}). À noter le sélecteur dédié
\texttt{gtsummary::all\_continuous2()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, heures.tv),}
    \AttributeTok{type =}\NormalTok{ age }\SpecialCharTok{\textasciitilde{}} \StringTok{"continuous2"}\NormalTok{,}
    \AttributeTok{statistic =} 
      \FunctionTok{all\_continuous2}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \FunctionTok{c}\NormalTok{(}
        \StringTok{"\{median\} (\{p25\} {-} \{p75\})"}\NormalTok{, }
        \StringTok{"\{mean\} (\{sd\})"}\NormalTok{,}
        \StringTok{"\{min\} {-} \{max\}"}
\NormalTok{      )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-continuous2}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-continuous2}des statistiques sur plusieurs lignes
(variables continues)}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
age & \\
Médiane (EI) & 48 (35 - 60) \\
Moyenne (ET) & 48 (17) \\
Étendue & 18 - 97 \\
heures.tv & 2,00 (1,00 -- 3,00) \\
Manquant & 5 \\
\bottomrule()
\end{longtable}

\hypertarget{mise-en-forme-des-statistiques}{%
\subsection{Mise en forme des
statistiques}\label{mise-en-forme-des-statistiques}}

L'argument \texttt{digits} permet de spécifier comment mettre en forme
les différentes statistiques. Le plus simple est d'indiquer le nombre de
décimales à afficher. Il est important de tenir compte que plusieurs
statistiques peuvent être affichées pour une même variable. On peut
alors indiquer une valeur différente pour chaque statistique.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, occup),}
    \AttributeTok{digits =} \FunctionTok{list}\NormalTok{(}
      \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{,}
      \FunctionTok{all\_categorical}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-digits}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-digits}personnalisation du nombre de
décimales}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
age & 48,0 (35,0 -- 60,0) \\
occup & \\
Exerce une profession & 1 049 (52,4\%) \\
Chomeur & 134 (6,7\%) \\
Etudiant, eleve & 94 (4,7\%) \\
Retraite & 392 (19,6\%) \\
Retire des affaires & 77 (3,9\%) \\
Au foyer & 171 (8,6\%) \\
Autre inactif & 83 (4,2\%) \\
\bottomrule()
\end{longtable}

Au lieu d'un nombre de décimales, on peut indiquer plutôt une fonction à
appliquer pour mettre en forme le résultat. Par exemple,
\texttt{\{gtsummary\}} fournit les fonctions suivantes~:
\texttt{gtsummary::style\_number()} pour les nombres de manière
générale, \texttt{gtsummary::style\_percent()} pour les pourcentages
(les valeurs sont multipliées par 100, mais le symbole \% n'est pas
ajouté), \texttt{gtsummary::style\_pvalue()} pour les p-valeurs,
\texttt{gtsummary::style\_sigfig()} qui n'affiche, par défaut, que deux
chiffres significatifs, ou encore \texttt{gtsummary::style\_ratio()} qui
est une variante de
\texttt{gtsummary::\textasciigrave{}\textasciigrave{}style\_sigfig()}
pour les ratios (comme les \emph{odds ratios}) que l'on compare à 1.

Il faiut bien noter que ce qui est attendu par \texttt{digits}, c'est
une fonction et non le résultat d'une fonction. On indiquera donc le nom
de la fonction sans parenthèse, comme dans l'exemple ci-dessous (même si
pas forcément pertinent ;-)).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ age,}
    \AttributeTok{digits =} 
      \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \FunctionTok{c}\NormalTok{(style\_percent, style\_sigfig, style\_ratio)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-digits-2}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-digits-2}personnalisation de la mise en forme des
nombres}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
age & 4 800 (35 -- 60,0) \\
\bottomrule()
\end{longtable}

Comme \texttt{digits} s'attends à recevoir une fonction (et non le
résultat) d'une fonction, on ne peut pas passer directement des
arguments aux fonctions \texttt{style\_*()} de \texttt{\{gtsummary\}}.
Pour cela il faut créer une fonction à la levée~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ marker,}
    \AttributeTok{statistic =} \SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\} pour 100"}\NormalTok{,}
    \AttributeTok{digits =} \SpecialCharTok{\textasciitilde{}} \ControlFlowTok{function}\NormalTok{(x)\{}\FunctionTok{style\_percent}\NormalTok{(x, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)\}}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-digits-3}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-digits-3}passer une fonction personnalisée à digits
(syntaxe 1)}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 200} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 200} \\
\midrule()
\endhead
Marker Level (ng/mL) & 91,6 pour 100 \\
Manquant & 10 \\
\bottomrule()
\end{longtable}

Depuis \textbf{R 4.1}, il existe une syntaxe raccourcie équivalente,
avec le symbole \texttt{\textbackslash{}} à la place de
\texttt{function}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ marker,}
    \AttributeTok{statistic =} \SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\} pour 100"}\NormalTok{,}
    \AttributeTok{digits =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ \textbackslash{}(x)\{}\FunctionTok{style\_percent}\NormalTok{(x, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)\}}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-digits-4}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-digits-4}passer une fonction personnalisée à digits
(syntaxe 2)}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 200} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 200} \\
\midrule()
\endhead
Marker Level (ng/mL) & 91,6 pour 100 \\
Manquant & 10 \\
\bottomrule()
\end{longtable}

Une syntaxe alternative consiste à avoir recours à la fonction
\texttt{purrr::partial()} qui permet d'appeler partiellement une
fonction et de renvoyer une nouvelle fonction.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ marker,}
    \AttributeTok{statistic =} \SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\} pour 100"}\NormalTok{,}
    \AttributeTok{digits =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ purrr}\SpecialCharTok{::}\FunctionTok{partial}\NormalTok{(style\_percent, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-digits-5}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-digits-5}passer une fonction personnalisée à digits
(syntaxe 3)}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 200} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 200} \\
\midrule()
\endhead
Marker Level (ng/mL) & 91,6 pour 100 \\
Manquant & 10 \\
\bottomrule()
\end{longtable}

À noter dans l'exemple précédent que les fonctions \texttt{style\_*()}
de \texttt{\{gtsummary\}} tiennent compte du thème défini (ici la
virgule comme séparateur de décimale).

Pour une mise en forme plus avancée des nombres, il faut se tourner vers
l'extension \texttt{\{scales\}} et ses diverses fonctions de mise en
forme comme \texttt{scales::label\_number()} ou
\texttt{scales::label\_percent()}.

\textbf{ATTENTION~:} les fonctions de \texttt{\{scales\}} n'héritent pas
des paramètres du thème \texttt{\{gtsummary\}} actif. Il faut donc
personnaliser le séparateur de décimal dans l'appel à la fonction.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ marker,}
    \AttributeTok{statistic =} \SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\}"}\NormalTok{,}
    \AttributeTok{digits =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_number}\NormalTok{(}
      \AttributeTok{accuracy =}\NormalTok{ .}\DecValTok{01}\NormalTok{, }
      \AttributeTok{suffix =} \StringTok{" ng/mL"}\NormalTok{, }
      \AttributeTok{decimal.mark =} \StringTok{","}
\NormalTok{    )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-digits-6}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-digits-6}passer une fonction personnalisée à digits
(syntaxe 4)}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 200} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 200} \\
\midrule()
\endhead
Marker Level (ng/mL) & 0,92 ng/mL \\
Manquant & 10 \\
\bottomrule()
\end{longtable}

\hypertarget{donnuxe9es-manquantes}{%
\subsection{Données manquantes}\label{donnuxe9es-manquantes}}

Le paramètre \texttt{missing} permets d'indiquer s'il faut afficher le
nombre d'observations manquantes (c'est-à-dire égales à \texttt{NA})~:
\texttt{"ifany"} (valeur par défaut) affiche ce nombre seulement s'il y
en a, \texttt{"no"} masque ce nombre et \texttt{"always"} force
l'affichage de ce nombre même s'il n'y pas de valeur manquante. Le
paramètre \texttt{missing\_text} permets de personnaliser le texte
affiché.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, heures.tv),}
    \AttributeTok{missing =} \StringTok{"always"}\NormalTok{,}
    \AttributeTok{missing\_text =} \StringTok{"Nbre observations manquantes"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-missing}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-missing}forcer l'affichage des valeurs
manquantes}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
age & 48 (35 -- 60) \\
Nbre observations manquantes & 0 \\
heures.tv & 2,00 (1,00 -- 3,00) \\
Nbre observations manquantes & 5 \\
\bottomrule()
\end{longtable}

Il est à noter, pour les variables catégorielles, que les valeurs
manquantes ne sont jamais pris en compte pour le calcul des
pourcentages. Pour les inclure dans le calcul, il faut les transformer
en valeurs explicites, par exemple avec
\texttt{forcats::fct\_na\_value\_to\_level()} de \texttt{\{forcats\}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{trav.imp.explicit =}\NormalTok{ trav.imp }\SpecialCharTok{|\textgreater{}} 
\NormalTok{      forcats}\SpecialCharTok{::}\FunctionTok{fct\_na\_value\_to\_level}\NormalTok{(}\StringTok{"(non renseigné)"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(trav.imp, trav.imp.explicit)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-explicit-na}{}
\begin{longtable}[]{@{}lc@{}}
\caption{\label{tbl-explicit-na}valeurs manquantes explicites (variable
catégorielle)}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} \\
\midrule()
\endhead
trav.imp & \\
Le plus important & 29 (2,8\%) \\
Aussi important que le reste & 259 (25\%) \\
Moins important que le reste & 708 (68\%) \\
Peu important & 52 (5,0\%) \\
Manquant & 952 \\
trav.imp.explicit & \\
Le plus important & 29 (1,5\%) \\
Aussi important que le reste & 259 (13\%) \\
Moins important que le reste & 708 (35\%) \\
Peu important & 52 (2,6\%) \\
(non renseigné) & 952 (48\%) \\
\bottomrule()
\end{longtable}

\hypertarget{ajouter-les-effectifs-observuxe9s}{%
\subsection{Ajouter les effectifs
observés}\label{ajouter-les-effectifs-observuxe9s}}

Lorsque l'on masque les manquants, il peut être pertinent d'ajouter une
colonne avec les effectifs observés pour chaque variable à l'aide de la
fonction \texttt{gtsummary::add\_n()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(heures.tv, trav.imp),}
    \AttributeTok{missing =} \StringTok{"no"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_n}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-add_n}{}
\begin{longtable}[]{@{}lcc@{}}
\caption{\label{tbl-add_n}ajouter une colonne avec les effectifs
observés}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N} & \textbf{N = 2 000} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N} & \textbf{N = 2 000} \\
\midrule()
\endhead
heures.tv & 1 995 & 2,00 (1,00 -- 3,00) \\
trav.imp & 1 048 & \\
Le plus important & & 29 (2,8\%) \\
Aussi important que le reste & & 259 (25\%) \\
Moins important que le reste & & 708 (68\%) \\
Peu important & & 52 (5,0\%) \\
\bottomrule()
\end{longtable}

\hypertarget{calcul-manuel}{%
\section{Calcul manuel}\label{calcul-manuel}}

\hypertarget{variable-continue-1}{%
\subsection{Variable continue}\label{variable-continue-1}}

\textbf{R} fournit de base toutes les fonctions nécessaires pour le
calcul des différentes statistiques descriptives~:

\begin{itemize}
\tightlist
\item
  \texttt{mean()} pour la moyenne
\item
  \texttt{sd()} pour l'écart-type
\item
  \texttt{min()} et \texttt{max()} pour le minimum et le maximum
\item
  \texttt{range()} pour l'étendue
\item
  \texttt{median()} pour la médiane
\end{itemize}

Si la variable contient des valeurs manquantes (\texttt{NA}), ces
fonctions renverront une valeur manquante, sauf si on leur précise
\texttt{na.rm\ =\ TRUE}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{heures.tv }\SpecialCharTok{|\textgreater{}} \FunctionTok{mean}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{heures.tv }\SpecialCharTok{|\textgreater{}} \FunctionTok{mean}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2.246566
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{heures.tv }\SpecialCharTok{|\textgreater{}} \FunctionTok{sd}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.775853
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{heures.tv }\SpecialCharTok{|\textgreater{}} \FunctionTok{min}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{heures.tv }\SpecialCharTok{|\textgreater{}} \FunctionTok{max}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 12
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{heures.tv }\SpecialCharTok{|\textgreater{}} \FunctionTok{range}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]  0 12
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{heures.tv }\SpecialCharTok{|\textgreater{}} \FunctionTok{median}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2
\end{verbatim}

La fonction \texttt{quantile()} permets de calculer tous types de
quantiles.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{heures.tv }\SpecialCharTok{|\textgreater{}} \FunctionTok{quantile}\NormalTok{(}\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  0%  25%  50%  75% 100% 
   0    1    2    3   12 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{heures.tv }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{quantile}\NormalTok{(}
    \AttributeTok{probs =} \FunctionTok{c}\NormalTok{(.}\DecValTok{2}\NormalTok{, .}\DecValTok{4}\NormalTok{, .}\DecValTok{6}\NormalTok{, .}\DecValTok{8}\NormalTok{),}
    \AttributeTok{na.rm =} \ConstantTok{TRUE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
20% 40% 60% 80% 
  1   2   2   3 
\end{verbatim}

La fonction \texttt{summary()} renvoie la plupart de ces indicateurs en
une seule fois, ainsi que le nombre de valeurs manquantes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{heures.tv }\SpecialCharTok{|\textgreater{}} \FunctionTok{summary}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
  0.000   1.000   2.000   2.247   3.000  12.000       5 
\end{verbatim}

\hypertarget{sec-table-univariee}{%
\subsection{Variable catégorielle}\label{sec-table-univariee}}

Les fonctions de base pour le calcul d'un tri à plat sont les fonctions
\texttt{table()} et \texttt{xtabs()}. Leur syntaxe est quelque peu
différente. On passe un vecteur entier à \texttt{table()} alors que la
syntaxe de \texttt{xtabs()} se rapproche de celle d'un modèle linéaire~:
on décrit le tableau attendu à l'aide d'une formule et on indique le
tableau de données. Les deux fonctions renvoient le meme résultat.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tbl }\OtherTok{\textless{}{-}}\NormalTok{ hdv2003}\SpecialCharTok{$}\NormalTok{trav.imp }\SpecialCharTok{|\textgreater{}} \FunctionTok{table}\NormalTok{()}
\NormalTok{tbl }\OtherTok{\textless{}{-}} \FunctionTok{xtabs}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ trav.imp, }\AttributeTok{data =}\NormalTok{ hdv2003)}
\NormalTok{tbl }\OtherTok{\textless{}{-}}\NormalTok{ hdv2003 }\SpecialCharTok{|\textgreater{}} \FunctionTok{xtabs}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ trav.imp, }\AttributeTok{data =}\NormalTok{ \_)}
\NormalTok{tbl}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
trav.imp
           Le plus important Aussi important que le reste 
                          29                          259 
Moins important que le reste                Peu important 
                         708                           52 
\end{verbatim}

Comme on le voit, il s'agit du tableau brut des effectifs, sans les
valeurs manquantes, et pas vraiment lisible dans la console de
\textbf{R}.

Pour calculer les proportions, on appliquera \texttt{prop.table()} sur
la table des effectifs bruts.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{prop.table}\NormalTok{(tbl)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
trav.imp
           Le plus important Aussi important que le reste 
                  0.02767176                   0.24713740 
Moins important que le reste                Peu important 
                  0.67557252                   0.04961832 
\end{verbatim}

Pour la réalisation rapide d'un tri à plat, on pourra donc préférer la
fonction \texttt{questionr::freq()} qui affiche également le nombre de
valeurs manquantes et les pourcentages, en un seul appel.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{trav.imp }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{(}\AttributeTok{total =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                                n     %  val%
Le plus important              29   1.5   2.8
Aussi important que le reste  259  13.0  24.7
Moins important que le reste  708  35.4  67.6
Peu important                  52   2.6   5.0
NA                            952  47.6    NA
Total                        2000 100.0 100.0
\end{verbatim}

\hypertarget{intervalles-de-confiance}{%
\section{Intervalles de confiance}\label{intervalles-de-confiance}}

\hypertarget{avec-gtsummary}{%
\subsection{Avec gtsummary}\label{avec-gtsummary}}

La fonction \texttt{gtsummary::add\_ci()} permet d'ajouter des
intervalles de confiance à un tableau créé avec
\texttt{gtsummary::tbl\_summary()}.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-warning-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-warning-color}{\faExclamationTriangle}\hspace{0.5em}{Avertissement}, bottomrule=.15mm, colframe=quarto-callout-warning-color-frame]

Par défaut, pour les \textbf{variables continues},
\texttt{gtsummary::tbl\_summary()} affiche la médiane tandis que
\texttt{gtsummary::add\_ci()} calcule l'intervalle de confiance d'une
moyenne~!

Il faut donc~:

\begin{itemize}
\tightlist
\item
  soit afficher la moyenne dans \texttt{gtsummary::tbl\_summary()} à
  l'aide du paramètre \texttt{statistic}~;
\item
  soit calculer les intervalles de confiance d'une médiane (méthode
  \texttt{"wilcox.text"}) via le paramètre \texttt{method} de
  \texttt{gtsummary::add\_ci()}.
\end{itemize}

\end{tcolorbox}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, heures.tv, trav.imp),}
    \AttributeTok{statistic =}\NormalTok{ age }\SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\} (\{sd\})"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_ci}\NormalTok{(}
    \AttributeTok{method =}\NormalTok{ heures.tv }\SpecialCharTok{\textasciitilde{}} \StringTok{"wilcox.test"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-add_ci}{}
\begin{longtable}[]{@{}lcc@{}}
\caption{\label{tbl-add_ci}ajouter les intervalles de
confiance}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} & \textbf{95\% CI} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} & \textbf{95\% CI} \\
\midrule()
\endhead
age & 48 (17) & 47, 49 \\
heures.tv & 2,00 (1,00 -- 3,00) & 2,5, 2,5 \\
Manquant & 5 & \\
trav.imp & & \\
Le plus important & 29 (2,8\%) & 1,9\%, 4,0\% \\
Aussi important que le reste & 259 (25\%) & 22\%, 27\% \\
Moins important que le reste & 708 (68\%) & 65\%, 70\% \\
Peu important & 52 (5,0\%) & 3,8\%, 6,5\% \\
Manquant & 952 & \\
\bottomrule()
\end{longtable}

L'argument \texttt{statistic} permet de personnaliser la présentation de
l'intervalle~; \texttt{conf.level} de changer le niveau de confiance et
\texttt{style\_fun} de modifier la mise en forme des nombres de
l'intervalle.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, heures.tv),}
    \AttributeTok{statistic =} \SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\}"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_ci}\NormalTok{(}
    \AttributeTok{statistic =} \SpecialCharTok{\textasciitilde{}} \StringTok{"entre \{conf.low\} et \{conf.high\}"}\NormalTok{,}
    \AttributeTok{conf.level =}\NormalTok{ .}\DecValTok{9}\NormalTok{,}
    \AttributeTok{style\_fun =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ purrr}\SpecialCharTok{::}\FunctionTok{partial}\NormalTok{(style\_number, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-add_ci-2}{}
\begin{longtable}[]{@{}lcc@{}}
\caption{\label{tbl-add_ci-2}des intervalles de confiance
personnalisés}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} & \textbf{90\% CI} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{N = 2 000} & \textbf{90\% CI} \\
\midrule()
\endhead
age & 48 & entre 47,5 et 48,8 \\
heures.tv & 2,25 & entre 2,2 et 2,3 \\
Manquant & 5 & \\
\bottomrule()
\end{longtable}

\hypertarget{calcul-manuel-1}{%
\subsection{Calcul manuel}\label{calcul-manuel-1}}

Le calcul de l'intervalle de confiance d'une \textbf{moyenne} s'effectue
avec la fonction \texttt{t.test()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{age }\SpecialCharTok{|\textgreater{}} \FunctionTok{t.test}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

    One Sample t-test

data:  hdv2003$age
t = 127.12, df = 1999, p-value < 2.2e-16
alternative hypothesis: true mean is not equal to 0
95 percent confidence interval:
 47.41406 48.89994
sample estimates:
mean of x 
   48.157 
\end{verbatim}

Le résultat renvoyé est une liste contenant de multiples informations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{age }\SpecialCharTok{|\textgreater{}} \FunctionTok{t.test}\NormalTok{() }\SpecialCharTok{|\textgreater{}} \FunctionTok{str}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
List of 10
 $ statistic  : Named num 127
  ..- attr(*, "names")= chr "t"
 $ parameter  : Named num 1999
  ..- attr(*, "names")= chr "df"
 $ p.value    : num 0
 $ conf.int   : num [1:2] 47.4 48.9
  ..- attr(*, "conf.level")= num 0.95
 $ estimate   : Named num 48.2
  ..- attr(*, "names")= chr "mean of x"
 $ null.value : Named num 0
  ..- attr(*, "names")= chr "mean"
 $ stderr     : num 0.379
 $ alternative: chr "two.sided"
 $ method     : chr "One Sample t-test"
 $ data.name  : chr "hdv2003$age"
 - attr(*, "class")= chr "htest"
\end{verbatim}

Si l'on a besoin d'accéder spécifiquement à l'intervalle de confiance
calculé~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{age }\SpecialCharTok{|\textgreater{}} \FunctionTok{t.test}\NormalTok{() }\SpecialCharTok{|\textgreater{}}\NormalTok{ purrr}\SpecialCharTok{::}\FunctionTok{pluck}\NormalTok{(}\StringTok{"conf.int"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 47.41406 48.89994
attr(,"conf.level")
[1] 0.95
\end{verbatim}

Pour celui d'une \textbf{médiane}, on utilisera \texttt{wilcox.test()}
en précisant \texttt{conf.int\ =\ TRUE}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{age }\SpecialCharTok{|\textgreater{}} \FunctionTok{wilcox.test}\NormalTok{(}\AttributeTok{conf.int =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

    Wilcoxon signed rank test with continuity correction

data:  hdv2003$age
V = 2001000, p-value < 2.2e-16
alternative hypothesis: true location is not equal to 0
95 percent confidence interval:
 47.00001 48.50007
sample estimates:
(pseudo)median 
      47.99996 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003}\SpecialCharTok{$}\NormalTok{age }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{wilcox.test}\NormalTok{(}\AttributeTok{conf.int =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
\NormalTok{  purrr}\SpecialCharTok{::}\FunctionTok{pluck}\NormalTok{(}\StringTok{"conf.int"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 47.00001 48.50007
attr(,"conf.level")
[1] 0.95
\end{verbatim}

Pour une \textbf{proportion}, on utilisera \texttt{prop.test()} en lui
transmettant le nombre de succès et le nombre d'observations, qu'il
faudra donc avoir calculé au préalable. On peut également passer une
table à deux entrées avec le nombre de succès puis le nombre d'échecs.

Ainsi, pour obtenir l'intervalle de confiance de la proportion des
enquêtés qui considèrent leur travail comme \emph{peu important}, en
tenant compte des valeurs manquantes, le plus simple est d'effectuer le
code suivant\sidenote{\footnotesize Notez l'utilisation de \texttt{rev()} pour
  inverser le tableau créé avec \texttt{xtabs()} afin que le nombre de
  succès (\texttt{TRUE}) soit indiqués avant le nombre d'échecs
  (\texttt{FALSE}).}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{xtabs}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{I}\NormalTok{(hdv2003}\SpecialCharTok{$}\NormalTok{trav.imp }\SpecialCharTok{==} \StringTok{"Peu important"}\NormalTok{), }\AttributeTok{data =}\NormalTok{ hdv2003) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{rev}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{prop.test}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

    1-sample proportions test with continuity correction

data:  rev(xtabs(~I(hdv2003$trav.imp == "Peu important"), data = hdv2003)), null probability 0.5
X-squared = 848.52, df = 1, p-value < 2.2e-16
alternative hypothesis: true p is not equal to 0.5
95 percent confidence interval:
 0.03762112 0.06502346
sample estimates:
         p 
0.04961832 
\end{verbatim}

Par défaut, \texttt{prop.test()} produit un intervalle de confiance
bilatéral en utilisant la méthode de Wilson avec correction de
continuité. Pour plus d'information sur les différentes manières de
calculer l'intervalle de confiance d'une proportion, on pourra se
référer à ce
\href{https://joseph.larmarange.net/Intervalle-de-confiance-bilateral}{billet
de blog}.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Comme on le voit, il n'est pas aisé, avec les fonctions de \textbf{R
base} de calculer les intervalles de confiance pour toutes les modalités
d'une variable catégorielle.

On pourra éventuellement avoir recours à la petite fonction suivante qui
réalise le tri à plat d'une variable catégorielle, calcule les
proprotions et leurs intervalles de confiance.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prop\_ci }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, }\AttributeTok{conf.level =}\NormalTok{ .}\DecValTok{95}\NormalTok{, }\AttributeTok{correct =} \ConstantTok{TRUE}\NormalTok{) \{}
\NormalTok{  tbl }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{table}\NormalTok{(x), }\AttributeTok{responseName =} \StringTok{"n"}\NormalTok{)}
\NormalTok{  tbl}\SpecialCharTok{$}\NormalTok{N }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(tbl}\SpecialCharTok{$}\NormalTok{n)}
\NormalTok{  tbl}\SpecialCharTok{$}\NormalTok{prop }\OtherTok{\textless{}{-}}\NormalTok{ tbl}\SpecialCharTok{$}\NormalTok{n }\SpecialCharTok{/}\NormalTok{ tbl}\SpecialCharTok{$}\NormalTok{N}
\NormalTok{  tbl}\SpecialCharTok{$}\NormalTok{conf.low }\OtherTok{\textless{}{-}} \ConstantTok{NA\_real\_}
\NormalTok{  tbl}\SpecialCharTok{$}\NormalTok{conf.high }\OtherTok{\textless{}{-}} \ConstantTok{NA\_real\_}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(tbl)) \{}
\NormalTok{    test }\OtherTok{\textless{}{-}} \FunctionTok{prop.test}\NormalTok{(}
      \AttributeTok{x =}\NormalTok{ tbl}\SpecialCharTok{$}\NormalTok{n[i],}
      \AttributeTok{n =}\NormalTok{ tbl}\SpecialCharTok{$}\NormalTok{N[i],}
      \AttributeTok{conf.level =}\NormalTok{ conf.level,}
      \AttributeTok{correct =}\NormalTok{ correct}
\NormalTok{    )}
\NormalTok{    tbl}\SpecialCharTok{$}\NormalTok{conf.low[i] }\OtherTok{\textless{}{-}}\NormalTok{ test}\SpecialCharTok{$}\NormalTok{conf.int[}\DecValTok{1}\NormalTok{]}
\NormalTok{    tbl}\SpecialCharTok{$}\NormalTok{conf.high[i] }\OtherTok{\textless{}{-}}\NormalTok{ test}\SpecialCharTok{$}\NormalTok{conf.int[}\DecValTok{2}\NormalTok{]}
\NormalTok{  \}}
\NormalTok{  tbl}
\NormalTok{\}}
\FunctionTok{prop\_ci}\NormalTok{(hdv2003}\SpecialCharTok{$}\NormalTok{trav.imp)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                             x   n    N       prop   conf.low  conf.high
1            Le plus important  29 1048 0.02767176 0.01894147 0.04001505
2 Aussi important que le reste 259 1048 0.24713740 0.22151849 0.27463695
3 Moins important que le reste 708 1048 0.67557252 0.64614566 0.70369541
4                Peu important  52 1048 0.04961832 0.03762112 0.06502346
\end{verbatim}

\end{tcolorbox}

\hypertarget{webin-r-5}{%
\section{webin-R}\label{webin-r-5}}

La statistique univariée est présentée dans le webin-R \#03
(\emph{statistiques descriptives avec gtsummary et esquisse}) sur
\href{https://youtu.be/oEF_8GXyP5c?t=1380}{YouTube}.

\url{https://youtu.be/oEF_8GXyP5c}

\hypertarget{sec-statistique-bivariee}{%
\chapter{Statistique bivariée \& Tests de
comparaison}\label{sec-statistique-bivariee}}

\hypertarget{deux-variables-catuxe9gorielles}{%
\section{Deux variables
catégorielles}\label{deux-variables-catuxe9gorielles}}

\hypertarget{tableau-croisuxe9-avec-gtsummary}{%
\subsection{\texorpdfstring{Tableau croisé avec
\texttt{gtsummary}}{Tableau croisé avec gtsummary}}\label{tableau-croisuxe9-avec-gtsummary}}

Pour regarder le lien entre deux variables catégorielles, l'approche la
plus fréquente consiste à réaliser un \emph{tableau croisé}, ce qui
s'obtient très facilement avec l'argument \texttt{by} de la fonction
\texttt{gtsummary::tbl\_summary()} que nous avons déjà abordée dans le
chapitre sur la statistique univariée (cf.
Section~\ref{sec-tri-a-plat}).

Prenons pour exemple le jeu de données \texttt{gtsummary::trial} et
croisons les variables \emph{stage} et \emph{grade}. On indique à
\texttt{by} la variable à représenter en colonnes et à \texttt{include}
celle à représenter en lignes.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gtsummary)}
\FunctionTok{theme\_gtsummary\_language}\NormalTok{(}\StringTok{"fr"}\NormalTok{, }\AttributeTok{decimal.mark =} \StringTok{\textquotesingle{},\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Setting theme `language: fr`
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ stage,}
    \AttributeTok{by =}\NormalTok{ grade}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-by}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2941}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2206}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2353}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2500}}@{}}
\caption{\label{tbl-by}un tableau croisé avec des pourcentages en
colonne}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} \\
\midrule()
\endhead
T Stage & & & \\
T1 & 17 (25\%) & 23 (34\%) & 13 (20\%) \\
T2 & 18 (26\%) & 17 (25\%) & 19 (30\%) \\
T3 & 18 (26\%) & 11 (16\%) & 14 (22\%) \\
T4 & 15 (22\%) & 17 (25\%) & 18 (28\%) \\
\bottomrule()
\end{longtable}

Par défaut, les pourcentages affichés correspondent à des pourcentages
en colonne. On peut demander des pourcentages en ligne avec
\texttt{percent\ =\ "row"} ou des pourcentages du total avec
\texttt{percent\ =\ "cell"}.

Il est possible de passer plusieurs variables à \texttt{include} mais
une seule variable peut être transmise à \texttt{by}. La fonction
\texttt{gtsummary::add\_overall()} permet d'ajouter une colonne totale.
Comme pour un tri à plat, on peut personnaliser les statistiques
affichées avec \texttt{statistic}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gtsummary)}
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(stage, trt),}
    \AttributeTok{by =}\NormalTok{ grade,}
    \AttributeTok{statistic =} \SpecialCharTok{\textasciitilde{}} \StringTok{"\{p\}\% (\{n\}/\{N\})"}\NormalTok{,}
    \AttributeTok{percent =} \StringTok{"row"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_overall}\NormalTok{(}\AttributeTok{last =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-by-2}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2527}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1648}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1758}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1868}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2198}}@{}}
\caption{\label{tbl-by-2}un tableau croisé avec des pourcentages en
ligne}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Total}, N = 200
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Total}, N = 200
\end{minipage} \\
\midrule()
\endhead
T Stage & & & & \\
T1 & 32\% (17/53) & 43\% (23/53) & 25\% (13/53) & 100\% (53/53) \\
T2 & 33\% (18/54) & 31\% (17/54) & 35\% (19/54) & 100\% (54/54) \\
T3 & 42\% (18/43) & 26\% (11/43) & 33\% (14/43) & 100\% (43/43) \\
T4 & 30\% (15/50) & 34\% (17/50) & 36\% (18/50) & 100\% (50/50) \\
Chemotherapy Treatment & & & & \\
Drug A & 36\% (35/98) & 33\% (32/98) & 32\% (31/98) & 100\% (98/98) \\
Drug B & 32\% (33/102) & 35\% (36/102) & 32\% (33/102) & 100\%
(102/102) \\
\bottomrule()
\end{longtable}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Important}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

Choisissez bien votre type de pourcentages (en lignes ou en colonnes).
Si d'un point de vue purement statistique, ils permettent tous deux de
décrire la relation entre les deux variables, ils ne correspondent au
même \emph{story telling}. Tout dépend donc du message que vous
souhaitez faire passer, de l'histoire que vous souhaitez raconter.

\end{tcolorbox}

\texttt{gtsummary::tbl\_summary()} est bien adaptée dans le cadre d'une
analyse de facteurs afin de représenter un \emph{outcome} donné avec
\texttt{by} et une liste de facteurs avec \texttt{include}.

Lorsque l'on ne croise que deux variables et que l'on souhaite un
affichage un peu plus traditionnel d'un tableau croisé, on peut utiliser
\texttt{gtsummary::tbl\_cross()} à laquelle on transmettra une et une
seule variable à \texttt{row} et une et une seule variable à
\texttt{col}. Pour afficher des pourcentages, il faudra indiquer le type
de pourcentages voulus avec \texttt{percent}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_cross}\NormalTok{(}
    \AttributeTok{row =}\NormalTok{ stage,}
    \AttributeTok{col =}\NormalTok{ grade,}
    \AttributeTok{percent =} \StringTok{"row"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-cross}{}
\begin{longtable}[]{@{}lcccc@{}}
\caption{\label{tbl-cross}un tableau croisé avec
tbl\_cross()}\tabularnewline
\toprule()
& I & II & III & Total \\
\midrule()
\endfirsthead
\toprule()
& I & II & III & Total \\
\midrule()
\endhead
T Stage & & & & \\
T1 & 17 (32\%) & 23 (43\%) & 13 (25\%) & 53 (100\%) \\
T2 & 18 (33\%) & 17 (31\%) & 19 (35\%) & 54 (100\%) \\
T3 & 18 (42\%) & 11 (26\%) & 14 (33\%) & 43 (100\%) \\
T4 & 15 (30\%) & 17 (34\%) & 18 (36\%) & 50 (100\%) \\
Total & 68 (34\%) & 68 (34\%) & 64 (32\%) & 200 (100\%) \\
\bottomrule()
\end{longtable}

\hypertarget{repruxe9sentations-graphiques}{%
\subsection{Représentations
graphiques}\label{repruxe9sentations-graphiques}}

La représentation graphique la plus commune pour le croisement de deux
variables catégorielles est le diagramme en barres, que l'on réalise
avec la géométrie \texttt{ggplot2::geom\_bar()} et en utilisant les
esthétiques \emph{x} et \emph{fill} pour représenter les deux variables.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{ggplot}\NormalTok{(trial) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ stage, }\AttributeTok{fill =}\NormalTok{ grade) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"T Stage"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Grade"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Effectifs"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-bar-fill-1.pdf}

}

\caption{\label{fig-bar-fill}un graphique en barres croisant deux
variables}

\end{figure}

On peut modifier la position des barres avec le paramètre
\texttt{position}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{ggplot}\NormalTok{(trial) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ stage, }\AttributeTok{fill =}\NormalTok{ grade) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"T Stage"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Grade"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Effectifs"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-bar-fill-dodge-1.pdf}

}

\caption{\label{fig-bar-fill-dodge}un graphique avec des barres côte à
côte}

\end{figure}

Pour des barres cumulées, on aura recours à
\texttt{position\ =\ "fill"}. Pour que les étiquettes de l'axe des
\texttt{y} soient représentées sous forme de pourcentages
(i.e.~\texttt{25\%} au lieu de \texttt{0.25}), on aura recours à la
fonction \texttt{scales::percent()} qui sera transmise à
\texttt{ggplot2::scale\_y\_continuous()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{ggplot}\NormalTok{(trial) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ stage, }\AttributeTok{fill =}\NormalTok{ grade) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"T Stage"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Grade"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Proportion"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\NormalTok{percent)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-bar-fill-dodge-2-1.pdf}

}

\caption{\label{fig-bar-fill-dodge-2}un graphique en barres cumulées}

\end{figure}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Ajouter des étiquettes sur un diagramme en barres}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Il est facile d'ajouter des étiquettes en ayant recours à
\texttt{ggplot2::geom\_text()}, à condition de lui passer les bons
paramètres.

Tout d'abord, il faudra préciser \texttt{stat\ =\ "count"} pour indiquer
que l'on souhaite utiliser la statistique
\texttt{ggplot2::stat\_count()} qui est celle utilisé par défaut par
\texttt{ggplot2::geom\_bar()}. C'est elle qui permets de compter le
nombre d'observations.

Il faut ensuite utiliser l'esthétique \emph{label} pour indiquer ce que
l'on souhaite afficher comme étiquettes. La fonction
\texttt{after\_stat(count)} permet d'accéder à la variable \emph{count}
calculée par \texttt{ggplot2::stat\_count()}.

Enfin, il faut indiquer la position verticale avec
\texttt{ggplot2::position\_stack()}. En précisant un ajustement de
vertical de \texttt{0.5}, on indique que l'on souhaite positionner
l'étiquette au milieu.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(trial) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ stage, }\AttributeTok{fill =}\NormalTok{ grade, }
    \AttributeTok{label =} \FunctionTok{after\_stat}\NormalTok{(count)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}
    \AttributeTok{stat =} \StringTok{"count"}\NormalTok{, }
    \AttributeTok{position =} \FunctionTok{position\_stack}\NormalTok{(.}\DecValTok{5}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/unnamed-chunk-7-1.pdf}

}

\end{figure}

Pour un graphique en barres cumulées, on peut utiliser de manière
similaire \texttt{ggplot2::position\_fill()}. On ne peut afficher
directement les proportions avec \texttt{ggplot2::stat\_count()}.
Cependant, nous pouvons avoir recours à \texttt{ggstats::stat\_prop()},
déjà évoquée dans le chapitre sur la statistique univariée (cf.
Section~\ref{sec-graph-univ-var-cat}) et dont le dénominateur doit être
précisé via l'esthétique \emph{by}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggstats)}
\FunctionTok{ggplot}\NormalTok{(trial) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ stage, }
    \AttributeTok{fill =}\NormalTok{ grade, }
    \AttributeTok{by =}\NormalTok{ stage,}
    \AttributeTok{label =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(}\FunctionTok{after\_stat}\NormalTok{(prop), }\AttributeTok{accuracy =}\NormalTok{ .}\DecValTok{1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}
    \AttributeTok{stat =} \StringTok{"prop"}\NormalTok{, }
    \AttributeTok{position =} \FunctionTok{position\_fill}\NormalTok{(.}\DecValTok{5}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\NormalTok{percent)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/unnamed-chunk-8-1.pdf}

}

\end{figure}

On peut aussi comparer facilement deux distributions, ici la proportion
de chaque niveau de qualification au sein chaque sexe.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(trial) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ stage,}
    \AttributeTok{y =} \FunctionTok{after\_stat}\NormalTok{(prop),}
    \AttributeTok{fill =}\NormalTok{ grade, }
    \AttributeTok{by =}\NormalTok{ grade,}
    \AttributeTok{label =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(}\FunctionTok{after\_stat}\NormalTok{(prop), }\AttributeTok{accuracy =} \DecValTok{1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}
    \AttributeTok{stat =} \StringTok{"prop"}\NormalTok{, }
    \AttributeTok{position =} \FunctionTok{position\_dodge}\NormalTok{(.}\DecValTok{9}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}
    \FunctionTok{aes}\NormalTok{(}\AttributeTok{y =} \FunctionTok{after\_stat}\NormalTok{(prop) }\SpecialCharTok{{-}} \FloatTok{0.01}\NormalTok{),}
    \AttributeTok{stat =} \StringTok{"prop"}\NormalTok{, }
    \AttributeTok{position =} \FunctionTok{position\_dodge}\NormalTok{(.}\DecValTok{9}\NormalTok{),}
    \AttributeTok{vjust =} \StringTok{"top"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\NormalTok{percent)}
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/unnamed-chunk-9-1.pdf}

}

\end{figure}

Il est possible d'alléger le graphique en retirant des éléments
superflus.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\SpecialCharTok{+} 
  \FunctionTok{theme\_light}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribution selon le niveau, par grade"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{legend.position =} \StringTok{"top"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/unnamed-chunk-10-1.pdf}

}

\end{figure}

\end{tcolorbox}

Pour visualiser chaque étape du code, vous pouvez consulter le diaporama
suivant~:
\url{https://larmarange.github.io/guide-R/analyses/ressources/flipbook-geom_bar-dodge.html}

\hypertarget{calcul-manuel-2}{%
\subsection{Calcul manuel}\label{calcul-manuel-2}}

Les deux fonctions de base permettant le calcul d'un tri à plat sont
\texttt{table()} et \texttt{xtabs()} (cf.
Section~\ref{sec-table-univariee}). Ces mêmes fonctions permettent le
calcul du tri croisé de deux variables (ou plus). Pour \texttt{table()},
on passera les deux vecteurs à croisés, tandis que pour \texttt{xtabs()}
on décrira le tableau attendu à l'aide d'une formule.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(trial}\SpecialCharTok{$}\NormalTok{stage, trial}\SpecialCharTok{$}\NormalTok{grade)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
    
      I II III
  T1 17 23  13
  T2 18 17  19
  T3 18 11  14
  T4 15 17  18
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{xtabs}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ stage }\SpecialCharTok{+}\NormalTok{ grade, }\AttributeTok{data =}\NormalTok{ trial)}
\NormalTok{tab}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
     grade
stage  I II III
   T1 17 23  13
   T2 18 17  19
   T3 18 11  14
   T4 15 17  18
\end{verbatim}

Le tableau obtenu est basique et ne contient que les effectifs. La
fonction \texttt{addmargins()} permet d'ajouter les totaux par ligne et
par colonne.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\SpecialCharTok{|\textgreater{}} \FunctionTok{addmargins}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
     grade
stage   I  II III Sum
  T1   17  23  13  53
  T2   18  17  19  54
  T3   18  11  14  43
  T4   15  17  18  50
  Sum  68  68  64 200
\end{verbatim}

Pour le calcul des pourcentages, le plus simple est d'avoir recours au
package \texttt{\{questionr\}} qui fournit les fonctions
\texttt{questionr::cprop()}, \texttt{questionr::rprop()} et
\texttt{questionr::prop()} qui permettent de calculer, respectivement,
les pourcentages en colonne, en ligne et totaux.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{questionr}\SpecialCharTok{::}\FunctionTok{cprop}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
       grade
stage   I     II    III   Ensemble
  T1     25.0  33.8  20.3  26.5   
  T2     26.5  25.0  29.7  27.0   
  T3     26.5  16.2  21.9  21.5   
  T4     22.1  25.0  28.1  25.0   
  Total 100.0 100.0 100.0 100.0   
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{questionr}\SpecialCharTok{::}\FunctionTok{rprop}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
          grade
stage      I     II    III   Total
  T1        32.1  43.4  24.5 100.0
  T2        33.3  31.5  35.2 100.0
  T3        41.9  25.6  32.6 100.0
  T4        30.0  34.0  36.0 100.0
  Ensemble  34.0  34.0  32.0 100.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{questionr}\SpecialCharTok{::}\FunctionTok{prop}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
       grade
stage   I     II    III   Total
  T1      8.5  11.5   6.5  26.5
  T2      9.0   8.5   9.5  27.0
  T3      9.0   5.5   7.0  21.5
  T4      7.5   8.5   9.0  25.0
  Total  34.0  34.0  32.0 100.0
\end{verbatim}

\hypertarget{test-du-chiuxb2-et-duxe9rivuxe9s}{%
\subsection{Test du Chi² et
dérivés}\label{test-du-chiuxb2-et-duxe9rivuxe9s}}

Dans le cadre d'un tableau croisé, on peut tester l'existence d'un lien
entre les modalités de deux variables, avec le très classique test du
Chi² (parfois écrit χ² ou Chi²). Pour une présentation plus détaillée du
test, on pourra se référer à ce
\href{https://github.com/juba/archive_doc_khi2/raw/master/khi2.pdf}{cours
de Julien Barnier}.

Le test du Chi² peut se calculer très facilement avec la fonction
\texttt{chisq.test()} appliquée au tableau obtenu avec \texttt{table()}
ou \texttt{xtabs()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{xtabs}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ stage }\SpecialCharTok{+}\NormalTok{ grade, }\AttributeTok{data =}\NormalTok{ trial)}
\NormalTok{tab}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
     grade
stage  I II III
   T1 17 23  13
   T2 18 17  19
   T3 18 11  14
   T4 15 17  18
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{chisq.test}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

    Pearson's Chi-squared test

data:  tab
X-squared = 4.8049, df = 6, p-value = 0.5691
\end{verbatim}

Si l'on est adepte de \texttt{\{gtsummary\}}, il suffit d'appliquer
\texttt{gtsummary::add\_p()} au tableau produit avec
\texttt{gtsummary::tbl\_summary()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ stage,}
    \AttributeTok{by =}\NormalTok{ grade}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_p}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-add_p}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2439}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1829}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1951}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2073}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1707}}@{}}
\caption{\label{tbl-add_p}un tableau croisé avec test du
khi²}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
T Stage & & & & 0,6 \\
T1 & 17 (25\%) & 23 (34\%) & 13 (20\%) & \\
T2 & 18 (26\%) & 17 (25\%) & 19 (30\%) & \\
T3 & 18 (26\%) & 11 (16\%) & 14 (22\%) & \\
T4 & 15 (22\%) & 17 (25\%) & 18 (28\%) & \\
\bottomrule()
\end{longtable}

Dans notre exemple, les deux variables \emph{stage} et \emph{grade} ne
sont clairement pas corrélées.

Un test alternatif est le test exact de Fisher. Il s'obtient aisément
avec \texttt{fisher.test()} ou bien en le spécifiant via l'argument
\texttt{test} de \texttt{gtsummary::add\_p()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{xtabs}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ stage }\SpecialCharTok{+}\NormalTok{ grade, }\AttributeTok{data =}\NormalTok{ trial)}
\FunctionTok{fisher.test}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

    Fisher's Exact Test for Count Data

data:  tab
p-value = 0.5801
alternative hypothesis: two.sided
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ stage,}
    \AttributeTok{by =}\NormalTok{ grade}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_p}\NormalTok{(}\AttributeTok{test =} \FunctionTok{all\_categorical}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"fisher.test"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-add_p-fisher}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2439}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1829}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1951}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2073}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1707}}@{}}
\caption{\label{tbl-add_p-fisher}un tableau croisé avec test exact de
Fisher}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
T Stage & & & & 0,6 \\
T1 & 17 (25\%) & 23 (34\%) & 13 (20\%) & \\
T2 & 18 (26\%) & 17 (25\%) & 19 (30\%) & \\
T3 & 18 (26\%) & 11 (16\%) & 14 (22\%) & \\
T4 & 15 (22\%) & 17 (25\%) & 18 (28\%) & \\
\bottomrule()
\end{longtable}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

Formellement, le test de Fisher suppose que les marges du tableau
(totaux lignes et colonnes) sont fixées, puisqu'il repose sur une loi
hypergéométrique, et donc celui-ci se prête plus au cas des situations
expérimentales (plans d'expérience, essais cliniques) qu'au cas des
données tirées d'études observationnelles.

En pratique, le test du Chi² étant assez robuste quant aux déviations
par rapport aux hypothèses d'applications du test (effectifs théoriques
supérieurs ou égaux à 5), le test de Fisher présente en général peu
d'intérêt dans le cas de l'analyse des tableaux de contingence.

\end{tcolorbox}

\hypertarget{comparaison-de-deux-proportions}{%
\subsection{Comparaison de deux
proportions}\label{comparaison-de-deux-proportions}}

Pour comparer deux proportions, la fonction de base est
\texttt{prop.test()} à laquelle on passera un tableau à 2×2 dimensions.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{xtabs}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{I}\NormalTok{(stage }\SpecialCharTok{==} \StringTok{"T1"}\NormalTok{) }\SpecialCharTok{+}\NormalTok{ trt, }\AttributeTok{data =}\NormalTok{ trial)}
\NormalTok{tab }\SpecialCharTok{|\textgreater{}}\NormalTok{ questionr}\SpecialCharTok{::}\FunctionTok{cprop}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                trt
I(stage == "T1") Drug A Drug B Ensemble
           FALSE  71.4   75.5   73.5   
           TRUE   28.6   24.5   26.5   
           Total 100.0  100.0  100.0   
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\SpecialCharTok{|\textgreater{}} \FunctionTok{prop.test}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

    2-sample test for equality of proportions with continuity correction

data:  tab
X-squared = 0.24047, df = 1, p-value = 0.6239
alternative hypothesis: two.sided
95 percent confidence interval:
 -0.2217278  0.1175050
sample estimates:
   prop 1    prop 2 
0.4761905 0.5283019 
\end{verbatim}

Il est également envisageable d'avoir recours à un test exact de Fisher.
Dans le cas d'un tableau à 2×2 dimensions, le test exact de Fisher ne
teste pas si les deux proportions sont différents, mais plutôt si leur
\href{https://fr.wikipedia.org/wiki/Odds_ratio}{\emph{odds ratio}} (qui
est d'ailleurs renvoyé par la fonction) est différent de 1.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fisher.test}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

    Fisher's Exact Test for Count Data

data:  tab
p-value = 0.5263
alternative hypothesis: true odds ratio is not equal to 1
95 percent confidence interval:
 0.4115109 1.5973635
sample estimates:
odds ratio 
 0.8125409 
\end{verbatim}

Mais le plus simple reste encore d'avoir recours à
\texttt{\{gtsummary\}} et à sa fonction
\texttt{gtsummary::add\_difference()} que l'on peut appliquer à un
tableau où le paramètre \texttt{by} n'a que deux modalités. Pour la
différence de proportions, il faut que les variables transmises à
\texttt{include} soit dichotomiques.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{by =}\NormalTok{ trt,}
    \AttributeTok{include =}\NormalTok{ response}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_difference}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-add_difference}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1923}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1923}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.2019}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1538}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1250}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1346}}@{}}
\caption{\label{tbl-add_difference}différence entre deux
proportions}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug A}, N = 98
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug B}, N = 102
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Difference}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug A}, N = 98
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug B}, N = 102
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Difference}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
Tumor Response & 28 (29\%) & 33 (34\%) & -4,2\% & -18\% -- 9,9\% &
0,6 \\
Manquant & 3 & 4 & & & \\
\bottomrule()
\end{longtable}

\textbf{Attention~:} si l'on passe une variable catégorielle à trois
modalités ou plus, c'est la différence des moyennes standardisées
(globale pour la variable) qui sera calculée et non la différence des
proportions dans chaque groupe.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{by =}\NormalTok{ trt,}
    \AttributeTok{include =}\NormalTok{ grade}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_difference}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-add_difference-2}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2198}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2198}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2308}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1758}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1538}}@{}}
\caption{\label{tbl-add_difference-2}différence moyenne
standardisée}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug A}, N = 98
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug B}, N = 102
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Difference}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug A}, N = 98
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug B}, N = 102
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Difference}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} \\
\midrule()
\endhead
Grade & & & 0,07 & -0,20 -- 0,35 \\
I & 35 (36\%) & 33 (32\%) & & \\
II & 32 (33\%) & 36 (35\%) & & \\
III & 31 (32\%) & 33 (32\%) & & \\
\bottomrule()
\end{longtable}

Pour calculer la différence des proportions pour chaque modalité de
\emph{grade}, il est nécessaire de transformer, en amont, la variable
catégorielle \emph{grade} en trois variables dichotomiques (de type
oui/non, une par modalité), ce qui peut se faire facilement avec la
fonction \texttt{fastDummies::dummy\_cols()} de l'extension
\texttt{\{fastDummies\}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  fastDummies}\SpecialCharTok{::}\FunctionTok{dummy\_cols}\NormalTok{(}\StringTok{"grade"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{by =}\NormalTok{ trt,}
    \AttributeTok{include =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"grade\_"}\NormalTok{),}
    \AttributeTok{digits =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_difference}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-add_difference-3}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1942}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1942}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.2039}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1553}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1165}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1359}}@{}}
\caption{\label{tbl-add_difference-3}différence entre proportions avec
création de variables dichotomiques}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug A}, N = 98
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug B}, N = 102
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Difference}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug A}, N = 98
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug B}, N = 102
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Difference}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
grade\_I & 35 (35,7\%) & 33 (32,4\%) & 3,4\% & -11\% -- 17\% & 0,7 \\
grade\_II & 32 (32,7\%) & 36 (35,3\%) & -2,6\% & -17\% -- 11\% & 0,8 \\
grade\_III & 31 (31,6\%) & 33 (32,4\%) & -0,72\% & -14\% -- 13\% &
\textgreater0,9 \\
\bottomrule()
\end{longtable}

\hypertarget{une-variable-continue-selon-une-variable-catuxe9gorielle}{%
\section{Une variable continue selon une variable
catégorielle}\label{une-variable-continue-selon-une-variable-catuxe9gorielle}}

\hypertarget{tableau-comparatif-avec-gtsummary}{%
\subsection{\texorpdfstring{Tableau comparatif avec
\texttt{gtsummary}}{Tableau comparatif avec gtsummary}}\label{tableau-comparatif-avec-gtsummary}}

Dans le chapitre sur la statitstique univariée (cf.
Section~\ref{sec-tri-a-plat}), nous avons abordé comment afficher les
statistiques descriptives d'une variable continue avec
\texttt{gtsummary::tbl\_summary()}. Pour comparer une variable continue
selon plusieurs groupes définis par une variable catégorielle, il suffit
d'utiliser le paramètre \texttt{by}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ age,}
    \AttributeTok{by =}\NormalTok{ grade}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-by-cont}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2941}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2206}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2353}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2500}}@{}}
\caption{\label{tbl-by-cont}âge médian et intervalle interquartile selon
le grade}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} \\
\midrule()
\endhead
Age & 47 (37 -- 56) & 48 (37 -- 57) & 47 (38 -- 58) \\
Manquant & 2 & 6 & 3 \\
\bottomrule()
\end{longtable}

La fonction \texttt{gtsummary::add\_overall()} permet d'ajouter une
colonne total et \texttt{gtsummary::modify\_spanning\_header()}
peut-être utilisé pour ajouter un en-tête de colonne.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ age,}
    \AttributeTok{by =}\NormalTok{ grade}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_overall}\NormalTok{(}\AttributeTok{last =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{modify\_spanning\_header}\NormalTok{(}
    \FunctionTok{all\_stat\_cols}\NormalTok{(}\AttributeTok{stat\_0 =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{\textasciitilde{}} \StringTok{"**Grade**"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-by-cont-2}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2273}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1705}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1818}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1932}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2273}}@{}}
\caption{\label{tbl-by-cont-2}âge médian et intervalle interquartile
selon le grade}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Total}, N = 200
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Total}, N = 200
\end{minipage} \\
\midrule()
\endhead
Age & 47 (37 -- 56) & 48 (37 -- 57) & 47 (38 -- 58) & 47 (38 -- 57) \\
Manquant & 2 & 6 & 3 & 11 \\
\bottomrule()
\end{longtable}

Comme pour un tri à plat, on peut personnaliser les statistiques à
afficher avec \texttt{statistic}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ age,}
    \AttributeTok{by =}\NormalTok{ grade,}
    \AttributeTok{statistic =} \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\} (\{sd\})"}\NormalTok{,}
    \AttributeTok{digits =} \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_overall}\NormalTok{(}\AttributeTok{last =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-by-cont-3}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2273}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1705}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1818}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1932}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2273}}@{}}
\caption{\label{tbl-by-cont-3}âge moyen et écart-type selon le
grade}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Total}, N = 200
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Total}, N = 200
\end{minipage} \\
\midrule()
\endhead
Age & 46,2 (15,2) & 47,5 (13,7) & 48,1 (14,1) & 47,2 (14,3) \\
Manquant & 2 & 6 & 3 & 11 \\
\bottomrule()
\end{longtable}

\hypertarget{repruxe9sentations-graphiques-1}{%
\subsection{Représentations
graphiques}\label{repruxe9sentations-graphiques-1}}

La moyenne ou la médiane sont des indicateurs centraux et ne suffisent
pas à rendre compte des différences de distribution d'une variable
continue entre plusieurs sous-groupes.

Une représentation usuelle pour comparer deux distributions consiste à
avoir recours à des boîtes à moustaches que l'on obtient avec
\texttt{ggplot2::geom\_boxplot()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(trial) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ grade, }\AttributeTok{y =}\NormalTok{ age) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{fill =} \StringTok{"lightblue"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-geom_boxplot-1.pdf}

}

\caption{\label{fig-geom_boxplot}boîtes à moustache}

\end{figure}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Le trait central représente la médiane, le rectangle est délimité par le
premier et le troisème quartiles (i.e.~le 25\textsuperscript{e} et le
75\textsuperscript{e} percentiles). Les traits verticaux vont jusqu'aux
extrêmes (minimum et maximum) ou jusqu'à 1,5 fois l'intervalle
interquartile. Si des points sont situés à plus d'1,5 fois l'intervalle
interquartile au-dessus du 3\textsuperscript{e} quartile ou en-dessous
du 1\textsuperscript{er} quartile, ils sont considérés comme des valeurs
atypiques et représentés par un point. Dans l'exemple précédent, c'est
le cas des deux plus petites valeurs observées pour le grade I.

\end{tcolorbox}

Alternativement, on peut utiliser un graphique en violons qui
représentent des courbes de densité dessinées en mirroir.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(trial) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ grade, }\AttributeTok{y =}\NormalTok{ age) }\SpecialCharTok{+}
  \FunctionTok{geom\_violin}\NormalTok{(}\AttributeTok{fill =} \StringTok{"lightblue"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-geom_violin-1.pdf}

}

\caption{\label{fig-geom_violin}graphique en violons}

\end{figure}

Il est toujours possible de représenter les observations inviduelles
sous la forme d'un nuage de points. Le paramètre \texttt{alpha} permet
de rendre les points transparents afin de mieux visualiser les
supperpositions de points.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(trial) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ grade, }\AttributeTok{y =}\NormalTok{ age) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{25}\NormalTok{, }\AttributeTok{colour =} \StringTok{"blue"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-geom_point-bi-cont-cat-1.pdf}

}

\caption{\label{fig-geom_point-bi-cont-cat}un nuage de points avec une
variable continue et une variable catégorielle}

\end{figure}

Comme la variable \emph{grade} est catégorielle, tous les points d'une
meme modalité sont représentées sur une même ligne. La représentation
peut être améliorée en ajoutant un décalage aléatoire sur l'axe
horizontal. Cela s'obtient avec \texttt{ggplot2::position\_jitter()} en
précisant \texttt{height\ =\ 0} pour ne pas ajouter de décalage vertical
et \texttt{width\ =\ .2} pour décaler horizontalement les points entre
-20\% et +20\%.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(trial) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ grade, }\AttributeTok{y =}\NormalTok{ age) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}
    \AttributeTok{alpha =}\NormalTok{ .}\DecValTok{25}\NormalTok{,}
    \AttributeTok{colour =} \StringTok{"blue"}\NormalTok{,}
    \AttributeTok{position =} \FunctionTok{position\_jitter}\NormalTok{(}\AttributeTok{height =} \DecValTok{0}\NormalTok{, }\AttributeTok{width =}\NormalTok{ .}\DecValTok{2}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-geom_point-bi-cont-cat-2-1.pdf}

}

\caption{\label{fig-geom_point-bi-cont-cat-2}un nuage de points avec une
variable continue et une variable catégorielle et avec un décalage
horizontal aléatoire}

\end{figure}

La statistique \texttt{ggstats::stat\_weighted\_mean()} de
\texttt{\{ggstats\}} permets de calculer à la volée la moyenne du nuage
de points.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(trial) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ grade, }\AttributeTok{y =}\NormalTok{ age) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{stat =} \StringTok{"weighted\_mean"}\NormalTok{, }\AttributeTok{colour =} \StringTok{"blue"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-stat_weighted_mean-1.pdf}

}

\caption{\label{fig-stat_weighted_mean}âge moyen selon le grade}

\end{figure}

Cela peut être utile pour effectuer des comparaisons multiples.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(trial) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ grade, }\AttributeTok{y =}\NormalTok{ age, }\AttributeTok{colour =}\NormalTok{ stage, }\AttributeTok{group =}\NormalTok{ stage) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\AttributeTok{stat =} \StringTok{"weighted\_mean"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{stat =} \StringTok{"weighted\_mean"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(}\AttributeTok{cols =} \FunctionTok{vars}\NormalTok{(trt)) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-stat_weighted_mean-2-1.pdf}

}

\caption{\label{fig-stat_weighted_mean-2}âge moyen selon le grade, par
traitement et état d'avancement de la maladie}

\end{figure}

\hypertarget{sec-tapply}{%
\subsection{Calcul manuel}\label{sec-tapply}}

Le plus simple pour calculer des indicateurs par sous-groupe est d'avoir
recours à \texttt{dplyr::summarise()} avec \texttt{dplyr::group\_by()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(dplyr)}
\NormalTok{trial }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(grade) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{age\_moy =} \FunctionTok{mean}\NormalTok{(age, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{age\_med =} \FunctionTok{median}\NormalTok{(age, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 3 x 3
  grade age_moy age_med
  <fct>   <dbl>   <dbl>
1 I        46.2    47  
2 II       47.5    48.5
3 III      48.1    47  
\end{verbatim}

En base \textbf{R}, on peut avoir recours à \texttt{tapply()}. On lui
indique d'abord le vecteur sur lequel on souhaite réaliser le calcul,
puis un facteur qui indiquera les sous-groupes, puis une fonction qui
sera appliquée à chaque sous-groupe et enfin, optionnellement, des
arguments additionnels qui seront transmis à cette fonction.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tapply}\NormalTok{(trial}\SpecialCharTok{$}\NormalTok{age, trial}\SpecialCharTok{$}\NormalTok{grade, mean, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
       I       II      III 
46.15152 47.53226 48.11475 
\end{verbatim}

\hypertarget{tests-de-comparaison}{%
\subsection{Tests de comparaison}\label{tests-de-comparaison}}

Pour comparer des moyennes ou des médianes, le plus facile est encore
d'avoir recours à \texttt{\{gtsummary\}} et sa fonction
\texttt{gtsummary::add\_p()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ age,}
    \AttributeTok{by =}\NormalTok{ grade}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_p}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-add_p-cont}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2439}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1829}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1951}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2073}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1707}}@{}}
\caption{\label{tbl-add_p-cont}test de comparaison sur la somme des
rangs}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
Age & 47 (37 -- 56) & 48 (37 -- 57) & 47 (38 -- 58) & 0,8 \\
Manquant & 2 & 6 & 3 & \\
\bottomrule()
\end{longtable}

Par défaut, pour les \textbf{variables continues}, un test de
Kruskal-Wallis calculé avec la fonction \texttt{stats::kruskal.test()}
est utilisé lorsqu'il y a trois groupes ou plus, et un test de
Wilcoxon-Mann-Whitney calculé avec \texttt{stats::wilcox.test()} (test
de comparaison des rangs) lorsqu'il n'y a que deux groupes. Au sens
strict, il ne s'agit pas de tests de comparaison des médianes mais de
tests sur la somme des rangs\sidenote{\footnotesize Si l'on a besoin spécifiquement
  d'un test de comparaison des médianes, il existe le \textbf{test de
  Brown-Mood} disponible dans le package \texttt{\{coin\}} avec la
  fonction \texttt{coin::median\_test()}. Attention, il ne faut pas
  confondre ce test avec le \textbf{test de dispersion de Mood}
  implémenté dans la fonction \texttt{stats::mood.test()}.}. En
pratique, ces tests sont appropriés lorsque l'on présente les médianes
et les intervalles interquartiles.

Si l'on affiche des moyennes, il serait plus juste d'utiliser un test
\emph{t de Student} (test de comparaison des moyennes) calculé avec
\texttt{stats::t.test()}, valable seulement si l'on compare deux
moyennes. Pour tester si trois moyennes ou plus sont égales, on aura
plutôt recours à \texttt{stats::oneway.test()}.

On peut indiquer à \texttt{gtsummary::add\_p()} le test à utiliser avec
le paramètre \texttt{test}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ age,}
    \AttributeTok{by =}\NormalTok{ grade,}
    \AttributeTok{statistic =} \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\} (\{sd\})"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_p}\NormalTok{(}
    \AttributeTok{test =} \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"oneway.test"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Multiple parameters; naming those columns num.df, den.df
\end{verbatim}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-add_p-cont-2}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2439}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1829}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1951}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2073}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1707}}@{}}
\caption{\label{tbl-add_p-cont-2}test de comparaison des
moyennes}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
Age & 46 (15) & 48 (14) & 48 (14) & 0,7 \\
Manquant & 2 & 6 & 3 & \\
\bottomrule()
\end{longtable}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Précision statistique}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

Classiquement, le test t de Student présuppose l'égalité des variances
entre les deux sous-groupes, ce qui permet de former une estimation
commune de la variance des deux échantillons (on parle de pooled
variance), qui revient à une moyenne pondérée des variances estimées à
partir des deux échantillons. Pour tester l'égalité des variances de
deux échantillons, on peut utiliser \texttt{stats::var.test()}.

Dans le cas où l'on souhaite relaxer cette hypothèse d'égalité des
variances, le test de Welch ou la correction de Satterthwaite reposent
sur l'idée que l'on utilise les deux estimations de variance séparément,
suivie d'une approximation des degrés de liberté pour la somme de ces
deux variances.

Par défaut, la fonction \texttt{stats::t.test()} réalise un test de
Welch. Pour un test classique de Student, il faut lui préciser
\texttt{var.equal\ =\ TRUE}.

De manière similaire, \texttt{stats::oneway.test()} ne présuppose pas,
par défaut, l'égalité des variances et généralise donc le test de Welch
au cas à trois modalités ou plus. Cependant, on peut là encore indiquer
\texttt{var.equal\ =\ TRUE}, auquel cas une analyse de variance (ANOVA)
classique sera réalisée, que l'on peut aussi obtenir avec
\texttt{stats::aov()}.

Il est possible d'indiquer à \texttt{gtsummary::add\_p()} des arguments
additionnels à passer à la fonction utilisée pour réaliser le test~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ age,}
    \AttributeTok{by =}\NormalTok{ trt,}
    \AttributeTok{statistic =} \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\} (\{sd\})"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_p}\NormalTok{(}
    \AttributeTok{test =} \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"t.test"}\NormalTok{,}
    \AttributeTok{test.args =} \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \FunctionTok{list}\NormalTok{(}\AttributeTok{var.equal =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2667}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2667}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2800}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1867}}@{}}
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug A}, N = 98
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug B}, N = 102
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
Age & 47 (15) & 47 (14) & 0,8 \\
Manquant & 7 & 4 & \\
\bottomrule()
\end{longtable}

\end{tcolorbox}

\hypertarget{diffuxe9rence-de-deux-moyennes}{%
\subsection{Différence de deux
moyennes}\label{diffuxe9rence-de-deux-moyennes}}

La fonctions \texttt{gtsummary::add\_difference()} permet, pour une
variable continue et si la variable catégorielle spécifiée via
\texttt{by} n'a que deux modalités, de calculer la différence des deux
moyennes, l'intervalle de confiance de cette différence et test si cette
différence est significativement différente de 0 avec
\texttt{stats::t.test()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trial }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ age,}
    \AttributeTok{by =}\NormalTok{ trt,}
    \AttributeTok{statistic =} \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\} (\{sd\})"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_difference}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-add_difference-cont}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1942}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1942}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.2039}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1553}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1165}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1359}}@{}}
\caption{\label{tbl-add_difference-cont}différence de deux
moyennes}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug A}, N = 98
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug B}, N = 102
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Difference}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug A}, N = 98
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Drug B}, N = 102
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Difference}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
Age & 47 (15) & 47 (14) & -0,44 & -4,6 -- 3,7 & 0,8 \\
Manquant & 7 & 4 & & & \\
\bottomrule()
\end{longtable}

\hypertarget{sec-deux-variables-continues}{%
\section{Deux variables continues}\label{sec-deux-variables-continues}}

\hypertarget{repruxe9sentations-graphiques-2}{%
\subsection{Représentations
graphiques}\label{repruxe9sentations-graphiques-2}}

La comparaison de deux variables continues se fait en premier lieu
graphique, en représentant, via un nuage de points, l'ensemble des
couples de valeurs. Notez ici l'application d'un niveau de transparence
(\texttt{alpha}) afin de faciliter la lecture des points superposés.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length, }\AttributeTok{y =}\NormalTok{ Petal.Width) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{25}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-nuage-points-1.pdf}

}

\caption{\label{fig-nuage-points}nuage de points}

\end{figure}

La géométrie \texttt{ggplot2::geom\_smooth()} permets d'ajouter une
courbe de tendance au graphique, avec son intervalle de confiance. Par
défaut, il s'agit d'une régression polynomiale locale obtenue avec
\texttt{stats::loess()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length, }\AttributeTok{y =}\NormalTok{ Petal.Width) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{25}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-nuage-points-2-1.pdf}

}

\caption{\label{fig-nuage-points-2}nuage de points avec une courbe de
tendance}

\end{figure}

Pour afficher plutôt la droite de régression linéaire entre les deux
variables, on précisera \texttt{method\ =\ "lm"}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length, }\AttributeTok{y =}\NormalTok{ Petal.Width) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{25}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-nuage-points-3-1.pdf}

}

\caption{\label{fig-nuage-points-3}nuage de points avec droite de
régression linéaire}

\end{figure}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce pour afficher l'intercept}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Supposons que nous souhaitions montrer l'endroit où la droite de
régression coupe l'axe des ordonnées (soit le point sur l'axe \emph{y}
pour \emph{x = 0}).

Nous pouvons étendre la surface du graphique avec
\texttt{ggplot2::expand\_limits()}. Cependant, cela n'étend pas pour
autant la droite de régression.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length, }\AttributeTok{y =}\NormalTok{ Petal.Width) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{25}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{expand\_limits}\NormalTok{(}\AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
`geom_smooth()` using formula = 'y ~ x'
\end{verbatim}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/unnamed-chunk-41-1.pdf}

}

\end{figure}

Une solution simple consiste à utiliser l'option
\texttt{fullrange\ =\ TRUE} dans \texttt{ggplot2::geom\_smooth()} pour
étendre la droite de régression à l'ensemble du graphique.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length, }\AttributeTok{y =}\NormalTok{ Petal.Width) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{, }\AttributeTok{fullrange =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{25}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{expand\_limits}\NormalTok{(}\AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
`geom_smooth()` using formula = 'y ~ x'
\end{verbatim}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/unnamed-chunk-42-1.pdf}

}

\end{figure}

On peut contrôler plus finement la partie de droite à afficher avec
l'argument \texttt{xseq} (liste des valeurs pour lesquelles on prédit et
affiche le lissage). On peut coupler deux appels à
\texttt{ggplot2::geom\_smooth()} pour afficher l'extension de la droite
vers la gauche en pointillés. L'option \texttt{se\ =\ FALSE} permet de
ne pas calculer d'intervalles de confiance pour ce second appel.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length, }\AttributeTok{y =}\NormalTok{ Petal.Width) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}
    \AttributeTok{method =} \StringTok{"lm"}\NormalTok{, }
    \AttributeTok{xseq =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{by =}\NormalTok{ .}\DecValTok{1}\NormalTok{),}
    \AttributeTok{linetype =} \StringTok{"dotted"}\NormalTok{,}
    \AttributeTok{se =} \ConstantTok{FALSE}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{25}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{expand\_limits}\NormalTok{(}\AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
`geom_smooth()` using formula = 'y ~ x'
`geom_smooth()` using formula = 'y ~ x'
\end{verbatim}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/unnamed-chunk-43-1.pdf}

}

\end{figure}

\end{tcolorbox}

La géométrie \texttt{ggplot2::geom\_rug()} permet d'afficher une
représentation synthétique de la densité de chaque variable sur les deux
axes.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length, }\AttributeTok{y =}\NormalTok{ Petal.Width) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{25}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_rug}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-nuage-points-4-1.pdf}

}

\caption{\label{fig-nuage-points-4}nuage de points avec représentation
synthétique des densités marginales}

\end{figure}

\hypertarget{tester-la-relation-entre-les-deux-variables}{%
\subsection{Tester la relation entre les deux
variables}\label{tester-la-relation-entre-les-deux-variables}}

Si l'on a besoin de calculer le coefficient de corrélation de Pearson
entre deux variables, on aura recours à \texttt{stats::cor()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cor}\NormalTok{(iris}\SpecialCharTok{$}\NormalTok{Petal.Length, iris}\SpecialCharTok{$}\NormalTok{Petal.Width)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.9628654
\end{verbatim}

Pour aller plus loin, on peut calculer une régression linéaire entre les
deux variables avec \texttt{stats::lm()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Petal.Length }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Petal.Width, }\AttributeTok{data =}\NormalTok{ iris)}
\FunctionTok{summary}\NormalTok{(m)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Call:
lm(formula = Petal.Length ~ Petal.Width, data = iris)

Residuals:
     Min       1Q   Median       3Q      Max 
-1.33542 -0.30347 -0.02955  0.25776  1.39453 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept)  1.08356    0.07297   14.85   <2e-16 ***
Petal.Width  2.22994    0.05140   43.39   <2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.4782 on 148 degrees of freedom
Multiple R-squared:  0.9271,    Adjusted R-squared:  0.9266 
F-statistic:  1882 on 1 and 148 DF,  p-value: < 2.2e-16
\end{verbatim}

Les résultats montrent une corrélation positive et significative entre
les deux variables.

Pour une présentation propre des résultats de la régression linéaire, on
utilisera \texttt{gtsummary::tbl\_regression()}. La fonction
\texttt{gtsummary::add\_glance\_source\_note()} permet d'ajouter
différentes statistiques en notes du tableau de résultats.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_glance\_source\_note}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}lccc@{}}
\toprule()
\textbf{Caractéristique} & \textbf{Beta} & \textbf{95\% IC} &
\textbf{p-valeur} \\
\midrule()
\endhead
Petal.Width & 2,2 & 2,1 -- 2,3 & \textless0,001 \\
\bottomrule()
\end{longtable}

\hypertarget{matrice-de-corruxe9lations}{%
\section{Matrice de corrélations}\label{matrice-de-corruxe9lations}}

Le package \texttt{\{GGally\}} et sa fonction \texttt{GGally::ggpairs()}
permettent de représenter facilement une matrice de corrélation entre
plusieurs variables, tant quantitatives que qualitatives.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(GGally)}
\FunctionTok{ggpairs}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-ggpairs-1.pdf}

}

\caption{\label{fig-ggpairs}une matrice de corrélation avec ggpairs()}

\end{figure}

\texttt{GGally::ggpairs()} et sa petite sœur \texttt{GGally::ggduo()}
offrent de nombreuses options de personnalisation qui sont détaillées
sur le \href{https://ggobi.github.io/ggally/articles/ggpairs.html}{site
dédié du package}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggpairs}\NormalTok{(trial, }\AttributeTok{mapping =} \FunctionTok{aes}\NormalTok{(}\AttributeTok{colour =}\NormalTok{ trt))}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/statistique-bivariee_files/figure-pdf/fig-ggpairs-2-1.pdf}

}

\caption{\label{fig-ggpairs-2}un second example de matrice de
corrélation}

\end{figure}

\hypertarget{webin-r-6}{%
\section{webin-R}\label{webin-r-6}}

La statistique univariée est présentée dans le webin-R \#03
(\emph{statistiques descriptives avec gtsummary et esquisse}) sur
\href{https://youtu.be/oEF_8GXyP5c?t=3650}{YouTube}.

\url{https://youtu.be/oEF_8GXyP5c}

\hypertarget{sec-likert}{%
\chapter{Échelles de Likert}\label{sec-likert}}

Les échelles de Likert tirent leur nom du psychologue américain Rensis
Likert qui les a développées. Elles sont le plus souvent utilisées pour
des variables d'opinion. Elles sont codées sous forme de variable
catégorielle et chaque item est codé selone une graduation comprenant en
général cinq ou sept choix de réponse, par exemple~: Tout à fait
d'accord, D'accord, Ni en désaccord ni d'accord, Pas d'accord, Pas du
tout d'accord.

Pour les échelles à nombre impair de choix, le niveau central permet
d'exprimer une absence d'avis, ce qui rend inutile une modalité «~Ne
sait pas~». Les échelles à nombre pair de modalités voient l'omission de
la modalité neutre et sont dites «~à choix forcé~».

\hypertarget{exemple-de-donnuxe9es}{%
\section{Exemple de données}\label{exemple-de-donnuxe9es}}

Générons un jeu de données qui nous servira pour les différents
exemples.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-- Attaching core tidyverse packages ------------------------ tidyverse 2.0.0 --
v dplyr     1.1.2     v readr     2.1.4
v forcats   1.0.0     v stringr   1.5.0
v ggplot2   3.4.2     v tibble    3.2.1
v lubridate 1.9.2     v tidyr     1.3.0
v purrr     1.0.1     
-- Conflicts ------------------------------------------ tidyverse_conflicts() --
x dplyr::filter() masks stats::filter()
x dplyr::lag()    masks stats::lag()
i Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(labelled)}
\NormalTok{niveaux }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"Pas du tout d\textquotesingle{}accord"}\NormalTok{,}
  \StringTok{"Plutôt pas d\textquotesingle{}accord"}\NormalTok{,}
  \StringTok{"Ni d\textquotesingle{}accord, ni pas d\textquotesingle{}accord"}\NormalTok{,}
  \StringTok{"Plutôt d\textquotesingle{}accord"}\NormalTok{,}
  \StringTok{"Tout à fait d\textquotesingle{}accord"}
\NormalTok{)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{42}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}}
  \FunctionTok{tibble}\NormalTok{(}
    \AttributeTok{groupe =} \FunctionTok{sample}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{, }\StringTok{"B"}\NormalTok{), }\DecValTok{150}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{q1 =} \FunctionTok{sample}\NormalTok{(niveaux, }\DecValTok{150}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{q2 =} \FunctionTok{sample}\NormalTok{(niveaux, }\DecValTok{150}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{prob =} \DecValTok{5}\SpecialCharTok{:}\DecValTok{1}\NormalTok{),}
    \AttributeTok{q3 =} \FunctionTok{sample}\NormalTok{(niveaux, }\DecValTok{150}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{prob =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{),}
    \AttributeTok{q4 =} \FunctionTok{sample}\NormalTok{(niveaux, }\DecValTok{150}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{prob =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{),}
    \AttributeTok{q5 =} \FunctionTok{sample}\NormalTok{(}\FunctionTok{c}\NormalTok{(niveaux, }\ConstantTok{NA}\NormalTok{), }\DecValTok{150}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{q6 =} \FunctionTok{sample}\NormalTok{(niveaux, }\DecValTok{150}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{prob =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\FunctionTok{across}\NormalTok{(q1}\SpecialCharTok{:}\NormalTok{q6, }\SpecialCharTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(.x, }\AttributeTok{levels =}\NormalTok{ niveaux))) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{set\_variable\_labels}\NormalTok{(}
    \AttributeTok{q1 =} \StringTok{"Première question"}\NormalTok{,}
    \AttributeTok{q2 =} \StringTok{"Seconde question"}\NormalTok{,}
    \AttributeTok{q3 =} \StringTok{"Troisième question"}\NormalTok{,}
    \AttributeTok{q4 =} \StringTok{"Quatrième question"}\NormalTok{,}
    \AttributeTok{q5 =} \StringTok{"Cinquième question"}\NormalTok{,}
    \AttributeTok{q6 =} \StringTok{"Sixième question"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{tableau-de-fruxe9quence}{%
\section{Tableau de fréquence}\label{tableau-de-fruxe9quence}}

On peut tout à fait réaliser un tableau de fréquence classique avec
\texttt{gtsummary::tbl\_summary()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gtsummary)}
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}\AttributeTok{include =}\NormalTok{ q1}\SpecialCharTok{:}\NormalTok{q6)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}lc@{}}
\toprule()
\textbf{Characteristic} & \textbf{N = 150} \\
\midrule()
\endhead
Première question & \\
Pas du tout d'accord & 39 (26\%) \\
Plutôt pas d'accord & 32 (21\%) \\
Ni d'accord, ni pas d'accord & 25 (17\%) \\
Plutôt d'accord & 30 (20\%) \\
Tout à fait d'accord & 24 (16\%) \\
Seconde question & \\
Pas du tout d'accord & 56 (37\%) \\
Plutôt pas d'accord & 44 (29\%) \\
Ni d'accord, ni pas d'accord & 19 (13\%) \\
Plutôt d'accord & 26 (17\%) \\
Tout à fait d'accord & 5 (3.3\%) \\
Troisième question & \\
Pas du tout d'accord & 8 (5.3\%) \\
Plutôt pas d'accord & 17 (11\%) \\
Ni d'accord, ni pas d'accord & 29 (19\%) \\
Plutôt d'accord & 43 (29\%) \\
Tout à fait d'accord & 53 (35\%) \\
Quatrième question & \\
Pas du tout d'accord & 11 (7.3\%) \\
Plutôt pas d'accord & 19 (13\%) \\
Ni d'accord, ni pas d'accord & 31 (21\%) \\
Plutôt d'accord & 40 (27\%) \\
Tout à fait d'accord & 49 (33\%) \\
Cinquième question & \\
Pas du tout d'accord & 33 (26\%) \\
Plutôt pas d'accord & 25 (20\%) \\
Ni d'accord, ni pas d'accord & 28 (22\%) \\
Plutôt d'accord & 25 (20\%) \\
Tout à fait d'accord & 16 (13\%) \\
Unknown & 23 \\
Sixième question & \\
Pas du tout d'accord & 50 (33\%) \\
Plutôt pas d'accord & 0 (0\%) \\
Ni d'accord, ni pas d'accord & 50 (33\%) \\
Plutôt d'accord & 50 (33\%) \\
Tout à fait d'accord & 0 (0\%) \\
\bottomrule()
\end{longtable}

Cependant, cela produit un tableau inutilement long, d'autant plus que
les variables \emph{q1} à \emph{q6} ont les mêmes modalités de réponse.
Le package \texttt{\{bstfun\}} propose une fonction expérimentale
\texttt{bstfun::tbl\_likert()} offrant un affichage plus compact.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Important}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

Ce package n'est pas disponible sur \textbf{CRAN}~: il est donc
nécessaire de l'installer depuis \textbf{GitHub} avec la commande
suivante~: \texttt{remotes::install\_github("MSKCC-Epi-Bio/bstfun")}. Si
vous êtes sous \textbf{Windows}, il vous faudra probablement installer
au préalable \textbf{RTools} qui peut être téléchargé à l'adresse
\url{https://cran.r-project.org/bin/windows/Rtools/}.

\end{tcolorbox}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(bstfun)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Attachement du package : 'bstfun'
\end{verbatim}

\begin{verbatim}
L'objet suivant est masqué depuis 'package:gtsummary':

    trial
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_likert}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ q1}\SpecialCharTok{:}\NormalTok{q6}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1258}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1722}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1656}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.2252}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1391}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1722}}@{}}
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Characteristic}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Pas du tout d'accord}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Plutôt pas d'accord}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Ni d'accord, ni pas d'accord}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Plutôt d'accord}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Tout à fait d'accord}
\end{minipage} \\
\midrule()
\endhead
Première question & 39 (26\%) & 32 (21\%) & 25 (17\%) & 30 (20\%) & 24
(16\%) \\
Seconde question & 56 (37\%) & 44 (29\%) & 19 (13\%) & 26 (17\%) & 5
(3.3\%) \\
Troisième question & 8 (5.3\%) & 17 (11\%) & 29 (19\%) & 43 (29\%) & 53
(35\%) \\
Quatrième question & 11 (7.3\%) & 19 (13\%) & 31 (21\%) & 40 (27\%) & 49
(33\%) \\
Cinquième question & 33 (26\%) & 25 (20\%) & 28 (22\%) & 25 (20\%) & 16
(13\%) \\
Sixième question & 50 (33\%) & 0 (0\%) & 50 (33\%) & 50 (33\%) & 0
(0\%) \\
\bottomrule()
\end{longtable}

On peut utiliser \texttt{add\_n()} pour ajouter les effectifs totaux et
\texttt{add\_continuous\_stat()} pour ajouter une statistique continue
en traitant la variable comme un score (ici nous allons attribuer les
valeurs -2, -1, 0, +1 et +2).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_likert}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ q1}\SpecialCharTok{:}\NormalTok{q6,}
    \AttributeTok{statistic =} \SpecialCharTok{\textasciitilde{}} \StringTok{"\{p\}\%"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_n}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_continuous\_stat}\NormalTok{(}\AttributeTok{score\_values =} \SpecialCharTok{{-}}\DecValTok{2}\SpecialCharTok{:}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 14\tabcolsep) * \real{0.1131}}
  >{\centering\arraybackslash}p{(\columnwidth - 14\tabcolsep) * \real{0.0417}}
  >{\centering\arraybackslash}p{(\columnwidth - 14\tabcolsep) * \real{0.1548}}
  >{\centering\arraybackslash}p{(\columnwidth - 14\tabcolsep) * \real{0.1488}}
  >{\centering\arraybackslash}p{(\columnwidth - 14\tabcolsep) * \real{0.2024}}
  >{\centering\arraybackslash}p{(\columnwidth - 14\tabcolsep) * \real{0.1250}}
  >{\centering\arraybackslash}p{(\columnwidth - 14\tabcolsep) * \real{0.1548}}
  >{\centering\arraybackslash}p{(\columnwidth - 14\tabcolsep) * \real{0.0595}}@{}}
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Characteristic}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{N}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Pas du tout d'accord}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Plutôt pas d'accord}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Ni d'accord, ni pas d'accord}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Plutôt d'accord}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Tout à fait d'accord}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Mean}
\end{minipage} \\
\midrule()
\endhead
Première question & 150 & 26\% & 21\% & 17\% & 20\% & 16\% & -0.21 \\
Seconde question & 150 & 37\% & 29\% & 13\% & 17\% & 3.3\% & -0.80 \\
Troisième question & 150 & 5.3\% & 11\% & 19\% & 29\% & 35\% & 0.77 \\
Quatrième question & 150 & 7.3\% & 13\% & 21\% & 27\% & 33\% & 0.65 \\
Cinquième question & 127 & 26\% & 20\% & 22\% & 20\% & 13\% & -0.27 \\
Sixième question & 150 & 33\% & 0\% & 33\% & 33\% & 0\% & -0.33 \\
\bottomrule()
\end{longtable}

\hypertarget{repruxe9sentations-graphiques-3}{%
\section{Représentations
graphiques}\label{repruxe9sentations-graphiques-3}}

À partir de sa version 0.3.0, le package \texttt{\{ggstats\}} propose
une fonction \texttt{ggstats::gglikert()} pour représenter des données
de Likert sous forme d'un diagramme en barre centré sur la modalité
centrale.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggstats)}
\FunctionTok{gglikert}\NormalTok{(df, }\AttributeTok{include =}\NormalTok{ q1}\SpecialCharTok{:}\NormalTok{q6)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/likert_files/figure-pdf/unnamed-chunk-5-1.pdf}

}

\end{figure}

Par défaut, les pourcentages totaux ne prennent pas en compte la
modalité centrale (lorsque le nombre de modalité est impair). On peut
inclure la modalité centrale avec
\texttt{totals\_include\_center\ =\ TRUE}, auquel cas la modalité
centrale seront comptabilisée pour moitié de chaque côté. Le paramètre
\texttt{sort} permet de trier les modalités (voir l'aide de
\texttt{ggstats::gglikert()} pour plus de détails sur les différentes
méthodes de tri).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{gglikert}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ q1}\SpecialCharTok{:}\NormalTok{q6,}
    \AttributeTok{totals\_include\_center =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{sort =} \StringTok{"ascending"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}
    \AttributeTok{fill =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{nrow =} \DecValTok{2}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/likert_files/figure-pdf/unnamed-chunk-6-1.pdf}

}

\end{figure}

Il est possible de séparer les résultats par sous-groupe avec des
facettes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{gglikert}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ q1}\SpecialCharTok{:}\NormalTok{q6,}
    \AttributeTok{facet\_cols =} \FunctionTok{vars}\NormalTok{(groupe)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/likert_files/figure-pdf/unnamed-chunk-7-1.pdf}

}

\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{gglikert}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ q1}\SpecialCharTok{:}\NormalTok{q6,}
    \AttributeTok{y =} \StringTok{"groupe"}\NormalTok{,}
    \AttributeTok{facet\_rows =} \FunctionTok{vars}\NormalTok{(.question),}
    \AttributeTok{facet\_label\_wrap =} \DecValTok{15}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/likert_files/figure-pdf/unnamed-chunk-7-2.pdf}

}

\end{figure}

Une représentation alternative consiste à réaliser un graphique en
barres classiques, ce que l'on peut aisément obtenir avec
\texttt{ggstats::gglikert\_stacked()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{gglikert\_stacked}\NormalTok{(}
    \AttributeTok{include =}\NormalTok{ q1}\SpecialCharTok{:}\NormalTok{q6,}
    \AttributeTok{sort =} \StringTok{"ascending"}\NormalTok{,}
    \AttributeTok{add\_median\_line =} \ConstantTok{TRUE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/likert_files/figure-pdf/unnamed-chunk-8-1.pdf}

}

\end{figure}

\hypertarget{sec-regression-lineaire}{%
\chapter{Régression linéaire}\label{sec-regression-lineaire}}

Un modèle de régression linéaire est un modèle de régression qui cherche
à établir une relation linéaire entre une \textbf{variable continue},
dite expliquée, et une ou plusieurs variables, dites explicatives.

\hypertarget{sec-regression-lineaire-variable-explicative-continue}{%
\section{Modèle à une seule variable explicative
continue}\label{sec-regression-lineaire-variable-explicative-continue}}

Nous avons déjà abordé très rapidement la régression linéaire dans le
chapitre sur la \emph{statistique bivariée} (cf.
Section~\ref{sec-deux-variables-continues}).

Reprenons le même exemple à partir du jeu de données \texttt{iris} qui
comporte les caractéristiques de 150 fleurs de trois espèces différentes
d'iris. Nous cherchons dans un premier temps à explorer la relation
entre la largeur (\emph{Petal.Width}) et la longueur des pétales
(\emph{Petal.Length}). Représentons cette relation sous la forme d'un
nuage de points.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length, }\AttributeTok{y =}\NormalTok{ Petal.Width) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{25}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Longueur"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Largeur"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/regression-lineaire_files/figure-pdf/fig-rel-petal.width-petal.length-1.pdf}

}

\caption{\label{fig-rel-petal.width-petal.length}Relation entre la
largeur et la longueur des pétales (nuage de points)}

\end{figure}

Il semble bien qu'il y a une \textbf{relation linéaire} entre ces deux
variables, c'est-à-dire que la relation entre ces deux variables peut
être représentée sous la forme d'une droite. Pour cela, on va rechercher
la droite telle que la distance entre les points observés et la droite
soit la plus petite possible. Cette droite peut être représentée
graphique avec \texttt{ggplot2::geom\_smooth()} et l'option
\texttt{method\ =\ "lm"}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length, }\AttributeTok{y =}\NormalTok{ Petal.Width) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{25}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Longueur"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Largeur"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/regression-lineaire_files/figure-pdf/fig-rel-petal.width-petal.length-lm-1.pdf}

}

\caption{\label{fig-rel-petal.width-petal.length-lm}Relation linéaire
entre la largeur et la longueur des pétales}

\end{figure}

La fonction de base pour calculer une régression linéaire est la
fonction \texttt{stats::m()}. On doit en premier lieu spécifier le
modèle à l'aide d'une \textbf{formule} : on indique la variable à
expliquer dans la partie gauche de la formule et la variable explicative
dans la partie droite, les deux parties étant séparées par un
tilde\sidenote{\footnotesize Avec un clavier français, sous WIndows, le caracère tilde
  s'obtient en pressant simulténament les touches Alt Gr et 7.}
(\texttt{\textasciitilde{}}).

Dans le cas présent, la variable \emph{Petal.Width} fait office de
variable à expliquer et \emph{Petal.Length} de variable explicative. Le
modèle s'écrit donc
\texttt{Petal.Width\ \textasciitilde{}\ Petal.Length}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Petal.Width }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Petal.Length, }\AttributeTok{data =}\NormalTok{ iris)}
\NormalTok{mod}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Call:
lm(formula = Petal.Width ~ Petal.Length, data = iris)

Coefficients:
 (Intercept)  Petal.Length  
     -0.3631        0.4158  
\end{verbatim}

Le résultat comporte deux coefficients. Le premier, d'une valeur de
\(0,4158\), est associé à la variable \emph{Petal.Length} et indique la
pente de la courbe (on parle de \emph{slope} en anglais). Le second,
d'une valeur de \(-0,3631\), représente l'ordonnée à l'origine
(\emph{intercept} en anglais), c'est-à-dire la valeur estimée de
\emph{Petal.Width} lorsque \emph{Petal.Length} vaut 0. Nous pouvons
rendre cela plus visible en élargissant notre graphique.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Petal.Length, }\AttributeTok{y =}\NormalTok{ Petal.Width) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{25}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_abline}\NormalTok{(}
    \AttributeTok{intercept =}\NormalTok{ mod}\SpecialCharTok{$}\NormalTok{coefficients[}\DecValTok{1}\NormalTok{],}
    \AttributeTok{slope =}\NormalTok{ mod}\SpecialCharTok{$}\NormalTok{coefficients[}\DecValTok{2}\NormalTok{],}
    \AttributeTok{linewidth =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{colour =} \StringTok{"red"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \DecValTok{0}\NormalTok{, }\AttributeTok{linewidth =} \DecValTok{1}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dotted"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Longueur"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Largeur"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{expand\_limits}\NormalTok{(}\AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_light}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/regression-lineaire_files/figure-pdf/fig-rel-petal.width-petal.length-lm2-1.pdf}

}

\caption{\label{fig-rel-petal.width-petal.length-lm2}Relation linéaire
entre la largeur et la longueur des pétales (représentation graphique de
l'intercept)}

\end{figure}

Le modèle linéaire calculé estime donc que le relation entre nos deux
variables peut s'écrire sous la forme suivante~:

\[
Petal.Width = 0,4158 \cdot Petal.Length - 0,3631
\]

Le package \texttt{\{gtsummary\}} fournit
\texttt{gtsummary::tbl\_regression()}, une fonction bien pratique pour
produire un tableau propre avec les coefficients du modèle, leur
intervalle de confiance à 95\% et leur p-valeurs\sidenote{\footnotesize Si l'on a
  besoin de ces informations sous la forme d'un tableau de données
  classique, on pourra se référer à
  \texttt{broom.helpers::tidy\_plus\_plus()}, utilisée de manière
  sous-jacente par \texttt{gtsummary::tbl\_regression()}, ainsi qu'à la
  méthode \texttt{broom::tidy()}. Ces fonctions sont génériques et peut
  être utilisées avec une très grande variété de modèles.}. On précisera
\texttt{intercept\ =\ TRUE} pour forcer l'affichage de
l'\emph{intercept} qui est masqué par défaut.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gtsummary)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
#StandWithUkraine
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{intercept =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-regression-lm}{}
\begin{longtable}[]{@{}lccc@{}}
\caption{\label{tbl-regression-lm}un tableau mis en forme des
coefficients du modèle}\tabularnewline
\toprule()
\textbf{Characteristic} & \textbf{Beta} & \textbf{95\% CI} &
\textbf{p-value} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Characteristic} & \textbf{Beta} & \textbf{95\% CI} &
\textbf{p-value} \\
\midrule()
\endhead
(Intercept) & -0.36 & -0.44, -0.28 & \textless0.001 \\
Petal.Length & 0.42 & 0.40, 0.43 & \textless0.001 \\
\bottomrule()
\end{longtable}

Les p-valeurs calculées nous indique si le coefficient est
statistiquement différent de 0. En effet, pour la variable explicative,
cela nous indique si la relation est statistiquement significative. Le
signe du coefficient (positif ou négatif) nous indique le sens de la
relation.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Dans certains cas, si l'on suppose que la relation entre les deux
variables est proportionnelle, on peut souhaiter calculer un modèle sans
\emph{intercept}. Par défaut, \textbf{R} ajoute un \emph{intercept} à
ses modèles. Pour forcer le calcul d'un modèle sans \emph{intercept}, on
ajoutera \texttt{-\ 1} à la formule défissant le modèle.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lm}\NormalTok{(Petal.Width }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Petal.Length }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{, }\AttributeTok{data =}\NormalTok{ iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Call:
lm(formula = Petal.Width ~ Petal.Length - 1, data = iris)

Coefficients:
Petal.Length  
      0.3365  
\end{verbatim}

\end{tcolorbox}

\hypertarget{sec-regression-lineaire-variable-explicative-categorielle}{%
\section{Modèle à une seule variable explicative
catégorielle}\label{sec-regression-lineaire-variable-explicative-categorielle}}

Si dans un modèle linéaire la variable à expliquer est nécessairement
continue, il est possible de définir une variable explicative
catégorielle. Prenons la variable \emph{Species}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(labelled)}
\NormalTok{iris }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{look\_for}\NormalTok{(}\StringTok{"Species"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values    
 5   Species  —     fct      0       setosa    
                                     versicolor
                                     virginica 
\end{verbatim}

Il s'agit d'un facteur à trois modalités. Par défaut, la première valeur
du facteur (ici \emph{setosa}) va servir de modalité de référence.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Petal.Width }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species, }\AttributeTok{data =}\NormalTok{ iris)}
\NormalTok{mod}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Call:
lm(formula = Petal.Width ~ Species, data = iris)

Coefficients:
      (Intercept)  Speciesversicolor   Speciesvirginica  
            0.246              1.080              1.780  
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{intercept =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-regression-lm-2}{}
\begin{longtable}[]{@{}lccc@{}}
\caption{\label{tbl-regression-lm-2}régression linaire avec une variable
explicative catégorielle}\tabularnewline
\toprule()
\textbf{Characteristic} & \textbf{Beta} & \textbf{95\% CI} &
\textbf{p-value} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Characteristic} & \textbf{Beta} & \textbf{95\% CI} &
\textbf{p-value} \\
\midrule()
\endhead
(Intercept) & 0.25 & 0.19, 0.30 & \textless0.001 \\
Species & & & \\
setosa & --- & --- & \\
versicolor & 1.1 & 1.0, 1.2 & \textless0.001 \\
virginica & 1.8 & 1.7, 1.9 & \textless0.001 \\
\bottomrule()
\end{longtable}

Dans ce cas de figure, l'\emph{intercept} représente la situation à la
référence, donc pour l'espèce \emph{setosa}.

Calculons les moyennes par espèce~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iris }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(Species) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}\FunctionTok{mean}\NormalTok{(Petal.Width))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 3 x 2
  Species    `mean(Petal.Width)`
  <fct>                    <dbl>
1 setosa                   0.246
2 versicolor               1.33 
3 virginica                2.03 
\end{verbatim}

Comme on le voit, l'\emph{intercept} nous indique donc la moyenne
observée pour l'espèce de référence (\(0,246\)).

Le coefficient associé à \emph{versicolor} correspond à la différence
par rapport à la référence (ici \(+1,080\)). Comme vous pouvez le
constater, il s'agit de la différence entre la moyenne observée pour
versicolor (\(1,326\)) et celle de la référence setosa (\(0,246\))~:
\(1,326-0,246=1,080\).

Ce coefficient est significativement différent de 0 (p\textless0,001),
indiquant que la largeur des pétales diffère significativement entre les
deux espèces.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Lorsque l'on calcule le même modèle sans \emph{intercept}, les
coefficients s'interprètent un différement~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lm}\NormalTok{(Petal.Width }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Species }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{, }\AttributeTok{data =}\NormalTok{ iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Call:
lm(formula = Petal.Width ~ Species - 1, data = iris)

Coefficients:
    Speciessetosa  Speciesversicolor   Speciesvirginica  
            0.246              1.326              2.026  
\end{verbatim}

En l'absence d'\emph{intercept}, trois coefficients sont calculés et il
n'y a plus ici de modalité de référence. Chaque coefficient représente
donc la moyenne observée pour chaque modalité.

On appelle \textbf{contrastes} les différents manières de coder des
variables catégorielles dans un modèle. Nous y reviendrons plus en
détail dans un chapitre dédié (cf. Chapitre~\ref{sec-contrastes}).

\end{tcolorbox}

\hypertarget{sec-regression-lineaire-multivariee}{%
\section{Modèle à plusieurs variables
explicatives}\label{sec-regression-lineaire-multivariee}}

Un des intérêts de la régression linéaire est de pouvoir estimer un
modèle multivarié, c'est-à-dire avec plusieurs variables explicatives.
Pour cela, on listera les différentes variables explicatives dans la
partioe droite de la formule, séparées par le symbole \texttt{+}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(}
\NormalTok{  Petal.Width }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Petal.Length }\SpecialCharTok{+}\NormalTok{ Sepal.Width }\SpecialCharTok{+}\NormalTok{ Sepal.Length }\SpecialCharTok{+}\NormalTok{ Species,}
  \AttributeTok{data =}\NormalTok{ iris}
\NormalTok{)}
\NormalTok{mod}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Call:
lm(formula = Petal.Width ~ Petal.Length + Sepal.Width + Sepal.Length + 
    Species, data = iris)

Coefficients:
      (Intercept)       Petal.Length        Sepal.Width       Sepal.Length  
         -0.47314            0.24220            0.24220           -0.09293  
Speciesversicolor   Speciesvirginica  
          0.64811            1.04637  
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{intercept =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-regression-lm-3}{}
\begin{longtable}[]{@{}lccc@{}}
\caption{\label{tbl-regression-lm-3}régression linaire avec plusieurs
variables explicatives}\tabularnewline
\toprule()
\textbf{Characteristic} & \textbf{Beta} & \textbf{95\% CI} &
\textbf{p-value} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Characteristic} & \textbf{Beta} & \textbf{95\% CI} &
\textbf{p-value} \\
\midrule()
\endhead
(Intercept) & -0.47 & -0.82, -0.12 & 0.008 \\
Petal.Length & 0.24 & 0.15, 0.34 & \textless0.001 \\
Sepal.Width & 0.24 & 0.15, 0.34 & \textless0.001 \\
Sepal.Length & -0.09 & -0.18, 0.00 & 0.039 \\
Species & & & \\
setosa & --- & --- & \\
versicolor & 0.65 & 0.40, 0.89 & \textless0.001 \\
virginica & 1.0 & 0.72, 1.4 & \textless0.001 \\
\bottomrule()
\end{longtable}

Ce type de modèle permet d'estimer l'effet de chaque variable
explicative, toutes choses égales par ailleurs. Dans le cas présent, on
s'aperçoit que la largeur des pétales diffère significativement selon
les espèces, est fortement corrélée positivement à la longueur du pétale
et la largeur du sépale et qu'il y a, lorsque l'on ajuste sur l'ensemble
des autres variables, une relation négative (faiblement significative)
avec la longueur du sépale.

Lorsque le nombre de coefficients est élevé, une représentation
graphique est souvent plus facile à lire qu'un tableau. On parle alors
de graphique en forêt ou \emph{forest plot} en anglais. Rien de plus
facile~! Il suffit d'avoir recours à \texttt{ggstats::ggcoef\_model()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggstats)}
\FunctionTok{ggcoef\_model}\NormalTok{(mod)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/regression-lineaire_files/figure-pdf/fig-forest-plot-lm-1.pdf}

}

\caption{\label{fig-forest-plot-lm}un graphique en forêt des
coefficients du modèle}

\end{figure}

\hypertarget{sec-regression-logistique-binaire}{%
\chapter{Régression logistique
binaire}\label{sec-regression-logistique-binaire}}

Dans le chapitre précédent (Chapitre~\ref{sec-regression-lineaire}),
nous avons abordé la régression linéaire pour les variables continues.
Pour analyser une variable catégorielle, il est nécessaire d'avoir
recours à d'autres types de modèles. Les modèles linéaires généralisés
(\emph{generalized linear models} ou \emph{GLM} en anglais) sont une
généralisation de la régression linéaire grâce à l'utilisation d'une
fonction de \textbf{lien} utilisée pour transformer la variable à
expliquer et pouvoir ainsi retomber sur un modèle linéaire classique. Il
existe de multiples fonctions de lien correspondant à tout autant de
modèles. Par exemple, on pourra utiliser un modèle de Poisson pour une
variable entière positive ou un modèle d'incidence.

Pour une variable binaire (c'est-à-dire du type oui / non ou vrai /
faux), les modèles les plus courants utilisent les fonctions de lien
\emph{probit} ou \emph{logit}, cette dernière fonction correspondent à
la \textbf{régression logistique binaire} (modèle \emph{logit}). Comme
pour la régression linéaire, les variables explicatives peuvent être
continues et/ou catégorielles.

\hypertarget{pruxe9paration-des-donnuxe9es}{%
\section{Préparation des données}\label{pruxe9paration-des-donnuxe9es}}

Dans ce chapitre, nous allons encore une fois utiliser les données de
l'enquête \emph{Histoire de vie}, fournies avec l'extension
\texttt{\{questionr\}}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(hdv2003, }\AttributeTok{package =} \StringTok{"questionr"}\NormalTok{)}
\NormalTok{d }\OtherTok{\textless{}{-}}\NormalTok{ hdv2003}
\end{Highlighting}
\end{Shaded}

À titre d'exemple, nous allons étudier l'effet de l'âge, du sexe, du
niveau d'étude, de la pratique religieuse et du nombre moyen d'heures
passées à regarder la télévision par jour sur la probabilité de
pratiquer un sport.

En premier lieu, il importe de vérifier, par exemple avec
\texttt{labelled::look\_for()}, que notre variable d'intérêt (ici
\emph{sport}) est correctement codée, c'est-à-dire que la première
modalité correspondent à la référence (soit ne pas avoir vécu
l'évènement d'intérêt) et que la seconde modalité corresponde au fait
d'avoir vécu l'évènement.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(labelled)}
\NormalTok{d }\SpecialCharTok{|\textgreater{}} \FunctionTok{look\_for}\NormalTok{(}\StringTok{"sport"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values
 19  sport    —     fct      0       Non   
                                     Oui   
\end{verbatim}

Dans notre exemple, la modalité Non est déjà la première modalité. Il
n'y a donc pas besoin de modifier notre variable.

Il faut également la présence éventuelle de données manquantes
(\texttt{NA})\sidenote{\footnotesize Pour visualiser le nombre de données manquantes
  (\texttt{NA}) de l'ensemble des variables d'un tableau, on pourra
  avoir recours à \texttt{questionr::freq.na()}.}. Les observations
concernées seront tout simplement exclues du modèle lors de son calcul.
Ce n'est pas notre cas ici.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Alternativement, on pourra aussi coder notre variable à expliquer sous
forme booléenne (\texttt{FALSE} / \texttt{TRUE}) ou numériquement en
\texttt{0}/\texttt{1}.

Il est possible d'indiquer un facteur à plus de deux modalités. Dans une
telle situation, \textbf{R} considérera que tous les modalités, sauf la
modalité de référence, est une réalisation de la variable d'intérêt.
Cela serait correct, par exemple, si notre variable sport était codée
ainsi~: Non, Oui, de temps en temps, Oui, régulièrement. Cependant, afin
d'éviter tout risque d'erreur ou de mauvaise interprétation, il est
vivement conseillé de recoder au préalable sa variable d'intérêt en un
facteur à deux modalités.

\end{tcolorbox}

La notion de \textbf{modalité de référence} s'applique également aux
variables explicatives catégorielles. En effet, dans un modèle, tous les
coefficients sont calculés par rapport à la modalité de référence (cf.
Section~\ref{sec-regression-lineaire-variable-explicative-categorielle}).
Il importe donc de choisir une modalité de référence qui fasse sens afin
de faciliter l'interprétation. Par ailleurs, ce choix doit dépendre de
la manière dont on souhaite présenter les résultats (le \emph{data
storytelling} est essentiel). De manière générale on évitera de choisir
comme référence une modalité peu représentée dans l'échantillon ou bien
une modalité correspondant à une situation atypique.

Prenons l'exemple de la variable \emph{sexe}. Souhaite-t-on connaitre
l'effet d'être une femme par rapport au fait d'être un homme ou bien
l'effet d'être un homme par rapport au fait d'être une femme~? Si l'on
opte pour le second, alors notre modalité de référence sera le sexe
féminin. Comme est codée cette variable~?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\SpecialCharTok{|\textgreater{}} \FunctionTok{look\_for}\NormalTok{(}\StringTok{"sexe"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values
 3   sexe     —     fct      0       Homme 
                                     Femme 
\end{verbatim}

La modalité Femme s'avère ne pas être la première modalité. Nous devons
appliquer la fonction \texttt{forcats::fct\_relevel()} ou la fonction
\texttt{stats::relevel()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\NormalTok{d }\OtherTok{\textless{}{-}}\NormalTok{ d }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{sexe =}\NormalTok{ sexe }\SpecialCharTok{|\textgreater{}} \FunctionTok{fct\_relevel}\NormalTok{(}\StringTok{"Femme"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d}\SpecialCharTok{$}\NormalTok{sexe }\SpecialCharTok{|\textgreater{}}\NormalTok{ questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
         n  % val%
Femme 1101 55   55
Homme  899 45   45
\end{verbatim}

\textbf{Données labellisées}

Si l'on utilise des données labellisées (voir
Chapitre~\ref{sec-etiquettes-valeurs}), nos variables catégorielles
seront stockées sous la forme d'un vecteur numérique avec des
étiquettes. Il sera donc nécessaire de convertir ces variables en
facteurs, tout simplement avec \texttt{labelled::to\_factor()} ou
\texttt{labelled::unlabelled()}.

Les variables \emph{age} et \emph{heures.tv} sont des variables
quantitatives. Il importe de vérifier qu'elles sont bien enregistrées en
tant que variables numériques. En effet, il arrive parfois que dans le
fichier source les variables quantitatives soient renseignées sous forme
de valeur textuelle et non sous forme numérique.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\SpecialCharTok{|\textgreater{}} \FunctionTok{look\_for}\NormalTok{(}\StringTok{"age"}\NormalTok{, }\StringTok{"heures"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable  label col_type missing values
 2   age       —     int      0             
 20  heures.tv —     dbl      5             
\end{verbatim}

Nos deux variables sont bien renseignées sous forme numérique
(respectivement des entiers et des nombres décimaux).

Cependant, l'effet de l'âge est rarement linéaire. Un exemple trivial
est par exemple le fait d'occuper un emploi qui sera moins fréquent aux
jeunes âges et aux âges élevés. Dès lors, on pourra transformer la
variable \emph{age} en groupe d'âges (et donc en variable catégorielle)
avec la fonction \texttt{cut()} (cf. Section~\ref{sec-cut})~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\OtherTok{\textless{}{-}}\NormalTok{ d }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{groupe\_ages =}\NormalTok{ age }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{cut}\NormalTok{(}
        \FunctionTok{c}\NormalTok{(}\DecValTok{18}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{45}\NormalTok{, }\DecValTok{65}\NormalTok{, }\DecValTok{99}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}\NormalTok{,}
        \AttributeTok{include.lowest =} \ConstantTok{TRUE}\NormalTok{,}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"18{-}24 ans"}\NormalTok{, }\StringTok{"25{-}44 ans"}\NormalTok{,}
                   \StringTok{"45{-}64 ans"}\NormalTok{, }\StringTok{"65 ans et plus"}\NormalTok{)}
\NormalTok{      )}
\NormalTok{  )}
\NormalTok{d}\SpecialCharTok{$}\NormalTok{groupe\_ages }\SpecialCharTok{|\textgreater{}}\NormalTok{ questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                 n    % val%
18-24 ans      169  8.5  8.5
25-44 ans      706 35.3 35.3
45-64 ans      745 37.2 37.2
65 ans et plus 380 19.0 19.0
\end{verbatim}

Jetons maintenant un oeil à la variable \emph{nivetud}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d}\SpecialCharTok{$}\NormalTok{nivetud }\SpecialCharTok{|\textgreater{}}\NormalTok{ questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                                                                  n    % val%
N'a jamais fait d'etudes                                         39  2.0  2.1
A arrete ses etudes, avant la derniere annee d'etudes primaires  86  4.3  4.6
Derniere annee d'etudes primaires                               341 17.0 18.1
1er cycle                                                       204 10.2 10.8
2eme cycle                                                      183  9.2  9.7
Enseignement technique ou professionnel court                   463 23.2 24.5
Enseignement technique ou professionnel long                    131  6.6  6.9
Enseignement superieur y compris technique superieur            441 22.0 23.4
NA                                                              112  5.6   NA
\end{verbatim}

En premier lieu, cette variable est détaillée en pas moins de huit
modalités dont certaines sont peu représentées (seulement 39 individus
soit 2~\% n'ont jamais fait d'études par exemple). Afin d'améliorier
notre modèle logistique, il peut être pertinent de regrouper certaines
modalités (cf. Section~\ref{sec-modifier-modalites})~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\OtherTok{\textless{}{-}}\NormalTok{ d }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{etudes =}\NormalTok{ nivetud }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{fct\_recode}\NormalTok{(}
      \StringTok{"Primaire"} \OtherTok{=} \StringTok{"N\textquotesingle{}a jamais fait d\textquotesingle{}etudes"}\NormalTok{,}
      \StringTok{"Primaire"} \OtherTok{=} \StringTok{"A arrete ses etudes, avant la derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
      \StringTok{"Primaire"} \OtherTok{=} \StringTok{"Derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
      \StringTok{"Secondaire"} \OtherTok{=} \StringTok{"1er cycle"}\NormalTok{,}
      \StringTok{"Secondaire"} \OtherTok{=} \StringTok{"2eme cycle"}\NormalTok{,}
      \StringTok{"Technique / Professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel court"}\NormalTok{,}
      \StringTok{"Technique / Professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel long"}\NormalTok{,}
      \StringTok{"Supérieur"} \OtherTok{=} \StringTok{"Enseignement superieur y compris technique superieur"}
\NormalTok{    )    }
\NormalTok{  )}
\NormalTok{d}\SpecialCharTok{$}\NormalTok{etudes }\SpecialCharTok{|\textgreater{}}\NormalTok{ questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                            n    % val%
Primaire                  466 23.3 24.7
Secondaire                387 19.4 20.5
Technique / Professionnel 594 29.7 31.5
Supérieur                 441 22.0 23.4
NA                        112  5.6   NA
\end{verbatim}

Notre variable comporte également 112 individus avec une valeur
manquante. Si nous conservons cette valeur manquante, ces 112 individus
seront, par défaut, exclus de l'analyse. Ces valeurs manquantes n'étant
pas négligeable (5,6~\%), nous pouvons également faire le choix de
considérer ces valeurs manquantes comme une modalité supplémentaire.
Auquel cas, nous utiliserons la fonction
\texttt{forcats::fct\_na\_value\_to\_level()} ~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d}\SpecialCharTok{$}\NormalTok{etudes }\OtherTok{\textless{}{-}}\NormalTok{ d}\SpecialCharTok{$}\NormalTok{etudes }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_na\_value\_to\_level}\NormalTok{(}\StringTok{"Non documenté"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Enfin, pour améliorer les différentes sorties (tableaux et figures),
nous allons ajouter des étiquettes de variables (cf.
Chapitre~\ref{sec-etiquettes-variables}) avec
\texttt{labelled::set\_variable\_labels()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\OtherTok{\textless{}{-}}\NormalTok{ d }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{set\_variable\_labels}\NormalTok{(}
    \AttributeTok{sport =} \StringTok{"Pratique un sport ?"}\NormalTok{,}
    \AttributeTok{sexe =} \StringTok{"Sexe"}\NormalTok{,}
    \AttributeTok{groupe\_ages =} \StringTok{"Groupe d\textquotesingle{}âges"}\NormalTok{,}
    \AttributeTok{etudes =} \StringTok{"Niveau d\textquotesingle{}études"}\NormalTok{,}
    \AttributeTok{relig =} \StringTok{"Rapport à la religion"}\NormalTok{,}
    \AttributeTok{heures.tv =} \StringTok{"Heures de télévision / jour"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Code récapitulatif (préparation des données)}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(hdv2003, }\AttributeTok{package =} \StringTok{"questionr"}\NormalTok{)}
\NormalTok{d }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{sexe =}\NormalTok{ sexe }\SpecialCharTok{|\textgreater{}} \FunctionTok{fct\_relevel}\NormalTok{(}\StringTok{"Femme"}\NormalTok{),}
    \AttributeTok{groupe\_ages =}\NormalTok{ age }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{cut}\NormalTok{(}
        \FunctionTok{c}\NormalTok{(}\DecValTok{18}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{45}\NormalTok{, }\DecValTok{65}\NormalTok{, }\DecValTok{99}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}\NormalTok{,}
        \AttributeTok{include.lowest =} \ConstantTok{TRUE}\NormalTok{,}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"18{-}24 ans"}\NormalTok{, }\StringTok{"25{-}44 ans"}\NormalTok{,}
                   \StringTok{"45{-}64 ans"}\NormalTok{, }\StringTok{"65 ans et plus"}\NormalTok{)}
\NormalTok{      ),}
    \AttributeTok{etudes =}\NormalTok{ nivetud }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{fct\_recode}\NormalTok{(}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"N\textquotesingle{}a jamais fait d\textquotesingle{}etudes"}\NormalTok{,}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"A arrete ses etudes, avant la derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"Derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
        \StringTok{"Secondaire"} \OtherTok{=} \StringTok{"1er cycle"}\NormalTok{,}
        \StringTok{"Secondaire"} \OtherTok{=} \StringTok{"2eme cycle"}\NormalTok{,}
        \StringTok{"Technique / Professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel court"}\NormalTok{,}
        \StringTok{"Technique / Professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel long"}\NormalTok{,}
        \StringTok{"Supérieur"} \OtherTok{=} \StringTok{"Enseignement superieur y compris technique superieur"}
\NormalTok{    ) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{fct\_na\_value\_to\_level}\NormalTok{(}\StringTok{"Non documenté"}\NormalTok{)  }
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{set\_variable\_labels}\NormalTok{(}
    \AttributeTok{sport =} \StringTok{"Pratique un sport ?"}\NormalTok{,}
    \AttributeTok{sexe =} \StringTok{"Sexe"}\NormalTok{,}
    \AttributeTok{groupe\_ages =} \StringTok{"Groupe d\textquotesingle{}âges"}\NormalTok{,}
    \AttributeTok{etudes =} \StringTok{"Niveau d\textquotesingle{}études"}\NormalTok{,}
    \AttributeTok{relig =} \StringTok{"Rapport à la religion"}\NormalTok{,}
    \AttributeTok{heures.tv =} \StringTok{"Heures de télévision / jour"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\end{tcolorbox}

\hypertarget{statistiques-descriptives}{%
\section{Statistiques descriptives}\label{statistiques-descriptives}}

Avant toute analyse multivariée, il est toujours bon de procéder à une
analyse descriptive bivariée simple, tout simplement avec
\texttt{gtsummary::tbl\_summary()}. Ajoutons quelques tests de
comparaison avec \texttt{gtsummary::add\_p()}. Petite astuce~:
\texttt{gtsummary::modify\_spanning\_header()} permet de rajouter un
en-tête sur plusieurs colonnes.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gtsummary)}
\FunctionTok{theme\_gtsummary\_language}\NormalTok{(}\StringTok{"fr"}\NormalTok{, }\AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{, }\AttributeTok{big.mark =} \StringTok{" "}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{by =}\NormalTok{ sport,}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(sexe, groupe\_ages, etudes, relig, heures.tv)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{add\_overall}\NormalTok{(}\AttributeTok{last =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_p}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{modify\_spanning\_header}\NormalTok{(}
    \AttributeTok{update =} \FunctionTok{all\_stat\_cols}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"**Pratique un sport ?**"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-analyse-bivariee}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2963}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1852}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1852}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2037}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1296}}@{}}
\caption{\label{tbl-analyse-bivariee}Pratique d'un sport selon
différentes variables explicatives (analyse bivariée)}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Non}, N = 1 277
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Oui}, N = 723
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Total}, N = 2 000
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Non}, N = 1 277
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Oui}, N = 723
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Total}, N = 2 000
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
\textbf{Sexe} & & & & \textless0,001 \\
Femme & 747 (58\%) & 354 (49\%) & 1 101 (55\%) & \\
Homme & 530 (42\%) & 369 (51\%) & 899 (45\%) & \\
\textbf{Groupe d'âges} & & & & \textless0,001 \\
18-24 ans & 58 (4,5\%) & 111 (15\%) & 169 (8,5\%) & \\
25-44 ans & 359 (28\%) & 347 (48\%) & 706 (35\%) & \\
45-64 ans & 541 (42\%) & 204 (28\%) & 745 (37\%) & \\
65 ans et plus & 319 (25\%) & 61 (8,4\%) & 380 (19\%) & \\
\textbf{Niveau d'études} & & & & \textless0,001 \\
Primaire & 416 (33\%) & 50 (6,9\%) & 466 (23\%) & \\
Secondaire & 270 (21\%) & 117 (16\%) & 387 (19\%) & \\
Technique / Professionnel & 378 (30\%) & 216 (30\%) & 594 (30\%) & \\
Supérieur & 186 (15\%) & 255 (35\%) & 441 (22\%) & \\
Non documenté & 27 (2,1\%) & 85 (12\%) & 112 (5,6\%) & \\
\textbf{Rapport à la religion} & & & & 0,14 \\
Pratiquant regulier & 182 (14\%) & 84 (12\%) & 266 (13\%) & \\
Pratiquant occasionnel & 295 (23\%) & 147 (20\%) & 442 (22\%) & \\
Appartenance sans pratique & 473 (37\%) & 287 (40\%) & 760 (38\%) & \\
Ni croyance ni appartenance & 239 (19\%) & 160 (22\%) & 399 (20\%) & \\
Rejet & 60 (4,7\%) & 33 (4,6\%) & 93 (4,7\%) & \\
NSP ou NVPR & 28 (2,2\%) & 12 (1,7\%) & 40 (2,0\%) & \\
\textbf{Heures de télévision / jour} & 2,00 (1,00 -- 3,00) & 2,00 (1,00
-- 3,00) & 2,00 (1,00 -- 3,00) & \textless0,001 \\
Manquant & 2 & 3 & 5 & \\
\bottomrule()
\end{longtable}

\hypertarget{calcul-de-la-ruxe9gression-logistique-binaire}{%
\section{Calcul de la régression logistique
binaire}\label{calcul-de-la-ruxe9gression-logistique-binaire}}

La spécification d'une régression logistique se fait avec
\texttt{stats::glm()} et est très similaire à celle d'une régression
linéaire simple (cf.
Section~\ref{sec-regression-lineaire-multivariee})~: on indique la
variable à expliquer suivie d'un tilde (\texttt{\textasciitilde{}}) puis
des variables explicatives séparées par un plus (\texttt{+})\sidenote{\footnotesize Il
  est possible de spécifier des modèles plus complexes, notamment avec
  des effets d'interaction, qui seront aborder plus loin (cf.
  Chapitre~\ref{sec-interactions}).}. Il faut indiquer à \texttt{glm()}
la famille du modèle souhaité~: on indiquera simplement
\texttt{family\ =\ binomial} pour un modèle \emph{logit}\sidenote{\footnotesize Pour
  un modèle \emph{probit}, on indiquera
  \texttt{family\ =\ binomial("probit")}.}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{+}\NormalTok{ groupe\_ages }\SpecialCharTok{+}\NormalTok{ etudes }\SpecialCharTok{+}\NormalTok{ relig }\SpecialCharTok{+}\NormalTok{ heures.tv,}
  \AttributeTok{family =}\NormalTok{ binomial,}
  \AttributeTok{data =}\NormalTok{ d}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Pour afficher les résultats du modèle, le plus simple est d'avoir
recours à \texttt{gtsummary::tbl\_regression()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{intercept =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-regression-logistique}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.4324}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1757}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2027}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1892}}@{}}
\caption{\label{tbl-regression-logistique}Facteurs associés à la
pratique d'un sport (régression logistique binaire)}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{log(OR)}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{log(OR)}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
\textbf{(Intercept)} & -0,80 & -1,4 -- -0,17 & 0,014 \\
\textbf{Sexe} & & & \\
Femme & --- & --- & \\
Homme & 0,44 & 0,23 -- 0,65 & \textless0,001 \\
\textbf{Groupe d'âges} & & & \\
18-24 ans & --- & --- & \\
25-44 ans & -0,42 & -0,87 -- 0,03 & 0,065 \\
45-64 ans & -1,1 & -1,6 -- -0,62 & \textless0,001 \\
65 ans et plus & -1,4 & -1,9 -- -0,85 & \textless0,001 \\
\textbf{Niveau d'études} & & & \\
Primaire & --- & --- & \\
Secondaire & 0,95 & 0,57 -- 1,3 & \textless0,001 \\
Technique / Professionnel & 1,0 & 0,68 -- 1,4 & \textless0,001 \\
Supérieur & 1,9 & 1,5 -- 2,3 & \textless0,001 \\
Non documenté & 2,2 & 1,5 -- 2,8 & \textless0,001 \\
\textbf{Rapport à la religion} & & & \\
Pratiquant regulier & --- & --- & \\
Pratiquant occasionnel & -0,02 & -0,39 -- 0,35 & \textgreater0,9 \\
Appartenance sans pratique & -0,01 & -0,35 -- 0,34 & \textgreater0,9 \\
Ni croyance ni appartenance & -0,22 & -0,59 -- 0,16 & 0,3 \\
Rejet & -0,38 & -0,95 -- 0,17 & 0,2 \\
NSP ou NVPR & -0,08 & -0,92 -- 0,70 & 0,8 \\
\textbf{Heures de télévision / jour} & -0,12 & -0,19 -- -0,06 &
\textless0,001 \\
\bottomrule()
\end{longtable}

\hypertarget{sec-interpreter-coefficients-regression-logistique}{%
\section{Interpréter les
coefficients}\label{sec-interpreter-coefficients-regression-logistique}}

L'\emph{intercept} traduit la situation à la référence (i.e.~toutes les
variables catégorielles à leur modalité de référence et les variables
continues à 0), après transformation selon la fonction de lien
(i.e.~après la transformation \emph{logit}).

Illustrons cela. Supposons donc une personne de sexe féminin, âgée entre
18 et 24 ans, de niveau d'étude primaire, pratiquante régulière et ne
regardant pas la télévision (situation de réference). Seul
l'\emph{intercept} s'applique dans le modèle, et donc le modèle prédit
que sa probabilité de faire du sport est de \(-0,80\) selon l'échelle
\emph{logit}. Retraduisons cela en probabilité classique avec la
fonction \emph{logit inverse}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{logit\_inverse }\OtherTok{\textless{}{-}} \FunctionTok{binomial}\NormalTok{(}\StringTok{"logit"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}\NormalTok{ purrr}\SpecialCharTok{::}\FunctionTok{pluck}\NormalTok{(}\StringTok{"linkinv"}\NormalTok{)}
\FunctionTok{logit\_inverse}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.80}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.3100255
\end{verbatim}

Selon le modèle, la probabilité que cette personne fasse du sport est
donc de \(31\%\).

Prenons maintenant une personne identique mais de sexe masculin. Nous
devons donc considérer, en plus de l'\emph{intercept}, le coefficient
associé à la modalité Homme. Sa probabilité de faire du sport est donc~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{logit\_inverse}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.80} \SpecialCharTok{+} \FloatTok{0.44}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.4109596
\end{verbatim}

Le coefficient associé à Homme est donc un modificateur par rapport à la
situation de référence.

Enfin, considérons que cette dernière personne regarde également la
télévision 2 heures en moyenne par jour. Nous devons alors considérer le
coefficient associé à la variable \emph{heures.tv} et, comme il s'agit
d'une variable continue, multiplier ce coefficient par 2, car le
coefficient représente le changement pour un incrément de 1 unité.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{logit\_inverse}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.80} \SpecialCharTok{+} \FloatTok{0.44} \SpecialCharTok{+} \DecValTok{2} \SpecialCharTok{*} \SpecialCharTok{{-}}\FloatTok{0.12}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.3543437
\end{verbatim}

Il est crucial de bien comprendre comment dans quels cas et comment
chaque coefficient est utilisé par le modèle.

Le package \texttt{\{breakdown\}} permet de mieux visualiser notre
dernier exemple.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{individu3 }\OtherTok{\textless{}{-}}\NormalTok{ d[}\DecValTok{1}\NormalTok{, ]}
\NormalTok{individu3}\SpecialCharTok{$}\NormalTok{sexe[}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"Homme"}
\NormalTok{individu3}\SpecialCharTok{$}\NormalTok{groupe\_ages[}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"18{-}24 ans"}
\NormalTok{individu3}\SpecialCharTok{$}\NormalTok{etudes[}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"Primaire"}
\NormalTok{individu3}\SpecialCharTok{$}\NormalTok{relig[}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"Pratiquant regulier"}
\NormalTok{individu3}\SpecialCharTok{$}\NormalTok{heures.tv[}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(breakDown)}
\NormalTok{logit }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{exp}\NormalTok{(x) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(x))}
\FunctionTok{plot}\NormalTok{(}
  \FunctionTok{broken}\NormalTok{(mod, individu3, }\AttributeTok{predict.function =}\NormalTok{ betas),}
  \AttributeTok{trans =}\NormalTok{ logit}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(),}
    \AttributeTok{breaks =} \DecValTok{0}\SpecialCharTok{:}\DecValTok{5}\SpecialCharTok{/}\DecValTok{5}\NormalTok{,}
    \AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/regression-logistique-binaire_files/figure-pdf/breakdown-individu3-1.pdf}

}

\caption{Décomposition de la probabilité de faire du sport de l'individu
3}

\end{figure}

\hypertarget{la-notion-dodds-ratio}{%
\section{\texorpdfstring{La notion d'\emph{odds
ratio}}{La notion d'odds ratio}}\label{la-notion-dodds-ratio}}

L'un des intérêts de la régression logistique \emph{logit} réside dans
le fait que l'exponentiel des coefficients correspond à des \emph{odds
ratio} ou rapport des côtes en français.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Pour comprendre la notion de côte (\emph{odd} en anglais), on peut se
référer aux paris sportifs. Par exemple, lorsque les trois quarts des
parieurs parient que le cheval A va remporter la course, on dit alors
que ce cheval à une côte de trois contre un (trois personnes parient
qu'il va gagner contre une personne qu'il va perdre). Prenon un autre
cheval~: si les deux tiers pensent que le cheval B va perdre (donc un
tiers pense qu'il va gagner), on dira alors que sa côte est de un contre
deux (une personne pense qu'il va gagner contre deux qu'il va perdre).

Si l'on connait la proportion ou probabilité \emph{p} d'avoir vécu ou de
vivre un événenement donné (ici gagner la course), la côte
(l'\emph{odd}) s'obtient avec la formule suivante~: \(p/(1-p)\). La côte
du cheval A est bien \(0,75/(1-0,75)=0,75/0,25=3\) est celle du cheval B
\((1/3)/(2/3)=1/2=0,5\).

Pour comparer deux côtes (par exemple pour savoir si le cheval A a une
probabilité plus élevée de remporter la course que le cheval B, selon
les parieurs), on calculera tout simplement le rapport des côtes ou
\emph{odds ratio} (OR)~: \(OR_{A/B}=Odds_{A}/Odds_{B}=3/0,5=6\).

Ce calcul peut se faire facilement dans \textbf{R} avec la fonction
\texttt{questionr::odds.ratio()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{questionr}\SpecialCharTok{::}\FunctionTok{odds.ratio}\NormalTok{(.}\DecValTok{75}\NormalTok{, }\DecValTok{1}\SpecialCharTok{/}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 6
\end{verbatim}

L'\emph{odds ratio} est donc égal à 1 si les deux côtes sont identiques,
est supérieur à 1 si le cheval A une probabilité supérieure à celle du
cheval B, et inférieur à 1 si c'est probabilité est inférieure.

On le voit, par construction, l'\emph{odds ratio} de B par rapport à A
est l'inverse de celui de A par rapport à B~: \(OR_{B/A}=1/OR_{A/B}\).

\end{tcolorbox}

Pour afficher les \emph{odds ratio} il suffit d'indiquer
\texttt{exponentiate\ =\ TRUE} à \texttt{gtsummary::tbl\_regression()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-regression-logistique-OR}{}
\begin{longtable}[]{@{}lccc@{}}
\caption{\label{tbl-regression-logistique-OR}Facteurs associés à la
pratique d'un sport (\emph{odds ratios})}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{OR} & \textbf{95\% IC} &
\textbf{p-valeur} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{OR} & \textbf{95\% IC} &
\textbf{p-valeur} \\
\midrule()
\endhead
\textbf{Sexe} & & & \\
Femme & --- & --- & \\
Homme & 1,55 & 1,26 -- 1,91 & \textless0,001 \\
\textbf{Groupe d'âges} & & & \\
18-24 ans & --- & --- & \\
25-44 ans & 0,66 & 0,42 -- 1,03 & 0,065 \\
45-64 ans & 0,34 & 0,21 -- 0,54 & \textless0,001 \\
65 ans et plus & 0,25 & 0,15 -- 0,43 & \textless0,001 \\
\textbf{Niveau d'études} & & & \\
Primaire & --- & --- & \\
Secondaire & 2,59 & 1,77 -- 3,83 & \textless0,001 \\
Technique / Professionnel & 2,86 & 1,98 -- 4,17 & \textless0,001 \\
Supérieur & 6,63 & 4,55 -- 9,80 & \textless0,001 \\
Non documenté & 8,59 & 4,53 -- 16,6 & \textless0,001 \\
\textbf{Rapport à la religion} & & & \\
Pratiquant regulier & --- & --- & \\
Pratiquant occasionnel & 0,98 & 0,68 -- 1,42 & \textgreater0,9 \\
Appartenance sans pratique & 0,99 & 0,71 -- 1,40 & \textgreater0,9 \\
Ni croyance ni appartenance & 0,81 & 0,55 -- 1,18 & 0,3 \\
Rejet & 0,68 & 0,39 -- 1,19 & 0,2 \\
NSP ou NVPR & 0,92 & 0,40 -- 2,02 & 0,8 \\
\textbf{Heures de télévision / jour} & 0,89 & 0,83 -- 0,95 &
\textless0,001 \\
\bottomrule()
\end{longtable}

Pour une représentation visuelle, graphique en forêt ou \emph{forest
plot} en anglais, on aura tout simplement recours à
\texttt{ggstats::ggcoef\_model()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/regression-logistique-binaire_files/figure-pdf/fig-forest-plot-regression-logistique-1.pdf}

}

\caption{\label{fig-forest-plot-regression-logistique}Facteurs associés
à la pratique d'un sport (\emph{forest plot})}

\end{figure}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

Lorsque l'on réalise un \emph{forest plot}~de coefficients
exponentialisés tels que des \emph{odds ratios}, une bonne pratique
consiste à utiliser une échelle logarithmique. En effet, l'inverse d'un
\emph{odds ratio} de 2 est 0,5. Avec une échelle logarithmique, la
distance entre 0,5 et 1 est égale à celle entre 1 et 2. Sur la figure
précédente, vous pourrez noter que \texttt{ggstats::ggcoef\_model()}
applique automatiquement une échelle logarithmique lorsque
\texttt{exponentiate\ =\ TRUE}.

Quelques références~:
\href{https://doi.org/10.1016/j.jadohealth.2017.07.025}{Forest Plots:
Linear or Logarithmic Scale?} ou encore
\href{https://doi.org/10.1016/j.jacc.2017.10.098}{Graphing Ratio
Measures on Forest Plot}.

\end{tcolorbox}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-caution-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-caution-color}{\faFire}\hspace{0.5em}{Mise en garde}, bottomrule=.15mm, colframe=quarto-callout-caution-color-frame]

En rédigeant les résultats de la régression, il faudra être vigilant à
ne pas confondre les \emph{odds ratios} avec des \emph{prevalence
ratios}. Avec un \emph{odds ratio} de 1,55, il serait tentant d'écrire
que les hommes ont une probabilité 55\% supérieure de pratique un sport
que les femmes (toutes choses égales par ailleurs). Une telle
formulation correspond à un \emph{prevalence ratio} (rapport des
prévalences en français) ou \emph{risk ratio} (rapport des risques), à
savoir diviser la probabilité de faire du sport des hommes par celle des
femmes, \(p_{hommes}/p_{femmes}\). Or, cela ne correspond pas à la
formule de l'\emph{odds ratio}, à savoir
\((p_{hommes}/(1-p_{hommes}))/(p_{femmes}/(1-p_{femmes}))\).

Lorsque le phénomène étudié est rare et donc que les probabilités sont
faibles (inférieures à quelques pour-cents), alors il est vrai que les
\emph{odds ratio} sont approximativement égaux aux \emph{prevalence
ratios}. Mais ceci n'est plus du tout vrai pour des phénomènes plus
fréquents.

\end{tcolorbox}

\hypertarget{afficher-les-uxe9carts-types-plutuxf4t-que-les-intervalles-de-confiance}{%
\section{Afficher les écarts-types plutôt que les intervalles de
confiance}\label{afficher-les-uxe9carts-types-plutuxf4t-que-les-intervalles-de-confiance}}

La manière de présenter les résultats d'un modèle de régression varie
selon les disciplines, les champs thématiques et les revues. Si en
sociologie et épidémiologie on aurait plutôt tendance à afficher les
\emph{odds ratio} avec leur intervalle de confiance, il est fréquent en
économétrie de présenter plutôt les coefficients brust et leurs
écarts-types (\emph{standard deviation} ou \emph{sd} en anglais). De
même, plutôt que d'ajouter une colonne avec les p valeurs, un usage
consiste à afficher des étoiles de significativités à la droite des
coefficients significatifs.

Pour cela, on pourra personnaliser le tableau produit avec
\texttt{gtsummary::tbl\_regression()}, notamment avec
\texttt{gtsummary::add\_significance\_stars()} pour l'ajout des étoiles
de significativité, ainsi que \texttt{gtsummary::modify\_column\_hide()}
et \texttt{gtsummary::modify\_column\_unhide()} pour afficher / masquer
les colonnes du tableau produit\sidenote{\footnotesize La liste des colonnes
  disponibles peut être obtenues avec
  \texttt{mod\ \textbar{}\textgreater{}\ tbl\_regression()\ \textbar{}\textgreater{}\ purrr::pluck("table\_body")\ \textbar{}\textgreater{}\ colnames()}.}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_significance\_stars}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{modify\_column\_hide}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"ci"}\NormalTok{, }\StringTok{"p.value"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{modify\_column\_unhide}\NormalTok{(}\StringTok{"std.error"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-regression-presentation_econometrique}{}
\begin{longtable}[]{@{}lcc@{}}
\caption{\label{tbl-regression-presentation_econometrique}Présentation
économétrique des facteurs associés à la pratique d'un
sport}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{log(OR)} & \textbf{ET} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{log(OR)} & \textbf{ET} \\
\midrule()
\endhead
\textbf{Sexe} & & \\
Femme & --- & --- \\
Homme & 0,44*** & 0,106 \\
\textbf{Groupe d'âges} & & \\
18-24 ans & --- & --- \\
25-44 ans & -0,42 & 0,228 \\
45-64 ans & -1,1*** & 0,238 \\
65 ans et plus & -1,4*** & 0,274 \\
\textbf{Niveau d'études} & & \\
Primaire & --- & --- \\
Secondaire & 0,95*** & 0,197 \\
Technique / Professionnel & 1,0*** & 0,190 \\
Supérieur & 1,9*** & 0,195 \\
Non documenté & 2,2*** & 0,330 \\
\textbf{Rapport à la religion} & & \\
Pratiquant regulier & --- & --- \\
Pratiquant occasionnel & -0,02 & 0,189 \\
Appartenance sans pratique & -0,01 & 0,175 \\
Ni croyance ni appartenance & -0,22 & 0,193 \\
Rejet & -0,38 & 0,286 \\
NSP ou NVPR & -0,08 & 0,411 \\
\textbf{Heures de télévision / jour} & -0,12*** & 0,034 \\
\bottomrule()
\end{longtable}

Les économistes pourraient préférer le package \texttt{\{modelsummary\}}
à \texttt{\{gtsummary\}}. Ces deux packages ont un objectif similaire
(la production de tableaux statistiques) mais abordent cet objectif avec
des approches différentes. Il faut noter que
\texttt{modelsummary::modelsummary()} n'affiche pas les modalités de
référence, ni les étiquettes de variable.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}}\NormalTok{ modelsummary}\SpecialCharTok{::}\FunctionTok{modelsummary}\NormalTok{(}\AttributeTok{stars =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{tbl-modelsummary}{}
\begin{table}
\caption{\label{tbl-modelsummary}Présentation des facteurs associés à la pratique d'un sport avec
modelsummary() }\tabularnewline

\centering
\begin{tabular}[t]{lc}
\toprule
  & (1)\\
\midrule
(Intercept) & \num{-0.798}*\\
 & (\num{0.324})\\
sexeHomme & \num{0.440}***\\
 & (\num{0.106})\\
groupe\_ages25-44 ans & \num{-0.420}+\\
 & (\num{0.228})\\
groupe\_ages45-64 ans & \num{-1.085}***\\
 & (\num{0.238})\\
groupe\_ages65 ans et plus & \num{-1.381}***\\
 & (\num{0.274})\\
etudesSecondaire & \num{0.951}***\\
 & (\num{0.197})\\
etudesTechnique / Professionnel & \num{1.049}***\\
 & (\num{0.190})\\
etudesSupérieur & \num{1.892}***\\
 & (\num{0.195})\\
etudesNon documenté & \num{2.150}***\\
 & (\num{0.330})\\
religPratiquant occasionnel & \num{-0.022}\\
 & (\num{0.189})\\
religAppartenance sans pratique & \num{-0.007}\\
 & (\num{0.175})\\
religNi croyance ni appartenance & \num{-0.215}\\
 & (\num{0.193})\\
religRejet & \num{-0.384}\\
 & (\num{0.286})\\
religNSP ou NVPR & \num{-0.084}\\
 & (\num{0.411})\\
heures.tv & \num{-0.121}***\\
 & (\num{0.034})\\
\midrule
Num.Obs. & \num{1995}\\
AIC & \num{2236.2}\\
BIC & \num{2320.1}\\
Log.Lik. & \num{-1103.086}\\
F & \num{21.691}\\
RMSE & \num{0.43}\\
\bottomrule
\multicolumn{2}{l}{\rule{0pt}{1em}+ p $<$ 0.1, * p $<$ 0.05, ** p $<$ 0.01, *** p $<$ 0.001}\\
\end{tabular}
\end{table}

La fonction \texttt{modelsummary::modelplot()} permet d'afficher un
graphique des coefficients.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}}\NormalTok{ modelsummary}\SpecialCharTok{::}\FunctionTok{modelplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/regression-logistique-binaire_files/figure-pdf/fig-modelplot-1.pdf}

}

\caption{\label{fig-modelplot}Facteurs associés à la pratique d'un sport
avec modelplot()}

\end{figure}

\textbf{ATTENTION~:} si l'on affiche les \emph{odds ratio} avec
\texttt{exponentiate\ =\ TRUE}, \texttt{modelsummary::modelplot()}
conserve par défaut une échelle linéaire. On sera donc vigilant à
appliquer \texttt{ggplot2::scale\_x\_log10()} manuellement pour utiliser
une échelle logarithmique.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}}
\NormalTok{  modelsummary}\SpecialCharTok{::}\FunctionTok{modelplot}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{  ggplot2}\SpecialCharTok{::}\FunctionTok{scale\_x\_log10}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/regression-logistique-binaire_files/figure-pdf/fig-modelplot-or-1.pdf}

}

\caption{\label{fig-modelplot-or}Odds Ratios associés à la pratique d'un
sport avec modelplot()}

\end{figure}

\hypertarget{afficher-toutes-les-comparaisons-pairwise-contrasts}{%
\section{\texorpdfstring{Afficher toutes les comparaisons
(\emph{pairwise
contrasts})}{Afficher toutes les comparaisons (pairwise contrasts)}}\label{afficher-toutes-les-comparaisons-pairwise-contrasts}}

Dans le tableau des résultats
(Table~\ref{tbl-regression-logistique-OR}), pour les variables
catégorielles, il importe de bien garder en mémoire que chaque
\emph{odds ratio} doit se comparer à la valeur de référence. Ainsi, les
\emph{odds ratios} affichés pour chaque classe d'âges correspondent à
une comparaison avec la classe d'âges de références, les 18-24 ans. La
p-valeur associée nous indique quant à elle si cet \emph{odds ratio} est
significativement de 1, donc si cette classe d'âges données se comporte
différemment de celle de référence.

Mais cela ne nous dit nullement si les 65 ans et plus diffèrent des
45-64 ans. Il est tout à fait possible de recalculer l'\emph{odds ratio}
correspondant en rapport les \emph{odds ratio} à la référence~:
\(OR_{65+/45-64}=OR_{65+/18-24}/OR_{45-64/18-24}\).

Le package \texttt{\{emmeans\}} et sa fonction
\texttt{emmeans::emmeans()} permettent de recalculer toutes les
combinaisons d'\emph{odds ratio} (on parle alors de \emph{pairwise
contrasts}) ainsi que leur intervalle de confiance et la p-valeur
correspondante.

On peut ajouter facilement\sidenote{\footnotesize Cela nécessite néanmoins au minimum
  la version 1.11.0 du package \texttt{\{broom.helpers\}} et la version
  1.6.3 de \texttt{\{gtsummary\}}.} cela au tableau produit avec
\texttt{gtsummary::tbl\_regression()} en ajoutant l'option
\texttt{add\_pairwise\_contrasts\ =\ TRUE}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{add\_pairwise\_contrasts =} \ConstantTok{TRUE}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-regression-logistique-pairwise}{}
\begin{table}
\caption{\label{tbl-regression-logistique-pairwise}Facteurs associés à la pratique d'un sport (pairwise contrasts) }\tabularnewline

\centering
\begin{tabular}{l|c|c|c}
\hline
**Caractéristique** & **OR** & **95\% IC** & **p-valeur**\\
\hline
\_\_Sexe\_\_ &  &  & \\
\hline
Homme / Femme & 1,55 & 1,26 – 1,91 & <0,001\\
\hline
\_\_Groupe d'âges\_\_ &  &  & \\
\hline
(25-44 ans) / (18-24 ans) & 0,66 & 0,37 – 1,18 & 0,3\\
\hline
(45-64 ans) / (18-24 ans) & 0,34 & 0,18 – 0,62 & <0,001\\
\hline
(45-64 ans) / (25-44 ans) & 0,51 & 0,38 – 0,70 & <0,001\\
\hline
65 ans et plus / (18-24 ans) & 0,25 & 0,12 – 0,51 & <0,001\\
\hline
65 ans et plus / (25-44 ans) & 0,38 & 0,24 – 0,61 & <0,001\\
\hline
65 ans et plus / (45-64 ans) & 0,74 & 0,47 – 1,17 & 0,3\\
\hline
\_\_Niveau d'études\_\_ &  &  & \\
\hline
Secondaire / Primaire & 2,59 & 1,51 – 4,43 & <0,001\\
\hline
(Technique / Professionnel) / Primaire & 2,86 & 1,70 – 4,79 & <0,001\\
\hline
(Technique / Professionnel) / Secondaire & 1,10 & 0,74 – 1,64 & >0,9\\
\hline
Supérieur / Primaire & 6,63 & 3,89 – 11,3 & <0,001\\
\hline
Supérieur / Secondaire & 2,56 & 1,69 – 3,88 & <0,001\\
\hline
Supérieur / (Technique / Professionnel) & 2,32 & 1,61 – 3,36 & <0,001\\
\hline
Non documenté / Primaire & 8,59 & 3,49 – 21,1 & <0,001\\
\hline
Non documenté / Secondaire & 3,32 & 1,46 – 7,53 & <0,001\\
\hline
Non documenté / (Technique / Professionnel) & 3,01 & 1,38 – 6,56 & 0,001\\
\hline
Non documenté / Supérieur & 1,30 & 0,58 – 2,90 & >0,9\\
\hline
\_\_Rapport à la religion\_\_ &  &  & \\
\hline
Pratiquant occasionnel / Pratiquant regulier & 0,98 & 0,57 – 1,68 & >0,9\\
\hline
Appartenance sans pratique / Pratiquant regulier & 0,99 & 0,60 – 1,63 & >0,9\\
\hline
Appartenance sans pratique / Pratiquant occasionnel & 1,02 & 0,68 – 1,52 & >0,9\\
\hline
Ni croyance ni appartenance / Pratiquant regulier & 0,81 & 0,47 – 1,40 & 0,9\\
\hline
Ni croyance ni appartenance / Pratiquant occasionnel & 0,82 & 0,52 – 1,31 & 0,8\\
\hline
Ni croyance ni appartenance / Appartenance sans pratique & 0,81 & 0,54 – 1,21 & 0,7\\
\hline
Rejet / Pratiquant regulier & 0,68 & 0,30 – 1,54 & 0,8\\
\hline
Rejet / Pratiquant occasionnel & 0,70 & 0,33 – 1,49 & 0,8\\
\hline
Rejet / Appartenance sans pratique & 0,69 & 0,33 – 1,41 & 0,7\\
\hline
Rejet / Ni croyance ni appartenance & 0,85 & 0,40 – 1,79 & >0,9\\
\hline
NSP ou NVPR / Pratiquant regulier & 0,92 & 0,29 – 2,97 & >0,9\\
\hline
NSP ou NVPR / Pratiquant occasionnel & 0,94 & 0,30 – 2,92 & >0,9\\
\hline
NSP ou NVPR / Appartenance sans pratique & 0,93 & 0,30 – 2,82 & >0,9\\
\hline
NSP ou NVPR / Ni croyance ni appartenance & 1,14 & 0,37 – 3,55 & >0,9\\
\hline
NSP ou NVPR / Rejet & 1,35 & 0,37 – 4,88 & >0,9\\
\hline
\_\_Heures de télévision / jour\_\_ & 0,89 & 0,83 – 0,95 & <0,001\\
\hline
\end{tabular}
\end{table}

De même, on peur visualiser les coefficients avec la même option dans
\texttt{ggstats::ggcoef\_model()}\sidenote{\footnotesize Cela nécessite néanmoins au
  minimum la version 1.11.0 du package \texttt{\{broom.helpers\}} et la
  version 0.2.0 de \texttt{\{ggstats\}}.}. On peut d'ailleurs choisir
les variables concernées avec l'argument \texttt{pairwise\_variables}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(}
    \AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{add\_pairwise\_contrasts =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{pairwise\_variables =} \FunctionTok{c}\NormalTok{(}\StringTok{"groupe\_ages"}\NormalTok{, }\StringTok{"etudes"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/regression-logistique-binaire_files/figure-pdf/fig-forest-plot-regression-logistique-pairwise-1.pdf}

}

\caption{\label{fig-forest-plot-regression-logistique-pairwise}Facteurs
associés à la pratique d'un sport (\emph{pairwise contrasts})}

\end{figure}

\hypertarget{sec-reg-log-anova}{%
\section{Identifier les variables ayant un effet
significatif}\label{sec-reg-log-anova}}

Pour les variables catégorielles à trois modalités ou plus, les p-values
associées aux \emph{odds ratios} nous indique si un \emph{odd ratio} est
significativement différent de 1, par rapport à la modalité de
référence. Mais cela n'indique pas si globalement une variable a un
effet significatif sur le modèle. Pour tester l'effet global d'une
variable, on peut avoir recours à la fonction \texttt{car::Anova()}.
Cette dernière va tour à tour supprimer chaque variable du modèle et
réaliser une analyse de variance (ANOVA) pour voir si la variance change
significativement.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{car}\SpecialCharTok{::}\FunctionTok{Anova}\NormalTok{(mod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Analysis of Deviance Table (Type II tests)

Response: sport
            LR Chisq Df Pr(>Chisq)    
sexe          17.309  1  3.176e-05 ***
groupe_ages   52.803  3  2.020e-11 ***
etudes       123.826  4  < 2.2e-16 ***
relig          4.232  5  0.5165401    
heures.tv     13.438  1  0.0002465 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

Ainsi, dans le cas présent, la suppression de la variable \emph{relig}
ne modifie significativement pas le modèle, indiquant l'absence d'effet
de cette variable.

Si l'on a recours à \texttt{gtsummary::tbl\_regression()}, on peut
facilement ajouter les p-valeurs globales avec
\texttt{gtsummary::add\_global\_p()}\sidenote{\footnotesize Si l'on veut conserver les
  p-values individuelles associées à chaque \emph{odds ratio}, on
  ajoutera l'option \texttt{keep\ =\ TRUE}.}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{bold\_labels}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_global\_p}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-regression-logistique-global-p}{}
\begin{table}
\caption{\label{tbl-regression-logistique-global-p}Ajout des p-valeurs globales }\tabularnewline

\centering
\begin{tabular}{l|c|c|c}
\hline
**Caractéristique** & **OR** & **95\% IC** & **p-valeur**\\
\hline
\_\_Sexe\_\_ &  &  & <0,001\\
\hline
Femme & — & — & \\
\hline
Homme & 1,55 & 1,26 – 1,91 & \\
\hline
\_\_Groupe d'âges\_\_ &  &  & <0,001\\
\hline
18-24 ans & — & — & \\
\hline
25-44 ans & 0,66 & 0,42 – 1,03 & \\
\hline
45-64 ans & 0,34 & 0,21 – 0,54 & \\
\hline
65 ans et plus & 0,25 & 0,15 – 0,43 & \\
\hline
\_\_Niveau d'études\_\_ &  &  & <0,001\\
\hline
Primaire & — & — & \\
\hline
Secondaire & 2,59 & 1,77 – 3,83 & \\
\hline
Technique / Professionnel & 2,86 & 1,98 – 4,17 & \\
\hline
Supérieur & 6,63 & 4,55 – 9,80 & \\
\hline
Non documenté & 8,59 & 4,53 – 16,6 & \\
\hline
\_\_Rapport à la religion\_\_ &  &  & 0,5\\
\hline
Pratiquant regulier & — & — & \\
\hline
Pratiquant occasionnel & 0,98 & 0,68 – 1,42 & \\
\hline
Appartenance sans pratique & 0,99 & 0,71 – 1,40 & \\
\hline
Ni croyance ni appartenance & 0,81 & 0,55 – 1,18 & \\
\hline
Rejet & 0,68 & 0,39 – 1,19 & \\
\hline
NSP ou NVPR & 0,92 & 0,40 – 2,02 & \\
\hline
\_\_Heures de télévision / jour\_\_ & 0,89 & 0,83 – 0,95 & <0,001\\
\hline
\end{tabular}
\end{table}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

Concernant le test réalisé dans le cadre d'une Anova, il existe trois
tests différents que l'on présente comme le type 1, le type 2 et le type
3 (ou I, II et III). Pour une explication sur ces différents types, on
pourra se référer (en anglais) à
\url{https://mcfromnz.wordpress.com/2011/03/02/anova-type-iiiiii-ss-explained/}
ou encore
\url{http://md.psych.bio.uni-goettingen.de/mv/unit/lm_cat/lm_cat_unbal_ss_explained.html}.

Le type I n'est pas recommandé dans le cas présent car il dépend de
l'ordre dans lequel les différentes variables sont testées.

Lorsqu'il n'y a pas d'interaction dans un modèle, le type II serait à
privilégier car plus puissant (nous aborderons les interactions dans un
prochain chapitre, cf. Chapitre~\ref{sec-interactions}).

En présence d'interactions, il est conseillé d'avoir plutôt recours au
type III. Cependant, en toute rigueur, pour utiliser le type III, il
faut que les variables catégorielles soient codées en utilisant un
contrastes dont la somme est nulle (un contrast de type somme ou
polynomial). Or, par défaut, les variables catégorielles sont codées
avec un contraste de type traitement (nous aborderons les différents
types de contrastes plus tard, cf. Chapitre~\ref{sec-contrastes}).

Par défaut, \texttt{car::Anova()} utilise le type II et
\texttt{gtsummary::add\_global\_p()} le type III. Dans les deux cas, il
est possible de préciser le type de test avec \texttt{type\ =\ "II"} ou
\texttt{type\ =\ "III"}.

Dans le cas de notre exemple, un modèle simple sans interaction, le type
de test ne change pas les résultats.

\end{tcolorbox}

\hypertarget{sec-step}{%
\section{Sélection pas à pas d'un meilleur modèle}\label{sec-step}}

Il est toujours tentant lorsque l'on recherche les facteurs associés à
un phénomène d'inclure un nombre important de variables explicatives
potentielles dans son modèle logistique. Cependant, un tel modèle n'est
pas forcément le plus efficace et certaines variables n'auront
probablement pas d'effet significatif sur la variable d'intérêt.

Pour une présentation didactique du cadre théorique de la sélection de
modèle, vous pouvez consulter en ligne le
\href{https://perso.univ-rennes2.fr/system/files/users/rouviere_l/chapitre3_glm.pdf}{cours
de L. Rouvière sur la sélection/validation de modèles}.

La technique de sélection descendante pas à pas est une approche visant
à améliorer son modèle explicatif\sidenote{\footnotesize Il existe également des
  méthodes de \emph{sélection ascendante pas à pas}, mais nous les
  aborderons pas ici.}. On réalise un premier modèle avec toutes les
variables spécifiées, puis on regarde s'il est possible d'améliorer le
modèle en supprimant une des variables du modèle. Si plusieurs variables
permettent d'améliorer le modèle, on supprimera la variable dont la
suppression améliorera le plus le modèle. Puis on recommence le même
procédé pour voir si la suppression d'une seconde variable peut encore
améliorer le modèle et ainsi de suite. Lorsque le modèle ne peut plus
être amélioré par la suppresion d'une variable, on s'arrête.

Il faut également définir un critère pour déterminer la qualité d'un
modèle. L'un des plus utilisés est le \emph{Akaike Information
Criterion} ou AIC. Plus l'AIC sera faible, meilleure sera le modèle. Il
s'agit d'un compromis entre le nombre de degrés de liberté (e.g.~le
nombre de coefficients dans le modèle) que l'on cherche à minimiser et
la variance expliquée que l'on cherche à maximiser.

La fonction \texttt{step()} permet justement de sélectionner le meilleur
modèle par une procédure pas à pas descendante basée sur la minimisation
de l'AIC. La fonction affiche à l'écran les différentes étapes de la
sélection et renvoie le modèle final.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2 }\OtherTok{\textless{}{-}} \FunctionTok{step}\NormalTok{(mod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Start:  AIC=2236.17
sport ~ sexe + groupe_ages + etudes + relig + heures.tv

              Df Deviance    AIC
- relig        5   2210.4 2230.4
<none>             2206.2 2236.2
- heures.tv    1   2219.6 2247.6
- sexe         1   2223.5 2251.5
- groupe_ages  3   2259.0 2283.0
- etudes       4   2330.0 2352.0

Step:  AIC=2230.4
sport ~ sexe + groupe_ages + etudes + heures.tv

              Df Deviance    AIC
<none>             2210.4 2230.4
- heures.tv    1   2224.0 2242.0
- sexe         1   2226.4 2244.4
- groupe_ages  3   2260.6 2274.6
- etudes       4   2334.3 2346.3
\end{verbatim}

Le modèle initial a un AIC de 2236,2. À la première étape, il apparait
que la suppression de la variable religion permet diminuer l'AIC à
2210,4. Lors de la seconde étape, toute suppression d'une autre variable
ferait augmenter l'AIC. La procédure s'arrête donc.

Pour obtenir directement l'AIC d'un modèle donné, on peut utiliser la
fonction \texttt{AIC()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{AIC}\NormalTok{(mod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2236.173
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{AIC}\NormalTok{(mod2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2230.404
\end{verbatim}

On peut effectuer une analyse de variance ou ANOVA pour comparer les
deux modèles avec la fonction \texttt{anova()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(mod, mod2, }\AttributeTok{test =} \StringTok{"Chisq"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Analysis of Deviance Table

Model 1: sport ~ sexe + groupe_ages + etudes + relig + heures.tv
Model 2: sport ~ sexe + groupe_ages + etudes + heures.tv
  Resid. Df Resid. Dev Df Deviance Pr(>Chi)
1      1980     2206.2                     
2      1985     2210.4 -5  -4.2319   0.5165
\end{verbatim}

Il n'y a pas de différences significatives entre nos deux modèles
(p=0,52). Autrement dit, notre second modèle explique tout autant de
variance que notre premier modèle, tout en étant plus parcimonieux.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Une alternative à la fonction \texttt{stats::step()} est la fonction
\texttt{MASS::stepAIC()} du package \texttt{\{MASS\}} qui fonctionne de
la même manière. Si cela ne change rien aux régressions logistiques
classiques, il arrive que pour certains types de modèle la méthode
\texttt{stats::step()} ne soit pas disponible, mais que
\texttt{MASS::stepAIC()} puisse être utilisée à la place.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(MASS)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Attachement du package : 'MASS'
\end{verbatim}

\begin{verbatim}
L'objet suivant est masqué depuis 'package:gtsummary':

    select
\end{verbatim}

\begin{verbatim}
L'objet suivant est masqué depuis 'package:dplyr':

    select
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2bis }\OtherTok{\textless{}{-}} \FunctionTok{stepAIC}\NormalTok{(mod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Start:  AIC=2236.17
sport ~ sexe + groupe_ages + etudes + relig + heures.tv

              Df Deviance    AIC
- relig        5   2210.4 2230.4
<none>             2206.2 2236.2
- heures.tv    1   2219.6 2247.6
- sexe         1   2223.5 2251.5
- groupe_ages  3   2259.0 2283.0
- etudes       4   2330.0 2352.0

Step:  AIC=2230.4
sport ~ sexe + groupe_ages + etudes + heures.tv

              Df Deviance    AIC
<none>             2210.4 2230.4
- heures.tv    1   2224.0 2242.0
- sexe         1   2226.4 2244.4
- groupe_ages  3   2260.6 2274.6
- etudes       4   2334.3 2346.3
\end{verbatim}

Un critère similaire à l'AIC est le critère BIC (\emph{Bayesian
Information Criterion}) appelé aussi SBC (\emph{Schwarz information
criterion}). Il s'obtient avec \texttt{stats::step()} en ajoutant
l'argument \texttt{k\ =\ log(n)} où \texttt{n} est le nombre
d'observations inclues dans le modèle que l'on peut obtenir avec
\texttt{nrow(model.matrix(reg))} (pour tenir compte des éventuelles
observations manquantes retirées des données pour le calcul du modèle).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2\_bic }\OtherTok{\textless{}{-}} \FunctionTok{step}\NormalTok{(mod, }\AttributeTok{k =} \FunctionTok{log}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(}\FunctionTok{model.matrix}\NormalTok{(mod))))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Start:  AIC=2320.15
sport ~ sexe + groupe_ages + etudes + relig + heures.tv

              Df Deviance    AIC
- relig        5   2210.4 2286.4
<none>             2206.2 2320.2
- heures.tv    1   2219.6 2326.0
- sexe         1   2223.5 2329.9
- groupe_ages  3   2259.0 2350.2
- etudes       4   2330.0 2413.6

Step:  AIC=2286.39
sport ~ sexe + groupe_ages + etudes + heures.tv

              Df Deviance    AIC
<none>             2210.4 2286.4
- heures.tv    1   2224.0 2292.4
- sexe         1   2226.4 2294.8
- groupe_ages  3   2260.6 2313.8
- etudes       4   2334.3 2379.8
\end{verbatim}

\end{tcolorbox}

On peut facilement comparer visuellement deux modèles avec
\texttt{ggstats::ggcoef\_compare()} de \texttt{\{ggstats\}}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggstats)}
\FunctionTok{ggcoef\_compare}\NormalTok{(}
  \FunctionTok{list}\NormalTok{(}\StringTok{"modèle complet"} \OtherTok{=}\NormalTok{ mod, }\StringTok{"modèle réduit"} \OtherTok{=}\NormalTok{ mod2), }
  \AttributeTok{exponentiate =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/regression-logistique-binaire_files/figure-pdf/fig-comparaison-modeles-dodge-1.pdf}

}

\caption{\label{fig-comparaison-modeles-dodge}Comparaison visuelle des
deux modèles (\emph{dodge})}

\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcoef\_compare}\NormalTok{(}
  \FunctionTok{list}\NormalTok{(}\StringTok{"modèle complet"} \OtherTok{=}\NormalTok{ mod, }\StringTok{"modèle réduit"} \OtherTok{=}\NormalTok{ mod2), }
  \AttributeTok{type =} \StringTok{"faceted"}\NormalTok{,}
  \AttributeTok{exponentiate =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/regression-logistique-binaire_files/figure-pdf/fig-comparaison-modeles-faceted-1.pdf}

}

\caption{\label{fig-comparaison-modeles-faceted}Comparaison visuelle des
deux modèles (\emph{faceted})}

\end{figure}

Si l'on souhaite afficher l'AIC (ainsi que d'autres statistiques
globales du modèle) en note du tableau des coefficients, on pourra
utiliser \texttt{gtsummary::add\_glance\_source\_note()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_glance\_source\_note}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-regression-logistique-glance_source_note}{}
\begin{table}
\caption{\label{tbl-regression-logistique-glance_source_note}Modèle obtenu après réduction du nombre de variables }\tabularnewline

\centering
\begin{tabular}{l|c|c|c}
\hline
**Caractéristique** & **OR** & **95\% IC** & **p-valeur**\\
\hline
\_\_Sexe\_\_ &  &  & \\
\hline
Femme & — & — & \\
\hline
Homme & 1,52 & 1,24 – 1,87 & <0,001\\
\hline
\_\_Groupe d'âges\_\_ &  &  & \\
\hline
18-24 ans & — & — & \\
\hline
25-44 ans & 0,68 & 0,43 – 1,06 & 0,084\\
\hline
45-64 ans & 0,36 & 0,23 – 0,57 & <0,001\\
\hline
65 ans et plus & 0,27 & 0,16 – 0,46 & <0,001\\
\hline
\_\_Niveau d'études\_\_ &  &  & \\
\hline
Primaire & — & — & \\
\hline
Secondaire & 2,54 & 1,73 – 3,75 & <0,001\\
\hline
Technique / Professionnel & 2,81 & 1,95 – 4,10 & <0,001\\
\hline
Supérieur & 6,55 & 4,50 – 9,66 & <0,001\\
\hline
Non documenté & 8,54 & 4,51 – 16,5 & <0,001\\
\hline
\_\_Heures de télévision / jour\_\_ & 0,89 & 0,83 – 0,95 & <0,001\\
\hline
\end{tabular}
\end{table}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-warning-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-warning-color}{\faExclamationTriangle}\hspace{0.5em}{Sélection pas à pas et valeurs manquantes}, bottomrule=.15mm, colframe=quarto-callout-warning-color-frame]

Si certaines de nos variables explications contiennent des valeurs
manquantes \texttt{NA}, cela peut entraîner des erreurs au moment
d'avoir recours à \texttt{step()}, car le nombre d'observations dans le
modèle va changer si on retire du modèle une variable explicative avec
des valeurs manquantes.

Prenons un exemple, en ajoutant des valeurs manquantes à la variable
\emph{relig} (pour cela nous allons recoder les refus et les ne sait pas
en \texttt{NA}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d}\SpecialCharTok{$}\NormalTok{relig\_na }\OtherTok{\textless{}{-}} 
\NormalTok{  d}\SpecialCharTok{$}\NormalTok{relig }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{fct\_recode}\NormalTok{(}
    \AttributeTok{NULL =} \StringTok{"Rejet"}\NormalTok{,}
    \AttributeTok{NULL =} \StringTok{"NSP ou NVPR"}
\NormalTok{  )}

\NormalTok{mod\_na }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{+}\NormalTok{ groupe\_ages }\SpecialCharTok{+}\NormalTok{ etudes }\SpecialCharTok{+}\NormalTok{ relig\_na }\SpecialCharTok{+}\NormalTok{ heures.tv,}
  \AttributeTok{family =}\NormalTok{ binomial,}
  \AttributeTok{data =}\NormalTok{ d}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Au moment d'exécuter \texttt{step()} nous obtenons l'erreur mentionnée
précédemment.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{step}\NormalTok{(mod\_na)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Start:  AIC=2077.34
sport ~ sexe + groupe_ages + etudes + relig_na + heures.tv

              Df Deviance    AIC
- relig_na     3   2053.8 2073.8
<none>             2051.3 2077.3
- heures.tv    1   2064.7 2088.7
- sexe         1   2068.1 2092.1
- groupe_ages  3   2098.8 2118.8
- etudes       4   2173.5 2191.5
\end{verbatim}

\begin{verbatim}
Error in step(mod_na): le nombre de lignes utilisées a changé : supprimer les valeurs manquantes ?
\end{verbatim}

Pas d'inquiétude ! Il y a moyen de s'en sortir en adoptant la stratégie
suivante~:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  créer une copie du jeu de données avec uniquement des observations
  sans valeur manquante pour nos variables explicatives~;
\item
  calculer notre modèle complet à partir de ce jeu de données~;
\item
  appliquer \texttt{step()}~;
\item
  recalculer le modèle réduit en repartant du jeu de données complet.
\end{enumerate}

Première étape, ne garder que les observations complètes à l'aide de
\texttt{tidyr::drop\_na()}, en lui indiquant la liste des variables dans
lesquelles vérifier la présence ou non de \texttt{NA}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d\_complet }\OtherTok{\textless{}{-}}\NormalTok{ d }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{drop\_na}\NormalTok{(sexe, groupe\_ages, etudes, relig\_na, heures.tv)}
\end{Highlighting}
\end{Shaded}

Deuxième étape, calculons le modèle complet avec ce jeu données.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod\_na\_alt }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{+}\NormalTok{ groupe\_ages }\SpecialCharTok{+}\NormalTok{ etudes }\SpecialCharTok{+}\NormalTok{ relig\_na }\SpecialCharTok{+}\NormalTok{ heures.tv,}
  \AttributeTok{family =}\NormalTok{ binomial,}
  \AttributeTok{data =}\NormalTok{ d\_complet}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Le modèle \texttt{mod\_na\_alt} est tout à fait identique au modèle
\texttt{mod\_na}, car \texttt{glm()} supprime de lui-même les valeurs
manquantes quand elles existent. Nous pouvons maintenant utiliser
\texttt{step().}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod\_na\_reduit }\OtherTok{\textless{}{-}} \FunctionTok{step}\NormalTok{(mod\_na\_alt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Start:  AIC=2077.34
sport ~ sexe + groupe_ages + etudes + relig_na + heures.tv

              Df Deviance    AIC
- relig_na     3   2053.8 2073.8
<none>             2051.3 2077.3
- heures.tv    1   2064.7 2088.7
- sexe         1   2068.1 2092.1
- groupe_ages  3   2098.8 2118.8
- etudes       4   2173.5 2191.5

Step:  AIC=2073.8
sport ~ sexe + groupe_ages + etudes + heures.tv

              Df Deviance    AIC
<none>             2053.8 2073.8
- heures.tv    1   2067.0 2085.0
- sexe         1   2069.8 2087.8
- groupe_ages  3   2099.5 2113.5
- etudes       4   2176.7 2188.7
\end{verbatim}

Cela s'exécute sans problème car tous les sous-modèles sont calculés à
partir de \texttt{d\_complet} et donc ont bien le même nombre
d'observations. Cependant, dans notre modèle réduit, on a retiré 137
observations en raison d'une valeur manquante sur la variable
\emph{relig\_na}, variable qui n'est plus présente dans notre modèle
réduit. Il serait donc pertinent de réintégrer ces observations.

Nous allons donc recalculer le modèle réduit mais à partir de
\texttt{d}. Inutile de recopier à la main la formule du modèle réduit,
car nous pouvons l'obtenir directement avec
\texttt{mod\_na\_reduit\$formula}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod\_na\_reduit2 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  mod\_na\_reduit}\SpecialCharTok{$}\NormalTok{formula,}
  \AttributeTok{family =}\NormalTok{ binomial,}
  \AttributeTok{data =}\NormalTok{ d}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\textbf{Attention~:} \texttt{mod\_na\_reduit} et
\texttt{mod\_na\_reduit2} ne sont pas identiques puisque le second a été
calculé sur un plus grand nombre d'observations, ce qui change très
légèrement les valeurs des coefficients.

Pour automatiser l'ensemble de ce processus, on peut copier/coller le
code de la fonction générique suivante~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{step\_with\_na }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(model, ...) \{}
  \CommentTok{\# refit the model without NAs}
\NormalTok{  model\_no\_na }\OtherTok{\textless{}{-}} \FunctionTok{update}\NormalTok{(model, }\AttributeTok{data =} \FunctionTok{model.frame}\NormalTok{(model))  }
  \CommentTok{\# apply step()}
\NormalTok{  model\_simplified }\OtherTok{\textless{}{-}} \FunctionTok{step}\NormalTok{(model\_no\_na, ...)}
  \CommentTok{\# recompute simplified model using full data}
  \FunctionTok{update}\NormalTok{(model, }\AttributeTok{formula =} \FunctionTok{terms}\NormalTok{(model\_simplified))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Elle réalise l'ensemble des opérations décrites plus haut en profitant
de la flexibilité offerte par la fonction \texttt{update()}.

\textbf{Attention :} il s'agit d'une fonction expérimentale et elle
n'est peut-être pas compatible avec tous les types de modèles. Elle a
été testée avec les modèles \texttt{lm()}, \texttt{glm()} et
\texttt{nnet::multinom()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod\_na\_reduit\_direct }\OtherTok{\textless{}{-}} \FunctionTok{step\_with\_na}\NormalTok{(mod\_na, }\AttributeTok{trace =} \DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Le résultat obtenu est strictement identique.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(mod\_na\_reduit2, mod\_na\_reduit\_direct)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Analysis of Deviance Table

Model 1: sport ~ sexe + groupe_ages + etudes + heures.tv
Model 2: sport ~ sexe + groupe_ages + etudes + heures.tv
  Resid. Df Resid. Dev Df Deviance
1      1985     2210.4            
2      1985     2210.4  0        0
\end{verbatim}

\end{tcolorbox}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Forcer certaines variables dans le modèle réduit}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Même si l'on a recourt à \texttt{step()}, on peut vouloir forcer la
présence de certaines variables dans le modèle, même si leur suppression
minimiserait l'AIC, en général parce que l'on a des hypothèses
spécifiques pour ces variables et que l'on peut avoir intérêt à montrer
qu'elles n'ont pas d'effet dans le modèle multivarié.

Prenons un exemple~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{autre\_modele }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{+}\NormalTok{ relig }\SpecialCharTok{+}\NormalTok{ heures.tv }\SpecialCharTok{+}\NormalTok{ cinema }\SpecialCharTok{+}\NormalTok{ lecture.bd,}
  \AttributeTok{family =}\NormalTok{ binomial,}
  \AttributeTok{data =}\NormalTok{ d}
\NormalTok{)}
\FunctionTok{step}\NormalTok{(autre\_modele)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Start:  AIC=2350.99
sport ~ sexe + relig + heures.tv + cinema + lecture.bd

             Df Deviance    AIC
- relig       5   2333.5 2343.5
- lecture.bd  1   2332.6 2350.6
<none>            2331.0 2351.0
- sexe        1   2352.4 2370.4
- heures.tv   1   2364.1 2382.1
- cinema      1   2516.7 2534.7

Step:  AIC=2343.52
sport ~ sexe + heures.tv + cinema + lecture.bd

             Df Deviance    AIC
- lecture.bd  1   2335.1 2343.1
<none>            2333.5 2343.5
- sexe        1   2355.9 2363.9
- heures.tv   1   2367.2 2375.2
- cinema      1   2522.3 2530.3

Step:  AIC=2343.1
sport ~ sexe + heures.tv + cinema

            Df Deviance    AIC
<none>           2335.1 2343.1
- sexe       1   2357.1 2363.1
- heures.tv  1   2369.3 2375.3
- cinema     1   2526.2 2532.2
\end{verbatim}

\begin{verbatim}

Call:  glm(formula = sport ~ sexe + heures.tv + cinema, family = binomial, 
    data = d)

Coefficients:
(Intercept)    sexeHomme    heures.tv    cinemaOui  
    -1.0296       0.4708      -0.1807       1.3658  

Degrees of Freedom: 1994 Total (i.e. Null);  1991 Residual
  (5 observations effacées parce que manquantes)
Null Deviance:      2609 
Residual Deviance: 2335     AIC: 2343
\end{verbatim}

Ici, deux variables sont retirées du modèle par \texttt{step()}~:
\emph{relig} et \emph{lecture.bd}. Nous souhaiterions néanmoins que
\emph{lecture.bd} ne soit jamais retirée. Nous allons donc indiquer à
\texttt{step()} un modèle minimum, via l'élément \texttt{lower} passé
dans une liste nommée à l'argument \texttt{scope}s

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{step}\NormalTok{(}
\NormalTok{  autre\_modele,}
  \AttributeTok{scope =} \FunctionTok{list}\NormalTok{(}\AttributeTok{lower =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ lecture.bd)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Start:  AIC=2350.99
sport ~ sexe + relig + heures.tv + cinema + lecture.bd

            Df Deviance    AIC
- relig      5   2333.5 2343.5
<none>           2331.0 2351.0
- sexe       1   2352.4 2370.4
- heures.tv  1   2364.1 2382.1
- cinema     1   2516.7 2534.7

Step:  AIC=2343.52
sport ~ sexe + heures.tv + cinema + lecture.bd

            Df Deviance    AIC
<none>           2333.5 2343.5
- sexe       1   2355.9 2363.9
- heures.tv  1   2367.2 2375.2
- cinema     1   2522.3 2530.3
\end{verbatim}

\begin{verbatim}

Call:  glm(formula = sport ~ sexe + heures.tv + cinema + lecture.bd, 
    family = binomial, data = d)

Coefficients:
  (Intercept)      sexeHomme      heures.tv      cinemaOui  lecture.bdOui  
      -1.0418         0.4766        -0.1795         1.3598         0.4017  

Degrees of Freedom: 1994 Total (i.e. Null);  1990 Residual
  (5 observations effacées parce que manquantes)
Null Deviance:      2609 
Residual Deviance: 2334     AIC: 2344
\end{verbatim}

\end{tcolorbox}

\hypertarget{ruxe9gressions-logistiques-univariuxe9es}{%
\section{Régressions logistiques
univariées}\label{ruxe9gressions-logistiques-univariuxe9es}}

Les usages varient selon les disciplines et les revues scientifiques,
mais il n'est pas rare de présenter, avant le modèle logistique
multivarié, une succession de modèles logistiques univariés (i.e.~avec
une seule variable explicative à la fois) afin de présenter les
\emph{odds ratios} et leur intervalle de confiance et p-valeur associés
avant l'ajustement multiniveau.

Afin d'éviter le code fastidieux consistant à réaliser chaque modèle un
par un (par exemple
\texttt{glm(sport\ \textasciitilde{}\ sexe,\ family\ =\ binomial,\ data\ =\ d)})
puis à en fusionner les résultats, on pourra tirer partie de
\texttt{gtsummary::tbl\_uvregression()} qui permet de réaliser toutes
ces régressions individuelles en une fois et de les présenter dans un
tableau synthétique.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_uvregression}\NormalTok{(}
    \AttributeTok{y =}\NormalTok{ sport,}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(sexe, groupe\_ages, etudes, relig, heures.tv),}
    \AttributeTok{method =}\NormalTok{ glm,}
    \AttributeTok{method.args =} \FunctionTok{list}\NormalTok{(}\AttributeTok{family =}\NormalTok{ binomial),}
    \AttributeTok{exponentiate =} \ConstantTok{TRUE}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-uregression}{}
\begin{table}
\caption{\label{tbl-uregression}Régressions logistiques univariées }\tabularnewline

\centering
\begin{tabular}{l|c|c|c|c}
\hline
**Caractéristique** & **N** & **OR** & **95\% IC** & **p-valeur**\\
\hline
\_\_Sexe\_\_ & 2 000 &  &  & \\
\hline
Femme &  & — & — & \\
\hline
Homme &  & 1,47 & 1,22 – 1,77 & <0,001\\
\hline
\_\_Rapport à la religion\_\_ & 2 000 &  &  & \\
\hline
Pratiquant regulier &  & — & — & \\
\hline
Pratiquant occasionnel &  & 1,08 & 0,78 – 1,50 & 0,6\\
\hline
Appartenance sans pratique &  & 1,31 & 0,98 – 1,78 & 0,071\\
\hline
Ni croyance ni appartenance &  & 1,45 & 1,05 – 2,02 & 0,026\\
\hline
Rejet &  & 1,19 & 0,72 – 1,95 & 0,5\\
\hline
NSP ou NVPR &  & 0,93 & 0,44 – 1,88 & 0,8\\
\hline
\_\_Heures de télévision / jour\_\_ & 1 995 & 0,79 & 0,74 – 0,84 & <0,001\\
\hline
\_\_Groupe d'âges\_\_ & 2 000 &  &  & \\
\hline
18-24 ans &  & — & — & \\
\hline
25-44 ans &  & 0,51 & 0,35 – 0,71 & <0,001\\
\hline
45-64 ans &  & 0,20 & 0,14 – 0,28 & <0,001\\
\hline
65 ans et plus &  & 0,10 & 0,07 – 0,15 & <0,001\\
\hline
\_\_Niveau d'études\_\_ & 2 000 &  &  & \\
\hline
Primaire &  & — & — & \\
\hline
Secondaire &  & 3,61 & 2,52 – 5,23 & <0,001\\
\hline
Technique / Professionnel &  & 4,75 & 3,42 – 6,72 & <0,001\\
\hline
Supérieur &  & 11,4 & 8,11 – 16,3 & <0,001\\
\hline
Non documenté &  & 26,2 & 15,7 – 44,9 & <0,001\\
\hline
\end{tabular}
\end{table}

\hypertarget{pruxe9senter-lensemble-des-ruxe9sultats-dans-un-muxeame-tableau}{%
\section{Présenter l'ensemble des résultats dans un même
tableau}\label{pruxe9senter-lensemble-des-ruxe9sultats-dans-un-muxeame-tableau}}

La fonction \texttt{gtsummary::tbl\_merge()} permet de fusionner
plusieurs tableaux (en tenant compte du nom des variables) et donc de
présenter les différents résultats de l'analyse descriptive, univariée
et multivariée dans un seul et même tableau.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tbl\_desc }\OtherTok{\textless{}{-}}
\NormalTok{  d }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{by =}\NormalTok{ sport,}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(sexe, groupe\_ages, etudes, relig, heures.tv),}
    \AttributeTok{statistic =} \FunctionTok{all\_categorical}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"\{p\}\% (\{n\}/\{N\})"}\NormalTok{,}
    \AttributeTok{percent =} \StringTok{"row"}\NormalTok{,}
    \AttributeTok{digits =} \FunctionTok{all\_categorical}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{modify\_column\_hide}\NormalTok{(}\StringTok{"stat\_1"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{modify\_header}\NormalTok{(}\StringTok{"stat\_2"} \SpecialCharTok{\textasciitilde{}} \StringTok{"**Pratique d\textquotesingle{}un sport**"}\NormalTok{)}

\NormalTok{tbl\_uni }\OtherTok{\textless{}{-}}
\NormalTok{  d }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_uvregression}\NormalTok{(}
    \AttributeTok{y =}\NormalTok{ sport,}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(sexe, groupe\_ages, etudes, relig, heures.tv),}
    \AttributeTok{method =}\NormalTok{ glm,}
    \AttributeTok{method.args =} \FunctionTok{list}\NormalTok{(}\AttributeTok{family =}\NormalTok{ binomial),}
    \AttributeTok{exponentiate =} \ConstantTok{TRUE}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{modify\_column\_hide}\NormalTok{(}\StringTok{"stat\_n"}\NormalTok{)}

\NormalTok{tbl\_multi }\OtherTok{\textless{}{-}}
\NormalTok{  mod2 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{list}\NormalTok{(tbl\_desc, tbl\_uni, tbl\_multi) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_merge}\NormalTok{(}
    \AttributeTok{tab\_spanner =} \FunctionTok{c}\NormalTok{(}
      \ConstantTok{NA}\NormalTok{,}
      \StringTok{"**Régressions univariées**"}\NormalTok{,}
      \StringTok{"**Régression multivariée**"}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-merge-regression-logistique}{}
\begin{table}
\caption{\label{tbl-merge-regression-logistique}tableau synthétique de l'analyse }\tabularnewline

\centering
\begin{tabular}{l|c|c|c|c|c|c|c}
\hline
**Caractéristique** & **Pratique d'un sport** & **OR** & **95\% IC** & **p-valeur** & **OR** & **95\% IC** & **p-valeur**\\
\hline
\_\_Sexe\_\_ &  &  &  &  &  &  & \\
\hline
Femme & 32,2\% (354/1 101) & — & — &  & — & — & \\
\hline
Homme & 41,0\% (369/899) & 1,47 & 1,22 – 1,77 & <0,001 & 1,52 & 1,24 – 1,87 & <0,001\\
\hline
\_\_Groupe d'âges\_\_ &  &  &  &  &  &  & \\
\hline
18-24 ans & 65,7\% (111/169) & — & — &  & — & — & \\
\hline
25-44 ans & 49,2\% (347/706) & 0,51 & 0,35 – 0,71 & <0,001 & 0,68 & 0,43 – 1,06 & 0,084\\
\hline
45-64 ans & 27,4\% (204/745) & 0,20 & 0,14 – 0,28 & <0,001 & 0,36 & 0,23 – 0,57 & <0,001\\
\hline
65 ans et plus & 16,1\% (61/380) & 0,10 & 0,07 – 0,15 & <0,001 & 0,27 & 0,16 – 0,46 & <0,001\\
\hline
\_\_Niveau d'études\_\_ &  &  &  &  &  &  & \\
\hline
Primaire & 10,7\% (50/466) & — & — &  & — & — & \\
\hline
Secondaire & 30,2\% (117/387) & 3,61 & 2,52 – 5,23 & <0,001 & 2,54 & 1,73 – 3,75 & <0,001\\
\hline
Technique / Professionnel & 36,4\% (216/594) & 4,75 & 3,42 – 6,72 & <0,001 & 2,81 & 1,95 – 4,10 & <0,001\\
\hline
Supérieur & 57,8\% (255/441) & 11,4 & 8,11 – 16,3 & <0,001 & 6,55 & 4,50 – 9,66 & <0,001\\
\hline
Non documenté & 75,9\% (85/112) & 26,2 & 15,7 – 44,9 & <0,001 & 8,54 & 4,51 – 16,5 & <0,001\\
\hline
\_\_Rapport à la religion\_\_ &  &  &  &  &  &  & \\
\hline
Pratiquant regulier & 31,6\% (84/266) & — & — &  &  &  & \\
\hline
Pratiquant occasionnel & 33,3\% (147/442) & 1,08 & 0,78 – 1,50 & 0,6 &  &  & \\
\hline
Appartenance sans pratique & 37,8\% (287/760) & 1,31 & 0,98 – 1,78 & 0,071 &  &  & \\
\hline
Ni croyance ni appartenance & 40,1\% (160/399) & 1,45 & 1,05 – 2,02 & 0,026 &  &  & \\
\hline
Rejet & 35,5\% (33/93) & 1,19 & 0,72 – 1,95 & 0,5 &  &  & \\
\hline
NSP ou NVPR & 30,0\% (12/40) & 0,93 & 0,44 – 1,88 & 0,8 &  &  & \\
\hline
\_\_Heures de télévision / jour\_\_ & 2,00 (1,00 – 3,00) & 0,79 & 0,74 – 0,84 & <0,001 & 0,89 & 0,83 – 0,95 & <0,001\\
\hline
Manquant & 3 &  &  &  &  &  & \\
\hline
\end{tabular}
\end{table}

Pour visualiser chaque étape du code, vous pouvez consulter le diaporama
suivant~:
\url{https://larmarange.github.io/guide-R/analyses/ressources/flipbook-regression-logistique.html}

\hypertarget{webin-r-7}{%
\section{webin-R}\label{webin-r-7}}

La régression logistique est présentée sur YouTube dans le
\href{https://youtu.be/-bdMv2aAqUY}{webin-R \#06} (\emph{régression
logistique (partie 1}) et le le
\href{https://youtu.be/BUo9i7XTLYQ}{webin-R \#07} (\emph{régression
logistique (partie 2}).

\url{https://youtu.be/-bdMv2aAqUY}

\url{https://youtu.be/BUo9i7XTLYQ}

\hypertarget{sec-estimations-marginales}{%
\chapter{Prédictions marginales, contrastes marginaux \& effets
marginaux}\label{sec-estimations-marginales}}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-warning-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-warning-color}{\faExclamationTriangle}\hspace{0.5em}{Avertissement}, bottomrule=.15mm, colframe=quarto-callout-warning-color-frame]

Ce chapitre nécessite une version récente de \texttt{\{broom.helpers\}}
(version ≥~1.12.0), de \texttt{\{gtsummary\}} (version ≥~1.6.3), de
\texttt{\{ggstats\}} (version ≥~0.2.1) et de
\texttt{\{marginaleffects\}} (version ≥ 0.10.0).

\end{tcolorbox}

Les coefficients d'une régression multivariée ne sont pas toujours
facile à interpréter car ils ne sont pas forcément exprimés dans la même
dimension que la variable d'intérêt. C'est notamment le cas pour une
régression logistique binaire (cf.
Chapitre~\ref{sec-regression-logistique-binaire}). Comment traduire la
valeur d'un \emph{odds ratio} en écart de probabilité~?

Dans certaines disciplines, notamment en économétrie, on préfère souvent
présenter les effets marginaux qui tentent de traduire les résultats du
modèle dans la dimension de la variable d'intérêt. Plusieurs approches
existent et l'on trouve dans la littérature des expressions telles que
effets marginaux, effets statistiques, moyennes marginales, pentes
marginales, effets marginaux à la moyenne, et autres expressions
similaires.

Différents auteurs peuvent utiliser la même expression pour désigner des
indicateurs différents, ou bien des manières différentes de les
calculer.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

Si vous n'êtes pas familier des estimations marginales et souhaitez
aller à l'essentiel, vous pouvez, en première lecture, vous concentrer
sur les prédications marginales moyennes et les contrastes marginaux
moyens, avant d'explorer les autres variantes.

\end{tcolorbox}

\hypertarget{terminologie}{%
\section{Terminologie}\label{terminologie}}

Dans ce guide, nous avons décidé d'adopter une terminologie consistante
avec celle du package \texttt{\{broom.helpers\}}, elle même basée sur
celle du package
\href{https://vincentarelbundock.github.io/marginaleffects/\#definitions}{\texttt{\{marginaleffects\}}},
dont la première version a été publié en septembre 2021, et avec le
\href{https://www.andrewheiss.com/blog/2022/05/20/marginalia/}{billet
d'Andrew Heiss intitulé \emph{Marginalia}} et publié en mai 2022.

Lorsque l'on utilise un modèle ajusté pour prédire l'\emph{outcome}
selon certaines combinaisons de valeurs des régresseurs / variables
explicatives, par exemple leurs valeurs observées ou leur moyenne, on
obtient des \textbf{prédictions ajustées}. Lorsque ces dernières sont
moyennées selon un régresseur spécifique, nous parlerons alors de
\textbf{prédictions marginales}.

Les \textbf{contrastes marginaux} correspondent au calcul d'une
différence entre des prédictions marginales, que ce soit pour une
variable catégorielle (e.g.~différence entre deux modalités) ou pour une
variable continue (différence observée au niveau de l'\emph{outcome}
pour un certain changement du prédicteur).

Les \textbf{pentes marginales} ou \textbf{effets marginaux} sont
définis, pour des variables continues, comme la dérivée partielle
(\emph{slope}) de l'équation de régression pour certains valeurs de la
variable explicative. Dit autrement, un effet marginal correspond à la
pente locale de la fonction de régression pour certaines valeurs
choisies d'un prédicteur continue. De manière pratique, les effets
marginaux sont similaires aux contrastes marginaux.

L'ensemble de ces indicateurs marginaux se calculent pour certaines
valeurs typiques des variables explicatives, avec plusieurs approches
possibles pour définir des valeurs typiques~: moyenne / mode, valeurs
observées, valeurs personnalisées\ldots{}

Nous présenterons ces différents concepts plus en détail dans la suite
de ce chapitre.

Plusieurs packages proposent des fonctions pour le calcul d'estimations
marginales, \texttt{\{marginaleffects\}}, \texttt{\{emmeans\}},
\texttt{\{margins\}}, \texttt{\{effects\}}, ou encore
\texttt{\{ggeffects\}}, chacun avec des approches et un vocabulaire
légèrement différent.

Le package \texttt{\{broom.helpers\}} fournit plusieurs \emph{tidiers}
qui permettent d'appeler les fonctions de ces autres packages et de
renvoyer un tableau de données compatible avec la fonction
\texttt{broom.helpers::tidy\_plus\_plus()} et dès lors de pouvoir
générer un tableau mis en forme avec
\texttt{gtsummary::tbl\_regression()} ou un graphique avec
\texttt{ggstats::ggcoef\_model()}.

\hypertarget{donnuxe9es-dillustration}{%
\section{Données d'illustration}\label{donnuxe9es-dillustration}}

Pour illustrer ce chapitre, nous allons reprendre le modèle réduit
utilisé dans le chapitre sur la régression logistique binaire (cf.
Chapitre~\ref{sec-regression-logistique-binaire}).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(labelled)}
\FunctionTok{library}\NormalTok{(gtsummary)}
\FunctionTok{theme\_gtsummary\_language}\NormalTok{(}
  \StringTok{"fr"}\NormalTok{,}
  \AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{,}
  \AttributeTok{big.mark =} \StringTok{" "}
\NormalTok{)}

\FunctionTok{data}\NormalTok{(hdv2003, }\AttributeTok{package =} \StringTok{"questionr"}\NormalTok{)}

\NormalTok{d }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{sexe =}\NormalTok{ sexe }\SpecialCharTok{|\textgreater{}} \FunctionTok{fct\_relevel}\NormalTok{(}\StringTok{"Femme"}\NormalTok{),}
    \AttributeTok{groupe\_ages =}\NormalTok{ age }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{cut}\NormalTok{(}
        \FunctionTok{c}\NormalTok{(}\DecValTok{18}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{45}\NormalTok{, }\DecValTok{65}\NormalTok{, }\DecValTok{99}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}\NormalTok{,}
        \AttributeTok{include.lowest =} \ConstantTok{TRUE}\NormalTok{,}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"18{-}24 ans"}\NormalTok{, }\StringTok{"25{-}44 ans"}\NormalTok{,}
                   \StringTok{"45{-}64 ans"}\NormalTok{, }\StringTok{"65 ans et plus"}\NormalTok{)}
\NormalTok{      ),}
    \AttributeTok{etudes =}\NormalTok{ nivetud }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{fct\_recode}\NormalTok{(}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"N\textquotesingle{}a jamais fait d\textquotesingle{}etudes"}\NormalTok{,}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"A arrete ses etudes, avant la derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"Derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
        \StringTok{"Secondaire"} \OtherTok{=} \StringTok{"1er cycle"}\NormalTok{,}
        \StringTok{"Secondaire"} \OtherTok{=} \StringTok{"2eme cycle"}\NormalTok{,}
        \StringTok{"Technique / Professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel court"}\NormalTok{,}
        \StringTok{"Technique / Professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel long"}\NormalTok{,}
        \StringTok{"Supérieur"} \OtherTok{=} \StringTok{"Enseignement superieur y compris technique superieur"}
\NormalTok{    ) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{fct\_na\_value\_to\_level}\NormalTok{(}\StringTok{"Non documenté"}\NormalTok{)  }
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{set\_variable\_labels}\NormalTok{(}
    \AttributeTok{sport =} \StringTok{"Pratique un sport ?"}\NormalTok{,}
    \AttributeTok{sexe =} \StringTok{"Sexe"}\NormalTok{,}
    \AttributeTok{groupe\_ages =} \StringTok{"Groupe d\textquotesingle{}âges"}\NormalTok{,}
    \AttributeTok{etudes =} \StringTok{"Niveau d\textquotesingle{}études"}\NormalTok{,}
    \AttributeTok{heures.tv =} \StringTok{"Heures de télévision / jour"}
\NormalTok{  )}

\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{+}\NormalTok{ groupe\_ages }\SpecialCharTok{+}\NormalTok{ etudes }\SpecialCharTok{+}\NormalTok{ heures.tv,}
  \AttributeTok{family =}\NormalTok{ binomial,}
  \AttributeTok{data =}\NormalTok{ d}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-rappel-model}{}
\begin{longtable}[]{@{}lccc@{}}
\caption{\label{tbl-rappel-model}Odds Ratios du modèle
logistique}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{OR} & \textbf{95\% IC} &
\textbf{p-valeur} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{OR} & \textbf{95\% IC} &
\textbf{p-valeur} \\
\midrule()
\endhead
\textbf{Sexe} & & & \\
Femme & --- & --- & \\
Homme & 1,52 & 1,24 -- 1,87 & \textless0,001 \\
\textbf{Groupe d'âges} & & & \\
18-24 ans & --- & --- & \\
25-44 ans & 0,68 & 0,43 -- 1,06 & 0,084 \\
45-64 ans & 0,36 & 0,23 -- 0,57 & \textless0,001 \\
65 ans et plus & 0,27 & 0,16 -- 0,46 & \textless0,001 \\
\textbf{Niveau d'études} & & & \\
Primaire & --- & --- & \\
Secondaire & 2,54 & 1,73 -- 3,75 & \textless0,001 \\
Technique / Professionnel & 2,81 & 1,95 -- 4,10 & \textless0,001 \\
Supérieur & 6,55 & 4,50 -- 9,66 & \textless0,001 \\
Non documenté & 8,54 & 4,51 -- 16,5 & \textless0,001 \\
\textbf{Heures de télévision / jour} & 0,89 & 0,83 -- 0,95 &
\textless0,001 \\
\bottomrule()
\end{longtable}

Il faut se rappeler que pour calculer le modèle, les observations ayant
au moins une valeur manquante ont été exclues. Le modèle n'a donc pas
été calculé sur 2000 observations (nombre de lignes de \texttt{hdv2003})
mais sur 1995. On peut obtenir le tableau de données du modèle
(\emph{model frame}), qui ne contient que les variables et les
observations utilisées, avec
\texttt{broom.helpers::model\_get\_model\_frame()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mf }\OtherTok{\textless{}{-}}\NormalTok{ mod }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  broom.helpers}\SpecialCharTok{::}\FunctionTok{model\_get\_model\_frame}\NormalTok{()}
\FunctionTok{nrow}\NormalTok{(mf)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1995
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{colnames}\NormalTok{(mf)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "sport"       "sexe"        "groupe_ages" "etudes"      "heures.tv"  
\end{verbatim}

\hypertarget{sec-predictions-marginales}{%
\section{Prédictions marginales}\label{sec-predictions-marginales}}

\hypertarget{pruxe9dictions-marginales-moyennes}{%
\subsection{Prédictions marginales
moyennes}\label{pruxe9dictions-marginales-moyennes}}

Pour illustrer et mieux comprendre ce que représente la différence entre
les femmes et les hommes, nous allons effectuer des prédictions avec
notre modèle en ne faisant varier que la variable \emph{sexe}.

Une première approche consiste à dupliquer nos données observées et à
supposer que tous les individus sont des femmes, puis à supposer que
tous les individus sont des hommes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mf\_femmes }\OtherTok{\textless{}{-}}\NormalTok{ mf }\SpecialCharTok{|\textgreater{}} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{sexe =} \StringTok{"Femme"}\NormalTok{)}
\NormalTok{mf\_hommes }\OtherTok{\textless{}{-}}\NormalTok{ mf }\SpecialCharTok{|\textgreater{}} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{sexe =} \StringTok{"Homme"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Nos deux jeux de données sont donc identiques pour toutes les autres
variables et ne varient que pour le \emph{sexe}. Nous pouvons maintenant
prédire, à partir de notre modèle ajusté, la probabilité de faire du
sport de chacun des individus de ces deux nouveaux jeux de données, puis
à en calculer la moyenne.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} \FunctionTok{predict}\NormalTok{(}\AttributeTok{type =} \StringTok{"response"}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ mf\_femmes) }\SpecialCharTok{|\textgreater{}} \FunctionTok{mean}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.324814
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} \FunctionTok{predict}\NormalTok{(}\AttributeTok{type =} \StringTok{"response"}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ mf\_hommes) }\SpecialCharTok{|\textgreater{}} \FunctionTok{mean}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.4036624
\end{verbatim}

Nous obtenons ainsi des \textbf{prédictions marginales moyennes},
\emph{average marginal predictions} en anglais, de respectivement 32\%
et 40\% pour les femmes et pour les hommes.

Le même résultat, avec en plus un intervalle de confiance, peut
s'obtenir avec \texttt{marginaleffects::predictions()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(marginaleffects)}
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{predictions}\NormalTok{(}\AttributeTok{variables =} \StringTok{"sexe"}\NormalTok{, }\AttributeTok{by =} \StringTok{"sexe"}\NormalTok{, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

  sexe Estimate Std. Error    z Pr(>|z|) 2.5 % 97.5 %
 Femme    0.325     0.0130 25.0   <0.001 0.299  0.350
 Homme    0.404     0.0147 27.5   <0.001 0.375  0.432

Columns: sexe, estimate, std.error, statistic, p.value, conf.low, conf.high 
\end{verbatim}

Pour une variable continue, on peut procéder de la même manière en
générant des prédictions marginales pour certaines valeurs de la
variable. Par défaut, \texttt{marginaleffects::predictions()} réalise
des prédictions selon les 5 nombres de Tukey (\emph{Tukey's five
numbers}, à savoir minimum, premier quartile, médiane, troisième
quartile et maximum).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{predictions}\NormalTok{(}\AttributeTok{variables =} \StringTok{"heures.tv"}\NormalTok{, }\AttributeTok{by =} \StringTok{"heures.tv"}\NormalTok{, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

 heures.tv Estimate Std. Error     z Pr(>|z|)  2.5 % 97.5 %
         0    0.410    0.01711 23.96   <0.001 0.3764  0.443
         1    0.386    0.01220 31.64   <0.001 0.3621  0.410
         2    0.363    0.00991 36.58   <0.001 0.3432  0.382
         3    0.340    0.01145 29.66   <0.001 0.3173  0.362
        12    0.168    0.04220  3.99   <0.001 0.0855  0.251

Columns: heures.tv, estimate, std.error, statistic, p.value, conf.low, conf.high 
\end{verbatim}

Le package \texttt{\{broom.helpers\}} fournit la fonction
\texttt{broom.helpers::tidy\_marginal\_predictions()} qui génèrent les
prédictions marginales de chaque variable\sidenote{\footnotesize La fonction
  \texttt{broom.helpers::tidy\_marginal\_predictions()} peut également
  gérer des combinaisons de variables ou interactions, voir
  Chapitre~\ref{sec-interactions}).} avec
\texttt{marginaleffects::predictions()} et renvoie les résultat dans un
format directement utilisable avec
\texttt{gtsummary::tbl\_regression()}.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

Il est à noter que \texttt{broom.helpers::tidy\_marginal\_predictions()}
renvoie des p-valeurs qui, par défaut, teste si les valeurs prédites
sont différentes de 0 (sur l'échelle de la fonction de lien, donc
différentes de 50\% dans le cas d'une régression logistique). Ce type de
tests n'est pas vraiment pertinent dans le cas présent. On peut
facilement masquer la colonne des p-valeurs avec
\texttt{modify\_column\_hide("p.value")}.

\end{tcolorbox}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_marginal\_predictions,}
    \AttributeTok{type =} \StringTok{"response"}\NormalTok{,}
    \AttributeTok{estimate\_fun =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}\AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{modify\_column\_hide}\NormalTok{(}\StringTok{"p.value"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-predictions-marginales-moyennes}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3951}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.4198}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.1852}}@{}}
\caption{\label{tbl-predictions-marginales-moyennes}Prédictions
marginales moyennes}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Average Marginal Predictions}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Average Marginal Predictions}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} \\
\midrule()
\endhead
\textbf{Sexe} & & \\
Femme & 32.5\% & 29.9\% -- 35.0\% \\
Homme & 40.4\% & 37.5\% -- 43.2\% \\
\textbf{Groupe d'âges} & & \\
18-24 ans & 51.2\% & 42.2\% -- 60.1\% \\
25-44 ans & 42.7\% & 39.3\% -- 46.2\% \\
45-64 ans & 29.9\% & 26.6\% -- 33.2\% \\
65 ans et plus & 24.9\% & 19.7\% -- 30.0\% \\
\textbf{Niveau d'études} & & \\
Primaire & 16.1\% & 11.9\% -- 20.4\% \\
Secondaire & 31.8\% & 27.2\% -- 36.4\% \\
Technique / Professionnel & 34.0\% & 30.3\% -- 37.7\% \\
Supérieur & 53.2\% & 48.4\% -- 57.9\% \\
Non documenté & 59.2\% & 47.0\% -- 71.5\% \\
\textbf{Heures de télévision / jour} & & \\
0 & 41.0\% & 37.6\% -- 44.3\% \\
1 & 38.6\% & 36.2\% -- 41.0\% \\
2 & 36.3\% & 34.3\% -- 38.2\% \\
3 & 34.0\% & 31.7\% -- 36.2\% \\
12 & 16.8\% & 8.6\% -- 25.1\% \\
\bottomrule()
\end{longtable}

La fonction \texttt{broom.helpers::plot\_marginal\_predictions()} permet
de visualiser les prédictions marginales à la moyenne en réalisant une
liste de graphiques, un par variable, que nous pouvons combiner avec
\texttt{patchwork::wrap\_plots()}. L'opérateur \texttt{\&} permet
d'appliquer une fonction de \texttt{\{ggplot2\}} à chaque
sous-graphique. Ici, nous allons uniformiser l'axe des \emph{y}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OtherTok{\textless{}{-}}\NormalTok{ mod }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  broom.helpers}\SpecialCharTok{::}\FunctionTok{plot\_marginal\_predictions}\NormalTok{(}\AttributeTok{type =} \StringTok{"response"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  patchwork}\SpecialCharTok{::}\FunctionTok{wrap\_plots}\NormalTok{() }\SpecialCharTok{\&}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, .}\DecValTok{8}\NormalTok{),}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{()}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/estimations-marginales_files/figure-pdf/fig-predictions-marginales-moyennes-1.pdf}

}

\caption{\label{fig-predictions-marginales-moyennes}Prédictions
marginales moyennes}

\end{figure}

Il est ici difficile de lire les étiquettes de la variable
\emph{etudes}. Nous pouvons éventuellement inverser l'axe des \emph{x}
et celui des \emph{y} avec \texttt{ggplot2::coord\_flip()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\SpecialCharTok{\&} \FunctionTok{coord\_flip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/estimations-marginales_files/figure-pdf/fig-predictions-marginales-moyennes-2-1.pdf}

}

\caption{\label{fig-predictions-marginales-moyennes-2}Prédictions
marginales moyennes}

\end{figure}

Une alternative possible avec d'avoir recours à
\texttt{ggtstats::ggcoef\_model()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_marginal\_predictions,}
    \AttributeTok{tidy\_args =} \FunctionTok{list}\NormalTok{(}\AttributeTok{type =} \StringTok{"response"}\NormalTok{),}
    \AttributeTok{show\_p\_values =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{signif\_stars =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{significance =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{vline =} \ConstantTok{FALSE}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/estimations-marginales_files/figure-pdf/fig-predictions-marginales-moyennes-3-1.pdf}

}

\caption{\label{fig-predictions-marginales-moyennes-3}Prédictions
marginales moyennes}

\end{figure}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Importance de l'argument \texttt{type} pour les modèles \texttt{glm}}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

Lorsque l'on a recours à des modèles calculés avec \texttt{glm()}, il
est possible de réaliser des prédictions selon deux échelles~: l'échelle
de notre \emph{outcome} ou variable à expliquer
(\texttt{type\ =\ "response"}), ici exprimée en probabilités ou
proportions puisqu'il s'agit d'une régression logistique, ou bien selon
l'échelle de la fonction de lien (\texttt{type\ =\ "link"}) du modèle,
ici la fonction \emph{logit} (voir
Section~\ref{sec-interpreter-coefficients-regression-logistique}).

Avec l'option \texttt{type\ =\ "reponse"}, on indique à
\texttt{\{marginaleffects\}} de calculer pour chaque individu une
prédiction selon l'échelle de l'outcome puis de procéder à la moyenne,
ce que nous avons fait dans les exemples précédents.

Si nous avions indiqué \texttt{type\ =\ "link"}, les prédictions
auraient été faites selon l'échelle de la fonction de lien avant d'être
moyennée.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} \FunctionTok{predict}\NormalTok{(}\AttributeTok{type =} \StringTok{"link"}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ mf\_femmes) }\SpecialCharTok{|\textgreater{}} \FunctionTok{mean}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] -0.910525
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} \FunctionTok{predict}\NormalTok{(}\AttributeTok{type =} \StringTok{"link"}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ mf\_hommes) }\SpecialCharTok{|\textgreater{}} \FunctionTok{mean}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] -0.4928844
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{predictions}\NormalTok{(}\AttributeTok{variables =} \StringTok{"sexe"}\NormalTok{, }\AttributeTok{by =} \StringTok{"sexe"}\NormalTok{, }\AttributeTok{type =} \StringTok{"link"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

  sexe Estimate Std. Error      z Pr(>|z|)  2.5 % 97.5 %
 Femme   -0.911     0.0751 -12.13   <0.001 -1.058 -0.763
 Homme   -0.493     0.0779  -6.33   <0.001 -0.646 -0.340

Columns: sexe, estimate, std.error, statistic, p.value, conf.low, conf.high 
\end{verbatim}

Depuis la version 0.10.0 de \texttt{\{marginaleffects\}}, si l'on ne
précise pas le paramètre \texttt{type} (i.e.~si \texttt{type\ =\ NULL}),
la fonction \texttt{marginaleffects::predictions()} réalise les
prédictions selon l'échelle de la fonction de lien, calcule les moyennes
puis re-transforme ce résultat selon l'échelle de la variable à
expliquer.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{logit\_inverse }\OtherTok{\textless{}{-}} \FunctionTok{binomial}\NormalTok{(}\StringTok{"logit"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}\NormalTok{ purrr}\SpecialCharTok{::}\FunctionTok{pluck}\NormalTok{(}\StringTok{"linkinv"}\NormalTok{)}
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} \FunctionTok{predict}\NormalTok{(}\AttributeTok{type =} \StringTok{"link"}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ mf\_femmes) }\SpecialCharTok{|\textgreater{}} \FunctionTok{mean}\NormalTok{() }\SpecialCharTok{|\textgreater{}} \FunctionTok{logit\_inverse}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.2868924
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} \FunctionTok{predict}\NormalTok{(}\AttributeTok{type =} \StringTok{"link"}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ mf\_hommes) }\SpecialCharTok{|\textgreater{}} \FunctionTok{mean}\NormalTok{() }\SpecialCharTok{|\textgreater{}} \FunctionTok{logit\_inverse}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.3792143
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{predictions}\NormalTok{(}\AttributeTok{variables =} \StringTok{"sexe"}\NormalTok{, }\AttributeTok{by =} \StringTok{"sexe"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

  sexe Estimate Pr(>|z|) 2.5 % 97.5 %
 Femme    0.287   <0.001 0.258  0.318
 Homme    0.379   <0.001 0.344  0.416

Columns: sexe, estimate, p.value, conf.low, conf.high 
\end{verbatim}

Or, la plupart du temps, le logit inverse de la moyenne des prédictions
est différent de la moyenne des logit inverse des prédictions~!

Les résultats seront similaires et du même ordre de grandeur, mais pas
identiques.

\end{tcolorbox}

\hypertarget{pruxe9dictions-marginales-uxe0-la-moyenne}{%
\subsection{Prédictions marginales à la
moyenne}\label{pruxe9dictions-marginales-uxe0-la-moyenne}}

Pour les prédictions marginales moyennes, nous avons réalisé des
prédictions pour chaque observations du tableau d'origine, en faisant
varier juste une variable à la fois, avant de calculer la moyenne des
prédictions.

Une alternative consiste à générer une sorte d'individu moyen / typique
puis à réaliser des prédictions pour cette unique individu, en faisant
juste varier la variable explicative d'intérêt. On parle alors de
\textbf{prédictions marginales à la moyenne}, \emph{marginal predictions
at the mean} en anglais.

\hypertarget{avec-marginaleffects}{%
\subsubsection{\texorpdfstring{avec
\texttt{\{marginaleffects\}}}{avec \{marginaleffects\}}}\label{avec-marginaleffects}}

On peut réaliser cela avec \texttt{\{marginaleffects\}} en précisant
\texttt{newdata\ =\ "mean"}. Prenons un exemple pour la variable
\emph{sexe}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} \FunctionTok{predictions}\NormalTok{(}\AttributeTok{variables =} \StringTok{"sexe"}\NormalTok{, }\AttributeTok{newdata =} \StringTok{"mean"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

 Estimate Pr(>|z|) 2.5 % 97.5 %
    0.239   <0.001 0.196  0.289
    0.323   <0.001 0.273  0.378

Columns: rowid, rowidcf, estimate, p.value, conf.low, conf.high, sport, groupe_ages, etudes, heures.tv, sexe 
\end{verbatim}

Dans ce cas de figure, \texttt{\{marginaleffects\}} considère pour
chaque variable continue sa moyenne (ici \texttt{2.246} pour
\emph{heures.tv}) et pour chaque variable catégorielle son mode (la
valeur observée la plus fréquente, ici
\texttt{"Technique\ /\ Professionnel"} pour la variable \emph{etudes}).
On fait juste varier les modalités de \emph{sexe} puis on calculer la
probabilité de faire du sport de ces individus moyens.

On peut également passer le paramètre \texttt{newdata\ =\ "mean"} à
\texttt{broom.helpers::tidy\_marginal\_predictions()} ou même à
\texttt{gtsummary::tbl\_regression()}\sidenote{\footnotesize Les paramètres
  additionnels indiqués à \texttt{gtsummary::tbl\_regression()} sont
  transmis en cascade à \texttt{broom.helpers::tidy\_plus\_plus()} puis
  à \texttt{broom.helpers::tidy\_marginal\_predictions()} et enfin à
  \texttt{marginaleffects::predictions()}.}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_marginal\_predictions,}
    \AttributeTok{newdata =} \StringTok{"mean"}\NormalTok{,}
    \AttributeTok{estimate\_fun =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}\AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{modify\_column\_hide}\NormalTok{(}\StringTok{"p.value"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-predictions-marginales-a-la-moyenne}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3765}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.4471}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.1765}}@{}}
\caption{\label{tbl-predictions-marginales-a-la-moyenne}Prédictions
marginales à la moyenne}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Marginal Predictions at the Mean}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Marginal Predictions at the Mean}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} \\
\midrule()
\endhead
\textbf{Sexe} & & \\
Femme & 23.9\% & 19.6\% -- 28.9\% \\
Homme & 32.3\% & 27.3\% -- 37.8\% \\
\textbf{Groupe d'âges} & & \\
18-24 ans & 46.8\% & 36.1\% -- 57.8\% \\
25-44 ans & 37.3\% & 32.1\% -- 42.8\% \\
45-64 ans & 23.9\% & 19.6\% -- 28.9\% \\
65 ans et plus & 19.2\% & 14.0\% -- 25.6\% \\
\textbf{Niveau d'études} & & \\
Primaire & 10.1\% & 7.3\% -- 13.7\% \\
Secondaire & 22.1\% & 17.7\% -- 27.2\% \\
Technique / Professionnel & 23.9\% & 19.6\% -- 28.9\% \\
Supérieur & 42.3\% & 36.0\% -- 48.9\% \\
Non documenté & 48.9\% & 34.7\% -- 63.2\% \\
\textbf{Heures de télévision / jour} & & \\
0 & 29.2\% & 23.6\% -- 35.5\% \\
1 & 26.8\% & 21.9\% -- 32.3\% \\
2 & 24.5\% & 20.1\% -- 29.5\% \\
3 & 22.3\% & 18.1\% -- 27.2\% \\
12 & 8.8\% & 4.6\% -- 16.4\% \\
\bottomrule()
\end{longtable}

De même, on peut générer une représentation graphique~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OtherTok{\textless{}{-}}\NormalTok{ mod }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  broom.helpers}\SpecialCharTok{::}\FunctionTok{plot\_marginal\_predictions}\NormalTok{(}\AttributeTok{newdata =} \StringTok{"mean"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  patchwork}\SpecialCharTok{::}\FunctionTok{wrap\_plots}\NormalTok{() }\SpecialCharTok{\&}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, .}\DecValTok{8}\NormalTok{),}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{\&}
  \FunctionTok{coord\_flip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/estimations-marginales_files/figure-pdf/fig-predictions-marginales-a-la-moyenne-1.pdf}

}

\caption{\label{fig-predictions-marginales-a-la-moyenne}Prédictions
marginales à la moyenne}

\end{figure}

Si l'on souhaite utiliser \texttt{ggstats::ggcoef\_model()}, on peut
directement indiquer \texttt{newdata\ =\ "mean"}. Il faudra passer cette
option via \texttt{tidy\_args} qui prend une liste d'arguments à
transmettre à \texttt{tidy\_fun}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_marginal\_predictions,}
    \AttributeTok{tidy\_args =} \FunctionTok{list}\NormalTok{(}\AttributeTok{newdata =} \StringTok{"mean"}\NormalTok{),}
    \AttributeTok{show\_p\_values =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{signif\_stars =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{significance =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{vline =} \ConstantTok{FALSE}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/estimations-marginales_files/figure-pdf/fig-predictions-marginales-a-la-moyenne-2-1.pdf}

}

\caption{\label{fig-predictions-marginales-a-la-moyenne-2}Prédictions
marginales à la moyenne}

\end{figure}

\hypertarget{avec-effects}{%
\subsubsection{\texorpdfstring{avec
\texttt{\{effects\}}}{avec \{effects\}}}\label{avec-effects}}

Le package \texttt{\{effects\}}\sidenote{\footnotesize Malgré son nom, le package
  \texttt{\{effects\}} ne calcule pas des effets marginaux mais des
  prédictions marginales, selon la terminologie retenue au début de ce
  document.} adopte une approche un peu différente pour définir un
individu moyen.

Calculons les prédictions marginales à la moyenne avec la fonction
\texttt{effects::Effect()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{e }\OtherTok{\textless{}{-}}\NormalTok{ effects}\SpecialCharTok{::}\FunctionTok{Effect}\NormalTok{(}\StringTok{"sexe"}\NormalTok{, mod)}
\NormalTok{e}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

 sexe effect
sexe
    Femme     Homme 
0.2868924 0.3792143 
\end{verbatim}

On le voit, les résultats sont là encore assez proches mais différents.
Regardons de plus près les données utilisées pour les prédictions.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{e}\SpecialCharTok{$}\NormalTok{model.matrix}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  (Intercept) sexeHomme groupe_ages25-44 ans groupe_ages45-64 ans
1           1         0            0.3533835            0.3719298
2           1         1            0.3533835            0.3719298
  groupe_ages65 ans et plus etudesSecondaire etudesTechnique / Professionnel
1                 0.1904762         0.193985                       0.2962406
2                 0.1904762         0.193985                       0.2962406
  etudesSupérieur etudesNon documenté heures.tv
1       0.2205514          0.05614035  2.246566
2       0.2205514          0.05614035  2.246566
attr(,"assign")
 [1] 0 1 2 2 2 3 3 3 3 4
attr(,"contrasts")
attr(,"contrasts")$sexe
[1] "contr.treatment"

attr(,"contrasts")$groupe_ages
[1] "contr.treatment"

attr(,"contrasts")$etudes
[1] "contr.treatment"
\end{verbatim}

Pour les variables continues, \texttt{\{effects\}} utilise la moyenne
observée de la variable, comme précédemment avec
\texttt{\{marginaleffects\}}. Par contre, pour les variables
catégorielles, ce n'est pas le mode qui est utilisé, mais l'ensemble des
modalités, pondérées selon leur proportion observée dans l'échantillon.
Cette approche a l'avantage de moyenniser également les variables
catégorielles, même si les indvidus pour lesquels une prédiction est
réalisée sont complètement fictifs.

On peut utiliser \texttt{broom.helpers::tidy\_all\_effects()} pour
générer un tableau de prédictions marginales avec \texttt{\{effects\}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_all\_effects,}
    \AttributeTok{estimate\_fun =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}\AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-predictions-marginales-effects}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3765}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.4471}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.1765}}@{}}
\caption{\label{tbl-predictions-marginales-effects}Prédictions
marginales à la moyenne avec le package effects}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Marginal Predictions at the Mean}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Marginal Predictions at the Mean}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} \\
\midrule()
\endhead
\textbf{Sexe} & & \\
Femme & 28.7\% & 25.8\% -- 31.8\% \\
Homme & 37.9\% & 34.4\% -- 41.6\% \\
\textbf{Groupe d'âges} & & \\
18-24 ans & 51.2\% & 41.0\% -- 61.3\% \\
25-44 ans & 41.5\% & 37.4\% -- 45.7\% \\
45-64 ans & 27.3\% & 23.9\% -- 30.9\% \\
65 ans et plus & 22.0\% & 17.4\% -- 27.5\% \\
\textbf{Niveau d'études} & & \\
Primaire & 14.9\% & 11.3\% -- 19.3\% \\
Secondaire & 30.7\% & 26.2\% -- 35.7\% \\
Technique / Professionnel & 32.9\% & 29.1\% -- 37.0\% \\
Supérieur & 53.4\% & 48.3\% -- 58.4\% \\
Non documenté & 59.9\% & 46.6\% -- 71.8\% \\
\textbf{Heures de télévision / jour} & & \\
0 & 38.9\% & 34.8\% -- 43.2\% \\
3 & 30.7\% & 28.1\% -- 33.4\% \\
6 & 23.6\% & 18.9\% -- 28.9\% \\
9 & 17.7\% & 11.9\% -- 25.4\% \\
10 & 16.0\% & 10.1\% -- 24.4\% \\
\bottomrule()
\end{longtable}

Pour une représentation graphique, nous pouvons utiliser les fonctions
internes d'\texttt{\{effects\}} en appliquant \texttt{plot()} aux
résultats de \texttt{effects::allEffects()} qui calcule les prédictions
marginales de chaque variable.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  effects}\SpecialCharTok{::}\FunctionTok{allEffects}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{plot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/estimations-marginales_files/figure-pdf/fig-predictions-marginales-effects-1.pdf}

}

\caption{\label{fig-predictions-marginales-effects}Prédictions
marginales à la moyenne avec le package effects}

\end{figure}

On peut aussi utiliser \texttt{ggstats::ggcoef\_model()}\sidenote{\footnotesize De
  manière générale, \texttt{ggstats::ggcoef\_model()} est compatible
  avec les mêmes \texttt{tidy\_fun} que
  \texttt{gtsummary::tbl\_regression()}, les deux fonctions utilisant en
  interne \texttt{broom.helpers::tidy\_plus\_plus()}.}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_all\_effects,}
    \AttributeTok{vline =} \ConstantTok{FALSE}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/estimations-marginales_files/figure-pdf/fig-predictions-marginales-effects-2-1.pdf}

}

\caption{\label{fig-predictions-marginales-effects-2}Prédictions
marginales à la moyenne avec le package effects}

\end{figure}

\hypertarget{variantes}{%
\subsection{Variantes}\label{variantes}}

Le package \texttt{\{ggeffects\}} propose une fonction
\texttt{ggeffects::ggpredict()} qui calcule des prédictions marginales à
la moyenne des variables continues et à la première modalité (utilisée
comme référence) des variables catégorielles. On ne peut donc plus, au
sens strict, parler de prédictions à la moyenne.
\texttt{\{broom.helpers\}} fournit une fonction
\texttt{tidy\_ggpredict()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_ggpredict,}
    \AttributeTok{estimate\_fun =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}\AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Data were 'prettified'. Consider using `terms="heures.tv [all]"` to get
  smooth plots.
\end{verbatim}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-ggpredict}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.4384}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3562}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.2055}}@{}}
\caption{\label{tbl-ggpredict}Prédictions marginales avec
ggpredict()}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Marginal Predictions}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Marginal Predictions}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} \\
\midrule()
\endhead
\textbf{Sexe} & & \\
Femme & 23.8\% & 15.3\% -- 35.1\% \\
Homme & 32.2\% & 21.4\% -- 45.4\% \\
\textbf{Groupe d'âges} & & \\
18-24 ans & 23.8\% & 15.3\% -- 35.1\% \\
25-44 ans & 17.5\% & 12.7\% -- 23.5\% \\
45-64 ans & 10.1\% & 7.3\% -- 13.7\% \\
65 ans et plus & 7.8\% & 5.5\% -- 10.9\% \\
\textbf{Niveau d'études} & & \\
Primaire & 23.8\% & 15.3\% -- 35.1\% \\
Secondaire & 44.2\% & 33.0\% -- 56.1\% \\
Technique / Professionnel & 46.8\% & 36.1\% -- 57.8\% \\
Supérieur & 67.2\% & 56.2\% -- 76.6\% \\
Non documenté & 72.8\% & 62.8\% -- 80.9\% \\
\textbf{Heures de télévision / jour} & & \\
0 & 29.1\% & 18.7\% -- 42.3\% \\
1 & 26.7\% & 17.2\% -- 38.9\% \\
2 & 24.4\% & 15.7\% -- 35.8\% \\
3 & 22.2\% & 14.2\% -- 33.0\% \\
4 & 20.2\% & 12.8\% -- 30.4\% \\
5 & 18.3\% & 11.4\% -- 28.2\% \\
6 & 16.6\% & 10.0\% -- 26.1\% \\
7 & 15.0\% & 8.8\% -- 24.3\% \\
8 & 13.5\% & 7.7\% -- 22.7\% \\
9 & 12.1\% & 6.6\% -- 21.2\% \\
10 & 10.9\% & 5.7\% -- 19.9\% \\
11 & 9.8\% & 4.9\% -- 18.7\% \\
12 & 8.8\% & 4.2\% -- 17.6\% \\
\bottomrule()
\end{longtable}

Pour une représentation graphique, on peut utiliser les fonctionnalités
natives inclues dans le package \texttt{\{ggeffects\}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  ggeffects}\SpecialCharTok{::}\FunctionTok{ggpredict}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{plot}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  patchwork}\SpecialCharTok{::}\FunctionTok{wrap\_plots}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/estimations-marginales_files/figure-pdf/fig-ggpredict-1.pdf}

}

\caption{\label{fig-ggpredict}Prédictions marginales avec ggpredict()}

\end{figure}

\hypertarget{contrastes-marginaux}{%
\section{Contrastes marginaux}\label{contrastes-marginaux}}

Maintenant que nous savons estimer des prédictions marginales, nous
pouvons facilement calculer des \textbf{contrastes marginaux}, à savoir
des différences entre prédictions marginales.

\hypertarget{contrastes-marginaux-moyens}{%
\subsection{Contrastes marginaux
moyens}\label{contrastes-marginaux-moyens}}

Considérons tout d'abord la variable catégorielle \emph{sexe} et
calculons les prédictions marginales moyennes avec
\texttt{marginaleffects::predictions()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pred }\OtherTok{\textless{}{-}} \FunctionTok{predictions}\NormalTok{(mod, }\AttributeTok{variables =} \StringTok{"sexe"}\NormalTok{, }\AttributeTok{by =} \StringTok{"sexe"}\NormalTok{, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{pred}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

  sexe Estimate Std. Error    z Pr(>|z|) 2.5 % 97.5 %
 Femme    0.325     0.0130 25.0   <0.001 0.299  0.350
 Homme    0.404     0.0147 27.5   <0.001 0.375  0.432

Columns: sexe, estimate, std.error, statistic, p.value, conf.low, conf.high 
\end{verbatim}

Le contraste entre les hommes et les femmes est tout simplement la
différence et les deux prédictions marginales.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pred}\SpecialCharTok{$}\NormalTok{estimate[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ pred}\SpecialCharTok{$}\NormalTok{estimate[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.07884839
\end{verbatim}

La fonction \texttt{marginaleffects::avg\_comparisons()} permet de
réaliser directement ce calcul.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{avg\_comparisons}\NormalTok{(mod, }\AttributeTok{variables =} \StringTok{"sexe"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

 Term      Contrast Estimate Std. Error z Pr(>|z|)  2.5 % 97.5 %
 sexe Homme - Femme   0.0788     0.0197 4   <0.001 0.0402  0.117

Columns: term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high 
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Dans les faits, \texttt{marginaleffects::avg\_comparisons()} a calculé
la différence entre les hommes et les femmes pour chaque observation
d'origine puis a réalisé la moyenne des différences. Mathématiquement,
la moyenne des différences est équivalente à la différence des moyennes.

\end{tcolorbox}

Les contrastes calculés ici ont été moyennés sur l'ensemble des valeurs
observées. On parle donc de \textbf{contrastes marginaux moyens}
(\emph{average marginal contrasts}).

Par défaut, chaque modalité est contrastée avec la première modalité
prise comme référence (voir exemple ci-dessous avec la variable
\emph{groupe\_ages}.

Regardons maintenant une variable continue.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{avg\_comparisons}\NormalTok{(mod, }\AttributeTok{variables =} \StringTok{"heures.tv"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

      Term Contrast Estimate Std. Error     z Pr(>|z|)   2.5 %  97.5 %
 heures.tv       +1  -0.0227     0.0062 -3.66   <0.001 -0.0348 -0.0105

Columns: term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high 
\end{verbatim}

Par défaut, \texttt{marginaleffects::avg\_comparisons()} calcule, pour
chaque valeur observée de \emph{heures.tv}, l'effet sur la probabilité
de pratiquer un sport d'augmenter de 1 le nombre d'heures quotidiennes
de télévision (plus précisément la différence des valeurs prédites pour
la valeur observée plus 0,5 et la valeur observée moins 0,5).

On peut facilement obtenir la liste des contrastes marginaux pour
l'ensemble des variables.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{avg\_comparisons}\NormalTok{(mod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

        Term                             Contrast Estimate Std. Error     z
 etudes      Non documenté - Primaire               0.4309     0.0691  6.23
 etudes      Secondaire - Primaire                  0.1568     0.0314  4.99
 etudes      Supérieur - Primaire                   0.3701     0.0337 10.98
 etudes      Technique / Professionnel - Primaire   0.1781     0.0295  6.04
 groupe_ages 25-44 ans - 18-24 ans                 -0.0844     0.0492 -1.71
 groupe_ages 45-64 ans - 18-24 ans                 -0.2127     0.0507 -4.20
 groupe_ages 65 ans et plus - 18-24 ans            -0.2631     0.0556 -4.73
 heures.tv   +1                                    -0.0227     0.0062 -3.66
 sexe        Homme - Femme                          0.0788     0.0197  4.00
 Pr(>|z|)   2.5 %  97.5 %
   <0.001  0.2954  0.5665
   <0.001  0.0952  0.2184
   <0.001  0.3040  0.4361
   <0.001  0.1203  0.2359
   0.0865 -0.1808  0.0121
   <0.001 -0.3121 -0.1133
   <0.001 -0.3720 -0.1541
   <0.001 -0.0348 -0.0105
   <0.001  0.0402  0.1175

Columns: term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high 
\end{verbatim}

Il est important de noter que le nom des colonnes n'est pas compatible
avec les fonctions de \texttt{\{broom.helpers\}} et par extension avec
\texttt{gtsummary::tbl\_regression()} et
\texttt{ggstats::ggcoef\_model()}. On utilisera donc
\texttt{broom.helpers::tidy\_marginal\_contrasts()}\sidenote{\footnotesize Il existe
  également une fonction
  \texttt{broom.helpers::tidy\_avg\_comparisons()} mais on lui préférera
  \texttt{broom.helpers::tidy\_marginal\_contrasts()}. Pour un modèle
  sans interaction, les résultats sont identiques. Mais
  \texttt{broom.helpers::tidy\_marginal\_contrasts()} peut gérer des
  termes d'interactions, ce qui sera utile dans un prochain chapitre
  (cf. Chapitre~\ref{sec-interactions}).} qui remets en forme le tableau
de résultats dans un format compatible. On pourra ainsi produire un
tableau propre des résultats\sidenote{\footnotesize Notez l'utilisation de
  \texttt{style\_positive\ =\ "plus"} dans l'appel de
  \texttt{scales::label\_percent()} pour ajouter un signe \texttt{+}
  devant les valeurs positives, afin de bien indiquer que l'on
  représente le résultat d'une différence.}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_marginal\_contrasts,}
    \AttributeTok{estimate\_fun =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}
      \AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{,}
      \AttributeTok{style\_positive =} \StringTok{"plus"}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-contrastes-marginaux-moyens}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3700}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3200}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1700}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1400}}@{}}
\caption{\label{tbl-contrastes-marginaux-moyens}Contrastes marginaux
moyens}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Average Marginal Contrasts}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Average Marginal Contrasts}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
\textbf{Sexe} & & & \\
Homme - Femme & +7.9\% & +4.0\% -- +11.7\% & \textless0,001 \\
\textbf{Groupe d'âges} & & & \\
25-44 ans - 18-24 ans & -8.4\% & -18.1\% -- +1.2\% & 0,086 \\
45-64 ans - 18-24 ans & -21.3\% & -31.2\% -- -11.3\% & \textless0,001 \\
65 ans et plus - 18-24 ans & -26.3\% & -37.2\% -- -15.4\% &
\textless0,001 \\
\textbf{Niveau d'études} & & & \\
Non documenté - Primaire & +43.1\% & +29.5\% -- +56.6\% &
\textless0,001 \\
Secondaire - Primaire & +15.7\% & +9.5\% -- +21.8\% & \textless0,001 \\
Supérieur - Primaire & +37.0\% & +30.4\% -- +43.6\% & \textless0,001 \\
Technique / Professionnel - Primaire & +17.8\% & +12.0\% -- +23.6\% &
\textless0,001 \\
\textbf{Heures de télévision / jour} & & & \\
+1 & -2.3\% & -3.5\% -- -1.1\% & \textless0,001 \\
\bottomrule()
\end{longtable}

De même, on peut représenter les contrastes marginaux moyens avec
\texttt{ggstats::ggcoef\_model()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(}
\NormalTok{  mod,}
  \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_marginal\_contrasts}
\NormalTok{) }\SpecialCharTok{+}
\NormalTok{  ggplot2}\SpecialCharTok{::}\FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}\AttributeTok{style\_positive =} \StringTok{"plus"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/estimations-marginales_files/figure-pdf/fig-contrastes-marginaux-moyens-1.pdf}

}

\caption{\label{fig-contrastes-marginaux-moyens}Contrastes marginaux
moyens}

\end{figure}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Il est possible de personnaliser le type de contrastes calculés,
variable par variable, avec l'option \texttt{variables\_list} de
\texttt{broom.helpers::tidy\_marginal\_contrasts()}. La syntaxe est un
peu particulière~: il faut transmettre une liste de listes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_marginal\_contrasts,}
    \AttributeTok{variables\_list =} \FunctionTok{list}\NormalTok{(}
      \FunctionTok{list}\NormalTok{(}\AttributeTok{heures.tv =} \DecValTok{2}\NormalTok{),}
      \FunctionTok{list}\NormalTok{(}\AttributeTok{groupe\_ages =} \StringTok{"pairwise"}\NormalTok{),}
      \FunctionTok{list}\NormalTok{(}\AttributeTok{etudes =} \StringTok{"sequential"}\NormalTok{)}
\NormalTok{    ),}
    \AttributeTok{estimate\_fun =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}
      \AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{,}
      \AttributeTok{style\_positive =} \StringTok{"plus"}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3824}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3137}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1667}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1373}}@{}}
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Average Marginal Contrasts}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
\textbf{Heures de télévision / jour} & & & \\
+2 & -4.5\% & -7.0\% -- -2.1\% & \textless0,001 \\
\textbf{Groupe d'âges} & & & \\
25-44 ans - 18-24 ans & -8.4\% & -18.1\% -- +1.2\% & 0,086 \\
45-64 ans - 18-24 ans & -21.3\% & -31.2\% -- -11.3\% & \textless0,001 \\
45-64 ans - 25-44 ans & -12.8\% & -17.6\% -- -8.1\% & \textless0,001 \\
65 ans et plus - 18-24 ans & -26.3\% & -37.2\% -- -15.4\% &
\textless0,001 \\
65 ans et plus - 25-44 ans & -17.9\% & -24.3\% -- -11.4\% &
\textless0,001 \\
65 ans et plus - 45-64 ans & -5.0\% & -11.0\% -- +0.9\% & 0,10 \\
\textbf{Niveau d'études} & & & \\
Non documenté - Supérieur & +6.1\% & -7.0\% -- +19.2\% & 0,4 \\
Secondaire - Primaire & +15.7\% & +9.5\% -- +21.8\% & \textless0,001 \\
Supérieur - Technique / Professionnel & +19.2\% & +13.3\% -- +25.1\% &
\textless0,001 \\
Technique / Professionnel - Secondaire & +2.1\% & -3.8\% -- +8.0\% &
0,5 \\
\bottomrule()
\end{longtable}

On peut obtenir le même résultat avec
\texttt{broom.helpers::tidy\_avg\_comparison()} avec une syntaxe un peu
plus simple (en passant une liste via \texttt{variables} au lieu d'une
liste de listes via \texttt{variables\_list}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_avg\_comparisons,}
    \AttributeTok{variables =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{heures.tv =} \DecValTok{2}\NormalTok{,}
      \AttributeTok{groupe\_ages =} \StringTok{"pairwise"}\NormalTok{,}
      \AttributeTok{etudes =} \StringTok{"sequential"}
\NormalTok{    ),}
    \AttributeTok{estimate\_fun =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}
      \AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{,}
      \AttributeTok{style\_positive =} \StringTok{"plus"}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3824}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3137}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1667}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1373}}@{}}
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Average Marginal Contrasts}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
\textbf{Niveau d'études} & & & \\
Non documenté - Supérieur & +6.1\% & -7.0\% -- +19.2\% & 0,4 \\
Secondaire - Primaire & +15.7\% & +9.5\% -- +21.8\% & \textless0,001 \\
Supérieur - Technique / Professionnel & +19.2\% & +13.3\% -- +25.1\% &
\textless0,001 \\
Technique / Professionnel - Secondaire & +2.1\% & -3.8\% -- +8.0\% &
0,5 \\
\textbf{Groupe d'âges} & & & \\
25-44 ans - 18-24 ans & -8.4\% & -18.1\% -- +1.2\% & 0,086 \\
45-64 ans - 18-24 ans & -21.3\% & -31.2\% -- -11.3\% & \textless0,001 \\
45-64 ans - 25-44 ans & -12.8\% & -17.6\% -- -8.1\% & \textless0,001 \\
65 ans et plus - 18-24 ans & -26.3\% & -37.2\% -- -15.4\% &
\textless0,001 \\
65 ans et plus - 25-44 ans & -17.9\% & -24.3\% -- -11.4\% &
\textless0,001 \\
65 ans et plus - 45-64 ans & -5.0\% & -11.0\% -- +0.9\% & 0,10 \\
\textbf{Heures de télévision / jour} & & & \\
+2 & -4.5\% & -7.0\% -- -2.1\% & \textless0,001 \\
\bottomrule()
\end{longtable}

\end{tcolorbox}

\hypertarget{contrastes-marginaux-uxe0-la-moyenne}{%
\subsection{Contrastes marginaux à la
moyenne}\label{contrastes-marginaux-uxe0-la-moyenne}}

Comme précédemment, plutôt que de calculer les contrastes marginaux pour
chaque individu observé avant de faire la moyenne des résultats, une
approche alternative consiste à considérer un individu moyen / typique
et à calculer les contrastes marginaux pour cet individu. On parle alors
de \textbf{contrastes marginaux à la moyenne} (\emph{marginal contrasts
at the mean}).

Avec \texttt{\{marginaleffects\}}, il suffit de spécifier
\texttt{newdata\ =\ "mean"}. Les variables continues seront fixées à
leur moyenne et les variables catégorielles à leur mode (modalité la
plus fréquente dans l'échantillon).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_marginal\_contrasts,}
    \AttributeTok{newdata =} \StringTok{"mean"}\NormalTok{,}
    \AttributeTok{estimate\_fun =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}
      \AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{,}
      \AttributeTok{style\_positive =} \StringTok{"plus"}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-contrastes-marginaux-uxe0-la-moyenne}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3558}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3462}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1635}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1346}}@{}}
\caption{\label{tbl-contrastes-marginaux-à-la-moyenne}Contrastes
marginaux à la moyenne}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Marginal Contrasts at the Mean}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Marginal Contrasts at the Mean}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
\textbf{Sexe} & & & \\
Homme - Femme & +8.4\% & +4.3\% -- +12.5\% & \textless0,001 \\
\textbf{Groupe d'âges} & & & \\
25-44 ans - 18-24 ans & -9.5\% & -20.5\% -- +1.5\% & 0,090 \\
45-64 ans - 18-24 ans & -22.9\% & -33.8\% -- -11.9\% & \textless0,001 \\
65 ans et plus - 18-24 ans & -27.6\% & -39.2\% -- -16.1\% &
\textless0,001 \\
\textbf{Niveau d'études} & & & \\
Non documenté - Primaire & +38.8\% & +24.1\% -- +53.5\% &
\textless0,001 \\
Secondaire - Primaire & +12.0\% & +7.0\% -- +17.1\% & \textless0,001 \\
Supérieur - Primaire & +32.2\% & +25.7\% -- +38.7\% & \textless0,001 \\
Technique / Professionnel - Primaire & +13.9\% & +9.0\% -- +18.7\% &
\textless0,001 \\
\textbf{Heures de télévision / jour} & & & \\
+1 & -2.2\% & -3.4\% -- -1.0\% & \textless0,001 \\
\bottomrule()
\end{longtable}

Pour la fonction \texttt{ggstats::ggcoef\_model()}, on utilisera
l'argument \texttt{tidy\_args} pour transmettre l'option
\texttt{newdata\ =\ "mean"}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(}
\NormalTok{  mod,}
  \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_marginal\_contrasts,}
  \AttributeTok{tidy\_args =} \FunctionTok{list}\NormalTok{(}\AttributeTok{newdata =} \StringTok{"mean"}\NormalTok{)}
\NormalTok{) }\SpecialCharTok{+}
\NormalTok{  ggplot2}\SpecialCharTok{::}\FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}\AttributeTok{style\_positive =} \StringTok{"plus"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/estimations-marginales_files/figure-pdf/fig-contrastes-marginaux-a-la-moyenne-1.pdf}

}

\caption{\label{fig-contrastes-marginaux-a-la-moyenne}Contrastes
marginaux à la moyenne}

\end{figure}

\hypertarget{pentes-marginales-effets-marginaux}{%
\section{Pentes marginales / Effets
marginaux}\label{pentes-marginales-effets-marginaux}}

Les effets marginaux, ou plus précisément les pentes marginales, sont
similaires aux contrastes marginaux, avec un différence subtile. Pour
une variable continue, les contrastes marginaux sont une différence
entre deux prédictions tandis que les \textbf{effets marginaux}
(\emph{marginal effects}) ou \textbf{pentes marginales} (\emph{marginal
slopes}). Dis autrement, l'effect marginal d'un régresseur continu \(x\)
est la pente / dérivée \({\partial y}/{\partial x}\) la fonction de
prédiction \(y\), mesurée à des valeurs spécifiques de \(x\).

Les effets marginaux sont le plus souvent calculés selon l'échelle de
l'\emph{outcome} et représentent le changement attendu de
l'\emph{outcome} pour une augmentation du régresseur d'une unité.

Par définition, les effets marginaux ne sont pas définis pour les
variables catégorielles. La plupart des fonctions rapportent, à la
place, les contrastes marginaux pour ces variables catégorielles.

Comme pour les prédictions marginales et les contrastes marginaux,
plusieurs approches existent (voir par exemple la
\href{https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html}{vignette
dédiée} du package \texttt{\{marginaleffects\}}).

\hypertarget{pentes-marginales-moyennes-effets-marginaux-moyens}{%
\subsection{Pentes marginales moyennes / Effets marginaux
moyens}\label{pentes-marginales-moyennes-effets-marginaux-moyens}}

Les \textbf{effets marginaux moyens} (\emph{average marginal effects})
sont calculés en deux temps~: (1) un effet marginal est calculé pour
chaque individu observé dans le modèle~; (ii) puis la moyenne de ces
effets individuels est calculée.

On aura tout simplement recours à la fonction
\texttt{marginaleffects::avg\_slopes()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{avg\_slopes}\NormalTok{(mod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

        Term                             Contrast Estimate Std. Error     z
 etudes      Non documenté - Primaire               0.4309     0.0691  6.23
 etudes      Secondaire - Primaire                  0.1568     0.0314  4.99
 etudes      Supérieur - Primaire                   0.3701     0.0337 10.98
 etudes      Technique / Professionnel - Primaire   0.1781     0.0295  6.04
 groupe_ages 25-44 ans - 18-24 ans                 -0.0844     0.0492 -1.71
 groupe_ages 45-64 ans - 18-24 ans                 -0.2127     0.0507 -4.20
 groupe_ages 65 ans et plus - 18-24 ans            -0.2631     0.0556 -4.73
 heures.tv   dY/dX                                 -0.0227     0.0062 -3.66
 sexe        Homme - Femme                          0.0788     0.0197  4.00
 Pr(>|z|)   2.5 %  97.5 %
   <0.001  0.2954  0.5665
   <0.001  0.0952  0.2184
   <0.001  0.3040  0.4361
   <0.001  0.1203  0.2359
   0.0865 -0.1808  0.0121
   <0.001 -0.3121 -0.1133
   <0.001 -0.3720 -0.1541
   <0.001 -0.0348 -0.0105
   <0.001  0.0402  0.1175

Columns: term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high 
\end{verbatim}

Pour un usage avec \texttt{broom.helpers::tidy\_plus\_plus()},
\texttt{gtsummary::tbl\_regression()} ou
\texttt{ggstats::ggcoef\_model()}, on utilisera
\texttt{broom.helpers::tidy\_avg\_slopes()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_avg\_slopes,}
    \AttributeTok{estimate\_fun =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}
      \AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{,}
      \AttributeTok{style\_positive =} \StringTok{"plus"}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-effets-marginaux-moyens}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3776}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3061}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1735}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1429}}@{}}
\caption{\label{tbl-effets-marginaux-moyens}Effets marginaux
moyens}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Average Marginal Effects}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Average Marginal Effects}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
\textbf{Niveau d'études} & & & \\
Non documenté - Primaire & +43.1\% & +29.5\% -- +56.6\% &
\textless0,001 \\
Secondaire - Primaire & +15.7\% & +9.5\% -- +21.8\% & \textless0,001 \\
Supérieur - Primaire & +37.0\% & +30.4\% -- +43.6\% & \textless0,001 \\
Technique / Professionnel - Primaire & +17.8\% & +12.0\% -- +23.6\% &
\textless0,001 \\
\textbf{Groupe d'âges} & & & \\
25-44 ans - 18-24 ans & -8.4\% & -18.1\% -- +1.2\% & 0,086 \\
45-64 ans - 18-24 ans & -21.3\% & -31.2\% -- -11.3\% & \textless0,001 \\
65 ans et plus - 18-24 ans & -26.3\% & -37.2\% -- -15.4\% &
\textless0,001 \\
\textbf{Heures de télévision / jour} & & & \\
dY/dX & -2.3\% & -3.5\% -- -1.1\% & \textless0,001 \\
\textbf{Sexe} & & & \\
Homme - Femme & +7.9\% & +4.0\% -- +11.7\% & \textless0,001 \\
\bottomrule()
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(}
\NormalTok{  mod,}
  \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_avg\_slopes}
\NormalTok{) }\SpecialCharTok{+}
\NormalTok{  ggplot2}\SpecialCharTok{::}\FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}\AttributeTok{style\_positive =} \StringTok{"plus"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/estimations-marginales_files/figure-pdf/fig-effets-marginaux-moyens-1.pdf}

}

\caption{\label{fig-effets-marginaux-moyens}Effets marginaux moyens}

\end{figure}

Un résultat similaire peut être obtenu avec \texttt{margins::margins()},
le package \texttt{\{margins\}} s'inspirant de la commande
\textbf{Stata} \texttt{margins}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{margins}\SpecialCharTok{::}\FunctionTok{margins}\NormalTok{(mod) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{tidy}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 9 x 5
  term                            estimate std.error statistic  p.value
  <chr>                              <dbl>     <dbl>     <dbl>    <dbl>
1 etudesNon documenté               0.431    0.0691       6.23 4.60e-10
2 etudesSecondaire                  0.157    0.0314       4.99 6.10e- 7
3 etudesSupérieur                   0.370    0.0337      11.0  4.69e-28
4 etudesTechnique / Professionnel   0.178    0.0295       6.04 1.53e- 9
5 groupe_ages25-44 ans             -0.0844   0.0492      -1.71 8.65e- 2
6 groupe_ages45-64 ans             -0.213    0.0507      -4.20 2.73e- 5
7 groupe_ages65 ans et plus        -0.263    0.0556      -4.73 2.21e- 6
8 heures.tv                        -0.0227   0.00620     -3.66 2.56e- 4
9 sexeHomme                         0.0788   0.0197       4.00 6.26e- 5
\end{verbatim}

For \texttt{\{broom.helpers\}}, \texttt{\{gtsummary\}} or
\texttt{\{ggstats\}}, use \texttt{broom.helpers::tidy\_margins()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_margins,}
    \AttributeTok{estimate\_fun =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}
      \AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{,}
      \AttributeTok{style\_positive =} \StringTok{"plus"}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-effets-marginaux-moyens-margins}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3441}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.3226}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1828}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1505}}@{}}
\caption{\label{tbl-effets-marginaux-moyens-margins}Effets marginaux
moyens avec margins}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Average Marginal Effects}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Average Marginal Effects}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
\textbf{Niveau d'études} & & & \\
Primaire & --- & --- & \\
Non documenté & +43.1\% & +29.5\% -- +56.6\% & \textless0,001 \\
Secondaire & +15.7\% & +9.5\% -- +21.8\% & \textless0,001 \\
Supérieur & +37.0\% & +30.4\% -- +43.6\% & \textless0,001 \\
Technique / Professionnel & +17.8\% & +12.0\% -- +23.6\% &
\textless0,001 \\
\textbf{Groupe d'âges} & & & \\
18-24 ans & --- & --- & \\
25-44 ans & -8.4\% & -18.1\% -- +1.2\% & 0,086 \\
45-64 ans & -21.3\% & -31.2\% -- -11.3\% & \textless0,001 \\
65 ans et plus & -26.3\% & -37.2\% -- -15.4\% & \textless0,001 \\
\textbf{Heures de télévision / jour} & -2.3\% & -3.5\% -- -1.1\% &
\textless0,001 \\
\textbf{Sexe} & & & \\
Femme & --- & --- & \\
Homme & +7.9\% & +4.0\% -- +11.7\% & \textless0,001 \\
\bottomrule()
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(}
\NormalTok{  mod,}
  \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_margins}
\NormalTok{) }\SpecialCharTok{+}
\NormalTok{  ggplot2}\SpecialCharTok{::}\FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{(}\AttributeTok{style\_positive =} \StringTok{"plus"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/estimations-marginales_files/figure-pdf/fig-effets-marginaux-moyens-margins-1.pdf}

}

\caption{\label{fig-effets-marginaux-moyens-margins}Effets marginaux
moyens avec margins}

\end{figure}

\hypertarget{pentes-marginales-uxe0-la-moyenne-effets-marginaux-uxe0-la-moyenne}{%
\subsection{Pentes marginales à la moyenne / Effets marginaux à la
moyenne}\label{pentes-marginales-uxe0-la-moyenne-effets-marginaux-uxe0-la-moyenne}}

Pour les \textbf{effets marginaux à la moyenne} (\emph{marginal effect
at the mean}), simplement indiquer \texttt{newdata\ =\ "mean"} à
\texttt{broom.helpers::tidy\_marginaleffects()}.

\hypertarget{lectures-compluxe9menaires-en-anglais}{%
\section{Lectures complémenaires (en
anglais)}\label{lectures-compluxe9menaires-en-anglais}}

\begin{itemize}
\tightlist
\item
  \href{https://vincentarelbundock.github.io/marginaleffects/}{Documentation
  of the \texttt{marginaleffects} package} par Vincent Arel-Bundock
\item
  \href{https://www.andrewheiss.com/blog/2022/05/20/marginalia/}{Marginalia:
  A guide to figuring out what the heck marginal effects, marginal
  slopes, average marginal effects, marginal effects at the mean, and
  all these other marginal things are} par Andrew Heiss
\item
  \href{https://strengejacke.github.io/ggeffects/articles/introduction_marginal_effects.html}{Introduction
  to Adjusted Predictions and Marginal Effects in R} par Daniel Lüdecke
\item
  \href{https://cran.r-project.org/web/packages/margins/vignettes/Introduction.html}{An
  Introduction to \texttt{margins}}
\item
  \href{https://larmarange.github.io/broom.helpers/articles/marginal_tidiers.html}{Marginal
  effects / slopes, contrasts, means and predictions with broom.helpers}
\end{itemize}

\hypertarget{sec-contrastes}{%
\chapter{Contrastes (variables catégorielles)}\label{sec-contrastes}}

Dans les modèles de régression (comme les modèles linéaires, cf.
Chapitre~\ref{sec-regression-lineaire}, ou les modèles linéaires
généralisés comme la régression logistique binaire, cf.
Chapitre~\ref{sec-regression-logistique-binaire}), une transformation
des variables catégorielles est nécessaire pour qu'elles puissent être
prises en compte dans le modèle. On va dès lors définir des
\textbf{contrastes}.

De manière générale, une variable catégorielle à \emph{n} modalités va
être transformée en \emph{n-1} variables quantitatives. Il existe
cependant plusieurs manières de faire (i.e.~plusieurs types de
contrastes). Et, selon les contrastes choisis, les coefficients du
modèles ne s'interpréteront pas de la même manière.

\hypertarget{contrastes-de-type-traitement}{%
\section{Contrastes de type
traitement}\label{contrastes-de-type-traitement}}

Par défaut, \textbf{R} applique des contrastes de type traitement pour
un facteur non ordonné. Il s'agit notamment des contrastes utilisés par
défaut dans les chapitres précédents.

\hypertarget{exemple-1-un-moduxe8le-linuxe9aire-avec-une-variable-catuxe9gorielle}{%
\subsection{Exemple 1 : un modèle linéaire avec une variable
catégorielle}\label{exemple-1-un-moduxe8le-linuxe9aire-avec-une-variable-catuxe9gorielle}}

Commençons avec un premier exemple que nous allons calculer avec le jeu
de données \emph{trial} chargé en mémoire lorsque l'on appelle
l'extension \texttt{\{gtsummary\}}. Ce jeu de données contient les
observations de 200 patients. Nous nous intéressons à deux variables en
particulier : \emph{marker} une variable numérique correspondant à un
marqueur biologique et \emph{grade} un facteur à trois modalités
correspondant à différent groupes de patients.

Regardons la moyenne de \emph{marker} pour chaque valeur de
\emph{grade}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(gtsummary)}
\NormalTok{trial }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{select}\NormalTok{(marker, grade) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_summary}\NormalTok{(}
    \AttributeTok{by =}\NormalTok{ grade,}
    \AttributeTok{statistic =}\NormalTok{ marker }\SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\}"}\NormalTok{,}
    \AttributeTok{digits =}\NormalTok{ marker }\SpecialCharTok{\textasciitilde{}} \DecValTok{4}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{add\_overall}\NormalTok{(}\AttributeTok{last =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2308}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1648}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1758}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.1868}}
  >{\centering\arraybackslash}p{(\columnwidth - 8\tabcolsep) * \real{0.2418}}@{}}
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Characteristic}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{I}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{II}, N = 68
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{III}, N = 64
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Overall}, N = 200
\end{minipage} \\
\midrule()
\endhead
Marker Level (ng/mL) & 1.0669 & 0.6805 & 0.9958 & 0.9160 \\
Unknown & 2 & 5 & 3 & 10 \\
\bottomrule()
\end{longtable}

Utilisons maintenant une régression linaire pour modéliser la valeur de
\emph{marker} en fonction de \emph{grade}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod1\_trt }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(marker }\SpecialCharTok{\textasciitilde{}}\NormalTok{ grade, }\AttributeTok{data =}\NormalTok{ trial)}
\NormalTok{mod1\_trt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Call:
lm(formula = marker ~ grade, data = trial)

Coefficients:
(Intercept)      gradeII     gradeIII  
     1.0669      -0.3864      -0.0711  
\end{verbatim}

Le modèle obtenu contient trois coefficients ou termes : un intercept et
deux termes associés à la variable \emph{grade}.

Pour bien interpréter ces coefficients, il faut comprendre comment la
variable \emph{grade} a été transformée avant d'être inclue dans le
modèle. Nous pouvons voir cela avec la fonction \texttt{contrasts()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{contrasts}\NormalTok{(trial}\SpecialCharTok{$}\NormalTok{grade)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
    II III
I    0   0
II   1   0
III  0   1
\end{verbatim}

Ce que nous montre cette matrice, c'est que la variable catégorielle
\emph{grade} à 3 modalités a été transformée en 2 variables binaires que
l'on retrouve sous les noms de \emph{gradeII} et \emph{gradeIII} dans le
modèle : \emph{gradeII} vaut 1 si \emph{grade} est égal à \emph{II} et 0
sinon; \emph{gradeIII} vaut 1 si \emph{grade} est égal à \emph{III} et 0
sinon. Si \emph{grade} est égal à \emph{I}, alors \emph{gradeII} et
\emph{gradeIII} valent 0.

Il s'agit ici d'un contraste dit de traitement ou la première modalité
joue ici le rôle de \textbf{modalité de référence}.

Dans ce modèle linéaire, la valeur de l'intercept correspond à la
moyenne de \emph{marker} lorsque nous nous trouvons à la référence, donc
quand \emph{grade} est égal à \emph{I} dans cet exemple. Et nous pouvons
le constater dans notre tableau précédent des moyennes, \texttt{1.0669}
correspond bien à la moyenne de \emph{marker} pour la modalité \emph{I}.

La valeur du coefficient associé à \emph{markerII} correspond à l'écart
par rapport à la référence lorsque \emph{marker} est égal à \emph{II}.
Autrement dit, la moyenne de \emph{marker} pour la modalité \emph{II}
correspond à la somme de l'intercept et du coefficient \emph{markerII}.
Et nous retrouvons bien la relation suivante :
\texttt{0.6805\ =\ 1.0669\ +\ -0.3864}. De même, la moyenne de
\emph{marker} lorsque \emph{grade} vaut \emph{III} est égale à la somme
de l'intercept et du terme \emph{markerIII}.

Lorsqu'on utilise des contrastes de type traitement, chaque terme du
modèle peut être associé à une et une seule modalité d'origine de la
variable catégorielle. Dès lors, il est possible de rajouter la modalité
de référence lorsque l'on présente les résultats et on peut même lui
associer la valeurs 0, ce qui peut être fait avec
\texttt{gtsummary::tbl\_regression()} avec l'option
\texttt{add\_estimate\_to\_reference\_rows\ =\ TRUE}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod1\_trt }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{intercept =} \ConstantTok{TRUE}\NormalTok{, }
    \AttributeTok{add\_estimate\_to\_reference\_rows =} \ConstantTok{TRUE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}lccc@{}}
\toprule()
\textbf{Characteristic} & \textbf{Beta} & \textbf{95\% CI} &
\textbf{p-value} \\
\midrule()
\endhead
(Intercept) & 1.1 & 0.86, 1.3 & \textless0.001 \\
Grade & & & \\
I & 0.00 & --- & \\
II & -0.39 & -0.68, -0.09 & 0.010 \\
III & -0.07 & -0.37, 0.23 & 0.6 \\
\bottomrule()
\end{longtable}

\hypertarget{exemple-2-une-ruxe9gression-logistique-avec-deux-variables-catuxe9gorielles}{%
\subsection{Exemple 2 : une régression logistique avec deux variables
catégorielles}\label{exemple-2-une-ruxe9gression-logistique-avec-deux-variables-catuxe9gorielles}}

Pour ce deuxième exemple, nous allons utiliser le jeu de données
\emph{hdv2003} fourni par l'extension \texttt{\{questionr\}} et recoder
la variable \emph{age} en groupes d'âges à 4 modalités.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(questionr)}
\FunctionTok{data}\NormalTok{(}\StringTok{"hdv2003"}\NormalTok{)}

\FunctionTok{library}\NormalTok{(tidyverse)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hdv2003 }\OtherTok{\textless{}{-}}\NormalTok{ hdv2003 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{groupe\_ages =} \FunctionTok{cut}\NormalTok{(}
\NormalTok{      age, }
      \FunctionTok{c}\NormalTok{(}\DecValTok{16}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{45}\NormalTok{, }\DecValTok{65}\NormalTok{, }\DecValTok{99}\NormalTok{), }
      \AttributeTok{right =} \ConstantTok{FALSE}\NormalTok{, }
      \AttributeTok{include.lowest =} \ConstantTok{TRUE}
\NormalTok{    ) }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{fct\_recode}\NormalTok{(}
        \StringTok{"16{-}24"} \OtherTok{=} \StringTok{"[16,25)"}\NormalTok{,}
        \StringTok{"25{-}44"} \OtherTok{=} \StringTok{"[25,45)"}\NormalTok{,}
        \StringTok{"45{-}64"} \OtherTok{=} \StringTok{"[45,65)"}\NormalTok{,}
        \StringTok{"65+"} \OtherTok{=} \StringTok{"[65,99]"}
\NormalTok{      ) }
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}}
\NormalTok{  labelled}\SpecialCharTok{::}\FunctionTok{set\_variable\_labels}\NormalTok{(}
    \AttributeTok{groupe\_ages =} \StringTok{"Groupe d\textquotesingle{}âges"}\NormalTok{,}
    \AttributeTok{sexe =} \StringTok{"Sexe"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

Nous allons faire une régression logistique binaire pour investiguer
l'effet du \emph{sexe} (variable à 2 modalités) et du \emph{groupe
d'âges} (variable à 4 modalités) sur la pratique du \emph{sport}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2\_trt }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{+}\NormalTok{ groupe\_ages,}
  \AttributeTok{family =}\NormalTok{ binomial,}
  \AttributeTok{data =}\NormalTok{ hdv2003}
\NormalTok{)}
\NormalTok{mod2\_trt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Call:  glm(formula = sport ~ sexe + groupe_ages, family = binomial, 
    data = hdv2003)

Coefficients:
     (Intercept)         sexeFemme  groupe_ages25-44  groupe_ages45-64  
          0.9021           -0.4455           -0.6845           -1.6535  
  groupe_ages65+  
         -2.3198  

Degrees of Freedom: 1999 Total (i.e. Null);  1995 Residual
Null Deviance:      2617 
Residual Deviance: 2385     AIC: 2395
\end{verbatim}

Le modèle contient 5 termes : 1 intercept, 1 coefficient pour la
variable \emph{sexe} et 3 coefficients pour la variable
\emph{groupe\_ages}. Comme précédemment, nous pouvons constater que les
variables à \emph{n} modalités sont remplacées par défaut (contrastes de
type traitement) par \emph{n-1} variables binaires, la première modalité
jouant à chaque fois le rôle de modalité de référence.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{contrasts}\NormalTok{(hdv2003}\SpecialCharTok{$}\NormalTok{sexe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
      Femme
Homme     0
Femme     1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{contrasts}\NormalTok{(hdv2003}\SpecialCharTok{$}\NormalTok{groupe\_ages)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
      25-44 45-64 65+
16-24     0     0   0
25-44     1     0   0
45-64     0     1   0
65+       0     0   1
\end{verbatim}

L'intercept correspond donc à la situation à la référence, c'est-à-dire
à la prédiction du modèle pour les hommes (référence de \emph{sexe})
âgés de 16 à 24 ans (référence de \emph{groupe\_ages}).

Il est possible d'exprimer cela en termes de probabilité en utilisant
l'inverse de la fonction \emph{logit} (puisque nous avons utilisé un
modèle \emph{logit}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{inv\_logit }\OtherTok{\textless{}{-}} \FunctionTok{binomial}\NormalTok{(}\StringTok{"logit"}\NormalTok{)}\SpecialCharTok{$}\NormalTok{linkinv}
\FunctionTok{inv\_logit}\NormalTok{(}\FloatTok{0.9021}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.7113809
\end{verbatim}

Selon le modèle, les hommes âgés de 16 à 24 ans ont donc 71\% de chance
de pratiquer du sport.

Regardons maintenant le coefficient associé à \emph{sexeFemme} (-0.4455)
: il représente (pour la modalité de référence des autres variables,
soit pour les 16-24 ans ici) la correction à appliquer à l'intercept
pour obtenir la probabilité de faire du sport. Il s'agit donc de la
différence entre les femmes et les hommes pour le groupe des 16-24 ans.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{inv\_logit}\NormalTok{(}\FloatTok{0.9021} \SpecialCharTok{{-}} \FloatTok{0.4455}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.6122073
\end{verbatim}

Autrement dit, selon le modèle, la probabilité de faire du sport pour
une femme âgée de 16 à 24 ans est de 61\%. On peut représenter cela avec
la fonction \texttt{ggeffects::ggpredict()} de \texttt{\{ggeffects\}},
qui représente les prédictions d'une variable toutes les autres
variables étant à la référence.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggeffects)}
\FunctionTok{ggpredict}\NormalTok{(mod2\_trt, }\StringTok{"sexe"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} \FunctionTok{plot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/contrastes_files/figure-pdf/unnamed-chunk-11-1.pdf}

}

\end{figure}

Bien souvent, pour une régression logistique, on préfère représenter les
exponentielles des coefficients qui correspondent à des \emph{odds
ratios}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2\_trt }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{intercept =} \ConstantTok{TRUE}\NormalTok{, }
    \AttributeTok{add\_estimate\_to\_reference\_rows =} \ConstantTok{TRUE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}lccc@{}}
\toprule()
\textbf{Characteristic} & \textbf{OR} & \textbf{95\% CI} &
\textbf{p-value} \\
\midrule()
\endhead
(Intercept) & 2.46 & 1.76, 3.48 & \textless0.001 \\
Sexe & & & \\
Homme & 1.00 & --- & \\
Femme & 0.64 & 0.53, 0.78 & \textless0.001 \\
Groupe d'âges & & & \\
16-24 & 1.00 & --- & \\
25-44 & 0.50 & 0.35, 0.71 & \textless0.001 \\
45-64 & 0.19 & 0.13, 0.27 & \textless0.001 \\
65+ & 0.10 & 0.06, 0.15 & \textless0.001 \\
\bottomrule()
\end{longtable}

Or, 0,64 correspond bien à l'odds ratio entre 61\% et 71\% (que l'on
peut calculer avec \texttt{questionr::odds.ratio()}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{questionr}\SpecialCharTok{::}\FunctionTok{odds.ratio}\NormalTok{(}\FloatTok{0.6122}\NormalTok{, }\FloatTok{0.7114}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.6404246
\end{verbatim}

De la même manière, les différents coefficients associés à
\emph{groupe\_ages} correspondent à la différence entre chaque groupe
d'âges et sa modalité de référence (ici 16-24 ans), quand les autres
variables (ici le \emph{sexe}) sont à leur référence (ici les hommes).

Pour prédire la probabilité de faire du sport pour un profil
particulier, il faut prendre en compte toutes les termes qui
s'appliquent et qui s'ajoutent à l'intercept. Par exemple, pour une
femme de 50 ans il faut considérer l'intercept (0.9021), le coefficient
\emph{sexeFemme} (-0.4455) et le coefficient
\emph{groupe\_ages45}\textbf{-64} (-1.6535). Sa probabilité de faire du
sport est donc de 23\%.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{inv\_logit}\NormalTok{(}\FloatTok{0.9021} \SpecialCharTok{{-}} \FloatTok{0.4455} \SpecialCharTok{{-}} \FloatTok{1.6535}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.2320271
\end{verbatim}

\hypertarget{changer-la-modalituxe9-de-ruxe9fuxe9rence}{%
\subsection{Changer la modalité de
référence}\label{changer-la-modalituxe9-de-ruxe9fuxe9rence}}

Il est possible de personnaliser les contrastes à utiliser et avoir un
recours à un contraste de type traitement mais en utilisant une autre
modalité que la première comme référence, avec la fonction
\texttt{contr.treatment()}. Le premier argument de la fonction
corresponds au nombre de modalités de la variable et le paramètre
\texttt{base} permets de spécifier la modalité de référence (1 par
défaut).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{contr.treatment}\NormalTok{(}\DecValTok{4}\NormalTok{, }\AttributeTok{base =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  1 3 4
1 1 0 0
2 0 0 0
3 0 1 0
4 0 0 1
\end{verbatim}

\texttt{contr.SAS()} permets de spécifier un contraste de type
traitement dont la modalité de référence est la dernière.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{contr.SAS}\NormalTok{(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  1 2 3
1 1 0 0
2 0 1 0
3 0 0 1
4 0 0 0
\end{verbatim}

Les contrastes peuvent être modifiés de deux manières : au moment de la
construction du modèle (via l'option \texttt{contrasts}) ou comme
attribut des variables (via la fonction \texttt{contrasts()}).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{contrasts}\NormalTok{(hdv2003}\SpecialCharTok{$}\NormalTok{sexe) }\OtherTok{\textless{}{-}} \FunctionTok{contr.SAS}\NormalTok{(}\DecValTok{2}\NormalTok{)}
\NormalTok{mod2\_trt\_bis }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{+}\NormalTok{ groupe\_ages, }
  \AttributeTok{family =}\NormalTok{ binomial, }
  \AttributeTok{data =}\NormalTok{ hdv2003,}
  \AttributeTok{contrasts =} \FunctionTok{list}\NormalTok{(}\AttributeTok{groupe\_ages =} \FunctionTok{contr.treatment}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{))}
\NormalTok{)}
\NormalTok{mod2\_trt\_bis }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{intercept =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}lccc@{}}
\toprule()
\textbf{Characteristic} & \textbf{OR} & \textbf{95\% CI} &
\textbf{p-value} \\
\midrule()
\endhead
(Intercept) & 0.30 & 0.25, 0.36 & \textless0.001 \\
Sexe & & & \\
Homme & 1.56 & 1.29, 1.90 & \textless0.001 \\
Femme & --- & --- & \\
Groupe d'âges & & & \\
16-24 & 5.23 & 3.67, 7.52 & \textless0.001 \\
25-44 & 2.64 & 2.12, 3.29 & \textless0.001 \\
45-64 & --- & --- & \\
65+ & 0.51 & 0.37, 0.70 & \textless0.001 \\
\bottomrule()
\end{longtable}

Comme les modalités de référence ont changé, l'intercept et les
différents termes ont également changé (puisque l'on ne compare plus à
la même référence).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_compare}\NormalTok{(}
  \FunctionTok{list}\NormalTok{(mod2\_trt, mod2\_trt\_bis),}
  \AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{type =} \StringTok{"faceted"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/contrastes_files/figure-pdf/unnamed-chunk-18-1.pdf}

}

\end{figure}

Cependant, du point de vue explicatif et prédictif, les deux modèles
sont rigoureusement identiques.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(mod2\_trt, mod2\_trt\_bis, }\AttributeTok{test =} \StringTok{"Chisq"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Analysis of Deviance Table

Model 1: sport ~ sexe + groupe_ages
Model 2: sport ~ sexe + groupe_ages
  Resid. Df Resid. Dev Df Deviance Pr(>Chi)
1      1995     2385.2                     
2      1995     2385.2  0        0         
\end{verbatim}

De même, leurs prédictions marginales (cf.
Chapitre~\ref{sec-estimations-marginales}) sont identiques.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_compare}\NormalTok{(}
  \FunctionTok{list}\NormalTok{(mod2\_trt, mod2\_trt\_bis),}
  \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_marginal\_predictions,}
  \AttributeTok{type =} \StringTok{"dodge"}\NormalTok{,}
  \AttributeTok{vline =} \ConstantTok{FALSE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/contrastes_files/figure-pdf/unnamed-chunk-20-1.pdf}

}

\end{figure}

\hypertarget{contrastes-de-type-somme}{%
\section{Contrastes de type somme}\label{contrastes-de-type-somme}}

Nous l'avons vu, les contrastes de type traitement nécessitent de
définir une modalité de référence et toutes les autres modalités seront
comparées à cette modalité de référence. Une alternative consiste à
comparer toutes les modalités à la grande moyenne, ce qui s'obtient avec
un contraste de type somme que l'on obtient avec \texttt{contr.sum()}.

\hypertarget{exemple-1-un-moduxe8le-linuxe9aire-avec-une-variable-catuxe9gorielle-1}{%
\subsection{Exemple 1 : un modèle linéaire avec une variable
catégorielle}\label{exemple-1-un-moduxe8le-linuxe9aire-avec-une-variable-catuxe9gorielle-1}}

Reprenons notre premier exemple de tout à l'heure et modifions seulement
le contraste.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{contrasts}\NormalTok{(trial}\SpecialCharTok{$}\NormalTok{grade) }\OtherTok{\textless{}{-}}\NormalTok{ contr.sum}
\NormalTok{mod1\_sum }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(}
\NormalTok{  marker }\SpecialCharTok{\textasciitilde{}}\NormalTok{ grade,}
  \AttributeTok{data =}\NormalTok{ trial}
\NormalTok{)}
\NormalTok{mod1\_sum}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Call:
lm(formula = marker ~ grade, data = trial)

Coefficients:
(Intercept)       grade1       grade2  
     0.9144       0.1525      -0.2339  
\end{verbatim}

L'\emph{intercept} correspond à ce qu'on appelle parfois la grande
moyenne (ou \emph{great average} en anglais). Il ne s'agit pas de la
moyenne observée de \emph{marker} mais de la moyenne des moyennes de
chaque sous-groupe. Cela va constituer la situation de référence de
notre modèle, en quelque sorte indépendante des effets de la variable
\emph{grade}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mean}\NormalTok{(trial}\SpecialCharTok{$}\NormalTok{marker, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.9159895
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{moy\_groupe }\OtherTok{\textless{}{-}}
\NormalTok{  trial }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(grade) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(}\AttributeTok{moyenne\_marker =} \FunctionTok{mean}\NormalTok{(marker, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{))}
\NormalTok{moy\_groupe}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 3 x 2
  grade moyenne_marker
  <fct>          <dbl>
1 I              1.07 
2 II             0.681
3 III            0.996
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mean}\NormalTok{(moy\_groupe}\SpecialCharTok{$}\NormalTok{moyenne\_marker)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.9144384
\end{verbatim}

Le terme \emph{grade1} correspond quant à lui au modificateur associé à
la première modalité de la variable \emph{grade} à savoir \emph{I}.
C'est l'écart, pour cette modalité, à la grande moyenne~:
\texttt{1.0669\ -\ 0.9144\ =\ 0.1525}.

De même, le terme \emph{grade2} correspond à l'écart pour la modalité
\emph{II} par rapport à la grande moyenne~:
\texttt{0.6805\ -\ 0.9144\ =\ -0.2339}.

Qu'en est-il de l'écart à la grande moyenne pour la modalité
\emph{III}~? Pour cela, voyons tout d'abord comment la variable
\emph{grade} a été codée~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{contrasts}\NormalTok{(trial}\SpecialCharTok{$}\NormalTok{grade)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
    [,1] [,2]
I      1    0
II     0    1
III   -1   -1
\end{verbatim}

Comme précédemment, cette variable à trois modalités a été codée avec
deux termes. Les deux premiers termes correspondent aux écarts à la
grande moyenne des deux premières modalités. La troisième modalité est,
quant à elle, codée systématiquement \texttt{-1}. C'est ce qui assure
que la somme des contributions soit nulle et donc que l'\emph{intercept}
capture la grande moyenne.

L'écart à la grande moyenne pour la troisième modalité s'obtient donc en
faisant la somme des autres termes et en l'inversant~:
\texttt{(0.1525\ -\ 0.2339)\ *\ -1\ =\ 0.0814\ =\ 0.9958\ -\ 0.9144}.

On peut calculer / afficher la valeur associée à la dernière modalité en
précisant \texttt{add\_estimate\_to\_reference\_rows\ =\ TRUE} lorsque
l'on appelle \texttt{gtsummary::tbl\_regression()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod1\_sum }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{intercept =} \ConstantTok{TRUE}\NormalTok{, }
    \AttributeTok{add\_estimate\_to\_reference\_rows =} \ConstantTok{TRUE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}lccc@{}}
\toprule()
\textbf{Characteristic} & \textbf{Beta} & \textbf{95\% CI} &
\textbf{p-value} \\
\midrule()
\endhead
(Intercept) & 0.91 & 0.79, 1.0 & \textless0.001 \\
Grade & & & \\
I & 0.15 & -0.02, 0.32 & 0.078 \\
II & -0.23 & -0.41, -0.06 & 0.008 \\
III & 0.08 & -0.13, 0.29 & 0.4 \\
\bottomrule()
\end{longtable}

De même, cette valeur est correctement affichée par
\texttt{ggstats::ggcoef\_model()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(mod1\_sum)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/contrastes_files/figure-pdf/unnamed-chunk-25-1.pdf}

}

\end{figure}

Le fait d'utiliser des contrastes de type traitement ou somme n'a aucun
impact sur la valeur prédictive du modèle. La quantité de variance
expliquée, la somme des résidus ou encore l'AIC sont identiques. En un
sens, il s'agit du même modèle. C'est seulement la manière d'interpréter
les coefficients du modèle qui change.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(mod1\_trt, mod1\_sum, }\AttributeTok{test =} \StringTok{"Chisq"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Analysis of Variance Table

Model 1: marker ~ grade
Model 2: marker ~ grade
  Res.Df    RSS Df Sum of Sq Pr(>Chi)
1    187 134.17                      
2    187 134.17  0         0         
\end{verbatim}

\hypertarget{exemple-2-une-ruxe9gression-logistique-avec-deux-variables-catuxe9gorielles-1}{%
\subsection{Exemple 2 : une régression logistique avec deux variables
catégorielles}\label{exemple-2-une-ruxe9gression-logistique-avec-deux-variables-catuxe9gorielles-1}}

Reprenons notre second exemple et codons les variables catégorielles
avec un traitement de type somme.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2\_sum }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{+}\NormalTok{ groupe\_ages,}
  \AttributeTok{family =}\NormalTok{ binomial,}
  \AttributeTok{data =}\NormalTok{ hdv2003,}
  \AttributeTok{contrasts =} \FunctionTok{list}\NormalTok{(}\AttributeTok{sexe =}\NormalTok{ contr.sum, }\AttributeTok{groupe\_ages =}\NormalTok{ contr.sum)}
\NormalTok{)}
\NormalTok{mod2\_sum }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{tbl\_regression}\NormalTok{(}
    \AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{intercept =} \ConstantTok{TRUE}\NormalTok{, }
    \AttributeTok{add\_estimate\_to\_reference\_rows =} \ConstantTok{TRUE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}lccc@{}}
\toprule()
\textbf{Characteristic} & \textbf{OR} & \textbf{95\% CI} &
\textbf{p-value} \\
\midrule()
\endhead
(Intercept) & 0.62 & 0.55, 0.69 & \textless0.001 \\
Sexe & & & \\
Homme & 1.25 & 1.13, 1.38 & \textless0.001 \\
Femme & 0.80 & 0.72, 0.89 & \textless0.001 \\
Groupe d'âges & & & \\
16-24 & 3.20 & 2.49, 4.15 & \textless0.001 \\
25-44 & 1.62 & 1.38, 1.89 & \textless0.001 \\
45-64 & 0.61 & 0.52, 0.72 & \textless0.001 \\
65+ & 0.31 & 0.24, 0.42 & \textless0.001 \\
\bottomrule()
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(mod2\_sum, }\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/contrastes_files/figure-pdf/unnamed-chunk-28-1.pdf}

}

\end{figure}

Cette fois-ci, l'\emph{intercept} capture la situation à la grande
moyenne à la fois du sexe et du groupe d'âges, et les coefficients
s'interprètent donc comme modificateurs de chaque modalité par rapport à
cette grande moyenne. En ce sens, les contrastes de type somme
permettent donc de capturer l'effet de chaque modalité.

Du point de vue explicatif et prédictif, le fait d'avoir recours à des
contrastes de type somme ou traitement n'a aucun impact~: les deux
modèles sont rigoureusement identiques. Il n'y a que la manière
d'interpréter les coeffcients qui chagnge.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(mod2\_trt, mod2\_sum, }\AttributeTok{test =} \StringTok{"Chisq"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Analysis of Deviance Table

Model 1: sport ~ sexe + groupe_ages
Model 2: sport ~ sexe + groupe_ages
  Resid. Df Resid. Dev Df Deviance Pr(>Chi)
1      1995     2385.2                     
2      1995     2385.2  0        0         
\end{verbatim}

Les prédictions marginales (cf.
Chapitre~\ref{sec-estimations-marginales}) sont identiques.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_compare}\NormalTok{(}
  \FunctionTok{list}\NormalTok{(mod2\_trt, mod2\_sum),}
  \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_marginal\_predictions,}
  \AttributeTok{type =} \StringTok{"dodge"}\NormalTok{,}
  \AttributeTok{vline =} \ConstantTok{FALSE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/contrastes_files/figure-pdf/unnamed-chunk-30-1.pdf}

}

\end{figure}

\hypertarget{autres-types-de-contrastes}{%
\section{Autres types de contrastes}\label{autres-types-de-contrastes}}

\hypertarget{contrastes-de-type-helmert}{%
\subsection{Contrastes de type
Helmert}\label{contrastes-de-type-helmert}}

Les contrastes de Helmert sont un peu plus complexes~: ils visent à
comparer la seconde modalité à la première, la troisième à la moyenne
des deux premières, la quatrième à la moyenne des trois premières, etc.

Prenon un exemple avec une variable catégorielle à quatre modalités.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{contrasts}\NormalTok{(trial}\SpecialCharTok{$}\NormalTok{stage) }\OtherTok{\textless{}{-}}\NormalTok{ contr.helmert}
\FunctionTok{contrasts}\NormalTok{(trial}\SpecialCharTok{$}\NormalTok{stage)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
   [,1] [,2] [,3]
T1   -1   -1   -1
T2    1   -1   -1
T3    0    2   -1
T4    0    0    3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod\_helmert }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(}
\NormalTok{  marker }\SpecialCharTok{\textasciitilde{}}\NormalTok{ stage,}
  \AttributeTok{data =}\NormalTok{ trial}
\NormalTok{)}
\NormalTok{mod\_helmert}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Call:
lm(formula = marker ~ stage, data = trial)

Coefficients:
(Intercept)       stage1       stage2       stage3  
    0.91661      0.19956      0.03294     -0.02085  
\end{verbatim}

Pour bien comprendre comment interpréter ces coefficients, calculons
déjà la grande moyenne.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m }\OtherTok{\textless{}{-}}\NormalTok{ trial }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(stage) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(}\AttributeTok{moy =} \FunctionTok{mean}\NormalTok{(marker, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{))}
\FunctionTok{mean}\NormalTok{(m}\SpecialCharTok{$}\NormalTok{moy)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 0.9166073
\end{verbatim}

On le voit, l'\emph{intercept} (\texttt{0.9166}) capture ici cette
grande moyenne, à savoir la moyenne des moyennes de chaque sous-groupe.

Maintenant, pour interpréter les coefficients, regardons comment évolue
la moyenne à chaque fois que l'on ajoute une modalité. La fonction
\texttt{dplyr::cummean()} nous permet de calculer la moyenne cumulée,
c'est-à-dire la moyenne de la valeur actuelle et des valeurs des lignes
précédentes. Avec \texttt{dplyr::lag()} nous pouvons obtenir la moyenne
cumulée de la ligne précédente. Il nous est alors possible de calculer
l'écart entre les deux, et donc de voir comment la moyenne a changé avec
l'ajout d'une modalité.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m }\OtherTok{\textless{}{-}}\NormalTok{ m }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{moy\_cum =}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{cummean}\NormalTok{(moy),}
    \AttributeTok{moy\_cum\_prec =}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{lag}\NormalTok{(moy\_cum),}
    \AttributeTok{ecart =}\NormalTok{ moy\_cum }\SpecialCharTok{{-}}\NormalTok{ moy\_cum\_prec}
\NormalTok{  )}
\NormalTok{m}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 4 x 5
  stage   moy moy_cum moy_cum_prec   ecart
  <fct> <dbl>   <dbl>        <dbl>   <dbl>
1 T1    0.705   0.705       NA     NA     
2 T2    1.10    0.905        0.705  0.200 
3 T3    1.00    0.937        0.905  0.0329
4 T4    0.854   0.917        0.937 -0.0208
\end{verbatim}

On le voit, les valeurs de la colonne \emph{ecart} correspondent aux
coefficients du modèle.

Le premier terme \emph{stage1} compare la deuxième modalité (\emph{T2})
à la première (\emph{T1}) et indique l'écart entre la moyenne des
moyennes de \emph{T1} et \emph{T2} et la moyenne de \emph{T1}.

Le second terme \emph{stage2} compare la troisième modalité (\emph{T3})
aux deux premières (\emph{T1} et \emph{T2}) et indique l'écart entre la
moyenne des moyennes de \emph{T1}, \emph{T2} et \emph{T3} par rapport à
la moyenne des moyennes de \emph{T1} et \emph{T2}.

Le troisième terme \emph{stage3} compare la quatrième modalité
(\emph{T4}) aux trois premières (\emph{T1,} \emph{T2} et \emph{T3}) et
indique l'écart entre la moyenne des moyennes de \emph{T1}, \emph{T2},
\emph{T3} et \emph{T4} par rapport à la moyenne des moyennes de
\emph{T1}, \emph{T2} et \emph{T3}.

Les contrastes de Helmert sont ainsi un peu plus complexes à interpréter
et à réserver à des cas particuliers où ils prennent tout leur sens.

\hypertarget{contrastes-polynomiaux}{%
\subsection{Contrastes polynomiaux}\label{contrastes-polynomiaux}}

Les contrastes polynomiaux, définis avec \texttt{contr.poly()}, sont
utilisés par défaut pour les variables catégorielles ordonnées. Ils
permettent de décomposer les effets selon une composante linéaire, une
composante quadratique, une composante cubique, voire des composantes de
degrés supérieurs.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{contrasts}\NormalTok{(trial}\SpecialCharTok{$}\NormalTok{stage) }\OtherTok{\textless{}{-}}\NormalTok{ contr.poly}
\FunctionTok{contrasts}\NormalTok{(trial}\SpecialCharTok{$}\NormalTok{stage)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
           .L   .Q         .C
T1 -0.6708204  0.5 -0.2236068
T2 -0.2236068 -0.5  0.6708204
T3  0.2236068 -0.5 -0.6708204
T4  0.6708204  0.5  0.2236068
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod\_poly }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(}
\NormalTok{  marker }\SpecialCharTok{\textasciitilde{}}\NormalTok{ stage,}
  \AttributeTok{data =}\NormalTok{ trial}
\NormalTok{)}
\NormalTok{mod\_poly}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Call:
lm(formula = marker ~ stage, data = trial)

Coefficients:
(Intercept)      stage.L      stage.Q      stage.C  
    0.91661      0.07749     -0.27419      0.10092  
\end{verbatim}

Ici aussi, l'\emph{intercept} correspond à la grande moyenne des
moyennes. Il est par contre plus difficile de donner un sens
interprétatif / sociologique aux différents coefficients.

\hypertarget{lectures-additionnelles}{%
\section{Lectures additionnelles}\label{lectures-additionnelles}}

\begin{itemize}
\tightlist
\item
  \href{https://rstudio-pubs-static.s3.amazonaws.com/65059_586f394d8eb84f84b1baaf56ffb6b47f.html}{\emph{A
  (sort of) Complete Guide to Contrasts in R}} par Rose Maier
\item
  \href{https://rstudio-pubs-static.s3.amazonaws.com/84177_4604ecc1bae246c9926865db53b6cc29.html}{\emph{An
  introductory explanation of contrast coding in R linear models}} par
  Athanassios Protopapas
\item
  \href{https://rpubs.com/monajhzhu/608609}{\emph{Understanding Sum
  Contrasts for Regression Models: A Demonstration}} par Mona Zhu
\end{itemize}

\hypertarget{sec-interactions}{%
\chapter{Interactions}\label{sec-interactions}}

Dans un modèle statistique classique, on fait l'hypothèse implicite que
chaque variable explicative est indépendante des autres. Cependant, cela
ne se vérifie pas toujours. Par exemple, l'effet de l'âge peut varier en
fonction du sexe.

Nous pourrons dès lors ajouter à notre modèle des \textbf{interactions}
entre variables.

\hypertarget{donnuxe9es-dillustration-1}{%
\section{Données d'illustration}\label{donnuxe9es-dillustration-1}}

Reprenons le modèle que nous avons utilisé dans le chapitre sur la
régression logistique binaire (cf.
Chapitre~\ref{sec-regression-logistique-binaire}).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(labelled)}

\FunctionTok{data}\NormalTok{(hdv2003, }\AttributeTok{package =} \StringTok{"questionr"}\NormalTok{)}

\NormalTok{d }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{sexe =}\NormalTok{ sexe }\SpecialCharTok{|\textgreater{}} \FunctionTok{fct\_relevel}\NormalTok{(}\StringTok{"Femme"}\NormalTok{),}
    \AttributeTok{groupe\_ages =}\NormalTok{ age }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{cut}\NormalTok{(}
        \FunctionTok{c}\NormalTok{(}\DecValTok{18}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{45}\NormalTok{, }\DecValTok{65}\NormalTok{, }\DecValTok{99}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}\NormalTok{,}
        \AttributeTok{include.lowest =} \ConstantTok{TRUE}\NormalTok{,}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"18{-}24 ans"}\NormalTok{, }\StringTok{"25{-}44 ans"}\NormalTok{,}
                   \StringTok{"45{-}64 ans"}\NormalTok{, }\StringTok{"65 ans et plus"}\NormalTok{)}
\NormalTok{      ),}
    \AttributeTok{etudes =}\NormalTok{ nivetud }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{fct\_recode}\NormalTok{(}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"N\textquotesingle{}a jamais fait d\textquotesingle{}etudes"}\NormalTok{,}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"A arrete ses etudes, avant la derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"Derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
        \StringTok{"Secondaire"} \OtherTok{=} \StringTok{"1er cycle"}\NormalTok{,}
        \StringTok{"Secondaire"} \OtherTok{=} \StringTok{"2eme cycle"}\NormalTok{,}
        \StringTok{"Technique / Professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel court"}\NormalTok{,}
        \StringTok{"Technique / Professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel long"}\NormalTok{,}
        \StringTok{"Supérieur"} \OtherTok{=} \StringTok{"Enseignement superieur y compris technique superieur"}
\NormalTok{    ) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{fct\_na\_value\_to\_level}\NormalTok{(}\StringTok{"Non documenté"}\NormalTok{)  }
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{set\_variable\_labels}\NormalTok{(}
    \AttributeTok{sport =} \StringTok{"Pratique un sport ?"}\NormalTok{,}
    \AttributeTok{sexe =} \StringTok{"Sexe"}\NormalTok{,}
    \AttributeTok{groupe\_ages =} \StringTok{"Groupe d\textquotesingle{}âges"}\NormalTok{,}
    \AttributeTok{etudes =} \StringTok{"Niveau d\textquotesingle{}études"}\NormalTok{,}
    \AttributeTok{heures.tv =} \StringTok{"Heures de télévision / jour"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{moduxe8le-sans-interaction}{%
\section{Modèle sans interaction}\label{moduxe8le-sans-interaction}}

Nous avions alors exploré les facteurs associés au fait de pratiquer du
sport.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{+}\NormalTok{ groupe\_ages }\SpecialCharTok{+}\NormalTok{ etudes }\SpecialCharTok{+}\NormalTok{ heures.tv,}
  \AttributeTok{family =}\NormalTok{ binomial,}
  \AttributeTok{data =}\NormalTok{ d}
\NormalTok{)}
\FunctionTok{library}\NormalTok{(gtsummary)}
\FunctionTok{theme\_gtsummary\_language}\NormalTok{(}
  \StringTok{"fr"}\NormalTok{,}
  \AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{,}
  \AttributeTok{big.mark =} \StringTok{" "}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-or-modele-simple}{}
\begin{longtable}[]{@{}lccc@{}}
\caption{\label{tbl-or-modele-simple}Odds Ratios du modèle logistique
simple}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{OR} & \textbf{95\% IC} &
\textbf{p-valeur} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{OR} & \textbf{95\% IC} &
\textbf{p-valeur} \\
\midrule()
\endhead
\textbf{Sexe} & & & \\
Femme & --- & --- & \\
Homme & 1,52 & 1,24 -- 1,87 & \textless0,001 \\
\textbf{Groupe d'âges} & & & \\
18-24 ans & --- & --- & \\
25-44 ans & 0,68 & 0,43 -- 1,06 & 0,084 \\
45-64 ans & 0,36 & 0,23 -- 0,57 & \textless0,001 \\
65 ans et plus & 0,27 & 0,16 -- 0,46 & \textless0,001 \\
\textbf{Niveau d'études} & & & \\
Primaire & --- & --- & \\
Secondaire & 2,54 & 1,73 -- 3,75 & \textless0,001 \\
Technique / Professionnel & 2,81 & 1,95 -- 4,10 & \textless0,001 \\
Supérieur & 6,55 & 4,50 -- 9,66 & \textless0,001 \\
Non documenté & 8,54 & 4,51 -- 16,5 & \textless0,001 \\
\textbf{Heures de télévision / jour} & 0,89 & 0,83 -- 0,95 &
\textless0,001 \\
\bottomrule()
\end{longtable}

Selon les résultats de notre modèle, les hommes pratiquent plus un sport
que les femmes et la pratique du sport diminue avec l'âge.

Dans le chapitre sur les estimations marginales, cf.
Chapitre~\ref{sec-estimations-marginales}, nous avons présenté la
fonction \texttt{broom.helpers::plot\_marginal\_predictions()} qui
permet de représenter les prédictions marginales moyennes du modèle.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  broom.helpers}\SpecialCharTok{::}\FunctionTok{plot\_marginal\_predictions}\NormalTok{(}\AttributeTok{type =} \StringTok{"response"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  patchwork}\SpecialCharTok{::}\FunctionTok{wrap\_plots}\NormalTok{() }\SpecialCharTok{\&}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, .}\DecValTok{8}\NormalTok{),}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{()}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/interactions_files/figure-pdf/fig-predictions-modele-simple-1.pdf}

}

\caption{\label{fig-predictions-modele-simple}Prédictions marginales
moyennes du modèle simple}

\end{figure}

\hypertarget{duxe9finition-dune-interaction}{%
\section{Définition d'une
interaction}\label{duxe9finition-dune-interaction}}

Cependant, l'effet de l'âge est-il le même selon le sexe~? Nous allons
donc introduire une interaction entre l'âge et le sexe dans notre
modèle, ce qui sera représenté par \texttt{sexe\ *\ groupe\_ages}dans
l'équation du modèle.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{*}\NormalTok{ groupe\_ages }\SpecialCharTok{+}\NormalTok{ etudes }\SpecialCharTok{+}\NormalTok{ heures.tv,}
  \AttributeTok{family =}\NormalTok{ binomial,}
  \AttributeTok{data =}\NormalTok{ d}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Commençons par regarder les prédictions marginales du modèle avec
interaction.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2 }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  broom.helpers}\SpecialCharTok{::}\FunctionTok{plot\_marginal\_predictions}\NormalTok{(}\AttributeTok{type =} \StringTok{"response"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  patchwork}\SpecialCharTok{::}\FunctionTok{wrap\_plots}\NormalTok{(}\AttributeTok{ncol =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\&}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{()}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/interactions_files/figure-pdf/fig-predictions-modele-interaction-1.pdf}

}

\caption{\label{fig-predictions-modele-interaction}Prédictions
marginales moyennes du modèle avec interaction}

\end{figure}

Sur ce graphique, on voit que la pratique d'un sport diminue fortement
avec l'âge chez les hommes, tandis que cette diminution est bien plus
modérée chez les femmes.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Par défaut, \texttt{broom.helpers::plot\_marginal\_predictions()}
détecte la présence d'interactions dans le modèle et calcule les
prédictions marginales pour chaque combinaison de variables incluent
dans une interaction. Il reste possible de calculer des prédictions
marginales individuellement pour chaque variable du modèle. Pour cela,
il suffit d'indiquer \texttt{variables\_list\ =\ "no\_interaction"}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2 }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  broom.helpers}\SpecialCharTok{::}\FunctionTok{plot\_marginal\_predictions}\NormalTok{(}
    \AttributeTok{variables\_list =} \StringTok{"no\_interaction"}\NormalTok{,}
    \AttributeTok{type =} \StringTok{"response"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  patchwork}\SpecialCharTok{::}\FunctionTok{wrap\_plots}\NormalTok{() }\SpecialCharTok{\&}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{()}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/interactions_files/figure-pdf/unnamed-chunk-7-1.pdf}

}

\end{figure}

\end{tcolorbox}

\hypertarget{significativituxe9-de-linteraction}{%
\section{Significativité de
l'interaction}\label{significativituxe9-de-linteraction}}

L'ajout d'une interaction au modèle augmente la capacité prédictive du
modèle mais, dans le même temps, augmente le nombre de coefficients (et
donc de degrés de liberté). La question se pose donc de savoir si
l'ajout d'un terme d'interaction améliore notre modèle.

En premier lieu, nous pouvons comparer les AIC des modèles avec et sans
interaction.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{AIC}\NormalTok{(mod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2230.404
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{AIC}\NormalTok{(mod2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2223.382
\end{verbatim}

L'AIC du modèle avec interaction est plus faible que celui sans
interaction, nous indiquant un gain~: notre modèle avec interaction est
donc meilleur.

On peut tester avec \texttt{car::Anova()} si l'interaction est
statistiquement significative\sidenote{\footnotesize Lorsqu'il y a une interaction, il
  est préférable d'utiliser le type III, cf.
  Section~\ref{sec-reg-log-anova}. En toute rigueur, il serait
  préférable de coder nos variables catégorielles avec un contraste de
  type somme (cf. Chapitre~\ref{sec-contrastes}). En pratique, nous
  pouvons nous en passer ici.}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{car}\SpecialCharTok{::}\FunctionTok{Anova}\NormalTok{(mod2, }\AttributeTok{type =} \StringTok{"III"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Analysis of Deviance Table (Type III tests)

Response: sport
                 LR Chisq Df Pr(>Chisq)    
sexe               19.349  1  1.089e-05 ***
groupe_ages        15.125  3  0.0017131 ** 
etudes            125.575  4  < 2.2e-16 ***
heures.tv          12.847  1  0.0003381 ***
sexe:groupe_ages   13.023  3  0.0045881 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

La p-valeur associée au terme d'interaction (\texttt{sexe:groupe\_ages})
est inférieure à 1\%~: l'interaction a donc bien un effet significatif.

Nous pouvons également utiliser \texttt{gtsummary::add\_global\_p()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_global\_p}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-or-modele-interaction}{}
\begin{longtable}[]{@{}lccc@{}}
\caption{\label{tbl-or-modele-interaction}Odds Ratios du modèle
logistique avec interaction}\tabularnewline
\toprule()
\textbf{Caractéristique} & \textbf{OR} & \textbf{95\% IC} &
\textbf{p-valeur} \\
\midrule()
\endfirsthead
\toprule()
\textbf{Caractéristique} & \textbf{OR} & \textbf{95\% IC} &
\textbf{p-valeur} \\
\midrule()
\endhead
\textbf{Sexe} & & & \textless0,001 \\
Femme & --- & --- & \\
Homme & 5,10 & 2,41 -- 11,4 & \\
\textbf{Groupe d'âges} & & & 0,002 \\
18-24 ans & --- & --- & \\
25-44 ans & 1,06 & 0,61 -- 1,85 & \\
45-64 ans & 0,64 & 0,36 -- 1,15 & \\
65 ans et plus & 0,49 & 0,25 -- 0,97 & \\
\textbf{Niveau d'études} & & & \textless0,001 \\
Primaire & --- & --- & \\
Secondaire & 2,55 & 1,74 -- 3,78 & \\
Technique / Professionnel & 2,84 & 1,97 -- 4,14 & \\
Supérieur & 6,69 & 4,60 -- 9,89 & \\
Non documenté & 8,94 & 4,64 -- 17,6 & \\
\textbf{Heures de télévision / jour} & 0,89 & 0,83 -- 0,95 &
\textless0,001 \\
\textbf{Sexe * Groupe d'âges} & & & 0,005 \\
Homme * 25-44 ans & 0,31 & 0,13 -- 0,70 & \\
Homme * 45-64 ans & 0,24 & 0,10 -- 0,54 & \\
Homme * 65 ans et plus & 0,23 & 0,09 -- 0,60 & \\
\bottomrule()
\end{longtable}

\hypertarget{interpruxe9tation-des-coefficients}{%
\section{Interprétation des
coefficients}\label{interpruxe9tation-des-coefficients}}

Jetons maintenant un œil aux coefficients du modèle. Pour rendre les
choses plus visuelles, nous aurons recours à
\texttt{ggtstats::ggcoef\_model()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2 }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/interactions_files/figure-pdf/fig-coefficients-modele-interaction-1.pdf}

}

\caption{\label{fig-coefficients-modele-interaction}Coefficients (odds
ratio) du modèle avec interaction}

\end{figure}

Concernant les variables \emph{sexe} et \emph{groupe\_ages}, nous avons
trois séries de coefficients~: une série pour le sexe, une pour le
groupe d'âges et enfin des coefficients pour l'interaction entre le sexe
et le groupe d'âges.

Pour bien interpréter ces coefficients, il faut toujours avoir en tête
les modalités choisies comme référence pour chaque variable.

Supposons une femme de 60 ans, dont toutes les autres variables
correspondent aux modalités de référence (i.e.~de niveau primaire, qui
ne regarde pas la télévision). Regardons ce que prédit le modèle quant à
sa probabilité de faire du sport au travers d'une représentation
graphique, grâce au package \texttt{\{breakDown\}}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(breakDown)}
\NormalTok{logit }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{exp}\NormalTok{(x)}\SpecialCharTok{/}\NormalTok{(}\DecValTok{1}\SpecialCharTok{+}\FunctionTok{exp}\NormalTok{(x))}
\NormalTok{nouvelle\_observation }\OtherTok{\textless{}{-}}\NormalTok{ d[}\DecValTok{1}\NormalTok{, ]}
\NormalTok{nouvelle\_observation}\SpecialCharTok{$}\NormalTok{sexe[}\DecValTok{1}\NormalTok{] }\OtherTok{=} \StringTok{"Femme"}
\NormalTok{nouvelle\_observation}\SpecialCharTok{$}\NormalTok{groupe\_ages[}\DecValTok{1}\NormalTok{] }\OtherTok{=} \StringTok{"45{-}64 ans"}
\NormalTok{nouvelle\_observation}\SpecialCharTok{$}\NormalTok{etud[}\DecValTok{1}\NormalTok{] }\OtherTok{=} \StringTok{"Primaire"}
\NormalTok{nouvelle\_observation}\SpecialCharTok{$}\NormalTok{heures.tv[}\DecValTok{1}\NormalTok{] }\OtherTok{=} \DecValTok{0}
\FunctionTok{plot}\NormalTok{(}
  \FunctionTok{broken}\NormalTok{(mod2, nouvelle\_observation, }\AttributeTok{predict.function =}\NormalTok{ betas),}
  \AttributeTok{trans =}\NormalTok{ logit}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Probabilité de faire du sport"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/interactions_files/figure-pdf/fig-interpretation-femme-60ans-1.pdf}

}

\caption{\label{fig-interpretation-femme-60ans}Représentation graphique
de l'estimation de la probabilité de faire du sport pour une femme de 60
ans}

\end{figure}

En premier lieu, l'\emph{intercept} s'applique et permet de déterminer
la probabilité de base de faire du sport à la référence. Femme étant la
modalité de référence pour la variable \emph{sexe}, cela ne modifie pas
le calcul de la probabilité de faire du sport. Par contre, il y a une
modification induite par la modalité 45-64 ans de la variable
\emph{groupe\_ages}.

Regardons maintenant la situation d'un homme de 20 ans.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nouvelle\_observation}\SpecialCharTok{$}\NormalTok{sexe[}\DecValTok{1}\NormalTok{] }\OtherTok{=} \StringTok{"Homme"}
\NormalTok{nouvelle\_observation}\SpecialCharTok{$}\NormalTok{groupe\_ages[}\DecValTok{1}\NormalTok{] }\OtherTok{=} \StringTok{"18{-}24 ans"}
\FunctionTok{plot}\NormalTok{(}
  \FunctionTok{broken}\NormalTok{(mod2, nouvelle\_observation, }\AttributeTok{predict.function =}\NormalTok{ betas),}
  \AttributeTok{trans =}\NormalTok{ logit}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{1.2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Probabilité de faire du sport"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/interactions_files/figure-pdf/fig-interpretation-homme-20ans-1.pdf}

}

\caption{\label{fig-interpretation-homme-20ans}Représentation graphique
de l'estimation de la probabilité de faire du sport pour un homme de 20
ans}

\end{figure}

Nous sommes à la modalité de référence pour l'âge par contre il y a un
effet important du sexe. Le coefficient associé globalement à la
variable sexe correspond donc à l'effet du sexe à la modalité de
référence du groupe d'âges.

Regardons enfin la situation d'un homme de 60 ans.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nouvelle\_observation}\SpecialCharTok{$}\NormalTok{groupe\_ages[}\DecValTok{1}\NormalTok{] }\OtherTok{=} \StringTok{"45{-}64 ans"}
\FunctionTok{plot}\NormalTok{(}
  \FunctionTok{broken}\NormalTok{(mod2, nouvelle\_observation, }\AttributeTok{predict.function =}\NormalTok{ betas),}
  \AttributeTok{trans =}\NormalTok{ logit}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{1.2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Probabilité de faire du sport"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/interactions_files/figure-pdf/fig-interpretation-homme-60ans-1.pdf}

}

\caption{\label{fig-interpretation-homme-60ans}Représentation graphique
de l'estimation de la probabilité de faire du sport pour un homme de 60
ans}

\end{figure}

Cette fois, plusieurs coefficients s'appliquent~: à la fois le
coefficient sexe = Homme (effet du sexe pour les 18-24 ans), le
coefficient groupe\_ages = 45-64 ans qui est l'effet de l'âge pour les
femmes de 45-64 ans par rapport aux 18-24 ans et le coefficient
sexe:groupe\_ages = Homme:45-64 ans qui indique l'effet spécifique qui
s'applique aux hommes de 45-64 ans, d'une part par rapport aux femmes du
même âge et d'autre part par rapport aux hommes de 18-24 ans. L'effet
des coefficients d'interaction doivent donc être interprétés par rapport
aux autres coefficients du modèle qui s'appliquent, en tenant compte des
modalités de référence.

\hypertarget{duxe9finition-alternative-de-linteraction}{%
\section{Définition alternative de
l'interaction}\label{duxe9finition-alternative-de-linteraction}}

Il est cependant possible d'écrire le même modèle différemment. En
effet, \texttt{sexe\ *\ groupe\_ages} dans la formule du modèle est
équivalent à l'écriture
\texttt{sexe\ +\ groupe\_ages\ +\ sexe:groupe\_ages}, c'est-à-dire que
l'on demande des coefficients pour la variable \emph{sexe} à la
référence de \emph{groupe\_ages}, des coefficients pour
\emph{groupe\_ages} à la référence de \emph{sexe} et enfin des
coefficients pour tenir compte de l'interaction.

On peut se contenter d'une série de coefficients uniques pour
l'interaction en indiquant seulement \texttt{sexe~:~groupe\_ages}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod3 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{:}\NormalTok{ groupe\_ages }\SpecialCharTok{+}\NormalTok{ etudes }\SpecialCharTok{+}\NormalTok{ heures.tv,}
  \AttributeTok{family =}\NormalTok{ binomial,}
  \AttributeTok{data =}\NormalTok{ d}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Au sens strict, ce modèle explique tout autant le phénomène étudié que
le modèle précédent. On peut le vérifier facilement avec
\texttt{stats::anova()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{anova}\NormalTok{(mod2, mod3, }\AttributeTok{test =} \StringTok{"Chisq"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Analysis of Deviance Table

Model 1: sport ~ sexe * groupe_ages + etudes + heures.tv
Model 2: sport ~ sexe:groupe_ages + etudes + heures.tv
  Resid. Df Resid. Dev Df Deviance Pr(>Chi)
1      1982     2197.4                     
2      1982     2197.4  0        0         
\end{verbatim}

De même, les prédictions marginales sont les mêmes, comme nous pouvons
le constater avec \texttt{ggstats::ggcoef\_compare()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_compare}\NormalTok{(}
  \FunctionTok{list}\NormalTok{(}\StringTok{"sexe * groupe\_ages"} \OtherTok{=}\NormalTok{ mod2, }\StringTok{"sexe : groupe\_ages"} \OtherTok{=}\NormalTok{ mod3),}
  \AttributeTok{tidy\_fun =}\NormalTok{ broom.helpers}\SpecialCharTok{::}\NormalTok{tidy\_marginal\_predictions,}
  \AttributeTok{significance =} \ConstantTok{NULL}\NormalTok{,}
  \AttributeTok{vline =} \ConstantTok{FALSE}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Warning: Model matrix is rank deficient. Some variance-covariance parameters are
  missing.

Warning: Model matrix is rank deficient. Some variance-covariance parameters are
  missing.

Warning: Model matrix is rank deficient. Some variance-covariance parameters are
  missing.
\end{verbatim}

\begin{figure}[H]

{\centering \includegraphics{analyses/interactions_files/figure-pdf/fig-comparaison-predictions-marginales-interaction-1.pdf}

}

\caption{\label{fig-comparaison-predictions-marginales-interaction}Comparaison
des prédictions marginales moyennes des deux modèles avec interaction}

\end{figure}

Par contre, regardons d'un peu plus près les coefficients de ce nouveau
modèle. Nous allons voir que leur interprétation est légèrement
différente.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod3 }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/interactions_files/figure-pdf/fig-coefficients-modele-interaction-3-1.pdf}

}

\caption{\label{fig-coefficients-modele-interaction-3}Coefficients (odds
ratio) du modèle avec interaction simple entre le sexe et le groupe
d'âges}

\end{figure}

Cette fois-ci, il n'y a plus de coefficients globaux pour la variable
\emph{sexe} ni pour \emph{groupe\_ages} mais des coefficients pour
chaque combinaison de ces deux variables. Reprenons l'exemple de notre
homme de 60 ans.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}
  \FunctionTok{broken}\NormalTok{(mod3, nouvelle\_observation, }\AttributeTok{predict.function =}\NormalTok{ betas),}
  \AttributeTok{trans =}\NormalTok{ logit}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{1.2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Probabilité de faire du sport"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{analyses/interactions_files/figure-pdf/fig-interpretation-homme-60ans-bis-1.pdf}

}

\caption{\label{fig-interpretation-homme-60ans-bis}Représentation
graphique de l'estimation de la probabilité de faire du sport pour un
homme de 60 ans (interaction simple)}

\end{figure}

Cette fois-ci, le coefficient d'interaction fournit indique l'effet
combiné du sexe et du groupe d'âges par rapport à la situation de
référence (femme de 18-24 ans).

\textbf{Que l'on définisse une interaction simple
(\texttt{sexe:groupe\_ages}) ou complète (\texttt{sexe*groupe\_ages}),
les deux modèles calculés sont donc identiques en termes prédictifs et
explicatifs, mais l'interprétation de leurs coefficients diffèrent.}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Il peut y avoir de multiples interactions dans un modèle, d'ordre 2
(entre deux variables) ou plus (entre trois variables ou plus). Il est
dès lors tentant de tester les multiples interactions possibles de
manière itératives afin d'identifier celles à retenir. C'est justement
le but de la fonction \texttt{ggmulti::glmulti()}
\texttt{glmulti::glmulti()} permets de tester toutes les combinaisons
d'interactions d'ordre 2 dans un modèle, en retenant le meilleur modèle
à partir d'un critère spécifié (par défaut l'AIC). ATTENTION : le temps
de calcul de \texttt{glmulti::glmulti()} peut-être long.

\end{tcolorbox}

\hypertarget{pour-aller-plus-loin}{%
\section{Pour aller plus loin}\label{pour-aller-plus-loin}}

Il y a d'autres extensions dédiées à l'analyse des interactions d'un
modèle, de même que de nombreux supports de cours en ligne dédiés à
cette question.

\begin{itemize}
\tightlist
\item
  \href{http://commonweb.unifr.ch/artsdean/pub/gestens/f/as/files/4665/9547_131825.pdf}{Les
  effets d'interaction} par Jean-François Bickel
\item
  \href{https://cran.r-project.org/web/packages/phia/vignettes/phia.pdf}{Analysing
  interactions of fitted models} par Helios De Rosario Martínez
\end{itemize}

\hypertarget{webin-r-8}{%
\section{webin-R}\label{webin-r-8}}

Les interactions sont abordées dans le webin-R \#07 (\emph{régression
logistique partie 2}) sur
\href{https://youtu.be/BUo9i7XTLYQ?t=2750}{YouTube}.

\url{https://youtu.be/BUo9i7XTLYQ}

\hypertarget{sec-multicolinearite}{%
\chapter{Multicolinéarité}\label{sec-multicolinearite}}

Dans une régression, la multicolinéarité est un problème qui survient
lorsque certaines variables de prévision du modèle mesurent le même
phénomène. Une multicolinéarité prononcée s'avère problématique, car
elle peut augmenter la variance des coefficients de régression et les
rendre instables et difficiles à interpréter. Les conséquences de
coefficients instables peuvent être les suivantes~:

\begin{itemize}
\tightlist
\item
  les coefficients peuvent sembler non significatifs, même lorsqu'une
  relation significative existe entre le prédicteur et la réponse~;
\item
  les coefficients de prédicteurs fortement corrélés varieront
  considérablement d'un échantillon à un autre~;
\item
  lorsque des termes d'un modèle sont fortement corrélés, la suppression
  de l'un de ces termes aura une incidence considérable sur les
  coefficients estimés des autres. Les coefficients des termes fortement
  corrélés peuvent même présenter le mauvais signe.
\end{itemize}

La multicolinéarité n'a aucune incidence sur l'adéquation de
l'ajustement, ni sur la qualité de la prévision. Cependant, les
coefficients individuels associés à chaque variable explicative ne
peuvent pas être interprétés de façon fiable.

\hypertarget{duxe9finition}{%
\section{Définition}\label{duxe9finition}}

Au sens strict, on parle de multicolinéarité parfaite lorsqu'une des
variables explicatives d'un modèle est une combinaison linéaire d'une ou
plusieurs autres variables explicatives introduites dans le même modèle.
L'absence de multicolinéarité parfaite est une des conditions requises
pour pouvoir estimer un modèle linéaire et, par extension, un modèle
linéaire généralisé (dont les modèles de régression logistique).

Dans les faits, une multicolinéarité parfaite n'est quasiment jamais
observée. Mais une forte multicolinéarité entre plusieurs variables peut
poser problème dans l'estimation et l'interprétation d'un modèle.

Une erreur fréquente est de confondre multicolinéarité et corrélation.
Si des variables colinéaires sont \emph{de facto} fortement corrélées
entre elles, deux variables corrélées ne sont pas forcément colinéaires.
En termes non statistiques, il y a colinéarité lorsque deux ou plusieurs
variables mesurent la même chose.

Prenons un exemple. Nous étudions les complications après l'accouchement
dans différentes maternités d'un pays en développement. On souhaite
mettre dans le modèle, à la fois le milieu de résidence (urbain ou
rural) et le fait qu'il y ait ou non un médecin dans la clinique. Or,
dans la zone d'enquête, les maternités rurales sont dirigées seulement
par des sage-femmes tandis que l'on trouve un médecin dans toutes les
maternités urbaines sauf une. Dès lors, dans ce contexte précis, le
milieu de résidence prédit presque totalement la présence d'un médecin
et on se retrouve face à une multicolinéarité (qui serait même parfaite
s'il n'y avait pas une clinique urbaine sans médecin). On ne peut donc
distinguer l'effet de la présence d'un médecin de celui du milieu de
résidence et il ne faut mettre qu'une seule de ces deux variables dans
le modèle, sachant que du point de vue de l'interprétation elle
capturera à la fois l'effet de la présence d'un médecin et celui du
milieu de résidence.

Par contre, si dans notre région d'étude, seule la moitié des maternités
urbaines disposait d'un médecin, alors le milieu de résidence n'aurait
pas été suffisant pour prédire la présence d'un médecin. Certes, les
deux variables seraient corrélées mais pas colinéaires. Un autre exemple
de corrélation sans colinéarité, c'est la relation entre milieu de
résidence et niveau d'instruction. Il y a une corrélation entre ces deux
variables, les personnes résidant en ville étant généralement plus
instruites. Cependant, il existe également des personnes non instruites
en ville et des personnes instruites en milieu rural. Le milieu de
résidence n'est donc pas suffisant pour prédire le niveau d'instruction.

\hypertarget{mesure-de-la-colinuxe9arituxe9}{%
\section{Mesure de la
colinéarité}\label{mesure-de-la-colinuxe9arituxe9}}

Il existe différentes mesures de la multicolinéarité. L'extension
\texttt{\{mctest\}} en fournie plusieurs, mais elle n'est utilisable que
si l'ensemble des variables explicatives sont de type numérique.

L'approche la plus classique consiste à examiner les facteurs
d'inflation de la variance (FIV) ou variance inflation factor (VIF) en
anglais. Les FIV estiment de combien la variance d'un coefficient est
augmentée en raison d'une relation linéaire avec d'autres prédicteurs.
Ainsi, un FIV de 1,8 nous dit que la variance de ce coefficient
particulier est supérieure de 80~\% à la variance que l'on aurait dû
observer si ce facteur n'est absolument pas corrélé aux autres
prédicteurs.

Si tous les FIV sont égaux à 1, il n'existe pas de multicolinéarité,
mais si certains FIV sont supérieurs à 1, les prédicteurs sont corrélés.
Il n'y a pas de consensus sur la valeur au-delà de laquelle on doit
considérer qu'il y a multicolinéarité. Certains auteurs, comme Paul
Allison\sidenote{\footnotesize \href{https://statisticalhorizons.com/multicollinearity}{When
  Can You Safely Ignore Multicollinearity?}}, disent de regarder plus en
détail les variables avec un FIV supérieur à 2,5. D'autres ne
s'inquiètent qu'à partir de 5. Il n'existe pas de test statistique qui
permettrait de dire s'il y a colinéarité ou non\sidenote{\footnotesize Pour plus de
  détails, voir ce post de Davig Giles,
  \href{http://davegiles.blogspot.be/2013/06/can-you-actually-test-for.html}{Can
  You Actually TEST for Multicollinearity?}, qui explique pourquoi ce
  n'est pas possible.}.

L'extension \texttt{\{car\}} fournit une fonction \texttt{car::vif()}
permettant de calculer les FIV à partir d'un modèle. Elle implémente
même une version généralisée permettant de considérer des facteurs
catégoriels et des modèles linéaires généralisés comme la régression
logistique.

Reprenons, pour exemple, un modèle logistique que nous avons déjà abordé
dans d'autres chapitres.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(labelled)}

\FunctionTok{data}\NormalTok{(hdv2003, }\AttributeTok{package =} \StringTok{"questionr"}\NormalTok{)}

\NormalTok{d }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{sexe =}\NormalTok{ sexe }\SpecialCharTok{|\textgreater{}} \FunctionTok{fct\_relevel}\NormalTok{(}\StringTok{"Femme"}\NormalTok{),}
    \AttributeTok{groupe\_ages =}\NormalTok{ age }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{cut}\NormalTok{(}
        \FunctionTok{c}\NormalTok{(}\DecValTok{18}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{45}\NormalTok{, }\DecValTok{65}\NormalTok{, }\DecValTok{99}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}\NormalTok{,}
        \AttributeTok{include.lowest =} \ConstantTok{TRUE}\NormalTok{,}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"18{-}24 ans"}\NormalTok{, }\StringTok{"25{-}44 ans"}\NormalTok{,}
                   \StringTok{"45{-}64 ans"}\NormalTok{, }\StringTok{"65 ans et plus"}\NormalTok{)}
\NormalTok{      ),}
    \AttributeTok{etudes =}\NormalTok{ nivetud }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{fct\_recode}\NormalTok{(}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"N\textquotesingle{}a jamais fait d\textquotesingle{}etudes"}\NormalTok{,}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"A arrete ses etudes, avant la derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"Derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
        \StringTok{"Secondaire"} \OtherTok{=} \StringTok{"1er cycle"}\NormalTok{,}
        \StringTok{"Secondaire"} \OtherTok{=} \StringTok{"2eme cycle"}\NormalTok{,}
        \StringTok{"Technique / Professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel court"}\NormalTok{,}
        \StringTok{"Technique / Professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel long"}\NormalTok{,}
        \StringTok{"Supérieur"} \OtherTok{=} \StringTok{"Enseignement superieur y compris technique superieur"}
\NormalTok{    ) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{fct\_na\_value\_to\_level}\NormalTok{(}\StringTok{"Non documenté"}\NormalTok{)  }
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{set\_variable\_labels}\NormalTok{(}
    \AttributeTok{sport =} \StringTok{"Pratique un sport ?"}\NormalTok{,}
    \AttributeTok{sexe =} \StringTok{"Sexe"}\NormalTok{,}
    \AttributeTok{groupe\_ages =} \StringTok{"Groupe d\textquotesingle{}âges"}\NormalTok{,}
    \AttributeTok{etudes =} \StringTok{"Niveau d\textquotesingle{}études"}\NormalTok{,}
    \AttributeTok{heures.tv =} \StringTok{"Heures de télévision / jour"}
\NormalTok{  )}

\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{+}\NormalTok{ groupe\_ages }\SpecialCharTok{+}\NormalTok{ etudes }\SpecialCharTok{+}\NormalTok{ heures.tv,}
  \AttributeTok{family =}\NormalTok{ binomial,}
  \AttributeTok{data =}\NormalTok{ d}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Le calcul des FIV se fait simplement en passant le modèle à la fonction
\texttt{car::vif()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}}\NormalTok{ car}\SpecialCharTok{::}\FunctionTok{vif}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                GVIF Df GVIF^(1/(2*Df))
sexe        1.024640  1        1.012245
groupe_ages 1.745492  3        1.097285
etudes      1.811370  4        1.077087
heures.tv   1.057819  1        1.028503
\end{verbatim}

Dans notre exemple, tous les FIV sont proches de 1. Il n'y a donc pas de
problème potentiel de colinéarité à explorer.

Pour un tableau propre, nous pouvons aussi utiliser
\texttt{gtsummary::add\_vif()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gtsummary)}
\FunctionTok{theme\_gtsummary\_language}\NormalTok{(}
  \StringTok{"fr"}\NormalTok{,}
  \AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{,}
  \AttributeTok{big.mark =} \StringTok{" "}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_vif}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-add_vif}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.3333}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.0833}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1354}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1458}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1042}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1979}}@{}}
\caption{\label{tbl-add_vif}Résumé du modèle logistique simple avec
affichage des VIF généralisés}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{OR}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{GVIF}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Adjusted GVIF}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{OR}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{GVIF}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Adjusted GVIF}
\end{minipage} \\
\midrule()
\endhead
\textbf{Sexe} & & & & 1,0 & 1,0 \\
Femme & --- & --- & & & \\
Homme & 1,52 & 1,24 -- 1,87 & \textless0,001 & & \\
\textbf{Groupe d'âges} & & & & 1,7 & 1,1 \\
18-24 ans & --- & --- & & & \\
25-44 ans & 0,68 & 0,43 -- 1,06 & 0,084 & & \\
45-64 ans & 0,36 & 0,23 -- 0,57 & \textless0,001 & & \\
65 ans et plus & 0,27 & 0,16 -- 0,46 & \textless0,001 & & \\
\textbf{Niveau d'études} & & & & 1,8 & 1,1 \\
Primaire & --- & --- & & & \\
Secondaire & 2,54 & 1,73 -- 3,75 & \textless0,001 & & \\
Technique / Professionnel & 2,81 & 1,95 -- 4,10 & \textless0,001 & & \\
Supérieur & 6,55 & 4,50 -- 9,66 & \textless0,001 & & \\
Non documenté & 8,54 & 4,51 -- 16,5 & \textless0,001 & & \\
\textbf{Heures de télévision / jour} & 0,89 & 0,83 -- 0,95 &
\textless0,001 & 1,1 & 1,0 \\
\bottomrule()
\end{longtable}

\hypertarget{la-multicolinuxe9arituxe9-est-elle-toujours-un-probluxe8me}{%
\section{La multicolinéarité est-elle toujours un
problème~?}\label{la-multicolinuxe9arituxe9-est-elle-toujours-un-probluxe8me}}

Là encore, il n'y a pas de consensus sur cette question. Certains
analystes considèrent que tout modèle où certains prédicteurs seraient
colinéaires n'est pas valable. Dans le billet
\href{https://statisticalhorizons.com/multicollinearity/}{When Can You
Safely Ignore Multicollinearity?}, Paul Allison évoque quant à lui des
situations où la multicolinéarité peut être ignorée en toute sécurité.
Le texte ci-dessous est une traduction de ce billet.

\textbf{1. Les variables avec des FIV élevés sont des variables de
contrôle, et les variables d'intérêt n'ont pas de FIV élevés.}

Voici le problème de la multicolinéarité~: ce n'est un problème que pour
les variables qui sont colinéaires. Il augmente les erreurs-types de
leurs coefficients et peut rendre ces coefficients instables de
plusieurs façons. Mais tant que les variables colinéaires ne sont
utilisées que comme variables de contrôle, et qu'elles ne sont pas
colinéaires avec vos variables d'intérêt, il n'y a pas de problème. Les
coefficients des variables d'intérêt ne sont pas affectés et la
performance des variables de contrôle n'est pas altérée.

Voici un exemple tiré de ces propres travaux~: l'échantillon est
constitué de collèges américains, la variable dépendante est le taux
d'obtention de diplôme et la variable d'intérêt est un indicateur
(factice) pour les secteurs public et privé. Deux variables de contrôle
sont les scores moyens au SAT et les scores moyens à l'ACT pour l'entrée
en première année. Ces deux variables ont une corrélation supérieure à
,9, ce qui correspond à des FIV d'au moins 5,26 pour chacune d'entre
elles. Mais le FIV pour l'indicateur public/privé n'est que de 1,04. Il
n'y a donc pas de problème à se préoccuper et il n'est pas nécessaire de
supprimer l'un ou l'autre des deux contrôles, à condition que l'on ne
cherche pas à interpréter ou comparer l'un par rapport à l'autre les
coefficients de ces deux variables de contrôle.

\textbf{2. Les FIV élevés sont causés par l'inclusion de puissances ou
de produits d'autres variables.}

Si vous spécifiez un modèle de régression avec \emph{x} et
\emph{x\textsuperscript{2}}, il y a de bonnes chances que ces deux
variables soient fortement corrélées. De même, si votre modèle a
\emph{x}, \emph{z} et \emph{xz}, \emph{x} et \emph{z} sont susceptibles
d'être fortement corrélés avec leur produit. Il n'y a pas de quoi
s'inquiéter, car la valeur \emph{p} de \emph{xz} n'est pas affectée par
la multicolinéarité. Ceci est facile à démontrer~: vous pouvez réduire
considérablement les corrélations en centrant les variables
(c'est-à-dire en soustrayant leurs moyennes) avant de créer les
puissances ou les produits. Mais la valeur \emph{p} pour
\emph{x\textsuperscript{2}} ou pour \emph{xz} sera exactement la même,
que l'on centre ou non. Et tous les résultats pour les autres variables
(y compris le R\textsuperscript{2} mais sans les termes d'ordre
inférieur) seront les mêmes dans les deux cas. La multicolinéarité n'a
donc pas de conséquences négatives.

\textbf{3. Les variables avec des FIV élevés sont des variables
indicatrices (factices) qui représentent une variable catégorielle avec
trois catégories ou plus.}

Si la proportion de cas dans la catégorie de référence est faible, les
variables indicatrices auront nécessairement des FIV élevés, même si la
variable catégorielle n'est pas associée à d'autres variables dans le
modèle de régression.

Supposons, par exemple, qu'une variable de l'état matrimonial comporte
trois catégories~: actuellement marié, jamais marié et anciennement
marié. Vous choisissez anciennement marié comme catégorie de référence,
avec des variables d'indicateur pour les deux autres. Ce qui se passe,
c'est que la corrélation entre ces deux indicateurs devient plus
négative à mesure que la fraction de personnes dans la catégorie de
référence diminue. Par exemple, si 45~\% des personnes ne sont jamais
mariées, 45~\% sont mariées et 10~\% sont anciennement mariées, les
valeurs du FIV pour les personnes mariées et les personnes jamais
mariées seront d'au moins 3,0.

Est-ce un problème~? Eh bien, cela signifie que les valeurs \emph{p} des
variables indicatrices peuvent être élevées. Mais le test global selon
lequel tous les indicateurs ont des coefficients de zéro n'est pas
affecté par des FIV élevés. Et rien d'autre dans la régression n'est
affecté. Si vous voulez vraiment éviter des FIV élevés, il suffit de
choisir une catégorie de référence avec une plus grande fraction des
cas. Cela peut être souhaitable pour éviter les situations où aucun des
indicateurs individuels n'est statistiquement significatif, même si
l'ensemble des indicateurs est significatif.

\hypertarget{webin-r-9}{%
\section{webin-R}\label{webin-r-9}}

La multicolinéarité est abordée dans le webin-R \#07 (\emph{régression
logistique partie 2}) sur
\href{https://youtu.be/BUo9i7XTLYQ?t=4455}{YouTube}.

\url{https://youtu.be/BUo9i7XTLYQ}

\part{\textbf{Données pondérées avec \texttt{survey}}}

\hypertarget{sec-plan-echantillonnage}{%
\chapter{Définir un plan
d'échantillonnage}\label{sec-plan-echantillonnage}}

Lorsque l'on travaille avec des données d'enquêtes, il est fréquent que
les données soient \textbf{pondérées}. Cette pondération est nécessaire
pour assurer la représentativité des données lorsque les participants
ont été sélectionnés avec des probabilités variables. C'est par exemple
le cas lorsqu'on réalise une enquête en grappes et/ou stratifiée.

De nombreuses fonctions acceptent une variable de pondération.
Cependant, la simple prise en compte de la pondération est souvent
insuffisante si l'on ne tient pas compte du plan d'échantillonnage de
l'enquête. Le plan d'échantillonnage ne joue pas seulement sur la
pondération des données, mais influence le calcul des variances et par
ricochet tous les tests statistiques. Deux échantillons identiques avec
la même variable de pondération mais des designs différents produiront
les mêmes moyennes et proportions mais des intervalles de confiance
différents.

Diverses fonctions de \textbf{R} peuvent prendre en compte une variable
de pondération. Mais, en règle générale, elles sont incapables de tenir
compte du plan d'échantillonnage. Il est donc préférable de privilégier
le package \texttt{\{survey\}} qui est spécialement dédié au traitement
d'enquêtes ayant des techniques d'échantillonnage et de pondération
potentiellement très complexes. \texttt{\{survey\}} peut également être
utilisée pour des pondérations simples.

\hypertarget{diffuxe9rents-types-duxe9chantillonnage}{%
\section{Différents types
d'échantillonnage}\label{diffuxe9rents-types-duxe9chantillonnage}}

L'\textbf{échantillonnage aléatoire simple} ou \textbf{échantillonnage
équiprobable} est une méthode pour laquelle tous les échantillons
possibles (de même taille) ont la même probabilité d'être choisis et
tous les éléments de la population ont une chance égale de faire partie
de l'échantillon. C'est l'échantillonnage le plus simple~: chaque
individu à la même probabilité d'être sélectionné.

L'\textbf{échantillonnage stratifié} est une méthode qui consiste
d'abord à subdiviser la population en groupes homogènes (strates) pour
ensuite extraire un échantillon aléatoire de chaque strate. Cette
méthode suppose une connaissance de la structure de la population. Pour
estimer les paramètres, les résultats doivent être pondérés par
l'importance relative de chaque strate dans la population.

L'échantillonnage par grappes est une méthode qui consiste à choisir un
échantillon aléatoire d'unités qui sont elles-mêmes des sous-ensembles
de la population (grappes ou clusters en anglais). Cette méthode suppose
que les unités de chaque grappe sont représentatives. Elle possède
l'avantage d'être souvent plus économique.

Il est possible de combiner plusieurs de ces approches. Par exemple, les
\emph{Enquêtes Démographiques et de Santé}\sidenote{\footnotesize Vaste programme
  d'enquêtes réalisées à intervalles réguliers dans les pays à faible et
  moyen revenu, disponibles sur \url{https://dhsprogram.com/}.} (EDS)
sont des enquêtes stratifiées en grappes à deux degrés. Dans un premier
temps, la population est divisée en strates par région et milieu de
résidence. Dans chaque strate, des zones d'enquêtes, correspondant à des
unités de recensement, sont tirées au sort avec une probabilité
proportionnelle au nombre de ménages de chaque zone au dernier
recensement de population. Enfin, au sein de chaque zone d'enquête
sélectionnée, un recensement de l'ensemble des ménages est effectué puis
un nombre identique de ménages par zone d'enquête est tiré au sort de
manière aléatoire simple.

\hypertarget{avec-surveysvydesign}{%
\section{\texorpdfstring{Avec
\texttt{survey::svydesign()}}{Avec survey::svydesign()}}\label{avec-surveysvydesign}}

La fonction \texttt{survey::svydesign()} accepte plusieurs arguments
décrits en détail sur sa page d'aide (obtenue avec la commande
\texttt{?svydesign}).

L'agument \texttt{data} permet de spécifier le tableau de données
contenant les observations.

L'argument \texttt{ids} est obligatoire et spécifie sous la forme d'une
formule les identifiants des différents niveaux d'un tirage en grappe.
S'il s'agit d'un échantillon aléatoire simple, on entrera
\texttt{ids\ =\ \textasciitilde{}\ 1}. Autre situation~: supposons une
étude portant sur la population française. Dans un premier temps, on a
tiré au sort un certain nombre de départements français. Dans un second
temps, on tire au sort dans chaque département des communes. Dans chaque
commune sélectionnée, on tire au sort des quartiers. Enfin, on interroge
de manière exhaustive toutes les personnes habitant les quartiers
enquêtés. Notre fichier de données devra donc comporter pour chaque
observation les variables \emph{id\_departement}, \emph{id\_commune} et
\emph{id\_quartier}. On écrira alors pour l'argument \texttt{ids} la
valeur suivante~:\\
\texttt{ids\ =\ \textasciitilde{}\ id\_departement\ +\ id\_commune\ +\ id\_quartier}.

Si l'échantillon est stratifié, on spécifiera les strates à l'aide de
l'argument \texttt{strata} en spécifiant la variable contenant
l'identifiant des strates. Par exemple~:
\texttt{strata\ =\ \textasciitilde{}\ id\_strate}.

Il faut encore spécifier les probabilités de tirage de chaque cluster
/grappe ou bien la pondération des individus. Si l'on dispose de la
probabilité de chaque observation d'être sélectionnée, on utilisera
l'argument \texttt{probs}. Si, par contre, on connaît la pondération de
chaque observation (qui doit être proportionnelle à l'inverse de cette
probabilité), on utilisera l'argument \texttt{weights}.

Si l'échantillon est stratifié, qu'au sein de chaque strate les
individus ont été tirés au sort de manière aléatoire et que l'on connaît
la taille de chaque strate, il est possible de ne pas avoir à spécifier
la probabilité de tirage ou la pondération de chaque observation. Il est
préférable de fournir une variable contenant la taille de chaque strate
à l'argument \texttt{fpc}. De plus, dans ce cas-là, une petite
correction sera appliquée au modèle pour prendre en compte la taille
finie de chaque strate.

On peut tout à fait définir un \textbf{échantillonnage aléatoire simple}
(on considère donc que toutes les observations ont le même poids, égal à
1). Pour rappel, en l'absence de clusters/grappes, il faut préciser
\texttt{ids\ =\ \textasciitilde{}\ 1}, ce paramètre n'ayant pas de
valeur par défaut.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p\_iris }\OtherTok{\textless{}{-}}\NormalTok{ survey}\SpecialCharTok{::}\FunctionTok{svydesign}\NormalTok{(}
  \AttributeTok{ids =} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }
  \AttributeTok{data =}\NormalTok{ iris}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Warning in svydesign.default(ids = ~1, data = iris): No weights or
probabilities supplied, assuming equal probability
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p\_iris}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Independent Sampling design (with replacement)
survey::svydesign(ids = ~1, data = iris)
\end{verbatim}

Pour un jeu de données \textbf{simplement pondéré} (chaque ligne
représente plusieurs observations)~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{titanic }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(Titanic)}
\NormalTok{titanic }\SpecialCharTok{|\textgreater{}}\NormalTok{ labelled}\SpecialCharTok{::}\FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values
 1   Class    —     chr      0             
 2   Sex      —     chr      0             
 3   Age      —     chr      0             
 4   Survived —     chr      0             
 5   n        —     dbl      0             
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p\_titanic }\OtherTok{\textless{}{-}}\NormalTok{ survey}\SpecialCharTok{::}\FunctionTok{svydesign}\NormalTok{(}
  \AttributeTok{ids =} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }
  \AttributeTok{data =}\NormalTok{ titanic, }
  \AttributeTok{weights =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ n}
\NormalTok{)}
\NormalTok{p\_titanic}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Independent Sampling design (with replacement)
survey::svydesign(ids = ~1, data = titanic, weights = ~n)
\end{verbatim}

Pour un \textbf{échantillon stratifié} pour lequel les strates sont
indiquées dans la variable \emph{stype} et les poids indiquées dans la
variable \emph{pw}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"api"}\NormalTok{, }\AttributeTok{package =} \StringTok{"survey"}\NormalTok{)}
\NormalTok{p\_strates }\OtherTok{\textless{}{-}}\NormalTok{ survey}\SpecialCharTok{::}\FunctionTok{svydesign}\NormalTok{(}
  \AttributeTok{id =} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }
  \AttributeTok{strata =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ stype, }
  \AttributeTok{weights =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ pw, }
  \AttributeTok{data =}\NormalTok{ apistrat}
\NormalTok{)}
\NormalTok{p\_strates}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Stratified Independent Sampling design (with replacement)
survey::svydesign(id = ~1, strata = ~stype, weights = ~pw, data = apistrat)
\end{verbatim}

Pour une \textbf{enquête en grappes à 1 degré}, pour laquelle
l'identifiant des grappes (\emph{clusters}) est indiqué par la variable
\emph{dnum}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"api"}\NormalTok{, }\AttributeTok{package =} \StringTok{"survey"}\NormalTok{)}
\NormalTok{p\_grappes }\OtherTok{\textless{}{-}}\NormalTok{ survey}\SpecialCharTok{::}\FunctionTok{svydesign}\NormalTok{(}
  \AttributeTok{id =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ dnum, }
  \AttributeTok{weights =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ pw, }
  \AttributeTok{data =}\NormalTok{ apiclus1}
\NormalTok{)}
\NormalTok{p\_grappes}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 - level Cluster Sampling design (with replacement)
With (15) clusters.
survey::svydesign(id = ~dnum, weights = ~pw, data = apiclus1)
\end{verbatim}

Voici un exemple un peu plus complexe d'une \textbf{enquête en grappes à
deux degrés} (les deux niveaux étant donnés par les variables
\emph{dnum} et \emph{snum}). Les poids ne sont pas fournis mais la
taille des grappes est connue et renseignée dans les variables
\emph{fpc1} et \emph{fpc2} que nous pourrons donc transmettre via
l'argument \texttt{fpc}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"api"}\NormalTok{, }\AttributeTok{package =} \StringTok{"survey"}\NormalTok{)}
\NormalTok{p\_grappes2 }\OtherTok{\textless{}{-}}\NormalTok{ survey}\SpecialCharTok{::}\FunctionTok{svydesign}\NormalTok{(}
  \AttributeTok{id =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ dnum }\SpecialCharTok{+}\NormalTok{ snum,}
  \AttributeTok{fpc =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ fpc1 }\SpecialCharTok{+}\NormalTok{ fpc2,}
  \AttributeTok{data =}\NormalTok{ apiclus2}
\NormalTok{)}
\NormalTok{p\_grappes2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2 - level Cluster Sampling design
With (40, 126) clusters.
survey::svydesign(id = ~dnum + snum, fpc = ~fpc1 + fpc2, data = apiclus2)
\end{verbatim}

Dans le cas présent, \texttt{\{survey\}} a calculé les poids
s'appliquant à chaque individu. On peut les obtenir avec la fonction
\texttt{weights()}, en l'occurrence avec
\texttt{p\_grappes2\ \textbar{}\textgreater{}\ weights()}.

Enfin, prenons l'exemple d'une \emph{Enquête Démographique et de Santé}.
Le nom des différentes variables est standardisé et commun quelle que
soit l'enquête. Nous supposerons que vous avez importé le fichier
\emph{individus} dans un tableau de données nommés \texttt{eds}. Le
poids statistique de chaque individu est fourni par la variable
\emph{V005} qui doit au préalable être divisée par un million. Les
grappes d'échantillonnage au premier degré sont fournies par la variable
\emph{V021 (primary sample unit)}. Si elle n'est pas renseignée, on
pourra utiliser le numéro de grappe \emph{V001}. Enfin, le milieu de
résidence (urbain / rural) est fourni par \emph{V025} et la région par
\emph{V024}. Pour rappel, l'échantillon a été stratifié à la fois par
région et par milieu de résidence. Certaines enquêtes fournissent
directement un numéro de strate via \emph{V022}. Si tel est le cas, on
pourra préciser le plan d'échantillonnage ainsi~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{eds}\SpecialCharTok{$}\NormalTok{poids }\OtherTok{\textless{}{-}}\NormalTok{ eds}\SpecialCharTok{$}\NormalTok{V005}\SpecialCharTok{/}\DecValTok{1000000}
\NormalTok{p\_eds }\OtherTok{\textless{}{-}}\NormalTok{ survey}\SpecialCharTok{::}\FunctionTok{svydesign}\NormalTok{(}
  \AttributeTok{ids =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ V021, }
  \AttributeTok{data =}\NormalTok{ eds, }
  \AttributeTok{strata =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ V022, }
  \AttributeTok{weights =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ poids}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{avec-srvyras_survey_design}{%
\section{\texorpdfstring{Avec
\texttt{srvyr::as\_survey\_design()}}{Avec srvyr::as\_survey\_design()}}\label{avec-srvyras_survey_design}}

Dans le prochain chapitre (cf.
Chapitre~\ref{sec-manipulation-donnees-ponderees}), nous aborderons le
package \texttt{\{srvyr\}} qui est aux objets \texttt{\{survey\}} ce que
\texttt{\{dplyr\}} est aux tableaux de données~: plus précisément, ce
package étend les verbes de \texttt{\{dplyr\}} aux plans
d'échantillonnage complexe.

La fonction \texttt{srvyr::as\_survey\_design()} est équivalente à
\texttt{survey::svydesign()} mais avec quelques différences~:

\begin{itemize}
\tightlist
\item
  le paramètre \texttt{ids} dispose d'une valeur par défaut et on peut
  l'ignorer en l'absence de grappes~;
\item
  les variables ne sont pas spécifiées avec une formule mais avec les
  mêmes sélecteurs que \texttt{dplyr::select()}~;
\item
  l'objet renvoyé est à la fois du type \texttt{"survey.design"} et du
  type \texttt{"tbl\_svy"}, une sorte de \emph{tibble} pour les objets
  \texttt{\{survey\}}.
\end{itemize}

Reprenons nos exemples précédents en commençant par un
\textbf{échantillonnage aléatoire simple}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t\_iris }\OtherTok{\textless{}{-}}\NormalTok{ iris }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  srvyr}\SpecialCharTok{::}\FunctionTok{as\_survey\_design}\NormalTok{()}
\NormalTok{t\_iris}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Independent Sampling design (with replacement)
Called via srvyr
Sampling variables:
 - ids: `1`
Data variables: Sepal.Length (dbl), Sepal.Width (dbl), Petal.Length (dbl),
  Petal.Width (dbl), Species (fct)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(t\_iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "tbl_svy"        "survey.design2" "survey.design" 
\end{verbatim}

Pour un jeu de données \textbf{simplement pondéré} (chaque ligne
représente plusieurs observations)~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{titanic }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(Titanic)}
\NormalTok{t\_titanic }\OtherTok{\textless{}{-}}\NormalTok{ titanic }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  srvyr}\SpecialCharTok{::}\FunctionTok{as\_survey\_design}\NormalTok{(}\AttributeTok{weights =}\NormalTok{ n)}
\NormalTok{t\_titanic}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Independent Sampling design (with replacement)
Called via srvyr
Sampling variables:
 - ids: `1`
 - weights: n
Data variables: Class (chr), Sex (chr), Age (chr), Survived (chr), n (dbl)
\end{verbatim}

Pour un \textbf{échantillon stratifié} pour lequel les strates sont
indiquées dans la variable \emph{stype} et les poids indiquées dans la
variable \emph{pw}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"api"}\NormalTok{, }\AttributeTok{package =} \StringTok{"survey"}\NormalTok{)}
\NormalTok{t\_strates }\OtherTok{\textless{}{-}}\NormalTok{ apistrat }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  srvyr}\SpecialCharTok{::}\FunctionTok{as\_survey\_design}\NormalTok{(}\AttributeTok{strata =}\NormalTok{ stype, }\AttributeTok{weights =}\NormalTok{ pw)}
\NormalTok{t\_strates}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Stratified Independent Sampling design (with replacement)
Called via srvyr
Sampling variables:
 - ids: `1`
 - strata: stype
 - weights: pw
Data variables: cds (chr), stype (fct), name (chr), sname (chr), snum (dbl),
  dname (chr), dnum (int), cname (chr), cnum (int), flag (int), pcttest (int),
  api00 (int), api99 (int), target (int), growth (int), sch.wide (fct),
  comp.imp (fct), both (fct), awards (fct), meals (int), ell (int), yr.rnd
  (fct), mobility (int), acs.k3 (int), acs.46 (int), acs.core (int), pct.resp
  (int), not.hsg (int), hsg (int), some.col (int), col.grad (int), grad.sch
  (int), avg.ed (dbl), full (int), emer (int), enroll (int), api.stu (int), pw
  (dbl), fpc (dbl)
\end{verbatim}

Pour une \textbf{enquête en grappes à 1 degré}, pour laquelle
l'identifiant des grappes (\emph{clusters}) est indiqué par la variable
\emph{dnum}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"api"}\NormalTok{, }\AttributeTok{package =} \StringTok{"survey"}\NormalTok{)}
\NormalTok{t\_grappes }\OtherTok{\textless{}{-}}\NormalTok{ apiclus1 }\SpecialCharTok{|\textgreater{}} 
\NormalTok{    srvyr}\SpecialCharTok{::}\FunctionTok{as\_survey\_design}\NormalTok{(}\AttributeTok{id =}\NormalTok{ dnum, }\AttributeTok{weights =}\NormalTok{ pw)}
\NormalTok{t\_grappes}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 - level Cluster Sampling design (with replacement)
With (15) clusters.
Called via srvyr
Sampling variables:
 - ids: dnum
 - weights: pw
Data variables: cds (chr), stype (fct), name (chr), sname (chr), snum (dbl),
  dname (chr), dnum (int), cname (chr), cnum (int), flag (int), pcttest (int),
  api00 (int), api99 (int), target (int), growth (int), sch.wide (fct),
  comp.imp (fct), both (fct), awards (fct), meals (int), ell (int), yr.rnd
  (fct), mobility (int), acs.k3 (int), acs.46 (int), acs.core (int), pct.resp
  (int), not.hsg (int), hsg (int), some.col (int), col.grad (int), grad.sch
  (int), avg.ed (dbl), full (int), emer (int), enroll (int), api.stu (int), fpc
  (dbl), pw (dbl)
\end{verbatim}

Voici un exemple un peu plus complexe d'une \textbf{enquête en grappes à
deux degrés} (les deux niveaux étant donnés par les variables
\emph{dnum} et \emph{snum}). Les poids ne sont pas fournis mais la
taille des grappes est connue et renseignée dans les variables
\emph{fpc1} et \emph{fpc2} que nous pourrons donc transmettre via
l'argument \texttt{fpc}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"api"}\NormalTok{, }\AttributeTok{package =} \StringTok{"survey"}\NormalTok{)}
\FunctionTok{data}\NormalTok{(}\StringTok{"api"}\NormalTok{, }\AttributeTok{package =} \StringTok{"survey"}\NormalTok{)}
\NormalTok{t\_grappes2 }\OtherTok{\textless{}{-}}\NormalTok{ apiclus2 }\SpecialCharTok{|\textgreater{}} 
\NormalTok{    srvyr}\SpecialCharTok{::}\FunctionTok{as\_survey\_design}\NormalTok{(}\AttributeTok{id =} \FunctionTok{c}\NormalTok{(dnum, snum), }\AttributeTok{fpc =} \FunctionTok{c}\NormalTok{(fpc1, fpc2))}
\NormalTok{t\_grappes2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2 - level Cluster Sampling design
With (40, 126) clusters.
Called via srvyr
Sampling variables:
 - ids: `dnum + snum`
 - fpc: `fpc1 + fpc2`
Data variables: cds (chr), stype (fct), name (chr), sname (chr), snum (dbl),
  dname (chr), dnum (int), cname (chr), cnum (int), flag (int), pcttest (int),
  api00 (int), api99 (int), target (int), growth (int), sch.wide (fct),
  comp.imp (fct), both (fct), awards (fct), meals (int), ell (int), yr.rnd
  (fct), mobility (int), acs.k3 (int), acs.46 (int), acs.core (int), pct.resp
  (int), not.hsg (int), hsg (int), some.col (int), col.grad (int), grad.sch
  (int), avg.ed (dbl), full (int), emer (int), enroll (int), api.stu (int), pw
  (dbl), fpc1 (dbl), fpc2 (int[1d])
\end{verbatim}

Enfin, prenons l'exemple d'une \emph{Enquête Démographique et de Santé}.
Le nom des différentes variables est standardisé et commun quelle que
soit l'enquête. Nous supposerons que vous avez importé le fichier
\emph{individus} dans un tableau de données nommés \texttt{eds}. Le
poids statistique de chaque individu est fourni par la variable
\emph{V005} qui doit au préalable être divisée par un million. Les
grappes d'échantillonnage au premier degré sont fournies par la variable
\emph{V021 (primary sample unit)}. Si elle n'est pas renseignée, on
pourra utiliser le numéro de grappe \emph{V001}. Enfin, le milieu de
résidence (urbain / rural) est fourni par \emph{V025} et la région par
\emph{V024}. Pour rappel, l'échantillon a été stratifié à la fois par
région et par milieu de résidence. Certaines enquêtes fournissent
directement un numéro de strate via \emph{V022}. Si tel est le cas, on
pourra préciser le plan d'échantillonnage ainsi~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{eds}\SpecialCharTok{$}\NormalTok{poids }\OtherTok{\textless{}{-}}\NormalTok{ eds}\SpecialCharTok{$}\NormalTok{V005}\SpecialCharTok{/}\DecValTok{1000000}
\NormalTok{t\_eds }\OtherTok{\textless{}{-}}\NormalTok{ eds }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  srvyr}\SpecialCharTok{::}\FunctionTok{as\_survey\_design}\NormalTok{(}
    \AttributeTok{ids =}\NormalTok{ V021,}
    \AttributeTok{strata =}\NormalTok{ V022,}
    \AttributeTok{weights =}\NormalTok{ poids}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\hypertarget{webin-r-10}{%
\section{webin-R}\label{webin-r-10}}

La statistique univariée est présentée dans le webin-R \#10
(\emph{données pondérées, plan d'échantillonnage complexe \& survey})
sur \href{https://youtu.be/aXCn9SyhcTE}{YouTube}.

\url{https://youtu.be/aXCn9SyhcTE}

\hypertarget{sec-manipulation-donnees-ponderees}{%
\chapter{Manipulation de données
pondérées}\label{sec-manipulation-donnees-ponderees}}

L'objet créé avec \texttt{survey::svydesign()} ou
\texttt{srvyr::as\_survey\_design()} n'est plus un tableau de données,
mais plutôt un tableau de données auquel est attaché un plan
d'échantillonnage. Les colonnes du tableau d'origine ne sont plus
directement accessibles avec l'opérateur \texttt{\$}. En fait, elles
sont stockées dans un sous-objet \texttt{\$variables}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{titanic }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(Titanic)}
\NormalTok{t\_titanic }\OtherTok{\textless{}{-}}\NormalTok{ titanic }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  srvyr}\SpecialCharTok{::}\FunctionTok{as\_survey\_design}\NormalTok{(}\AttributeTok{weights =}\NormalTok{ n)}
\NormalTok{t\_titanic}\SpecialCharTok{$}\NormalTok{variables }\SpecialCharTok{|\textgreater{}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{glimpse}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Rows: 32
Columns: 5
$ Class    <chr> "1st", "2nd", "3rd", "Crew", "1st", "2nd", "3rd", "Crew", "1s~
$ Sex      <chr> "Male", "Male", "Male", "Male", "Female", "Female", "Female",~
$ Age      <chr> "Child", "Child", "Child", "Child", "Child", "Child", "Child"~
$ Survived <chr> "No", "No", "No", "No", "No", "No", "No", "No", "No", "No", "~
$ n        <dbl> 0, 0, 35, 0, 0, 0, 17, 0, 118, 154, 387, 670, 4, 13, 89, 3, 5~
\end{verbatim}

Il n'est pas aisé de modifier des variables dans un objet de ce type. Il
est donc préférable de procéder à l'ensemble des nettoyages, recodages
de variables (et au besoin transformation des vecteurs labellisés en
facteur), avant de définir le plan d'échantillonnage et de procéder aux
analyses.

Si l'on souhaite manipuler les données, le plus simple est d'avoir
recours au package \texttt{\{srvyr\}} qui étend les verbes de
\texttt{\{dplyr\}} (cf. Chapitre~\ref{sec-dplyr}) aux objets
\texttt{\{survey\}}.

\hypertarget{utilisation-de-srvyr}{%
\section{\texorpdfstring{Utilisation de
\texttt{\{srvyr\}}}{Utilisation de \{srvyr\}}}\label{utilisation-de-srvyr}}

\texttt{\{srvyr\}} fournit les verbes \texttt{srvyr::select()} et
\texttt{srvyr::filter()} pour sélectionner respectivement des colonnes
et des lignes.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(srvyr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Attachement du package : 'srvyr'
\end{verbatim}

\begin{verbatim}
L'objet suivant est masqué depuis 'package:stats':

    filter
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t\_titanic }\SpecialCharTok{|\textgreater{}} \FunctionTok{select}\NormalTok{(Sex, Age)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Independent Sampling design (with replacement)
Called via srvyr
Sampling variables:
 - ids: `1`
 - weights: n
Data variables: Sex (chr), Age (chr)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t\_titanic }\SpecialCharTok{|\textgreater{}} \FunctionTok{filter}\NormalTok{(Sex }\SpecialCharTok{==} \StringTok{"Female"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Independent Sampling design (with replacement)
Called via srvyr
Sampling variables:
 - ids: `1`
 - weights: n
Data variables: Class (chr), Sex (chr), Age (chr), Survived (chr), n (dbl)
\end{verbatim}

On peut aussi utiliser \texttt{srvyr::pull()} pour extraire le contenu
d'une colonne ou \texttt{srvyr::drop\_na()} pour supprimer les
observations contenant des valeurs manquantes.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-warning-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-warning-color}{\faExclamationTriangle}\hspace{0.5em}{Avertissement}, bottomrule=.15mm, colframe=quarto-callout-warning-color-frame]

Par contre, le verbe \texttt{arrange()} (tri du tableau) ou encore les
fonctions de jointures (telles que \texttt{left\_join()}) ne sont pas
implémentées car ce type d'opération entraînerait des modifications du
plan d'échantillonnage. Il est donc préférable de réaliser ce type
d'opérations avant la déclaration du plan d'échantillonnage (quand les
données sont donc encore stockées dans un tableau de données
classiques).

\end{tcolorbox}

\texttt{srvyr} fournit également le verbe \texttt{srvyr::summarize()}
permettant de calculer des statistiques sur l'ensemble du fichier ou par
sous-groupe (en combinant \texttt{summarize()} avec
\texttt{group\_by()}). Afin de prendre en compte correctement la
pondération et le plan d'échantillonnage, \texttt{srvyr} fournit des
fonctions adaptées pour un usage au sein de \texttt{summarize()}~:
\texttt{srvyr::survey\_mean()}, \texttt{srvyr::survey\_total()},
\texttt{srvyr::survey\_prop()}, \texttt{srvyr::survey\_ratio()},
\texttt{srvyr::survey\_quantile()} ou encore
\texttt{srvyr::survey\_median()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t\_titanic }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(Sex, Class, Survived) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{taux\_survie =} \FunctionTok{survey\_prop}\NormalTok{()) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(Survived }\SpecialCharTok{==} \StringTok{"Yes"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
When `proportion` is unspecified, `survey_prop()` now defaults to `proportion = TRUE`.
i This should improve confidence interval coverage.
This message is displayed once per session.
\end{verbatim}

\begin{verbatim}
Warning: There were 24 warnings in `dplyr::summarise()`.
The first warning was:
i In argument: `taux_survie = survey_prop()`.
i In group 1: `Sex = "Female"`, `Class = "1st"`, `Survived = "No"`.
Caused by warning in `summary.glm()`:
! les observations de poids nul n'ont pas été utilisées pour le calcul de la dispersion
i Run `dplyr::last_dplyr_warnings()` to see the 23 remaining warnings.
\end{verbatim}

\begin{verbatim}
# A tibble: 8 x 5
# Groups:   Sex, Class [8]
  Sex    Class Survived taux_survie taux_survie_se
  <chr>  <chr> <chr>          <dbl>          <dbl>
1 Female 1st   Yes            0.972         0.0384
2 Female 2nd   Yes            0.877         0.145 
3 Female 3rd   Yes            0.459         0.306 
4 Female Crew  Yes            0.870         0.163 
5 Male   1st   Yes            0.344         0.312 
6 Male   2nd   Yes            0.140         0.150 
7 Male   3rd   Yes            0.173         0.183 
8 Male   Crew  Yes            0.223         0.249 
\end{verbatim}

\hypertarget{lister-rechercher-des-variables}{%
\section{Lister / Rechercher des
variables}\label{lister-rechercher-des-variables}}

La fonction \texttt{labelled::look\_for()}, que nous avons déjà abordée
(cf. Section~\ref{sec-afficher-donnees}), est compatible avec les objets
\texttt{\{survey\}} et peut donc être utilisée pour lister ou rechercher
des variables.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t\_titanic }\OtherTok{\textless{}{-}}\NormalTok{ titanic }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  labelled}\SpecialCharTok{::}\FunctionTok{set\_variable\_labels}\NormalTok{(}
    \AttributeTok{Class =} \StringTok{"Class du passager"}\NormalTok{,}
    \AttributeTok{Sex =} \StringTok{"Sexe du passager"}\NormalTok{,}
    \AttributeTok{Age =} \StringTok{"Enfant ou adulte ?"}\NormalTok{,}
    \AttributeTok{Survived =} \StringTok{"A survécu au naufrage ?"}\NormalTok{,}
    \AttributeTok{n =} \StringTok{"Nombre d\textquotesingle{}observations"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  srvyr}\SpecialCharTok{::}\FunctionTok{as\_survey\_design}\NormalTok{(}\AttributeTok{weights =}\NormalTok{ n)}
\NormalTok{t\_titanic }\SpecialCharTok{|\textgreater{}}\NormalTok{ labelled}\SpecialCharTok{::}\FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label                   col_type missing values
 1   Class    Class du passager       chr      0             
 2   Sex      Sexe du passager        chr      0             
 3   Age      Enfant ou adulte ?      chr      0             
 4   Survived A survécu au naufrage ? chr      0             
 5   n        Nombre d'observations   dbl      0             
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t\_titanic }\SpecialCharTok{|\textgreater{}}\NormalTok{ labelled}\SpecialCharTok{::}\FunctionTok{look\_for}\NormalTok{(}\StringTok{"nau"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label                   col_type missing values
 4   Survived A survécu au naufrage ? chr      0             
\end{verbatim}

\hypertarget{extraire-un-sous-uxe9chantillon}{%
\section{Extraire un
sous-échantillon}\label{extraire-un-sous-uxe9chantillon}}

Si l'on souhaite travailler sur un sous-échantillon de l'enquête, il
importe de définir le plan d'échantillonnage sur l'ensemble du jeu de
données \textbf{avant} de procéder à la sélection des observations.

La fonction classique pour sélectionner des lignes est
\texttt{subset()}. Cependant, elle a un inconvénient lorsque nos données
comportent des étiquettes de variables (cf.
Chapitre~\ref{sec-etiquettes-variables}) ou de valeurs (
Chapitre~\ref{sec-etiquettes-valeurs}), car les étiquettes ne sont pas
conservées après l'opération.

On préférera donc avoir recours à \texttt{srvyr::filter()} qui
conservent les attributs associés aux colonnes du tableau de données.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t\_subset }\OtherTok{\textless{}{-}}\NormalTok{ t\_titanic }\SpecialCharTok{|\textgreater{}} \FunctionTok{subset}\NormalTok{(Sex }\SpecialCharTok{==} \StringTok{"Female"}\NormalTok{)}
\NormalTok{t\_subset }\SpecialCharTok{|\textgreater{}}\NormalTok{ labelled}\SpecialCharTok{::}\FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values
 1   Class    —     chr      0             
 2   Sex      —     chr      0             
 3   Age      —     chr      0             
 4   Survived —     chr      0             
 5   n        —     dbl      0             
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t\_filter }\OtherTok{\textless{}{-}}\NormalTok{ t\_titanic }\SpecialCharTok{|\textgreater{}} \FunctionTok{filter}\NormalTok{(Sex }\SpecialCharTok{==} \StringTok{"Female"}\NormalTok{)}
\NormalTok{t\_filter }\SpecialCharTok{|\textgreater{}}\NormalTok{ labelled}\SpecialCharTok{::}\FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label                   col_type missing values
 1   Class    Class du passager       chr      0             
 2   Sex      Sexe du passager        chr      0             
 3   Age      Enfant ou adulte ?      chr      0             
 4   Survived A survécu au naufrage ? chr      0             
 5   n        Nombre d'observations   dbl      0             
\end{verbatim}

\hypertarget{sec-analyses-bivariees-ponderees}{%
\chapter{Analyses uni- et bivariées
pondérées}\label{sec-analyses-bivariees-ponderees}}

\hypertarget{la-fonction-tbl_svysummary}{%
\section{\texorpdfstring{La fonction
\texttt{tbl\_svysummary()}}{La fonction tbl\_svysummary()}}\label{la-fonction-tbl_svysummary}}

Dans les chapitres sur la statistique univariée (cf.
Chapitre~\ref{sec-statistique-univariee}) et la statistique bivariée
(cf. Chapitre~\ref{sec-statistique-bivariee}), nous avons abordé la
fonction \texttt{gtsummary::tbl\_summary()} qui permet de générer des
tris à plats et des tableaux croisés prêts à être publiés.

Son équivalent pour les objets \texttt{\{survey\}} existe~: il s'agit de
la fonction \texttt{gtsummary::tbl\_svysummary()} qui fonctionne de
manière similaire.

Pour illustrer son fonctionnement, nous allons utiliser le jeu de
données \emph{fecondite} fournit dans le package \texttt{\{questionr\}}.
Ce jeu de données fournit un tableau de données \texttt{femmes}
comportant une variable \emph{poids} de pondération que nous allons
utiliser. Les données catégorielles étant stockées sous forme de
vecteurs numériques avec étiquettes de valeurs (cf.
Chapitre~\ref{sec-etiquettes-valeurs}), nous allons les convertir en
facteurs avec \texttt{labelled::unlabelled()}. De même, certaines
valeurs manquantes sont indiquées sous formes de \emph{user NAs} (cf.
Section~\ref{sec-user-na})~: nous allons les convertir en valeurs
manquantes classiques (\emph{regular NAs}) avec
\texttt{labelled::user\_na\_to\_na()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"fecondite"}\NormalTok{, }\AttributeTok{package =} \StringTok{"questionr"}\NormalTok{)}
\FunctionTok{library}\NormalTok{(srvyr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Attachement du package : 'srvyr'
\end{verbatim}

\begin{verbatim}
L'objet suivant est masqué depuis 'package:stats':

    filter
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dp }\OtherTok{\textless{}{-}}\NormalTok{ femmes }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  labelled}\SpecialCharTok{::}\FunctionTok{user\_na\_to\_na}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  labelled}\SpecialCharTok{::}\FunctionTok{unlabelled}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{as\_survey\_design}\NormalTok{(}\AttributeTok{weights =}\NormalTok{ poids)}
\NormalTok{dp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Independent Sampling design (with replacement)
Called via srvyr
Sampling variables:
 - ids: `1`
 - weights: poids
Data variables: id_femme (dbl), id_menage (dbl), poids (dbl), date_entretien
  (date), date_naissance (date), age (dbl), milieu (fct), region (fct), educ
  (fct), travail (fct), matri (fct), religion (fct), journal (fct), radio
  (fct), tv (fct), nb_enf_ideal (dbl), test (fct)
\end{verbatim}

Chargeons \texttt{\{gtsummary\}} et définissons le français comme langue
de rendu des tableaux.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gtsummary)}
\FunctionTok{theme\_gtsummary\_language}\NormalTok{(}
  \AttributeTok{language =} \StringTok{"fr"}\NormalTok{, }
  \AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{, }
  \AttributeTok{big.mark =} \StringTok{" "}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Setting theme `language: fr`
\end{verbatim}

Pour réaliser un tableau croisé, il nous suffit d'appeler
\texttt{gtsummary::tbl\_svysummary()} de la même manière que l'on aurait
procédé avec \texttt{gtsummary::tbl\_summary()}. En arrière plan,
\texttt{gtsummary::tbl\_svysummary()} appellera les différentes
fonctions statistiques de \texttt{\{survey\}}~: la pondération ainsi que
les spécificités du plan d'échantillonnage seront donc correctement
prises en compte.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dp }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_svysummary}\NormalTok{(}
    \AttributeTok{by =}\NormalTok{ milieu,}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, educ, travail)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_overall}\NormalTok{(}\AttributeTok{last =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-tbl_svysummary}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.5000}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1716}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1642}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1642}}@{}}
\caption{\label{tbl-tbl_svysummary}Tableau croisé sur des données
pondérées}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{urbain}, N = 1 026
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{rural}, N = 1 002
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Total}, N = 2 027
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{urbain}, N = 1 026
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{rural}, N = 1 002
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Total}, N = 2 027
\end{minipage} \\
\midrule()
\endhead
\textbf{Âge révolu (en années) à la date de passation du questionnaire}
& 26 (20 -- 33) & 28 (22 -- 36) & 27 (21 -- 35) \\
\textbf{Niveau d'éducation} & & & \\
aucun & 414 (40\%) & 681 (68\%) & 1 095 (54\%) \\
primaire & 251 (24\%) & 257 (26\%) & 507 (25\%) \\
secondaire & 303 (30\%) & 61 (6,1\%) & 364 (18\%) \\
supérieur & 58 (5,7\%) & 3 (0,3\%) & 61 (3,0\%) \\
\textbf{A un emploi ?} & & & \\
non & 401 (39\%) & 269 (27\%) & 670 (33\%) \\
oui & 621 (61\%) & 731 (73\%) & 1 351 (67\%) \\
Manquant & 5 & 1 & 6 \\
\bottomrule()
\end{longtable}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Important}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

Par défaut, les effectifs (ainsi que les pourcentages et autres
statistiques) affichés sont pondérés. Il est important de bien
comprendre ce que représentent ces effectifs pondérés pour les
interpréter correctement. Pour cela, il faut savoir comment les poids de
l'enquête ont été calculés.

Dans certains cas, lorsque la population totale est connue, la somme des
poids est égale à cette population totale dans laquelle l'échantillon a
été tiré au sort. Les effectifs pondérés représentent donc une
estimation des effectifs dans la population totale et ne représentent en
rien le nombre d'observations dans l'enquête.

Dans d'autres enquêtes, les poids sont générés de telle manière que la
somme des poids correspondent au nombre total de personnes enquêtées.
Dans ce genre de situation, on a souvent tendance, à tort, à interpréter
les effectifs pondérés comme un nombre d'observations. Or, il peut y
avoir un écart important entre le nombre d'observations dans l'enquête
et les effectifs pondérés.

On pourra éventuellement présenter séparément le nombre d'observations
(i.e.~les effectifs non pondérés) et les proportions pondérées.
\texttt{gtsummary::tbl\_svysummary()} fournit justement à la fois ces
données pondérées et non pondérées. Il est vrai que cela nécessite quand
même quelques manipulations. Pour les cellules, on précisera le type
d'effectifs à afficher avec l'argument \texttt{statistic}. Pour
personnaliser l'affiche du nombre de valeurs manquantes, cela doit se
faire à un niveau plus global via
\texttt{gtsummary::set\_gtsummary\_theme()}. Enfin, on passera par
\texttt{gtsummary::modify\_header()} pour personnaliser les en-têtes de
colonne.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set\_gtsummary\_theme}\NormalTok{(}
  \FunctionTok{list}\NormalTok{(}\StringTok{"tbl\_summary{-}str:missing\_stat"} \OtherTok{=} \StringTok{"\{N\_miss\_unweighted\} obs."}\NormalTok{)}
\NormalTok{)}
\NormalTok{dp }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_svysummary}\NormalTok{(}
    \AttributeTok{by =}\NormalTok{ milieu,}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(educ, travail),}
    \AttributeTok{statistic =} \FunctionTok{all\_categorical}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"\{p\}\% (\{n\_unweighted\} obs.)"}\NormalTok{,}
    \AttributeTok{digits =} \FunctionTok{all\_categorical}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{modify\_header}\NormalTok{(}
    \FunctionTok{all\_stat\_cols}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"**\{level\}** (\{n\_unweighted\} obs.)"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3333}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3333}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3333}}@{}}
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{urbain} (912 obs.)
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{rural} (1088 obs.)
\end{minipage} \\
\midrule()
\endhead
\textbf{Niveau d'éducation} & & \\
aucun & 40,3\% (375 obs.) & 68,0\% (763 obs.) \\
primaire & 24,4\% (213 obs.) & 25,6\% (247 obs.) \\
secondaire & 29,5\% (275 obs.) & 6,1\% (73 obs.) \\
supérieur & 5,7\% (49 obs.) & 0,3\% (5 obs.) \\
\textbf{A un emploi ?} & & \\
non & 39,2\% (370 obs.) & 26,9\% (296 obs.) \\
oui & 60,8\% (537 obs.) & 73,1\% (790 obs.) \\
Manquant & 5 obs. & 2 obs. \\
\bottomrule()
\end{longtable}

Il faut noter qu'une modification du thème impactera tous les tableaux
suivants, jusqu'à ce que le thème soit à nouveau modifié ou bien que
l'on fasse appel à \texttt{gtsummary::reset\_gtsummary\_theme()}.

\end{tcolorbox}

\hypertarget{calcul-manuel-avec-survey}{%
\section{\texorpdfstring{Calcul manuel avec
\texttt{\{survey\}}}{Calcul manuel avec \{survey\}}}\label{calcul-manuel-avec-survey}}

Lorsque l'on travail avec un plan d'échantillonnage, on ne peut utiliser
les fonctions statistiques classiques de \textbf{R}. On aura recours à
leurs équivalents fournis par \texttt{\{survey\}}~:

\begin{itemize}
\item
  \texttt{survey::svymean()}, \texttt{survey::svyvar()},
  \texttt{survey::svytotal()}, \texttt{survey::svyquantile()}~: moyenne,
  variance, total, quantiles
\item
  \texttt{survey::svytable()}~: tri à plat et tableau croisé
\item
  \texttt{survey::svychisq()}~: test du χ²
\item
  \texttt{survey::svyby()}~: statistiques selon un facteur
\item
  \texttt{survey::svyttest()}~: test t de Student de comparaison de
  moyennes
\item
  \texttt{survey::svyciprop()}~: intervalle de confiance d'une
  proportion
\item
  \texttt{survey::svyratio()}~: ratio de deux variables continues
\end{itemize}

Ces fonctions prennent leurs arguments sous forme de formules pour
spécifier les variables d'intérêt.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svymean}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ age, dp)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
      mean     SE
age 28.468 0.2697
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svymean}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ age, dp) }\SpecialCharTok{|\textgreater{}} \FunctionTok{confint}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
       2.5 %   97.5 %
age 27.93931 28.99653
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svyquantile}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{age, dp, }\AttributeTok{quantile =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.25}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.75}\NormalTok{), }\AttributeTok{ci =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
$age
     quantile ci.2.5 ci.97.5        se
0.25       21     21      22 0.2549523
0.5        27     27      28 0.2549523
0.75       35     35      37 0.5099045

attr(,"hasci")
[1] TRUE
attr(,"class")
[1] "newsvyquantile"
\end{verbatim}

Les tris à plat se déclarent en passant comme argument le nom de la
variable précédé d'un tilde (\texttt{\textasciitilde{}}), tandis que les
tableaux croisés utilisent les noms des deux variables séparés par un
signe plus (\texttt{+}) et précédés par un tilde
(\texttt{\textasciitilde{}})\sidenote{\footnotesize Cette syntaxe est similaire à
  celle de \texttt{xtabs()}.}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svytable}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{region, dp)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
region
    Nord      Est      Sud    Ouest 
611.0924 175.7404 329.2220 911.2197 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svytable}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{milieu }\SpecialCharTok{+}\NormalTok{ educ, dp)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
        educ
milieu        aucun   primaire secondaire  supérieur
  urbain 413.608780 250.665214 303.058978  58.412688
  rural  681.131096 256.694363  61.023980   2.679392
\end{verbatim}

La fonction \texttt{questionr::freq()} peut être utilisée si on lui
passe en argument non pas la variable elle-même, mais son tri à plat
obtenu avec \texttt{survey::svytable()}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svytable}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{region, dp) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{freq}\NormalTok{(}\AttributeTok{total =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
           n     %  val%
Nord   611.1  30.1  30.1
Est    175.7   8.7   8.7
Sud    329.2  16.2  16.2
Ouest  911.2  44.9  44.9
Total 2027.3 100.0 100.0
\end{verbatim}

Les fonctions \texttt{questionr::rprop()} et \texttt{questionr::cprop()}
peuvent être utilisées pour calculer les pourcentages en ligne ou en
colonne.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svytable}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{milieu }\SpecialCharTok{+}\NormalTok{ educ, dp) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  questionr}\SpecialCharTok{::}\FunctionTok{cprop}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
        educ
milieu   aucun primaire secondaire supérieur Ensemble
  urbain  37.8  49.4     83.2       95.6      50.6   
  rural   62.2  50.6     16.8        4.4      49.4   
  Total  100.0 100.0    100.0      100.0     100.0   
\end{verbatim}

Le principe de la fonction \texttt{survey::svyby()} est similaire à
celui de \texttt{tapply()} (cf. Section~\ref{sec-tapply}). Elle permet
de calculer des statistiques selon plusieurs sous-groupes définis par un
facteur.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svyby}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{age, }\SpecialCharTok{\textasciitilde{}}\NormalTok{region, dp, survey}\SpecialCharTok{::}\NormalTok{svymean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
      region      age        se
Nord    Nord 29.03299 0.4753268
Est      Est 27.54455 0.5261669
Sud      Sud 28.96830 0.6148223
Ouest  Ouest 28.08626 0.4458201
\end{verbatim}

\hypertarget{intervalles-de-confiance-et-tests-statistiques}{%
\section{Intervalles de confiance et tests
statistiques}\label{intervalles-de-confiance-et-tests-statistiques}}

La fonction \texttt{gtsummary::add\_ci()} peut être appliquée à des
tableaux produits avec \texttt{gtsummary::tbl\_svysummary()}\sidenote{\footnotesize Cela
  requiert une version récente (≥1.7.0) de \texttt{\{gtsummary\}}.}. Les
méthodes utilisées sont adaptées à la prise en compte d'un plan
d'échantillonnage. On se référera à la document de la fonction pour plus
de détails sur les méthodes statistiques utilisées. \textbf{Rappel~:}
pour les variables continues, on sera vigilant à ce que la statistique
affichée (médiane par défaut) corresponde au type d'intervalle de
confiance calculé (moyenne par défaut).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dp }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_svysummary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, region),}
    \AttributeTok{statistic =} \FunctionTok{all\_continuous}\NormalTok{() }\SpecialCharTok{\textasciitilde{}} \StringTok{"\{mean\} (\{sd\})"}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_ci}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-tbl_svysummary-add_ci}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.7128}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.1596}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.1277}}@{}}
\caption{\label{tbl-tbl_svysummary-add_ci}Intervalles de confiance avec
prise en compte du plan d'échantillonnage}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{N = 2 027}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% CI}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{N = 2 027}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% CI}
\end{minipage} \\
\midrule()
\endhead
\textbf{Âge révolu (en années) à la date de passation du questionnaire}
& 28 (9) & 28, 29 \\
\textbf{Région de résidence} & & \\
Nord & 611 (30\%) & 28\%, 33\% \\
Est & 176 (8,7\%) & 7,7\%, 9,8\% \\
Sud & 329 (16\%) & 14\%, 18\% \\
Ouest & 911 (45\%) & 42\%, 48\% \\
\bottomrule()
\end{longtable}

De même, on peut aisément effectuer des tests de comparaison avec
\texttt{gtsummary::add\_p()}. Là aussi, les tests utilisés sont des
adaptations des tests classiques avec différentes corrections pour tenir
compte à la fois de la pondération et du plan d'échantillonnage.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dp }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_svysummary}\NormalTok{(}
    \AttributeTok{include =} \FunctionTok{c}\NormalTok{(age, region),}
    \AttributeTok{by =}\NormalTok{ milieu}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_p}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-tbl_svysummary-add_p}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.5317}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1825}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1746}}
  >{\centering\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1111}}@{}}
\caption{\label{tbl-tbl_svysummary-add_p}Tests de comparaison avec prise
en compte du plan d'échantillonnage}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{urbain}, N = 1 026
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{rural}, N = 1 002
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{urbain}, N = 1 026
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{rural}, N = 1 002
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} \\
\midrule()
\endhead
\textbf{Âge révolu (en années) à la date de passation du questionnaire}
& 26 (20 -- 33) & 28 (22 -- 36) & \textless0,001 \\
\textbf{Région de résidence} & & & \textless0,001 \\
Nord & 265 (26\%) & 346 (35\%) & \\
Est & 48 (4,7\%) & 128 (13\%) & \\
Sud & 79 (7,7\%) & 250 (25\%) & \\
Ouest & 633 (62\%) & 278 (28\%) & \\
\bottomrule()
\end{longtable}

\hypertarget{impact-du-plan-duxe9chantillonnage}{%
\section{Impact du plan
d'échantillonnage}\label{impact-du-plan-duxe9chantillonnage}}

Lorsque l'on calcul des proportions, moyennes ou médianes pondérées,
seuls les poids entrent en ligne de compte. Le plan d'échantillonnage
(strates et/ou grappes) n'a de son côté pas d'effet. Par contre, le plan
d'échantillonnage a un impact important sur le calcul des variances et,
par extension, sur le calcul des intervalles de confiance et des tests
de comparaison.

Pour illustrer cela, nous allons considérer un même jeu de données, avec
la même variable de poids, mais en faisant varier la présence de strates
et de grappes.

Commençons par regarder le jeu de données \emph{apistrat} fourni par
\texttt{\{survey\}}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"api"}\NormalTok{, }\AttributeTok{package =} \StringTok{"survey"}\NormalTok{)}
\FunctionTok{nrow}\NormalTok{(apistrat)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 200
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(apistrat}\SpecialCharTok{$}\NormalTok{pw)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  15.10   19.05   32.28   30.97   44.21   44.21 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sum}\NormalTok{(apistrat}\SpecialCharTok{$}\NormalTok{pw)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 6194
\end{verbatim}

Nous avons ici un tableau de données de 200 lignes, avec des poids
variant entre 15 et 44. Nous pouvons définir une pondération simple et
croiser deux variables.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d\_ponderation\_simple }\OtherTok{\textless{}{-}}\NormalTok{ apistrat }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{as\_survey\_design}\NormalTok{(}\AttributeTok{weights =}\NormalTok{ pw)}
\NormalTok{tbl }\OtherTok{\textless{}{-}}\NormalTok{ survey}\SpecialCharTok{::}\FunctionTok{svytable}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ awards }\SpecialCharTok{+}\NormalTok{ yr.rnd, }\AttributeTok{design =}\NormalTok{ d\_ponderation\_simple)}
\NormalTok{tbl}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
      yr.rnd
awards      No     Yes
   No  2068.34  168.09
   Yes 3274.06  683.51
\end{verbatim}

Réalisons un test du Chi² entre ces deux variables. Si nous appliquions
la fonction classique \texttt{chisq.test()} sur ce tableau, cette
fonction considérait que nous avons 6194 observations (somme des poids)
et dès lors nous obtiendrions une p-valeur très faible.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tbl }\SpecialCharTok{|\textgreater{}} \FunctionTok{chisq.test}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

    Pearson's Chi-squared test with Yates' continuity correction

data:  tbl
X-squared = 113.84, df = 1, p-value < 2.2e-16
\end{verbatim}

Le calcul précédent ne tient pas compte que nous n'avons que 200
observations dans notre échantillon. Refaisons le calcul
\texttt{survey::svychisq()} qui est adaptée aux plans d'échantillonnage.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svychisq}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ awards }\SpecialCharTok{+}\NormalTok{ yr.rnd, }\AttributeTok{design =}\NormalTok{ d\_ponderation\_simple)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

    Pearson's X^2: Rao & Scott adjustment

data:  NextMethod()
F = 2.9162, ndf = 1, ddf = 199, p-value = 0.08926
\end{verbatim}

Le résultat est ici tout autre et notre test n'est plus significatif au
seuil de 5\%~! Ici, les corrections de Rao \& Scott permettent justement
de tenir compte que nous avons un échantillon de seulement 200
observations.

Regardons maintenant si, à poids égal, il y a une différence entre une
enquête stratifiée et une enquête en grappes.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Pondération simple}
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svytable}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ awards }\SpecialCharTok{+}\NormalTok{ yr.rnd, }\AttributeTok{design =}\NormalTok{ d\_ponderation\_simple)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
      yr.rnd
awards      No     Yes
   No  2068.34  168.09
   Yes 3274.06  683.51
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svychisq}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ awards }\SpecialCharTok{+}\NormalTok{ yr.rnd, }\AttributeTok{design =}\NormalTok{ d\_ponderation\_simple)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

    Pearson's X^2: Rao & Scott adjustment

data:  NextMethod()
F = 2.9162, ndf = 1, ddf = 199, p-value = 0.08926
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Enquête stratifiée}
\NormalTok{d\_strates }\OtherTok{\textless{}{-}}\NormalTok{ apistrat }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{as\_survey\_design}\NormalTok{(}\AttributeTok{weights =}\NormalTok{ pw, }\AttributeTok{strata =}\NormalTok{ stype)}
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svytable}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ awards }\SpecialCharTok{+}\NormalTok{ yr.rnd, }\AttributeTok{design =}\NormalTok{ d\_strates)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
      yr.rnd
awards      No     Yes
   No  2068.34  168.09
   Yes 3274.06  683.51
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svychisq}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ awards }\SpecialCharTok{+}\NormalTok{ yr.rnd, }\AttributeTok{design =}\NormalTok{ d\_strates)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

    Pearson's X^2: Rao & Scott adjustment

data:  NextMethod()
F = 2.9007, ndf = 1, ddf = 197, p-value = 0.09012
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Enquête en grappes}
\NormalTok{d\_grappes }\OtherTok{\textless{}{-}}\NormalTok{ apistrat }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{as\_survey\_design}\NormalTok{(}\AttributeTok{weights =}\NormalTok{ pw, }\AttributeTok{ids =}\NormalTok{ dnum)}
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svytable}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ awards }\SpecialCharTok{+}\NormalTok{ yr.rnd, }\AttributeTok{design =}\NormalTok{ d\_grappes)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
      yr.rnd
awards      No     Yes
   No  2068.34  168.09
   Yes 3274.06  683.51
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survey}\SpecialCharTok{::}\FunctionTok{svychisq}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ awards }\SpecialCharTok{+}\NormalTok{ yr.rnd, }\AttributeTok{design =}\NormalTok{ d\_grappes)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

    Pearson's X^2: Rao & Scott adjustment

data:  NextMethod()
F = 3.1393, ndf = 1, ddf = 134, p-value = 0.0787
\end{verbatim}

On le constate~: dans les trois cas les tableaux croisés sont
identiques, mais pour autant les trois p-valeurs diffèrent.

\textbf{Dès lors qu'un calcul de variance est impliqué, la simple prise
en compte des poids est insuffisante~: il faut appliquer des corrections
en fonction du plan d'échantillonnage~!}

Pas d'inquiétude, \texttt{\{survey\}} s'en occupe pour vous, dès lors
que le plan d'échantillonnage a correctement été défini.

\hypertarget{sec-graphiques-ponderes}{%
\chapter{Graphiques pondérés}\label{sec-graphiques-ponderes}}

Le package \texttt{\{ggplot2\}} n'est compatible directement avec les
objets \texttt{\{survey\}}. Cependant, il accepte une esthétique
\emph{weight} qui permet de définir une variable de pondération.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-warning-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-warning-color}{\faExclamationTriangle}\hspace{0.5em}{Avertissement}, bottomrule=.15mm, colframe=quarto-callout-warning-color-frame]

\textbf{ATTENTION :} les graphiques obtenus ne sont corrects qu'à la
condition que seuls les poids soient nécessaires pour les construire, ce
qui est le cas d'un nuage de points ou d'un diagramme en barres.

Par contre, si le calcul du graphique implique le calcul de variances,
la représentation sera incorrecte. Par exemple, avec
\texttt{ggplot2::geom\_smooth()}, les intervalles de confiance affichés
ne prendront pas correctement en compte le plan d'échantillonnage.

\end{tcolorbox}

Reprenons le jeu de données \emph{fecondite} que nous avons abordé dans
le chapitre sur les analyses bivariées pondérées, cf.
Chapitre~\ref{sec-analyses-bivariees-ponderees}. Les poids d'enquête y
sont indiqués dans la colonne \emph{poids}. Pour rappel, les données
catégorielles étant stockées sous forme de vecteurs numériques avec
étiquettes de valeurs (cf. Chapitre~\ref{sec-etiquettes-valeurs}), nous
allons les convertir en facteurs avec \texttt{labelled::unlabelled()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"fecondite"}\NormalTok{, }\AttributeTok{package =} \StringTok{"questionr"}\NormalTok{)}
\FunctionTok{library}\NormalTok{(tidyverse)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-- Attaching core tidyverse packages ------------------------ tidyverse 2.0.0 --
v dplyr     1.1.1     v readr     2.1.4
v forcats   1.0.0     v stringr   1.5.0
v ggplot2   3.4.1     v tibble    3.2.1
v lubridate 1.9.2     v tidyr     1.3.0
v purrr     1.0.1     
-- Conflicts ------------------------------------------ tidyverse_conflicts() --
x dplyr::filter() masks stats::filter()
x dplyr::lag()    masks stats::lag()
i Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\OtherTok{\textless{}{-}}\NormalTok{ labelled}\SpecialCharTok{::}\FunctionTok{unlabelled}\NormalTok{(femmes)}
\end{Highlighting}
\end{Shaded}

Pour réaliser un graphique, nous pouvons reprendre ce que nous avons vu
dans notre chapitre introductif sur \texttt{\{ggplot2\}}, cf.
Chapitre~\ref{sec-ggplot2}, en spécifiant simplement l'esthétique
\emph{weight}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(d) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ region, }\AttributeTok{fill =}\NormalTok{ test, }\AttributeTok{weight =}\NormalTok{ poids) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{donnees_ponderees/graphiques-ponderes_files/figure-pdf/fig-graph-pondere-1-1.pdf}

}

\caption{\label{fig-graph-pondere-1}Un graphique en barres pondéré}

\end{figure}

Si l'on a déjà créé un objet \texttt{\{survey\}}, on peut obtenir les
poids des observations avec la fonction \texttt{weights()}. Les données
sont quant à elle accessibles via le sous-élément nommé
\emph{variables}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(srvyr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Attachement du package : 'srvyr'
\end{verbatim}

\begin{verbatim}
L'objet suivant est masqué depuis 'package:stats':

    filter
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dp }\OtherTok{\textless{}{-}}\NormalTok{ femmes }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  labelled}\SpecialCharTok{::}\FunctionTok{unlabelled}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{as\_survey\_design}\NormalTok{(}\AttributeTok{weights =}\NormalTok{ poids)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(dp}\SpecialCharTok{$}\NormalTok{variables) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ region, }\AttributeTok{fill =}\NormalTok{ test, }\AttributeTok{weight =} \FunctionTok{weights}\NormalTok{(dp)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{donnees_ponderees/graphiques-ponderes_files/figure-pdf/fig-graph-pondere-2-1.pdf}

}

\caption{\label{fig-graph-pondere-2}Un graphique en barres pondéré}

\end{figure}

Pour se faciliter les choses, on peut avoir directement recours à la
fonction \texttt{ggstats::ggsurvey()}, que l'on utilisera à la place de
\texttt{ggplot2::ggplot()}, et qui fait exactement la même chose que
dans notre exemple précédent~: on lui passe un objet de type
\texttt{\{survey\}} et la fonction en extrait le sous-élément
\emph{variables} pour le passer à \texttt{ggplot2::ggplot()} et les
poids qui sont automatiquement associés à l'esthétique \emph{weight}.

Ainsi, le code de notre graphique précédent s'écrit tout
simplement\sidenote{\footnotesize Notez que les poids ont déjà été associés à la bonne
  esthétique et qu'il n'est donc pas nécessaire de le refaire dans
  l'appel à \texttt{aes()}.}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ggstats}\SpecialCharTok{::}\FunctionTok{ggsurvey}\NormalTok{(dp) }\SpecialCharTok{+}
  \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ region, }\AttributeTok{fill =}\NormalTok{ test) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"fill"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{donnees_ponderees/graphiques-ponderes_files/figure-pdf/fig-graph-pondere-3-1.pdf}

}

\caption{\label{fig-graph-pondere-3}Un graphique en barres pondéré}

\end{figure}

\hypertarget{sec-regression-logistique-binaire-ponderee}{%
\chapter{Régression logistique binaire
pondérée}\label{sec-regression-logistique-binaire-ponderee}}

Nous avons abordé la régression logistique binaire non pondérée dans un
chapitre dédié, cf. Chapitre~\ref{sec-regression-logistique-binaire}.
Elle se réalise classiquement avec la fonction \texttt{glm()} en
spécifiant \texttt{family\ =\ binomial}.

Lorsque l'on utilise des données d'enquêtes, l'approche est similaire
sauf que l'on aura recours à la fonction \texttt{survey::svyglm()} qui
sait gérer des objets \texttt{\{survey\}}~: non seulement la pondération
sera prise en compte, mais le calcul des intervalles de confiance et des
p-valeurs sera ajusté en fonction du plan d'échantillonnage.

\hypertarget{donnuxe9es-des-exemples}{%
\section{Données des exemples}\label{donnuxe9es-des-exemples}}

Nous allons reprendre les même données issues de l'enquête
\emph{Histoire de vie 2003}, mais en tenant compte cette fois-ci des
poids de pondération fourni dans la variable \emph{poids}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(labelled)}
\FunctionTok{data}\NormalTok{(hdv2003, }\AttributeTok{package =} \StringTok{"questionr"}\NormalTok{)}
\NormalTok{d }\OtherTok{\textless{}{-}}
\NormalTok{  hdv2003 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{sexe =}\NormalTok{ sexe }\SpecialCharTok{|\textgreater{}} \FunctionTok{fct\_relevel}\NormalTok{(}\StringTok{"Femme"}\NormalTok{),}
    \AttributeTok{groupe\_ages =}\NormalTok{ age }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{cut}\NormalTok{(}
        \FunctionTok{c}\NormalTok{(}\DecValTok{18}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{45}\NormalTok{, }\DecValTok{65}\NormalTok{, }\DecValTok{99}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}\NormalTok{,}
        \AttributeTok{include.lowest =} \ConstantTok{TRUE}\NormalTok{,}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"18{-}24 ans"}\NormalTok{, }\StringTok{"25{-}44 ans"}\NormalTok{,}
                   \StringTok{"45{-}64 ans"}\NormalTok{, }\StringTok{"65 ans et plus"}\NormalTok{)}
\NormalTok{      ),}
    \AttributeTok{etudes =}\NormalTok{ nivetud }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{fct\_recode}\NormalTok{(}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"N\textquotesingle{}a jamais fait d\textquotesingle{}etudes"}\NormalTok{,}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"A arrete ses etudes, avant la derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
        \StringTok{"Primaire"} \OtherTok{=} \StringTok{"Derniere annee d\textquotesingle{}etudes primaires"}\NormalTok{,}
        \StringTok{"Secondaire"} \OtherTok{=} \StringTok{"1er cycle"}\NormalTok{,}
        \StringTok{"Secondaire"} \OtherTok{=} \StringTok{"2eme cycle"}\NormalTok{,}
        \StringTok{"Technique / Professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel court"}\NormalTok{,}
        \StringTok{"Technique / Professionnel"} \OtherTok{=} \StringTok{"Enseignement technique ou professionnel long"}\NormalTok{,}
        \StringTok{"Supérieur"} \OtherTok{=} \StringTok{"Enseignement superieur y compris technique superieur"}
\NormalTok{    ) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{fct\_na\_value\_to\_level}\NormalTok{(}\StringTok{"Non documenté"}\NormalTok{)  }
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{set\_variable\_labels}\NormalTok{(}
    \AttributeTok{sport =} \StringTok{"Pratique un sport ?"}\NormalTok{,}
    \AttributeTok{sexe =} \StringTok{"Sexe"}\NormalTok{,}
    \AttributeTok{groupe\_ages =} \StringTok{"Groupe d\textquotesingle{}âges"}\NormalTok{,}
    \AttributeTok{etudes =} \StringTok{"Niveau d\textquotesingle{}études"}\NormalTok{,}
    \AttributeTok{relig =} \StringTok{"Rapport à la religion"}\NormalTok{,}
    \AttributeTok{heures.tv =} \StringTok{"Heures de télévision / jour"}\NormalTok{,}
    \AttributeTok{poids =} \StringTok{"Pondération de l\textquotesingle{}enquête"}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

Il ne nous reste qu'à définir notre objet \texttt{\{survey\}} en
spécifiant la pondération fournie avec l'enquête. La documentation ne
mentionne ni strates ni grappes.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(srvyr)}
\FunctionTok{library}\NormalTok{(survey)}
\NormalTok{dp }\OtherTok{\textless{}{-}}\NormalTok{ d }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{as\_survey\_design}\NormalTok{(}\AttributeTok{weights =}\NormalTok{ poids)}
\end{Highlighting}
\end{Shaded}

\hypertarget{calcul-de-la-ruxe9gression-logistique-binaire-1}{%
\section{Calcul de la régression logistique
binaire}\label{calcul-de-la-ruxe9gression-logistique-binaire-1}}

La syntaxe de \texttt{survey::svyglm()} est similaire à celle de
\texttt{glm()} sauf qu'elle a un argument \texttt{design} au lieu de
\texttt{data}.

La plupart du temps, les poids de pondération ne sont pas des nombres
entiers, mais des nombres décimaux. Dès lors, on ne peut plus utiliser
la famille de modèles binomiale (qui repose sur des nombres entiers de
succès et d'échecs)\sidenote{\footnotesize Si l'on indique
  \texttt{family\ =\ binomial}, vous obtiendrez avec une version récente
  de \textbf{R} un message d'avertissement du type
  \texttt{Avis\ :\ nombre\ de\ succès\ non\ entier\ dans\ un\ glm\ binomial\ !}.
  Avec une version plus ancienne de \textbf{R}, vous devriez même avoir
  un message d'erreur.}. On aura plutôt recours à la famille
quasi-binomiale, que l'on spécifie avec
\texttt{family\ =\ quasibinomial} et qui constitue une extension de la
famille binomiale pouvant gérer des poids non entiers.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OtherTok{\textless{}{-}} \FunctionTok{svyglm}\NormalTok{(}
\NormalTok{  sport }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sexe }\SpecialCharTok{+}\NormalTok{ groupe\_ages }\SpecialCharTok{+}\NormalTok{ etudes }\SpecialCharTok{+}\NormalTok{ relig }\SpecialCharTok{+}\NormalTok{ heures.tv,}
  \AttributeTok{family =}\NormalTok{ quasibinomial,}
  \AttributeTok{design =}\NormalTok{ dp}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Simple, non~?

\hypertarget{suxe9lection-de-moduxe8le}{%
\section{Sélection de modèle}\label{suxe9lection-de-moduxe8le}}

Comme précédemment, il est possible de procéder à une sélection de
modèle pas à pas, par minimisation de l'AIC, avec \texttt{step()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2 }\OtherTok{\textless{}{-}} \FunctionTok{step}\NormalTok{(mod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Start:  AIC=2309.89
sport ~ sexe + groupe_ages + etudes + relig + heures.tv

              Df Deviance    AIC
- relig        5   2266.3 2302.2
<none>             2263.9 2309.9
- heures.tv    1   2276.2 2320.2
- sexe         1   2276.4 2320.4
- groupe_ages  3   2313.9 2353.8
- etudes       4   2383.5 2421.2

Step:  AIC=2296.28
sport ~ sexe + groupe_ages + etudes + heures.tv

              Df Deviance    AIC
<none>             2266.3 2296.3
- heures.tv    1   2278.4 2306.4
- sexe         1   2279.0 2307.0
- groupe_ages  3   2318.3 2342.1
- etudes       4   2387.2 2408.8
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-warning-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-warning-color}{\faExclamationTriangle}\hspace{0.5em}{Sélection pas à pas et valeurs manquantes}, bottomrule=.15mm, colframe=quarto-callout-warning-color-frame]

Nous avons abordé dans le chapitre sur la régression logistique binaire
la problématique des valeurs manquantes lors d'une sélection pas à pas
descendante par minimisation de l'AIC (cf.~encadré de la
Section~\ref{sec-step} ). La même approche peut être appliquée avec des
données pondérées. Cependant, la fonction \texttt{step\_with\_na()} que
nous avons présenté n'est pas compatible avec les modèles
\texttt{survey::svyglm()} puisqu'ils prennent en entrée un argument
\texttt{design} et non \texttt{data}.

\end{tcolorbox}

\hypertarget{affichage-des-ruxe9sultats}{%
\section{Affichage des résultats}\label{affichage-des-ruxe9sultats}}

Nous pouvons tout à fait utiliser \texttt{gtsumarry::tbl\_regression()}
avec ce type de modèles. De même, on peut utiliser
\texttt{gtsummary::add\_global\_p()} pour calculer les p-valeurs
globales des variables ou encore \texttt{gtsummary::add\_vif()} pour
vérifier la multicolinéarité (cf. Chapitre~\ref{sec-multicolinearite}).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(gtsummary)}
\FunctionTok{theme\_gtsummary\_language}\NormalTok{(}\StringTok{"fr"}\NormalTok{, }\AttributeTok{decimal.mark =} \StringTok{","}\NormalTok{, }\AttributeTok{big.mark =} \StringTok{" "}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tbl\_regression}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_global\_p}\NormalTok{(}\AttributeTok{keep =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{add\_vif}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{bold\_labels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Warning in printHypothesis(L, rhs, names(b)): one or more coefficients in the hypothesis include
     arithmetic operators in their names;
  the printed representation of the hypothesis will be omitted

Warning in printHypothesis(L, rhs, names(b)): one or more coefficients in the hypothesis include
     arithmetic operators in their names;
  the printed representation of the hypothesis will be omitted
\end{verbatim}

\begin{verbatim}
Table printed with `knitr::kable()`, not {gt}. Learn why at
https://www.danieldsjoberg.com/gtsummary/articles/rmarkdown.html
To suppress this message, include `message = FALSE` in code chunk header.
\end{verbatim}

\hypertarget{tbl-regression-logistique-ponderee}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.3333}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.0833}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1354}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1458}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1042}}
  >{\centering\arraybackslash}p{(\columnwidth - 10\tabcolsep) * \real{0.1979}}@{}}
\caption{\label{tbl-regression-logistique-ponderee}Facteurs associés à
la pratique d'un sport (régression logistique pondérée)}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{OR}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{GVIF}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Adjusted GVIF}
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Caractéristique}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{OR}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{95\% IC}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{p-valeur}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{GVIF}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Adjusted GVIF}
\end{minipage} \\
\midrule()
\endhead
\textbf{Sexe} & & & 0,005 & 1,0 & 1,0 \\
Femme & --- & --- & & & \\
Homme & 1,44 & 1,12 -- 1,87 & 0,005 & & \\
\textbf{Groupe d'âges} & & & \textless0,001 & 2,1 & 1,1 \\
18-24 ans & --- & --- & & & \\
25-44 ans & 0,85 & 0,48 -- 1,51 & 0,6 & & \\
45-64 ans & 0,40 & 0,22 -- 0,73 & 0,003 & & \\
65 ans et plus & 0,37 & 0,19 -- 0,72 & 0,004 & & \\
\textbf{Niveau d'études} & & & \textless0,001 & 2,2 & 1,1 \\
Primaire & --- & --- & & & \\
Secondaire & 2,66 & 1,62 -- 4,38 & \textless0,001 & & \\
Technique / Professionnel & 3,09 & 1,90 -- 5,00 & \textless0,001 & & \\
Supérieur & 6,54 & 3,99 -- 10,7 & \textless0,001 & & \\
Non documenté & 10,3 & 4,60 -- 23,0 & \textless0,001 & & \\
\textbf{Heures de télévision / jour} & 0,89 & 0,82 -- 0,97 & 0,006 & 1,1
& 1,0 \\
\bottomrule()
\end{longtable}

Pour un graphique des coefficients, nous pouvons utiliser
\texttt{ggstats::ggcoef\_model()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2 }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  ggstats}\SpecialCharTok{::}\FunctionTok{ggcoef\_model}\NormalTok{(}\AttributeTok{exponentiate =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{donnees_ponderees/regression-logistique-binaire-ponderee_files/figure-pdf/fig-forest-plot-regression-logistique-ponderee-1.pdf}

}

\caption{\label{fig-forest-plot-regression-logistique-ponderee}Facteurs
associés à la pratique d'un sport (régression logistique pondérée)}

\end{figure}

\hypertarget{pruxe9dictions-marginales}{%
\section{Prédictions marginales}\label{pruxe9dictions-marginales}}

Pour visualiser les prédictions marginales moyennes du modèle (cf.
Section~\ref{sec-predictions-marginales}), nous pouvons utiliser
\texttt{broom.helpers::plot\_marginal\_predictions()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod2 }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  broom.helpers}\SpecialCharTok{::}\FunctionTok{plot\_marginal\_predictions}\NormalTok{(}\AttributeTok{type =} \StringTok{"response"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  patchwork}\SpecialCharTok{::}\FunctionTok{wrap\_plots}\NormalTok{() }\SpecialCharTok{\&}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, .}\DecValTok{8}\NormalTok{),}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_percent}\NormalTok{()}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics{donnees_ponderees/regression-logistique-binaire-ponderee_files/figure-pdf/fig-predictions-marginales-moyennes-regression-ponderee-1.pdf}

}

\caption{\label{fig-predictions-marginales-moyennes-regression-ponderee}Prédictions
marginales moyennes du modèle pondéré}

\end{figure}

\part{\textbf{Manipulation avancée}}

\hypertarget{sec-fusion_tables}{%
\chapter{Fusion de tables}\label{sec-fusion_tables}}

Il est fréquent d'avoir à gérer des données réparties dans plusieurs
tables de données, notamment lorsque l'on a une enquêtes réalisée à
différents niveaux (par exemple, un questionnaire ménage et un
questionnaire individu) ou des données longitudinales.

On peut distinguer deux types d'actions~:

\begin{itemize}
\tightlist
\item
  l'ajout de variables (jointure entre tables)
\item
  l'ajout d'observations (concaténation de tables)
\end{itemize}

\hypertarget{jointures-avec-dplyr}{%
\section{Jointures avec dplyr}\label{jointures-avec-dplyr}}

Le jeu de données \texttt{\{nycflights13\}} est un exemple de données
réparties en plusieurs tables. Ici on en a trois~: les informations sur
les vols, celles sur les aéroports et celles sur les compagnies
aériennes sont dans trois tables distinctes.

\texttt{\{dplyr\}} propose différentes fonctions permettant de
travailler avec des données structurées de cette manière.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(nycflights13)}
\FunctionTok{data}\NormalTok{(flights)}
\FunctionTok{data}\NormalTok{(airports)}
\FunctionTok{data}\NormalTok{(airlines)}
\end{Highlighting}
\end{Shaded}

\hypertarget{cluxe9s-implicites}{%
\subsection{Clés implicites}\label{cluxe9s-implicites}}

Lorsque les données sont réparties dans plusieurs tables différentes, il
est essentiel de repérer les identifiants permettant de naviguer d'une
table à l'autre. Dans notre exemple, on peut voir que la table
\texttt{flights} contient le code de la compagnie aérienne du vol dans
la variable \emph{carrier}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}}\NormalTok{ labelled}\SpecialCharTok{::}\FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable       label col_type missing values
 1   year           —     int      0             
 2   month          —     int      0             
 3   day            —     int      0             
 4   dep_time       —     int      8255          
 5   sched_dep_time —     int      0             
 6   dep_delay      —     dbl      8255          
 7   arr_time       —     int      8713          
 8   sched_arr_time —     int      0             
 9   arr_delay      —     dbl      9430          
 10  carrier        —     chr      0             
 11  flight         —     int      0             
 12  tailnum        —     chr      2512          
 13  origin         —     chr      0             
 14  dest           —     chr      0             
 15  air_time       —     dbl      9430          
 16  distance       —     dbl      0             
 17  hour           —     dbl      0             
 18  minute         —     dbl      0             
 19  time_hour      —     dttm     0             
\end{verbatim}

Et que par ailleurs la table \texttt{airlines} contient une information
supplémentaire relative à ces compagnies, à savoir le nom complet.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{airlines }\SpecialCharTok{|\textgreater{}}\NormalTok{ labelled}\SpecialCharTok{::}\FunctionTok{look\_for}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 pos variable label col_type missing values
 1   carrier  —     chr      0             
 2   name     —     chr      0             
\end{verbatim}

Il est donc naturel de vouloir associer les deux, en l'occurrence pour
ajouter les noms complets des compagnies à la table \texttt{flights}.
Dans ce cas on va faire une \emph{jointure}~: les lignes d'une table
seront associées à une autre en se basant non pas sur leur position,
mais sur les valeurs d'une ou plusieurs colonnes. Ces colonnes sont
appelées des \emph{clés}.

Pour faire une jointure de ce type, on va utiliser la fonction
\texttt{dplyr::left\_join()}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fusion }\OtherTok{\textless{}{-}}\NormalTok{ flights }\SpecialCharTok{|\textgreater{}} \FunctionTok{left\_join}\NormalTok{(airlines)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Joining with `by = join_by(carrier)`
\end{verbatim}

Pour faciliter la lecture, on va afficher seulement certaines colonnes
du résultat et les premières lignes de la table~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fusion }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(month, day, carrier, name) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{head}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 10 x 4
   month   day carrier name                    
   <int> <int> <chr>   <chr>                   
 1     1     1 UA      United Air Lines Inc.   
 2     1     1 UA      United Air Lines Inc.   
 3     1     1 AA      American Airlines Inc.  
 4     1     1 B6      JetBlue Airways         
 5     1     1 DL      Delta Air Lines Inc.    
 6     1     1 UA      United Air Lines Inc.   
 7     1     1 B6      JetBlue Airways         
 8     1     1 EV      ExpressJet Airlines Inc.
 9     1     1 B6      JetBlue Airways         
10     1     1 AA      American Airlines Inc.  
\end{verbatim}

On voit que la table obtenue est bien la fusion des deux tables
d'origine selon les valeurs des deux colonnes clés \emph{carrier}. On
est parti de la table \texttt{flights}, et pour chaque ligne on a ajouté
les colonnes de \texttt{airlines} pour lesquelles la valeur de
\emph{carrier} est la même. On a donc bien une nouvelle colonne
\texttt{name} dans notre table résultat, avec le nom complet de la
compagnie aérienne.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-note-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, bottomrule=.15mm, colframe=quarto-callout-note-color-frame]

Nous sommes ici dans le cas le plus simple concernant les clés de
jointure~: les deux clés sont uniques et portent le même nom dans les
deux tables. Par défaut, si on ne lui spécifie pas explicitement les
clés, \texttt{\{dplyr\}} fusionne en utilisant l'ensemble des colonnes
communes aux deux tables. On peut d'ailleurs voir dans cet exemple qu'un
message a été affiché précisant que la jointure s'est faite sur la
variable \emph{carrier}.

\end{tcolorbox}

\hypertarget{cluxe9s-explicites}{%
\subsection{Clés explicites}\label{cluxe9s-explicites}}

La table \texttt{airports}, elle, contient des informations
supplémentaires sur les aéroports~: nom complet, altitude, position
géographique, etc. Chaque aéroport est identifié par un code contenu
dans la colonne \emph{faa}.

Si on regarde la table \texttt{flights}, on voit que le code
d'identification des aéroports apparaît à deux endroits différents~:
pour l'aéroport de départ dans la colonne \emph{origin}, et pour celui
d'arrivée dans la colonne \emph{dest}. On a donc deux clés de jointures
possibles, et qui portent un nom différent de la clé de
\texttt{airports}.

On va commencer par fusionner les données concernant l'aéroport de
départ. Pour simplifier l'affichage des résultats, on va se contenter
d'un sous-ensemble des deux tables~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights\_ex }\OtherTok{\textless{}{-}}\NormalTok{ flights }\SpecialCharTok{|\textgreater{}} \FunctionTok{select}\NormalTok{(month, day, origin, dest)}
\NormalTok{airports\_ex }\OtherTok{\textless{}{-}}\NormalTok{ airports }\SpecialCharTok{|\textgreater{}} \FunctionTok{select}\NormalTok{(faa, alt, name)}
\end{Highlighting}
\end{Shaded}

Si on se contente d'un \texttt{dplyr::left\_join()} comme à l'étape
précédente, on obtient un message d'erreur car aucune colonne commune ne
peut être identifiée comme clé de jointure~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights\_ex }\SpecialCharTok{|\textgreater{}} \FunctionTok{left\_join}\NormalTok{(airports\_ex)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Error in `left_join()`:
! `by` must be supplied when `x` and `y` have no common variables.
i Use `cross_join()` to perform a cross-join.
\end{verbatim}

On doit donc spécifier explicitement les clés avec l'argument
\texttt{by} de \texttt{dplyr::left\_join()}. Ici la clé est nommée
\emph{origin} dans la première table, et \emph{faa} dans la seconde. La
syntaxe est donc la suivante~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights\_ex }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{left\_join}\NormalTok{(airports\_ex, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"origin"} \OtherTok{=} \StringTok{"faa"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{head}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 10 x 6
   month   day origin dest    alt name               
   <int> <int> <chr>  <chr> <dbl> <chr>              
 1     1     1 EWR    IAH      18 Newark Liberty Intl
 2     1     1 LGA    IAH      22 La Guardia         
 3     1     1 JFK    MIA      13 John F Kennedy Intl
 4     1     1 JFK    BQN      13 John F Kennedy Intl
 5     1     1 LGA    ATL      22 La Guardia         
 6     1     1 EWR    ORD      18 Newark Liberty Intl
 7     1     1 EWR    FLL      18 Newark Liberty Intl
 8     1     1 LGA    IAD      22 La Guardia         
 9     1     1 JFK    MCO      13 John F Kennedy Intl
10     1     1 LGA    ORD      22 La Guardia         
\end{verbatim}

On constate que les deux nouvelles colonnes \emph{name} et \emph{alt}
contiennent bien les données correspondant à l'aéroport de départ.

On va stocker le résultat de cette jointure dans \texttt{flights\_ex}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights\_ex }\OtherTok{\textless{}{-}}\NormalTok{ flights\_ex }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{left\_join}\NormalTok{(airports\_ex, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"origin"} \OtherTok{=} \StringTok{"faa"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

Supposons qu'on souhaite maintenant fusionner à nouveau les informations
de la table \texttt{airports}, mais cette fois pour les aéroports
d'arrivée de notre nouvelle table \texttt{flights\_ex}. Les deux clés
sont donc désormais \emph{dest} dans la première table, et \emph{faa}
dans la deuxième. La syntaxe est donc la suivante~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights\_ex }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{left\_join}\NormalTok{(airports\_ex, }\AttributeTok{by=}\FunctionTok{c}\NormalTok{(}\StringTok{"dest"} \OtherTok{=} \StringTok{"faa"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{head}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 10 x 8
   month   day origin dest  alt.x name.x              alt.y name.y              
   <int> <int> <chr>  <chr> <dbl> <chr>               <dbl> <chr>               
 1     1     1 EWR    IAH      18 Newark Liberty Intl    97 George Bush Interco~
 2     1     1 LGA    IAH      22 La Guardia             97 George Bush Interco~
 3     1     1 JFK    MIA      13 John F Kennedy Intl     8 Miami Intl          
 4     1     1 JFK    BQN      13 John F Kennedy Intl    NA <NA>                
 5     1     1 LGA    ATL      22 La Guardia           1026 Hartsfield Jackson ~
 6     1     1 EWR    ORD      18 Newark Liberty Intl   668 Chicago Ohare Intl  
 7     1     1 EWR    FLL      18 Newark Liberty Intl     9 Fort Lauderdale Hol~
 8     1     1 LGA    IAD      22 La Guardia            313 Washington Dulles I~
 9     1     1 JFK    MCO      13 John F Kennedy Intl    96 Orlando Intl        
10     1     1 LGA    ORD      22 La Guardia            668 Chicago Ohare Intl  
\end{verbatim}

Cela fonctionne, les informations de l'aéroport d'arrivée ont bien été
ajoutées, mais on constate que les colonnes ont été renommées. En effet,
ici les deux tables fusionnées contenaient toutes les deux des colonnes
\emph{name} et \emph{alt}. Comme on ne peut pas avoir deux colonnes avec
le même nom dans un tableau, \texttt{\{dplyr\}} a renommé les colonnes
de la première table en \emph{name.x} et \emph{alt.x}, et celles de la
deuxième en \emph{name.y} et \emph{alt.y}.

C'est pratique, mais pas forcément très parlant. On pourrait renommer
manuellement les colonnes pour avoir des intitulés plus explicites avec
\texttt{dplyr::rename()}, mais on peut aussi utiliser l'argument
\texttt{suffix} de \texttt{dplyr::left\_join()}, qui permet d'indiquer
les suffixes à ajouter aux colonnes. Ainsi, on peut faire~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights\_ex }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{left\_join}\NormalTok{(}
\NormalTok{    airports\_ex, }
    \AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"dest"} \OtherTok{=} \StringTok{"faa"}\NormalTok{), }
    \AttributeTok{suffix =} \FunctionTok{c}\NormalTok{(}\StringTok{"\_depart"}\NormalTok{, }\StringTok{"\_arrivee"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{head}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 10 x 8
   month   day origin dest  alt_depart name_depart      alt_arrivee name_arrivee
   <int> <int> <chr>  <chr>      <dbl> <chr>                  <dbl> <chr>       
 1     1     1 EWR    IAH           18 Newark Liberty ~          97 George Bush~
 2     1     1 LGA    IAH           22 La Guardia                97 George Bush~
 3     1     1 JFK    MIA           13 John F Kennedy ~           8 Miami Intl  
 4     1     1 JFK    BQN           13 John F Kennedy ~          NA <NA>        
 5     1     1 LGA    ATL           22 La Guardia              1026 Hartsfield ~
 6     1     1 EWR    ORD           18 Newark Liberty ~         668 Chicago Oha~
 7     1     1 EWR    FLL           18 Newark Liberty ~           9 Fort Lauder~
 8     1     1 LGA    IAD           22 La Guardia               313 Washington ~
 9     1     1 JFK    MCO           13 John F Kennedy ~          96 Orlando Intl
10     1     1 LGA    ORD           22 La Guardia               668 Chicago Oha~
\end{verbatim}

On obtient ainsi directement des noms de colonnes nettement plus clairs.

\hypertarget{types-de-jointures}{%
\subsection{Types de jointures}\label{types-de-jointures}}

Jusqu'à présent nous avons utilisé la fonction
\texttt{dplyr::left\_join()}, mais il existe plusieurs types de
jointures.

Partons de deux tables d'exemple, \texttt{personnes} et
\texttt{voitures}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{personnes }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(}
  \AttributeTok{nom =} \FunctionTok{c}\NormalTok{(}\StringTok{"Sylvie"}\NormalTok{, }\StringTok{"Sylvie"}\NormalTok{, }\StringTok{"Monique"}\NormalTok{, }\StringTok{"Gunter"}\NormalTok{, }\StringTok{"Rayan"}\NormalTok{, }\StringTok{"Rayan"}\NormalTok{),}
  \AttributeTok{voiture =} \FunctionTok{c}\NormalTok{(}\StringTok{"Twingo"}\NormalTok{, }\StringTok{"Ferrari"}\NormalTok{, }\StringTok{"Scenic"}\NormalTok{, }\StringTok{"Lada"}\NormalTok{, }\StringTok{"Twingo"}\NormalTok{, }\StringTok{"Clio"}\NormalTok{)}
\NormalTok{)}
\NormalTok{personnes}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 6 x 2
  nom     voiture
  <chr>   <chr>  
1 Sylvie  Twingo 
2 Sylvie  Ferrari
3 Monique Scenic 
4 Gunter  Lada   
5 Rayan   Twingo 
6 Rayan   Clio   
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{voitures }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(}
  \AttributeTok{voiture =} \FunctionTok{c}\NormalTok{(}\StringTok{"Twingo"}\NormalTok{, }\StringTok{"Ferrari"}\NormalTok{, }\StringTok{"Clio"}\NormalTok{, }\StringTok{"Lada"}\NormalTok{, }\StringTok{"208"}\NormalTok{),}
  \AttributeTok{vitesse =} \FunctionTok{c}\NormalTok{(}\StringTok{"140"}\NormalTok{, }\StringTok{"280"}\NormalTok{, }\StringTok{"160"}\NormalTok{, }\StringTok{"85"}\NormalTok{, }\StringTok{"160"}\NormalTok{)}
\NormalTok{)}
\NormalTok{voitures}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 2
  voiture vitesse
  <chr>   <chr>  
1 Twingo  140    
2 Ferrari 280    
3 Clio    160    
4 Lada    85     
5 208     160    
\end{verbatim}

\hypertarget{left_join}{%
\subsubsection{\texorpdfstring{\texttt{left\_join()}}{left\_join()}}\label{left_join}}

Si on fait un \texttt{dplyr::left\_join()} de \texttt{voitures} sur
\texttt{personnes}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{personnes }\SpecialCharTok{|\textgreater{}} \FunctionTok{left\_join}\NormalTok{(voitures, }\AttributeTok{by =} \StringTok{"voiture"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 6 x 3
  nom     voiture vitesse
  <chr>   <chr>   <chr>  
1 Sylvie  Twingo  140    
2 Sylvie  Ferrari 280    
3 Monique Scenic  <NA>   
4 Gunter  Lada    85     
5 Rayan   Twingo  140    
6 Rayan   Clio    160    
\end{verbatim}

On voit que chaque ligne de \texttt{personnes} est bien présente, et
qu'on lui a ajouté une ligne de \texttt{voitures} correspondante si elle
existe. Dans le cas du \emph{Scenic}, il n'y a avait pas de ligne dans
\texttt{voitures}, donc \emph{vitesse} a été peuplée avec la valeur
manquante \texttt{NA}. Dans le cas de la \emph{208}, présente dans
\texttt{voitures} mais pas dans \texttt{personnes}, la ligne n'apparaît
pas.

La clé de fusion étant unique dans la table de droite, le nombre de
lignes de la table de gauche est donc bien préservée.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{personnes }\SpecialCharTok{|\textgreater{}} \FunctionTok{nrow}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{personnes }\SpecialCharTok{|\textgreater{}} \FunctionTok{left\_join}\NormalTok{(voitures, }\AttributeTok{by =} \StringTok{"voiture"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} \FunctionTok{nrow}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 6
\end{verbatim}

Si on fait un \texttt{dplyr::left\_join()} cette fois de
\texttt{personnes} sur \texttt{voitures}, c'est l'inverse~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{voitures }\SpecialCharTok{|\textgreater{}} \FunctionTok{left\_join}\NormalTok{(personnes, }\AttributeTok{by =} \StringTok{"voiture"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 6 x 3
  voiture vitesse nom   
  <chr>   <chr>   <chr> 
1 Twingo  140     Sylvie
2 Twingo  140     Rayan 
3 Ferrari 280     Sylvie
4 Clio    160     Rayan 
5 Lada    85      Gunter
6 208     160     <NA>  
\end{verbatim}

La ligne \emph{208} est bien là avec la variable \emph{nom} remplie avec
une valeur manquante \texttt{NA}. Par contre \emph{Monique} est absente.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-important-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{Important}, bottomrule=.15mm, colframe=quarto-callout-important-color-frame]

On remarquera que la ligne \emph{Twingo}, présente deux fois dans
\texttt{personnes}, a été dupliquée pour être associée aux deux lignes
de données de \texttt{Sylvie} et \texttt{Rayan}. Autrement dit, si la
clé de fusion n'est pas unique dans la table de droite, certaines de
lignes de la table de gauche seront dupliquées.

\textbf{En résumé, quand on fait un \texttt{left\_join(x,\ y)}, toutes
les lignes de \texttt{x} sont présentes, et dupliquées si nécessaire
quand elles apparaissent plusieurs fois dans \texttt{y}. Les lignes de
\texttt{y} non présentes dans \texttt{x} disparaissent. Les lignes de
\texttt{x} non présentes dans \texttt{y} se voient attribuer des valeurs
manquantes \texttt{NA} pour les nouvelles colonnes.}

\end{tcolorbox}

Intuitivement, on pourrait considérer que \texttt{left\_join(x,\ y)}
signifie ramener l'information de la table \texttt{y} sur la table
\texttt{x}.

En général, \texttt{dplyr::left\_join()} sera le type de jointures le
plus fréquemment utilisé.

\hypertarget{right_join}{%
\subsubsection{\texorpdfstring{\texttt{right\_join()}}{right\_join()}}\label{right_join}}

La jointure \texttt{dplyr::right\_join()} est l'exacte symétrique de
\texttt{dplyr::left\_join()}, c'est-à dire que
\texttt{x\ \textbar{}\textgreater{}\ right\_join(y)} est
équivalent\sidenote{\footnotesize À l'exception de l'ordre des variables dans le
  tableau final.} à
\texttt{y\ \textbar{}\textgreater{}\ left\_join(x)}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{personnes }\SpecialCharTok{|\textgreater{}} \FunctionTok{right\_join}\NormalTok{(voitures, }\AttributeTok{by =} \StringTok{"voiture"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 6 x 3
  nom    voiture vitesse
  <chr>  <chr>   <chr>  
1 Sylvie Twingo  140    
2 Sylvie Ferrari 280    
3 Gunter Lada    85     
4 Rayan  Twingo  140    
5 Rayan  Clio    160    
6 <NA>   208     160    
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{voitures }\SpecialCharTok{|\textgreater{}} \FunctionTok{left\_join}\NormalTok{(personnes, }\AttributeTok{by =} \StringTok{"voiture"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 6 x 3
  voiture vitesse nom   
  <chr>   <chr>   <chr> 
1 Twingo  140     Sylvie
2 Twingo  140     Rayan 
3 Ferrari 280     Sylvie
4 Clio    160     Rayan 
5 Lada    85      Gunter
6 208     160     <NA>  
\end{verbatim}

\hypertarget{inner_join}{%
\subsubsection{\texorpdfstring{\texttt{inner\_join()}}{inner\_join()}}\label{inner_join}}

Dans le cas de \texttt{dplyr::inner\_join()}, seules les lignes
présentes à la fois dans \texttt{x} et \texttt{y} sont présentes (et si
nécessaire dupliquées) dans la table résultat~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{personnes }\SpecialCharTok{|\textgreater{}} \FunctionTok{inner\_join}\NormalTok{(voitures, }\AttributeTok{by =} \StringTok{"voiture"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 3
  nom    voiture vitesse
  <chr>  <chr>   <chr>  
1 Sylvie Twingo  140    
2 Sylvie Ferrari 280    
3 Gunter Lada    85     
4 Rayan  Twingo  140    
5 Rayan  Clio    160    
\end{verbatim}

Ici la ligne \emph{208} est absente, ainsi que la ligne \emph{Monique},
qui dans le cas d'un \texttt{dplyr::left\_join()} avait été conservée et
s'était vue attribuer \texttt{NA} à \emph{vitesse}.

\hypertarget{full_join}{%
\subsubsection{\texorpdfstring{\texttt{full\_join()}}{full\_join()}}\label{full_join}}

Dans le cas de \texttt{dplyr::full\_join()}, toutes les lignes de
\texttt{x} et toutes les lignes de \texttt{y} sont conservées (avec des
\texttt{NA} ajoutés si nécessaire) même si elles sont absentes de
l'autre table~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{personnes }\SpecialCharTok{|\textgreater{}} \FunctionTok{full\_join}\NormalTok{(voitures, }\AttributeTok{by =} \StringTok{"voiture"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 7 x 3
  nom     voiture vitesse
  <chr>   <chr>   <chr>  
1 Sylvie  Twingo  140    
2 Sylvie  Ferrari 280    
3 Monique Scenic  <NA>   
4 Gunter  Lada    85     
5 Rayan   Twingo  140    
6 Rayan   Clio    160    
7 <NA>    208     160    
\end{verbatim}

\hypertarget{semi_join-et-anti_join}{%
\subsubsection{\texorpdfstring{\texttt{semi\_join()} et
\texttt{anti\_join()}}{semi\_join() et anti\_join()}}\label{semi_join-et-anti_join}}

\texttt{dplyr::semi\_join()} et \texttt{dplyr::anti\_join()} sont des
jointures \emph{filtrantes}, c'est-à-dire qu'elles sélectionnent les
lignes de \texttt{x} sans ajouter les colonnes de \texttt{y}.

Ainsi, \texttt{dplyr::semi\_join()} ne conservera que les lignes de
\texttt{x} pour lesquelles une ligne de \texttt{y} existe également, et
supprimera les autres. Dans notre exemple, la ligne \texttt{Monique} est
donc supprimée~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{personnes }\SpecialCharTok{|\textgreater{}} \FunctionTok{semi\_join}\NormalTok{(voitures, }\AttributeTok{by =} \StringTok{"voiture"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 5 x 2
  nom    voiture
  <chr>  <chr>  
1 Sylvie Twingo 
2 Sylvie Ferrari
3 Gunter Lada   
4 Rayan  Twingo 
5 Rayan  Clio   
\end{verbatim}

Un \texttt{dplyr::anti\_join()} fait l'inverse, il ne conserve que les
lignes de \texttt{x} absentes de \texttt{y}. Dans notre exemple, on ne
garde donc que la ligne \emph{Monique}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{personnes }\SpecialCharTok{|\textgreater{}} \FunctionTok{anti\_join}\NormalTok{(voitures, }\AttributeTok{by =} \StringTok{"voiture"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1 x 2
  nom     voiture
  <chr>   <chr>  
1 Monique Scenic 
\end{verbatim}

\hypertarget{jointures-avec-merge}{%
\section{\texorpdfstring{Jointures avec
\texttt{merge()}}{Jointures avec merge()}}\label{jointures-avec-merge}}

La fonction \texttt{merge()} est la fonction de \textbf{R base} pour
fusionner des tables entre elles.

Par défaut, elle réalise un \emph{inner join}, c'est-à-dire qu'elle ne
garde que les observations dont la clé est retrouvée dans les deux
tableaux fusionnés

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{merge}\NormalTok{(personnes, voitures, }\AttributeTok{by =} \StringTok{"voiture"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  voiture    nom vitesse
1    Clio  Rayan     160
2 Ferrari Sylvie     280
3    Lada Gunter      85
4  Twingo Sylvie     140
5  Twingo  Rayan     140
\end{verbatim}

Les paramètres \texttt{all.x} et \texttt{all.y} permettent de réaliser
fusions à gauche, à droite ou complète. L'équivalent de
\texttt{dplyr::left\_join()} sera obtenu avec \texttt{all.x\ =\ TRUE},
celui de \texttt{dplyr::right\_join()} avec \texttt{all.y\ =\ TRUE} et
celui de \texttt{dplyr::full\_join()} avec
\texttt{all.x\ =\ TRUE,\ all.y\ =\ TRUE}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{merge}\NormalTok{(personnes, voitures, }\AttributeTok{by =} \StringTok{"voiture"}\NormalTok{, }\AttributeTok{all.x =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  voiture     nom vitesse
1    Clio   Rayan     160
2 Ferrari  Sylvie     280
3    Lada  Gunter      85
4  Scenic Monique    <NA>
5  Twingo  Sylvie     140
6  Twingo   Rayan     140
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{personnes }\SpecialCharTok{|\textgreater{}} \FunctionTok{left\_join}\NormalTok{(voitures)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Joining with `by = join_by(voiture)`
\end{verbatim}

\begin{verbatim}
# A tibble: 6 x 3
  nom     voiture vitesse
  <chr>   <chr>   <chr>  
1 Sylvie  Twingo  140    
2 Sylvie  Ferrari 280    
3 Monique Scenic  <NA>   
4 Gunter  Lada    85     
5 Rayan   Twingo  140    
6 Rayan   Clio    160    
\end{verbatim}

\hypertarget{ajouter-des-observations-avec-bind_rows}{%
\section{\texorpdfstring{Ajouter des observations avec
\texttt{bind\_rows()}}{Ajouter des observations avec bind\_rows()}}\label{ajouter-des-observations-avec-bind_rows}}

La fonction \texttt{base::rbind()}, fournie nativement avec \textbf{R}
pour ajouter des observations à un tableau, doit être évitée car elle
générera des résultats non pertinents si les tableaux que l'on
concatènent n'ont pas exactement les mêmes colonnes dans le même ordre.

La fonction \texttt{dplyr::bind\_rows()} de \texttt{\{dplyr\}} permet
d'ajouter des lignes à une table à partir d'une ou plusieurs autres
tables.

L'exemple suivant (certes très artificiel) montre l'utilisation de
\texttt{dplyr::bind\_rows()}. On commence par créer trois tableaux
\texttt{t1}, \texttt{t2} et \texttt{t3}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t1 }\OtherTok{\textless{}{-}}\NormalTok{ airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(faa, name, lat, lon) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{slice}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{)}
\NormalTok{t1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 4
  faa   name                            lat   lon
  <chr> <chr>                         <dbl> <dbl>
1 04G   Lansdowne Airport              41.1 -80.6
2 06A   Moton Field Municipal Airport  32.5 -85.7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t2 }\OtherTok{\textless{}{-}}\NormalTok{ airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(name, faa, lon, lat) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{slice}\NormalTok{(}\DecValTok{5}\SpecialCharTok{:}\DecValTok{6}\NormalTok{)}

\NormalTok{t2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 4
  name                           faa     lon   lat
  <chr>                          <chr> <dbl> <dbl>
1 Jekyll Island Airport          09J   -81.4  31.1
2 Elizabethton Municipal Airport 0A9   -82.2  36.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t3 }\OtherTok{\textless{}{-}}\NormalTok{ airports }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(faa, name) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{slice}\NormalTok{(}\DecValTok{100}\SpecialCharTok{:}\DecValTok{101}\NormalTok{)}
\NormalTok{t3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 2
  faa   name             
  <chr> <chr>            
1 ADW   Andrews Afb      
2 AET   Allakaket Airport
\end{verbatim}

On concatène ensuite les trois tables avec
\texttt{dplyr::bind\_rows()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{bind\_rows}\NormalTok{(t1, t2, t3)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 6 x 4
  faa   name                             lat   lon
  <chr> <chr>                          <dbl> <dbl>
1 04G   Lansdowne Airport               41.1 -80.6
2 06A   Moton Field Municipal Airport   32.5 -85.7
3 09J   Jekyll Island Airport           31.1 -81.4
4 0A9   Elizabethton Municipal Airport  36.4 -82.2
5 ADW   Andrews Afb                     NA    NA  
6 AET   Allakaket Airport               NA    NA  
\end{verbatim}

On remarquera que si des colonnes sont manquantes pour certaines tables,
comme les colonnes \emph{lat} et \emph{lon} de \texttt{t3}, des valeurs
manquantes \texttt{NA} sont automatiquement insérées.

De plus, peu importe l'ordre des variables entre les différentes tables,
\texttt{dplyr::bind\_rows()} les réassociera en considérant que deux
colonnes ayant le même nom dans deux tableaux correspondent à la même
variable.

Il peut être utile, quand on concatène des lignes, de garder une trace
du tableau d'origine de chacune des lignes dans le tableau final. C'est
possible grâce à l'argument \texttt{.id} de
\texttt{dplyr::bind\_rows()}. On passe à cet argument le nom d'une
colonne qui contiendra l'indicateur d'origine des lignes~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{bind\_rows}\NormalTok{(t1, t2, t3, }\AttributeTok{.id =} \StringTok{"source"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 6 x 5
  source faa   name                             lat   lon
  <chr>  <chr> <chr>                          <dbl> <dbl>
1 1      04G   Lansdowne Airport               41.1 -80.6
2 1      06A   Moton Field Municipal Airport   32.5 -85.7
3 2      09J   Jekyll Island Airport           31.1 -81.4
4 2      0A9   Elizabethton Municipal Airport  36.4 -82.2
5 3      ADW   Andrews Afb                     NA    NA  
6 3      AET   Allakaket Airport               NA    NA  
\end{verbatim}

Par défaut la colonne \texttt{.id} ne contient qu'un nombre, différent
pour chaque tableau. On peut lui spécifier des valeurs plus explicites
en ``nommant'' les tables dans \texttt{dplyr::bind\_rows()} de la
manière suivante~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{bind\_rows}\NormalTok{(}\AttributeTok{table1 =}\NormalTok{ t1, }\AttributeTok{table2 =}\NormalTok{ t2, }\AttributeTok{table3 =}\NormalTok{ t3, }\AttributeTok{.id =} \StringTok{"source"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 6 x 5
  source faa   name                             lat   lon
  <chr>  <chr> <chr>                          <dbl> <dbl>
1 table1 04G   Lansdowne Airport               41.1 -80.6
2 table1 06A   Moton Field Municipal Airport   32.5 -85.7
3 table2 09J   Jekyll Island Airport           31.1 -81.4
4 table2 0A9   Elizabethton Municipal Airport  36.4 -82.2
5 table3 ADW   Andrews Afb                     NA    NA  
6 table3 AET   Allakaket Airport               NA    NA  
\end{verbatim}

Une alternative à \texttt{dplyr::bind\_rows()} est la fonction
\texttt{plyr::rbind.fill()} de l'extension \texttt{\{plyr\}} qui
fonctionne de manière similaire.

\hypertarget{sec-dates}{%
\chapter{\texorpdfstring{Dates avec
\texttt{lubridate}}{Dates avec lubridate}}\label{sec-dates}}

Dans cette section, nous aborderons la gestion des dates des heures dans
\textbf{R}. Si ce type de données peut paraître simple à première vue,
la situation se complique dès lors que l'on souhaite effectuer des
calculs entre dates. En effet, le nombre de jours varie d'un mois à un
autre, voir d'une année à l'autre si l'on tient compte des années
bissextiles. Quand on manipule des heures, il faut aussi pouvoir prendre
en compte les différents fuseaux horaires ainsi que les changements liés
à l'heure d'été.

Heureusement, le package \texttt{\{lubridate\}} permet de résoudre la
plupart des problèmes posés par la manipulation de date. Il est chargé
par défaut avec la commande \texttt{library(tidyverse)}. Nous allons
également charger en mémoire le package \texttt{\{nycflights13\}} qui
nous fournira les données utilisées dans nos exemples.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(nycflights13)}
\end{Highlighting}
\end{Shaded}

\hypertarget{cruxe9ation-de-dates-de-dates-heures}{%
\section{Création de dates / de
dates-heures}\label{cruxe9ation-de-dates-de-dates-heures}}

Il existe trois types de variables pour représenter des dates et des
heures~:

\begin{itemize}
\item
  une \textbf{date}, de la classe \texttt{Date} et représentée dans un
  tibble avec \texttt{\textless{}date\textgreater{}}
\item
  une \textbf{heure}, de la classe \texttt{hms} et représentée dans un
  tibble avec \texttt{\textless{}time\textgreater{}}
\item
  une \textbf{date-heure}, de la classe \texttt{POSIXct} et représentée
  dans un tibble avec \texttt{\textless{}dttm\textgreater{}}
\end{itemize}

Les classes \texttt{Date} et \texttt{POSIXct} sont gérées nativement par
\textbf{R} tandis que la classe \texttt{hms} est fournies par le package
homonyme \texttt{\{hms\}}. Cette dernière classe est d'un usage plus
spécifique. Dans cette section, nous allons nous concentrer sur les
dates et les dates-heures.

Il est toujours préférable d'utiliser la classe la plus simple. Si vous
gérez uniquement des dates, privilégiez la classe \texttt{Date}. La
classe \texttt{POSIXct}, plus complexe, permet d'ajouter une heure
associée à un fuseau horaire.

Pour obtenir la date ou la date-heure courante, vous pouvez appeler
\texttt{today()} ou \texttt{now()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{today}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2023-07-05"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{now}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2023-07-05 16:03:28 CEST"
\end{verbatim}

\hypertarget{lors-de-limport-dun-fichier-csv}{%
\subsection{lors de l'import d'un fichier
CSV}\label{lors-de-limport-dun-fichier-csv}}

Si le fichier CSV contient des dates ou des dates-heures au format
ISO8601, \texttt{readr::read\_csv()} saura les reconnaître
automatiquement~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{csv }\OtherTok{\textless{}{-}} \StringTok{"}
\StringTok{  date,datetime}
\StringTok{  2022{-}01{-}02,2022{-}01{-}02 05:12}
\StringTok{"}
\FunctionTok{read\_csv}\NormalTok{(csv)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1 x 2
  date       datetime           
  <date>     <dttm>             
1 2022-01-02 2022-01-02 05:12:00
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Le format
\href{https://fr.wikipedia.org/wiki/ISO_8601}{\textbf{ISO8601}} est un
standard international pour l'écriture de dates\sidenote{\footnotesize \url{https://xkcd.com/1179/}}
sous la forme \texttt{AAAA-MM-JJ} afin d'éviter la confusion entre les
habitudes de différents pays, par exemple \texttt{JJ/MM/AAAA} en France
ou \texttt{MM/JJ/AA} dans les pays anglosaxons.

\end{tcolorbox}

Pour les autres formats, non standards, il sera nécessaire d'utiliser
\texttt{col\_types} avec \texttt{col\_date()} pour spécifier comme lire
et interpréter les chaînes de caractères. \texttt{\{readr\}} comprend la
spécification \textbf{POSIX} qui permet de décrire une format de
date\sidenote{\footnotesize La spécification complète est décrite dans l'aide de la
  fonction \texttt{strptime()}.}. Il s'agit de codes commençant par le
symbole \texttt{\%} et indiquant un composant d'une date. Par exemple,
\texttt{\%Y-\%m-\%d} correspond au format ISO8601, par exemple
\texttt{2023-10-03} pour le 3 octobre 2023. Le tableau
Table~\ref{tbl-date-formats} liste les principales options.

\hypertarget{tbl-date-formats}{}
\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1918}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1918}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.4247}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.1918}}@{}}
\caption{\label{tbl-date-formats}Les formats de dates compris par
readr}\tabularnewline
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
Type
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Code
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Signification
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Exemple
\end{minipage} \\
\midrule()
\endfirsthead
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
Type
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Code
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Signification
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Exemple
\end{minipage} \\
\midrule()
\endhead
Année & \texttt{\%Y} & année sur 4 chiffres & 2021 \\
& \texttt{\%y} & année sur 2 chiffres & 21 \\
Mois & \texttt{\%m} & numéro du mois & 2 \\
& \texttt{\%b} & nom abrégé & Feb \\
& \texttt{\%B} & nom complet & February \\
Jour & \texttt{\%d} & jour sur 2 chiffres & 02 \\
& \texttt{\%e} & jour sur 1 ou 2 chiffres & 2 \\
Heure & \texttt{\%H} & heure sur 24 heures & 13 \\
& \texttt{\%I} & heure sur 12 heures & 1 \\
& \texttt{\%p} & AM ou PM & pm \\
Minute & \texttt{\%M} & minutes & 35 \\
Seconde & \texttt{\%S} & secondes & 45 \\
& \texttt{\%OS} & secondes avec une composante décimale & 45.35 \\
Fuseau horaire & \texttt{\%Z} & nom du fuseau & America/Chicago \\
& \texttt{\%z} & décalage du fuseau par rapport au temps universel UTC &
+0800 \\
Autre & \texttt{\%.} & sauter un caractère (autre qu'un chiffre) & : \\
& \texttt{\%*} & sauter un nombre quelconque de caractères (autres qu'un
chiffre) & \\
\bottomrule()
\end{longtable}

Et voici un exemple de code induisant une lecture différente d'une date
ambiguë.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{csv }\OtherTok{\textless{}{-}} \StringTok{"}
\StringTok{  date}
\StringTok{  01/02/15}
\StringTok{"}

\FunctionTok{read\_csv}\NormalTok{(csv, }\AttributeTok{col\_types =} \FunctionTok{cols}\NormalTok{(}\AttributeTok{date =} \FunctionTok{col\_date}\NormalTok{(}\StringTok{"\%m/\%d/\%y"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1 x 1
  date      
  <date>    
1 2015-01-02
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{read\_csv}\NormalTok{(csv, }\AttributeTok{col\_types =} \FunctionTok{cols}\NormalTok{(}\AttributeTok{date =} \FunctionTok{col\_date}\NormalTok{(}\StringTok{"\%d/\%m/\%y"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1 x 1
  date      
  <date>    
1 2015-02-01
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{read\_csv}\NormalTok{(csv, }\AttributeTok{col\_types =} \FunctionTok{cols}\NormalTok{(}\AttributeTok{date =} \FunctionTok{col\_date}\NormalTok{(}\StringTok{"\%y/\%m/\%d"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1 x 1
  date      
  <date>    
1 2001-02-15
\end{verbatim}

Quel que soit le format original, les dates importées seront toujours
affichées par \textbf{R} au format ISO.

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Si vous utilisez \texttt{\%b} ou \texttt{\%B}, il est essentiel de
spécifier la langue utilisée avec le paramètre \texttt{local} de
\texttt{col\_date()}. Pour voir l'ensemble des langues couvertes, vous
pouvez appelez \texttt{readr::date\_names\_langs()} et pour voir les
chaînes de langues correspondantes \texttt{readr::date\_names\_lang()}.
Si vos données n'utilise pas des noms standards, vous pouvez créer votre
propre jeu de correspondance avec \texttt{readr::date\_names()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{date\_names\_langs}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  [1] "af"  "agq" "ak"  "am"  "ar"  "as"  "asa" "az"  "bas" "be"  "bem" "bez"
 [13] "bg"  "bm"  "bn"  "bo"  "br"  "brx" "bs"  "ca"  "cgg" "chr" "cs"  "cy" 
 [25] "da"  "dav" "de"  "dje" "dsb" "dua" "dyo" "dz"  "ebu" "ee"  "el"  "en" 
 [37] "eo"  "es"  "et"  "eu"  "ewo" "fa"  "ff"  "fi"  "fil" "fo"  "fr"  "fur"
 [49] "fy"  "ga"  "gd"  "gl"  "gsw" "gu"  "guz" "gv"  "ha"  "haw" "he"  "hi" 
 [61] "hr"  "hsb" "hu"  "hy"  "id"  "ig"  "ii"  "is"  "it"  "ja"  "jgo" "jmc"
 [73] "ka"  "kab" "kam" "kde" "kea" "khq" "ki"  "kk"  "kkj" "kl"  "kln" "km" 
 [85] "kn"  "ko"  "kok" "ks"  "ksb" "ksf" "ksh" "kw"  "ky"  "lag" "lb"  "lg" 
 [97] "lkt" "ln"  "lo"  "lt"  "lu"  "luo" "luy" "lv"  "mas" "mer" "mfe" "mg" 
[109] "mgh" "mgo" "mk"  "ml"  "mn"  "mr"  "ms"  "mt"  "mua" "my"  "naq" "nb" 
[121] "nd"  "ne"  "nl"  "nmg" "nn"  "nnh" "nus" "nyn" "om"  "or"  "os"  "pa" 
[133] "pl"  "ps"  "pt"  "qu"  "rm"  "rn"  "ro"  "rof" "ru"  "rw"  "rwk" "sah"
[145] "saq" "sbp" "se"  "seh" "ses" "sg"  "shi" "si"  "sk"  "sl"  "smn" "sn" 
[157] "so"  "sq"  "sr"  "sv"  "sw"  "ta"  "te"  "teo" "th"  "ti"  "to"  "tr" 
[169] "twq" "tzm" "ug"  "uk"  "ur"  "uz"  "vai" "vi"  "vun" "wae" "xog" "yav"
[181] "yi"  "yo"  "zgh" "zh"  "zu" 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{date\_names\_lang}\NormalTok{(}\StringTok{"fr"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<date_names>
Days:   dimanche (dim.), lundi (lun.), mardi (mar.), mercredi (mer.), jeudi
        (jeu.), vendredi (ven.), samedi (sam.)
Months: janvier (janv.), février (févr.), mars (mars), avril (avr.), mai (mai),
        juin (juin), juillet (juil.), août (août), septembre (sept.),
        octobre (oct.), novembre (nov.), décembre (déc.)
AM/PM:  AM/PM
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{date\_names\_lang}\NormalTok{(}\StringTok{"en"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<date_names>
Days:   Sunday (Sun), Monday (Mon), Tuesday (Tue), Wednesday (Wed), Thursday
        (Thu), Friday (Fri), Saturday (Sat)
Months: January (Jan), February (Feb), March (Mar), April (Apr), May (May),
        June (Jun), July (Jul), August (Aug), September (Sep), October
        (Oct), November (Nov), December (Dec)
AM/PM:  AM/PM
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{csv }\OtherTok{\textless{}{-}} \StringTok{"date}
\StringTok{3 de febrero de 2001"}

\FunctionTok{read\_csv}\NormalTok{(}
\NormalTok{  csv,}
  \AttributeTok{col\_types =} \FunctionTok{cols}\NormalTok{(}\AttributeTok{date =} \FunctionTok{col\_date}\NormalTok{(}\StringTok{"\%d de \%B de \%Y"}\NormalTok{)),}
  \AttributeTok{locale =} \FunctionTok{locale}\NormalTok{(}\StringTok{"es"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1 x 1
  date      
  <date>    
1 2001-02-03
\end{verbatim}

\end{tcolorbox}

\hypertarget{uxe0-partir-dune-chauxeene-de-caractuxe8res}{%
\subsection{à partir d'une chaîne de
caractères}\label{uxe0-partir-dune-chauxeene-de-caractuxe8res}}

Le langage de spécification de la date et du temps est puissant, mais il
nécessite une analyse minutieuse du format de la date. Une autre
approche consiste à utiliser les fonctions de \texttt{\{lubridate\}} qui
tentent de déterminer automatiquement le format une fois que vous avez
spécifié l'ordre des composants. Pour les utiliser, identifiez l'ordre
dans lequel l'année, le mois et le jour apparaissent dans vos dates,
puis placez ``y'', ``m'' et ``d'' dans le même ordre. Cela vous donne le
nom de la fonction \texttt{\{lubridate\}} qui analysera votre date. Par
exemple :

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ymd}\NormalTok{(}\StringTok{"2017{-}01{-}31"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2017-01-31"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mdy}\NormalTok{(}\StringTok{"January 31st, 2017"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2017-01-31"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dmy}\NormalTok{(}\StringTok{"31{-}Jan{-}2017"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2017-01-31"
\end{verbatim}

\texttt{ymd()} et ses soeurs crééent des dates. Pour des dates-heures,
ajoutez un tiret bas et les lettres ``h'', ``m'' et/ou ``s''~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ymd\_hms}\NormalTok{(}\StringTok{"2017{-}01{-}31 20:11:59"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2017-01-31 20:11:59 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mdy\_hm}\NormalTok{(}\StringTok{"01/31/2017 08:01"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2017-01-31 08:01:00 UTC"
\end{verbatim}

\hypertarget{uxe0-partir-des-composants}{%
\subsection{à partir des composants}\label{uxe0-partir-des-composants}}

Parfois, les différentes composantes d'une date (jour, mois,
année\ldots) sont stockées dans des colonnes séparées. C'est le cas par
exemple dans la table \texttt{flights} issue du package
\texttt{\{nycflights13\}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(year, month, day, hour, minute) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 6 x 5
   year month   day  hour minute
  <int> <int> <int> <dbl>  <dbl>
1  2013     1     1     5     15
2  2013     1     1     5     29
3  2013     1     1     5     40
4  2013     1     1     5     45
5  2013     1     1     6      0
6  2013     1     1     5     58
\end{verbatim}

Pour créer une date ou une date-heure à partir de colonnes séparées, il
suffit d'utiliser \texttt{lubridate::make\_date()} pour les dates et
\texttt{lubridate::make\_datetime()} pour les dates-heures~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flights }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(year, month, day, hour, minute) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{departure =} \FunctionTok{make\_datetime}\NormalTok{(year, month, day, hour, minute),}
    \AttributeTok{departure\_date =} \FunctionTok{make\_date}\NormalTok{(year, month, day)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{head}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 6 x 7
   year month   day  hour minute departure           departure_date
  <int> <int> <int> <dbl>  <dbl> <dttm>              <date>        
1  2013     1     1     5     15 2013-01-01 05:15:00 2013-01-01    
2  2013     1     1     5     29 2013-01-01 05:29:00 2013-01-01    
3  2013     1     1     5     40 2013-01-01 05:40:00 2013-01-01    
4  2013     1     1     5     45 2013-01-01 05:45:00 2013-01-01    
5  2013     1     1     6      0 2013-01-01 06:00:00 2013-01-01    
6  2013     1     1     5     58 2013-01-01 05:58:00 2013-01-01    
\end{verbatim}

\hypertarget{conversion-2}{%
\subsection{conversion}\label{conversion-2}}

Pour convertir une date en date-heure, ou l'inverse, utilisez
\texttt{lubridate::as\_datetime()} ou \texttt{lubridate::as\_date()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{as\_datetime}\NormalTok{(}\FunctionTok{today}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2023-07-05 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{as\_date}\NormalTok{(}\FunctionTok{now}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2023-07-05"
\end{verbatim}

\hypertarget{manipuler-les-composants-dune-datedate-heure}{%
\section{Manipuler les composants d'une
date/date-heure}\label{manipuler-les-composants-dune-datedate-heure}}

\hypertarget{extraire-un-composant}{%
\subsection{Extraire un composant}\label{extraire-un-composant}}

Pour extraire un composant d'une date ou d'une date-heure, il suffit
d'utiliser l'une des fonctions suivantes~: \texttt{year()} (année),
\texttt{month()} (mois), \texttt{mday()} (jour du mois), \texttt{yday()}
(jours de l'année), \texttt{wday()} (jour de la semaine),
\texttt{hour()} (heure), \texttt{minute()} (minute), ou
\texttt{second()} (seconde).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datetime }\OtherTok{\textless{}{-}} \FunctionTok{ymd\_hms}\NormalTok{(}\StringTok{"2026{-}07{-}08 12:34:56"}\NormalTok{)}

\FunctionTok{year}\NormalTok{(datetime)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2026
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{month}\NormalTok{(datetime)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mday}\NormalTok{(datetime)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 8
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{yday}\NormalTok{(datetime)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 189
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wday}\NormalTok{(datetime)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 4
\end{verbatim}

Pour \texttt{month()} et \texttt{wday()}, vous pouvez indiquer
\texttt{label\ =\ TRUE} pour récupérer le nom abrégé du mois ou du jours
de la semaine. Ajoutez \texttt{abbr\ =\ FALSE} pour le nom complet.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{month}\NormalTok{(datetime, }\AttributeTok{label =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] juil
12 Levels: janv < févr < mars < avr < mai < juin < juil < août < ... < déc
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wday}\NormalTok{(datetime, }\AttributeTok{label =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{abbr =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] mercredi
7 Levels: dimanche < lundi < mardi < mercredi < jeudi < ... < samedi
\end{verbatim}

Les noms sont affichés dans la langue de votre ordinateur. On peut
utiliser le paramètre \texttt{locale} pour changer la langue.
Attention~: le code peut varier selon votre système d'exploitation. Vous
pouvez essayer déjà de simplement indiquer le code à 2 lettres de la
langue visée, par exemple \texttt{"de"} pour l'allemand. Si cela ne
fonctionne pas, essayez \texttt{"de\_DE"} (allemand utilisé en
Allemagne), \texttt{"de\_DE.UTF-8"} (format utilisé par MacOS et
plusieurs distributions Linux), la variante \texttt{"de\_DE.utf8"}
(utilisée par certaines distributions Linux) ou bien encore
\texttt{"German.UTF-8"} (utilisé par Windows).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{month}\NormalTok{(datetime, }\AttributeTok{label =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{abbr =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{locale =} \StringTok{"en"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] July
12 Levels: January < February < March < April < May < June < ... < December
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{month}\NormalTok{(datetime, }\AttributeTok{label =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{abbr =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{locale =} \StringTok{"es\_ES.utf8"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] julio
12 Levels: enero < febrero < marzo < abril < mayo < junio < ... < diciembre
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{month}\NormalTok{(datetime, }\AttributeTok{label =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{abbr =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{locale =} \StringTok{"German.UTF{-}8"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] Juli
12 Levels: Januar < Februar < März < April < Mai < Juni < Juli < ... < Dezember
\end{verbatim}

\hypertarget{arrondis}{%
\subsection{Arrondis}\label{arrondis}}

Les fonctions \texttt{lubridate::round\_date()},
\texttt{lubridate::floor\_date()} et \texttt{lubridate::ceiling\_date()}
permettent d'arrondir une date à l'unité la plus proche, inférieure ou
supérieure. On devra préciser avec \texttt{unit} l'unité utilisée pour
arrondir. Les valeurs acceptées sont \texttt{"second"},
\texttt{"minute"}, \texttt{"hour"}, \texttt{"day"}, \texttt{"week"},
\texttt{"month"}, \texttt{"bimonth"} (bimestre, i.e.~période de 2 mois),
\texttt{"quarter"} (trimestre), \texttt{season} (saison),
\texttt{halfyear} (semestre) et \texttt{year}, ou un multiple de ces
valeurs.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\OtherTok{\textless{}{-}} \FunctionTok{ymd}\NormalTok{(}\StringTok{"2022{-}05{-}14"}\NormalTok{)}
\FunctionTok{floor\_date}\NormalTok{(d, }\AttributeTok{unit =} \StringTok{"week"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2022-05-08"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{floor\_date}\NormalTok{(d, }\AttributeTok{unit =} \StringTok{"month"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2022-05-01"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{floor\_date}\NormalTok{(d, }\AttributeTok{unit =} \StringTok{"3 months"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2022-04-01"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{floor\_date}\NormalTok{(d, }\AttributeTok{unit =} \StringTok{"year"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2022-01-01"
\end{verbatim}

\hypertarget{modifier-un-composant}{%
\subsection{Modifier un composant}\label{modifier-un-composant}}

Les mêmes fonctions peuvent être utilisées pour modifier un composant
particulier d'une date-heure.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datetime }\OtherTok{\textless{}{-}} \FunctionTok{ymd\_hms}\NormalTok{(}\StringTok{"2026{-}07{-}08 12:34:56"}\NormalTok{)}

\FunctionTok{year}\NormalTok{(datetime) }\OtherTok{\textless{}{-}} \DecValTok{2030}
\NormalTok{datetime}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2030-07-08 12:34:56 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{month}\NormalTok{(datetime) }\OtherTok{\textless{}{-}} \DecValTok{01}
\NormalTok{datetime}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2030-01-08 12:34:56 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hour}\NormalTok{(datetime) }\OtherTok{\textless{}{-}} \FunctionTok{hour}\NormalTok{(datetime) }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{datetime}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2030-01-08 13:34:56 UTC"
\end{verbatim}

Une alternative, plutôt que de modifier une date-heure, consiste à créer
une copie modifiée avec \texttt{lubridate::update()}. Cela permet
également de modifier plusieurs éléments à la fois~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{update}\NormalTok{(datetime, }\AttributeTok{year =} \DecValTok{2030}\NormalTok{, }\AttributeTok{month =} \DecValTok{2}\NormalTok{, }\AttributeTok{mday =} \DecValTok{2}\NormalTok{, }\AttributeTok{hour =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2030-02-02 02:34:56 UTC"
\end{verbatim}

Si les valeurs sont trop importantes (trop de jours par exemple), la
fonction ajoutera les unités en trop pour générer une date valide~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{update}\NormalTok{(}\FunctionTok{ymd}\NormalTok{(}\StringTok{"2023{-}02{-}01"}\NormalTok{), }\AttributeTok{mday =} \DecValTok{30}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2023-03-02"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{update}\NormalTok{(}\FunctionTok{ymd}\NormalTok{(}\StringTok{"2023{-}02{-}01"}\NormalTok{), }\AttributeTok{hour =} \DecValTok{400}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2023-02-17 16:00:00 UTC"
\end{verbatim}

\hypertarget{duruxe9es-puxe9riodes-intervalles-arithmuxe9tique}{%
\section{Durées, périodes, intervalles \&
Arithmétique}\label{duruxe9es-puxe9riodes-intervalles-arithmuxe9tique}}

Il existe plusieurs manières de représenter les intervalles de temps
entre deux dates~:

\begin{itemize}
\tightlist
\item
  les \textbf{durées} (\emph{Duration}), qui représentent un nombre
  exact de secondes~;
\item
  les \textbf{périodes} (\emph{Periods}), qui représentent une durée
  sous la forme d'unités de temps telles que des semaines ou des mois~;
\item
  les \textbf{intervalles} (\emph{Intervals}), qui sont définis par une
  date-heure de début et une date-heure de fin.
\end{itemize}

\hypertarget{duruxe9es-duration}{%
\subsection{Durées (Duration)}\label{duruxe9es-duration}}

Avec \textbf{R}, lorsque l'on soustrait deux dates, on obtient un objet
de la classe \texttt{difftime}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diff }\OtherTok{\textless{}{-}} \FunctionTok{ymd}\NormalTok{(}\StringTok{"2021{-}06{-}30"}\NormalTok{) }\SpecialCharTok{{-}} \FunctionTok{ymd}\NormalTok{(}\StringTok{"1979{-}10{-}14"}\NormalTok{)}
\NormalTok{diff}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Time difference of 15235 days
\end{verbatim}

Un objet \texttt{difftime} enregistre une durée sous la forme d'un
nombre de secondes, de minutes, d'heures, de jours ou de semaines. Du
fait de variations de l'unité d'un objet à l'autre, ils ne sont pas
toujours faciles à manipuler. Pour lever toute ambiguïté, on préférera
les objets de la class \texttt{Duration} qui stockent les durées sous la
forme d'un nombre de secondes. La conversion peut se faire avec
\texttt{lubridate::as.duration()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{as.duration}\NormalTok{(diff)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "1316304000s (~41.71 years)"
\end{verbatim}

Il est possible de créer facilement des durées avec une série de
fonctions dédiées dont le nom commence par \texttt{"d"}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dseconds}\NormalTok{(}\DecValTok{15}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "15s"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dminutes}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "600s (~10 minutes)"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dhours}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{12}\NormalTok{, }\DecValTok{24}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "43200s (~12 hours)" "86400s (~1 days)"  
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ddays}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "0s"                "86400s (~1 days)"  "172800s (~2 days)"
[4] "259200s (~3 days)" "345600s (~4 days)" "432000s (~5 days)"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dweeks}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "1814400s (~3 weeks)"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dyears}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "31557600s (~1 years)"
\end{verbatim}

Les durées sont toujours exprimées en secondes. Des unités plus grandes
sont créées en convertissant les minutes, les heures, les jours, les
semaines et les années en secondes~: 60 secondes dans une minute, 60
minutes dans une heure, 24 heures dans un jour et 7 jours dans une
semaine. Les unités de temps plus grandes posent davantage de problèmes.
Une année utilise le nombre «~moyen~» de jours dans une année,
c'est-à-dire 365,25. Il n'existe aucun moyen de convertir un mois en
durée, car les variations sont trop importantes.

Il est possible d'additionner et de multiplier les durées~:

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{2} \SpecialCharTok{*} \FunctionTok{dyears}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "63115200s (~2 years)"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dyears}\NormalTok{(}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{dweeks}\NormalTok{(}\DecValTok{12}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{dhours}\NormalTok{(}\DecValTok{15}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "38869200s (~1.23 years)"
\end{verbatim}

On peut ajouter ou soustraire des durées à une date.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{demain }\OtherTok{\textless{}{-}} \FunctionTok{today}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{ddays}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{il\_y\_a\_un\_an }\OtherTok{\textless{}{-}} \FunctionTok{today}\NormalTok{() }\SpecialCharTok{{-}} \FunctionTok{dyears}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Cependant, comme les durées représentent un nombre exact de secondes,
vous pouvez parfois obtenir un résultat inattendu~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{one\_am }\OtherTok{\textless{}{-}} \FunctionTok{ymd\_hms}\NormalTok{(}\StringTok{"2026{-}03{-}08 01:00:00"}\NormalTok{, }\AttributeTok{tz =} \StringTok{"America/New\_York"}\NormalTok{)}

\NormalTok{one\_am}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2026-03-08 01:00:00 EST"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{one\_am }\SpecialCharTok{+} \FunctionTok{ddays}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2026-03-09 02:00:00 EDT"
\end{verbatim}

Pourquoi lorsqu'on ajoute un jour, on passe de 1 heure du matin à 2
heures du matin~? Si vous regardez attentivement la date, vous
remarquerez que le fuseau a changé. Le 8 mars 2026 n'aura que 23 heures
aux États-Unis en raison du passage à l'heure d'été. En ajoutant une
durée de 1 jour, nous avons ajouté exactement 24 heures. Le même type de
phénomène peut s'observer en ajoutant une durée d'une année, car on
considère que cela représente en moyenne 365.25 jours.

\hypertarget{puxe9riodes-period}{%
\subsection{Périodes (Period)}\label{puxe9riodes-period}}

Pour résoudre ce problème, \texttt{\{lubridate\}} a introduit les
périodes (de classe \texttt{Period}) qui représentent une durée en
nombre de secondes, minutes, heures, jours, mois et années, sans
préciser la durée exacte de chaque mois ou année. Cela permet de faire
des calculs plus intuitifs~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{one\_am}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2026-03-08 01:00:00 EST"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{one\_am }\SpecialCharTok{+} \FunctionTok{days}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2026-03-09 01:00:00 EDT"
\end{verbatim}

Comme pour les durées, on peut créer facilement des périodes avec des
fonctions dédiées (notez ici le pluriel des noms de fonction, alors que
celles permettant d'extraire un composant d'une date étaient au
singulier)~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hours}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{12}\NormalTok{, }\DecValTok{24}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "12H 0M 0S" "24H 0M 0S"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{days}\NormalTok{(}\DecValTok{7}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "7d 0H 0M 0S"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{months}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "1m 0d 0H 0M 0S" "2m 0d 0H 0M 0S" "3m 0d 0H 0M 0S" "4m 0d 0H 0M 0S"
[5] "5m 0d 0H 0M 0S" "6m 0d 0H 0M 0S"
\end{verbatim}

On peut ajouter, soustraire et multiplier les périodes entre elles.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{10} \SpecialCharTok{*}\NormalTok{ (}\FunctionTok{months}\NormalTok{(}\DecValTok{6}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{days}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "60m 10d 0H 0M 0S"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{days}\NormalTok{(}\DecValTok{50}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{hours}\NormalTok{(}\DecValTok{25}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{minutes}\NormalTok{(}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "50d 25H 2M 0S"
\end{verbatim}

Bien sûr, on peut ajouter ou soustraire une période à une date~:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Exemple avec une année bissextile}
\FunctionTok{ymd}\NormalTok{(}\StringTok{"2024{-}01{-}01"}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{dyears}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2024-12-31 06:00:00 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ymd}\NormalTok{(}\StringTok{"2024{-}01{-}01"}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{years}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2025-01-01"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Exemple avec un passage à l\textquotesingle{}heure d\textquotesingle{}été}
\NormalTok{one\_am }\SpecialCharTok{+} \FunctionTok{ddays}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2026-03-09 02:00:00 EDT"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{one\_am }\SpecialCharTok{+} \FunctionTok{days}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2026-03-09 01:00:00 EDT"
\end{verbatim}

Restent malgré tout quelques cas problématiques. Essayons d'ajouter 1
mois à la date du 31 janvier 2021.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ymd}\NormalTok{(}\StringTok{"2021{-}01{-}31"}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{months}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] NA
\end{verbatim}

Ce calcul a jouté 1 au mois, sans toucher à l'année ni au jour,
produisant la date du 31 février 2021 qui n'existe pas, produisant ainsi
\texttt{NA}. Pour du calcul impliquant des dates et des périodes, il est
préférable d'utiliser les opérateurs dédiés \texttt{\%m+\%} pour
l'addition et \texttt{\%m-\%} pour la soustraction.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ymd}\NormalTok{(}\StringTok{"2021{-}01{-}31"}\NormalTok{) }\SpecialCharTok{\%m+\%} \FunctionTok{months}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2021-02-28"
\end{verbatim}

Lorsque le résultat produit une date inexistante, cela renvoie la
dernière date correcte, ici le 28 février 2021, ce qui correspond bien à
la fin du mois considéré.

\hypertarget{sec-intervals}{%
\subsection{Intervalles (Interval)}\label{sec-intervals}}

Quelle est la durée réelle d'une année~? En 2015, il s'agissait de 365
jours alors qu'en 2016 on en comptait 366. Quand on s'intéresse aux
mois, la situation est encore plus compliquée car il y a une grande
variation du nombre de jours d'un mois à l'autre.

Pour des calculs précis entre deux dates, les durées et les intervalles
sont souvent insuffisants. On pourra alors avoir recours aux intervalles
(de la classe \texttt{Interval}) qui sont définis avec une date de début
et une date de fin.

On peut créer un intervalle avec la fonction
\texttt{lubridate::interval()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{interval}\NormalTok{(}\FunctionTok{ymd}\NormalTok{(}\StringTok{"2022{-}05{-}13"}\NormalTok{), }\FunctionTok{ymd}\NormalTok{(}\StringTok{"2022{-}08{-}15"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2022-05-13 UTC--2022-08-15 UTC
\end{verbatim}

On peut également utiliser l'opérateur \texttt{\%-\/-\%}~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y2023 }\OtherTok{\textless{}{-}} \FunctionTok{ymd}\NormalTok{(}\StringTok{"2023{-}01{-}01"}\NormalTok{) }\SpecialCharTok{\%{-}{-}\%} \FunctionTok{ymd}\NormalTok{(}\StringTok{"2024{-}01{-}01"}\NormalTok{)}
\NormalTok{y2024 }\OtherTok{\textless{}{-}} \FunctionTok{ymd}\NormalTok{(}\StringTok{"2024{-}01{-}01"}\NormalTok{) }\SpecialCharTok{\%{-}{-}\%} \FunctionTok{ymd}\NormalTok{(}\StringTok{"2025{-}01{-}01"}\NormalTok{)}

\NormalTok{y2023}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2023-01-01 UTC--2024-01-01 UTC
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y2024}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2024-01-01 UTC--2025-01-01 UTC
\end{verbatim}

On peut tester si une date est située dans un intervalle donné avec
l'opérateur \texttt{\%within\%}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{int }\OtherTok{\textless{}{-}} \FunctionTok{interval}\NormalTok{(}\FunctionTok{ymd}\NormalTok{(}\StringTok{"2001{-}01{-}01"}\NormalTok{), }\FunctionTok{ymd}\NormalTok{(}\StringTok{"2002{-}01{-}01"}\NormalTok{))}
\FunctionTok{ymd}\NormalTok{(}\StringTok{"2001{-}05{-}03"}\NormalTok{) }\SpecialCharTok{\%within\%}\NormalTok{ int}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] TRUE
\end{verbatim}

On peut même tester si un intervalle est situé à l'intérieur d'un
intervalle~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{int2 }\OtherTok{\textless{}{-}} \FunctionTok{interval}\NormalTok{(}\FunctionTok{ymd}\NormalTok{(}\StringTok{"2001{-}06{-}01"}\NormalTok{), }\FunctionTok{ymd}\NormalTok{(}\StringTok{"2001{-}11{-}11"}\NormalTok{))}
\NormalTok{int2 }\SpecialCharTok{\%within\%}\NormalTok{ int}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] TRUE
\end{verbatim}

Cela n'est valable que si l'ensemble du premier intervalle est situé à
l'intérieur du second intervalle.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{int3 }\OtherTok{\textless{}{-}} \FunctionTok{interval}\NormalTok{(}\FunctionTok{ymd}\NormalTok{(}\StringTok{"2001{-}06{-}01"}\NormalTok{), }\FunctionTok{ymd}\NormalTok{(}\StringTok{"2002{-}06{-}01"}\NormalTok{))}
\NormalTok{int3 }\SpecialCharTok{\%within\%}\NormalTok{ int}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] FALSE
\end{verbatim}

Pour tester si deux intervalles ont une partie en commun, on pourra
utiliser \texttt{lubridate::int\_overlaps()}. La fonction
\texttt{intersect()} renvoie la partie partagée par les deux
intervalles.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{int\_overlaps}\NormalTok{(int3, int)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{intersect}\NormalTok{(int3, int)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2001-06-01 UTC--2002-01-01 UTC
\end{verbatim}

\texttt{\{lubridate\}} fournie plusieurs fonctions, de la forme
\texttt{int\_*()}, pour manipuler les intervalles.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{int}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2001-01-01 UTC--2002-01-01 UTC
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{int\_start}\NormalTok{(int)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2001-01-01 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{int\_end}\NormalTok{(int)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2002-01-01 UTC"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{int\_flip}\NormalTok{(int)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2002-01-01 UTC--2001-01-01 UTC
\end{verbatim}

On peut calculer facilement la durée d'un intervalle avec la fonction
\texttt{lubridate::time\_length()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{time\_length}\NormalTok{(int) }\CommentTok{\# en seconde par défaut}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 31536000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{time\_length}\NormalTok{(int, }\AttributeTok{unit =} \StringTok{"weeks"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 52.14286
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{time\_length}\NormalTok{(int, }\AttributeTok{unit =} \StringTok{"days"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 365
\end{verbatim}

La fonction \texttt{time\_length()} permet notamment de calculer
correctement un âge.

\hypertarget{calcul-dun-uxe2ge}{%
\section{Calcul d'un âge}\label{calcul-dun-uxe2ge}}

En tant que démographe, je suis toujours attentif au calcul des âges.
Les démographes distinguent l'\textbf{âge exact}, exprimé en années avec
une partie décimale, et qui correspond à la durée entre la date
considérée et la date de naissance~; l'\textbf{âge révolu}, qui
correspond à l'âge au dernier anniversaire et exprimé avec un nombre
entier d'années (c'est l'âge que nous utilisons dans notre vie
quotidienne)·; et l'\textbf{âge atteint} ou \textbf{âge par différence
de millésimes}, qui correspond à la différence entre l'année en cours et
l'année de naissance (c'est l'âge que l'on aura cette année le jour de
son anniversaire).

Pour calculer un âge exact en années, nous ne pouvons pendre la durée en
jours entre les deux dates et diviser par 365 puisqu'il y a des années
bissextiles. Une approche correcte est déjà de considérer l'âge au
dernière anniversaire pour la partie entière, puis de calculer la partie
décimale comme étant le ratio entre la durée depuis le dernière
anniversaire et la durée entre le dernier et le prochain anniversaire.
C'est exactement ce que fait \texttt{lubridate::time\_length()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{naiss }\OtherTok{\textless{}{-}} \FunctionTok{ymd}\NormalTok{(}\StringTok{"1979{-}11{-}28"}\NormalTok{)}
\NormalTok{evt }\OtherTok{\textless{}{-}} \FunctionTok{ymd}\NormalTok{(}\StringTok{"2022{-}07{-}14"}\NormalTok{)}
\NormalTok{age\_exact }\OtherTok{\textless{}{-}} \FunctionTok{time\_length}\NormalTok{(naiss }\SpecialCharTok{\%{-}{-}\%}\NormalTok{ evt, }\AttributeTok{unit =} \StringTok{"years"}\NormalTok{)}
\NormalTok{age\_exact}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 42.62466
\end{verbatim}

Pour un âge révolu, il suffit de ne garder que la partie entière de
l'âge exact avec \texttt{trunc()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{age\_revolu }\OtherTok{\textless{}{-}} \FunctionTok{trunc}\NormalTok{(age\_exact)}
\NormalTok{age\_revolu}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 42
\end{verbatim}

Enfin, pour un âge atteint ou un âge par différence de millésimes, nous
extrairons les deux années avant d'en faire la soustraction.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{age\_atteint }\OtherTok{\textless{}{-}} \FunctionTok{year}\NormalTok{(evt) }\SpecialCharTok{{-}} \FunctionTok{year}\NormalTok{(naiss)}
\NormalTok{age\_atteint}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 43
\end{verbatim}

\begin{tcolorbox}[enhanced jigsaw, toptitle=1mm, left=2mm, breakable, opacitybacktitle=0.6, colback=white, toprule=.15mm, opacityback=0, bottomtitle=1mm, rightrule=.15mm, coltitle=black, colbacktitle=quarto-callout-tip-color!10!white, leftrule=.75mm, arc=.35mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Astuce}, bottomrule=.15mm, colframe=quarto-callout-tip-color-frame]

Le calcul d\textquotesingle un âge moyen s\textquotesingle effectue
normalement à partir d\textquotesingle âges exacts. Il arrive
fréquemment que l\textquotesingle on ne dispose dans les données
d\textquotesingle enquêtes que de l\textquotesingle âge révolu. Auquel
cas, il faut bien penser à rajouter 0,5 au résultat obtenu. En effet, un
âge révolu peut être vu comme une classe d\textquotesingle âges exacts~:
les individus ayant 20 ans révolus ont entre 20 et 21 ans exacts, soit
en moyenne 20,5 ans~!

\end{tcolorbox}

\hypertarget{fuseaux-horaires}{%
\section{Fuseaux horaires}\label{fuseaux-horaires}}

Les \href{https://fr.wikipedia.org/wiki/Fuseau_horaire}{fuseaux
horaires} sont un sujet extrêmement complexe en raison de leur
interaction avec les entités géopolitiques. Heureusement, nous n'avons
pas besoin d'entrer dans tous les détails, car ils ne sont pas tous
importants pour l'analyse des données, mais il y a quelques défis que
nous devrons relever.

Le premier défi est que les noms courants des fuseaux horaires ont
tendance à être ambigus. Par exemple, si vous êtes américain, vous
connaissez probablement l'EST (\emph{Eastern Standard Time}). Cependant,
l'Australie et le Canada ont également une heure normale de l'Est~! Pour
éviter toute confusion, \textbf{R} utilise les fuseaux horaires standard
internationaux de l'IANA. Ceux-ci utilisent un schéma de dénomination
cohérent \texttt{\{zone\}/\{lieu\}}, généralement sous la forme
\textbf{\{continent\}/\{ville\}} ou \texttt{\{océan\}/\{ville\}}. Parmi
les exemples, citons \texttt{"America/New\_York"},
\textbf{``Europe/Paris''} et \textbf{``Pacific/Auckland''}.

On peut se demander pourquoi le fuseau horaire utilise une ville, alors
que l'on pense généralement que les fuseaux horaires sont associés à un
pays ou à une région à l'intérieur d'un pays. La raison en est que la
base de données de l'IANA doit enregistrer des dizaines d'années de
règles relatives aux fuseaux horaires. Au fil des décennies, les pays
changent de nom (ou se séparent) assez fréquemment, mais les noms de
villes ont tendance à rester inchangés. Un autre problème réside dans le
fait que le nom doit refléter non seulement le comportement actuel, mais
aussi l'ensemble de l'histoire. Par exemple, il existe des fuseaux
horaires pour \texttt{"America/New\_York"} et
\texttt{"America/Detroit"}. Cela vaut la peine de lire la base de
données brute des fuseaux horaires (disponible à l'adresse
\url{https://www.iana.org/time-zones}) rien que pour lire certaines de
ces histoires !

Vous pouvez découvrir ce que \textbf{R} pense être votre fuseau horaire
actuel avec \texttt{Sys.timezone()}~:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{Sys.timezone}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Europe/Paris"
\end{verbatim}

La liste complète des fuseaux horaires est disponible avec
\texttt{OlsonNames()}:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(}\FunctionTok{OlsonNames}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 596
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(}\FunctionTok{OlsonNames}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Africa/Abidjan"     "Africa/Accra"       "Africa/Addis_Ababa"
[4] "Africa/Algiers"     "Africa/Asmara"      "Africa/Asmera"     
\end{verbatim}

Dans \textbf{R}, le fuseau horaire est un attribut de la date-heure qui
ne contrôle que l'affichage. Par exemple, ces trois objets représentent
le même instant dans le temps~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x1 }\OtherTok{\textless{}{-}} \FunctionTok{ymd\_hms}\NormalTok{(}\StringTok{"2024{-}06{-}01 12:00:00"}\NormalTok{, }\AttributeTok{tz =} \StringTok{"America/New\_York"}\NormalTok{)}
\NormalTok{x1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2024-06-01 12:00:00 EDT"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x2 }\OtherTok{\textless{}{-}} \FunctionTok{ymd\_hms}\NormalTok{(}\StringTok{"2024{-}06{-}01 18:00:00"}\NormalTok{, }\AttributeTok{tz =} \StringTok{"Europe/Copenhagen"}\NormalTok{)}
\NormalTok{x2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2024-06-01 18:00:00 CEST"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x3 }\OtherTok{\textless{}{-}} \FunctionTok{ymd\_hms}\NormalTok{(}\StringTok{"2024{-}06{-}02 04:00:00"}\NormalTok{, }\AttributeTok{tz =} \StringTok{"Pacific/Auckland"}\NormalTok{)}
\NormalTok{x3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2024-06-02 04:00:00 NZST"
\end{verbatim}

Sauf indication contraire, \texttt{\{lubridate\}} utilise toujours
l'heure UTC. UTC
(\href{https://www.wikiwand.com/fr/Temps_universel_coordonn\%C3\%A9}{Temps
universel coordonné}, compromis entre l'anglais CUT~\emph{Coordinated
universal time}~et le français TUC~\emph{Temps universel coordonné}) est
le fuseau horaire standard utilisé par la communauté scientifique et est
à peu près équivalent à GMT (\emph{Greenwich Mean Time}). Il n'y a pas
d'heure d'été, ce qui en fait une représentation pratique pour les
calculs. Les opérations qui combinent des dates-heure, comme
\texttt{c()}, ne tiennent souvent pas compte du fuseau horaire. Dans ce
cas, les dates-heure s'afficheront dans le fuseau horaire du premier
élément~:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x4 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(x1, x2, x3)}
\NormalTok{x4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2024-06-01 12:00:00 EDT" "2024-06-01 12:00:00 EDT"
[3] "2024-06-01 12:00:00 EDT"
\end{verbatim}

Vous pouvez modifier le fuseau horaire de deux manières~:

\begin{itemize}
\item
  Conserver le même instant dans le temps, mais modifier la façon dont
  il est affiché. Utilisez cette option lorsque l'instant est correct,
  mais que vous souhaitez un affichage plus naturel.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x4a }\OtherTok{\textless{}{-}} \FunctionTok{with\_tz}\NormalTok{(x4, }\AttributeTok{tzone =} \StringTok{"Australia/Lord\_Howe"}\NormalTok{)}
\NormalTok{x4a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2024-06-02 02:30:00 +1030" "2024-06-02 02:30:00 +1030"
[3] "2024-06-02 02:30:00 +1030"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x4a }\SpecialCharTok{{-}}\NormalTok{ x4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Time differences in secs
[1] 0 0 0
\end{verbatim}
\item
  Modifier l'instant sous-jacent dans le temps. Utilisez cette option
  lorsqu'un instant a été étiqueté avec un fuseau horaire incorrect et
  que vous devez le corriger.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x4b }\OtherTok{\textless{}{-}} \FunctionTok{force\_tz}\NormalTok{(x4, }\AttributeTok{tzone =} \StringTok{"Australia/Lord\_Howe"}\NormalTok{)}
\NormalTok{x4b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "2024-06-01 12:00:00 +1030" "2024-06-01 12:00:00 +1030"
[3] "2024-06-01 12:00:00 +1030"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x4b }\SpecialCharTok{{-}}\NormalTok{ x4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Time differences in hours
[1] -14.5 -14.5 -14.5
\end{verbatim}
\end{itemize}

\hypertarget{pour-aller-plus-loin-1}{%
\section{Pour aller plus loin}\label{pour-aller-plus-loin-1}}

\begin{itemize}
\tightlist
\item
  le chapitre \href{https://r4ds.hadley.nz/datetimes.html}{Dates and
  times} de l'ouvrage \emph{R for Data Science} (2e édition)
\item
  la documentation du package \texttt{\{lubridate\}}~:
  \url{https://lubridate.tidyverse.org/}
\end{itemize}

\hypertarget{sec-tidyr}{%
\chapter{\texorpdfstring{Réorganisation avec
\texttt{tidyr}}{Réorganisation avec tidyr}}\label{sec-tidyr}}



\end{document}
